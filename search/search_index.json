{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u5b9e\u9a8c\u6587\u6863 \u00b6 uCore LoongArch32 \u00b6 \u5b9e\u9a8c\u5185\u5bb9 \u00b6 0. \u73af\u5883\u914d\u7f6e\u4e0e\u88f8\u673a\u7a0b\u5e8f 1. \u5f02\u5e38\u4e0e\u4e2d\u65ad 2. \u5185\u5b58\u7ba1\u7406 3. \u8fdb\u7a0b\u7ba1\u7406 4. \u6587\u4ef6\u7cfb\u7edf Note \u52a9\u6559\u5728\u6587\u4e2d\u52a0\u5165\u4e86\u8bb8\u591a\u5c0f\u601d\u8003\u5185\u5bb9\uff0c\u76ee\u7684\u662f\u8ba9\u6709\u5174\u8da3\u7684\u540c\u5b66\u4eec\u53ef\u4ee5\u987a\u7740\u5c0f\u601d\u8003\u7684\u5185\u5bb9\u53bb\u63a2\u7d22\u66f4\u591a\u672a\u77e5\u7684\u9886\u57df\uff0c\u5e76\u5f15\u5bfc\u5927\u5bb6\u7684\u6279\u5224\u6027\u601d\u7ef4\u3002\u6b22\u8fce\u540c\u5b66\u8bfe\u4e0b\u8ba8\u8bba\uff0c\u4e0d\u9700\u8981\u4e5f\u4e0d\u5e94\u8be5\u63d0\u4ea4\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u3002 \u5176\u5b83\u6559\u5b66\u8d44\u6599 \u00b6 \u8bb2\u89e3\u89c6\u9891","title":"\u4e3b\u9875"},{"location":"#_1","text":"","title":"\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u5b9e\u9a8c\u6587\u6863"},{"location":"#ucore-loongarch32","text":"","title":"uCore LoongArch32"},{"location":"#_2","text":"0. \u73af\u5883\u914d\u7f6e\u4e0e\u88f8\u673a\u7a0b\u5e8f 1. \u5f02\u5e38\u4e0e\u4e2d\u65ad 2. \u5185\u5b58\u7ba1\u7406 3. \u8fdb\u7a0b\u7ba1\u7406 4. \u6587\u4ef6\u7cfb\u7edf Note \u52a9\u6559\u5728\u6587\u4e2d\u52a0\u5165\u4e86\u8bb8\u591a\u5c0f\u601d\u8003\u5185\u5bb9\uff0c\u76ee\u7684\u662f\u8ba9\u6709\u5174\u8da3\u7684\u540c\u5b66\u4eec\u53ef\u4ee5\u987a\u7740\u5c0f\u601d\u8003\u7684\u5185\u5bb9\u53bb\u63a2\u7d22\u66f4\u591a\u672a\u77e5\u7684\u9886\u57df\uff0c\u5e76\u5f15\u5bfc\u5927\u5bb6\u7684\u6279\u5224\u6027\u601d\u7ef4\u3002\u6b22\u8fce\u540c\u5b66\u8bfe\u4e0b\u8ba8\u8bba\uff0c\u4e0d\u9700\u8981\u4e5f\u4e0d\u5e94\u8be5\u63d0\u4ea4\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u3002","title":"\u5b9e\u9a8c\u5185\u5bb9"},{"location":"#_3","text":"\u8bb2\u89e3\u89c6\u9891","title":"\u5176\u5b83\u6559\u5b66\u8d44\u6599"},{"location":"chiplab/n4ddr/","text":"\u5f00\u53d1\u677f\u4ecb\u7ecd \u00b6 \u6211\u4eec\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406\u4e0e\u786c\u4ef6\u7efc\u5408\u8bbe\u8ba1\u8bfe\u7a0b\u4e2d\u4f7f\u7528\u7684 Nexys 4 DDR FPGA\u5f00\u53d1\u677f\u80fd\u591f\u8fd0\u884c\u9f99\u82af\u5f00\u53d1\u7684 Chiplab \u8f6f\u6838\u3002\u771f\u5b9e\u7684Chiplab\u8f6f\u6838\u4e0eQEMU\u5b58\u5728\u4e00\u4e9b\u5dee\u5f02\uff0c\u53ef\u4ee5\u5e2e\u52a9\u540c\u5b66\u4eec\u53d1\u73b0\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u672a\u8003\u8651\u5230\u771f\u5b9e\u786c\u4ef6\u7684\u4e00\u4e9b\u95ee\u9898\uff08\u4f8b\u5982I Cache\u4e0eD Cache\u4e00\u81f4\u6027\u662f\u5426\u6b63\u786e\u7ef4\u62a4\uff09\u3002 \u6b65\u9aa4 \u00b6 1. \u4f7f\u7528 loongarch32r-linux-gnusf-strip \u5bf9elf\u6587\u4ef6\u4e0d\u5fc5\u8981\u7684\u90e8\u5206\u8fdb\u884c\u88c1\u526a\uff0c\u5426\u5219PMON\u4f1a\u62a5\u9519\u3002 \u00b6 \u5728ucore-loongarch32\u7684obj\u6587\u4ef6\u5939\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a loongarch32r-linux-gnusf-strip ucore-kernel-initrd 2. \u5c06PMON\uff08Bootloader\uff09\u70e7\u5199\u5230Nexys 4 DDR\u5f00\u53d1\u677f\u7684SPI Flash \u00b6 Warning \u6ce8\u610f\uff0cNexys 4 DDR\u5f00\u53d1\u677f\u70e7\u5199SPI Flash\u7684\u65b9\u5f0f\u4e0e\u9f99\u82af\u676f\u5f00\u53d1\u677f\u4ee5\u53ca\u767e\u82af\u8ba1\u5212\u5f00\u53d1\u677f\u4e0d\u540c\u3002\u8bf7\u52ff\u6309\u7167 \u5b98\u65b9\u6d41\u7a0b \u8fdb\u884c\u3002 \u5c06\u5f00\u53d1\u677f\u8fde\u4e0a\u7535\u8111\uff0c\u6253\u5f00Vivado\u7684Hardware Manager \u4e0b\u8f7d PMON\u6587\u4ef6 \u4f60\u4e5f\u53ef\u4ee5\u4ece Chiplab\u6587\u6863 \u4e2d\u4e0b\u8f7d\u6700\u65b0PMON\u6587\u4ef6\u3002 \u5728Hardware Manager\u4e2d\u8fde\u63a5\u5f00\u53d1\u677f\uff0c\u5e76\u9009\u4e2dFPGA\u82af\u7247\uff0c\u70b9\u51fb\u53f3\u952e\uff0c\u9009\u62e9 Add Configuration Memory Device \u3002 \u5728\u5f39\u51fa\u7684\u7a97\u53e3\u4e2d\u641c\u7d22\u82af\u7247 s25fl128sxxxxxx0-spi-x1_x2_x4 \u3002 \u4f7f\u7528\u521a\u521a\u4e0b\u8f7d\u7684PMON\u6587\u4ef6 gzrom-uart_div_18.bin \u8fdb\u884c\u70e7\u5199\u3002 3. \u4f7f\u7528Vivado\u751f\u6210Chiplab\u7684FPGA bit\u6d41\u3002 \u00b6 \u4e0b\u8f7d\u52a9\u6559\u505a\u597d\u7684Vivado\u5de5\u7a0b\u3002 git clone https://gitee.com/cyyself/chiplab.git -b n4ddr_with_cpu cd chiplab open fpga/nexys4ddr/system_run/system_run.xpr # \u5982\u679c\u6ca1\u6709open\u547d\u4ee4\u53ef\u4ee5\u81ea\u5df1\u7528Vivado\u6253\u5f00\u8fd9\u4e2axpr\u6587\u4ef6 \u76f4\u63a5\u751f\u6210bit\u6d41\uff0c\u7136\u540e\u70e7\u5230\u5f00\u53d1\u677f\u4e0a\u5373\u53ef\u3002\uff08\u8fd9\u4e2a\u6d41\u7a0b\u5927\u5bb6\u505a\u8fc7\u6570\u5b57\u903b\u8f91\u548c\u7ec4\u6210\u539f\u7406\u7684\u5b9e\u9a8c\u5e94\u8be5\u5f88\u719f\u6089\u3002\uff09 Warning \u5982\u679c\u4f7f\u7528\u65b0\u7248\u672c\u7684Vivado\uff0c\u5728\u66f4\u65b0IP\u6838\u65f6\u5e94\u9009\u62e9 Continue with Core Container Disabled . 4. \u5c06bit\u6d41\u5199\u5230\u5f00\u53d1\u677f\u4e0a\u3002 \u00b6 \u8fd9\u4e2a\u6d41\u7a0b\u5927\u5bb6\u505a\u8fc7\u6570\u5b57\u903b\u8f91\u548c\u7ec4\u6210\u539f\u7406\u7684\u5b9e\u9a8c\u5e94\u8be5\u5f88\u719f\u6089\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662fSPI Flash\u5df2\u88ab\u6211\u4eec\u7684PMON\u5360\u7528\uff0c\u6240\u4ee5\u8bf7\u52ff\u56fa\u5316\u3002 5. \u5269\u4f59\u6d41\u7a0b \u00b6 \u4ee5\u4e0b\u6d41\u7a0b\u53ef\u76f4\u63a5\u53c2\u8003 \u9f99\u82afChiplab\u6587\u6863 \uff0c\u4ece4.3\u8282\u5f00\u59cb\uff0c4.5\u8282\u9664\u5916\uff08\u56e0\u4e3aNexys 4 DDR\u6ca1\u6709NAND Flash\uff09\u3002 \u4f7f\u7528\u4e32\u53e3\u8f6f\u4ef6\u8fde\u63a5\u5f00\u53d1\u677f\u7684USB\u4e32\u53e3\uff0c\u4f7f\u7528115200\u6ce2\u7279\u7387\uff0c8n1\uff0c\u65e0\u6d41\u63a7\u3002 \u4f7f\u7528\u7f51\u7ebf\u8fde\u63a5\u81ea\u5df1\u7684\u7535\u8111\u548c\u5f00\u53d1\u677f \u5728PMON\u4e2d\u914d\u7f6eIP \u6211\u4eec\u53ef\u4ee5\u4e3a\u8fde\u63a5\u5f00\u53d1\u677f\u7684\u7f51\u5361\u968f\u610f\u914d\u7f6e\u4e00\u4e2a\u9759\u6001IP\uff0c\u4f8b\u5982PC\u914d\u7f6e\u4e3a169.254.0.1\u3002 \u4e4b\u540e\u5728\u4e32\u53e3\u4e2d\u7684PMON\u4e5f\u914d\u7f6e\u540c\u7f51\u6bb5IP\uff1a ifconfig dmfe0 169 .254.0.2 ping 169 .254.0.1 \u5728\u7535\u8111\u4e0a\u8fd0\u884ctftp\u670d\u52a1\u5668 \u5bf9\u4e8eWindows\u7528\u6237\uff0c\u63a8\u8350\u4f7f\u7528 Tftpd64 \u5bf9\u4e8eLinux\u7528\u6237\uff0c\u63a8\u8350\u4f7f\u7528tftpd-hpa\uff0c\u5bf9\u4e8eUbuntu\u53ef\u4ee5\u53c2\u8003 Wiki \u3002 \u4f7f\u7528WSL2\u7684\u540c\u5b66\u6ce8\u610f\uff1aWSL2\u4e2d\u7f51\u5361\u4e3aNAT\u6a21\u5f0f\uff0cTFTP\u534f\u8bae\u4f7f\u7528UDP\u4f20\u8f93\uff0c\u8bf7\u786e\u4fdd\u4f60\u4f7f\u7528\u7684\u7aef\u53e3\u8f6c\u53d1\u65b9\u5f0f\u80fd\u591f\u6b63\u786e\u5904\u7406UDP\uff0c\u5426\u5219\u5efa\u8bae\u5c06\u6587\u4ef6\u590d\u5236\u51fa\u6765\uff0c\u5728Host\u7aefWindows\u8fd0\u884c\u3002 \u7136\u540e\uff0c\u5c06\u4f60\u8981\u4f20\u5230\u5f00\u53d1\u677f\u4e0a\u7684\u88f8\u673a\u7a0b\u5e8f\uff08\u751a\u81f3Lab0\u7684\u6700\u7b80\u88f8\u673a\u7a0b\u5e8f\u4e5f\u662f\u53ef\u4ee5\u7684\uff09\uff0c\u653e\u5230tftp\u670d\u52a1\u5668\u8f6f\u4ef6\u8bbe\u5b9a\u7684\u6839\u76ee\u5f55\u4e0b\u3002 \u5728PMON\u4e2d\u8f7d\u5165\u5185\u6838 \u5728PMON\u4e2d\u6267\u884c\uff1a load tftp://169.254.0.1/ucore-kernel-initrd g \u6ce8\uff1auCore\u4e0d\u4f1a\u8bfb\u53d6Bootloader\u4f20\u9012\u7684Kernel command line\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u50cf\u542f\u52a8Linux\u4e00\u6837\u5728g\u540e\u9762\u6dfb\u52a0\u53c2\u6570\u3002 \u66f4\u591a\u5e2e\u52a9 \u00b6 \u5982\u679c\u540c\u5b66\u4eec\u60f3\u8981\u5728\u8fd9\u4e2a\u5f00\u53d1\u677f\u4e0a\u8fd0\u884cLoongArch32\u7684Linux\uff0c\u53ef\u4ee5\u9605\u8bfb\u66f4\u591a\u8bf4\u660e\uff1a Chiplab\u5e2e\u52a9\u6587\u6863 Chiplab\u79fb\u690dN4DDR\u8bf4\u660e","title":"Nexys 4 DDR"},{"location":"chiplab/n4ddr/#_1","text":"\u6211\u4eec\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406\u4e0e\u786c\u4ef6\u7efc\u5408\u8bbe\u8ba1\u8bfe\u7a0b\u4e2d\u4f7f\u7528\u7684 Nexys 4 DDR FPGA\u5f00\u53d1\u677f\u80fd\u591f\u8fd0\u884c\u9f99\u82af\u5f00\u53d1\u7684 Chiplab \u8f6f\u6838\u3002\u771f\u5b9e\u7684Chiplab\u8f6f\u6838\u4e0eQEMU\u5b58\u5728\u4e00\u4e9b\u5dee\u5f02\uff0c\u53ef\u4ee5\u5e2e\u52a9\u540c\u5b66\u4eec\u53d1\u73b0\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u672a\u8003\u8651\u5230\u771f\u5b9e\u786c\u4ef6\u7684\u4e00\u4e9b\u95ee\u9898\uff08\u4f8b\u5982I Cache\u4e0eD Cache\u4e00\u81f4\u6027\u662f\u5426\u6b63\u786e\u7ef4\u62a4\uff09\u3002","title":"\u5f00\u53d1\u677f\u4ecb\u7ecd"},{"location":"chiplab/n4ddr/#_2","text":"","title":"\u6b65\u9aa4"},{"location":"chiplab/n4ddr/#1-loongarch32r-linux-gnusf-stripelfpmon","text":"\u5728ucore-loongarch32\u7684obj\u6587\u4ef6\u5939\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a loongarch32r-linux-gnusf-strip ucore-kernel-initrd","title":"1. \u4f7f\u7528loongarch32r-linux-gnusf-strip\u5bf9elf\u6587\u4ef6\u4e0d\u5fc5\u8981\u7684\u90e8\u5206\u8fdb\u884c\u88c1\u526a\uff0c\u5426\u5219PMON\u4f1a\u62a5\u9519\u3002"},{"location":"chiplab/n4ddr/#2-pmonbootloadernexys-4-ddrspi-flash","text":"Warning \u6ce8\u610f\uff0cNexys 4 DDR\u5f00\u53d1\u677f\u70e7\u5199SPI Flash\u7684\u65b9\u5f0f\u4e0e\u9f99\u82af\u676f\u5f00\u53d1\u677f\u4ee5\u53ca\u767e\u82af\u8ba1\u5212\u5f00\u53d1\u677f\u4e0d\u540c\u3002\u8bf7\u52ff\u6309\u7167 \u5b98\u65b9\u6d41\u7a0b \u8fdb\u884c\u3002 \u5c06\u5f00\u53d1\u677f\u8fde\u4e0a\u7535\u8111\uff0c\u6253\u5f00Vivado\u7684Hardware Manager \u4e0b\u8f7d PMON\u6587\u4ef6 \u4f60\u4e5f\u53ef\u4ee5\u4ece Chiplab\u6587\u6863 \u4e2d\u4e0b\u8f7d\u6700\u65b0PMON\u6587\u4ef6\u3002 \u5728Hardware Manager\u4e2d\u8fde\u63a5\u5f00\u53d1\u677f\uff0c\u5e76\u9009\u4e2dFPGA\u82af\u7247\uff0c\u70b9\u51fb\u53f3\u952e\uff0c\u9009\u62e9 Add Configuration Memory Device \u3002 \u5728\u5f39\u51fa\u7684\u7a97\u53e3\u4e2d\u641c\u7d22\u82af\u7247 s25fl128sxxxxxx0-spi-x1_x2_x4 \u3002 \u4f7f\u7528\u521a\u521a\u4e0b\u8f7d\u7684PMON\u6587\u4ef6 gzrom-uart_div_18.bin \u8fdb\u884c\u70e7\u5199\u3002","title":"2. \u5c06PMON\uff08Bootloader\uff09\u70e7\u5199\u5230Nexys 4 DDR\u5f00\u53d1\u677f\u7684SPI Flash"},{"location":"chiplab/n4ddr/#3-vivadochiplabfpga-bit","text":"\u4e0b\u8f7d\u52a9\u6559\u505a\u597d\u7684Vivado\u5de5\u7a0b\u3002 git clone https://gitee.com/cyyself/chiplab.git -b n4ddr_with_cpu cd chiplab open fpga/nexys4ddr/system_run/system_run.xpr # \u5982\u679c\u6ca1\u6709open\u547d\u4ee4\u53ef\u4ee5\u81ea\u5df1\u7528Vivado\u6253\u5f00\u8fd9\u4e2axpr\u6587\u4ef6 \u76f4\u63a5\u751f\u6210bit\u6d41\uff0c\u7136\u540e\u70e7\u5230\u5f00\u53d1\u677f\u4e0a\u5373\u53ef\u3002\uff08\u8fd9\u4e2a\u6d41\u7a0b\u5927\u5bb6\u505a\u8fc7\u6570\u5b57\u903b\u8f91\u548c\u7ec4\u6210\u539f\u7406\u7684\u5b9e\u9a8c\u5e94\u8be5\u5f88\u719f\u6089\u3002\uff09 Warning \u5982\u679c\u4f7f\u7528\u65b0\u7248\u672c\u7684Vivado\uff0c\u5728\u66f4\u65b0IP\u6838\u65f6\u5e94\u9009\u62e9 Continue with Core Container Disabled .","title":"3. \u4f7f\u7528Vivado\u751f\u6210Chiplab\u7684FPGA bit\u6d41\u3002"},{"location":"chiplab/n4ddr/#4-bit","text":"\u8fd9\u4e2a\u6d41\u7a0b\u5927\u5bb6\u505a\u8fc7\u6570\u5b57\u903b\u8f91\u548c\u7ec4\u6210\u539f\u7406\u7684\u5b9e\u9a8c\u5e94\u8be5\u5f88\u719f\u6089\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662fSPI Flash\u5df2\u88ab\u6211\u4eec\u7684PMON\u5360\u7528\uff0c\u6240\u4ee5\u8bf7\u52ff\u56fa\u5316\u3002","title":"4. \u5c06bit\u6d41\u5199\u5230\u5f00\u53d1\u677f\u4e0a\u3002"},{"location":"chiplab/n4ddr/#5","text":"\u4ee5\u4e0b\u6d41\u7a0b\u53ef\u76f4\u63a5\u53c2\u8003 \u9f99\u82afChiplab\u6587\u6863 \uff0c\u4ece4.3\u8282\u5f00\u59cb\uff0c4.5\u8282\u9664\u5916\uff08\u56e0\u4e3aNexys 4 DDR\u6ca1\u6709NAND Flash\uff09\u3002 \u4f7f\u7528\u4e32\u53e3\u8f6f\u4ef6\u8fde\u63a5\u5f00\u53d1\u677f\u7684USB\u4e32\u53e3\uff0c\u4f7f\u7528115200\u6ce2\u7279\u7387\uff0c8n1\uff0c\u65e0\u6d41\u63a7\u3002 \u4f7f\u7528\u7f51\u7ebf\u8fde\u63a5\u81ea\u5df1\u7684\u7535\u8111\u548c\u5f00\u53d1\u677f \u5728PMON\u4e2d\u914d\u7f6eIP \u6211\u4eec\u53ef\u4ee5\u4e3a\u8fde\u63a5\u5f00\u53d1\u677f\u7684\u7f51\u5361\u968f\u610f\u914d\u7f6e\u4e00\u4e2a\u9759\u6001IP\uff0c\u4f8b\u5982PC\u914d\u7f6e\u4e3a169.254.0.1\u3002 \u4e4b\u540e\u5728\u4e32\u53e3\u4e2d\u7684PMON\u4e5f\u914d\u7f6e\u540c\u7f51\u6bb5IP\uff1a ifconfig dmfe0 169 .254.0.2 ping 169 .254.0.1 \u5728\u7535\u8111\u4e0a\u8fd0\u884ctftp\u670d\u52a1\u5668 \u5bf9\u4e8eWindows\u7528\u6237\uff0c\u63a8\u8350\u4f7f\u7528 Tftpd64 \u5bf9\u4e8eLinux\u7528\u6237\uff0c\u63a8\u8350\u4f7f\u7528tftpd-hpa\uff0c\u5bf9\u4e8eUbuntu\u53ef\u4ee5\u53c2\u8003 Wiki \u3002 \u4f7f\u7528WSL2\u7684\u540c\u5b66\u6ce8\u610f\uff1aWSL2\u4e2d\u7f51\u5361\u4e3aNAT\u6a21\u5f0f\uff0cTFTP\u534f\u8bae\u4f7f\u7528UDP\u4f20\u8f93\uff0c\u8bf7\u786e\u4fdd\u4f60\u4f7f\u7528\u7684\u7aef\u53e3\u8f6c\u53d1\u65b9\u5f0f\u80fd\u591f\u6b63\u786e\u5904\u7406UDP\uff0c\u5426\u5219\u5efa\u8bae\u5c06\u6587\u4ef6\u590d\u5236\u51fa\u6765\uff0c\u5728Host\u7aefWindows\u8fd0\u884c\u3002 \u7136\u540e\uff0c\u5c06\u4f60\u8981\u4f20\u5230\u5f00\u53d1\u677f\u4e0a\u7684\u88f8\u673a\u7a0b\u5e8f\uff08\u751a\u81f3Lab0\u7684\u6700\u7b80\u88f8\u673a\u7a0b\u5e8f\u4e5f\u662f\u53ef\u4ee5\u7684\uff09\uff0c\u653e\u5230tftp\u670d\u52a1\u5668\u8f6f\u4ef6\u8bbe\u5b9a\u7684\u6839\u76ee\u5f55\u4e0b\u3002 \u5728PMON\u4e2d\u8f7d\u5165\u5185\u6838 \u5728PMON\u4e2d\u6267\u884c\uff1a load tftp://169.254.0.1/ucore-kernel-initrd g \u6ce8\uff1auCore\u4e0d\u4f1a\u8bfb\u53d6Bootloader\u4f20\u9012\u7684Kernel command line\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u50cf\u542f\u52a8Linux\u4e00\u6837\u5728g\u540e\u9762\u6dfb\u52a0\u53c2\u6570\u3002","title":"5. \u5269\u4f59\u6d41\u7a0b"},{"location":"chiplab/n4ddr/#_3","text":"\u5982\u679c\u540c\u5b66\u4eec\u60f3\u8981\u5728\u8fd9\u4e2a\u5f00\u53d1\u677f\u4e0a\u8fd0\u884cLoongArch32\u7684Linux\uff0c\u53ef\u4ee5\u9605\u8bfb\u66f4\u591a\u8bf4\u660e\uff1a Chiplab\u5e2e\u52a9\u6587\u6863 Chiplab\u79fb\u690dN4DDR\u8bf4\u660e","title":"\u66f4\u591a\u5e2e\u52a9"},{"location":"faq/env/","text":"1. WSL2\u7684Ubuntu Docker\u65e0\u6cd5\u542f\u52a8 \u00b6 \u8fd9\u4e2a\u95ee\u9898\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u786e\u8ba4\uff1a sudo service docker status \u5982\u679c\u770b\u5230not running\u8bf4\u660e\u6ca1\u6709\u542f\u52a8\u3002 \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 dockerd -D \u547d\u4ee4\u67e5\u770b\u6ca1\u6709\u542f\u52a8\u7684\u539f\u56e0\uff0c\u4e0a\u7f51\u641c\u7d22\u76f8\u5173\u8d44\u6599\u3002 \u540c\u5b66\u4eec\u901a\u5e38\u4f7f\u7528Ubuntu 22.04\u9047\u5230\u7684\u95ee\u9898\u662fDocker\u4e0d\u652f\u6301\u65b0\u7248iptables\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u89e3\u51b3\uff1a sudo apt install iptables sudo update-alternatives --set iptables /usr/sbin/iptables-legacy sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy sudo service docker start 2. WSL2\u65e0\u6cd5\u8054\u7f51 \u00b6 \u5efa\u8bae\u5927\u5bb6\u907f\u514d\u4f7f\u7528\u7279\u6b8a\u7684\u7f51\u7edc\u73af\u5883\uff08\u5982VPN\uff09\uff0c\u5e76\u91cd\u542f\u7535\u8111\u540e\u518d\u8bd5\u3002 3. apt update\u65f6\u51fa\u73b0the public key is not available \u00b6 \u5927\u5bb6\u60f3\u60f3\u6211\u4eec\u52a0Docker\u6e90\u7684\u65f6\u5019\u4ec0\u4e48\u65f6\u5019\u6d89\u53ca\u8fc7\u5bc6\u94a5\uff1f\u786e\u4fdd\u7f51\u7edc\u6b63\u5e38\u7684\u60c5\u51b5\u4e0b\u91cd\u65b0\u6267\u884c\u90a3\u6761\u547d\u4ee4\u8bd5\u8bd5\u770b\u3002 4. apt install\u540e\u51fa\u73b0failed to retireve available kernel versions. \u00b6 \u4e0e\u4e4b\u4ff1\u6765\u7684\u8fd8\u6709failed to check for processor microcode upgrades. \u8fd9\u4e2a\u662f\u56e0\u4e3aWSL2\u7684Kernel\u88abWSL\u81ea\u8eab\u7ba1\u7406\uff0c\u865a\u62df\u673a\u4e5f\u4e0d\u9700\u8981microcode\u66f4\u65b0\uff0c\u56e0\u6b64\u8fd9\u4e2a\u63d0\u793a\u53ef\u4ee5\u5ffd\u7565\u3002 5. make\u65f6\u51fa\u73b0command not found \u00b6 \u540c\u5b66\u4f60\u8fdb\u5165Docker\u4e86\u5417\uff1f 6. \u865a\u62df\u673a\u56fe\u5f62\u64cd\u4f5c\u4e0d\u6d41\u7545 \u00b6 \u865a\u62df\u673a\u663e\u5361\u6027\u80fd\u8f83\u4f4e\uff0c\u5927\u5bb6\u53ef\u4ee5\u5728\u865a\u62df\u673a\u5916\u9762\u88c5VSCode\uff0c\u7136\u540eremote SSH\u8fde\u5230\u865a\u62df\u673a\u3002 7. WSL\u65e0\u6cd5\u5b89\u88c5\uff0c\u63d0\u793a\u8981\u5f00\u542f\u865a\u62df\u5316\uff0c\u4f46\u662f\u865a\u62df\u5316\u5df2\u7ecf\u5f00\u542f \u00b6 \u5f88\u6709\u53ef\u80fd\u662f\u6709\u4e9b\u540c\u5b66\u7528\u4e86\u4e00\u4e9b\u65e0\u6cd5\u548cWindows\u865a\u62df\u5316\u5e73\u53f0\u5171\u5b58\u7684\u8f6f\u4ef6\u5bfc\u81f4\u7684\u3002\u4f8b\u5982\u90e8\u5206Android\u6a21\u62df\u5668\uff08\u4e3a\u4ec0\u4e48\u4e0d\u4f7f\u7528 Windows 11 \u81ea\u5e26\u7684\u6027\u80fd\u66f4\u597d\u7684 Windows Subsystem for Android\u66ff\u4ee3\u5462\uff1f\uff09\u3002 \u8fd9\u4e9b\u8f6f\u4ef6\u4f1a\u4fee\u6539bcd\u7981\u7528\u865a\u62df\u5316\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u91cd\u65b0\u5f00\u542f\uff1a bcdedit / set hypervisorlaunchtype auto 8. WSL2\u91cc\u5b89\u88c5\u4e86Docker\uff0cVSCode\u627e\u4e0d\u5230 \u00b6 VSCode\u4e0d\u80fd\u8fdeWSL2\u91cc\u7684Docker\uff0c\u9700\u8981\u5148\u4f7f\u7528WSL Remote\u8fde\u5230WSL\u91cc\u7684VSCode\uff0c\u518d\u5728\u8fd9\u4e2a\u91cc\u9762\u88c5VSCode\u7684Docker\u63d2\u4ef6\u3002 9. apt\u7684https\u51fa\u73b0\u8bc1\u4e66\u9519\u8bef \u00b6 \u4e00\u822c\u6709\u4e24\u79cd\u60c5\u51b5\uff1a \u865a\u62df\u673a\u7f51\u5361\u7528\u4e86\u6865\u63a5\u6a21\u5f0f\uff0c\u4f46\u662f\u865a\u62df\u673a\u6ca1\u6709\u767b\u5f55\u6821\u56ed\u7f51\u3002 \u89e3\u51b3\u65b9\u6cd5\uff1a\u6539\u4e3aNAT\u6a21\u5f0f\uff0c\u5171\u4eab\u4f60\u7535\u8111\u7684IP\u5730\u5740\u4e0a\u7f51\u3002 \u4f7f\u7528\u7684Ubuntu\u7248\u672c\u8f83\u8001\uff0cCA\u8bc1\u4e66\u6ca1\u6709\u66f4\u65b0 \u4fee\u6539 /etc/apt/sources.list \uff0c\u5c06\u6240\u6709\u7684https\u6539\u4e3ahttp\uff0c\u7136\u540e\u91cd\u65b0\u6267\u884c apt update \u4e0e apt upgrade \u3002 10. \u6309\u7167\u6e05\u534e\u955c\u50cf\u7ad9\u5b89\u88c5Docker\u65e0\u6cd5\u6dfb\u52a0gpg\u5bc6\u94a5\uff0c\u63d0\u793ano such file or directory \u00b6 \u8fd8\u662fUbuntu\u7248\u672c\u95ee\u9898\uff0cUbuntu 20.04\u6ca1\u6709 /etc/apt/keyrings \u6587\u4ef6\u5939\uff0c\u9700\u8981\u5927\u5bb6\u81ea\u884c\u4f7f\u7528 mkdir -p /etc/apt/keyrings \u521b\u5efa\u3002 11. WSL\u4e2dattach VSCode\u65f6\u51fa\u73b0wsl ENOENT \u00b6 \u8fd9\u4e2a\u662f\u7531\u4e8e\u672c\u673a\u73af\u5883\u53d8\u91cf\u627e\u4e0d\u5230 wsl \u5bfc\u81f4\u7684\u3002 \u5148\u6253\u5f00\u4f60\u7684Windows\u7684\u7ec8\u7aef\uff0c\u770b\u770b\u8f93\u5165wsl\u80fd\u4e0d\u80fd\u6253\u5f00\u3002 \u82e5\u4e0d\u80fd\uff0c\u8bf7\u68c0\u67e5\u4f60\u7684\u7535\u8111\u73af\u5883\u53d8\u91cf\uff0c\u786e\u4fdd\u7cfb\u7edf\u7684Path\u4e2d\u5b58\u5728 %SystemRoot%\\system32 \uff0c\u82e5\u6ca1\u6709\u6dfb\u52a0\uff0c\u7136\u540e\u5b8c\u5168\u5173\u95edVisual Studio Code\u5e76\u91cd\u65b0\u6253\u5f00\u3002 \uff08\u52a9\u6559\u5341\u5206\u597d\u5947\u4e3a\u4ec0\u4e48\u4f1a\u6709\u5927\u91cf\u540c\u5b66\u51fa\u73b0\u540c\u6837\u7684\u5171\u6027\u95ee\u9898\uff0c\u8be5\u73af\u5883\u53d8\u91cf\u5728Windows\u5b89\u88c5\u540e\u5e94\u8be5\u662f\u9ed8\u8ba4\u5b58\u5728\u7684\uff0c\u96be\u9053\u662f\u770b\u4e86\u540c\u6837\u7684\u4e0d\u9760\u8c31\u914d\u73af\u5883\u6559\u7a0b\u90fd\u628asystem32\u4ecePath\u91cc\u5220\u4e86\uff1f\uff09 \u82e5\u80fd\uff0c\u52a9\u6559\u4e5f\u4e0d\u77e5\u9053\u662f\u4ec0\u4e48\u7384\u5b66\u95ee\u9898\uff0c\u5efa\u8bae\u81ea\u5df1\u4e0a\u7f51\u67e5\u627e\u76f8\u5173\u89e3\u51b3\u65b9\u6cd5\u3002 12. Visual Studio Code\u65e0\u6cd5Attach\u5230Docker\uff0c\u63d0\u793adocker\u5728Path\u4e2d\u627e\u4e0d\u5230\u3002 \u00b6 \u89e3\u51b3\u65b9\u6848\uff1a 1. \u5148\u5347\u7ea7\u5230\u6700\u65b0\u7248\u672cVisual Studio Code\uff0c\u8001\u7248\u672c\u5b58\u5728\u8fd9\u4e2a\u95ee\u9898\u3002 2. \u82e5\u4e0d\u80fd\u89e3\u51b3\uff0c\u53ef\u4ee5\u5148\u8003\u8651\u76f4\u63a5\u7528attach shell\u7684\u65b9\u6cd5\u4f7f\u7528Docker\uff0c\u6bcf\u6b21\u65b0\u5efa\u7ec8\u7aef\u91cd\u65b0attach\u65b0\u7684Shell\uff0c\u5e76cd\u5230\u5f53\u524d\u8def\u5f84\u5373\u53ef\u3002 13. gdb\u63d0\u793aThe program is not being run. \u00b6 \u8bf7\u540c\u5b66\u4eec\u4ed4\u7ec6\u67e5\u770bgdb\u8f93\u51fa\u7684\u63d0\u793a\uff0c\u5df2\u7ecf\u544a\u8bc9\u4e86\u4f60\u9700\u8981\u5c06\u4ec0\u4e48\u547d\u4ee4\u52a0\u5165\u5230~/.gdbinit\u6216/.gdbinit\u4e2d\u3002\u8fd9\u4e2a\u662f\u7531\u4e8egdb\u51fa\u4e8e\u5b89\u5168\u8003\u8651\u9ed8\u8ba4\u7981\u6b62\u4e86.gdbinit\u811a\u672c\u7684\u6267\u884c\u3002\u9632\u6b62\u7528\u6237\u4ece\u4e0d\u53ef\u4fe1\u7684\u6765\u6e90\u83b7\u53d6\u4e86\u67d0\u4e2a\u542b\u6709.gdbinit\u7684\u6587\u4ef6\u5939\u5e26\u6765\u8fdc\u7a0b\u6267\u884c\u3002 \u5982\u679c\u662f\u624b\u6253gdb\u7684\u540c\u5b66\uff0c\u8bf7\u786e\u4fddqemu\u901a\u8fc7-S\u542f\u52a8\u4e86gdb-server\uff0c\u5e76\u4f7f\u7528target remote :1234\u8fde\u63a5\u4e0aqemu\u3002 \u6765\u81ea\u52a9\u6559\u7684\u63d0\u9192 \u00b6 \u6700\u540e\uff0c\u8fd8\u662f\u5e0c\u671b\u5927\u5bb6\u80fd\u81ea\u5df1\u8bfb\u61c2\u9519\u8bef\u63d0\u793a\uff0c\u57f9\u517b\u81ea\u5df1\u89e3\u51b3\u95ee\u9898\u7684\u80fd\u529b\u3002 \u522b\u4eba\u6839\u636e\u4f60\u7684\u9519\u8bef\u544a\u8bc9\u4f60\u89e3\u51b3\u65b9\u6848\u53ea\u4e0d\u8fc7\u662f\u6cbb\u6807\u4e0d\u6cbb\u672c\uff0c\u5f53\u540c\u5b66\u4eec\u4ee5\u540e\u505a\u7684\u5de5\u4f5c\u57fa\u4e8e\u4e00\u4e9b\u6bd4\u8f83\u65b0\u7684\u6846\u67b6\u4ee5\u53ca\u5f00\u6e90\u4ee3\u7801\u65f6\u53ef\u80fd\u8fd8\u65f6\u5e38\u9700\u8981\u4fee\u8fd9\u4e9b\u5f00\u6e90\u4ee3\u7801\u672c\u8eab\u7684\u95ee\u9898\uff0c\u751a\u81f3\u7ecf\u5e38\u4f1a\u7ed9\u8fd9\u4e9b\u5f00\u6e90\u9879\u76ee\u63d0\u4ea4Patch\u3002\u8bda\u7136\uff0c\u89e3\u51b3\u95ee\u9898\u7684\u8fc7\u7a0b\u9700\u8981\u5f88\u591a\u7684\u57fa\u7840\u77e5\u8bc6\u4ee5\u53ca\u7ecf\u9a8c\uff0c\u4f46\u5e0c\u671b\u5927\u5bb6\u80fd\u591f\u5728\u9047\u5230\u8fd9\u79cd\u95ee\u9898\u65f6\uff0c\u80fd\u591f\u81ea\u5df1\u627e\u5230\u89e3\u51b3\u95ee\u9898\u7684\u601d\u8def\u3002 \u7ed9\u540c\u5b66\u4e00\u4e9b\u5efa\u8bae\uff1a \u5b66\u4f1a\u8bfb\u82f1\u6587\u7684\u9519\u8bef\u63d0\u793a\uff0c\u9047\u5230\u9519\u8bef\u662f\u6b63\u5e38\u7684\uff0c\u4e0d\u8981\u5bb3\u6015\u3002 \u5b66\u4f1a\u6839\u636e\u63d0\u793a\u4e0a\u7f51\u641c\u7d22\uff0c\u5e76\u5c1d\u8bd5\u7528\u82f1\u8bed\u4ee5\u53ca\u641c\u7d22\u82f1\u8bed\u8f83\u4e3a\u53cb\u597d\u7684\u641c\u7d22\u5f15\u64ce\u3002 \u67d0\u4e9b\u641c\u7d22\u5f15\u64ce\u5bf9\u4e8e\u67d0\u4e9b\u7f51\u7ad9SEO\u592a\u8fc7\u9760\u524d\u5f88\u5bb9\u6613\u641c\u5230\u4e00\u4e9b\u4e0d\u4e13\u4e1a\u7684\u5185\u5bb9\u3002\u8ba9\u4f60\u65e0\u6cd5\u4e86\u89e3\u95ee\u9898\u7684\u672c\u8d28\uff0c\u5bfc\u81f4\u4e00\u4e9b\u8fc7\u65f6\u7684\u95ee\u9898\u3002 \u8bf8\u5982Ubuntu\u6362\u4e86\u4e00\u4e2a\u65e7\u7248\u672c\u7684\u6e90\u7136\u540e\u7528aptitude\u6216\u8005apt install -f\u628a\u6574\u4e2a\u7cfb\u7edf\u7684\u8f6f\u4ef6\u5305\u4f9d\u8d56\u5b8c\u5168\u7834\u574f\uff0c\u6700\u540e\u53ea\u80fd\u91cd\u88c5\u7cfb\u7edf\u3002\u7136\u800c\u7528aptitude\u548capt install -f\u672c\u8eab\u5c31\u662f\u975e\u5e38\u9519\u8bef\u7684\u505a\u6cd5\u3002 \u5b66\u4f1a\u8bfb\u8f6f\u4ef6\u7684\u6587\u6863\u3002\u4ee5\u53caLinux\u4e0b\u5404\u79cd\u5de5\u5177\u7684man\u3002\u5f53\u65e0\u6cd5\u8bfb\u6587\u6863\u89e3\u51b3\u95ee\u9898\u65f6\uff0c\u6216\u8bb8\u6211\u4eec\u8fd8\u8981\u81ea\u5df1\u53bb\u9605\u8bfb\u76f8\u5173\u7684\u4ee3\u7801\u3002","title":"\u73af\u5883\u642d\u5efa"},{"location":"faq/env/#1-wsl2ubuntu-docker","text":"\u8fd9\u4e2a\u95ee\u9898\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u786e\u8ba4\uff1a sudo service docker status \u5982\u679c\u770b\u5230not running\u8bf4\u660e\u6ca1\u6709\u542f\u52a8\u3002 \u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 dockerd -D \u547d\u4ee4\u67e5\u770b\u6ca1\u6709\u542f\u52a8\u7684\u539f\u56e0\uff0c\u4e0a\u7f51\u641c\u7d22\u76f8\u5173\u8d44\u6599\u3002 \u540c\u5b66\u4eec\u901a\u5e38\u4f7f\u7528Ubuntu 22.04\u9047\u5230\u7684\u95ee\u9898\u662fDocker\u4e0d\u652f\u6301\u65b0\u7248iptables\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u89e3\u51b3\uff1a sudo apt install iptables sudo update-alternatives --set iptables /usr/sbin/iptables-legacy sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy sudo service docker start","title":"1. WSL2\u7684Ubuntu Docker\u65e0\u6cd5\u542f\u52a8"},{"location":"faq/env/#2-wsl2","text":"\u5efa\u8bae\u5927\u5bb6\u907f\u514d\u4f7f\u7528\u7279\u6b8a\u7684\u7f51\u7edc\u73af\u5883\uff08\u5982VPN\uff09\uff0c\u5e76\u91cd\u542f\u7535\u8111\u540e\u518d\u8bd5\u3002","title":"2. WSL2\u65e0\u6cd5\u8054\u7f51"},{"location":"faq/env/#3-apt-updatethe-public-key-is-not-available","text":"\u5927\u5bb6\u60f3\u60f3\u6211\u4eec\u52a0Docker\u6e90\u7684\u65f6\u5019\u4ec0\u4e48\u65f6\u5019\u6d89\u53ca\u8fc7\u5bc6\u94a5\uff1f\u786e\u4fdd\u7f51\u7edc\u6b63\u5e38\u7684\u60c5\u51b5\u4e0b\u91cd\u65b0\u6267\u884c\u90a3\u6761\u547d\u4ee4\u8bd5\u8bd5\u770b\u3002","title":"3. apt update\u65f6\u51fa\u73b0the public key is not available"},{"location":"faq/env/#4-apt-installfailed-to-retireve-available-kernel-versions","text":"\u4e0e\u4e4b\u4ff1\u6765\u7684\u8fd8\u6709failed to check for processor microcode upgrades. \u8fd9\u4e2a\u662f\u56e0\u4e3aWSL2\u7684Kernel\u88abWSL\u81ea\u8eab\u7ba1\u7406\uff0c\u865a\u62df\u673a\u4e5f\u4e0d\u9700\u8981microcode\u66f4\u65b0\uff0c\u56e0\u6b64\u8fd9\u4e2a\u63d0\u793a\u53ef\u4ee5\u5ffd\u7565\u3002","title":"4. apt install\u540e\u51fa\u73b0failed to retireve available kernel versions."},{"location":"faq/env/#5-makecommand-not-found","text":"\u540c\u5b66\u4f60\u8fdb\u5165Docker\u4e86\u5417\uff1f","title":"5. make\u65f6\u51fa\u73b0command not found"},{"location":"faq/env/#6","text":"\u865a\u62df\u673a\u663e\u5361\u6027\u80fd\u8f83\u4f4e\uff0c\u5927\u5bb6\u53ef\u4ee5\u5728\u865a\u62df\u673a\u5916\u9762\u88c5VSCode\uff0c\u7136\u540eremote SSH\u8fde\u5230\u865a\u62df\u673a\u3002","title":"6. \u865a\u62df\u673a\u56fe\u5f62\u64cd\u4f5c\u4e0d\u6d41\u7545"},{"location":"faq/env/#7-wsl","text":"\u5f88\u6709\u53ef\u80fd\u662f\u6709\u4e9b\u540c\u5b66\u7528\u4e86\u4e00\u4e9b\u65e0\u6cd5\u548cWindows\u865a\u62df\u5316\u5e73\u53f0\u5171\u5b58\u7684\u8f6f\u4ef6\u5bfc\u81f4\u7684\u3002\u4f8b\u5982\u90e8\u5206Android\u6a21\u62df\u5668\uff08\u4e3a\u4ec0\u4e48\u4e0d\u4f7f\u7528 Windows 11 \u81ea\u5e26\u7684\u6027\u80fd\u66f4\u597d\u7684 Windows Subsystem for Android\u66ff\u4ee3\u5462\uff1f\uff09\u3002 \u8fd9\u4e9b\u8f6f\u4ef6\u4f1a\u4fee\u6539bcd\u7981\u7528\u865a\u62df\u5316\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u91cd\u65b0\u5f00\u542f\uff1a bcdedit / set hypervisorlaunchtype auto","title":"7. WSL\u65e0\u6cd5\u5b89\u88c5\uff0c\u63d0\u793a\u8981\u5f00\u542f\u865a\u62df\u5316\uff0c\u4f46\u662f\u865a\u62df\u5316\u5df2\u7ecf\u5f00\u542f"},{"location":"faq/env/#8-wsl2dockervscode","text":"VSCode\u4e0d\u80fd\u8fdeWSL2\u91cc\u7684Docker\uff0c\u9700\u8981\u5148\u4f7f\u7528WSL Remote\u8fde\u5230WSL\u91cc\u7684VSCode\uff0c\u518d\u5728\u8fd9\u4e2a\u91cc\u9762\u88c5VSCode\u7684Docker\u63d2\u4ef6\u3002","title":"8. WSL2\u91cc\u5b89\u88c5\u4e86Docker\uff0cVSCode\u627e\u4e0d\u5230"},{"location":"faq/env/#9-apthttps","text":"\u4e00\u822c\u6709\u4e24\u79cd\u60c5\u51b5\uff1a \u865a\u62df\u673a\u7f51\u5361\u7528\u4e86\u6865\u63a5\u6a21\u5f0f\uff0c\u4f46\u662f\u865a\u62df\u673a\u6ca1\u6709\u767b\u5f55\u6821\u56ed\u7f51\u3002 \u89e3\u51b3\u65b9\u6cd5\uff1a\u6539\u4e3aNAT\u6a21\u5f0f\uff0c\u5171\u4eab\u4f60\u7535\u8111\u7684IP\u5730\u5740\u4e0a\u7f51\u3002 \u4f7f\u7528\u7684Ubuntu\u7248\u672c\u8f83\u8001\uff0cCA\u8bc1\u4e66\u6ca1\u6709\u66f4\u65b0 \u4fee\u6539 /etc/apt/sources.list \uff0c\u5c06\u6240\u6709\u7684https\u6539\u4e3ahttp\uff0c\u7136\u540e\u91cd\u65b0\u6267\u884c apt update \u4e0e apt upgrade \u3002","title":"9. apt\u7684https\u51fa\u73b0\u8bc1\u4e66\u9519\u8bef"},{"location":"faq/env/#10-dockergpgno-such-file-or-directory","text":"\u8fd8\u662fUbuntu\u7248\u672c\u95ee\u9898\uff0cUbuntu 20.04\u6ca1\u6709 /etc/apt/keyrings \u6587\u4ef6\u5939\uff0c\u9700\u8981\u5927\u5bb6\u81ea\u884c\u4f7f\u7528 mkdir -p /etc/apt/keyrings \u521b\u5efa\u3002","title":"10. \u6309\u7167\u6e05\u534e\u955c\u50cf\u7ad9\u5b89\u88c5Docker\u65e0\u6cd5\u6dfb\u52a0gpg\u5bc6\u94a5\uff0c\u63d0\u793ano such file or directory"},{"location":"faq/env/#11-wslattach-vscodewsl-enoent","text":"\u8fd9\u4e2a\u662f\u7531\u4e8e\u672c\u673a\u73af\u5883\u53d8\u91cf\u627e\u4e0d\u5230 wsl \u5bfc\u81f4\u7684\u3002 \u5148\u6253\u5f00\u4f60\u7684Windows\u7684\u7ec8\u7aef\uff0c\u770b\u770b\u8f93\u5165wsl\u80fd\u4e0d\u80fd\u6253\u5f00\u3002 \u82e5\u4e0d\u80fd\uff0c\u8bf7\u68c0\u67e5\u4f60\u7684\u7535\u8111\u73af\u5883\u53d8\u91cf\uff0c\u786e\u4fdd\u7cfb\u7edf\u7684Path\u4e2d\u5b58\u5728 %SystemRoot%\\system32 \uff0c\u82e5\u6ca1\u6709\u6dfb\u52a0\uff0c\u7136\u540e\u5b8c\u5168\u5173\u95edVisual Studio Code\u5e76\u91cd\u65b0\u6253\u5f00\u3002 \uff08\u52a9\u6559\u5341\u5206\u597d\u5947\u4e3a\u4ec0\u4e48\u4f1a\u6709\u5927\u91cf\u540c\u5b66\u51fa\u73b0\u540c\u6837\u7684\u5171\u6027\u95ee\u9898\uff0c\u8be5\u73af\u5883\u53d8\u91cf\u5728Windows\u5b89\u88c5\u540e\u5e94\u8be5\u662f\u9ed8\u8ba4\u5b58\u5728\u7684\uff0c\u96be\u9053\u662f\u770b\u4e86\u540c\u6837\u7684\u4e0d\u9760\u8c31\u914d\u73af\u5883\u6559\u7a0b\u90fd\u628asystem32\u4ecePath\u91cc\u5220\u4e86\uff1f\uff09 \u82e5\u80fd\uff0c\u52a9\u6559\u4e5f\u4e0d\u77e5\u9053\u662f\u4ec0\u4e48\u7384\u5b66\u95ee\u9898\uff0c\u5efa\u8bae\u81ea\u5df1\u4e0a\u7f51\u67e5\u627e\u76f8\u5173\u89e3\u51b3\u65b9\u6cd5\u3002","title":"11. WSL\u4e2dattach VSCode\u65f6\u51fa\u73b0wsl ENOENT"},{"location":"faq/env/#12-visual-studio-codeattachdockerdockerpath","text":"\u89e3\u51b3\u65b9\u6848\uff1a 1. \u5148\u5347\u7ea7\u5230\u6700\u65b0\u7248\u672cVisual Studio Code\uff0c\u8001\u7248\u672c\u5b58\u5728\u8fd9\u4e2a\u95ee\u9898\u3002 2. \u82e5\u4e0d\u80fd\u89e3\u51b3\uff0c\u53ef\u4ee5\u5148\u8003\u8651\u76f4\u63a5\u7528attach shell\u7684\u65b9\u6cd5\u4f7f\u7528Docker\uff0c\u6bcf\u6b21\u65b0\u5efa\u7ec8\u7aef\u91cd\u65b0attach\u65b0\u7684Shell\uff0c\u5e76cd\u5230\u5f53\u524d\u8def\u5f84\u5373\u53ef\u3002","title":"12. Visual Studio Code\u65e0\u6cd5Attach\u5230Docker\uff0c\u63d0\u793adocker\u5728Path\u4e2d\u627e\u4e0d\u5230\u3002"},{"location":"faq/env/#13-gdbthe-program-is-not-being-run","text":"\u8bf7\u540c\u5b66\u4eec\u4ed4\u7ec6\u67e5\u770bgdb\u8f93\u51fa\u7684\u63d0\u793a\uff0c\u5df2\u7ecf\u544a\u8bc9\u4e86\u4f60\u9700\u8981\u5c06\u4ec0\u4e48\u547d\u4ee4\u52a0\u5165\u5230~/.gdbinit\u6216/.gdbinit\u4e2d\u3002\u8fd9\u4e2a\u662f\u7531\u4e8egdb\u51fa\u4e8e\u5b89\u5168\u8003\u8651\u9ed8\u8ba4\u7981\u6b62\u4e86.gdbinit\u811a\u672c\u7684\u6267\u884c\u3002\u9632\u6b62\u7528\u6237\u4ece\u4e0d\u53ef\u4fe1\u7684\u6765\u6e90\u83b7\u53d6\u4e86\u67d0\u4e2a\u542b\u6709.gdbinit\u7684\u6587\u4ef6\u5939\u5e26\u6765\u8fdc\u7a0b\u6267\u884c\u3002 \u5982\u679c\u662f\u624b\u6253gdb\u7684\u540c\u5b66\uff0c\u8bf7\u786e\u4fddqemu\u901a\u8fc7-S\u542f\u52a8\u4e86gdb-server\uff0c\u5e76\u4f7f\u7528target remote :1234\u8fde\u63a5\u4e0aqemu\u3002","title":"13. gdb\u63d0\u793aThe program is not being run."},{"location":"faq/env/#_1","text":"\u6700\u540e\uff0c\u8fd8\u662f\u5e0c\u671b\u5927\u5bb6\u80fd\u81ea\u5df1\u8bfb\u61c2\u9519\u8bef\u63d0\u793a\uff0c\u57f9\u517b\u81ea\u5df1\u89e3\u51b3\u95ee\u9898\u7684\u80fd\u529b\u3002 \u522b\u4eba\u6839\u636e\u4f60\u7684\u9519\u8bef\u544a\u8bc9\u4f60\u89e3\u51b3\u65b9\u6848\u53ea\u4e0d\u8fc7\u662f\u6cbb\u6807\u4e0d\u6cbb\u672c\uff0c\u5f53\u540c\u5b66\u4eec\u4ee5\u540e\u505a\u7684\u5de5\u4f5c\u57fa\u4e8e\u4e00\u4e9b\u6bd4\u8f83\u65b0\u7684\u6846\u67b6\u4ee5\u53ca\u5f00\u6e90\u4ee3\u7801\u65f6\u53ef\u80fd\u8fd8\u65f6\u5e38\u9700\u8981\u4fee\u8fd9\u4e9b\u5f00\u6e90\u4ee3\u7801\u672c\u8eab\u7684\u95ee\u9898\uff0c\u751a\u81f3\u7ecf\u5e38\u4f1a\u7ed9\u8fd9\u4e9b\u5f00\u6e90\u9879\u76ee\u63d0\u4ea4Patch\u3002\u8bda\u7136\uff0c\u89e3\u51b3\u95ee\u9898\u7684\u8fc7\u7a0b\u9700\u8981\u5f88\u591a\u7684\u57fa\u7840\u77e5\u8bc6\u4ee5\u53ca\u7ecf\u9a8c\uff0c\u4f46\u5e0c\u671b\u5927\u5bb6\u80fd\u591f\u5728\u9047\u5230\u8fd9\u79cd\u95ee\u9898\u65f6\uff0c\u80fd\u591f\u81ea\u5df1\u627e\u5230\u89e3\u51b3\u95ee\u9898\u7684\u601d\u8def\u3002 \u7ed9\u540c\u5b66\u4e00\u4e9b\u5efa\u8bae\uff1a \u5b66\u4f1a\u8bfb\u82f1\u6587\u7684\u9519\u8bef\u63d0\u793a\uff0c\u9047\u5230\u9519\u8bef\u662f\u6b63\u5e38\u7684\uff0c\u4e0d\u8981\u5bb3\u6015\u3002 \u5b66\u4f1a\u6839\u636e\u63d0\u793a\u4e0a\u7f51\u641c\u7d22\uff0c\u5e76\u5c1d\u8bd5\u7528\u82f1\u8bed\u4ee5\u53ca\u641c\u7d22\u82f1\u8bed\u8f83\u4e3a\u53cb\u597d\u7684\u641c\u7d22\u5f15\u64ce\u3002 \u67d0\u4e9b\u641c\u7d22\u5f15\u64ce\u5bf9\u4e8e\u67d0\u4e9b\u7f51\u7ad9SEO\u592a\u8fc7\u9760\u524d\u5f88\u5bb9\u6613\u641c\u5230\u4e00\u4e9b\u4e0d\u4e13\u4e1a\u7684\u5185\u5bb9\u3002\u8ba9\u4f60\u65e0\u6cd5\u4e86\u89e3\u95ee\u9898\u7684\u672c\u8d28\uff0c\u5bfc\u81f4\u4e00\u4e9b\u8fc7\u65f6\u7684\u95ee\u9898\u3002 \u8bf8\u5982Ubuntu\u6362\u4e86\u4e00\u4e2a\u65e7\u7248\u672c\u7684\u6e90\u7136\u540e\u7528aptitude\u6216\u8005apt install -f\u628a\u6574\u4e2a\u7cfb\u7edf\u7684\u8f6f\u4ef6\u5305\u4f9d\u8d56\u5b8c\u5168\u7834\u574f\uff0c\u6700\u540e\u53ea\u80fd\u91cd\u88c5\u7cfb\u7edf\u3002\u7136\u800c\u7528aptitude\u548capt install -f\u672c\u8eab\u5c31\u662f\u975e\u5e38\u9519\u8bef\u7684\u505a\u6cd5\u3002 \u5b66\u4f1a\u8bfb\u8f6f\u4ef6\u7684\u6587\u6863\u3002\u4ee5\u53caLinux\u4e0b\u5404\u79cd\u5de5\u5177\u7684man\u3002\u5f53\u65e0\u6cd5\u8bfb\u6587\u6863\u89e3\u51b3\u95ee\u9898\u65f6\uff0c\u6216\u8bb8\u6211\u4eec\u8fd8\u8981\u81ea\u5df1\u53bb\u9605\u8bfb\u76f8\u5173\u7684\u4ee3\u7801\u3002","title":"\u6765\u81ea\u52a9\u6559\u7684\u63d0\u9192"},{"location":"lab0/bare-prog/","text":"\u521d\u8bc6\u88f8\u673a\u7a0b\u5e8f \u00b6 \u6211\u4eec\u4ee5\u5f80\u5199\u7528\u6237\u7a0b\u5e8f\u65f6\uff0c\u901a\u5e38\u90fd\u53ea\u5173\u6ce8\u4ee3\u7801\u672c\u8eab\uff0c\u800c\u5c06\u8fd0\u884c\u65f6\u7684\u73af\u5883\u4ea4\u7ed9\u4e86\u7f16\u8bd1\u5668\u7b49\u7cfb\u7edf\u8f6f\u4ef6\u8fdb\u884c\u5904\u7406\uff0c\u4f46\u6211\u4eec\u82e5\u8981\u7f16\u5199\u88f8\u673a\u7a0b\u5e8f\uff0c\u5c31\u9700\u8981\u8fdb\u4e00\u6b65\u63ed\u5f00\u8fd0\u884c\u65f6\u73af\u5883\u7684\u795e\u79d8\u9762\u7eb1\u3002 \u5f3a\u70c8\u5efa\u8bae\u540c\u5b66\u4eec\u9605\u8bfb\u300a\u7a0b\u5e8f\u5458\u7684\u81ea\u6211\u4fee\u517b\uff1a\u94fe\u63a5\u3001\u88c5\u8f7d\u4e0e\u5e93\u300b\uff0c\u4f1a\u5bf9\u8fd9\u4e9b\u95ee\u9898\u6709\u66f4\u52a0\u6e05\u6670\u7684\u8ba4\u8bc6\uff0c\u5728\u91cd\u5e86\u5927\u5b66A\u533a\u4e0e\u864e\u6eaa\u7684\u56fe\u4e66\u9986\u5747\u6709\u9986\u85cf\u3002 \u4e0b\u8868\u63ed\u793a\u4e86\u88f8\u673a\u7a0b\u5e8f\u4e0e\u7528\u6237\u7a0b\u5e8f\u7684\u533a\u522b\uff1a \u5bf9\u6bd4\u5bf9\u8c61 \u88f8\u673a\u7a0b\u5e8f \u5e38\u89c4\u7528\u6237\u7a0b\u5e8f \u5185\u5b58\u5730\u5740\u7a7a\u95f4 \u81ea\u884c\u7ba1\u7406\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u53ef\u4ee5\u81ea\u884c\u5bf9\u865a\u62df\u5185\u5b58\u8fdb\u884c\u914d\u7f6e\u540e\u4f7f\u81ea\u5df1\u8fd0\u884c\u5728\u865a\u62df\u5730\u5740\u7a7a\u95f4 \u7531\u64cd\u4f5c\u7cfb\u7edf\u7ba1\u7406\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff08\u4e0d\u8003\u8651Linux NOMMU\u6a21\u5f0f\uff09 \u7cfb\u7edf\u8c03\u7528 \u8c03\u7528\u81ea\u5df1 \u8c03\u7528\u66f4\u9ad8\u7279\u6743\u7ea7\u7684\u64cd\u4f5c\u7cfb\u7edf/\u56fa\u4ef6 \u6808\u7684\u521d\u59cb\u5316 \u81ea\u884c\u5b8c\u6210 \u64cd\u4f5c\u7cfb\u7edf\u8f7d\u5165\u7528\u6237\u8fdb\u7a0b\u65f6\u5b8c\u6210\uff08\u6bd5\u7adf\u8fd8\u8981\u901a\u8fc7\u6808\u4f20\u9012\u53c2\u6570\uff09 BSS\u6bb5\u7684\u6e05\u7a7a \u81ea\u884c\u5b8c\u6210 \u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u865a\u62df\u9875\u9762\u65f6\u5b8c\u6210\u6e05\u96f6 \u8bb8\u591a\u540c\u5b66\u53ef\u80fd\u5bf9\u4e8e\u4e0a\u8868\u5df2\u7ecf\u770b\u61f5\u4e86\uff0c\u4e0d\u660e\u767d\u8fd9\u4e9b\u540d\u8bcd\u7684\u5177\u4f53\u542b\u4e49\uff0c\u6ca1\u5173\u7cfb\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u4e00\u4e00\u89e3\u91ca\uff1a \u8c03\u7528\u6808 \u00b6 \u6211\u4eec\u77e5\u9053\u7f16\u5199\u7684\u7a0b\u5e8f\u53ef\u4ee5\u8fdb\u884c\u51fd\u6570\u8c03\u7528\uff0c\u4e5f\u53ef\u4ee5\u5728\u8c03\u7528\u540e\u8fd4\u56de\u3002\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u601d\u8003\uff0c\u8bb0\u5f55\u51fd\u6570\u6267\u884c\u4f4d\u7f6e\uff0c\u5305\u62ec\u5c40\u90e8\u53d8\u91cf\u7684\u72b6\u6001\u7b49\u53ef\u4ee5\u91c7\u7528\u4e00\u79cd\u5148\u8fdb\u540e\u51fa\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4e5f\u5c31\u662f\u6808\u3002\u8fd9\u4e2a\u8c03\u7528\u6808\u7684\u6570\u636e\u7ed3\u6784\u5728\u4e0d\u540c\u7684\u6307\u4ee4\u96c6\u67b6\u6784\u7684ABI\uff08Application Binary Interface\uff09\u4e2d\u5b9a\u4e49\u4e0d\u540c\u3002\u4e14\u5b83\u7684\u751f\u957f\u65b9\u5f0f\u662f\u5411\u4e0b\u751f\u957f\u3002 \u4f46\u6211\u4eec\u9700\u8981\u5148\u5206\u914d\u51fa\u4e00\u4e2a\u6808\uff0c\u624d\u80fd\u8fd0\u884c\u8fd9\u79cd\u80fd\u8fdb\u884c\u51fd\u6570\u8c03\u7528\u7684C\u8bed\u8a00\u7a0b\u5e8f\u3002\u56e0\u6b64\u5bf9\u4e8e\u88f8\u673a\u7a0b\u5e8f\u800c\u8a00\uff0c\u6211\u4eec\u9700\u8981\u5728\u6c47\u7f16\u7a0b\u5e8f\u91cc\u5148\u521d\u59cb\u5316GPR\uff08\u901a\u7528\u5bc4\u5b58\u5668\uff09\u7684sp\u6307\u9488\uff0c\u624d\u80fd\u8fdb\u5165C\u7a0b\u5e8f\u3002 \u7a0b\u5e8f\u91cc\u7684\u5404\u4e2a\u5b58\u50a8\u533a \u00b6 \u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u8fd0\u884c\u4ee5\u4e0b\u5b9e\u9a8c\uff0c\u7f16\u5199\u5982\u4e0bC\u8bed\u8a00\u7a0b\u5e8f\uff1a hello.c 1 2 3 4 5 #include <stdio.h> int main () { printf ( \"Hello World \\n \" ); return 0 ; } \u7136\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u7f16\u8bd1\u4e3a\u76ee\u6807\u6587\u4ef6\u5e76\u67e5\u770b\u76ee\u6807\u6587\u4ef6\u7684\u5934\uff1a \u279c gcc hello.c -c -o hello.o \u279c objdump -h hello.o hello.o: file format elf64-x86-64 Sections: Idx Name Size VMA LMA File off Algn 0 .text 0000001a 0000000000000000 0000000000000000 00000040 2 **0 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE 1 .data 00000000 0000000000000000 0000000000000000 0000005a 2 **0 CONTENTS, ALLOC, LOAD, DATA 2 .bss 00000000 0000000000000000 0000000000000000 0000005a 2 **0 ALLOC 3 .rodata 0000000c 0000000000000000 0000000000000000 0000005a 2 **0 CONTENTS, ALLOC, LOAD, READONLY, DATA 4 .comment 0000001f 0000000000000000 0000000000000000 00000066 2 **0 CONTENTS, READONLY 5 .note.GNU-stack 00000000 0000000000000000 0000000000000000 00000085 2 **0 CONTENTS, READONLY 6 .eh_frame 00000038 0000000000000000 0000000000000000 00000088 2 **3 CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA \u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u7684\u7a0b\u5e8f\u5206\u4e3a\u4e86 .text \u3001 .data \u3001 .bss \u3001 .rodata \u5404\u5b58\u50a8\u6bb5\u3002 \u5176\u4e2d\uff1a .text \u662f\u4ee3\u7801\u6bb5\uff0c\u653e\u7f6e\u7684\u662f\u6211\u4eec\u7684\u7a0b\u5e8f\u7f16\u8bd1\u540e\u7684\u4ee3\u7801\u3002 .data \u662f\u6570\u636e\u6bb5\uff0c\u8fd9\u91cc\u653e\u7684\u662f\u521d\u59cb\u5316\u8fc7\u7684\u9759\u6001\u53d8\u91cf\uff08\u5305\u542b\u5168\u5c40\u53d8\u91cf\u8fd8\u6709 static \u4fee\u9970\u540e\u7684\u5c40\u90e8\u53d8\u91cf\uff09\u3002 .bss \u662f\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u9759\u6001\u53d8\u91cf\u7684\u533a\u57df\u3002\u800c\u5728ELF\u6587\u4ef6\u4e2d\uff0c\u5b83\u5e76\u4e0d\u5b9e\u9645\u5b58\u50a8\u6570\u636e\uff0c\u4ec5\u7528\u4e8e\u544a\u77e5\u64cd\u4f5c\u7cfb\u7edf\u8f7d\u5165\u8fdb\u7a0b\u65f6\u8be5\u6bb5\u5408\u6cd5\u5730\u5740\u7684\u5b58\u5728\u3002 .rodata \u5b58\u653e\u7684\u662f\u53ea\u8bfb\u6570\u636e\uff0c\u4f8b\u5982\u5b57\u7b26\u4e32\u5e38\u91cf\u4e0e\u5168\u5c40const\u53d8\u91cf\u5c31\u5b58\u653e\u5728\u8fd9\u4e2a\u4f4d\u7f6e\u3002 \u8fd9\u4e9b\u6bb5\u7684\u5143\u6570\u636e\u653e\u5728\u6211\u4eec\u7f16\u8bd1\u7684\u4ea7\u7269\uff08ELF\u6587\u4ef6\uff09\u7684\u5934\u90e8\u5206\u3002 \u94fe\u63a5 \u00b6 \u6211\u4eec\u5728\u5927\u4e00\u7684\u201c\u7a0b\u5e8f\u8bbe\u8ba1\u57fa\u7840\u201d\u8bfe\u7a0b\u5e94\u8be5\u5df2\u7ecf\u5b66\u8fc7\u591a\u6587\u4ef6\u7684C\u8bed\u8a00\u7a0b\u5e8f\u7f16\u5199\u4ee5\u53ca\u94fe\u63a5\u8fc7\u7a0b\uff0c\u540c\u5b66\u4eec\u5e94\u8be5\u4e5f\u5728\u5176\u4e2d\u5b66\u4e60\u4e86Makefile\u7684\u57fa\u672c\u4f7f\u7528\u3002 \u8bb8\u591a\u540c\u5b66\u4e5f\u8bb8\u4f1a\u597d\u5947\uff0c\u94fe\u63a5\u5668\u662f\u5982\u4f55\u5c06\u8fd9\u4e9b\u672a\u5b9a\u4e49\u7684\u51fd\u6570\u627e\u5230\u5bf9\u5e94\u7684\u4f4d\u7f6e\u5e76\u8fdb\u884c\u94fe\u63a5\u7684\u5462\uff1f \u8fd9\u91cc\u6211\u4eec\u5c31\u5f97\u6d89\u53ca\u5230\u4e00\u4e2a\u7b26\u53f7\u8868\u7684\u6982\u5ff5\uff0c\u5728\u6211\u4eec\u7f16\u8bd1\u4ea7\u751f\u7684ELF\u6587\u4ef6\u4e2d\uff0c\u8fd8\u6709\u4e00\u4e2a\u5b58\u653e\u7b26\u53f7\u8868\u7684\u533a\u57df\uff0c\u5176\u4e2d\u7b26\u53f7\u6307\u7684\u662f\u51fd\u6570\u3001\u53d8\u91cf\u7b49\u7684\u540d\u5b57\uff0c\u5e76\u8bb0\u5f55\u4ed6\u4eec\u5bf9\u5e94\u7684\u5730\u5740\u3002\u8fd9\u6837\u5728\u94fe\u63a5\u65f6\u5c31\u77e5\u9053\u80fd\u591f\u77e5\u9053\u5bf9\u5e94\u7684\u4f4d\u7f6e\uff0c\u4ece\u800c\u8fdb\u884c\u94fe\u63a5\uff0c\u751f\u6210\u51fa\u4e00\u4e2a\u66f4\u5927\u7684\u53ef\u6267\u884c\u7a0b\u5e8f\u3002 \u800c\u5bf9\u4e8e\u88f8\u673a\u7a0b\u5e8f\uff0c\u6211\u4eec\u8fd8\u6709\u4e00\u4e2a\u9700\u6c42\u662f\u8bbe\u5b9a\u7a0b\u5e8f\u5404\u5b58\u50a8\u6bb5\u7684\u6392\u5e03\u4ee5\u53ca\u5730\u5740\u504f\u79fb\u91cf\u3002\u5730\u5740\u504f\u79fb\u91cf\u53ef\u4ee5\u544a\u77e5\u7f16\u8bd1\u5668\u8fdb\u884c\u76f4\u63a5\u8df3\u8f6c\u65f6\u6240\u9700\u8981\u7684\u5730\u5740\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u5f15\u5165\u4e00\u4e2a\u53eb\u505ald\u811a\u672c\u7684\u4e1c\u897f\uff0c\u5b83\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u89c4\u5212\u9700\u8981\u653e\u5165\u6700\u7ec8\u7f16\u8bd1\u7ed3\u679c\u7684\u5404\u6bb5\u7684\u5730\u5740\u3002 Note \u5c0f\u601d\u8003\uff1a \u64cd\u4f5c\u7cfb\u7edf\u7ed9\u7528\u6237\u8fdb\u7a0b\u5206\u914d\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u65f6\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981\u5c06\u5bf9\u5e94\u9875\u9762\u6e05\u96f6\u540e\u518d\u5206\u914d\uff1f\u5982\u679c\u4e0d\u6e05\u96f6\u4f1a\u5bfc\u81f4\u4ec0\u4e48\u95ee\u9898\uff1f\uff08\u53ef\u4ee5\u4ece\u5b89\u5168\u7b49\u89d2\u5ea6\u8003\u8651\uff09 \u6211\u4eec\u5199C\u8bed\u8a00\u7a0b\u5e8f\u65f6\u5f00\u7684\u5c40\u90e8\u53d8\u91cf\u4e0d\u8d4b\u521d\u59cb\u503c\u4e3a\u4ec0\u4e48\u7ecf\u5e38\u4f1a\u5f97\u5230\u4e00\u4e2a\u968f\u673a\u6570\uff1f\u662f\u5426\u4e0e\u524d\u9762\u63d0\u5230\u64cd\u4f5c\u7cfb\u7edf\u7ed9\u7528\u6237\u8fdb\u7a0b\u5206\u914d\u865a\u62df\u9875\u9762\u65f6\u4f1a\u8fdb\u884c\u6e05\u96f6\u7684\u7ed3\u8bba\u76f8\u6096\uff1f Linux NOMMU\u4e3a\u4ec0\u4e48\u53ea\u5728\u90e8\u5206\u6307\u4ee4\u96c6\u67b6\u6784\u5b58\u5728\uff1f\u90e8\u5206\u5b58\u5728NOMMU\u7684\u6307\u4ee4\u96c6\uff08\u5982RISC-V\uff09\u63d0\u4f9b\u4e86\u4ec0\u4e48\u9694\u79bb\u673a\u5236\u786e\u4fdd\u4e00\u4e2a\u8fdb\u7a0b\u65e0\u6cd5\u4fee\u6539\u5176\u4ed6\u8fdb\u7a0b\u7684\u6570\u636e\uff1f \u4e3a\u4ec0\u4e48\u6211\u4eec\u5728\u88f8\u673a\u7a0b\u5e8f\u4e2d\u53ef\u4ee5\u6682\u65f6\u4e0d\u8003\u8651malloc\uff08new\uff09\u8fd9\u79cd\u5806\u5185\u5b58\u5206\u914d\uff1f \u6808\u80fd\u4e0d\u80fd\u6539\u6210\u5411\u4e0a\u751f\u957f\uff1f\u6709\u4ec0\u4e48\u5229\u5f0a\uff1f \u7ed3\u5408\u7a0b\u5e8f\u7684\u5404\u6bb5\u6240\u9700\u7684\u6700\u5c0f\u6743\u9650\u4e0d\u540c\uff0c\u5904\u7406\u5668\u7684MMU\u53ef\u4ee5\u63d0\u4f9b\u54ea\u4e9b\u6743\u9650\u63a7\u5236\u4f4d\u786e\u4fdd\u7a0b\u5e8f\u56e0\u4e3a\u6f0f\u6d1e\u5bfc\u81f4\u4efb\u610f\u5185\u5b58\u8bfb\u5199\u65f6\uff0c\u653b\u51fb\u8005\u80fd\u7834\u574f\u7684\u6570\u636e\u8303\u56f4\u6700\u4f4e\uff1f\u4f8b\u5982\u5982\u4f55\u624d\u80fd\u8ba9.text\u6bb5\u548c.rodata\u6bb5\u4e0d\u88ab\u4fee\u6539\uff0c\u5176\u4ed6\u6bb5\u7684\u6570\u636e\u4e0d\u53ef\u88ab\u6267\u884c\uff1f\u5982\u679c\u653b\u51fb\u8005\u6709\u80fd\u529b\u7834\u574f\u9875\u8868\uff0c\u8fd8\u6709\u4ec0\u4e48\u5b89\u5168\u673a\u5236\u53ef\u4ee5\u52a0\u5165\u5904\u7406\u5668\u4e2d\u8fdb\u884c\u66f4\u597d\u7684\u4fdd\u62a4\uff1f \u7f16\u5199\u4e00\u4e2a\u88f8\u673a\u7a0b\u5e8f \u00b6 \u81f3\u6b64\uff0c\u6211\u4eec\u5f00\u59cb\u771f\u6b63\u7f16\u5199\u4e00\u4e2a\u88f8\u673a\u7a0b\u5e8f\uff0c\u5927\u5bb6\u5728\u642d\u5efa\u597d\u7684\u73af\u5883\u4e2d\u65b0\u5efa\u6587\u4ef6\u5939\uff0c\u4e00\u6b65\u6b65\u5f00\u59cb\u5427\uff01 \u521d\u59cb\u5316\u7684\u6c47\u7f16\u4ee3\u7801 \u00b6 start.S 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 .extern main .text .globl _start _start: # Config direct window and set PG li.w $t0 , 0xa0000011 csrwr $t0 , 0x180 /* CSR_DMWIN0(0x180): 0xa0000000-0xbfffffff->0x00000000-0x1fffffff Cached */ li.w $t0 , 0x80000001 /* CSR_DMWIN1(0x181): 0x80000000-0x9fffffff->0x00000000-0x1fffffff Uncached */ # Enable PG li.w $t0 , 0xb0 csrwr $t0 , 0x0 /* CSR_CRMD(0x0): PLV=0, IE=0, PG */ la $sp , bootstacktop la $t0 , main jr $t0 poweroff: b poweroff _stack: .section .data .global bootstack bootstack: .space 1024 .global bootstacktop bootstacktop: .space 64 \u6211\u4eec\u5c06\u8fd9\u4e2a\u6587\u4ef6\u4fdd\u5b58\u4e3a start.S \u3002 \u8fd9\u91cc\u7a0b\u5e8f\u4e3b\u8981\u5b8c\u6210\u4e86\u5bf9CSR\u7684DMWIN\u7684\u8bbe\u7f6e\uff0c\u5e76\u4fee\u6539CSR_CRMD\u5f00\u542f\u865a\u62df\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u7136\u540e\u4ece\u6808\u5730\u5740\u76f4\u63a5\u8fdb\u5165\u5230main\u51fd\u6570\u3002\u800cmain\u51fd\u6570\u6765\u6e90\u4e8e\u5916\u90e8\u7684extern\uff0c\u6211\u4eec\u63a5\u7740\u5199main\u5bf9\u5e94\u7684\u4ee3\u7801\u3002 \u7f16\u5199\u7b80\u5355\u4e32\u53e3\u8f93\u51faC\u7a0b\u5e8f \u00b6 \u4e32\u53e3\u662f\u4e00\u79cd\u901a\u4fe1\u65b9\u5f0f\u3002\u5728LoongArch32\u7684QEMU\u4e2d\uff0c\u6709\u4e00\u4e2ans16550a\u89c4\u683c\u7684\u4e32\u53e3\uff0c\u4f4d\u4e8e\u7269\u7406\u5730\u57400x1fe001e0\u3002 \u8be5\u4e32\u53e3\u901a\u8fc7MMIO\u7684\u65b9\u5f0f\u8bbf\u95ee\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u7f16\u5199ns16550a\u5bf9\u5e94\u7684\u9a71\u52a8\u4ee3\u7801\u5b8c\u6210\u4e32\u53e3\u7684\u6253\u5370\uff0c\u8fd9\u4e00\u90e8\u5206\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u4e0a\u7f51\u641c\u7d22\uff0c\u52a9\u6559\u5df2\u7ecf\u7ed9\u51fa\u4e00\u4e2a\u53ea\u6709\u8f93\u51fa\u529f\u80fd\u7684\u9a71\u52a8\u8303\u4f8b\uff0c\u5982\u4e0b\uff1a main.c 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #define UART_BASE 0x9fe001e0 #define UART_RX 0 /* In: Receive buffer */ #define UART_TX 0 /* Out: Transmit buffer */ #define UART_LSR 5 /* In: Line Status Register */ #define UART_LSR_TEMT 0x40 /* Transmitter empty */ #define UART_LSR_THRE 0x20 /* Transmit-hold-register empty */ #define UART_LSR_DR 0x01 /* Receiver data ready */ void uart_put_c ( char c ) { while ( ! ( * (( volatile char * ) UART_BASE + UART_LSR ) & ( UART_LSR_THRE ))); * (( volatile char * ) UART_BASE + UART_TX ) = c ; } void print_s ( const char * c ) { while ( * c ) { uart_put_c ( * c ); c ++ ; } } void main () { print_s ( \" \\n Here is my first bare-metal machine program on LoongArch32! \\n\\n \" ); } \u6211\u4eec\u5c06\u8fd9\u4e2a\u6587\u4ef6\u4fdd\u5b58\u4e3a main.c \u3002 \u7ec6\u5fc3\u7684\u540c\u5b66\u53ef\u80fd\u4f1a\u6ce8\u610f\u5230\uff0c\u6211\u4eec\u524d\u6587\u63d0\u5230\u4e32\u53e3\u5730\u5740\u662f\u57280x1fe001e0\uff0c\u4e3a\u4ec0\u4e48\u8fd9\u91cc\u4ee3\u7801\u5199\u6210\u4e860x9fe001e0\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u524d\u9762\u8bbe\u7f6e\u4e86DMW\uff0c\u5b8c\u6210\u4e860x80000000-0x9fffffff\u7684\u6620\u5c04\uff0c\u5e76\u8bbe\u7f6e\u7684Uncached\u5c5e\u6027\u3002 Warning \u5982\u679c\u4f7f\u7528Cached\u5730\u5740\u8bbf\u95ee\u4e32\u53e3\uff0c\u4f8b\u5982\u5bf9\u5e94\u7684DMWIN0\u4e0b\u76840xbfe001e0\uff0c\u5c3d\u7ba1\u5728QEMU\u4e2d\u4e0d\u4f1a\u6709\u4efb\u4f55\u9519\u8bef\uff0c\u4f46\u5728\u5b9e\u9645\u6709Cache\u7684CPU\u786c\u4ef6\u4e0a\u4f1a\u5bfc\u81f4\u4e32\u53e3\u8bbf\u95ee\u5931\u53bb\u539f\u5b50\u6027\uff0c\u5bfc\u81f4\u65e0\u6cd5\u5f97\u5230\u4e32\u53e3\u8f93\u51fa\u3002 \u7f16\u5199\u94fe\u63a5\u811a\u672c \u00b6 \u8fd9\u91cc\u6211\u4eec\u7684\u94fe\u63a5\u811a\u672c\u9700\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u6307\u5b9a\u4e00\u4e2a\u8d77\u59cb\u5730\u5740\uff0c\u5e76\u5220\u53bb\u7a0b\u5e8f\u4e2d\u4e0d\u9700\u8981\u7684\u5b58\u50a8\u533a\u6bb5\uff0c\u56e0\u6b64\u6700\u7ec8\u4ea7\u751f\u94fe\u63a5\u811a\u672c\u5982\u4e0b\uff1a lab0.ld 1 2 3 4 5 6 7 SECTIONS { . = 0xa0000000; .text : { *(.text) } .rodata : { *(.rodata) } .bss : { *(.bss) } } \u7136\u540e\u4fdd\u5b58\u4e3a lab0.ld \u3002 \u5176\u4e2d\uff0c\u6211\u4eec\u628a\u5f00\u59cb\u5730\u5740\u653e\u57280xa0000000\u662f\u57fa\u4e8e\u6211\u4eec\u914d\u7f6e\u7684DMWIN0\u8003\u8651\u7684\uff0c\u5bf9\u4e8e\u4ee3\u7801\u548c\u6570\u636e\u8fd9\u7c7b\u8bbf\u95ee\uff0c\u6211\u4eec\u5f53\u7136\u5e0c\u671b\u653e\u5728\u5e26\u6709Cache\u5c5e\u6027\u7684\u5730\u5740\u6bb5\uff0c\u8fd9\u6837\u8fd0\u884c\u8d77\u6765\u901f\u5ea6\u5feb\u4e00\u4e9b\u3002 \u7f16\u5199Makefile \u00b6 Makefile 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 TOOL := loongarch32r-linux-gnusf- CC := $( TOOL ) gcc OBJCOPY := $( TOOL ) objcopy OBJDUMP := $( TOOL ) objdump QEMU := qemu-system-loongarch32 .PHONY : clean qemu start.elf : start . S main . c lab 0. ld $( CC ) -nostdlib -T lab0.ld start.S main.c -O3 -o $@ qemu : start . elf $( QEMU ) -M ls3a5k32 -m 32M -kernel start.elf -nographic clean : rm start.elf Warning Makefile\u4e2d\u547d\u4ee4\u6240\u5728\u7684\u884c\u5fc5\u987b\u4ee5\u5236\u8868\u7b26\uff08\"\\t\"\uff09\u5f00\u5934\uff0c\u5982\u679c\u76f4\u63a5\u590d\u5236\u4e3a\u7a7a\u683c\u9700\u8981\u624b\u52a8\u66ff\u6362\u4e3a\u5236\u8868\u7b26\uff0c\u5426\u5219Make\u65f6\u4f1a\u51fa\u73b0\"missing separator.\"\u9519\u8bef\u3002 \u7136\u540e\u4fdd\u5b58\u4e3a Makefile \u3002 \u5173\u4e8eMakefile\u7684\u5185\u5bb9\u5927\u5bb6\u53ef\u4ee5\u4e0a\u7f51\u5bfb\u627e\u76f8\u5173\u8d44\u6599\u3002\u8fd9\u91cc\u7f16\u8bd1\u65f6\u6dfb\u52a0\u53c2\u6570 -nostdlib \u662f\u4e3a\u4e86\u9632\u6b62stdlib\u7f16\u8bd1\u5230\u6211\u4eec\u7684\u7a0b\u5e8f\u4e2d\uff0c\u6bd5\u7adf\u8fd9\u662f\u4e00\u4e2a\u88f8\u673a\u7a0b\u5e8f\u3002 \u7f16\u8bd1\u8fd0\u884c \u00b6 \u5728\u653e\u7f6e\u4e86 start.S \u3001 main.c \u3001 lab0.ld \u3001 Makefile \u7684\u6587\u4ef6\u5939\u4e0b\u6267\u884c make qemu \uff1a \u279c make qemu qemu-system-loongarch32 -M ls3a5k32 -m 32M -kernel start.elf -nographic loongson32_init: num_nodes 1 loongson32_init: node 0 mem 0x2000000 Here is my first bare-metal machine program on LoongArch32! \u770b\u5230\"Here is my first bare-metal machine program on LoongArch32!\"\u8868\u793a\u6211\u4eec\u7684\u88f8\u673a\u7a0b\u5e8f\u8fd0\u884c\u6210\u529f\uff01 \u9000\u51faQEMU \u00b6 \u5728nographic\u6a21\u5f0f\u4e0b\uff0c\u53ef\u4ee5\u6309 Ctrl + A \u4e00\u6b21\uff0c\u7136\u540e\u6309 X \u9000\u51fa\u3002 Note \u5c0f\u601d\u8003\uff1a \u4e3a\u4ec0\u4e48\u5728start.S\u7684\u6700\u540e\u5199\u4e86\u4e2a\u6b7b\u5faa\u73af\uff0c\u5982\u679c\u4e0d\u5199\u4f1a\u6709\u4ec0\u4e48\u574f\u5904\uff1f \u5728QEMU\u6a21\u62df\u5668\u4e2d\u8fd0\u884c\u88f8\u673a\u7a0b\u5e8f\u6709\u4ec0\u4e48\u529e\u6cd5\u907f\u514dCPU\u6ee1\u8f7d\uff1f\uff08\u53ef\u4ee5\u9605\u8bfb\u5b9e\u9a8c\u4e00\u7684\u4ee3\u7801\u627e\u5230\u7b54\u6848\u3002\uff09","title":"\u7f16\u5199\u88f8\u673a\u7a0b\u5e8f"},{"location":"lab0/bare-prog/#_1","text":"\u6211\u4eec\u4ee5\u5f80\u5199\u7528\u6237\u7a0b\u5e8f\u65f6\uff0c\u901a\u5e38\u90fd\u53ea\u5173\u6ce8\u4ee3\u7801\u672c\u8eab\uff0c\u800c\u5c06\u8fd0\u884c\u65f6\u7684\u73af\u5883\u4ea4\u7ed9\u4e86\u7f16\u8bd1\u5668\u7b49\u7cfb\u7edf\u8f6f\u4ef6\u8fdb\u884c\u5904\u7406\uff0c\u4f46\u6211\u4eec\u82e5\u8981\u7f16\u5199\u88f8\u673a\u7a0b\u5e8f\uff0c\u5c31\u9700\u8981\u8fdb\u4e00\u6b65\u63ed\u5f00\u8fd0\u884c\u65f6\u73af\u5883\u7684\u795e\u79d8\u9762\u7eb1\u3002 \u5f3a\u70c8\u5efa\u8bae\u540c\u5b66\u4eec\u9605\u8bfb\u300a\u7a0b\u5e8f\u5458\u7684\u81ea\u6211\u4fee\u517b\uff1a\u94fe\u63a5\u3001\u88c5\u8f7d\u4e0e\u5e93\u300b\uff0c\u4f1a\u5bf9\u8fd9\u4e9b\u95ee\u9898\u6709\u66f4\u52a0\u6e05\u6670\u7684\u8ba4\u8bc6\uff0c\u5728\u91cd\u5e86\u5927\u5b66A\u533a\u4e0e\u864e\u6eaa\u7684\u56fe\u4e66\u9986\u5747\u6709\u9986\u85cf\u3002 \u4e0b\u8868\u63ed\u793a\u4e86\u88f8\u673a\u7a0b\u5e8f\u4e0e\u7528\u6237\u7a0b\u5e8f\u7684\u533a\u522b\uff1a \u5bf9\u6bd4\u5bf9\u8c61 \u88f8\u673a\u7a0b\u5e8f \u5e38\u89c4\u7528\u6237\u7a0b\u5e8f \u5185\u5b58\u5730\u5740\u7a7a\u95f4 \u81ea\u884c\u7ba1\u7406\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u53ef\u4ee5\u81ea\u884c\u5bf9\u865a\u62df\u5185\u5b58\u8fdb\u884c\u914d\u7f6e\u540e\u4f7f\u81ea\u5df1\u8fd0\u884c\u5728\u865a\u62df\u5730\u5740\u7a7a\u95f4 \u7531\u64cd\u4f5c\u7cfb\u7edf\u7ba1\u7406\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff08\u4e0d\u8003\u8651Linux NOMMU\u6a21\u5f0f\uff09 \u7cfb\u7edf\u8c03\u7528 \u8c03\u7528\u81ea\u5df1 \u8c03\u7528\u66f4\u9ad8\u7279\u6743\u7ea7\u7684\u64cd\u4f5c\u7cfb\u7edf/\u56fa\u4ef6 \u6808\u7684\u521d\u59cb\u5316 \u81ea\u884c\u5b8c\u6210 \u64cd\u4f5c\u7cfb\u7edf\u8f7d\u5165\u7528\u6237\u8fdb\u7a0b\u65f6\u5b8c\u6210\uff08\u6bd5\u7adf\u8fd8\u8981\u901a\u8fc7\u6808\u4f20\u9012\u53c2\u6570\uff09 BSS\u6bb5\u7684\u6e05\u7a7a \u81ea\u884c\u5b8c\u6210 \u64cd\u4f5c\u7cfb\u7edf\u5206\u914d\u865a\u62df\u9875\u9762\u65f6\u5b8c\u6210\u6e05\u96f6 \u8bb8\u591a\u540c\u5b66\u53ef\u80fd\u5bf9\u4e8e\u4e0a\u8868\u5df2\u7ecf\u770b\u61f5\u4e86\uff0c\u4e0d\u660e\u767d\u8fd9\u4e9b\u540d\u8bcd\u7684\u5177\u4f53\u542b\u4e49\uff0c\u6ca1\u5173\u7cfb\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u4e00\u4e00\u89e3\u91ca\uff1a","title":"\u521d\u8bc6\u88f8\u673a\u7a0b\u5e8f"},{"location":"lab0/bare-prog/#_2","text":"\u6211\u4eec\u77e5\u9053\u7f16\u5199\u7684\u7a0b\u5e8f\u53ef\u4ee5\u8fdb\u884c\u51fd\u6570\u8c03\u7528\uff0c\u4e5f\u53ef\u4ee5\u5728\u8c03\u7528\u540e\u8fd4\u56de\u3002\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u601d\u8003\uff0c\u8bb0\u5f55\u51fd\u6570\u6267\u884c\u4f4d\u7f6e\uff0c\u5305\u62ec\u5c40\u90e8\u53d8\u91cf\u7684\u72b6\u6001\u7b49\u53ef\u4ee5\u91c7\u7528\u4e00\u79cd\u5148\u8fdb\u540e\u51fa\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4e5f\u5c31\u662f\u6808\u3002\u8fd9\u4e2a\u8c03\u7528\u6808\u7684\u6570\u636e\u7ed3\u6784\u5728\u4e0d\u540c\u7684\u6307\u4ee4\u96c6\u67b6\u6784\u7684ABI\uff08Application Binary Interface\uff09\u4e2d\u5b9a\u4e49\u4e0d\u540c\u3002\u4e14\u5b83\u7684\u751f\u957f\u65b9\u5f0f\u662f\u5411\u4e0b\u751f\u957f\u3002 \u4f46\u6211\u4eec\u9700\u8981\u5148\u5206\u914d\u51fa\u4e00\u4e2a\u6808\uff0c\u624d\u80fd\u8fd0\u884c\u8fd9\u79cd\u80fd\u8fdb\u884c\u51fd\u6570\u8c03\u7528\u7684C\u8bed\u8a00\u7a0b\u5e8f\u3002\u56e0\u6b64\u5bf9\u4e8e\u88f8\u673a\u7a0b\u5e8f\u800c\u8a00\uff0c\u6211\u4eec\u9700\u8981\u5728\u6c47\u7f16\u7a0b\u5e8f\u91cc\u5148\u521d\u59cb\u5316GPR\uff08\u901a\u7528\u5bc4\u5b58\u5668\uff09\u7684sp\u6307\u9488\uff0c\u624d\u80fd\u8fdb\u5165C\u7a0b\u5e8f\u3002","title":"\u8c03\u7528\u6808"},{"location":"lab0/bare-prog/#_3","text":"\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u8fd0\u884c\u4ee5\u4e0b\u5b9e\u9a8c\uff0c\u7f16\u5199\u5982\u4e0bC\u8bed\u8a00\u7a0b\u5e8f\uff1a hello.c 1 2 3 4 5 #include <stdio.h> int main () { printf ( \"Hello World \\n \" ); return 0 ; } \u7136\u540e\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u7f16\u8bd1\u4e3a\u76ee\u6807\u6587\u4ef6\u5e76\u67e5\u770b\u76ee\u6807\u6587\u4ef6\u7684\u5934\uff1a \u279c gcc hello.c -c -o hello.o \u279c objdump -h hello.o hello.o: file format elf64-x86-64 Sections: Idx Name Size VMA LMA File off Algn 0 .text 0000001a 0000000000000000 0000000000000000 00000040 2 **0 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE 1 .data 00000000 0000000000000000 0000000000000000 0000005a 2 **0 CONTENTS, ALLOC, LOAD, DATA 2 .bss 00000000 0000000000000000 0000000000000000 0000005a 2 **0 ALLOC 3 .rodata 0000000c 0000000000000000 0000000000000000 0000005a 2 **0 CONTENTS, ALLOC, LOAD, READONLY, DATA 4 .comment 0000001f 0000000000000000 0000000000000000 00000066 2 **0 CONTENTS, READONLY 5 .note.GNU-stack 00000000 0000000000000000 0000000000000000 00000085 2 **0 CONTENTS, READONLY 6 .eh_frame 00000038 0000000000000000 0000000000000000 00000088 2 **3 CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA \u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u7684\u7a0b\u5e8f\u5206\u4e3a\u4e86 .text \u3001 .data \u3001 .bss \u3001 .rodata \u5404\u5b58\u50a8\u6bb5\u3002 \u5176\u4e2d\uff1a .text \u662f\u4ee3\u7801\u6bb5\uff0c\u653e\u7f6e\u7684\u662f\u6211\u4eec\u7684\u7a0b\u5e8f\u7f16\u8bd1\u540e\u7684\u4ee3\u7801\u3002 .data \u662f\u6570\u636e\u6bb5\uff0c\u8fd9\u91cc\u653e\u7684\u662f\u521d\u59cb\u5316\u8fc7\u7684\u9759\u6001\u53d8\u91cf\uff08\u5305\u542b\u5168\u5c40\u53d8\u91cf\u8fd8\u6709 static \u4fee\u9970\u540e\u7684\u5c40\u90e8\u53d8\u91cf\uff09\u3002 .bss \u662f\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u9759\u6001\u53d8\u91cf\u7684\u533a\u57df\u3002\u800c\u5728ELF\u6587\u4ef6\u4e2d\uff0c\u5b83\u5e76\u4e0d\u5b9e\u9645\u5b58\u50a8\u6570\u636e\uff0c\u4ec5\u7528\u4e8e\u544a\u77e5\u64cd\u4f5c\u7cfb\u7edf\u8f7d\u5165\u8fdb\u7a0b\u65f6\u8be5\u6bb5\u5408\u6cd5\u5730\u5740\u7684\u5b58\u5728\u3002 .rodata \u5b58\u653e\u7684\u662f\u53ea\u8bfb\u6570\u636e\uff0c\u4f8b\u5982\u5b57\u7b26\u4e32\u5e38\u91cf\u4e0e\u5168\u5c40const\u53d8\u91cf\u5c31\u5b58\u653e\u5728\u8fd9\u4e2a\u4f4d\u7f6e\u3002 \u8fd9\u4e9b\u6bb5\u7684\u5143\u6570\u636e\u653e\u5728\u6211\u4eec\u7f16\u8bd1\u7684\u4ea7\u7269\uff08ELF\u6587\u4ef6\uff09\u7684\u5934\u90e8\u5206\u3002","title":"\u7a0b\u5e8f\u91cc\u7684\u5404\u4e2a\u5b58\u50a8\u533a"},{"location":"lab0/bare-prog/#_4","text":"\u6211\u4eec\u5728\u5927\u4e00\u7684\u201c\u7a0b\u5e8f\u8bbe\u8ba1\u57fa\u7840\u201d\u8bfe\u7a0b\u5e94\u8be5\u5df2\u7ecf\u5b66\u8fc7\u591a\u6587\u4ef6\u7684C\u8bed\u8a00\u7a0b\u5e8f\u7f16\u5199\u4ee5\u53ca\u94fe\u63a5\u8fc7\u7a0b\uff0c\u540c\u5b66\u4eec\u5e94\u8be5\u4e5f\u5728\u5176\u4e2d\u5b66\u4e60\u4e86Makefile\u7684\u57fa\u672c\u4f7f\u7528\u3002 \u8bb8\u591a\u540c\u5b66\u4e5f\u8bb8\u4f1a\u597d\u5947\uff0c\u94fe\u63a5\u5668\u662f\u5982\u4f55\u5c06\u8fd9\u4e9b\u672a\u5b9a\u4e49\u7684\u51fd\u6570\u627e\u5230\u5bf9\u5e94\u7684\u4f4d\u7f6e\u5e76\u8fdb\u884c\u94fe\u63a5\u7684\u5462\uff1f \u8fd9\u91cc\u6211\u4eec\u5c31\u5f97\u6d89\u53ca\u5230\u4e00\u4e2a\u7b26\u53f7\u8868\u7684\u6982\u5ff5\uff0c\u5728\u6211\u4eec\u7f16\u8bd1\u4ea7\u751f\u7684ELF\u6587\u4ef6\u4e2d\uff0c\u8fd8\u6709\u4e00\u4e2a\u5b58\u653e\u7b26\u53f7\u8868\u7684\u533a\u57df\uff0c\u5176\u4e2d\u7b26\u53f7\u6307\u7684\u662f\u51fd\u6570\u3001\u53d8\u91cf\u7b49\u7684\u540d\u5b57\uff0c\u5e76\u8bb0\u5f55\u4ed6\u4eec\u5bf9\u5e94\u7684\u5730\u5740\u3002\u8fd9\u6837\u5728\u94fe\u63a5\u65f6\u5c31\u77e5\u9053\u80fd\u591f\u77e5\u9053\u5bf9\u5e94\u7684\u4f4d\u7f6e\uff0c\u4ece\u800c\u8fdb\u884c\u94fe\u63a5\uff0c\u751f\u6210\u51fa\u4e00\u4e2a\u66f4\u5927\u7684\u53ef\u6267\u884c\u7a0b\u5e8f\u3002 \u800c\u5bf9\u4e8e\u88f8\u673a\u7a0b\u5e8f\uff0c\u6211\u4eec\u8fd8\u6709\u4e00\u4e2a\u9700\u6c42\u662f\u8bbe\u5b9a\u7a0b\u5e8f\u5404\u5b58\u50a8\u6bb5\u7684\u6392\u5e03\u4ee5\u53ca\u5730\u5740\u504f\u79fb\u91cf\u3002\u5730\u5740\u504f\u79fb\u91cf\u53ef\u4ee5\u544a\u77e5\u7f16\u8bd1\u5668\u8fdb\u884c\u76f4\u63a5\u8df3\u8f6c\u65f6\u6240\u9700\u8981\u7684\u5730\u5740\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u5f15\u5165\u4e00\u4e2a\u53eb\u505ald\u811a\u672c\u7684\u4e1c\u897f\uff0c\u5b83\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u89c4\u5212\u9700\u8981\u653e\u5165\u6700\u7ec8\u7f16\u8bd1\u7ed3\u679c\u7684\u5404\u6bb5\u7684\u5730\u5740\u3002 Note \u5c0f\u601d\u8003\uff1a \u64cd\u4f5c\u7cfb\u7edf\u7ed9\u7528\u6237\u8fdb\u7a0b\u5206\u914d\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u65f6\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981\u5c06\u5bf9\u5e94\u9875\u9762\u6e05\u96f6\u540e\u518d\u5206\u914d\uff1f\u5982\u679c\u4e0d\u6e05\u96f6\u4f1a\u5bfc\u81f4\u4ec0\u4e48\u95ee\u9898\uff1f\uff08\u53ef\u4ee5\u4ece\u5b89\u5168\u7b49\u89d2\u5ea6\u8003\u8651\uff09 \u6211\u4eec\u5199C\u8bed\u8a00\u7a0b\u5e8f\u65f6\u5f00\u7684\u5c40\u90e8\u53d8\u91cf\u4e0d\u8d4b\u521d\u59cb\u503c\u4e3a\u4ec0\u4e48\u7ecf\u5e38\u4f1a\u5f97\u5230\u4e00\u4e2a\u968f\u673a\u6570\uff1f\u662f\u5426\u4e0e\u524d\u9762\u63d0\u5230\u64cd\u4f5c\u7cfb\u7edf\u7ed9\u7528\u6237\u8fdb\u7a0b\u5206\u914d\u865a\u62df\u9875\u9762\u65f6\u4f1a\u8fdb\u884c\u6e05\u96f6\u7684\u7ed3\u8bba\u76f8\u6096\uff1f Linux NOMMU\u4e3a\u4ec0\u4e48\u53ea\u5728\u90e8\u5206\u6307\u4ee4\u96c6\u67b6\u6784\u5b58\u5728\uff1f\u90e8\u5206\u5b58\u5728NOMMU\u7684\u6307\u4ee4\u96c6\uff08\u5982RISC-V\uff09\u63d0\u4f9b\u4e86\u4ec0\u4e48\u9694\u79bb\u673a\u5236\u786e\u4fdd\u4e00\u4e2a\u8fdb\u7a0b\u65e0\u6cd5\u4fee\u6539\u5176\u4ed6\u8fdb\u7a0b\u7684\u6570\u636e\uff1f \u4e3a\u4ec0\u4e48\u6211\u4eec\u5728\u88f8\u673a\u7a0b\u5e8f\u4e2d\u53ef\u4ee5\u6682\u65f6\u4e0d\u8003\u8651malloc\uff08new\uff09\u8fd9\u79cd\u5806\u5185\u5b58\u5206\u914d\uff1f \u6808\u80fd\u4e0d\u80fd\u6539\u6210\u5411\u4e0a\u751f\u957f\uff1f\u6709\u4ec0\u4e48\u5229\u5f0a\uff1f \u7ed3\u5408\u7a0b\u5e8f\u7684\u5404\u6bb5\u6240\u9700\u7684\u6700\u5c0f\u6743\u9650\u4e0d\u540c\uff0c\u5904\u7406\u5668\u7684MMU\u53ef\u4ee5\u63d0\u4f9b\u54ea\u4e9b\u6743\u9650\u63a7\u5236\u4f4d\u786e\u4fdd\u7a0b\u5e8f\u56e0\u4e3a\u6f0f\u6d1e\u5bfc\u81f4\u4efb\u610f\u5185\u5b58\u8bfb\u5199\u65f6\uff0c\u653b\u51fb\u8005\u80fd\u7834\u574f\u7684\u6570\u636e\u8303\u56f4\u6700\u4f4e\uff1f\u4f8b\u5982\u5982\u4f55\u624d\u80fd\u8ba9.text\u6bb5\u548c.rodata\u6bb5\u4e0d\u88ab\u4fee\u6539\uff0c\u5176\u4ed6\u6bb5\u7684\u6570\u636e\u4e0d\u53ef\u88ab\u6267\u884c\uff1f\u5982\u679c\u653b\u51fb\u8005\u6709\u80fd\u529b\u7834\u574f\u9875\u8868\uff0c\u8fd8\u6709\u4ec0\u4e48\u5b89\u5168\u673a\u5236\u53ef\u4ee5\u52a0\u5165\u5904\u7406\u5668\u4e2d\u8fdb\u884c\u66f4\u597d\u7684\u4fdd\u62a4\uff1f","title":"\u94fe\u63a5"},{"location":"lab0/bare-prog/#_5","text":"\u81f3\u6b64\uff0c\u6211\u4eec\u5f00\u59cb\u771f\u6b63\u7f16\u5199\u4e00\u4e2a\u88f8\u673a\u7a0b\u5e8f\uff0c\u5927\u5bb6\u5728\u642d\u5efa\u597d\u7684\u73af\u5883\u4e2d\u65b0\u5efa\u6587\u4ef6\u5939\uff0c\u4e00\u6b65\u6b65\u5f00\u59cb\u5427\uff01","title":"\u7f16\u5199\u4e00\u4e2a\u88f8\u673a\u7a0b\u5e8f"},{"location":"lab0/bare-prog/#_6","text":"start.S 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 .extern main .text .globl _start _start: # Config direct window and set PG li.w $t0 , 0xa0000011 csrwr $t0 , 0x180 /* CSR_DMWIN0(0x180): 0xa0000000-0xbfffffff->0x00000000-0x1fffffff Cached */ li.w $t0 , 0x80000001 /* CSR_DMWIN1(0x181): 0x80000000-0x9fffffff->0x00000000-0x1fffffff Uncached */ # Enable PG li.w $t0 , 0xb0 csrwr $t0 , 0x0 /* CSR_CRMD(0x0): PLV=0, IE=0, PG */ la $sp , bootstacktop la $t0 , main jr $t0 poweroff: b poweroff _stack: .section .data .global bootstack bootstack: .space 1024 .global bootstacktop bootstacktop: .space 64 \u6211\u4eec\u5c06\u8fd9\u4e2a\u6587\u4ef6\u4fdd\u5b58\u4e3a start.S \u3002 \u8fd9\u91cc\u7a0b\u5e8f\u4e3b\u8981\u5b8c\u6210\u4e86\u5bf9CSR\u7684DMWIN\u7684\u8bbe\u7f6e\uff0c\u5e76\u4fee\u6539CSR_CRMD\u5f00\u542f\u865a\u62df\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u7136\u540e\u4ece\u6808\u5730\u5740\u76f4\u63a5\u8fdb\u5165\u5230main\u51fd\u6570\u3002\u800cmain\u51fd\u6570\u6765\u6e90\u4e8e\u5916\u90e8\u7684extern\uff0c\u6211\u4eec\u63a5\u7740\u5199main\u5bf9\u5e94\u7684\u4ee3\u7801\u3002","title":"\u521d\u59cb\u5316\u7684\u6c47\u7f16\u4ee3\u7801"},{"location":"lab0/bare-prog/#c","text":"\u4e32\u53e3\u662f\u4e00\u79cd\u901a\u4fe1\u65b9\u5f0f\u3002\u5728LoongArch32\u7684QEMU\u4e2d\uff0c\u6709\u4e00\u4e2ans16550a\u89c4\u683c\u7684\u4e32\u53e3\uff0c\u4f4d\u4e8e\u7269\u7406\u5730\u57400x1fe001e0\u3002 \u8be5\u4e32\u53e3\u901a\u8fc7MMIO\u7684\u65b9\u5f0f\u8bbf\u95ee\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u7f16\u5199ns16550a\u5bf9\u5e94\u7684\u9a71\u52a8\u4ee3\u7801\u5b8c\u6210\u4e32\u53e3\u7684\u6253\u5370\uff0c\u8fd9\u4e00\u90e8\u5206\u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u4e0a\u7f51\u641c\u7d22\uff0c\u52a9\u6559\u5df2\u7ecf\u7ed9\u51fa\u4e00\u4e2a\u53ea\u6709\u8f93\u51fa\u529f\u80fd\u7684\u9a71\u52a8\u8303\u4f8b\uff0c\u5982\u4e0b\uff1a main.c 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #define UART_BASE 0x9fe001e0 #define UART_RX 0 /* In: Receive buffer */ #define UART_TX 0 /* Out: Transmit buffer */ #define UART_LSR 5 /* In: Line Status Register */ #define UART_LSR_TEMT 0x40 /* Transmitter empty */ #define UART_LSR_THRE 0x20 /* Transmit-hold-register empty */ #define UART_LSR_DR 0x01 /* Receiver data ready */ void uart_put_c ( char c ) { while ( ! ( * (( volatile char * ) UART_BASE + UART_LSR ) & ( UART_LSR_THRE ))); * (( volatile char * ) UART_BASE + UART_TX ) = c ; } void print_s ( const char * c ) { while ( * c ) { uart_put_c ( * c ); c ++ ; } } void main () { print_s ( \" \\n Here is my first bare-metal machine program on LoongArch32! \\n\\n \" ); } \u6211\u4eec\u5c06\u8fd9\u4e2a\u6587\u4ef6\u4fdd\u5b58\u4e3a main.c \u3002 \u7ec6\u5fc3\u7684\u540c\u5b66\u53ef\u80fd\u4f1a\u6ce8\u610f\u5230\uff0c\u6211\u4eec\u524d\u6587\u63d0\u5230\u4e32\u53e3\u5730\u5740\u662f\u57280x1fe001e0\uff0c\u4e3a\u4ec0\u4e48\u8fd9\u91cc\u4ee3\u7801\u5199\u6210\u4e860x9fe001e0\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u524d\u9762\u8bbe\u7f6e\u4e86DMW\uff0c\u5b8c\u6210\u4e860x80000000-0x9fffffff\u7684\u6620\u5c04\uff0c\u5e76\u8bbe\u7f6e\u7684Uncached\u5c5e\u6027\u3002 Warning \u5982\u679c\u4f7f\u7528Cached\u5730\u5740\u8bbf\u95ee\u4e32\u53e3\uff0c\u4f8b\u5982\u5bf9\u5e94\u7684DMWIN0\u4e0b\u76840xbfe001e0\uff0c\u5c3d\u7ba1\u5728QEMU\u4e2d\u4e0d\u4f1a\u6709\u4efb\u4f55\u9519\u8bef\uff0c\u4f46\u5728\u5b9e\u9645\u6709Cache\u7684CPU\u786c\u4ef6\u4e0a\u4f1a\u5bfc\u81f4\u4e32\u53e3\u8bbf\u95ee\u5931\u53bb\u539f\u5b50\u6027\uff0c\u5bfc\u81f4\u65e0\u6cd5\u5f97\u5230\u4e32\u53e3\u8f93\u51fa\u3002","title":"\u7f16\u5199\u7b80\u5355\u4e32\u53e3\u8f93\u51faC\u7a0b\u5e8f"},{"location":"lab0/bare-prog/#_7","text":"\u8fd9\u91cc\u6211\u4eec\u7684\u94fe\u63a5\u811a\u672c\u9700\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u6307\u5b9a\u4e00\u4e2a\u8d77\u59cb\u5730\u5740\uff0c\u5e76\u5220\u53bb\u7a0b\u5e8f\u4e2d\u4e0d\u9700\u8981\u7684\u5b58\u50a8\u533a\u6bb5\uff0c\u56e0\u6b64\u6700\u7ec8\u4ea7\u751f\u94fe\u63a5\u811a\u672c\u5982\u4e0b\uff1a lab0.ld 1 2 3 4 5 6 7 SECTIONS { . = 0xa0000000; .text : { *(.text) } .rodata : { *(.rodata) } .bss : { *(.bss) } } \u7136\u540e\u4fdd\u5b58\u4e3a lab0.ld \u3002 \u5176\u4e2d\uff0c\u6211\u4eec\u628a\u5f00\u59cb\u5730\u5740\u653e\u57280xa0000000\u662f\u57fa\u4e8e\u6211\u4eec\u914d\u7f6e\u7684DMWIN0\u8003\u8651\u7684\uff0c\u5bf9\u4e8e\u4ee3\u7801\u548c\u6570\u636e\u8fd9\u7c7b\u8bbf\u95ee\uff0c\u6211\u4eec\u5f53\u7136\u5e0c\u671b\u653e\u5728\u5e26\u6709Cache\u5c5e\u6027\u7684\u5730\u5740\u6bb5\uff0c\u8fd9\u6837\u8fd0\u884c\u8d77\u6765\u901f\u5ea6\u5feb\u4e00\u4e9b\u3002","title":"\u7f16\u5199\u94fe\u63a5\u811a\u672c"},{"location":"lab0/bare-prog/#makefile","text":"Makefile 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 TOOL := loongarch32r-linux-gnusf- CC := $( TOOL ) gcc OBJCOPY := $( TOOL ) objcopy OBJDUMP := $( TOOL ) objdump QEMU := qemu-system-loongarch32 .PHONY : clean qemu start.elf : start . S main . c lab 0. ld $( CC ) -nostdlib -T lab0.ld start.S main.c -O3 -o $@ qemu : start . elf $( QEMU ) -M ls3a5k32 -m 32M -kernel start.elf -nographic clean : rm start.elf Warning Makefile\u4e2d\u547d\u4ee4\u6240\u5728\u7684\u884c\u5fc5\u987b\u4ee5\u5236\u8868\u7b26\uff08\"\\t\"\uff09\u5f00\u5934\uff0c\u5982\u679c\u76f4\u63a5\u590d\u5236\u4e3a\u7a7a\u683c\u9700\u8981\u624b\u52a8\u66ff\u6362\u4e3a\u5236\u8868\u7b26\uff0c\u5426\u5219Make\u65f6\u4f1a\u51fa\u73b0\"missing separator.\"\u9519\u8bef\u3002 \u7136\u540e\u4fdd\u5b58\u4e3a Makefile \u3002 \u5173\u4e8eMakefile\u7684\u5185\u5bb9\u5927\u5bb6\u53ef\u4ee5\u4e0a\u7f51\u5bfb\u627e\u76f8\u5173\u8d44\u6599\u3002\u8fd9\u91cc\u7f16\u8bd1\u65f6\u6dfb\u52a0\u53c2\u6570 -nostdlib \u662f\u4e3a\u4e86\u9632\u6b62stdlib\u7f16\u8bd1\u5230\u6211\u4eec\u7684\u7a0b\u5e8f\u4e2d\uff0c\u6bd5\u7adf\u8fd9\u662f\u4e00\u4e2a\u88f8\u673a\u7a0b\u5e8f\u3002","title":"\u7f16\u5199Makefile"},{"location":"lab0/bare-prog/#_8","text":"\u5728\u653e\u7f6e\u4e86 start.S \u3001 main.c \u3001 lab0.ld \u3001 Makefile \u7684\u6587\u4ef6\u5939\u4e0b\u6267\u884c make qemu \uff1a \u279c make qemu qemu-system-loongarch32 -M ls3a5k32 -m 32M -kernel start.elf -nographic loongson32_init: num_nodes 1 loongson32_init: node 0 mem 0x2000000 Here is my first bare-metal machine program on LoongArch32! \u770b\u5230\"Here is my first bare-metal machine program on LoongArch32!\"\u8868\u793a\u6211\u4eec\u7684\u88f8\u673a\u7a0b\u5e8f\u8fd0\u884c\u6210\u529f\uff01","title":"\u7f16\u8bd1\u8fd0\u884c"},{"location":"lab0/bare-prog/#qemu","text":"\u5728nographic\u6a21\u5f0f\u4e0b\uff0c\u53ef\u4ee5\u6309 Ctrl + A \u4e00\u6b21\uff0c\u7136\u540e\u6309 X \u9000\u51fa\u3002 Note \u5c0f\u601d\u8003\uff1a \u4e3a\u4ec0\u4e48\u5728start.S\u7684\u6700\u540e\u5199\u4e86\u4e2a\u6b7b\u5faa\u73af\uff0c\u5982\u679c\u4e0d\u5199\u4f1a\u6709\u4ec0\u4e48\u574f\u5904\uff1f \u5728QEMU\u6a21\u62df\u5668\u4e2d\u8fd0\u884c\u88f8\u673a\u7a0b\u5e8f\u6709\u4ec0\u4e48\u529e\u6cd5\u907f\u514dCPU\u6ee1\u8f7d\uff1f\uff08\u53ef\u4ee5\u9605\u8bfb\u5b9e\u9a8c\u4e00\u7684\u4ee3\u7801\u627e\u5230\u7b54\u6848\u3002\uff09","title":"\u9000\u51faQEMU"},{"location":"lab0/intro/","text":"\u5f00\u7bc7 \u00b6 \u76f8\u4fe1\u5927\u5bb6\u901a\u8fc7\u201c\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406\u201d\u8fd9\u95e8\u8bfe\u7a0b\u5df2\u7ecf\u5bf9\u8ba1\u7b97\u673a\u5982\u4f55\u8ba1\u7b97\u4ee5\u53ca\u6267\u884c\u6307\u4ee4\u6709\u4e86\u4e00\u5b9a\u7684\u4e86\u89e3\u3002 \u4f46\u6211\u4eec\u8ba1\u7b97\u673a\u7684\u5904\u7406\u5668\u9664\u4e86\u7b80\u5355\u5730\u6267\u884c\u6307\u4ee4\u4e4b\u5916\uff0c\u5b83\u8fd8\u62e5\u6709\u7279\u6743\u7ea7\u7ba1\u7406\u3001\u5f02\u5e38\u4e0e\u4e2d\u65ad\u7b49\u529f\u80fd\uff0c\u8fd9\u4e9b\u786c\u4ef6\u529f\u80fd\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u8f6f\u4ef6\u5bc6\u5207\u76f8\u5173\u3002 \u76f8\u4fe1\u5927\u5bb6\u5728\u901a\u8fc7\u672c\u5b9e\u9a8c\u7684\u5b66\u4e60\u540e\uff0c\u80fd\u591f\u5bf9\u8ba1\u7b97\u673a\u7684\u542f\u52a8\u6d41\u7a0b\u4ee5\u53ca\u64cd\u4f5c\u7cfb\u7edf\u7684\u8fd0\u884c\u6d41\u7a0b\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u8ba4\u8bc6\uff0c\u89e3\u5f00\u5927\u5bb6\u5fc3\u4e2d\u8ba1\u7b97\u673a\u5e95\u5c42\u7684\u795e\u79d8\u9762\u7eb1\u3002 LoongArch32\u7b80\u4ecb \u00b6 LoongArch\u662f\u4e00\u79cd\u7cbe\u7b80\u6307\u4ee4\u96c6\u67b6\u6784\u3002\u5206\u4e3a32\u4f4d\u4e0e64\u4f4d\u4e24\u4e2a\u7248\u672c\u3002\u6211\u4eec\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u91c7\u7528\u7684\u662f32\u4f4d\u7248\u672c\u3002 \u901a\u7528\u5bc4\u5b58\u5668 \u00b6 LoongArch32\u670932\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u8bb0\u4e3ar0~r31\uff0c\u8fd9\u4e9b\u5bc4\u5b58\u5668\u5728 ABI \u4e2d\u5b9a\u4e49\u4e86\u5bf9\u5e94\u7684\u522b\u540d\uff0c\u5982\u4e0b\uff1a \u540d\u79f0 \u522b\u540d \u7528\u9014 \u5728\u8c03\u7528\u4e2d\u662f\u5426\u4fdd\u7559 $r0 $zero \u5e38\u6570 0 \uff08\u5e38\u6570\uff09 $r1 $ra \u8fd4\u56de\u5730\u5740 \u5426 $r2 $tp \u7ebf\u7a0b\u6307\u9488 \uff08\u4e0d\u53ef\u5206\u914d\uff09 $r3 $sp \u6808\u6307\u9488 \u662f $r4 - $r5 $a0 - $a1 \u4f20\u53c2\u5bc4\u5b58\u5668\u3001\u8fd4\u56de\u503c\u5bc4\u5b58\u5668 \u5426 $r6 - $r11 $a2 - $a7 \u4f20\u53c2\u5bc4\u5b58\u5668 \u5426 $r12 - $r20 $t0 - $t8 \u4e34\u65f6\u5bc4\u5b58\u5668 \u5426 $r21 \u4fdd\u7559 \uff08\u4e0d\u53ef\u5206\u914d\uff09 $r22 $fp / $s9 \u6808\u5e27\u6307\u9488 / \u9759\u6001\u5bc4\u5b58\u5668 \u662f $r23 - $r31 $s0 - $s8 \u9759\u6001\u5bc4\u5b58\u5668 \u662f \u6ce8\uff1aLoongArch32\u8001\u7248\u672cABI\u4e2d\u5b58\u5728\u4e0e v0 \u3001 v1 \u5bc4\u5b58\u5668\uff0c\u4e0e a0 \u3001 a1 \u540c\u4e3a $r4 \u4e0e $r5 \u5bc4\u5b58\u5668\u7684\u522b\u540d\uff0c\u5728\u65b0\u7248ABI\u4e2d\u5df2\u88ab\u820d\u5f03\u3002 \u57fa\u672c\u6574\u6570\u6307\u4ee4 \u00b6 \u8fd9\u4e00\u90e8\u5206\u8bf7\u540c\u5b66\u4eec\u81ea\u884c\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u3002 marco\u6307\u4ee4 \u00b6 marco\u6307\u4ee4\u662f\u6211\u4eec\u7f16\u5199\u6c47\u7f16\u65f6\u6d89\u53ca\u5230\u7684\u4e00\u79cd\u7279\u6b8a\u6307\u4ee4\uff0c\u5b83\u672c\u8eab\u4e0d\u5b9a\u4e49\u5728ISA\u4e2d\u3002\u8fd9\u4e9bmarco\u6307\u4ee4\u5b9a\u4e49\u51fa\u6765\u540e\u4f1a\u5728\u6c47\u7f16\u5668\u7ffb\u8bd1\u6210\u5176\u4ed6\u4e00\u6761\u6216\u591a\u6761\u771f\u5b9e\u5b58\u5728\u7684\u6307\u4ee4\uff0c\u800c\u5b83\u5b58\u5728\u7684\u610f\u4e49\u662f\u4e3a\u4e86\u8ba9\u6211\u4eec\u7f16\u5199\u6c47\u7f16\u4ee3\u7801\u65f6\u80fd\u591f\u66f4\u52a0\u65b9\u4fbf\u3002 \u5728\u6211\u4eec\u79fb\u690d\u7684uCore for LoongArch32\u4e2d\uff0c\u53ea\u7528\u5230\u4e86\u4e00\u79cdmarco\u6307\u4ee4\uff0c\u5c31\u662f li.w \u3002\u56e0\u4e3aLoongArch32\u4e0d\u652f\u630132\u4f4d\u7684\u7acb\u5373\u6570\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u591a\u6761\u6307\u4ee4\u62fc\u51d1\u51fa\u4e00\u4e2a32\u4f4d\u7684\u7acb\u5373\u6570\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7528 li.w \u76f4\u63a5\u5e2e\u6211\u4eec\u62fc\u63a5\uff0c\u6700\u7ec8\u751f\u6210\u51fa\u6765\u7684\u662f lu12i.w \u4e0e\u4e00\u6761 ori \u6307\u4ee4\u5171\u540c\u5b8c\u6210li.w\u7684\u64cd\u4f5c\u3002 \u7531\u4e8e\u52a9\u6559\u6682\u672a\u627e\u5230\u9f99\u82af\u76f8\u5173\u6587\u6863\u7684\u8bf4\u660e\uff0c\u53ef\u4ee5\u901a\u8fc7\u9605\u8bfb\u6c47\u7f16\u5668\u7684\u6307\u4ee4\u5b9a\u4e49\u4ee3\u7801\u624b\u52a8\u9006\u5411marco\u6307\u4ee4\uff1a https://gitee.com/loongson-edu/la32r_binutils/blob/master/opcodes/loongarch-opc.c \u5982\u679c\u6709\u5174\u8da3\u7684\u540c\u5b66\u60f3\u77e5\u9053\u8fd9\u4e9bopcodes\u5982\u4f55\u5b9a\u4e49\uff0c\u53ef\u4ee5 \u53c2\u8003\u52a9\u6559\u7684\u535a\u5ba2 \uff0c\u66fe\u7ecf\u505a\u8fc7RISC-V\u4e0a\u6dfb\u52a0\u6307\u4ee4\u7684\u5de5\u4f5c\u3002 LoongArch32\u62ff\u6765\u505a\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u6709\u4ec0\u4e48\u597d\u5904\uff1f \u00b6 \u5feb\u901f\u4e0a\u624b\u5bb9\u6613\uff0c\u4e0eMIPS\u975e\u5e38\u76f8\u4f3c\uff0c\u7b80\u5355\u6613\u61c2\u3002\u4e14\u5177\u6709\u4e2d\u6587\u6587\u6863\u3002 \u76f8\u6bd4x86\uff0c\u5386\u53f2\u5305\u88b1\u8f7b\uff0c\u4e0d\u9700\u8981\u4e86\u89e3\u5404\u79cdPIO\u76f8\u5173\u5bc4\u5b58\u5668\u7684\u8bbe\u7f6e\u4ee5\u53ca\u5206\u6bb5\u7ba1\u7406\u3002 \u76f8\u6bd4RISC-V\uff0c\u5e26MMU\u7684\u64cd\u4f5c\u7cfb\u7edf\u76f4\u63a5\u8fd0\u884c\u5728\u6700\u9ad8\u7279\u6743\u7ea7\uff0c\u4e0d\u9700\u8981\u4e86\u89e3SBI\u4ee5\u53caSupervisor\u7279\u6743\u7ea7\u7b49\u4e00\u7cfb\u5217\u5185\u5bb9\u3002 LoongArch32\u4e0ex86\u3001ARM\u3001RISC-V\u5728\u5185\u5b58\u7ba1\u7406\u4e0a\u7684\u533a\u522b \u00b6 \u5b83\u7684\u865a\u62df\u5185\u5b58\u7ba1\u7406\u91c7\u7528 \u8f6f\u4ef6\u63a7\u5236TLB \uff0c\u4e0eMIPS\u7c7b\u4f3c\uff0c\u5f53TLB\u67e5\u627e\u5931\u8d25\u6216TLB\u67e5\u627e\u6210\u529f\u4f46\u6709\u6548\u4f4d\u4e3a0\u65f6\uff0c\u4ea7\u751f\u5bf9\u5e94\u7684TLB\u5f02\u5e38\uff0c\u8df3\u8f6c\u5230\u5f02\u5e38\u5904\u7406\u5730\u5740\u8fdb\u884c\u5904\u7406\u3002 \u800cx86\u3001ARM\u3001RISC-V\u90fd\u662f\u91c7\u7528\u786c\u4ef6\u904d\u5386\u9875\u8868\u65b9\u5f0f\uff0c\u8f6f\u4ef6\u53ea\u9700\u8981\u5c06\u9875\u8868\u57fa\u5730\u5740\u901a\u8fc7\u4e00\u4e2aCSR\u544a\u77e5\u786c\u4ef6\uff08\u5982x86\u4e0a\u7684CR3\u3001RISC-V\u4e0a\u7684satp\uff09\uff0c\u786c\u4ef6\u5b8c\u6210TLB\u586b\u5145\u3002\u53ea\u6709\u5f53\u9875\u8868\u904d\u5386\u53d1\u73b0\u9875\u9762\u65e0\u6548\u65f6\u624d\u4ea7\u751f\u7f3a\u9875\u5f02\u5e38\uff0c\u8df3\u8f6c\u5230\u5f02\u5e38\u5904\u7406\u5730\u5740\u8fdb\u884c\u5904\u7406\u3002 \u56e0\u6b64\uff0c\u5728LoongArch32\u4e0eMIPS\u4e00\u6837 \u6ca1\u6709\u7f3a\u9875\u5f02\u5e38 \uff0c\u5176\u7f3a\u9875\u5f02\u5e38\u5305\u542b\u5728TLB\u5f02\u5e38\u4e2d\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u5224\u65ad\u662f\u5426\u662f\u7f3a\u9875\u3002 \u5728x86\u3001ARM\u3001RISC-V\u4e0a \u6ca1\u6709TLB\u5f02\u5e38 \u3002 \u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668 \u00b6 \u6211\u4eec\u4e5f\u8bb8\u77e5\u9053CPU\u4e0a\u6709\u4e00\u4e9b\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u751a\u81f3\u6709\u4e00\u4e9b\u540c\u5b66\u80fd\u975e\u5e38\u719f\u6089\u4ed6\u4eec\u7684\u540d\u5b57\uff0c\u4f8b\u5982x86-64\u4e0a\u7684RAX\u3001RSP\u3001RBP\u7b49\uff0cARM/MIPS/RISC-V\u4e0a\u768432\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u4ee5\u53ca\u5404\u81ea\u7684\u522b\u540d\uff0c\u5982a0\u3001a1\u3001sp\u3001ra\u7b49\u3002 \u4f46\u6211\u4eec\u7684CPU\u4e0a\uff0c\u8fd8\u6709\u4e00\u79cd\u7279\u6b8a\u7684\u5bc4\u5b58\u5668\uff0c\u5b83\u79f0\u4e3a\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668\uff08Control/Status Registers\uff0cCSR\uff09\uff0c\u5b83\u5bf9\u8ba1\u7b97\u673a\u7684\u7cfb\u7edf\u72b6\u6001\u4e0e\u63a7\u5236\u8fdb\u884c\u7ba1\u7406\u3002\u5e76\u901a\u8fc7CSR\u6307\u4ee4\u5bf9\u4ed6\u4eec\u8fdb\u884c\u8bfb\u5199\uff0c\u5728\u4fee\u6539\u540e\uff0c\u8ba1\u7b97\u673a\u7684\u8fd0\u884c\u72b6\u6001\u4e5f\u5c31\u968f\u4e4b\u6539\u53d8\u3002 \u4f8b\u5982\uff0c\u5728LoongArch32\u67b6\u6784\u4e2d\uff0c\u6709\u4e24\u79cd\u7279\u6743\u7ea7\uff0cPLV0\uff08\u4fd7\u79f0\u5185\u6838\u6001\uff09\u4e0ePLV3\uff08\u4fd7\u79f0\u7528\u6237\u6001\uff09\u3002\u7c7b\u4f3c\u4e8ex86\u67b6\u6784\u4e0a\u7684Ring0\u4e0eRing3\u3002\u4e5f\u7c7b\u4f3cARM\u4e0a\u7684EL0\u4e0eEL3\uff0c\u4ee5\u53caRISC-V\u67b6\u6784\u4e2d\u7684Machine\u4e0eUser\u3002 Note \u5c0f\u601d\u8003\uff1a\u64cd\u4f5c\u7cfb\u7edf\u4e00\u5b9a\u8fd0\u884c\u5728\u6700\u9ad8\u7279\u6743\u7ea7\u5417\uff1f\u5982\u679c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u4e0a\u8fd8\u6709\u4e00\u5c42\u7279\u6743\u7ea7\u4f1a\u5e26\u6765\u4ec0\u4e48\u597d\u5904\uff1f \u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u4e86\u89e3RISC-V\u67b6\u6784\u4e2d\u7684Supervisor\u7279\u6743\u7ea7\u4ee5\u53ca\u5404\u4e2a\u6307\u4ee4\u96c6\u67b6\u6784\u7684\u865a\u62df\u5316\u673a\u5236\u3002 \u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u4f1a\u6d89\u53ca\u5230CSR\u7684 CRMD \u72b6\u6001\u4fee\u6539\u3001 DMW0 \u4e0e DMW1 \u7684\u914d\u7f6e\u3002\u5173\u4e8e\u8fd9\u91cc\u7684\u5bc4\u5b58\u5668\u5404\u4f4d\u57df\u7684\u5177\u4f53\u542b\u4e49\u4ee5\u53ca\u914d\u7f6e\u65b9\u5f0f\uff0c\u9700\u8981\u5927\u5bb6\u81ea\u884c\u9605\u8bfb \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u5b8c\u6210\u3002 Info \u8bf7\u5927\u5bb6\u81ea\u884c\u9605\u8bfb \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u4e2d\u7684P55, \u4e86\u89e3CRMD\u540e\uff0c\u518d\u7ee7\u7eed\u4e86\u89e3\u540e\u7eed\u5185\u5bb9\u3002 \u5173\u4e8eDMW\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u53ef\u4ee5\u6682\u65f6\u8df3\u8fc7\uff0c\u6211\u4eec\u4f1a\u5728\u540e\u6587\u4e2d\u4ecb\u7ecd\uff0c\u53ef\u5c4a\u65f6\u518d\u56de\u8fc7\u5934\u6765\u770bDMW\u7684\u5bc4\u5b58\u5668\u3002 I/O\u4e0e\u5730\u5740\u7a7a\u95f4 \u00b6 I/O\u7b80\u4ecb \u00b6 \u8bb8\u591a\u540c\u5b66\u4e5f\u8bb8\u4f1a\u597d\u5947\uff0c\u5f53\u6211\u4eec\u7684\u8ba1\u7b97\u673a\u8fde\u63a5\u4e0a\u4e00\u4e2a\u5916\u8bbe\u65f6\uff0c\u8ba1\u7b97\u673a\u662f\u600e\u4e48\u53d1\u73b0\u8fd9\u4e9b\u5916\u8bbe\u7684\u8fde\u63a5\uff1f\u5916\u8bbe\u4e0e\u6211\u4eec\u7684\u8ba1\u7b97\u673a\u662f\u600e\u4e48\u4ea4\u4e92\u7684\u5462\uff1f \u8fd9\u91cc\u5c31\u9700\u8981\u6d89\u53ca\u5230I/O\u7684\u6982\u5ff5\u3002 \u5728\u6211\u4eec\u7684\u8ba1\u7b97\u673a\u4e2d\uff0cI/O\u65b9\u5f0f\u901a\u5e38\u53ef\u5206\u4e3a3\u79cd\uff1a PMIO (Port-Mapped I/O) \u00b6 \u8fd9\u662f\u4e00\u79cd\u975e\u5e38\u7279\u6b8a\u7684I/O\uff0c\u5728LoongArch32\u3001RISC-V\u3001ARM\u3001MIPS\u4e2d \u5747\u4e0d\u5b58\u5728 \u3002 \u5728x86\uff08\u542bx86-64\uff09\u67b6\u6784\u4e2d\uff0c\u6709\u4e00\u4e2a\u4e0e\u5185\u5b58\u72ec\u7acb\u7684I/O\u5730\u5740\u7a7a\u95f4\uff0c\u4f7f\u7528 in[blw] \u4e0e out[blw] \u6307\u4ee4\uff0c\u5b8c\u6210I/O\u5730\u5740\u4e0eGPR\uff08\u901a\u7528\u5bc4\u5b58\u5668\uff09\u95f4\u7684\u6570\u636e\u79fb\u52a8\u3002 MMIO (Memory-Mapped I/O) \u00b6 \u5185\u5b58\u6620\u5c04I/O\u5c31\u662f\u5c06I/O\u8bbe\u5907\u6620\u5c04\u5230\u7269\u7406\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u4e2d\uff0c\u50cf\u8bfb\u5199\u5185\u5b58\u4e00\u6837\u8bbf\u95eeI/O\u8bbe\u5907\u3002 \u8fd9\u79cd\u65b9\u5f0f\u5bf9\u4e8e\u8f6f\u4ef6\u800c\u8a00\u975e\u5e38\u65b9\u4fbf\uff0c\u4ec5\u9700\u8981\u7528\u4e00\u4e2a\u6307\u9488\u6307\u5411\u5bf9\u5e94\u7684MMIO\u8bbe\u5907\u4e0a\u7684\u5730\u5740\uff0c\u5e76\u4e86\u89e3\u8bfb\u5199MMIO\u8bbe\u5907\u5730\u5740\u7684\u5177\u4f53\u542b\u4e49\u5373\u53ef\u5b8c\u6210IO\u64cd\u4f5c\u3002 \u4f8b\u5982\u6211\u4eec\u5b9e\u9a8c\u4e2d\u6d89\u53ca\u5230\u7684UART\u4e32\u53e3\u5c31\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u8fdb\u884cIO\u4ea4\u4e92\u3002 DMA (Direct Memory Access) \u00b6 \u5c3d\u7ba1MMIO\u5f88\u65b9\u4fbf\uff0c\u4f46\u5b83\u7684\u6570\u636e\u642c\u8fd0\u9700\u8981CPU\u53c2\u4e0e\uff0c\u6548\u7387\u8f83\u4f4e\u3002 \u5bf9\u4e8e\u4e00\u6b21\u8bbf\u95ee\u5927\u91cf\u6570\u636e\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba9\u8bbe\u5907\u76f4\u63a5\u8bfb\u5199\u5185\u5b58\uff0c\u907f\u514d\u7ecf\u8fc7CPU\u5f71\u54cd\u6548\u7387\u3002 \u73b0\u5728\u8ba1\u7b97\u673a\u7684\u9ad8\u901fIO\uff0c\u4f8b\u5982\u7f51\u5361\u3001\u786c\u76d8\u63a7\u5236\u5668\u3001GPU\uff0c\u90fd\u4f7f\u7528DMA\u6280\u672f\u5c06\u6570\u636e\u7f13\u51b2\u533a\u76f4\u63a5\u653e\u7f6e\u4e8e\u5185\u5b58\uff0c\u907f\u514d\u5927\u91cf\u6570\u636e\u4f20\u8f93\u65f6\u9700\u8981\u5927\u91cfMMIO\u8bbf\u95ee\u3002 \u8fd9\u91cc\u9700\u8981\u63d0\u9192\u540c\u5b66\u4eec\u6ce8\u610f\u7684\u662f\uff0cDMA\u8bbf\u95ee\u901a\u5e38\u4e0e\u5176\u4ed6IO\u65b9\u5f0f\u4ee5\u53ca\u4e2d\u65ad\u914d\u5408\u4f7f\u7528\u3002\u5176\u4ed6IO\u65b9\u5f0f\u7528\u4e8e\u8fdb\u884cDMA\u4f20\u8f93\u7684\u63a7\u5236\uff0c\u4e2d\u65ad\u7528\u4e8e\u901a\u77e5DMA\u72b6\u6001\u6539\u53d8\uff0c\u4f8b\u5982\u6709\u65b0\u6570\u636e\u5df2\u7ecf\u5b8c\u6210\u5199\u5165\u5185\u5b58\u6216\u8005\u7f13\u51b2\u533a\u5df2\u7ecf\u53d1\u5230\u5bf9\u5e94\u7684\u8bbe\u5907\u3002 Note \u5c0f\u601d\u8003\uff1a \u5982\u679cCPU\u6709Cache\uff0c\u5bf9\u5916\u8bbe\u7684MMIO\u8bbf\u95ee\u80fd\u4e0d\u80fd\u7ecf\u8fc7Cache\u5462\uff1f\u4e3a\u4ec0\u4e48\uff1f \u5982\u679cCPU\u4e3a\u4e71\u5e8f\u591a\u53d1\u5c04\u67b6\u6784\uff0c\u5bf9\u5916\u8bbe\u7684MMIO\u8bbf\u95ee\u80fd\u5426\u4e71\u5e8f\u53d1\u51fa\u5462\uff1f \u9664\u4e86\u63d2\u5165\u5185\u5b58\u5c4f\u969c\u6307\u4ee4\u5916\uff0c\u5404\u4e2a\u6307\u4ee4\u96c6\u67b6\u6784\u8fd8\u63d0\u4f9b\u4e86\u4ec0\u4e48\u914d\u7f6e\u4f7f\u5f97\u4f7f\u7528\u865a\u62df\u5730\u5740\u8fdb\u884cMMIO\u8bbf\u95ee\u65f6CPU\u4e00\u5b9a\u80fd\u786e\u4fdd\u987a\u5e8f\u6267\u884c\uff1f \u5982\u679cCPU\u6709Cache\uff0cDMA\u64cd\u4f5c\u4e0d\u7ecf\u8fc7Cache\u76f4\u63a5\u8bfb\u5199\u5185\u5b58\u4ea7\u751f\u4e86Cache\u7684\u6570\u636e\u4e0e\u5185\u5b58\u4e0d\u4e00\u81f4\u600e\u4e48\u529e\uff1f\u652f\u6301DMA\u4e00\u81f4\u6027\u7684CPU\u4e0e\u4e0d\u652f\u6301DMA\u4e00\u81f4\u6027\u7684CPU\u5206\u522b\u600e\u4e48\u505a\uff1f \u5728C\u8bed\u8a00\u4e2d\u5b8c\u6210MMIO\u8bbf\u95ee\u65f6\uff0c\u4e3a\u4ec0\u4e48\u901a\u5e38\u4f1a\u5bf9\u6307\u5411\u8981\u8bbf\u95ee\u7684\u6570\u636e\u7684\u6307\u9488\u52a0\u4e0a volatile \u5173\u952e\u5b57\uff0c\u5b83\u4f1a\u5982\u4f55\u5f71\u54cd\u7f16\u8bd1\u5668\u884c\u4e3a\uff1f\uff08\u540c\u5b66\u4eec\u53ef\u4ee5\u8bd5\u8bd5\u770b\u7b80\u5355\u5199\u4e00\u4e2a\u8fde\u7eed\u8fdb\u884cMMIO\u8bbf\u95ee\u7684\u88f8\u673a\u7a0b\u5e8f\uff0c\u5e76\u5728\u7f16\u8bd1\u65f6\u5f00\u542fO2\u4f18\u5316\uff0c\u89c2\u5bdf\u751f\u6210\u6c47\u7f16\u7684\u53d8\u5316\u3002\uff09 \u65e2\u7136\u8bbf\u95ee\u7684\u6570\u636e\u7ec8\u7a76\u662f\u8981\u88ab\u4f7f\u7528\u7684\uff0c\u90a3\u4e48\u5747\u644a\u65f6\u95f4\u6765\u8bf4DMA\u7684\u4f18\u52bf\u5728\u54ea\u91cc\u5462\uff1f\uff08\u63d0\u793a\uff1a\u53ef\u4ee5\u4e86\u89e3\u5355\u6b21Uncached\u8bbf\u95ee\u5ef6\u8fdf\uff0c\u4ee5\u53ca\u540e\u7eed\u4f53\u7cfb\u67b6\u6784\u8bfeCache\u5b9e\u9a8c\u4e2d\u7684\u603b\u7ebf\u7a81\u53d1\u4f20\u8f93\uff0cSIMD\u6307\u4ee4\uff0c\u8f6f\u4ef6\u4e0a\u5bf9\u6570\u636e\u7684\u96f6\u62f7\u8d1d\u5904\u7406\uff0c\u6216\u8bb8\u80fd\u591f\u89e3\u7b54\u540c\u5b66\u4eec\u7684\u7591\u60d1\u3002\uff09 \u64cd\u4f5c\u7cfb\u7edf\u5982\u4f55\u77e5\u9053\u8fd9\u53f0\u8ba1\u7b97\u673a\u4e0a\u6709\u54ea\u4e9b\u8bbe\u5907\uff1f \u00b6 e820\u4e0eACPI \u00b6 \u5728x86\u8ba1\u7b97\u673a\u4e2d\uff0cBIOS\u63d0\u4f9b\u4e86\u4e00\u4e2ae820\u5185\u5b58\u7ba1\u7406\u5668\uff0c\u5e76\u901a\u8fc7\u4e2d\u65ad\u6307\u4ee4\uff08x86\u4e0a\u7684int\uff09\u8c03\u7528BIOS\u5b8c\u6210\u7269\u7406\u5185\u5b58\u5730\u5740\u7684\u63a2\u6d4b\u3002 \u6709\u5728x86\u8ba1\u7b97\u673a\u4e0a\u4f7f\u7528Linux\u7684\u540c\u5b66\u4eec\uff0c\u53ef\u4ee5\u901a\u8fc7dmesg\u547d\u4ee4\u67e5\u770b\u5185\u6838\u7684\u8f93\u51fa\uff0c\u5728\u5185\u6838\u542f\u52a8\u65f6\u53ef\u4ee5\u627e\u5230BIOS\u63d0\u4f9b\u7684e820\u5185\u5b58\u6620\u5c04\u8868\uff0c\u4e14\u5982\u679c\u540c\u5b66\u4eec\u7684\u8ba1\u7b97\u673a\u91c7\u7528\u6838\u5fc3\u663e\u5361\uff0c\u5f80\u5f80\u4f1a\u770b\u5230\u6570\u767e\u5146\u751a\u81f3\u6570GB\u7684\u5185\u5b58\u5e26\u4e0a\u4e86reserved\u6807\u8bb0\uff0c\u8fd9\u662f\u56e0\u4e3a\u6838\u5fc3\u663e\u5361\u4f1a\u5360\u7528\u4e00\u90e8\u5206\u5185\u5b58\u3002\u4f46\u8fd9\u91cc\u8fd8\u8981\u63d0\u9192\u540c\u5b66\u4eec\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u865a\u62df\u673a\u7684\u8bdd\uff0c\u770b\u7684\u5c31\u662f\u4f60\u865a\u62df\u673a\u7684e820\u800c\u4e0d\u662f\u771f\u5b9e\u8ba1\u7b97\u673aBIOS\u6c47\u62a5\u7684e820\u4e86\u3002 ACPI\uff08Advanced Configuration and Power Interface\uff09\u662f\u4e0a\u4e2a\u4e16\u7eaa90\u5e74\u4ee3\u4ea7\u751f\u7684\u4e00\u79cd\u5f00\u653e\u6807\u51c6\uff0c\u5b83\u5b9a\u4e49\u4e86\u7cfb\u7edf\u56fa\u4ef6\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u95f4\u7684\u786c\u4ef6\u62bd\u8c61\u63a5\u53e3\u3002x86\u8ba1\u7b97\u673a\u4e0a\u7684\u64cd\u4f5c\u7cfb\u7edf\u5c31\u53ef\u4ee5\u5229\u7528ACPI\u5bf9\u56fa\u4ef6\u51fd\u6570\u8fdb\u884c\u8c03\u7528\uff0c\u83b7\u53d6\u7cfb\u7edf\u4e0a\u7684\u5185\u5b58\u5e03\u5c40\u3001\u5404\u8bbe\u5907\u6240\u5904\u7684\u4f4d\u7f6e\u548c\u8bbe\u5907\u578b\u53f7\u7b49\uff0c\u5c31\u5b9e\u73b0\u4e86\u540c\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u80fd\u591f\u517c\u5bb9\u591a\u79cd\u4e0d\u540c\u7684\u8ba1\u7b97\u673a\u3002 \u8bbe\u5907\u6811 \u00b6 \u81ea\u5df1\u7ed9\u4e00\u4e9b\u5d4c\u5165\u5f0f\u5f00\u53d1\u677f\u7f16\u8bd1\u8fc7\u7cfb\u7edf\u8f6f\u4ef6\u7684\u540c\u5b66\u4e00\u5b9a\u5bf9\u8bbe\u5907\u6811\u4e0d\u964c\u751f\u3002 \u5728\u8fd9\u4e9b\u6ca1\u6709ACPI\u673a\u5236\u7684\u5e73\u53f0\u4e0a\uff0c\u901a\u5e38\u91c7\u7528\u4e00\u79cd\u53eb\u505a\u8bbe\u5907\u6811\u7684\u811a\u672c\u6765\u63cf\u8ff0\u8ba1\u7b97\u673a\u786c\u4ef6\u4e0a\u5404\u4e2a\u8bbe\u5907\u3002\u8be5\u8bbe\u5907\u6811\u901a\u5e38\u4f1a\u653e\u7f6e\u4e8eBootloader\u4e2d\u901a\u8fc7\u53c2\u6570\u4f20\u9012\u7ed9\u7cfb\u7edf\u5185\u6838\uff0c\u4e5f\u53ef\u80fd\u76f4\u63a5\u5185\u5d4c\u4e0e\u7cfb\u7edf\u5185\u6838\u4e2d\uff0c\u60f3\u8981\u77e5\u9053\u8bbe\u5907\u6811\u662f\u4e2a\u4ec0\u4e48\u6587\u4ef6\u7684\u540c\u5b66\u53ef\u4ee5\u7ffb\u770bLinux\u5185\u6838\u6e90\u4ee3\u7801\u7684 arch/*/boot/dts \u6587\u4ef6\u5939\u3002 \u800c\u5bf9\u4e8e\u4e00\u4e9b\u5373\u63d2\u5373\u7528\u7684\u8bbe\u5907\uff0c\u4f8b\u5982USB\u4e0ePCI-E\uff0c\u8bbe\u5907\u6811\u901a\u5e38\u4ec5\u63d0\u4f9b\u5176\u63a7\u5236\u5668\u672c\u8eab\u7684\u63cf\u8ff0\uff0c\u8fd9\u4e9b\u5373\u63d2\u5373\u7528\u8bbe\u5907\u7684\u5177\u4f53\u63a2\u6d4b\u4ea4\u7ed9\u63a7\u5236\u5668\u9a71\u52a8\u6765\u5b8c\u6210\u3002 \u8fd8\u53ef\u4ee5\u9009\u62e9\u4e0d\u63a2\u6d4b \u00b6 \u5728LoongArch32\u7684uCore\u79fb\u690d\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5316\u64cd\u4f5c\u7cfb\u7edf\uff0c\u6211\u4eec\u6ca1\u6709\u4f7f\u7528\u4efb\u4f55\u8bbe\u5907\u63a2\u6d4b\u7684\u65b9\u6cd5\u3002\u6bd5\u7adf\u6ca1\u6709ACPI\uff0c\u4e5f\u6ca1\u6709Bootloader\u4f20\u9012\u8bbe\u5907\u6811\uff0c\u5373\u4f7f\u6709\u4f20\u9012\u8bbe\u5907\u6811\u4e5f\u9700\u8981\u4e00\u90e8\u5206\u89e3\u6790\u8bbe\u5907\u6811\u7684\u4ee3\u7801\uff0c\u4f1a\u589e\u52a0\u7cfb\u7edf\u7684\u590d\u6742\u7a0b\u5ea6\u3002 \u5bf9\u4e8e\u5185\u5b58\u5927\u5c0f\uff0c\u7531\u4e8eLoongArch32\u4e0b\u53ef\u7528\u7269\u7406\u5185\u5b58\u8303\u56f4\u662f\u4ece0\u5f00\u59cb\u8fde\u7eed\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u8bbe\u5b9a\u4e00\u4e2a\u56fa\u5b9a\u503c32M\uff0c\u76f4\u63a5\u4f7f\u7528\u5373\u53ef\u3002 \u800c\u5bf9\u4e8eIO\u5916\u8bbe\uff0c\u5728uCore\u4e2d\u4ec5\u4f7f\u7528\u4e32\u53e3\uff0c\u4e14\u5b83\u7684MMIO\u5730\u5740\u4ee5\u53ca\u4e2d\u65ad\u670d\u52a1\u53f7\u5728\u6211\u4eec\u4f7f\u7528\u7684QEMU\u4e0eChiplab FPGA\u8f6f\u6838SoC\u73af\u5883\u4e2d\u90fd\u662f\u56fa\u5b9a\u7684\uff0c\u56e0\u6b64\u4e5f\u5c06\u8be5\u5730\u5740\u56fa\u5b9a\u4e86\uff0c\u76f4\u63a5\u4f7f\u7528\u5373\u53ef\u3002 \u865a\u62df\u5730\u5740\u7ba1\u7406 \u00b6 LoongArch32\u7684\u865a\u62df\u5730\u5740\u6620\u5c04\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u4e00\u79cd\u662fDMW\uff0c\u4e00\u79cd\u662fTLB\u3002DMW\u7684\u67e5\u627e\u4f18\u5148\u4e8eTLB\u7684\u67e5\u627e\uff0c\u5f53\u4e24\u8005\u5747\u67e5\u627e\u5931\u8d25\u65f6\u4ea7\u751fTLB REFILL\u4f8b\u5916\uff08\u5f02\u5e38\uff09\u3002 DMW \u00b6 LoongArch32\u6709\u4e00\u79cd\u7279\u6b8a\u7684\u865a\u62df\u5730\u5740\u6620\u5c04\u65b9\u5f0f\uff0c\u79f0\u4e3a\u76f4\u63a5\u6620\u5c04\u914d\u7f6e\u7a97\u53e3\uff08DMW\uff09\u3002\u5b83\u53ef\u4ee5\u63d0\u4f9b\u865a\u62df\u5730\u5740 [31:29] \u90e8\u5206\u5230\u7269\u7406\u5730\u5740 [31:29] \u7684\u6620\u5c04\u914d\u7f6e\u3002\u5e76\u53ef\u4ee5\u5728\u5730\u5740\u6620\u5c04\u7a97\u53e3\u4e2d\u8bbe\u7f6e\u5141\u8bb8\u8bbf\u95ee\u8be5\u7a97\u53e3\u7684\u7279\u6743\u7ea7\u4ee5\u53caCache\u5c5e\u6027\u3002 \u8be6\u7ec6\u4fe1\u606f\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u4e2d\u7684P43\u3002 TLB \u00b6 \u5927\u5bb6\u5e94\u8be5\u5728\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406\u8bfe\u7a0b\u65f6\u5df2\u7ecf\u5bf9TLB\u6709\u4e00\u4e2a\u521d\u6b65\u7684\u4e86\u89e3\uff0c\u5b83\u662f\u4e00\u4e2a\u865a\u62df\u5730\u5740\u7ffb\u8bd1\u7684\u7f13\u51b2\u533a\uff0c\u50a8\u5b58\u4e86\u6700\u8fd1\u4f7f\u7528\u7684\u4e00\u90e8\u5206\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u5e76\u8bb0\u5f55\u4e86\u5bf9\u5e94\u865a\u62df\u9875\u9762\u7684\u5143\u6570\u636e\uff0c\u4f8b\u5982\u6743\u9650\u914d\u7f6e\u4e0eCache\u5c5e\u6027\u7b49\u3002 \u4e5f\u8bb8\u6709\u7684\u540c\u5b66\u4f1a\u60f3\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981TLB\u800c\u4e0d\u662f\u6bcf\u6b21\u8bbf\u95ee\u9875\u8868\u52a0\u4e0aPage Table Cache\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u591a\u7ea7\u683c\u5f0f\u904d\u5386\u65f6\u9700\u8981\u9010\u5c42\u8bbf\u95ee\u591a\u4e2a\u5730\u5740\u5e76\u4e0d\u9002\u5408\u5904\u7406\u5668\u5355\u4e2a\u5468\u671f\u8bbf\u95ee\uff0c\u56e0\u4e3a\u786c\u4ef6\u4e0a\u5c06\u9875\u8868\u904d\u5386\u7684\u7ed3\u679c\u653e\u5728\u4e00\u4e2a\u7f13\u51b2\u533a\u4e2d\uff0c\u8fd9\u4e2a\u7f13\u51b2\u533a\u5c31\u662fTLB\u3002 \u4e0d\u540c\u4e8ex86\u3001ARM\u3001RISC-V\u7b49\u67b6\u6784\uff0c\u7531\u786c\u4ef6\u904d\u5386\u9875\u8868\u586b\u5145TLB\uff0c\u5e76\u63d0\u4f9b\u9875\u8868\u57fa\u5730\u5740\u7b49\u5bc4\u5b58\u5668\u7531\u8f6f\u4ef6\u914d\u7f6e\u5f53\u524d\u5904\u7406\u5668\u904d\u5386\u7684\u9875\u8868\u3002LoongArch32\u91c7\u7528\u4e86\u4e0eMIPS\u76f8\u540c\u7684\u8f6f\u4ef6\u63a7\u5236TLB\u7684\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u8be6\u7ec6\u4fe1\u606f\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u4e2d\u7684P55\u3002 \u672c\u6b21\u5b9e\u9a8c\u4e2d\u6682\u4e0d\u6d89\u53caTLB\uff0c\u5927\u5bb6\u53ea\u9700\u8981\u4e86\u89e3\u5b83\u7684\u5b58\u5728\u5373\u53ef\u3002 \u5982\u4f55\u914d\u7f6eDMW\uff1f \u00b6 \u5bf9\u4e8e\u5927\u591a\u6570\u6307\u4ee4\u96c6\u67b6\u6784\u800c\u8a00\uff08\u6211\u4eec\u719f\u6089\u7684MIPS\u662f\u4e2a\u6709\u56fa\u5b9a\u865a\u62df\u5730\u5740\u6620\u5c04\u7684\u7279\u4f8b\uff09\uff0c\u5728\u8ba1\u7b97\u673a\u4e0a\u7535\u542f\u52a8\u65f6\uff0c\u8f6f\u4ef6\u8fd0\u884c\u5728\u7269\u7406\u5730\u5740\u7a7a\u95f4\u4e2d\u3002\u771f\u5b9e\u786c\u4ef6\u4e0a\u901a\u5e38\u4f1a\u5728\u4e0a\u7535\u542f\u52a8\u65f6\u4ece\u7b2c\u4e00\u7ea7Bootloader\u5f00\u59cb\u6267\u884c\u5b8c\u6210\u7cfb\u7edf\u7684\u521d\u59cb\u5316\uff0c\u518d\u9010\u7ea7\u8f7d\u5165\u66f4\u9ad8\u7ea7\u7684Bootloader\u4ee5\u81f3\u4e8e\u6700\u540e\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\u3002\u800c\u5177\u4f53\u4ece\u54ea\u4e00\u7ea7\u5f00\u59cb\u4f7f\u7528\u865a\u62df\u5730\u5740\u53d6\u51b3\u4e8e\u5404\u67b6\u6784\u4ee5\u53ca\u7cfb\u7edf\u8f6f\u4ef6\u3002\u5bf9\u4e8e\u6211\u4eec\u672c\u6b21\u5b9e\u9a8c\u4f7f\u7528\u7684LoongArch32\u67b6\u6784\u800c\u8a00\uff0c\u5728QEMU\u4e0a\u8fd0\u884c\u65f6\u662f\u5728uCore\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u65f6\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u914d\u7f6eDMW\u7a97\u53e3\u5e76\u4fee\u6539CSR.CRMD\u5bc4\u5b58\u5668\u5f00\u59cb\u5f00\u542f\u865a\u62df\u5730\u5740\u6620\u5c04\u7684\u3002\u800c\u5982\u679c\u662f\u4f7f\u7528Chiplab\u8f6f\u6838\uff0c\u5b83\u7684\u7b2c\u4e00\u7ea7Bootloader\u662fPMON\uff0c\u5728PMON\u4e2d\u5c31\u4f1a\u8bbe\u7f6eDMW\u5e76\u5f00\u542f\u865a\u62df\u5730\u5740\u6620\u5c04\u3002 \u5728uCore\u4e2d\uff0c\u4f1a\u914d\u7f6e\u4e24\u4e2aDMW\u7a97\u53e3\uff0c\u5206\u522b\u7528\u4e8e\u5185\u6838\u666e\u901a\u7684DRAM\u8bbf\u95ee\u4e0eIO\u5916\u8bbe\u8bbf\u95ee\uff0c\u5982\u4e0b\uff1a DMW\u7f16\u53f7 MAT\uff08\u5b58\u50a8\u8bbf\u95ee\u7c7b\u578b\uff09 PLV0 PLV3 PSEG VSEG VSEG\u8303\u56f4 DMW0 1\uff08\u4e00\u81f4\u53ef\u7f13\u5b58\uff09 1 0 0b000 (0x00000000-0x1fffffff) 0b101 0xa0000000-0xbfffffff DMW1 0\uff08\u5f3a\u5e8f\u975e\u7f13\u5b58\uff09 1 0 0b000 (0x00000000-0x1fffffff) 0b100 0x80000000-0x9fffffff \u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u662f\u4eceQEMU\u6a21\u62df\u5668\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\uff0cDMW\u6211\u4eec\u53ef\u4ee5\u81ea\u5b9a\u4e49\uff0c\u4f46\u5982\u679c\u662f\u4eceChiplab\u7684FPGA\u8f6f\u6838\u4e0a\u4f7f\u7528PMON\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\uff0c\u7531\u4e8ePMON\u672c\u8eab\u5df2\u7ecf\u8fdb\u884cDMW\u7684\u914d\u7f6e\u5e76\u8fd0\u884c\u5728\u865a\u62df\u5730\u5740\uff0c\u56e0\u6b64\u6211\u4eec\u7684DMW\u914d\u7f6e\u5fc5\u987b\u4e0ePMON\u4e00\u81f4\u624d\u80fd\u4fdd\u8bc1\u7cfb\u7edf\u6b63\u5e38\u542f\u52a8\u3002 \u7279\u522b\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cLoongArch32\u7684QEMU\u6709\u4e00\u4e2a\u7279\u70b9\u662f\u5b83\u4f1a\u5728\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u4e0b\u53bb\u9664\u7269\u7406\u5730\u5740\u7684\u9ad83\u4f4d\uff0c\u4ee5\u786e\u4fdd\u6ca1\u6709\u914d\u7f6eDMW\u65f6\u80fd\u591f\u6b63\u786e\u542f\u52a8\u7cfb\u7edf\u8f6f\u4ef6\uff0c\u4f46\u771f\u5b9e\u7684LoongArch32\u786c\u4ef6\uff08\u5982Chiplab\u8f6f\u6838\uff09\u4e0d\u4f1a\u8fd9\u4e48\u505a\u3002\u56e0\u6b64\u5927\u5bb6\u5728\u7f16\u5199\u7cfb\u7edf\u8f6f\u4ef6\u7684\u65f6\u5019\u9700\u8981\u6ce8\u610f\u8fd9\u4e2a\u7279\u5f81\uff0c\u7f16\u5199\u90a3\u4e9b\u8fd0\u884c\u5728\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u7684\u4ee3\u7801\u65f6\u9700\u8981\u786e\u4fdd\u53d6\u6307\u5730\u5740\u548c\u8bbf\u5b58\u5730\u5740\u5747\u4e3a\u7269\u7406\u5730\u5740\uff0c\u82e5\u65e0\u6cd5\u4fdd\u8bc1\u5219\u53ef\u4ee5\u505a\u4e00\u5c42\u8df3\u8f6c\uff08\u53c2\u8003uCore\u5904\u7406TLBREFILL\u7684\u4ee3\u7801\uff09\uff0c\u5207\u6362\u4e3a\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u518d\u8fdb\u884c\u4e0b\u4e00\u6b65\u64cd\u4f5c\uff0c\u9632\u6b62\u7f16\u5199\u7684\u64cd\u4f5c\u7cfb\u7edf\u5728QEMU\u4e0a\u80fd\u8fd0\u884c\u4f46\u65e0\u6cd5\u5728\u771f\u5b9e\u786c\u4ef6\u4e0a\u8fd0\u884c\u3002 QEMU\u7b80\u4ecb \u00b6 QEMU\u662f\u4e00\u6b3e\u6a21\u62df\u5668\uff08\u865a\u62df\u673a\uff09\uff0c\u652f\u6301\u591a\u79cd\u6307\u4ee4\u96c6\u67b6\u6784\u3002\u6211\u4eec\u5b9e\u9a8c\u4e2d\u4f7f\u7528\u7684\u662fLoongArch32\u67b6\u6784\u7684QEMU\u3002","title":"\u80cc\u666f\u4ecb\u7ecd"},{"location":"lab0/intro/#_1","text":"\u76f8\u4fe1\u5927\u5bb6\u901a\u8fc7\u201c\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406\u201d\u8fd9\u95e8\u8bfe\u7a0b\u5df2\u7ecf\u5bf9\u8ba1\u7b97\u673a\u5982\u4f55\u8ba1\u7b97\u4ee5\u53ca\u6267\u884c\u6307\u4ee4\u6709\u4e86\u4e00\u5b9a\u7684\u4e86\u89e3\u3002 \u4f46\u6211\u4eec\u8ba1\u7b97\u673a\u7684\u5904\u7406\u5668\u9664\u4e86\u7b80\u5355\u5730\u6267\u884c\u6307\u4ee4\u4e4b\u5916\uff0c\u5b83\u8fd8\u62e5\u6709\u7279\u6743\u7ea7\u7ba1\u7406\u3001\u5f02\u5e38\u4e0e\u4e2d\u65ad\u7b49\u529f\u80fd\uff0c\u8fd9\u4e9b\u786c\u4ef6\u529f\u80fd\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u8f6f\u4ef6\u5bc6\u5207\u76f8\u5173\u3002 \u76f8\u4fe1\u5927\u5bb6\u5728\u901a\u8fc7\u672c\u5b9e\u9a8c\u7684\u5b66\u4e60\u540e\uff0c\u80fd\u591f\u5bf9\u8ba1\u7b97\u673a\u7684\u542f\u52a8\u6d41\u7a0b\u4ee5\u53ca\u64cd\u4f5c\u7cfb\u7edf\u7684\u8fd0\u884c\u6d41\u7a0b\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u8ba4\u8bc6\uff0c\u89e3\u5f00\u5927\u5bb6\u5fc3\u4e2d\u8ba1\u7b97\u673a\u5e95\u5c42\u7684\u795e\u79d8\u9762\u7eb1\u3002","title":"\u5f00\u7bc7"},{"location":"lab0/intro/#loongarch32","text":"LoongArch\u662f\u4e00\u79cd\u7cbe\u7b80\u6307\u4ee4\u96c6\u67b6\u6784\u3002\u5206\u4e3a32\u4f4d\u4e0e64\u4f4d\u4e24\u4e2a\u7248\u672c\u3002\u6211\u4eec\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u91c7\u7528\u7684\u662f32\u4f4d\u7248\u672c\u3002","title":"LoongArch32\u7b80\u4ecb"},{"location":"lab0/intro/#_2","text":"LoongArch32\u670932\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u8bb0\u4e3ar0~r31\uff0c\u8fd9\u4e9b\u5bc4\u5b58\u5668\u5728 ABI \u4e2d\u5b9a\u4e49\u4e86\u5bf9\u5e94\u7684\u522b\u540d\uff0c\u5982\u4e0b\uff1a \u540d\u79f0 \u522b\u540d \u7528\u9014 \u5728\u8c03\u7528\u4e2d\u662f\u5426\u4fdd\u7559 $r0 $zero \u5e38\u6570 0 \uff08\u5e38\u6570\uff09 $r1 $ra \u8fd4\u56de\u5730\u5740 \u5426 $r2 $tp \u7ebf\u7a0b\u6307\u9488 \uff08\u4e0d\u53ef\u5206\u914d\uff09 $r3 $sp \u6808\u6307\u9488 \u662f $r4 - $r5 $a0 - $a1 \u4f20\u53c2\u5bc4\u5b58\u5668\u3001\u8fd4\u56de\u503c\u5bc4\u5b58\u5668 \u5426 $r6 - $r11 $a2 - $a7 \u4f20\u53c2\u5bc4\u5b58\u5668 \u5426 $r12 - $r20 $t0 - $t8 \u4e34\u65f6\u5bc4\u5b58\u5668 \u5426 $r21 \u4fdd\u7559 \uff08\u4e0d\u53ef\u5206\u914d\uff09 $r22 $fp / $s9 \u6808\u5e27\u6307\u9488 / \u9759\u6001\u5bc4\u5b58\u5668 \u662f $r23 - $r31 $s0 - $s8 \u9759\u6001\u5bc4\u5b58\u5668 \u662f \u6ce8\uff1aLoongArch32\u8001\u7248\u672cABI\u4e2d\u5b58\u5728\u4e0e v0 \u3001 v1 \u5bc4\u5b58\u5668\uff0c\u4e0e a0 \u3001 a1 \u540c\u4e3a $r4 \u4e0e $r5 \u5bc4\u5b58\u5668\u7684\u522b\u540d\uff0c\u5728\u65b0\u7248ABI\u4e2d\u5df2\u88ab\u820d\u5f03\u3002","title":"\u901a\u7528\u5bc4\u5b58\u5668"},{"location":"lab0/intro/#_3","text":"\u8fd9\u4e00\u90e8\u5206\u8bf7\u540c\u5b66\u4eec\u81ea\u884c\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u3002","title":"\u57fa\u672c\u6574\u6570\u6307\u4ee4"},{"location":"lab0/intro/#marco","text":"marco\u6307\u4ee4\u662f\u6211\u4eec\u7f16\u5199\u6c47\u7f16\u65f6\u6d89\u53ca\u5230\u7684\u4e00\u79cd\u7279\u6b8a\u6307\u4ee4\uff0c\u5b83\u672c\u8eab\u4e0d\u5b9a\u4e49\u5728ISA\u4e2d\u3002\u8fd9\u4e9bmarco\u6307\u4ee4\u5b9a\u4e49\u51fa\u6765\u540e\u4f1a\u5728\u6c47\u7f16\u5668\u7ffb\u8bd1\u6210\u5176\u4ed6\u4e00\u6761\u6216\u591a\u6761\u771f\u5b9e\u5b58\u5728\u7684\u6307\u4ee4\uff0c\u800c\u5b83\u5b58\u5728\u7684\u610f\u4e49\u662f\u4e3a\u4e86\u8ba9\u6211\u4eec\u7f16\u5199\u6c47\u7f16\u4ee3\u7801\u65f6\u80fd\u591f\u66f4\u52a0\u65b9\u4fbf\u3002 \u5728\u6211\u4eec\u79fb\u690d\u7684uCore for LoongArch32\u4e2d\uff0c\u53ea\u7528\u5230\u4e86\u4e00\u79cdmarco\u6307\u4ee4\uff0c\u5c31\u662f li.w \u3002\u56e0\u4e3aLoongArch32\u4e0d\u652f\u630132\u4f4d\u7684\u7acb\u5373\u6570\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u591a\u6761\u6307\u4ee4\u62fc\u51d1\u51fa\u4e00\u4e2a32\u4f4d\u7684\u7acb\u5373\u6570\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7528 li.w \u76f4\u63a5\u5e2e\u6211\u4eec\u62fc\u63a5\uff0c\u6700\u7ec8\u751f\u6210\u51fa\u6765\u7684\u662f lu12i.w \u4e0e\u4e00\u6761 ori \u6307\u4ee4\u5171\u540c\u5b8c\u6210li.w\u7684\u64cd\u4f5c\u3002 \u7531\u4e8e\u52a9\u6559\u6682\u672a\u627e\u5230\u9f99\u82af\u76f8\u5173\u6587\u6863\u7684\u8bf4\u660e\uff0c\u53ef\u4ee5\u901a\u8fc7\u9605\u8bfb\u6c47\u7f16\u5668\u7684\u6307\u4ee4\u5b9a\u4e49\u4ee3\u7801\u624b\u52a8\u9006\u5411marco\u6307\u4ee4\uff1a https://gitee.com/loongson-edu/la32r_binutils/blob/master/opcodes/loongarch-opc.c \u5982\u679c\u6709\u5174\u8da3\u7684\u540c\u5b66\u60f3\u77e5\u9053\u8fd9\u4e9bopcodes\u5982\u4f55\u5b9a\u4e49\uff0c\u53ef\u4ee5 \u53c2\u8003\u52a9\u6559\u7684\u535a\u5ba2 \uff0c\u66fe\u7ecf\u505a\u8fc7RISC-V\u4e0a\u6dfb\u52a0\u6307\u4ee4\u7684\u5de5\u4f5c\u3002","title":"marco\u6307\u4ee4"},{"location":"lab0/intro/#loongarch32_1","text":"\u5feb\u901f\u4e0a\u624b\u5bb9\u6613\uff0c\u4e0eMIPS\u975e\u5e38\u76f8\u4f3c\uff0c\u7b80\u5355\u6613\u61c2\u3002\u4e14\u5177\u6709\u4e2d\u6587\u6587\u6863\u3002 \u76f8\u6bd4x86\uff0c\u5386\u53f2\u5305\u88b1\u8f7b\uff0c\u4e0d\u9700\u8981\u4e86\u89e3\u5404\u79cdPIO\u76f8\u5173\u5bc4\u5b58\u5668\u7684\u8bbe\u7f6e\u4ee5\u53ca\u5206\u6bb5\u7ba1\u7406\u3002 \u76f8\u6bd4RISC-V\uff0c\u5e26MMU\u7684\u64cd\u4f5c\u7cfb\u7edf\u76f4\u63a5\u8fd0\u884c\u5728\u6700\u9ad8\u7279\u6743\u7ea7\uff0c\u4e0d\u9700\u8981\u4e86\u89e3SBI\u4ee5\u53caSupervisor\u7279\u6743\u7ea7\u7b49\u4e00\u7cfb\u5217\u5185\u5bb9\u3002","title":"LoongArch32\u62ff\u6765\u505a\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u6709\u4ec0\u4e48\u597d\u5904\uff1f"},{"location":"lab0/intro/#loongarch32x86armrisc-v","text":"\u5b83\u7684\u865a\u62df\u5185\u5b58\u7ba1\u7406\u91c7\u7528 \u8f6f\u4ef6\u63a7\u5236TLB \uff0c\u4e0eMIPS\u7c7b\u4f3c\uff0c\u5f53TLB\u67e5\u627e\u5931\u8d25\u6216TLB\u67e5\u627e\u6210\u529f\u4f46\u6709\u6548\u4f4d\u4e3a0\u65f6\uff0c\u4ea7\u751f\u5bf9\u5e94\u7684TLB\u5f02\u5e38\uff0c\u8df3\u8f6c\u5230\u5f02\u5e38\u5904\u7406\u5730\u5740\u8fdb\u884c\u5904\u7406\u3002 \u800cx86\u3001ARM\u3001RISC-V\u90fd\u662f\u91c7\u7528\u786c\u4ef6\u904d\u5386\u9875\u8868\u65b9\u5f0f\uff0c\u8f6f\u4ef6\u53ea\u9700\u8981\u5c06\u9875\u8868\u57fa\u5730\u5740\u901a\u8fc7\u4e00\u4e2aCSR\u544a\u77e5\u786c\u4ef6\uff08\u5982x86\u4e0a\u7684CR3\u3001RISC-V\u4e0a\u7684satp\uff09\uff0c\u786c\u4ef6\u5b8c\u6210TLB\u586b\u5145\u3002\u53ea\u6709\u5f53\u9875\u8868\u904d\u5386\u53d1\u73b0\u9875\u9762\u65e0\u6548\u65f6\u624d\u4ea7\u751f\u7f3a\u9875\u5f02\u5e38\uff0c\u8df3\u8f6c\u5230\u5f02\u5e38\u5904\u7406\u5730\u5740\u8fdb\u884c\u5904\u7406\u3002 \u56e0\u6b64\uff0c\u5728LoongArch32\u4e0eMIPS\u4e00\u6837 \u6ca1\u6709\u7f3a\u9875\u5f02\u5e38 \uff0c\u5176\u7f3a\u9875\u5f02\u5e38\u5305\u542b\u5728TLB\u5f02\u5e38\u4e2d\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u5224\u65ad\u662f\u5426\u662f\u7f3a\u9875\u3002 \u5728x86\u3001ARM\u3001RISC-V\u4e0a \u6ca1\u6709TLB\u5f02\u5e38 \u3002","title":"LoongArch32\u4e0ex86\u3001ARM\u3001RISC-V\u5728\u5185\u5b58\u7ba1\u7406\u4e0a\u7684\u533a\u522b"},{"location":"lab0/intro/#_4","text":"\u6211\u4eec\u4e5f\u8bb8\u77e5\u9053CPU\u4e0a\u6709\u4e00\u4e9b\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u751a\u81f3\u6709\u4e00\u4e9b\u540c\u5b66\u80fd\u975e\u5e38\u719f\u6089\u4ed6\u4eec\u7684\u540d\u5b57\uff0c\u4f8b\u5982x86-64\u4e0a\u7684RAX\u3001RSP\u3001RBP\u7b49\uff0cARM/MIPS/RISC-V\u4e0a\u768432\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c\u4ee5\u53ca\u5404\u81ea\u7684\u522b\u540d\uff0c\u5982a0\u3001a1\u3001sp\u3001ra\u7b49\u3002 \u4f46\u6211\u4eec\u7684CPU\u4e0a\uff0c\u8fd8\u6709\u4e00\u79cd\u7279\u6b8a\u7684\u5bc4\u5b58\u5668\uff0c\u5b83\u79f0\u4e3a\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668\uff08Control/Status Registers\uff0cCSR\uff09\uff0c\u5b83\u5bf9\u8ba1\u7b97\u673a\u7684\u7cfb\u7edf\u72b6\u6001\u4e0e\u63a7\u5236\u8fdb\u884c\u7ba1\u7406\u3002\u5e76\u901a\u8fc7CSR\u6307\u4ee4\u5bf9\u4ed6\u4eec\u8fdb\u884c\u8bfb\u5199\uff0c\u5728\u4fee\u6539\u540e\uff0c\u8ba1\u7b97\u673a\u7684\u8fd0\u884c\u72b6\u6001\u4e5f\u5c31\u968f\u4e4b\u6539\u53d8\u3002 \u4f8b\u5982\uff0c\u5728LoongArch32\u67b6\u6784\u4e2d\uff0c\u6709\u4e24\u79cd\u7279\u6743\u7ea7\uff0cPLV0\uff08\u4fd7\u79f0\u5185\u6838\u6001\uff09\u4e0ePLV3\uff08\u4fd7\u79f0\u7528\u6237\u6001\uff09\u3002\u7c7b\u4f3c\u4e8ex86\u67b6\u6784\u4e0a\u7684Ring0\u4e0eRing3\u3002\u4e5f\u7c7b\u4f3cARM\u4e0a\u7684EL0\u4e0eEL3\uff0c\u4ee5\u53caRISC-V\u67b6\u6784\u4e2d\u7684Machine\u4e0eUser\u3002 Note \u5c0f\u601d\u8003\uff1a\u64cd\u4f5c\u7cfb\u7edf\u4e00\u5b9a\u8fd0\u884c\u5728\u6700\u9ad8\u7279\u6743\u7ea7\u5417\uff1f\u5982\u679c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u4e0a\u8fd8\u6709\u4e00\u5c42\u7279\u6743\u7ea7\u4f1a\u5e26\u6765\u4ec0\u4e48\u597d\u5904\uff1f \u611f\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u4e86\u89e3RISC-V\u67b6\u6784\u4e2d\u7684Supervisor\u7279\u6743\u7ea7\u4ee5\u53ca\u5404\u4e2a\u6307\u4ee4\u96c6\u67b6\u6784\u7684\u865a\u62df\u5316\u673a\u5236\u3002 \u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u4f1a\u6d89\u53ca\u5230CSR\u7684 CRMD \u72b6\u6001\u4fee\u6539\u3001 DMW0 \u4e0e DMW1 \u7684\u914d\u7f6e\u3002\u5173\u4e8e\u8fd9\u91cc\u7684\u5bc4\u5b58\u5668\u5404\u4f4d\u57df\u7684\u5177\u4f53\u542b\u4e49\u4ee5\u53ca\u914d\u7f6e\u65b9\u5f0f\uff0c\u9700\u8981\u5927\u5bb6\u81ea\u884c\u9605\u8bfb \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u5b8c\u6210\u3002 Info \u8bf7\u5927\u5bb6\u81ea\u884c\u9605\u8bfb \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u4e2d\u7684P55, \u4e86\u89e3CRMD\u540e\uff0c\u518d\u7ee7\u7eed\u4e86\u89e3\u540e\u7eed\u5185\u5bb9\u3002 \u5173\u4e8eDMW\u5bc4\u5b58\u5668\u7684\u90e8\u5206\u53ef\u4ee5\u6682\u65f6\u8df3\u8fc7\uff0c\u6211\u4eec\u4f1a\u5728\u540e\u6587\u4e2d\u4ecb\u7ecd\uff0c\u53ef\u5c4a\u65f6\u518d\u56de\u8fc7\u5934\u6765\u770bDMW\u7684\u5bc4\u5b58\u5668\u3002","title":"\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668"},{"location":"lab0/intro/#io","text":"","title":"I/O\u4e0e\u5730\u5740\u7a7a\u95f4"},{"location":"lab0/intro/#io_1","text":"\u8bb8\u591a\u540c\u5b66\u4e5f\u8bb8\u4f1a\u597d\u5947\uff0c\u5f53\u6211\u4eec\u7684\u8ba1\u7b97\u673a\u8fde\u63a5\u4e0a\u4e00\u4e2a\u5916\u8bbe\u65f6\uff0c\u8ba1\u7b97\u673a\u662f\u600e\u4e48\u53d1\u73b0\u8fd9\u4e9b\u5916\u8bbe\u7684\u8fde\u63a5\uff1f\u5916\u8bbe\u4e0e\u6211\u4eec\u7684\u8ba1\u7b97\u673a\u662f\u600e\u4e48\u4ea4\u4e92\u7684\u5462\uff1f \u8fd9\u91cc\u5c31\u9700\u8981\u6d89\u53ca\u5230I/O\u7684\u6982\u5ff5\u3002 \u5728\u6211\u4eec\u7684\u8ba1\u7b97\u673a\u4e2d\uff0cI/O\u65b9\u5f0f\u901a\u5e38\u53ef\u5206\u4e3a3\u79cd\uff1a","title":"I/O\u7b80\u4ecb"},{"location":"lab0/intro/#pmio-port-mapped-io","text":"\u8fd9\u662f\u4e00\u79cd\u975e\u5e38\u7279\u6b8a\u7684I/O\uff0c\u5728LoongArch32\u3001RISC-V\u3001ARM\u3001MIPS\u4e2d \u5747\u4e0d\u5b58\u5728 \u3002 \u5728x86\uff08\u542bx86-64\uff09\u67b6\u6784\u4e2d\uff0c\u6709\u4e00\u4e2a\u4e0e\u5185\u5b58\u72ec\u7acb\u7684I/O\u5730\u5740\u7a7a\u95f4\uff0c\u4f7f\u7528 in[blw] \u4e0e out[blw] \u6307\u4ee4\uff0c\u5b8c\u6210I/O\u5730\u5740\u4e0eGPR\uff08\u901a\u7528\u5bc4\u5b58\u5668\uff09\u95f4\u7684\u6570\u636e\u79fb\u52a8\u3002","title":"PMIO (Port-Mapped I/O)"},{"location":"lab0/intro/#mmio-memory-mapped-io","text":"\u5185\u5b58\u6620\u5c04I/O\u5c31\u662f\u5c06I/O\u8bbe\u5907\u6620\u5c04\u5230\u7269\u7406\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u4e2d\uff0c\u50cf\u8bfb\u5199\u5185\u5b58\u4e00\u6837\u8bbf\u95eeI/O\u8bbe\u5907\u3002 \u8fd9\u79cd\u65b9\u5f0f\u5bf9\u4e8e\u8f6f\u4ef6\u800c\u8a00\u975e\u5e38\u65b9\u4fbf\uff0c\u4ec5\u9700\u8981\u7528\u4e00\u4e2a\u6307\u9488\u6307\u5411\u5bf9\u5e94\u7684MMIO\u8bbe\u5907\u4e0a\u7684\u5730\u5740\uff0c\u5e76\u4e86\u89e3\u8bfb\u5199MMIO\u8bbe\u5907\u5730\u5740\u7684\u5177\u4f53\u542b\u4e49\u5373\u53ef\u5b8c\u6210IO\u64cd\u4f5c\u3002 \u4f8b\u5982\u6211\u4eec\u5b9e\u9a8c\u4e2d\u6d89\u53ca\u5230\u7684UART\u4e32\u53e3\u5c31\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u8fdb\u884cIO\u4ea4\u4e92\u3002","title":"MMIO (Memory-Mapped I/O)"},{"location":"lab0/intro/#dma-direct-memory-access","text":"\u5c3d\u7ba1MMIO\u5f88\u65b9\u4fbf\uff0c\u4f46\u5b83\u7684\u6570\u636e\u642c\u8fd0\u9700\u8981CPU\u53c2\u4e0e\uff0c\u6548\u7387\u8f83\u4f4e\u3002 \u5bf9\u4e8e\u4e00\u6b21\u8bbf\u95ee\u5927\u91cf\u6570\u636e\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba9\u8bbe\u5907\u76f4\u63a5\u8bfb\u5199\u5185\u5b58\uff0c\u907f\u514d\u7ecf\u8fc7CPU\u5f71\u54cd\u6548\u7387\u3002 \u73b0\u5728\u8ba1\u7b97\u673a\u7684\u9ad8\u901fIO\uff0c\u4f8b\u5982\u7f51\u5361\u3001\u786c\u76d8\u63a7\u5236\u5668\u3001GPU\uff0c\u90fd\u4f7f\u7528DMA\u6280\u672f\u5c06\u6570\u636e\u7f13\u51b2\u533a\u76f4\u63a5\u653e\u7f6e\u4e8e\u5185\u5b58\uff0c\u907f\u514d\u5927\u91cf\u6570\u636e\u4f20\u8f93\u65f6\u9700\u8981\u5927\u91cfMMIO\u8bbf\u95ee\u3002 \u8fd9\u91cc\u9700\u8981\u63d0\u9192\u540c\u5b66\u4eec\u6ce8\u610f\u7684\u662f\uff0cDMA\u8bbf\u95ee\u901a\u5e38\u4e0e\u5176\u4ed6IO\u65b9\u5f0f\u4ee5\u53ca\u4e2d\u65ad\u914d\u5408\u4f7f\u7528\u3002\u5176\u4ed6IO\u65b9\u5f0f\u7528\u4e8e\u8fdb\u884cDMA\u4f20\u8f93\u7684\u63a7\u5236\uff0c\u4e2d\u65ad\u7528\u4e8e\u901a\u77e5DMA\u72b6\u6001\u6539\u53d8\uff0c\u4f8b\u5982\u6709\u65b0\u6570\u636e\u5df2\u7ecf\u5b8c\u6210\u5199\u5165\u5185\u5b58\u6216\u8005\u7f13\u51b2\u533a\u5df2\u7ecf\u53d1\u5230\u5bf9\u5e94\u7684\u8bbe\u5907\u3002 Note \u5c0f\u601d\u8003\uff1a \u5982\u679cCPU\u6709Cache\uff0c\u5bf9\u5916\u8bbe\u7684MMIO\u8bbf\u95ee\u80fd\u4e0d\u80fd\u7ecf\u8fc7Cache\u5462\uff1f\u4e3a\u4ec0\u4e48\uff1f \u5982\u679cCPU\u4e3a\u4e71\u5e8f\u591a\u53d1\u5c04\u67b6\u6784\uff0c\u5bf9\u5916\u8bbe\u7684MMIO\u8bbf\u95ee\u80fd\u5426\u4e71\u5e8f\u53d1\u51fa\u5462\uff1f \u9664\u4e86\u63d2\u5165\u5185\u5b58\u5c4f\u969c\u6307\u4ee4\u5916\uff0c\u5404\u4e2a\u6307\u4ee4\u96c6\u67b6\u6784\u8fd8\u63d0\u4f9b\u4e86\u4ec0\u4e48\u914d\u7f6e\u4f7f\u5f97\u4f7f\u7528\u865a\u62df\u5730\u5740\u8fdb\u884cMMIO\u8bbf\u95ee\u65f6CPU\u4e00\u5b9a\u80fd\u786e\u4fdd\u987a\u5e8f\u6267\u884c\uff1f \u5982\u679cCPU\u6709Cache\uff0cDMA\u64cd\u4f5c\u4e0d\u7ecf\u8fc7Cache\u76f4\u63a5\u8bfb\u5199\u5185\u5b58\u4ea7\u751f\u4e86Cache\u7684\u6570\u636e\u4e0e\u5185\u5b58\u4e0d\u4e00\u81f4\u600e\u4e48\u529e\uff1f\u652f\u6301DMA\u4e00\u81f4\u6027\u7684CPU\u4e0e\u4e0d\u652f\u6301DMA\u4e00\u81f4\u6027\u7684CPU\u5206\u522b\u600e\u4e48\u505a\uff1f \u5728C\u8bed\u8a00\u4e2d\u5b8c\u6210MMIO\u8bbf\u95ee\u65f6\uff0c\u4e3a\u4ec0\u4e48\u901a\u5e38\u4f1a\u5bf9\u6307\u5411\u8981\u8bbf\u95ee\u7684\u6570\u636e\u7684\u6307\u9488\u52a0\u4e0a volatile \u5173\u952e\u5b57\uff0c\u5b83\u4f1a\u5982\u4f55\u5f71\u54cd\u7f16\u8bd1\u5668\u884c\u4e3a\uff1f\uff08\u540c\u5b66\u4eec\u53ef\u4ee5\u8bd5\u8bd5\u770b\u7b80\u5355\u5199\u4e00\u4e2a\u8fde\u7eed\u8fdb\u884cMMIO\u8bbf\u95ee\u7684\u88f8\u673a\u7a0b\u5e8f\uff0c\u5e76\u5728\u7f16\u8bd1\u65f6\u5f00\u542fO2\u4f18\u5316\uff0c\u89c2\u5bdf\u751f\u6210\u6c47\u7f16\u7684\u53d8\u5316\u3002\uff09 \u65e2\u7136\u8bbf\u95ee\u7684\u6570\u636e\u7ec8\u7a76\u662f\u8981\u88ab\u4f7f\u7528\u7684\uff0c\u90a3\u4e48\u5747\u644a\u65f6\u95f4\u6765\u8bf4DMA\u7684\u4f18\u52bf\u5728\u54ea\u91cc\u5462\uff1f\uff08\u63d0\u793a\uff1a\u53ef\u4ee5\u4e86\u89e3\u5355\u6b21Uncached\u8bbf\u95ee\u5ef6\u8fdf\uff0c\u4ee5\u53ca\u540e\u7eed\u4f53\u7cfb\u67b6\u6784\u8bfeCache\u5b9e\u9a8c\u4e2d\u7684\u603b\u7ebf\u7a81\u53d1\u4f20\u8f93\uff0cSIMD\u6307\u4ee4\uff0c\u8f6f\u4ef6\u4e0a\u5bf9\u6570\u636e\u7684\u96f6\u62f7\u8d1d\u5904\u7406\uff0c\u6216\u8bb8\u80fd\u591f\u89e3\u7b54\u540c\u5b66\u4eec\u7684\u7591\u60d1\u3002\uff09","title":"DMA  (Direct Memory Access)"},{"location":"lab0/intro/#_5","text":"","title":"\u64cd\u4f5c\u7cfb\u7edf\u5982\u4f55\u77e5\u9053\u8fd9\u53f0\u8ba1\u7b97\u673a\u4e0a\u6709\u54ea\u4e9b\u8bbe\u5907\uff1f"},{"location":"lab0/intro/#e820acpi","text":"\u5728x86\u8ba1\u7b97\u673a\u4e2d\uff0cBIOS\u63d0\u4f9b\u4e86\u4e00\u4e2ae820\u5185\u5b58\u7ba1\u7406\u5668\uff0c\u5e76\u901a\u8fc7\u4e2d\u65ad\u6307\u4ee4\uff08x86\u4e0a\u7684int\uff09\u8c03\u7528BIOS\u5b8c\u6210\u7269\u7406\u5185\u5b58\u5730\u5740\u7684\u63a2\u6d4b\u3002 \u6709\u5728x86\u8ba1\u7b97\u673a\u4e0a\u4f7f\u7528Linux\u7684\u540c\u5b66\u4eec\uff0c\u53ef\u4ee5\u901a\u8fc7dmesg\u547d\u4ee4\u67e5\u770b\u5185\u6838\u7684\u8f93\u51fa\uff0c\u5728\u5185\u6838\u542f\u52a8\u65f6\u53ef\u4ee5\u627e\u5230BIOS\u63d0\u4f9b\u7684e820\u5185\u5b58\u6620\u5c04\u8868\uff0c\u4e14\u5982\u679c\u540c\u5b66\u4eec\u7684\u8ba1\u7b97\u673a\u91c7\u7528\u6838\u5fc3\u663e\u5361\uff0c\u5f80\u5f80\u4f1a\u770b\u5230\u6570\u767e\u5146\u751a\u81f3\u6570GB\u7684\u5185\u5b58\u5e26\u4e0a\u4e86reserved\u6807\u8bb0\uff0c\u8fd9\u662f\u56e0\u4e3a\u6838\u5fc3\u663e\u5361\u4f1a\u5360\u7528\u4e00\u90e8\u5206\u5185\u5b58\u3002\u4f46\u8fd9\u91cc\u8fd8\u8981\u63d0\u9192\u540c\u5b66\u4eec\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u865a\u62df\u673a\u7684\u8bdd\uff0c\u770b\u7684\u5c31\u662f\u4f60\u865a\u62df\u673a\u7684e820\u800c\u4e0d\u662f\u771f\u5b9e\u8ba1\u7b97\u673aBIOS\u6c47\u62a5\u7684e820\u4e86\u3002 ACPI\uff08Advanced Configuration and Power Interface\uff09\u662f\u4e0a\u4e2a\u4e16\u7eaa90\u5e74\u4ee3\u4ea7\u751f\u7684\u4e00\u79cd\u5f00\u653e\u6807\u51c6\uff0c\u5b83\u5b9a\u4e49\u4e86\u7cfb\u7edf\u56fa\u4ef6\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u95f4\u7684\u786c\u4ef6\u62bd\u8c61\u63a5\u53e3\u3002x86\u8ba1\u7b97\u673a\u4e0a\u7684\u64cd\u4f5c\u7cfb\u7edf\u5c31\u53ef\u4ee5\u5229\u7528ACPI\u5bf9\u56fa\u4ef6\u51fd\u6570\u8fdb\u884c\u8c03\u7528\uff0c\u83b7\u53d6\u7cfb\u7edf\u4e0a\u7684\u5185\u5b58\u5e03\u5c40\u3001\u5404\u8bbe\u5907\u6240\u5904\u7684\u4f4d\u7f6e\u548c\u8bbe\u5907\u578b\u53f7\u7b49\uff0c\u5c31\u5b9e\u73b0\u4e86\u540c\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u80fd\u591f\u517c\u5bb9\u591a\u79cd\u4e0d\u540c\u7684\u8ba1\u7b97\u673a\u3002","title":"e820\u4e0eACPI"},{"location":"lab0/intro/#_6","text":"\u81ea\u5df1\u7ed9\u4e00\u4e9b\u5d4c\u5165\u5f0f\u5f00\u53d1\u677f\u7f16\u8bd1\u8fc7\u7cfb\u7edf\u8f6f\u4ef6\u7684\u540c\u5b66\u4e00\u5b9a\u5bf9\u8bbe\u5907\u6811\u4e0d\u964c\u751f\u3002 \u5728\u8fd9\u4e9b\u6ca1\u6709ACPI\u673a\u5236\u7684\u5e73\u53f0\u4e0a\uff0c\u901a\u5e38\u91c7\u7528\u4e00\u79cd\u53eb\u505a\u8bbe\u5907\u6811\u7684\u811a\u672c\u6765\u63cf\u8ff0\u8ba1\u7b97\u673a\u786c\u4ef6\u4e0a\u5404\u4e2a\u8bbe\u5907\u3002\u8be5\u8bbe\u5907\u6811\u901a\u5e38\u4f1a\u653e\u7f6e\u4e8eBootloader\u4e2d\u901a\u8fc7\u53c2\u6570\u4f20\u9012\u7ed9\u7cfb\u7edf\u5185\u6838\uff0c\u4e5f\u53ef\u80fd\u76f4\u63a5\u5185\u5d4c\u4e0e\u7cfb\u7edf\u5185\u6838\u4e2d\uff0c\u60f3\u8981\u77e5\u9053\u8bbe\u5907\u6811\u662f\u4e2a\u4ec0\u4e48\u6587\u4ef6\u7684\u540c\u5b66\u53ef\u4ee5\u7ffb\u770bLinux\u5185\u6838\u6e90\u4ee3\u7801\u7684 arch/*/boot/dts \u6587\u4ef6\u5939\u3002 \u800c\u5bf9\u4e8e\u4e00\u4e9b\u5373\u63d2\u5373\u7528\u7684\u8bbe\u5907\uff0c\u4f8b\u5982USB\u4e0ePCI-E\uff0c\u8bbe\u5907\u6811\u901a\u5e38\u4ec5\u63d0\u4f9b\u5176\u63a7\u5236\u5668\u672c\u8eab\u7684\u63cf\u8ff0\uff0c\u8fd9\u4e9b\u5373\u63d2\u5373\u7528\u8bbe\u5907\u7684\u5177\u4f53\u63a2\u6d4b\u4ea4\u7ed9\u63a7\u5236\u5668\u9a71\u52a8\u6765\u5b8c\u6210\u3002","title":"\u8bbe\u5907\u6811"},{"location":"lab0/intro/#_7","text":"\u5728LoongArch32\u7684uCore\u79fb\u690d\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5316\u64cd\u4f5c\u7cfb\u7edf\uff0c\u6211\u4eec\u6ca1\u6709\u4f7f\u7528\u4efb\u4f55\u8bbe\u5907\u63a2\u6d4b\u7684\u65b9\u6cd5\u3002\u6bd5\u7adf\u6ca1\u6709ACPI\uff0c\u4e5f\u6ca1\u6709Bootloader\u4f20\u9012\u8bbe\u5907\u6811\uff0c\u5373\u4f7f\u6709\u4f20\u9012\u8bbe\u5907\u6811\u4e5f\u9700\u8981\u4e00\u90e8\u5206\u89e3\u6790\u8bbe\u5907\u6811\u7684\u4ee3\u7801\uff0c\u4f1a\u589e\u52a0\u7cfb\u7edf\u7684\u590d\u6742\u7a0b\u5ea6\u3002 \u5bf9\u4e8e\u5185\u5b58\u5927\u5c0f\uff0c\u7531\u4e8eLoongArch32\u4e0b\u53ef\u7528\u7269\u7406\u5185\u5b58\u8303\u56f4\u662f\u4ece0\u5f00\u59cb\u8fde\u7eed\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u8bbe\u5b9a\u4e00\u4e2a\u56fa\u5b9a\u503c32M\uff0c\u76f4\u63a5\u4f7f\u7528\u5373\u53ef\u3002 \u800c\u5bf9\u4e8eIO\u5916\u8bbe\uff0c\u5728uCore\u4e2d\u4ec5\u4f7f\u7528\u4e32\u53e3\uff0c\u4e14\u5b83\u7684MMIO\u5730\u5740\u4ee5\u53ca\u4e2d\u65ad\u670d\u52a1\u53f7\u5728\u6211\u4eec\u4f7f\u7528\u7684QEMU\u4e0eChiplab FPGA\u8f6f\u6838SoC\u73af\u5883\u4e2d\u90fd\u662f\u56fa\u5b9a\u7684\uff0c\u56e0\u6b64\u4e5f\u5c06\u8be5\u5730\u5740\u56fa\u5b9a\u4e86\uff0c\u76f4\u63a5\u4f7f\u7528\u5373\u53ef\u3002","title":"\u8fd8\u53ef\u4ee5\u9009\u62e9\u4e0d\u63a2\u6d4b"},{"location":"lab0/intro/#_8","text":"LoongArch32\u7684\u865a\u62df\u5730\u5740\u6620\u5c04\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u4e00\u79cd\u662fDMW\uff0c\u4e00\u79cd\u662fTLB\u3002DMW\u7684\u67e5\u627e\u4f18\u5148\u4e8eTLB\u7684\u67e5\u627e\uff0c\u5f53\u4e24\u8005\u5747\u67e5\u627e\u5931\u8d25\u65f6\u4ea7\u751fTLB REFILL\u4f8b\u5916\uff08\u5f02\u5e38\uff09\u3002","title":"\u865a\u62df\u5730\u5740\u7ba1\u7406"},{"location":"lab0/intro/#dmw","text":"LoongArch32\u6709\u4e00\u79cd\u7279\u6b8a\u7684\u865a\u62df\u5730\u5740\u6620\u5c04\u65b9\u5f0f\uff0c\u79f0\u4e3a\u76f4\u63a5\u6620\u5c04\u914d\u7f6e\u7a97\u53e3\uff08DMW\uff09\u3002\u5b83\u53ef\u4ee5\u63d0\u4f9b\u865a\u62df\u5730\u5740 [31:29] \u90e8\u5206\u5230\u7269\u7406\u5730\u5740 [31:29] \u7684\u6620\u5c04\u914d\u7f6e\u3002\u5e76\u53ef\u4ee5\u5728\u5730\u5740\u6620\u5c04\u7a97\u53e3\u4e2d\u8bbe\u7f6e\u5141\u8bb8\u8bbf\u95ee\u8be5\u7a97\u53e3\u7684\u7279\u6743\u7ea7\u4ee5\u53caCache\u5c5e\u6027\u3002 \u8be6\u7ec6\u4fe1\u606f\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u4e2d\u7684P43\u3002","title":"DMW"},{"location":"lab0/intro/#tlb","text":"\u5927\u5bb6\u5e94\u8be5\u5728\u8ba1\u7b97\u673a\u7ec4\u6210\u539f\u7406\u8bfe\u7a0b\u65f6\u5df2\u7ecf\u5bf9TLB\u6709\u4e00\u4e2a\u521d\u6b65\u7684\u4e86\u89e3\uff0c\u5b83\u662f\u4e00\u4e2a\u865a\u62df\u5730\u5740\u7ffb\u8bd1\u7684\u7f13\u51b2\u533a\uff0c\u50a8\u5b58\u4e86\u6700\u8fd1\u4f7f\u7528\u7684\u4e00\u90e8\u5206\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u5e76\u8bb0\u5f55\u4e86\u5bf9\u5e94\u865a\u62df\u9875\u9762\u7684\u5143\u6570\u636e\uff0c\u4f8b\u5982\u6743\u9650\u914d\u7f6e\u4e0eCache\u5c5e\u6027\u7b49\u3002 \u4e5f\u8bb8\u6709\u7684\u540c\u5b66\u4f1a\u60f3\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981TLB\u800c\u4e0d\u662f\u6bcf\u6b21\u8bbf\u95ee\u9875\u8868\u52a0\u4e0aPage Table Cache\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u591a\u7ea7\u683c\u5f0f\u904d\u5386\u65f6\u9700\u8981\u9010\u5c42\u8bbf\u95ee\u591a\u4e2a\u5730\u5740\u5e76\u4e0d\u9002\u5408\u5904\u7406\u5668\u5355\u4e2a\u5468\u671f\u8bbf\u95ee\uff0c\u56e0\u4e3a\u786c\u4ef6\u4e0a\u5c06\u9875\u8868\u904d\u5386\u7684\u7ed3\u679c\u653e\u5728\u4e00\u4e2a\u7f13\u51b2\u533a\u4e2d\uff0c\u8fd9\u4e2a\u7f13\u51b2\u533a\u5c31\u662fTLB\u3002 \u4e0d\u540c\u4e8ex86\u3001ARM\u3001RISC-V\u7b49\u67b6\u6784\uff0c\u7531\u786c\u4ef6\u904d\u5386\u9875\u8868\u586b\u5145TLB\uff0c\u5e76\u63d0\u4f9b\u9875\u8868\u57fa\u5730\u5740\u7b49\u5bc4\u5b58\u5668\u7531\u8f6f\u4ef6\u914d\u7f6e\u5f53\u524d\u5904\u7406\u5668\u904d\u5386\u7684\u9875\u8868\u3002LoongArch32\u91c7\u7528\u4e86\u4e0eMIPS\u76f8\u540c\u7684\u8f6f\u4ef6\u63a7\u5236TLB\u7684\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u8be6\u7ec6\u4fe1\u606f\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u4e2d\u7684P55\u3002 \u672c\u6b21\u5b9e\u9a8c\u4e2d\u6682\u4e0d\u6d89\u53caTLB\uff0c\u5927\u5bb6\u53ea\u9700\u8981\u4e86\u89e3\u5b83\u7684\u5b58\u5728\u5373\u53ef\u3002","title":"TLB"},{"location":"lab0/intro/#dmw_1","text":"\u5bf9\u4e8e\u5927\u591a\u6570\u6307\u4ee4\u96c6\u67b6\u6784\u800c\u8a00\uff08\u6211\u4eec\u719f\u6089\u7684MIPS\u662f\u4e2a\u6709\u56fa\u5b9a\u865a\u62df\u5730\u5740\u6620\u5c04\u7684\u7279\u4f8b\uff09\uff0c\u5728\u8ba1\u7b97\u673a\u4e0a\u7535\u542f\u52a8\u65f6\uff0c\u8f6f\u4ef6\u8fd0\u884c\u5728\u7269\u7406\u5730\u5740\u7a7a\u95f4\u4e2d\u3002\u771f\u5b9e\u786c\u4ef6\u4e0a\u901a\u5e38\u4f1a\u5728\u4e0a\u7535\u542f\u52a8\u65f6\u4ece\u7b2c\u4e00\u7ea7Bootloader\u5f00\u59cb\u6267\u884c\u5b8c\u6210\u7cfb\u7edf\u7684\u521d\u59cb\u5316\uff0c\u518d\u9010\u7ea7\u8f7d\u5165\u66f4\u9ad8\u7ea7\u7684Bootloader\u4ee5\u81f3\u4e8e\u6700\u540e\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\u3002\u800c\u5177\u4f53\u4ece\u54ea\u4e00\u7ea7\u5f00\u59cb\u4f7f\u7528\u865a\u62df\u5730\u5740\u53d6\u51b3\u4e8e\u5404\u67b6\u6784\u4ee5\u53ca\u7cfb\u7edf\u8f6f\u4ef6\u3002\u5bf9\u4e8e\u6211\u4eec\u672c\u6b21\u5b9e\u9a8c\u4f7f\u7528\u7684LoongArch32\u67b6\u6784\u800c\u8a00\uff0c\u5728QEMU\u4e0a\u8fd0\u884c\u65f6\u662f\u5728uCore\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u65f6\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u914d\u7f6eDMW\u7a97\u53e3\u5e76\u4fee\u6539CSR.CRMD\u5bc4\u5b58\u5668\u5f00\u59cb\u5f00\u542f\u865a\u62df\u5730\u5740\u6620\u5c04\u7684\u3002\u800c\u5982\u679c\u662f\u4f7f\u7528Chiplab\u8f6f\u6838\uff0c\u5b83\u7684\u7b2c\u4e00\u7ea7Bootloader\u662fPMON\uff0c\u5728PMON\u4e2d\u5c31\u4f1a\u8bbe\u7f6eDMW\u5e76\u5f00\u542f\u865a\u62df\u5730\u5740\u6620\u5c04\u3002 \u5728uCore\u4e2d\uff0c\u4f1a\u914d\u7f6e\u4e24\u4e2aDMW\u7a97\u53e3\uff0c\u5206\u522b\u7528\u4e8e\u5185\u6838\u666e\u901a\u7684DRAM\u8bbf\u95ee\u4e0eIO\u5916\u8bbe\u8bbf\u95ee\uff0c\u5982\u4e0b\uff1a DMW\u7f16\u53f7 MAT\uff08\u5b58\u50a8\u8bbf\u95ee\u7c7b\u578b\uff09 PLV0 PLV3 PSEG VSEG VSEG\u8303\u56f4 DMW0 1\uff08\u4e00\u81f4\u53ef\u7f13\u5b58\uff09 1 0 0b000 (0x00000000-0x1fffffff) 0b101 0xa0000000-0xbfffffff DMW1 0\uff08\u5f3a\u5e8f\u975e\u7f13\u5b58\uff09 1 0 0b000 (0x00000000-0x1fffffff) 0b100 0x80000000-0x9fffffff \u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u662f\u4eceQEMU\u6a21\u62df\u5668\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\uff0cDMW\u6211\u4eec\u53ef\u4ee5\u81ea\u5b9a\u4e49\uff0c\u4f46\u5982\u679c\u662f\u4eceChiplab\u7684FPGA\u8f6f\u6838\u4e0a\u4f7f\u7528PMON\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\uff0c\u7531\u4e8ePMON\u672c\u8eab\u5df2\u7ecf\u8fdb\u884cDMW\u7684\u914d\u7f6e\u5e76\u8fd0\u884c\u5728\u865a\u62df\u5730\u5740\uff0c\u56e0\u6b64\u6211\u4eec\u7684DMW\u914d\u7f6e\u5fc5\u987b\u4e0ePMON\u4e00\u81f4\u624d\u80fd\u4fdd\u8bc1\u7cfb\u7edf\u6b63\u5e38\u542f\u52a8\u3002 \u7279\u522b\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cLoongArch32\u7684QEMU\u6709\u4e00\u4e2a\u7279\u70b9\u662f\u5b83\u4f1a\u5728\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u4e0b\u53bb\u9664\u7269\u7406\u5730\u5740\u7684\u9ad83\u4f4d\uff0c\u4ee5\u786e\u4fdd\u6ca1\u6709\u914d\u7f6eDMW\u65f6\u80fd\u591f\u6b63\u786e\u542f\u52a8\u7cfb\u7edf\u8f6f\u4ef6\uff0c\u4f46\u771f\u5b9e\u7684LoongArch32\u786c\u4ef6\uff08\u5982Chiplab\u8f6f\u6838\uff09\u4e0d\u4f1a\u8fd9\u4e48\u505a\u3002\u56e0\u6b64\u5927\u5bb6\u5728\u7f16\u5199\u7cfb\u7edf\u8f6f\u4ef6\u7684\u65f6\u5019\u9700\u8981\u6ce8\u610f\u8fd9\u4e2a\u7279\u5f81\uff0c\u7f16\u5199\u90a3\u4e9b\u8fd0\u884c\u5728\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u7684\u4ee3\u7801\u65f6\u9700\u8981\u786e\u4fdd\u53d6\u6307\u5730\u5740\u548c\u8bbf\u5b58\u5730\u5740\u5747\u4e3a\u7269\u7406\u5730\u5740\uff0c\u82e5\u65e0\u6cd5\u4fdd\u8bc1\u5219\u53ef\u4ee5\u505a\u4e00\u5c42\u8df3\u8f6c\uff08\u53c2\u8003uCore\u5904\u7406TLBREFILL\u7684\u4ee3\u7801\uff09\uff0c\u5207\u6362\u4e3a\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u518d\u8fdb\u884c\u4e0b\u4e00\u6b65\u64cd\u4f5c\uff0c\u9632\u6b62\u7f16\u5199\u7684\u64cd\u4f5c\u7cfb\u7edf\u5728QEMU\u4e0a\u80fd\u8fd0\u884c\u4f46\u65e0\u6cd5\u5728\u771f\u5b9e\u786c\u4ef6\u4e0a\u8fd0\u884c\u3002","title":"\u5982\u4f55\u914d\u7f6eDMW\uff1f"},{"location":"lab0/intro/#qemu","text":"QEMU\u662f\u4e00\u6b3e\u6a21\u62df\u5668\uff08\u865a\u62df\u673a\uff09\uff0c\u652f\u6301\u591a\u79cd\u6307\u4ee4\u96c6\u67b6\u6784\u3002\u6211\u4eec\u5b9e\u9a8c\u4e2d\u4f7f\u7528\u7684\u662fLoongArch32\u67b6\u6784\u7684QEMU\u3002","title":"QEMU\u7b80\u4ecb"},{"location":"lab0/setup/","text":"\u51c6\u5907\u5de5\u4f5c \u00b6 \u73af\u5883\u51c6\u5907\uff1ax86-64\u67b6\u6784\u7684Docker\u8fd0\u884c\u73af\u5883\u3002 \u56e0\u4e3aLoongArch32\u7684\u73af\u5883\u914d\u7f6e\u6bd4\u8f83\u590d\u6742\uff0c\u5c24\u5176\u662f\u5b83\u7684QEMU\u9700\u8981\u8865\u5145\u5927\u91cf\u4f9d\u8d56\uff0c\u56e0\u6b64\u52a9\u6559\u4e3a\u4e86\u8282\u7701\u540c\u5b66\u4eec\u7684\u5de5\u4f5c\u91cf\u6253\u5305\u4e86\u4e00\u4e2aDocker\u955c\u50cf\uff0c\u5b83\u5c01\u88c5\u4e86\u6240\u6709\u8fd0\u884c\u6211\u4eec\u7684uCore\u5b9e\u9a8c\u6240\u9700\u7684\u73af\u5883\uff0c \u5e76\u5df2\u53d1\u5e03\u5230Docker Hub(\u9700\u4f7f\u7528VPN\u540e\u8bbf\u95ee) \uff0c\u540c\u65f6\u8be5\u955c\u50cf\u4e5f\u5df2\u4e0a\u4f20\u81f3\u963f\u91cc\u4e91\uff0c\u4e0b\u8f7d\u65b9\u6cd5 \u5728\u6b64 . \u8fd9\u91cc\u63a8\u8350\u4f7f\u7528Windows\u7684\u540c\u5b66\u4f7f\u7528WSL2\u6216Linux\u865a\u62df\u673a\u5b89\u88c5Docker\uff0c\u4f7f\u7528Linux\u7684\u540c\u5b66\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff0c\u4f7f\u7528macOS\uff08\u542bApple Silicon\uff09\u7684\u540c\u5b66\u4f7f\u7528Linux\u865a\u62df\u673a\u5b89\u88c5Docker\u3002 \u5e38\u89c1Linux\u53d1\u884c\u7248\u5b89\u88c5Docker\u65b9\u6cd5\u53ef\u53c2\u8003 \u6e05\u534e\u955c\u50cf\u7ad9\u4e0a\u7684\u6559\u7a0b \u3002 Note \u4f7f\u7528WSL2+Ubuntu 22.04\u7684\u540c\u5b66\u8bf7\u6ce8\u610f\uff1a \u5982\u679c\u9047\u5230Docker Daemon\u6ca1\u6709\u542f\u52a8\uff0c\u4e5f\u8bb8\u662fiptables-legacy\u6ca1\u6709\u5b89\u88c5\uff0c\u53ef\u4ee5\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u89e3\u51b3\uff1a sudo apt install iptables sudo update-alternatives --set iptables /usr/sbin/iptables-legacy sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy sudo service docker start \u53e6\u5916\uff0cWSL1\u4e0d\u652f\u6301Docker\uff0c\u6ca1\u6709\u6761\u4ef6\u5b89\u88c5WSL2\u7684\u540c\u5b66\u5efa\u8bae\u4f7f\u7528\u865a\u62df\u673a\u3002 \u5bf9\u4e8e\u4f7f\u7528\u7684\u7535\u8111\u975ex86-64\u67b6\u6784\u7684\u540c\u5b66 \u00b6 \u5982\u679c\u540c\u5b66\u4eec\u4f7f\u7528\u975ex86-64\u67b6\u6784\u7684\u8ba1\u7b97\u673a\u8fdb\u884c\u5b9e\u9a8c\uff0c\u4f8b\u5982\u4f7f\u7528ARM\u67b6\u6784\u7684Apple Silicon\u7684Mac\u751a\u81f3\u662f\u6811\u8393\u6d3e\uff0c\u53ef\u4ee5\u4f7f\u7528\u865a\u62df\u673a\u5b89\u88c5\u4e00\u4e2a\u81ea\u5df1\u6307\u4ee4\u96c6\u67b6\u6784\u7684Linux\u53d1\u884c\u7248\uff08\u5bf9\u4e8eARM\u63a8\u8350Debian\uff0c\u4f5c\u4e3aUbuntu\u7684\u4e0a\u6e38\u8f6f\u4ef6\u652f\u6301\u8f83\u4e30\u5bcc\uff09\uff0c\u7136\u540e\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5qemu-user\u6a21\u62dfx86-64\u73af\u5883\uff0c\u5c31\u53ef\u4ee5\u5728Linux\u4e2d\u8fd0\u884cx86\u67b6\u6784\u7684\u4e8c\u8fdb\u5236\u7a0b\u5e8f\u4e86\uff1a sudo apt install qemu-user qemu-user-static binfmt-support gcc-x86-64-linux-gnu binutils-x86-64-linux-gnu binutils-x86-64-linux-gnu-dbg build-essential \u4e4b\u540e\u7684\u64cd\u4f5c\u4e0ex86-64\u7684Linux\u5b8c\u5168\u76f8\u540c\u3002 \u914d\u7f6eDocker\uff08\u53ef\u9009\uff09 \u00b6 \u914d\u7f6e\u955c\u50cf\u7ad9 \u5bf9\u4e8e\u8bb8\u591a\u540c\u5b66\u7684\u7f51\u7edc\u73af\u5883\u800c\u8a00\u53ef\u80fd\u4eceDocker Hub\u5b98\u65b9\u4e0b\u8f7d\u8f83\u6162\uff0c\u8fd9\u91cc\u63a8\u8350\u5c06Docker Hub\u6539\u4e3a\u5357\u4eac\u5927\u5b66\u955c\u50cf\u7ad9\uff08\u76ee\u524d\u6559\u80b2\u7f51\u5185\u552f\u4e00Docker Hub\u955c\u50cf\uff09\uff0c \u914d\u7f6e\u65b9\u6cd5\u5728\u6b64 . \u914d\u7f6eDocker\u7ec4\u7684\u7528\u6237\u6743\u9650 \u5982\u679c\u540c\u5b66\u4eec\u60f3\u8981\u5728Linux\u4e2d\u4e0d\u901a\u8fc7root\u7528\u6237\uff08sudo\uff09\u5c31\u80fd\u76f4\u63a5\u8bbf\u95eeDocker\uff0c\u4ee5\u53ca\u5728\u8fd0\u884c\u4e8e\u7528\u6237\u6743\u9650\u7684VSCode\u4e2d\u76f4\u63a5\u4f7f\u7528Docker\uff0c\u53ef\u4ee5\u5c06\u81ea\u5df1\u7684\u7528\u6237\u52a0\u5165Docker\u521b\u5efa\u7684\u7ec4\u4e2d\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a sudo usermod -aG docker $USER newgrp docker \u4e4b\u540e\u91cd\u542f\u7535\u8111\u5373\u53ef\u5168\u5c40\u751f\u6548\uff0c\u5426\u5219\u6bcf\u6b21\u6253\u5f00\u7ec8\u7aef\u9700\u8981\u4f7f\u7528 newgrp docker \u624d\u80fd\u4f7f\u6743\u9650\u751f\u6548\u3002 \u4e0b\u8f7dDocker\u955c\u50cf\u5e76\u521b\u5efa\u5b9e\u9a8c\u73af\u5883\u5bb9\u5668 \u00b6 \u4e0b\u8f7d chenyy/la32r-env \u955c\u50cf\uff1a \u5728\u7ec8\u7aef\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a docker pull chenyy/la32r-env \u57fa\u4e8e chenyy/la32r-env \u521b\u5efa la32r-docker \u5bb9\u5668 docker run -dit \\ --name la32r-docker \\ --user = $( id -u $USER ) : $( id -g $USER ) \\ --net = host \\ --workdir = \"/home/ $USER \" \\ --volume = \"/home:/home\" \\ --volume = \"/root:/root\" \\ --volume = \"/mnt:/mnt\" \\ --volume = \"/etc/group:/etc/group:ro\" \\ --volume = \"/etc/passwd:/etc/passwd:ro\" \\ --volume = \"/etc/shadow:/etc/shadow:ro\" \\ --volume = \"/etc/sudoers.d:/etc/sudoers.d:ro\" \\ -e LANG = en_US.UTF-8 \\ -e LANGUAGE = en_US.UTF-8 \\ -e LC_ALL = en_US.UTF-8 \\ chenyy/la32r-env \u8fd9\u91cc\u6211\u4eec\u5bf9Docker\u8fdb\u884c\u4e86\u4e00\u4e9b\u914d\u7f6e\uff0c\u7b80\u5355\u8bf4\u5c31\u662f\u5c06\u6574\u4e2a/home\u76ee\u5f55\u5728\u4e3b\u673a\u4e0eDocker\u5bb9\u5668\u4e4b\u95f4\u5171\u4eab\uff0c\u4ece\u800cDocker\u80fd\u591f\u76f4\u63a5\u8bbf\u95ee\u7528\u6237\u6587\u4ef6\u3002\u540c\u65f6\u5c06\u7528\u6237\u4e0e\u7ec4\u6743\u9650\u8fdb\u884c\u540c\u6b65\uff0c\u65b9\u4fbf\u5728Docker\u4e2d\u76f4\u63a5\u8bbf\u95ee\u5bf9\u5e94\u7684\u6587\u4ef6\u3002 \u542f\u52a8 la32r-docker \u5bb9\u5668 docker start la32r-docker \u8fdb\u5165 la32r-docker \u7684Shell docker exec -it la32r-docker /bin/zsh \u914d\u7f6eVSCode\uff08\u53ef\u9009\uff09 \u00b6 \u540c\u5b66\u4eec\u53ef\u4ee5\u5728VSCode\u7684\u63d2\u4ef6\u4e2d\u641c\u7d22Docker\uff0c\u5e76\u901a\u8fc7\u8be5\u63d2\u4ef6\u8fde\u63a5\u5230\u5bb9\u5668\u4e2d\u5b8c\u6210\u64cd\u4f5c\u3002 \u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728VSCode\u7684\u63d2\u4ef6\u4e2d\u627e\u5230\u5bf9\u5e94Docker\uff0c\u53ef\u4ee5\u8fdb\u884cAttach Shell\u6216Attch VSCode\u3002\u65b9\u4fbf\u6211\u4eec\u540e\u7eed\u5728Host\u7aef\u7684VSCode\u5b8c\u6210\u4ee3\u7801\u7f16\u5199\uff0c\u5e76\u5728Docker\u4e2d\u4f7f\u7528\u5bf9\u5e94\u73af\u5883\u5b8c\u6210\u7f16\u8bd1\u4e0e\u8c03\u8bd5\u3002","title":"\u642d\u5efa\u5b9e\u9a8c\u73af\u5883"},{"location":"lab0/setup/#_1","text":"\u73af\u5883\u51c6\u5907\uff1ax86-64\u67b6\u6784\u7684Docker\u8fd0\u884c\u73af\u5883\u3002 \u56e0\u4e3aLoongArch32\u7684\u73af\u5883\u914d\u7f6e\u6bd4\u8f83\u590d\u6742\uff0c\u5c24\u5176\u662f\u5b83\u7684QEMU\u9700\u8981\u8865\u5145\u5927\u91cf\u4f9d\u8d56\uff0c\u56e0\u6b64\u52a9\u6559\u4e3a\u4e86\u8282\u7701\u540c\u5b66\u4eec\u7684\u5de5\u4f5c\u91cf\u6253\u5305\u4e86\u4e00\u4e2aDocker\u955c\u50cf\uff0c\u5b83\u5c01\u88c5\u4e86\u6240\u6709\u8fd0\u884c\u6211\u4eec\u7684uCore\u5b9e\u9a8c\u6240\u9700\u7684\u73af\u5883\uff0c \u5e76\u5df2\u53d1\u5e03\u5230Docker Hub(\u9700\u4f7f\u7528VPN\u540e\u8bbf\u95ee) \uff0c\u540c\u65f6\u8be5\u955c\u50cf\u4e5f\u5df2\u4e0a\u4f20\u81f3\u963f\u91cc\u4e91\uff0c\u4e0b\u8f7d\u65b9\u6cd5 \u5728\u6b64 . \u8fd9\u91cc\u63a8\u8350\u4f7f\u7528Windows\u7684\u540c\u5b66\u4f7f\u7528WSL2\u6216Linux\u865a\u62df\u673a\u5b89\u88c5Docker\uff0c\u4f7f\u7528Linux\u7684\u540c\u5b66\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff0c\u4f7f\u7528macOS\uff08\u542bApple Silicon\uff09\u7684\u540c\u5b66\u4f7f\u7528Linux\u865a\u62df\u673a\u5b89\u88c5Docker\u3002 \u5e38\u89c1Linux\u53d1\u884c\u7248\u5b89\u88c5Docker\u65b9\u6cd5\u53ef\u53c2\u8003 \u6e05\u534e\u955c\u50cf\u7ad9\u4e0a\u7684\u6559\u7a0b \u3002 Note \u4f7f\u7528WSL2+Ubuntu 22.04\u7684\u540c\u5b66\u8bf7\u6ce8\u610f\uff1a \u5982\u679c\u9047\u5230Docker Daemon\u6ca1\u6709\u542f\u52a8\uff0c\u4e5f\u8bb8\u662fiptables-legacy\u6ca1\u6709\u5b89\u88c5\uff0c\u53ef\u4ee5\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u89e3\u51b3\uff1a sudo apt install iptables sudo update-alternatives --set iptables /usr/sbin/iptables-legacy sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy sudo service docker start \u53e6\u5916\uff0cWSL1\u4e0d\u652f\u6301Docker\uff0c\u6ca1\u6709\u6761\u4ef6\u5b89\u88c5WSL2\u7684\u540c\u5b66\u5efa\u8bae\u4f7f\u7528\u865a\u62df\u673a\u3002","title":"\u51c6\u5907\u5de5\u4f5c"},{"location":"lab0/setup/#x86-64","text":"\u5982\u679c\u540c\u5b66\u4eec\u4f7f\u7528\u975ex86-64\u67b6\u6784\u7684\u8ba1\u7b97\u673a\u8fdb\u884c\u5b9e\u9a8c\uff0c\u4f8b\u5982\u4f7f\u7528ARM\u67b6\u6784\u7684Apple Silicon\u7684Mac\u751a\u81f3\u662f\u6811\u8393\u6d3e\uff0c\u53ef\u4ee5\u4f7f\u7528\u865a\u62df\u673a\u5b89\u88c5\u4e00\u4e2a\u81ea\u5df1\u6307\u4ee4\u96c6\u67b6\u6784\u7684Linux\u53d1\u884c\u7248\uff08\u5bf9\u4e8eARM\u63a8\u8350Debian\uff0c\u4f5c\u4e3aUbuntu\u7684\u4e0a\u6e38\u8f6f\u4ef6\u652f\u6301\u8f83\u4e30\u5bcc\uff09\uff0c\u7136\u540e\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5qemu-user\u6a21\u62dfx86-64\u73af\u5883\uff0c\u5c31\u53ef\u4ee5\u5728Linux\u4e2d\u8fd0\u884cx86\u67b6\u6784\u7684\u4e8c\u8fdb\u5236\u7a0b\u5e8f\u4e86\uff1a sudo apt install qemu-user qemu-user-static binfmt-support gcc-x86-64-linux-gnu binutils-x86-64-linux-gnu binutils-x86-64-linux-gnu-dbg build-essential \u4e4b\u540e\u7684\u64cd\u4f5c\u4e0ex86-64\u7684Linux\u5b8c\u5168\u76f8\u540c\u3002","title":"\u5bf9\u4e8e\u4f7f\u7528\u7684\u7535\u8111\u975ex86-64\u67b6\u6784\u7684\u540c\u5b66"},{"location":"lab0/setup/#docker","text":"\u914d\u7f6e\u955c\u50cf\u7ad9 \u5bf9\u4e8e\u8bb8\u591a\u540c\u5b66\u7684\u7f51\u7edc\u73af\u5883\u800c\u8a00\u53ef\u80fd\u4eceDocker Hub\u5b98\u65b9\u4e0b\u8f7d\u8f83\u6162\uff0c\u8fd9\u91cc\u63a8\u8350\u5c06Docker Hub\u6539\u4e3a\u5357\u4eac\u5927\u5b66\u955c\u50cf\u7ad9\uff08\u76ee\u524d\u6559\u80b2\u7f51\u5185\u552f\u4e00Docker Hub\u955c\u50cf\uff09\uff0c \u914d\u7f6e\u65b9\u6cd5\u5728\u6b64 . \u914d\u7f6eDocker\u7ec4\u7684\u7528\u6237\u6743\u9650 \u5982\u679c\u540c\u5b66\u4eec\u60f3\u8981\u5728Linux\u4e2d\u4e0d\u901a\u8fc7root\u7528\u6237\uff08sudo\uff09\u5c31\u80fd\u76f4\u63a5\u8bbf\u95eeDocker\uff0c\u4ee5\u53ca\u5728\u8fd0\u884c\u4e8e\u7528\u6237\u6743\u9650\u7684VSCode\u4e2d\u76f4\u63a5\u4f7f\u7528Docker\uff0c\u53ef\u4ee5\u5c06\u81ea\u5df1\u7684\u7528\u6237\u52a0\u5165Docker\u521b\u5efa\u7684\u7ec4\u4e2d\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a sudo usermod -aG docker $USER newgrp docker \u4e4b\u540e\u91cd\u542f\u7535\u8111\u5373\u53ef\u5168\u5c40\u751f\u6548\uff0c\u5426\u5219\u6bcf\u6b21\u6253\u5f00\u7ec8\u7aef\u9700\u8981\u4f7f\u7528 newgrp docker \u624d\u80fd\u4f7f\u6743\u9650\u751f\u6548\u3002","title":"\u914d\u7f6eDocker\uff08\u53ef\u9009\uff09"},{"location":"lab0/setup/#docker_1","text":"\u4e0b\u8f7d chenyy/la32r-env \u955c\u50cf\uff1a \u5728\u7ec8\u7aef\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a docker pull chenyy/la32r-env \u57fa\u4e8e chenyy/la32r-env \u521b\u5efa la32r-docker \u5bb9\u5668 docker run -dit \\ --name la32r-docker \\ --user = $( id -u $USER ) : $( id -g $USER ) \\ --net = host \\ --workdir = \"/home/ $USER \" \\ --volume = \"/home:/home\" \\ --volume = \"/root:/root\" \\ --volume = \"/mnt:/mnt\" \\ --volume = \"/etc/group:/etc/group:ro\" \\ --volume = \"/etc/passwd:/etc/passwd:ro\" \\ --volume = \"/etc/shadow:/etc/shadow:ro\" \\ --volume = \"/etc/sudoers.d:/etc/sudoers.d:ro\" \\ -e LANG = en_US.UTF-8 \\ -e LANGUAGE = en_US.UTF-8 \\ -e LC_ALL = en_US.UTF-8 \\ chenyy/la32r-env \u8fd9\u91cc\u6211\u4eec\u5bf9Docker\u8fdb\u884c\u4e86\u4e00\u4e9b\u914d\u7f6e\uff0c\u7b80\u5355\u8bf4\u5c31\u662f\u5c06\u6574\u4e2a/home\u76ee\u5f55\u5728\u4e3b\u673a\u4e0eDocker\u5bb9\u5668\u4e4b\u95f4\u5171\u4eab\uff0c\u4ece\u800cDocker\u80fd\u591f\u76f4\u63a5\u8bbf\u95ee\u7528\u6237\u6587\u4ef6\u3002\u540c\u65f6\u5c06\u7528\u6237\u4e0e\u7ec4\u6743\u9650\u8fdb\u884c\u540c\u6b65\uff0c\u65b9\u4fbf\u5728Docker\u4e2d\u76f4\u63a5\u8bbf\u95ee\u5bf9\u5e94\u7684\u6587\u4ef6\u3002 \u542f\u52a8 la32r-docker \u5bb9\u5668 docker start la32r-docker \u8fdb\u5165 la32r-docker \u7684Shell docker exec -it la32r-docker /bin/zsh","title":"\u4e0b\u8f7dDocker\u955c\u50cf\u5e76\u521b\u5efa\u5b9e\u9a8c\u73af\u5883\u5bb9\u5668"},{"location":"lab0/setup/#vscode","text":"\u540c\u5b66\u4eec\u53ef\u4ee5\u5728VSCode\u7684\u63d2\u4ef6\u4e2d\u641c\u7d22Docker\uff0c\u5e76\u901a\u8fc7\u8be5\u63d2\u4ef6\u8fde\u63a5\u5230\u5bb9\u5668\u4e2d\u5b8c\u6210\u64cd\u4f5c\u3002 \u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728VSCode\u7684\u63d2\u4ef6\u4e2d\u627e\u5230\u5bf9\u5e94Docker\uff0c\u53ef\u4ee5\u8fdb\u884cAttach Shell\u6216Attch VSCode\u3002\u65b9\u4fbf\u6211\u4eec\u540e\u7eed\u5728Host\u7aef\u7684VSCode\u5b8c\u6210\u4ee3\u7801\u7f16\u5199\uff0c\u5e76\u5728Docker\u4e2d\u4f7f\u7528\u5bf9\u5e94\u73af\u5883\u5b8c\u6210\u7f16\u8bd1\u4e0e\u8c03\u8bd5\u3002","title":"\u914d\u7f6eVSCode\uff08\u53ef\u9009\uff09"},{"location":"lab0/task/","text":"\u5b9e\u9a8c\u4efb\u52a1 \u00b6 \u642d\u5efa\u7f16\u8bd1\u73af\u5883 \u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u88f8\u673a\u7a0b\u5e8f\uff0c\u5b9e\u73b0\u5728\u4e32\u53e3\u4e0a\u8f93\u51fa\u5b57\u7b26\u4e32 \u4e0d\u9700\u8981\u63d0\u4ea4\u62a5\u544a\u3002 \u7ec4\u961f\u5206\u5de5\u5efa\u8bae \u00b6 \u5b9e\u9a8c0\u5efa\u8bae\u6bcf\u4e2a\u5c0f\u7ec4\u6210\u5458\u90fd\u5b8c\u6210\u719f\u6089\uff0c\u5bf9\u540e\u7eed\u5b9e\u9a8c\u7684\u7406\u89e3\u5177\u6709\u975e\u5e38\u5927\u7684\u5e2e\u52a9\u3002","title":"\u5b9e\u9a8c\u4efb\u52a1"},{"location":"lab0/task/#_1","text":"\u642d\u5efa\u7f16\u8bd1\u73af\u5883 \u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u88f8\u673a\u7a0b\u5e8f\uff0c\u5b9e\u73b0\u5728\u4e32\u53e3\u4e0a\u8f93\u51fa\u5b57\u7b26\u4e32 \u4e0d\u9700\u8981\u63d0\u4ea4\u62a5\u544a\u3002","title":"\u5b9e\u9a8c\u4efb\u52a1"},{"location":"lab0/task/#_2","text":"\u5b9e\u9a8c0\u5efa\u8bae\u6bcf\u4e2a\u5c0f\u7ec4\u6210\u5458\u90fd\u5b8c\u6210\u719f\u6089\uff0c\u5bf9\u540e\u7eed\u5b9e\u9a8c\u7684\u7406\u89e3\u5177\u6709\u975e\u5e38\u5927\u7684\u5e2e\u52a9\u3002","title":"\u7ec4\u961f\u5206\u5de5\u5efa\u8bae"},{"location":"lab1/code/","text":"lab1\u4e2d\u5bf9\u4f8b\u5916\u7684\u5904\u7406\u5b9e\u73b0\uff08\u4e2d\u65ad\u5f02\u5e38\uff09 \u00b6 (1) \u5916\u8bbe\u57fa\u672c\u521d\u59cb\u5316\u8bbe\u7f6e Lab1\u5b9e\u73b0\u4e86\u4e2d\u65ad\u521d\u59cb\u5316\u548c\u5bf9\u4e32\u53e3\u3001\u65f6\u949f\u5916\u8bbe\u8fdb\u884c\u4e2d\u65ad\u5904\u7406\u3002\u4e32\u53e3\u7684\u521d\u59cb\u5316\u51fd\u6570serial_init\uff08\u4f4d\u4e8e/kern/driver/console.c\uff09\u4e2d\u6d89\u53ca\u4e2d\u65ad\u521d\u59cb\u5316\u5de5\u4f5c\u7684\u5f88\u7b80\u5355\uff1a ...... // \u4f7f\u80fd\u4e32\u53e31\u63a5\u6536\u5b57\u7b26\u540e\u4ea7\u751f\u4e2d\u65ad outb(COM1 + COM_IER, COM_IER_RDI); ...... // \u901a\u8fc7\u4e2d\u65ad\u63a7\u5236\u5668\u4f7f\u80fd\u4e32\u53e31\u4e2d\u65ad pic_enable(IRQ_COM1); \u65f6\u949f\u662f\u4e00\u79cd\u6709\u7740\u7279\u6b8a\u4f5c\u7528\u7684\u5916\u8bbe\uff0c\u5176\u4f5c\u7528\u5e76\u4e0d\u4ec5\u4ec5\u662f\u8ba1\u65f6\u3002\u5728\u540e\u7eed\u7ae0\u8282\u4e2d\u5c06\u8bb2\u5230\uff0c\u6b63\u662f\u7531\u4e8e\u6709\u4e86\u89c4\u5f8b\u7684\u65f6\u949f\u4e2d\u65ad\uff0c\u624d\u4f7f\u5f97\u65e0\u8bba\u5f53\u524dCPU\u8fd0\u884c\u5728\u54ea\u91cc\uff0c\u64cd\u4f5c\u7cfb\u7edf\u90fd\u53ef\u4ee5\u5728\u9884\u5148\u786e\u5b9a\u7684\u65f6\u95f4\u70b9\u4e0a\u83b7\u5f97CPU\u63a7\u5236\u6743\u3002\u8fd9\u6837\u5f53\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u4e86\u4e00\u5b9a\u65f6\u95f4\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u901a\u8fc7\u65f6\u949f\u4e2d\u65ad\u83b7\u5f97CPU\u63a7\u5236\u6743\uff0c\u5e76\u53ef\u628aCPU\u8d44\u6e90\u8ba9\u7ed9\u66f4\u9700\u8981CPU\u7684\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u3002\u65f6\u949f\u7684\u521d\u59cb\u5316\u51fd\u6570clock_init\uff08\u4f4d\u4e8ekern/driver/clock.c\u4e2d\uff09\u5b8c\u6210\u4e86\u5bf9\u65f6\u949f\u63a7\u5236\u5668\u7684\u521d\u59cb\u5316\uff1a ...... unsigned long timer_config; unsigned long period = 200000000; period = period / HZ; timer_config = period & LISA_CSR_TMCFG_TIMEVAL; timer_config |= (LISA_CSR_TMCFG_PERIOD | LISA_CSR_TMCFG_EN); __lcsr_csrwr(timer_config, LISA_CSR_TMCFG); pic_enable(TIMER0_IRQ); \u8fd9\u91cc\u5173\u4e8eCSR\u4e2d\u7684TCFG\u5bc4\u5b58\u5668\u5177\u4f53\u542b\u4e49\u9700\u8981\u53c2\u9605 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u7684P64\uff08PDF\u4e2d\u768476\u9875\uff09\u3002 (2) \u4f8b\u5916\u521d\u59cb\u5316\u8bbe\u7f6e \u5bf9\u4e8eLoongArch32\u67b6\u6784\u7684\u8ba1\u7b97\u673a\u6765\u8bf4\uff0c\u64cd\u4f5c\u7cfb\u7edf\u521d\u59cb\u5316\u4e2d\u65ad\u9996\u5148\u9700\u8981\u5b8c\u6210\u4f8b\u5916\u5904\u7406\u7a0b\u5e8f\u7684\u57fa\u5730\u5740\u8bbe\u7f6e\u3002\u8fd9\u4e00\u90e8\u5206\u7a0b\u5e8f\u5199\u5728\u4e86 kern/init/init.c \u4e2d\u7684 setup_exception_vector \u51fd\u6570\u3002 \u5176\u4e2d\uff0c\u8be5\u51fd\u6570\u4e2d\u4f7f\u7528\u7684 __exception_vector \u5730\u5740\u4f4d\u4e8e\u6587\u4ef6 kern/trap/vectors.S \u3002\u4e3a\u4e86\u7b80\u5316\uff0c\u5b83\u76f4\u63a5\u8df3\u8f6c\u5230\u4e86 kern/trap/exception.S \u4e2d\u7684 ramExcHandle_general \u5904\u3002 (3) \u4f8b\u5916\u7684\u5904\u7406\u8fc7\u7a0b trap\u51fd\u6570\uff08\u5b9a\u4e49\u5728trap.c\u4e2d\uff09\u662f\u5bf9\u4f8b\u5916\u8fdb\u884c\u5904\u7406\u7684\u8fc7\u7a0b\uff0c\u6240\u6709\u7684\u4f8b\u5916\u5728\u7ecf\u8fc7\u4e2d\u65ad\u5165\u53e3\u51fd\u6570 ramExcHandle_general \u9884\u5904\u7406\u540e (\u5b9a\u4e49\u5728 exception.S\u4e2d) \uff0c\u90fd\u4f1a\u8df3\u8f6c\u5230\u8fd9\u91cc\u3002\u5728\u5904\u7406\u8fc7\u7a0b\u4e2d\uff0c\u6839\u636e\u4e0d\u540c\u7684\u4f8b\u5916\u7c7b\u578b\uff0c\u8fdb\u884c\u76f8\u5e94\u7684\u5904\u7406\u3002\u5728\u76f8\u5e94\u7684\u5904\u7406\u8fc7\u7a0b\u7ed3\u675f\u4ee5\u540e\uff0ctrap\u5c06\u4f1a\u8fd4\u56de\uff0c\u88ab\u4e2d\u65ad\u7684\u7a0b\u5e8f\u4f1a\u7ee7\u7eed\u8fd0\u884c\u3002\u6574\u4e2a\u4e2d\u65ad\u5904\u7406\u6d41\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a 1)\u4ea7\u751f\u4f8b\u5916\u540e\uff0c CPU\u786c\u4ef6\u5b8c\u6210\u4e86\u5982\u4e0b\u64cd\u4f5c\uff1a \u5c06CSR.CRMD\u7684PLV\u3001IE\u5206\u522b\u5b58\u5230CSR.PRMD\u7684PPLV\u548cIE\u4e2d\uff0c\u7136\u540e\u5c06CSR.CRMD\u7684PLV\u7f6e\u4e3a0\uff0cIE\u7f6e\u4e3a0\u3002 \u5c06\u89e6\u53d1\u4f8b\u5916\u6307\u4ee4\u7684PC\u503c\u8bb0\u5f55\u5230CSR.ERA\u4e2d \u8df3\u8f6c\u5230\u4f8b\u5916\u5165\u53e3\u5904\u53d6\u503c\u3002\uff08\u5982\u679c\u662fTLB\u76f8\u5173\u4f8b\u5916\u8df3\u8f6c\u5230CSR.RFBASE\uff0c\u5426\u5219\u4e3aCSR.EBASE\uff09 2)\u7ecf\u8fc7\u4f8b\u5916\u5411\u91cf\u7684\u8df3\u8f6c\uff0c\u8fdb\u5165 exception.S \u4e2d\u7684 ramExcHandle_general \u3002 \u5728\u8fd9\u91cc\u4f1a\u5b8c\u6210\u4f8b\u5916\u73b0\u573a\u7684\u4fdd\u5b58\u64cd\u4f5c\uff0c\u5207\u6362\u5230\u5185\u6838\u6808\uff0c\u5c06\u5f53\u524d\u5904\u7406\u5668\u7684\u6240\u6709\u901a\u7528\u5bc4\u5b58\u5668\u538b\u5165\u5185\u6838\u6808\u4e2d\uff0c\u5e76\u4f7f\u7528CSR\u4e2d\u7684KS0\u548cKS1\u5bc4\u5b58\u5668\u7528\u6765\u8f85\u52a9\u4fdd\u5b58\u6570\u636e\uff08\u5426\u5219\u4fdd\u5b58\u8fc7\u7a0b\u4e2d\u5fc5\u7136\u5bfc\u81f4\u4e00\u4e9b\u7279\u5b9a\u5bc4\u5b58\u5668\u7684\u4fee\u6539\uff09\u3002 \u4fdd\u5b58\u7684\u6570\u636e\u6309\u7167trapfame\u7ed3\u6784\u8fdb\u884c\uff0c\u4f4d\u4e8e kern/trap/loongarch_trapframe.h \u3002 3) \u7136\u540e\u8df3\u8f6c\u8fdb\u5165 kern/trap/trap.c \u4e2d\u7684 loongarch_trap \u51fd\u6570\uff0c\u5f00\u59cb\u4e86C\u8bed\u8a00\u7a0b\u5e8f\u7684\u5185\u6838\u7684\u5904\u7406\u3002 \u8fd9\u4e2a\u51fd\u6570\u4e2d\uff0c\u4f1a\u6839\u636e\u4f8b\u5916\u7684\u7c7b\u578b\u5b8c\u6210\u4f8b\u5916\u7684\u5206\u7c7b\u5e76\u8fdb\u884c\u5904\u7406\uff0c\u5177\u4f53\u89c1 kern/trap/trap.c \u3002 4) \u5f53 loongarch_trap \u8fd9\u4e00\u51fd\u6570\u5904\u7406\u5b8c\u6bd5\u540e\uff08\u5904\u7406\u8fc7\u7a0b\u53ef\u80fd\u5305\u542b\u5bf9trapframe\u7684\u4fee\u6539\uff09\uff0c\u4f1a\u8fd4\u56de\u5230\u4e4b\u524d\u7684\u6c47\u7f16\u7a0b\u5e8f\uff08 exception.S \u4e2d\uff09\uff0c\u5b8c\u6210\u5bc4\u5b58\u5668\u72b6\u6001\u7684\u8fd8\u539f\uff0c\u7136\u540e\u4f7f\u7528ertn\u6307\u4ee4\u7ed3\u675f\u4f8b\u5916\u5904\u7406\uff0c\u6062\u590d\u7a0b\u5e8f\u7684\u6267\u884c\u3002 \u81f3\u6b64\uff0c\u5bf9\u6574\u4e2alab1\u4e2d\u7684\u4e3b\u8981\u90e8\u5206\u7684\u80cc\u666f\u77e5\u8bc6\u548c\u5b9e\u73b0\u8fdb\u884c\u4e86\u9610\u8ff0\u3002\u8bf7\u5927\u5bb6\u80fd\u591f\u636e\u6b64\u5b8c\u6210\u5b9e\u9a8c\u4efb\u52a1\u3002","title":"\u4ee3\u7801\u8bb2\u89e3"},{"location":"lab1/code/#lab1","text":"(1) \u5916\u8bbe\u57fa\u672c\u521d\u59cb\u5316\u8bbe\u7f6e Lab1\u5b9e\u73b0\u4e86\u4e2d\u65ad\u521d\u59cb\u5316\u548c\u5bf9\u4e32\u53e3\u3001\u65f6\u949f\u5916\u8bbe\u8fdb\u884c\u4e2d\u65ad\u5904\u7406\u3002\u4e32\u53e3\u7684\u521d\u59cb\u5316\u51fd\u6570serial_init\uff08\u4f4d\u4e8e/kern/driver/console.c\uff09\u4e2d\u6d89\u53ca\u4e2d\u65ad\u521d\u59cb\u5316\u5de5\u4f5c\u7684\u5f88\u7b80\u5355\uff1a ...... // \u4f7f\u80fd\u4e32\u53e31\u63a5\u6536\u5b57\u7b26\u540e\u4ea7\u751f\u4e2d\u65ad outb(COM1 + COM_IER, COM_IER_RDI); ...... // \u901a\u8fc7\u4e2d\u65ad\u63a7\u5236\u5668\u4f7f\u80fd\u4e32\u53e31\u4e2d\u65ad pic_enable(IRQ_COM1); \u65f6\u949f\u662f\u4e00\u79cd\u6709\u7740\u7279\u6b8a\u4f5c\u7528\u7684\u5916\u8bbe\uff0c\u5176\u4f5c\u7528\u5e76\u4e0d\u4ec5\u4ec5\u662f\u8ba1\u65f6\u3002\u5728\u540e\u7eed\u7ae0\u8282\u4e2d\u5c06\u8bb2\u5230\uff0c\u6b63\u662f\u7531\u4e8e\u6709\u4e86\u89c4\u5f8b\u7684\u65f6\u949f\u4e2d\u65ad\uff0c\u624d\u4f7f\u5f97\u65e0\u8bba\u5f53\u524dCPU\u8fd0\u884c\u5728\u54ea\u91cc\uff0c\u64cd\u4f5c\u7cfb\u7edf\u90fd\u53ef\u4ee5\u5728\u9884\u5148\u786e\u5b9a\u7684\u65f6\u95f4\u70b9\u4e0a\u83b7\u5f97CPU\u63a7\u5236\u6743\u3002\u8fd9\u6837\u5f53\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u4e86\u4e00\u5b9a\u65f6\u95f4\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u901a\u8fc7\u65f6\u949f\u4e2d\u65ad\u83b7\u5f97CPU\u63a7\u5236\u6743\uff0c\u5e76\u53ef\u628aCPU\u8d44\u6e90\u8ba9\u7ed9\u66f4\u9700\u8981CPU\u7684\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u3002\u65f6\u949f\u7684\u521d\u59cb\u5316\u51fd\u6570clock_init\uff08\u4f4d\u4e8ekern/driver/clock.c\u4e2d\uff09\u5b8c\u6210\u4e86\u5bf9\u65f6\u949f\u63a7\u5236\u5668\u7684\u521d\u59cb\u5316\uff1a ...... unsigned long timer_config; unsigned long period = 200000000; period = period / HZ; timer_config = period & LISA_CSR_TMCFG_TIMEVAL; timer_config |= (LISA_CSR_TMCFG_PERIOD | LISA_CSR_TMCFG_EN); __lcsr_csrwr(timer_config, LISA_CSR_TMCFG); pic_enable(TIMER0_IRQ); \u8fd9\u91cc\u5173\u4e8eCSR\u4e2d\u7684TCFG\u5bc4\u5b58\u5668\u5177\u4f53\u542b\u4e49\u9700\u8981\u53c2\u9605 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u7684P64\uff08PDF\u4e2d\u768476\u9875\uff09\u3002 (2) \u4f8b\u5916\u521d\u59cb\u5316\u8bbe\u7f6e \u5bf9\u4e8eLoongArch32\u67b6\u6784\u7684\u8ba1\u7b97\u673a\u6765\u8bf4\uff0c\u64cd\u4f5c\u7cfb\u7edf\u521d\u59cb\u5316\u4e2d\u65ad\u9996\u5148\u9700\u8981\u5b8c\u6210\u4f8b\u5916\u5904\u7406\u7a0b\u5e8f\u7684\u57fa\u5730\u5740\u8bbe\u7f6e\u3002\u8fd9\u4e00\u90e8\u5206\u7a0b\u5e8f\u5199\u5728\u4e86 kern/init/init.c \u4e2d\u7684 setup_exception_vector \u51fd\u6570\u3002 \u5176\u4e2d\uff0c\u8be5\u51fd\u6570\u4e2d\u4f7f\u7528\u7684 __exception_vector \u5730\u5740\u4f4d\u4e8e\u6587\u4ef6 kern/trap/vectors.S \u3002\u4e3a\u4e86\u7b80\u5316\uff0c\u5b83\u76f4\u63a5\u8df3\u8f6c\u5230\u4e86 kern/trap/exception.S \u4e2d\u7684 ramExcHandle_general \u5904\u3002 (3) \u4f8b\u5916\u7684\u5904\u7406\u8fc7\u7a0b trap\u51fd\u6570\uff08\u5b9a\u4e49\u5728trap.c\u4e2d\uff09\u662f\u5bf9\u4f8b\u5916\u8fdb\u884c\u5904\u7406\u7684\u8fc7\u7a0b\uff0c\u6240\u6709\u7684\u4f8b\u5916\u5728\u7ecf\u8fc7\u4e2d\u65ad\u5165\u53e3\u51fd\u6570 ramExcHandle_general \u9884\u5904\u7406\u540e (\u5b9a\u4e49\u5728 exception.S\u4e2d) \uff0c\u90fd\u4f1a\u8df3\u8f6c\u5230\u8fd9\u91cc\u3002\u5728\u5904\u7406\u8fc7\u7a0b\u4e2d\uff0c\u6839\u636e\u4e0d\u540c\u7684\u4f8b\u5916\u7c7b\u578b\uff0c\u8fdb\u884c\u76f8\u5e94\u7684\u5904\u7406\u3002\u5728\u76f8\u5e94\u7684\u5904\u7406\u8fc7\u7a0b\u7ed3\u675f\u4ee5\u540e\uff0ctrap\u5c06\u4f1a\u8fd4\u56de\uff0c\u88ab\u4e2d\u65ad\u7684\u7a0b\u5e8f\u4f1a\u7ee7\u7eed\u8fd0\u884c\u3002\u6574\u4e2a\u4e2d\u65ad\u5904\u7406\u6d41\u7a0b\u5927\u81f4\u5982\u4e0b\uff1a 1)\u4ea7\u751f\u4f8b\u5916\u540e\uff0c CPU\u786c\u4ef6\u5b8c\u6210\u4e86\u5982\u4e0b\u64cd\u4f5c\uff1a \u5c06CSR.CRMD\u7684PLV\u3001IE\u5206\u522b\u5b58\u5230CSR.PRMD\u7684PPLV\u548cIE\u4e2d\uff0c\u7136\u540e\u5c06CSR.CRMD\u7684PLV\u7f6e\u4e3a0\uff0cIE\u7f6e\u4e3a0\u3002 \u5c06\u89e6\u53d1\u4f8b\u5916\u6307\u4ee4\u7684PC\u503c\u8bb0\u5f55\u5230CSR.ERA\u4e2d \u8df3\u8f6c\u5230\u4f8b\u5916\u5165\u53e3\u5904\u53d6\u503c\u3002\uff08\u5982\u679c\u662fTLB\u76f8\u5173\u4f8b\u5916\u8df3\u8f6c\u5230CSR.RFBASE\uff0c\u5426\u5219\u4e3aCSR.EBASE\uff09 2)\u7ecf\u8fc7\u4f8b\u5916\u5411\u91cf\u7684\u8df3\u8f6c\uff0c\u8fdb\u5165 exception.S \u4e2d\u7684 ramExcHandle_general \u3002 \u5728\u8fd9\u91cc\u4f1a\u5b8c\u6210\u4f8b\u5916\u73b0\u573a\u7684\u4fdd\u5b58\u64cd\u4f5c\uff0c\u5207\u6362\u5230\u5185\u6838\u6808\uff0c\u5c06\u5f53\u524d\u5904\u7406\u5668\u7684\u6240\u6709\u901a\u7528\u5bc4\u5b58\u5668\u538b\u5165\u5185\u6838\u6808\u4e2d\uff0c\u5e76\u4f7f\u7528CSR\u4e2d\u7684KS0\u548cKS1\u5bc4\u5b58\u5668\u7528\u6765\u8f85\u52a9\u4fdd\u5b58\u6570\u636e\uff08\u5426\u5219\u4fdd\u5b58\u8fc7\u7a0b\u4e2d\u5fc5\u7136\u5bfc\u81f4\u4e00\u4e9b\u7279\u5b9a\u5bc4\u5b58\u5668\u7684\u4fee\u6539\uff09\u3002 \u4fdd\u5b58\u7684\u6570\u636e\u6309\u7167trapfame\u7ed3\u6784\u8fdb\u884c\uff0c\u4f4d\u4e8e kern/trap/loongarch_trapframe.h \u3002 3) \u7136\u540e\u8df3\u8f6c\u8fdb\u5165 kern/trap/trap.c \u4e2d\u7684 loongarch_trap \u51fd\u6570\uff0c\u5f00\u59cb\u4e86C\u8bed\u8a00\u7a0b\u5e8f\u7684\u5185\u6838\u7684\u5904\u7406\u3002 \u8fd9\u4e2a\u51fd\u6570\u4e2d\uff0c\u4f1a\u6839\u636e\u4f8b\u5916\u7684\u7c7b\u578b\u5b8c\u6210\u4f8b\u5916\u7684\u5206\u7c7b\u5e76\u8fdb\u884c\u5904\u7406\uff0c\u5177\u4f53\u89c1 kern/trap/trap.c \u3002 4) \u5f53 loongarch_trap \u8fd9\u4e00\u51fd\u6570\u5904\u7406\u5b8c\u6bd5\u540e\uff08\u5904\u7406\u8fc7\u7a0b\u53ef\u80fd\u5305\u542b\u5bf9trapframe\u7684\u4fee\u6539\uff09\uff0c\u4f1a\u8fd4\u56de\u5230\u4e4b\u524d\u7684\u6c47\u7f16\u7a0b\u5e8f\uff08 exception.S \u4e2d\uff09\uff0c\u5b8c\u6210\u5bc4\u5b58\u5668\u72b6\u6001\u7684\u8fd8\u539f\uff0c\u7136\u540e\u4f7f\u7528ertn\u6307\u4ee4\u7ed3\u675f\u4f8b\u5916\u5904\u7406\uff0c\u6062\u590d\u7a0b\u5e8f\u7684\u6267\u884c\u3002 \u81f3\u6b64\uff0c\u5bf9\u6574\u4e2alab1\u4e2d\u7684\u4e3b\u8981\u90e8\u5206\u7684\u80cc\u666f\u77e5\u8bc6\u548c\u5b9e\u73b0\u8fdb\u884c\u4e86\u9610\u8ff0\u3002\u8bf7\u5927\u5bb6\u80fd\u591f\u636e\u6b64\u5b8c\u6210\u5b9e\u9a8c\u4efb\u52a1\u3002","title":"lab1\u4e2d\u5bf9\u4f8b\u5916\u7684\u5904\u7406\u5b9e\u73b0\uff08\u4e2d\u65ad\u5f02\u5e38\uff09"},{"location":"lab1/getcode/","text":"\u4e0b\u8f7d\u5b9e\u9a8c\u8d44\u6599\u5305 \u00b6 \u6211\u4eec\u5c06\u5b9e\u9a8c\u8d44\u6599\u5305\u653e\u7f6e\u5728Github\u4e0a\uff0c\u8bf7\u5927\u5bb6\u81ea\u5df1\u5b89\u88c5Git\uff08\u6211\u4eec\u63d0\u4f9b\u7684\u5b9e\u9a8cDocker\u4e2d\u5df2\u7ecf\u81ea\u5e26\uff09\uff0c\u7136\u540e\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7d\uff1a git clone https://github.com/cyyself/ucore-loongarch32.git -b cqu2022_noanswer \u5efa\u8bae\u5927\u5bb6\u4e0d\u8981\u4f7f\u7528Github\u7f51\u9875\u63d0\u4f9b\u7684Download ZIP\u529f\u80fd\uff0c\u56e0\u4e3a\u8fd9\u6837\u4f1a\u4e22\u5931Git\u5143\u6570\u636e\uff0c\u65e0\u6cd5\u505a\u5230\u5207\u6362\u5206\u652f\u7b49\u529f\u80fd\u3002 \u5982\u679c\u8981\u4e0b\u8f7d\u6709\u7b54\u6848\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528 git checkout cqu2022 \u5207\u6362\u5230\u8be5\u5206\u652f\u3002 \u6211\u4eec\u5e76\u4e0d\u5bf9\u540c\u5b66\u4eec\u7684\u4ee3\u7801\u8fdb\u884c\u67e5\u91cd\uff0c\u9f13\u52b1\u540c\u5b66\u4eec\u5728\u770b\u4e86\u7b54\u6848\u540e\u53cd\u63a8\u64cd\u4f5c\u7cfb\u7edf\u7684\u8fd0\u884c\u8fc7\u7a0b\u4ece\u800c\u4e86\u89e3\u539f\u7406\u3002 \u521d\u6b21\u63a5\u89e6git\u7684\u540c\u5b66\u53ef\u4ee5 \u53c2\u8003\u8fd9\u91cc \u3002 \u8fd0\u884c\u5b9e\u9a8c \u00b6 \u6211\u4eec\u53ef\u4ee5\u5728Makefile\u4e2d\u5207\u6362\u8981\u8fd0\u884c\u7684\u5b9e\u9a8c\uff0c\u5c06\u8be5\u5b9e\u9a8c\u4e4b\u540e\u7684\u5b9e\u9a8c\u6ce8\u91ca\u6389\u5373\u53ef\u3002 \u4f8b\u5982\uff0c\u8fd0\u884c\u5b9e\u9a8c1\uff0c\u5c06Makefile\u6539\u4e3a\u4ee5\u4e0b\u72b6\u6001\uff1a LAB1 := -DLAB1_EX2 -DLAB1_EX3 -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT #LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 #LAB3 := -DLAB3_EX1 -DLAB3_EX2 #LAB4 := -DLAB4_EX1 -DLAB4_EX2 \u8fd0\u884c\u5b9e\u9a8c2\uff0c\u4ee5\u6b64\u7c7b\u63a8\u5982\u4e0b\uff1a LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 #LAB3 := -DLAB3_EX1 -DLAB3_EX2 #LAB4 := -DLAB4_EX1 -DLAB4_EX2 \u7f16\u8bd1\u4e0e\u8fd0\u884c\u5b9e\u9a8c \u00b6 \u5982\u679c\u6211\u4eec\u4fee\u6539\u4e86\u4ee3\u7801\uff0c\u5e0c\u671b\u91cd\u65b0\u7f16\u8bd1OS\u5185\u6838\u53ef\u4ee5\u6267\u884c\u4ee5\u4e0b\u4ee3\u7801\u3002 make clean # \u6e05\u7a7a\u7f16\u8bd1\u4ea7\u7269 make -j 16 # \u7f16\u8bd1 make qemu # \u8fd0\u884cqemu \u6ce8\uff0c\u5982\u679c\u6ca1\u6709make clean\uff0cMakefile\u4e0d\u4e00\u5b9a\u4f1a\u68c0\u6d4b\u5230\u4f60\u7684\u4fee\u6539\uff0c\u53ef\u80fd\u5bfc\u81f4\u7f16\u8bd1\u9519\u8bef\u6216\u8005\u7f16\u8bd1\u4e86stale\u72b6\u6001\u3002 \u5b9e\u9a8c\u8c03\u8bd5 \u00b6 \u5b9e\u9a8c\u7684\u8c03\u8bd5\u9700\u8981\u4f7f\u7528gdb\u4e0eqemu\u3002gdb\u7684\u4f7f\u7528\u65b9\u6cd5\u9700\u8981\u5927\u5bb6\u81ea\u884c\u5b66\u4e60\u3002 \u82e5\u8981\u8fdb\u5165gdb\u8c03\u8bd5\uff0c\u5927\u5bb6\u53ef\u4ee5\u5f00\u542f\u4e00\u4e2a\u7ec8\u7aef\u6267\u884c make debug \uff0c\u5728\u53e6\u4e00\u4e2a\u7ec8\u7aef\u6267\u884c make gdb \u3002 \u5982\u4f55\u5feb\u901f\u627e\u5230\u6bcf\u4e2a\u5b9e\u9a8c\u6211\u9700\u8981\u8865\u5145\u7684\u4ee3\u7801 \u00b6 \u4f7f\u7528\u4f60\u7684\u7f16\u8f91\u5668\uff0c\u5728UCORE\u4ee3\u7801\u4e2d\u641c\u7d22\"YOUR CODE\"\u5b57\u7b26\u4e32\u3002","title":"\u83b7\u53d6\u5b9e\u9a8c\u8d44\u6599"},{"location":"lab1/getcode/#_1","text":"\u6211\u4eec\u5c06\u5b9e\u9a8c\u8d44\u6599\u5305\u653e\u7f6e\u5728Github\u4e0a\uff0c\u8bf7\u5927\u5bb6\u81ea\u5df1\u5b89\u88c5Git\uff08\u6211\u4eec\u63d0\u4f9b\u7684\u5b9e\u9a8cDocker\u4e2d\u5df2\u7ecf\u81ea\u5e26\uff09\uff0c\u7136\u540e\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7d\uff1a git clone https://github.com/cyyself/ucore-loongarch32.git -b cqu2022_noanswer \u5efa\u8bae\u5927\u5bb6\u4e0d\u8981\u4f7f\u7528Github\u7f51\u9875\u63d0\u4f9b\u7684Download ZIP\u529f\u80fd\uff0c\u56e0\u4e3a\u8fd9\u6837\u4f1a\u4e22\u5931Git\u5143\u6570\u636e\uff0c\u65e0\u6cd5\u505a\u5230\u5207\u6362\u5206\u652f\u7b49\u529f\u80fd\u3002 \u5982\u679c\u8981\u4e0b\u8f7d\u6709\u7b54\u6848\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528 git checkout cqu2022 \u5207\u6362\u5230\u8be5\u5206\u652f\u3002 \u6211\u4eec\u5e76\u4e0d\u5bf9\u540c\u5b66\u4eec\u7684\u4ee3\u7801\u8fdb\u884c\u67e5\u91cd\uff0c\u9f13\u52b1\u540c\u5b66\u4eec\u5728\u770b\u4e86\u7b54\u6848\u540e\u53cd\u63a8\u64cd\u4f5c\u7cfb\u7edf\u7684\u8fd0\u884c\u8fc7\u7a0b\u4ece\u800c\u4e86\u89e3\u539f\u7406\u3002 \u521d\u6b21\u63a5\u89e6git\u7684\u540c\u5b66\u53ef\u4ee5 \u53c2\u8003\u8fd9\u91cc \u3002","title":"\u4e0b\u8f7d\u5b9e\u9a8c\u8d44\u6599\u5305"},{"location":"lab1/getcode/#_2","text":"\u6211\u4eec\u53ef\u4ee5\u5728Makefile\u4e2d\u5207\u6362\u8981\u8fd0\u884c\u7684\u5b9e\u9a8c\uff0c\u5c06\u8be5\u5b9e\u9a8c\u4e4b\u540e\u7684\u5b9e\u9a8c\u6ce8\u91ca\u6389\u5373\u53ef\u3002 \u4f8b\u5982\uff0c\u8fd0\u884c\u5b9e\u9a8c1\uff0c\u5c06Makefile\u6539\u4e3a\u4ee5\u4e0b\u72b6\u6001\uff1a LAB1 := -DLAB1_EX2 -DLAB1_EX3 -D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT #LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 #LAB3 := -DLAB3_EX1 -DLAB3_EX2 #LAB4 := -DLAB4_EX1 -DLAB4_EX2 \u8fd0\u884c\u5b9e\u9a8c2\uff0c\u4ee5\u6b64\u7c7b\u63a8\u5982\u4e0b\uff1a LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 #LAB3 := -DLAB3_EX1 -DLAB3_EX2 #LAB4 := -DLAB4_EX1 -DLAB4_EX2","title":"\u8fd0\u884c\u5b9e\u9a8c"},{"location":"lab1/getcode/#_3","text":"\u5982\u679c\u6211\u4eec\u4fee\u6539\u4e86\u4ee3\u7801\uff0c\u5e0c\u671b\u91cd\u65b0\u7f16\u8bd1OS\u5185\u6838\u53ef\u4ee5\u6267\u884c\u4ee5\u4e0b\u4ee3\u7801\u3002 make clean # \u6e05\u7a7a\u7f16\u8bd1\u4ea7\u7269 make -j 16 # \u7f16\u8bd1 make qemu # \u8fd0\u884cqemu \u6ce8\uff0c\u5982\u679c\u6ca1\u6709make clean\uff0cMakefile\u4e0d\u4e00\u5b9a\u4f1a\u68c0\u6d4b\u5230\u4f60\u7684\u4fee\u6539\uff0c\u53ef\u80fd\u5bfc\u81f4\u7f16\u8bd1\u9519\u8bef\u6216\u8005\u7f16\u8bd1\u4e86stale\u72b6\u6001\u3002","title":"\u7f16\u8bd1\u4e0e\u8fd0\u884c\u5b9e\u9a8c"},{"location":"lab1/getcode/#_4","text":"\u5b9e\u9a8c\u7684\u8c03\u8bd5\u9700\u8981\u4f7f\u7528gdb\u4e0eqemu\u3002gdb\u7684\u4f7f\u7528\u65b9\u6cd5\u9700\u8981\u5927\u5bb6\u81ea\u884c\u5b66\u4e60\u3002 \u82e5\u8981\u8fdb\u5165gdb\u8c03\u8bd5\uff0c\u5927\u5bb6\u53ef\u4ee5\u5f00\u542f\u4e00\u4e2a\u7ec8\u7aef\u6267\u884c make debug \uff0c\u5728\u53e6\u4e00\u4e2a\u7ec8\u7aef\u6267\u884c make gdb \u3002","title":"\u5b9e\u9a8c\u8c03\u8bd5"},{"location":"lab1/getcode/#_5","text":"\u4f7f\u7528\u4f60\u7684\u7f16\u8f91\u5668\uff0c\u5728UCORE\u4ee3\u7801\u4e2d\u641c\u7d22\"YOUR CODE\"\u5b57\u7b26\u4e32\u3002","title":"\u5982\u4f55\u5feb\u901f\u627e\u5230\u6bcf\u4e2a\u5b9e\u9a8c\u6211\u9700\u8981\u8865\u5145\u7684\u4ee3\u7801"},{"location":"lab1/intro/","text":"\u80cc\u666f \u00b6 \u64cd\u4f5c\u7cfb\u7edf\u662f\u4e00\u4e2a\u8f6f\u4ef6\uff0c\u4e5f\u9700\u8981\u901a\u8fc7\u67d0\u79cd\u673a\u5236\u52a0\u8f7d\u5e76\u8fd0\u884c\u5b83\u3002\u5bf9\u4e8eLoongArch32\u7684\u8ba1\u7b97\u673a\u6765\u8bf4\uff0c\u4e0a\u7535\u590d\u4f4d\u6700\u521d\u542f\u52a8\u7684\u662f\u4e00\u4e2aBIOS\u8f6f\u4ef6\uff08\u4f8b\u5982PMON\uff09\uff0c\u8be5BIOS\u8f6f\u4ef6\u80fd\u591f\u652f\u6301\u4ece\u7f51\u7edc\u52a0\u8f7dELF\u683c\u5f0f\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\uff0c\u4ece\u800c\u5f00\u59cb\u542f\u52a8\u6211\u4eec\u5df2\u7ecf\u7f16\u8bd1\u597d\u7684uCore\u5185\u6838\u3002 \u800c\u5bf9\u4e8eQEMU\u865a\u62df\u673a\u800c\u8a00\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 -kernel \u6765\u6307\u5b9a\u6211\u4eec\u9700\u8981\u52a0\u8f7d\u7684\u5185\u6838\u7684ELF\u6587\u4ef6\uff0c\u4ece\u800c\u76f4\u63a5\u5b8c\u6210\u4e86\u5185\u6838\u7684\u8f7d\u5165\u8fc7\u7a0b\uff0c\u5e76\u76f4\u63a5\u4eceELF\u7684\u5165\u53e3\u70b9\u5f00\u59cb\u542f\u52a8\u3002 BIOS\u542f\u52a8\u8fc7\u7a0b \u00b6 \u5f53\u8ba1\u7b97\u673a\u52a0\u7535\u540e\uff0c\u4e00\u822c\u4e0d\u76f4\u63a5\u6267\u884c\u64cd\u4f5c\u7cfb\u7edf\uff0c\u800c\u662f\u6267\u884c\u7cfb\u7edf\u521d\u59cb\u5316\u8f6f\u4ef6\u5b8c\u6210\u57fa\u672cIO\u521d\u59cb\u5316\u548c\u5f15\u5bfc\u52a0\u8f7d\u529f\u80fd\u3002\u7b80\u5355\u5730\u8bf4\uff0c\u7cfb\u7edf\u521d\u59cb\u5316\u8f6f\u4ef6\u5c31\u662f\u5728\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\u4e4b\u524d\u8fd0\u884c\u7684\u4e00\u6bb5\u5c0f\u8f6f\u4ef6\u3002\u901a\u8fc7\u8fd9\u6bb5\u5c0f\u8f6f\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u521d\u59cb\u5316\u786c\u4ef6\u8bbe\u5907\u3001\u5efa\u7acb\u7cfb\u7edf\u7684\u5185\u5b58\u7a7a\u95f4\u6620\u5c04\u56fe\uff0c\u4ece\u800c\u5c06\u7cfb\u7edf\u7684\u8f6f\u786c\u4ef6\u73af\u5883\u5e26\u5230\u4e00\u4e2a\u5408\u9002\u7684\u72b6\u6001\uff0c\u4ee5\u4fbf\u4e3a\u6700\u7ec8\u8c03\u7528\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u51c6\u5907\u597d\u6b63\u786e\u7684\u73af\u5883\u3002\u6700\u7ec8\u5f15\u5bfc\u52a0\u8f7d\u7a0b\u5e8f\u628a\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u6620\u50cf\u52a0\u8f7d\u5230RAM\u4e2d\uff0c\u5e76\u5c06\u7cfb\u7edf\u63a7\u5236\u6743\u4f20\u9012\u7ed9\u5b83\u3002 \u5bf9\u4e8e\u7edd\u5927\u591a\u6570\u8ba1\u7b97\u673a\u7cfb\u7edf\u800c\u8a00\uff0c\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u8f6f\u4ef6\u662f\u5b58\u653e\u5728\u78c1\u76d8\uff08\u786c\u76d8/\u8f6f\u76d8\uff09\u3001\u5149\u76d8\u3001EPROM\u3001ROM\u3001Flash\u7b49\u53ef\u5728\u6389\u7535\u540e\u7ee7\u7eed\u4fdd\u5b58\u6570\u636e\u7684\u5b58\u50a8\u4ecb\u8d28\u4e0a\u3002\u8ba1\u7b97\u673a\u542f\u52a8\u540e\uff0cCPU\u4e00\u5f00\u59cb\u4f1a\u5230\u4e00\u4e2a\u7279\u5b9a\u7684\u5730\u5740\u5f00\u59cb\u6267\u884c\u6307\u4ee4\uff0c\u8fd9\u4e2a\u7279\u5b9a\u7684\u5730\u5740\u5b58\u653e\u4e86\u7cfb\u7edf\u521d\u59cb\u5316\u8f6f\u4ef6\uff0c\u8d1f\u8d23\u5b8c\u6210\u8ba1\u7b97\u673a\u57fa\u672c\u7684IO\u521d\u59cb\u5316\uff0c\u8fd9\u662f\u7cfb\u7edf\u52a0\u7535\u540e\u8fd0\u884c\u7684\u7b2c\u4e00\u6bb5\u8f6f\u4ef6\u4ee3\u7801\u3002 \u5bf9\u4e8eLoongArch32\u4f53\u7cfb\u7ed3\u6784\u800c\u8a00\uff0c\u771f\u5b9e\u7684\u786c\u4ef6\u4e0a\u7535\u540e\u4f1a\u5f00\u59cb\u542f\u52a8BIOS\uff0c\u8be5BIOS\u53ef\u4ee5\u88ab\u81ea\u5df1\u5237\u5199\u3002\u800c\u5728 ChipLab\u6559\u5b66\u8ba1\u7b97\u673a \u4e2d\u91c7\u7528\u7684\u662fPMON2000\u4f5c\u4e3aBIOS\uff0c\u5b83\u5177\u6709\u7f51\u7edc\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u8fc7\u7f51\u5361\u4ece\u7f51\u7edc\u4e0a\u4f7f\u7528tftp\u534f\u8bae\u8f7d\u5165ELF\u683c\u5f0f\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u52a0\u8f7d\u5230\u5185\u5b58\uff0c\u7136\u540e\u4eceELF\u7684\u5165\u53e3\u70b9\u542f\u52a8\u3002 \u800c\u6211\u4eec\u5b9e\u9a8c\u91c7\u7528\u7684QEMU\u73af\u5883\uff0c\u5219\u662f\u629b\u5f03\u4e86BIOS\u8fd9\u4e00\u8fc7\u7a0b\u3002\u5728QEMU\u4e0a\u76f4\u63a5\u4f7f\u7528 -kernel \u53c2\u6570\u6307\u5b9a\u5185\u6838\u7684ELF\u6587\u4ef6\uff0c\u672c\u8d28\u4e0a\u5c31\u662f\u5b8c\u6210\u4e86BIOS\u6240\u505a\u7684\u52a0\u8f7d\u5185\u6838\u7684\u8fc7\u7a0b\uff0c\u76f4\u63a5\u4eceELF\u6587\u4ef6\u7684\u5165\u53e3\u70b9\u5f00\u59cb\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\u3002 \u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u8fc7\u7a0b \u00b6 \u5f53bootloader\u901a\u8fc7\u628aucore\u5728\u7cfb\u7edf\u52a0\u8f7d\u5230\u5185\u5b58\u540e\uff0c\u5c31\u8f6c\u8df3\u5230ucore\u64cd\u4f5c\u7cfb\u7edf\u5728\u5185\u5b58\u4e2d\u7684\u5165\u53e3\u4f4d\u7f6e\uff08kern/start.S\u4e2d\u7684start\u7684\u5730\u5740\uff09\uff0c\u8fd9\u6837ucore\u5c31\u63a5\u7ba1\u4e86\u6574\u4e2a\u63a7\u5236\u6743\u3002\u5f53\u524d\u7684ucore\u529f\u80fd\u5f88\u7b80\u5355\uff0c\u53ea\u5b8c\u6210\u57fa\u672c\u7684\u5185\u5b58\u7ba1\u7406\u548c\u5916\u8bbe\u4e2d\u65ad\u7ba1\u7406\u3002ucore\u4e3b\u8981\u5b8c\u6210\u7684\u5de5\u4f5c\u5305\u62ec\uff1a \u914d\u7f6eDMW\uff0c\u4f7f\u5f97\u64cd\u4f5c\u7cfb\u7edf\u62e5\u6709\u53ef\u7528\u7684\u5730\u5740\u7a7a\u95f4\uff08\u4f4d\u4e8e kern/init/entry.S \uff0c\u5176\u5b83\u90e8\u5206\u5747\u4e3aC\u8bed\u8a00\u7a0b\u5e8f\uff0c\u6574\u4f53\u4f4d\u4e8e kern/init/init.c \uff09 \u521d\u59cb\u5316\u7ec8\u7aef\uff1b \u663e\u793a\u5b57\u7b26\u4e32\uff1b \u8bbe\u7f6e\u4f8b\u5916\u4e24\u4e2a\u4f8b\u5916\u5411\u91cf\uff1b \u6267\u884cwhile\uff081\uff09\u6b7b\u5faa\u73af\u3002 \u4ee5\u540e\u7684\u5b9e\u9a8c\u4e2d\u4f1a\u5927\u91cf\u6d89\u53ca\u5404\u4e2a\u51fd\u6570\u76f4\u63a5\u7684\u8c03\u7528\u5173\u7cfb\uff0c\u4ee5\u53ca\u7531\u4e8e\u4e2d\u65ad\u5904\u7406\u5bfc\u81f4\u7684\u5f02\u6b65\u73b0\u8c61\uff0c\u53ef\u80fd\u5bf9\u5927\u5bb6\u5b9e\u73b0\u64cd\u4f5c\u7cfb\u7edf\u548c\u6539\u6b63\u5176\u4e2d\u7684\u9519\u8bef\u6709\u5f88\u5927\u5f71\u54cd\u3002\u800c\u7406\u89e3\u597d\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u7684\u5efa\u7acb\u673a\u5236\u548c\u4e2d\u65ad\u5904\u7406\u673a\u5236\uff0c\u5bf9\u540e\u7eed\u5b9e\u9a8c\u4f1a\u6709\u5f88\u5927\u5e2e\u52a9\u3002 \u5730\u5740\u7a7a\u95f4 \u00b6 uCore\u4e2d\u7684\u5730\u5740\u7a7a\u95f4\u6d89\u53ca\u4e24\u79cd\u5730\u5740\uff1a \u903b\u8f91\u5730\u5740\uff08Logical Address,\u5e94\u7528\u7a0b\u5e8f\u5458\u770b\u5230\u7684\u5730\u5740\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u4e0a\u79f0\u4e3a\u865a\u62df\u5730\u5740\uff0c\u4ee5\u540e\u63d0\u5230\u865a\u62df\u5730\u5740\u5c31\u662f\u6307\u903b\u8f91\u5730\u5740\uff09 \u7269\u7406\u5730\u5740\uff08Physical Address, \u5b9e\u9645\u7684\u7269\u7406\u5185\u5b58\u5730\u5740\uff09\u3002 (1) \u903b\u8f91\u5730\u5740\u7a7a\u95f4 \u4ece\u5e94\u7528\u7a0b\u5e8f\u7684\u89d2\u5ea6\u770b\uff0c\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u5c31\u662f\u5e94\u7528\u7a0b\u5e8f\u5458\u7f16\u7a0b\u6240\u7528\u5230\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u7a0b\u5e8f\u7247\u6bb5\uff1a int val=100; int * point=&val; \u5176\u4e2d\u6307\u9488\u53d8\u91cfpoint\u4e2d\u5b58\u50a8\u7684\u5373\u662f\u4e00\u4e2a\u903b\u8f91\u5730\u5740\u3002 (2) \u7269\u7406\u5730\u5740\u7a7a\u95f4 \u4ece\u64cd\u4f5c\u7cfb\u7edf\u7684\u89d2\u5ea6\u770b\uff0cCPU\u3001\u5185\u5b58\u786c\u4ef6\uff08\u901a\u5e38\u8bf4\u7684\u201c\u5185\u5b58\u6761\u201d\uff09\u548c\u5404\u79cd\u5916\u8bbe\u662f\u5b83\u4e3b\u8981\u7ba1\u7406\u7684\u786c\u4ef6\u8d44\u6e90\u800c\u5185\u5b58\u786c\u4ef6\u548c\u5916\u8bbe\u5206\u5e03\u5728\u7269\u7406\u5730\u5740\u7a7a\u95f4\u4e2d\u3002\u7269\u7406\u5730\u5740\u7a7a\u95f4\u5c31\u662f\u4e00\u4e2a\u201c\u5927\u6570\u7ec4\u201d\uff0cCPU\u901a\u8fc7\u7d22\u5f15\uff08\u7269\u7406\u5730\u5740\uff09\u6765\u8bbf\u95ee\u8fd9\u4e2a\u201c\u5927\u6570\u7ec4\u201d\u4e2d\u7684\u5185\u5bb9\u3002\u7269\u7406\u5730\u5740\u662f\u6307CPU\u63d0\u4ea4\u5230\u5185\u5b58\u603b\u7ebf\u4e0a\u7528\u4e8e\u8bbf\u95ee\u8ba1\u7b97\u673a\u5185\u5b58\u548c\u5916\u8bbe\u7684\u6700\u7ec8\u5730\u5740\u3002 \u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u5927\u5c0f\u53d6\u51b3\u4e8eCPU\u5b9e\u73b0\u7684\u7269\u7406\u5730\u5740\u4f4d\u6570\uff0cLoongArch32\u8ba1\u7b97\u673a\u4e2d\uff0cCPU\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\u53d6\u51b3\u4e8e\u5904\u7406\u5668\u914d\u7f6e\u7684PALEN\u3002\u800c\u5bf9\u4e8e\u5916\u8bbe\uff0c\u5219\u662f\u56fa\u5b9a\u914d\u7f6e\u4e8e0x1f000000~0x1fffffff\u3002\u4f8b\u5982\u6211\u4eec\u5982\u679c\u914d\u7f6eQEMU\u7684\u5185\u5b58\u4e3a256M\uff0c\u90a3\u4e48\u7269\u7406\u5730\u5740\u7a7a\u95f4\u5982\u4e0b\uff1a +------------------+ <- 0xFFFFFFFF (4GB) | \u65e0\u6548\u7a7a\u95f4 | +------------------+ <- 0x1FFFFFFF (512M) | IO\u5916\u8bbe\u5730\u5740\u7a7a\u95f4 | +------------------+ <- 0x1F000000 (496M) | \u65e0\u6548\u7a7a\u95f4 | +------------------+ <- 0x0FFFFFFF (256M) | \u6709\u6548\u5185\u5b58 | +------------------+ <- 0x00000000 \u4e2d\u65ad\u4e0e\u5f02\u5e38 \u00b6 \u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u5bf9\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u5404\u79cd\u5916\u8bbe\u8fdb\u884c\u7ba1\u7406\uff0c\u8fd9\u5c31\u9700\u8981CPU\u548c\u5916\u8bbe\u80fd\u591f\u76f8\u4e92\u901a\u4fe1\u624d\u884c\u3002\u4e00\u822c\u5916\u8bbe\u7684\u901f\u5ea6\u8fdc\u6162\u4e8eCPU\u7684\u901f\u5ea6\u3002\u5982\u679c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u901a\u8fc7CPU\u201c\u4e3b\u52a8\u5173\u5fc3\u201d\u5916\u8bbe\u7684\u4e8b\u4ef6\uff0c\u5373\u91c7\u7528\u901a\u5e38\u7684\u8f6e\u8be2(polling)\u673a\u5236\uff0c\u5219\u592a\u6d6a\u8d39CPU\u8d44\u6e90\u4e86\u3002\u6240\u4ee5\u9700\u8981\u64cd\u4f5c\u7cfb\u7edf\u548cCPU\u80fd\u591f\u4e00\u8d77\u63d0\u4f9b\u67d0\u79cd\u673a\u5236\uff0c\u8ba9\u5916\u8bbe\u5728\u9700\u8981\u64cd\u4f5c\u7cfb\u7edf\u5904\u7406\u5916\u8bbe\u76f8\u5173\u4e8b\u4ef6\u7684\u65f6\u5019\uff0c\u80fd\u591f\u201c\u4e3b\u52a8\u901a\u77e5\u201d\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5373\u6253\u65ad\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u7684\u6b63\u5e38\u6267\u884c\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u5916\u8bbe\u7684\u76f8\u5173\u5904\u7406\uff0c\u7136\u540e\u518d\u6062\u590d\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u7684\u6b63\u5e38\u6267\u884c\u3002\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u8fd9\u79cd\u673a\u5236\u79f0\u4e3a\u4e2d\u65ad\u673a\u5236\u3002\u4e2d\u65ad\u673a\u5236\u7ed9\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e86\u5904\u7406\u610f\u5916\u60c5\u51b5\u7684\u80fd\u529b\uff0c\u540c\u65f6\u5b83\u4e5f\u662f\u5b9e\u73b0\u8fdb\u7a0b/\u7ebf\u7a0b\u62a2\u5360\u5f0f\u8c03\u5ea6\u7684\u4e00\u4e2a\u91cd\u8981\u57fa\u77f3\u3002\u4f46\u4e2d\u65ad\u7684\u5f15\u5165\u4f1a\u5bfc\u81f4\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u7684\u7406\u89e3\u66f4\u52a0\u56f0\u96be\u3002 \u5728LoongArch32\u67b6\u6784\u4e2d\uff0c\u4e2d\u65ad\u5c5e\u4e8e\u5f02\u5e38(Exception)\u7684\u4e00\u79cd\uff0cuCore\u5185\u6838\u76ee\u524d\u5904\u7406\u7684\u5f02\u5e38\u5305\u62ec\u4ee5\u4e0b\u7c7b\u578b\uff1a \u4e2d\u65ad (EX_IRQ,CSR.ESTAT.Ecode=0) Load\u64cd\u4f5c\u9875\u65e0\u6548 (EX_TLBL,CSR.ESTAT.Ecode=1) Store\u64cd\u4f5c\u9875\u65e0\u6548(EX_TLBS,CSR.ESTAT.Ecode=2) TLB \u91cd\u586b (EX_TLBR,CSR.ESTAT.Ecode=31) \u6307\u4ee4\u4e0d\u5b58\u5728 (EX_RI,CSR.ESTAT.Ecode=13) \u6307\u4ee4\u7279\u6743\u7b49\u7ea7\u9519\u8bef(EX_IPE,CSR.ESTAT.Ecode=14) \u7cfb\u7edf\u8c03\u7528 (EX_SYS,CSR.ESTAT.Ecode=11) \u5730\u5740\u9519\u8bef\u4f8b\u5916 (EX_ADE,CSR.ESTAT.Ecode=8) \u4f8b\u5982\u5730\u5740\u6ca1\u6709\u5bf9\u9f50 LoongArch32\u67b6\u6784\u7684\u5904\u7406\u5668\u4e5f\u63d0\u4f9b\u4e86\u4e24\u4e2a\u4f8b\u5916\u5165\u53e3\u3002\u5206\u522b\u662f\u5e38\u89c4\u4f8b\u5916\u4e0eTLB\u4f8b\u5916\u3002\u7531\u4e8eTLB\u4f8b\u5916\u6d89\u53ca\u91cd\u586b\u9875\u8868\u7684\u5de5\u4f5c\uff0c\u56e0\u6b64\u5fc5\u987b\u4e3a\u7269\u7406\u5730\u5740\u3002\u800c\u5e38\u89c4\u4f8b\u5916\u5165\u53e3\u5219\u53ef\u4ee5\u6839\u636e\u76ee\u524d\u5904\u7406\u5668\u7684\u8fd0\u884c\u72b6\u6001\u9009\u62e9\u4f7f\u7528\u865a\u62df\u5730\u5740\u6216\u7269\u7406\u5730\u5740\u3002\u8fd9\u4e24\u4e2a\u4f8b\u5916\u5165\u53e3\u4e5f\u5b58\u50a8\u5728CSR\u5bc4\u5b58\u5668\u4e2d\uff0c\u540d\u79f0\u5206\u522b\u4e3aCSR.EBASE\u4e0eCSR.RFBASE\u3002uCore\u5bf9\u4e8eCSR.RFBASE\u7684\u5904\u7406\u91c7\u7528\u4e86\u4e24\u5c42\u8df3\u8f6c\u7684\u65b9\u5f0f\uff0c\u672c\u6b21\u5b9e\u9a8c\u6211\u4eec\u6682\u65f6\u4e0d\u8003\u8651RFBASE\u7684\u5904\u7406\u8fc7\u7a0b\u3002 \u65f6\u949f\u4e2d\u65ad \u00b6 LoongArch32\u7684CSR\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65f6\u949f\u5b9a\u65f6\u5668\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u4ee5\u901a\u8fc7CSR\u6307\u4ee4\u914d\u7f6e\u8be5\u5b9a\u65f6\u5668\uff0c\u4ece\u800c\u5b9e\u73b0\u786c\u4ef6\u4ea7\u751f\u65f6\u949f\u4e2d\u65ad\uff0c\u4f7f\u5f97\u64cd\u4f5c\u7cfb\u7edf\u80fd\u591f\u8fdb\u884c\u5206\u65f6\u8c03\u5ea6\u3002 \u8fd9\u4e00\u90e8\u5206\u5927\u5bb6\u8bf7\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u7684 7.6\u5b9a\u65f6\u5668\u76f8\u5173\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668 \uff0c\u4ee5\u53ca 7.4.5\u4f8b\u5916\u72b6\u6001\uff08ESTAT\uff09 \u7684\u4ecb\u7ecd\u3002 \u4e32\u53e3\u4e2d\u65ad \u00b6 \u6211\u4eec\u7684QEMU\u4ee5\u53caChiplab SoC\u4e0a\u90fd\u6709\u4e00\u4e2aNS16550a\u517c\u5bb9\u7684\u4e32\u53e3\u63a7\u5236\u5668\uff0c\u8be5\u63a7\u5236\u5668\u5728\u5f88\u591a\u79cd\u60c5\u51b5\u4e0b\u90fd\u4f1a\u6709\u4e2d\u65ad\u4ea7\u751f\uff08\u5927\u5bb6\u53ef\u4ee5\u81ea\u884c\u67e5\u9605ns16550\u6709\u5173\u8d44\u6599\uff09\uff0c\u5728\u672c\u5b9e\u9a8c\u4e2d\u6211\u4eec\u6682\u65f6\u53ea\u9700\u8981\u77e5\u9053\uff0c\u4e32\u53e3\u6709\u8f93\u5165\u65f6\u4f1a\u4ea7\u751f\u4e2d\u65ad\u3002 \u5728LoongArch32\u7684QEMU\u4ee5\u53caChiplab SoC\u4e0a\uff0c\u4e32\u53e3\u8fde\u63a5\u7684\u4e2d\u65ad\u4e3aHWI[0]\u3002 \u4f8b\u5916\u4ea7\u751f \u00b6 \u5f53\u4f8b\u5916\u4ea7\u751f\u65f6\uff0c\u5904\u7406\u5668 \u786c\u4ef6 \u4f1a\u8fdb\u884c\u5982\u4e0b\u64cd\u4f5c\uff08\u8fd9\u4e9b\u64cd\u4f5c\u7531\u786c\u4ef6\u5b8c\u6210\uff0c\u4e0d\u4f1a\u51fa\u73b0\u5728\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\u4e2d\uff09\uff1a \u5c06CSR.CRMD\u7684PLV\u3001IE\u5206\u522b\u5b58\u5230CSR.PRMD\u7684PPLV\u548cIE\u4e2d\uff0c\u7136\u540e\u5c06CSR.CRMD\u7684PLV\u7f6e\u4e3a0\uff0cIE\u7f6e\u4e3a0\u3002 \u5c06\u89e6\u53d1\u4f8b\u5916\u6307\u4ee4\u7684PC\u503c\u8bb0\u5f55\u5230CSR.ERA\u4e2d \u8df3\u8f6c\u5230\u4f8b\u5916\u5165\u53e3\u5904\u53d6\u503c\u3002\uff08\u5982\u679c\u662fTLB\u76f8\u5173\u4f8b\u5916\u8df3\u8f6c\u5230CSR.RFBASE\uff0c\u5426\u5219\u4e3aCSR.EBASE\uff09 \u7136\u540e\u5c06PC\u8df3\u8f6c\u5230\u5bf9\u5e94\u7684\u4f8b\u5916\u5165\u53e3\u5730\u5740\u5904\uff0c\u4ea4\u7ed9\u8f6f\u4ef6\u5b8c\u6210\u4f8b\u5916\u7684\u5904\u7406\u64cd\u4f5c\u3002 Note \u66f4\u52a0\u8be6\u7ec6\u7684\u4fe1\u606f\u8bf7\u540c\u5b66\u4eec\u81ea\u884c\u9605\u8bfb \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u3002\u5173\u4e8e\u4e2d\u65ad\u4ea7\u751f\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u9605\u8bfb\u8be5\u6587\u6863\u76846.1.4\u90e8\u5206\u3002 Note \u5c0f\u601d\u8003\uff1a\u4e3a\u4ec0\u4e48\u8fdb\u5165\u5f02\u5e38\u5904\u7406\u65f6\u8981\u5173\u95ed\u4e2d\u65ad\uff1f \u8fd9\u91cc\u7ed9\u51fa\u53c2\u8003\u7b54\u6848\uff1a \u82e5\u4e0d\u5173\u95ed\uff0c\u8003\u8651\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\uff1a \u5f02\u5e38\u7c7b\u578b\u662f\u4e2d\u65ad \u5904\u7406\u5668\u7531\u4e8e\u4e2d\u65ad\u5f02\u5e38\u8df3\u8f6c\u5230\u4e86\u5f02\u5e38\u5165\u53e3\u70b9\uff0c\u6b64\u65f6\u4e2d\u65ad\u4fe1\u53f7\u8fd8\u6ca1\u6709\u54cd\u5e94\u4f7f\u5176\u6e05\u9664\uff0c\u5904\u7406\u5668\u7ee7\u7eed\u6ee1\u8db3\u4e2d\u65ad\u4ea7\u751f\u6761\u4ef6\uff0c\u5219\u7ee7\u7eed\u8df3\u8f6c\u4e2d\u65ad\u5165\u53e3\u70b9\uff0c\u4f1a\u5bfc\u81f4\u6b7b\u5faa\u73af\u3002 \u5f02\u5e38\u7c7b\u578b\u4e0d\u662f\u4e2d\u65ad \u82e5\u5728\u5f02\u5e38\u5904\u7406\u65f6\u53d1\u751f\u4e2d\u65ad\uff08\u4f8b\u5982\u5916\u8bbe\u6709\u6570\u636e\u5230\u8fbe\u3001\u5b9a\u65f6\u5668\u4ea7\u751f\u65f6\u949f\u4e2d\u65ad\u7b49\u60c5\u51b5\uff09\uff0c\u4f1a\u5bfc\u81f4\u5f02\u5e38\u4e0a\u4e0b\u6587\u88ab\u7834\u574f\uff0c\u4ece\u800c\u5bfc\u81f4\u4e0a\u4e00\u4e2a\u5f02\u5e38\u5e94\u8be5\u4fdd\u5b58\u7684\u72b6\u6001\u8fd8\u6ca1\u5b58\u4e0b\u6765\uff0c\u4e0b\u4e00\u4e2a\u5f02\u5e38\u7ee7\u7eed\u4ea7\u751f\uff0c\u4ece\u800c\u65e0\u6cd5\u6062\u590d\u539f\u6765\u7684\u73b0\u573a\u3002 \uff08\u540c\u5b66\u4eec\u53ef\u4ee5\u601d\u8003uCore\u4e2d\u7684trapframe\u4fdd\u5b58\u65f6\u518d\u6b21\u51fa\u73b0\u4e00\u4e2a\u4e2d\u65ad\u4f1a\u51fa\u73b0\u4ec0\u4e48\u60c5\u51b5\uff1f\uff09 Note \u5c0f\u601d\u8003\uff1a\u4e3a\u4ec0\u4e48TLB\u91cd\u586b\u5f02\u5e38\u91c7\u7528\u4e86\u5173\u95ed\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u91c7\u7528\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u7684\u8bbe\u8ba1\uff1f \u540c\u5b66\u4eec\u53ef\u4ee5\u505a\u5b8cLab2\u540e\u5c1d\u8bd5\u56de\u7b54\u6b64\u95ee\u9898\u3002 \u8be5\u95ee\u9898\u6709\u591a\u4e2a\u89d2\u5ea6\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u8003\u8651\u5206\u89e3\u540e\u7684\u4ee5\u4e0b\u5b50\u95ee\u9898\uff1a \u5982\u679c\u5185\u5b58\u8d85\u8fc7512M\uff0c\u4e14\u9875\u8868\u4f1a\u653e\u5728\u7269\u7406\u5185\u5b58\u4efb\u610f\u4f4d\u7f6e\uff0cDMW\u65b9\u6848\u8fd8\u662f\u5426\u53ef\u884c\uff1f TLB Miss\u76f8\u5bf9\u4e8e\u9875\u65e0\u6548/\u9875\u4fee\u6539\u662f\u9891\u7387\u9ad8\u5f97\u591a\u7684\u4e8b\u4ef6\uff0c\u5982\u679c\u5e0c\u671bTLB Miss\u65f6OS\u80fd\u591f\u5c3d\u5feb\u5b8c\u6210TLB\u91cd\u586b\uff0c\u5e94\u8be5\u5982\u4f55\u6539\u5199uCore\u4ee3\u7801\uff1f \u540c\u5b66\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u9605\u8bfbLinux\u4e2d\u5bf9\u4e8e\u540c\u6837\u662f\u8f6f\u4ef6\u63a7\u5236TLB\u7684MIPS\u67b6\u6784\u7684\u4ee3\u7801\u3002 \u64cd\u4f5c\u7cfb\u7edf\u54cd\u5e94\u5f02\u5e38 \u00b6 \u5bf9\u4e8euCore\uff0cCSR.EBASE\u5728\u5185\u6838\u521d\u59cb\u5316\u9636\u6bb5\uff08\u4f4d\u4e8e kern/init/init.c \u7684 setup_exception_vector \u51fd\u6570\uff09\u4f1a\u88ab\u521d\u59cb\u5316\u4e3a exception_handler \u7b26\u53f7\u5bf9\u5e94\u7684\u6307\u9488\uff08\u4f4d\u4e8e kern/trap/exceptions.S \uff09\u3002 \u5728 kern/trap/exceptions.S \u4e2d\uff0c\u4f1a\u5b8c\u6210\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u5c06t0\u3001t1\u4fdd\u5b58\u5230CSR\u7684KS0\u3001KS1\u4e2d\uff0c\u4ee5\u4fbf\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e24\u4e2aGPR\u6765\u5b58\u50a8\u4e00\u4e9b\u6570\u636e\u800c\u4e0d\u5fc5\u7834\u574f\u4f8b\u5916\u73b0\u573a\u3002 \u5224\u65ad\u5f02\u5e38\u662f\u5426\u53d1\u751f\u5728\u7528\u6237\u6001\uff0c\u82e5\u662f\uff0c\u5207\u6362\u6808\u4e3a\u5185\u6838\u6808\u3002 \u5728\u6808\u4e0a\u5f00\u8f9f\u8db3\u591f\u5b58\u50a8 trapframe \u6570\u636e\u7ed3\u6784\u7684\u7a7a\u95f4\uff08\u4f4d\u4e8e kern/trap/loongarch_trapframe.h \uff09\uff0c\u5c06\u5f02\u5e38\u53d1\u751f\u73b0\u573a\u6309\u7167trapframe\u7ed3\u6784\u4fdd\u5b58\u5728\u6808\u4e2d\u3002 \u6ce8\uff1a\u5176\u4e2d\u7684pushreg\u7ed3\u6784\u53ea\u4fdd\u5b5830\u4e2aGPR\u5bc4\u5b58\u5668\uff0c\u800c\u4e0d\u662f32\u4e2a\u3002 \u8fd9\u662f\u56e0\u4e3a0\u53f7\u5bc4\u5b58\u5668\u6a2a\u4e3a0\u4e0d\u53ef\u5199\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u4fdd\u5b58\uff0c1\u53f7\u5bc4\u5b58\u5668\u5728ABI\u4e2d\u610f\u4e49\u662fRA\uff0c\u5df2\u7ecf\u4fdd\u5b58\u5728\u4e86trapframe\u4e2d\u7684tf_ra\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cra\u5bc4\u5b58\u5668\u4e0eCSR.ERA\u610f\u4e49\u4e0d\u540c\u3002ra\u5bc4\u5b58\u5668\u5728ABI\u4e0a\u5b58\u50a8\u7684\u662f\u7a0b\u5e8f\u8fd0\u884c\u4e2d\u51fd\u6570return\u7684\u8fd4\u56de\u5730\u5740\uff0c\u800cCSR.ERA\u5b58\u50a8\u7684\u662f\u4f8b\u5916\u4ea7\u751f\u65f6\u8fd8\u6ca1\u63d0\u4ea4\u7684PC\u5730\u5740\u3002 \u6570\u636e\u4fdd\u5b58\u540e\uff0c\u5c06a0\u5bc4\u5b58\u5668\u4fdd\u5b58\u4e3a\u6307\u5411trapframe\u7684\u6307\u9488 \u6839\u636eABI\u5b9a\u4e49\uff0ca0\u4fdd\u5b58\u7684\u662f\u51fd\u6570\u8c03\u7528\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\uff0c\u8fd9\u6837C\u8bed\u8a00\u7f16\u5199\u7684loongarch_trap\u51fd\u6570\u8bfb\u53d6\u8be5\u53c2\u6570\u5373\u8bfb\u53d6a0\u7684\u503c\u3002 \u8df3\u8f6c\u5230loongarch_trap\u51fd\u6570 \u4e4b\u540e\u7684C\u8bed\u8a00\u4ee3\u7801\u7f16\u5199\u7684\u90e8\u5206\u4e0d\u8be6\u7ec6\u5c55\u5f00\uff0c\u8bf7\u540c\u5b66\u4eec\u81ea\u884c\u9605\u8bfb\u4ee3\u7801\u3002 Note \u5c0f\u601d\u8003\uff1a\u4e3a\u4ec0\u4e48\u9700\u8981\u5207\u6362\u4e3a\u5185\u6838\u6808\uff1f\u76f4\u63a5\u8ba9\u5185\u6838\u8dd1\u5728\u7528\u6237\u7a0b\u5e8f\u7684\u6808\u4e0a\u662f\u5426\u53ef\u884c\uff1f \u8003\u8651\u4ee5\u4e0b\u89d2\u5ea6\uff1a 1. \u5185\u6838\u6808\u6cc4\u9732\u7ed9\u7528\u6237\u7a0b\u5e8f\u662f\u5426\u5bfc\u81f4\u5b89\u5168\u95ee\u9898\uff1f 2. \u7528\u6237\u7a0b\u5e8f\u8dd1\u5728\u865a\u62df\u5730\u5740\uff0c\u8bfb\u5199\u7528\u6237\u6808\u53ef\u80fd\u4f1a\u4ea7\u751f\u4ec0\u4e48\u95ee\u9898\uff1f\uff08\u53ef\u4ee5\u505a\u5b8c\u540e\u7eedLab\u540e\u518d\u601d\u8003\u8be5\u5b50\u95ee\u9898\uff09 \u4f8b\u5916\u5904\u7406\u8fd4\u56de \u00b6 \u5f53loongarch_trap\u51fd\u6570\u7ed3\u675f\u540e\uff0c\u7531\u4e8e\u6211\u4eec\u8df3\u8f6c\u65f6\u5199\u4e86ra\u5bc4\u5b58\u5668\uff0c\u6b64\u65f6\u4f1a\u56de\u5230\u8df3\u8f6c\u524d\u7684\u4f4d\u7f6e\u3002 \u8be5\u4f4d\u7f6e\u4e5f\u5c31\u662f kern/trap/exception.S \u7684jirl\u5230loongarch_trap\u7684\u4e0b\u4e00\u6761\u6307\u4ee4\uff0c\u5bf9\u5e94\u7684\u662fexception_return\u7b26\u53f7\u7684\u5f00\u59cb\u3002 \u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u5c06\u4e4b\u524d\u4fdd\u5b58\u7684trapframe\u4e2d\u7684\u4fe1\u606f\u4ece\u6808\u4e0a\u8fd8\u539f\uff0c\u7136\u540e\u8c03\u7528ertn\u6307\u4ee4\uff0c\u8be5\u6307\u4ee4\u4f1a\u5b8c\u6210\u5982\u4e0b\u64cd\u4f5c\uff1a \u5c06CSR.PRMD\u4e2d\u7684PPLV\u3001PIE\u503c\u56de\u590d\u5230CSR.CRMD\u7684PLV\u3001IE\u4e2d\u3002 \u8df3\u8f6c\u5230CSR.ERA\u6240\u8bb0\u5f55\u7684\u5730\u5740\u5904\u53d6\u6307\u3002 Note \u5c0f\u601d\u8003\uff1a\u6211\u4eec\u5728loongarch_trap\u51fd\u6570\u4e2d\u7ee7\u7eed\u8c03\u7528\u4e86trap_dispatch\uff0c\u6b64\u65f6\u662f\u5426\u4f1a\u6539\u53d8ra\u5bc4\u5b58\u5668\u7684\u503c\uff1f\u5982\u679c\u6539\u53d8\u4e86\uff0c\u539f\u672c\u7684ra\u4f1a\u88ab\u5b58\u50a8\u5728\u4ec0\u4e48\u4f4d\u7f6e\uff1f \u540c\u5b66\u4eec\u53ef\u4ee5\u56de\u5fc6\u7a0b\u5e8f\u8fd0\u884c\u65f6\u7684\u6808\u662f\u505a\u4ec0\u4e48\u7528\u7684\uff0c\u4ee5\u53ca\u9605\u8bfbLoongArch32\u7684ABI\u6587\u6863\u4ee5\u53ca\u5176\u4ed6\u67b6\u6784\u7684ABI\u6587\u6863\u3002","title":"\u80cc\u666f\u4ecb\u7ecd"},{"location":"lab1/intro/#_1","text":"\u64cd\u4f5c\u7cfb\u7edf\u662f\u4e00\u4e2a\u8f6f\u4ef6\uff0c\u4e5f\u9700\u8981\u901a\u8fc7\u67d0\u79cd\u673a\u5236\u52a0\u8f7d\u5e76\u8fd0\u884c\u5b83\u3002\u5bf9\u4e8eLoongArch32\u7684\u8ba1\u7b97\u673a\u6765\u8bf4\uff0c\u4e0a\u7535\u590d\u4f4d\u6700\u521d\u542f\u52a8\u7684\u662f\u4e00\u4e2aBIOS\u8f6f\u4ef6\uff08\u4f8b\u5982PMON\uff09\uff0c\u8be5BIOS\u8f6f\u4ef6\u80fd\u591f\u652f\u6301\u4ece\u7f51\u7edc\u52a0\u8f7dELF\u683c\u5f0f\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\uff0c\u4ece\u800c\u5f00\u59cb\u542f\u52a8\u6211\u4eec\u5df2\u7ecf\u7f16\u8bd1\u597d\u7684uCore\u5185\u6838\u3002 \u800c\u5bf9\u4e8eQEMU\u865a\u62df\u673a\u800c\u8a00\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 -kernel \u6765\u6307\u5b9a\u6211\u4eec\u9700\u8981\u52a0\u8f7d\u7684\u5185\u6838\u7684ELF\u6587\u4ef6\uff0c\u4ece\u800c\u76f4\u63a5\u5b8c\u6210\u4e86\u5185\u6838\u7684\u8f7d\u5165\u8fc7\u7a0b\uff0c\u5e76\u76f4\u63a5\u4eceELF\u7684\u5165\u53e3\u70b9\u5f00\u59cb\u542f\u52a8\u3002","title":"\u80cc\u666f"},{"location":"lab1/intro/#bios","text":"\u5f53\u8ba1\u7b97\u673a\u52a0\u7535\u540e\uff0c\u4e00\u822c\u4e0d\u76f4\u63a5\u6267\u884c\u64cd\u4f5c\u7cfb\u7edf\uff0c\u800c\u662f\u6267\u884c\u7cfb\u7edf\u521d\u59cb\u5316\u8f6f\u4ef6\u5b8c\u6210\u57fa\u672cIO\u521d\u59cb\u5316\u548c\u5f15\u5bfc\u52a0\u8f7d\u529f\u80fd\u3002\u7b80\u5355\u5730\u8bf4\uff0c\u7cfb\u7edf\u521d\u59cb\u5316\u8f6f\u4ef6\u5c31\u662f\u5728\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\u4e4b\u524d\u8fd0\u884c\u7684\u4e00\u6bb5\u5c0f\u8f6f\u4ef6\u3002\u901a\u8fc7\u8fd9\u6bb5\u5c0f\u8f6f\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u521d\u59cb\u5316\u786c\u4ef6\u8bbe\u5907\u3001\u5efa\u7acb\u7cfb\u7edf\u7684\u5185\u5b58\u7a7a\u95f4\u6620\u5c04\u56fe\uff0c\u4ece\u800c\u5c06\u7cfb\u7edf\u7684\u8f6f\u786c\u4ef6\u73af\u5883\u5e26\u5230\u4e00\u4e2a\u5408\u9002\u7684\u72b6\u6001\uff0c\u4ee5\u4fbf\u4e3a\u6700\u7ec8\u8c03\u7528\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u51c6\u5907\u597d\u6b63\u786e\u7684\u73af\u5883\u3002\u6700\u7ec8\u5f15\u5bfc\u52a0\u8f7d\u7a0b\u5e8f\u628a\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u6620\u50cf\u52a0\u8f7d\u5230RAM\u4e2d\uff0c\u5e76\u5c06\u7cfb\u7edf\u63a7\u5236\u6743\u4f20\u9012\u7ed9\u5b83\u3002 \u5bf9\u4e8e\u7edd\u5927\u591a\u6570\u8ba1\u7b97\u673a\u7cfb\u7edf\u800c\u8a00\uff0c\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u8f6f\u4ef6\u662f\u5b58\u653e\u5728\u78c1\u76d8\uff08\u786c\u76d8/\u8f6f\u76d8\uff09\u3001\u5149\u76d8\u3001EPROM\u3001ROM\u3001Flash\u7b49\u53ef\u5728\u6389\u7535\u540e\u7ee7\u7eed\u4fdd\u5b58\u6570\u636e\u7684\u5b58\u50a8\u4ecb\u8d28\u4e0a\u3002\u8ba1\u7b97\u673a\u542f\u52a8\u540e\uff0cCPU\u4e00\u5f00\u59cb\u4f1a\u5230\u4e00\u4e2a\u7279\u5b9a\u7684\u5730\u5740\u5f00\u59cb\u6267\u884c\u6307\u4ee4\uff0c\u8fd9\u4e2a\u7279\u5b9a\u7684\u5730\u5740\u5b58\u653e\u4e86\u7cfb\u7edf\u521d\u59cb\u5316\u8f6f\u4ef6\uff0c\u8d1f\u8d23\u5b8c\u6210\u8ba1\u7b97\u673a\u57fa\u672c\u7684IO\u521d\u59cb\u5316\uff0c\u8fd9\u662f\u7cfb\u7edf\u52a0\u7535\u540e\u8fd0\u884c\u7684\u7b2c\u4e00\u6bb5\u8f6f\u4ef6\u4ee3\u7801\u3002 \u5bf9\u4e8eLoongArch32\u4f53\u7cfb\u7ed3\u6784\u800c\u8a00\uff0c\u771f\u5b9e\u7684\u786c\u4ef6\u4e0a\u7535\u540e\u4f1a\u5f00\u59cb\u542f\u52a8BIOS\uff0c\u8be5BIOS\u53ef\u4ee5\u88ab\u81ea\u5df1\u5237\u5199\u3002\u800c\u5728 ChipLab\u6559\u5b66\u8ba1\u7b97\u673a \u4e2d\u91c7\u7528\u7684\u662fPMON2000\u4f5c\u4e3aBIOS\uff0c\u5b83\u5177\u6709\u7f51\u7edc\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u8fc7\u7f51\u5361\u4ece\u7f51\u7edc\u4e0a\u4f7f\u7528tftp\u534f\u8bae\u8f7d\u5165ELF\u683c\u5f0f\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u52a0\u8f7d\u5230\u5185\u5b58\uff0c\u7136\u540e\u4eceELF\u7684\u5165\u53e3\u70b9\u542f\u52a8\u3002 \u800c\u6211\u4eec\u5b9e\u9a8c\u91c7\u7528\u7684QEMU\u73af\u5883\uff0c\u5219\u662f\u629b\u5f03\u4e86BIOS\u8fd9\u4e00\u8fc7\u7a0b\u3002\u5728QEMU\u4e0a\u76f4\u63a5\u4f7f\u7528 -kernel \u53c2\u6570\u6307\u5b9a\u5185\u6838\u7684ELF\u6587\u4ef6\uff0c\u672c\u8d28\u4e0a\u5c31\u662f\u5b8c\u6210\u4e86BIOS\u6240\u505a\u7684\u52a0\u8f7d\u5185\u6838\u7684\u8fc7\u7a0b\uff0c\u76f4\u63a5\u4eceELF\u6587\u4ef6\u7684\u5165\u53e3\u70b9\u5f00\u59cb\u542f\u52a8\u64cd\u4f5c\u7cfb\u7edf\u3002","title":"BIOS\u542f\u52a8\u8fc7\u7a0b"},{"location":"lab1/intro/#_2","text":"\u5f53bootloader\u901a\u8fc7\u628aucore\u5728\u7cfb\u7edf\u52a0\u8f7d\u5230\u5185\u5b58\u540e\uff0c\u5c31\u8f6c\u8df3\u5230ucore\u64cd\u4f5c\u7cfb\u7edf\u5728\u5185\u5b58\u4e2d\u7684\u5165\u53e3\u4f4d\u7f6e\uff08kern/start.S\u4e2d\u7684start\u7684\u5730\u5740\uff09\uff0c\u8fd9\u6837ucore\u5c31\u63a5\u7ba1\u4e86\u6574\u4e2a\u63a7\u5236\u6743\u3002\u5f53\u524d\u7684ucore\u529f\u80fd\u5f88\u7b80\u5355\uff0c\u53ea\u5b8c\u6210\u57fa\u672c\u7684\u5185\u5b58\u7ba1\u7406\u548c\u5916\u8bbe\u4e2d\u65ad\u7ba1\u7406\u3002ucore\u4e3b\u8981\u5b8c\u6210\u7684\u5de5\u4f5c\u5305\u62ec\uff1a \u914d\u7f6eDMW\uff0c\u4f7f\u5f97\u64cd\u4f5c\u7cfb\u7edf\u62e5\u6709\u53ef\u7528\u7684\u5730\u5740\u7a7a\u95f4\uff08\u4f4d\u4e8e kern/init/entry.S \uff0c\u5176\u5b83\u90e8\u5206\u5747\u4e3aC\u8bed\u8a00\u7a0b\u5e8f\uff0c\u6574\u4f53\u4f4d\u4e8e kern/init/init.c \uff09 \u521d\u59cb\u5316\u7ec8\u7aef\uff1b \u663e\u793a\u5b57\u7b26\u4e32\uff1b \u8bbe\u7f6e\u4f8b\u5916\u4e24\u4e2a\u4f8b\u5916\u5411\u91cf\uff1b \u6267\u884cwhile\uff081\uff09\u6b7b\u5faa\u73af\u3002 \u4ee5\u540e\u7684\u5b9e\u9a8c\u4e2d\u4f1a\u5927\u91cf\u6d89\u53ca\u5404\u4e2a\u51fd\u6570\u76f4\u63a5\u7684\u8c03\u7528\u5173\u7cfb\uff0c\u4ee5\u53ca\u7531\u4e8e\u4e2d\u65ad\u5904\u7406\u5bfc\u81f4\u7684\u5f02\u6b65\u73b0\u8c61\uff0c\u53ef\u80fd\u5bf9\u5927\u5bb6\u5b9e\u73b0\u64cd\u4f5c\u7cfb\u7edf\u548c\u6539\u6b63\u5176\u4e2d\u7684\u9519\u8bef\u6709\u5f88\u5927\u5f71\u54cd\u3002\u800c\u7406\u89e3\u597d\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u7684\u5efa\u7acb\u673a\u5236\u548c\u4e2d\u65ad\u5904\u7406\u673a\u5236\uff0c\u5bf9\u540e\u7eed\u5b9e\u9a8c\u4f1a\u6709\u5f88\u5927\u5e2e\u52a9\u3002","title":"\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u8fc7\u7a0b"},{"location":"lab1/intro/#_3","text":"uCore\u4e2d\u7684\u5730\u5740\u7a7a\u95f4\u6d89\u53ca\u4e24\u79cd\u5730\u5740\uff1a \u903b\u8f91\u5730\u5740\uff08Logical Address,\u5e94\u7528\u7a0b\u5e8f\u5458\u770b\u5230\u7684\u5730\u5740\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u4e0a\u79f0\u4e3a\u865a\u62df\u5730\u5740\uff0c\u4ee5\u540e\u63d0\u5230\u865a\u62df\u5730\u5740\u5c31\u662f\u6307\u903b\u8f91\u5730\u5740\uff09 \u7269\u7406\u5730\u5740\uff08Physical Address, \u5b9e\u9645\u7684\u7269\u7406\u5185\u5b58\u5730\u5740\uff09\u3002 (1) \u903b\u8f91\u5730\u5740\u7a7a\u95f4 \u4ece\u5e94\u7528\u7a0b\u5e8f\u7684\u89d2\u5ea6\u770b\uff0c\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u5c31\u662f\u5e94\u7528\u7a0b\u5e8f\u5458\u7f16\u7a0b\u6240\u7528\u5230\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u7a0b\u5e8f\u7247\u6bb5\uff1a int val=100; int * point=&val; \u5176\u4e2d\u6307\u9488\u53d8\u91cfpoint\u4e2d\u5b58\u50a8\u7684\u5373\u662f\u4e00\u4e2a\u903b\u8f91\u5730\u5740\u3002 (2) \u7269\u7406\u5730\u5740\u7a7a\u95f4 \u4ece\u64cd\u4f5c\u7cfb\u7edf\u7684\u89d2\u5ea6\u770b\uff0cCPU\u3001\u5185\u5b58\u786c\u4ef6\uff08\u901a\u5e38\u8bf4\u7684\u201c\u5185\u5b58\u6761\u201d\uff09\u548c\u5404\u79cd\u5916\u8bbe\u662f\u5b83\u4e3b\u8981\u7ba1\u7406\u7684\u786c\u4ef6\u8d44\u6e90\u800c\u5185\u5b58\u786c\u4ef6\u548c\u5916\u8bbe\u5206\u5e03\u5728\u7269\u7406\u5730\u5740\u7a7a\u95f4\u4e2d\u3002\u7269\u7406\u5730\u5740\u7a7a\u95f4\u5c31\u662f\u4e00\u4e2a\u201c\u5927\u6570\u7ec4\u201d\uff0cCPU\u901a\u8fc7\u7d22\u5f15\uff08\u7269\u7406\u5730\u5740\uff09\u6765\u8bbf\u95ee\u8fd9\u4e2a\u201c\u5927\u6570\u7ec4\u201d\u4e2d\u7684\u5185\u5bb9\u3002\u7269\u7406\u5730\u5740\u662f\u6307CPU\u63d0\u4ea4\u5230\u5185\u5b58\u603b\u7ebf\u4e0a\u7528\u4e8e\u8bbf\u95ee\u8ba1\u7b97\u673a\u5185\u5b58\u548c\u5916\u8bbe\u7684\u6700\u7ec8\u5730\u5740\u3002 \u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u5927\u5c0f\u53d6\u51b3\u4e8eCPU\u5b9e\u73b0\u7684\u7269\u7406\u5730\u5740\u4f4d\u6570\uff0cLoongArch32\u8ba1\u7b97\u673a\u4e2d\uff0cCPU\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\u53d6\u51b3\u4e8e\u5904\u7406\u5668\u914d\u7f6e\u7684PALEN\u3002\u800c\u5bf9\u4e8e\u5916\u8bbe\uff0c\u5219\u662f\u56fa\u5b9a\u914d\u7f6e\u4e8e0x1f000000~0x1fffffff\u3002\u4f8b\u5982\u6211\u4eec\u5982\u679c\u914d\u7f6eQEMU\u7684\u5185\u5b58\u4e3a256M\uff0c\u90a3\u4e48\u7269\u7406\u5730\u5740\u7a7a\u95f4\u5982\u4e0b\uff1a +------------------+ <- 0xFFFFFFFF (4GB) | \u65e0\u6548\u7a7a\u95f4 | +------------------+ <- 0x1FFFFFFF (512M) | IO\u5916\u8bbe\u5730\u5740\u7a7a\u95f4 | +------------------+ <- 0x1F000000 (496M) | \u65e0\u6548\u7a7a\u95f4 | +------------------+ <- 0x0FFFFFFF (256M) | \u6709\u6548\u5185\u5b58 | +------------------+ <- 0x00000000","title":"\u5730\u5740\u7a7a\u95f4"},{"location":"lab1/intro/#_4","text":"\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u5bf9\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u5404\u79cd\u5916\u8bbe\u8fdb\u884c\u7ba1\u7406\uff0c\u8fd9\u5c31\u9700\u8981CPU\u548c\u5916\u8bbe\u80fd\u591f\u76f8\u4e92\u901a\u4fe1\u624d\u884c\u3002\u4e00\u822c\u5916\u8bbe\u7684\u901f\u5ea6\u8fdc\u6162\u4e8eCPU\u7684\u901f\u5ea6\u3002\u5982\u679c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u901a\u8fc7CPU\u201c\u4e3b\u52a8\u5173\u5fc3\u201d\u5916\u8bbe\u7684\u4e8b\u4ef6\uff0c\u5373\u91c7\u7528\u901a\u5e38\u7684\u8f6e\u8be2(polling)\u673a\u5236\uff0c\u5219\u592a\u6d6a\u8d39CPU\u8d44\u6e90\u4e86\u3002\u6240\u4ee5\u9700\u8981\u64cd\u4f5c\u7cfb\u7edf\u548cCPU\u80fd\u591f\u4e00\u8d77\u63d0\u4f9b\u67d0\u79cd\u673a\u5236\uff0c\u8ba9\u5916\u8bbe\u5728\u9700\u8981\u64cd\u4f5c\u7cfb\u7edf\u5904\u7406\u5916\u8bbe\u76f8\u5173\u4e8b\u4ef6\u7684\u65f6\u5019\uff0c\u80fd\u591f\u201c\u4e3b\u52a8\u901a\u77e5\u201d\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5373\u6253\u65ad\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u7684\u6b63\u5e38\u6267\u884c\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u5916\u8bbe\u7684\u76f8\u5173\u5904\u7406\uff0c\u7136\u540e\u518d\u6062\u590d\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u7684\u6b63\u5e38\u6267\u884c\u3002\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u8fd9\u79cd\u673a\u5236\u79f0\u4e3a\u4e2d\u65ad\u673a\u5236\u3002\u4e2d\u65ad\u673a\u5236\u7ed9\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e86\u5904\u7406\u610f\u5916\u60c5\u51b5\u7684\u80fd\u529b\uff0c\u540c\u65f6\u5b83\u4e5f\u662f\u5b9e\u73b0\u8fdb\u7a0b/\u7ebf\u7a0b\u62a2\u5360\u5f0f\u8c03\u5ea6\u7684\u4e00\u4e2a\u91cd\u8981\u57fa\u77f3\u3002\u4f46\u4e2d\u65ad\u7684\u5f15\u5165\u4f1a\u5bfc\u81f4\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u7684\u7406\u89e3\u66f4\u52a0\u56f0\u96be\u3002 \u5728LoongArch32\u67b6\u6784\u4e2d\uff0c\u4e2d\u65ad\u5c5e\u4e8e\u5f02\u5e38(Exception)\u7684\u4e00\u79cd\uff0cuCore\u5185\u6838\u76ee\u524d\u5904\u7406\u7684\u5f02\u5e38\u5305\u62ec\u4ee5\u4e0b\u7c7b\u578b\uff1a \u4e2d\u65ad (EX_IRQ,CSR.ESTAT.Ecode=0) Load\u64cd\u4f5c\u9875\u65e0\u6548 (EX_TLBL,CSR.ESTAT.Ecode=1) Store\u64cd\u4f5c\u9875\u65e0\u6548(EX_TLBS,CSR.ESTAT.Ecode=2) TLB \u91cd\u586b (EX_TLBR,CSR.ESTAT.Ecode=31) \u6307\u4ee4\u4e0d\u5b58\u5728 (EX_RI,CSR.ESTAT.Ecode=13) \u6307\u4ee4\u7279\u6743\u7b49\u7ea7\u9519\u8bef(EX_IPE,CSR.ESTAT.Ecode=14) \u7cfb\u7edf\u8c03\u7528 (EX_SYS,CSR.ESTAT.Ecode=11) \u5730\u5740\u9519\u8bef\u4f8b\u5916 (EX_ADE,CSR.ESTAT.Ecode=8) \u4f8b\u5982\u5730\u5740\u6ca1\u6709\u5bf9\u9f50 LoongArch32\u67b6\u6784\u7684\u5904\u7406\u5668\u4e5f\u63d0\u4f9b\u4e86\u4e24\u4e2a\u4f8b\u5916\u5165\u53e3\u3002\u5206\u522b\u662f\u5e38\u89c4\u4f8b\u5916\u4e0eTLB\u4f8b\u5916\u3002\u7531\u4e8eTLB\u4f8b\u5916\u6d89\u53ca\u91cd\u586b\u9875\u8868\u7684\u5de5\u4f5c\uff0c\u56e0\u6b64\u5fc5\u987b\u4e3a\u7269\u7406\u5730\u5740\u3002\u800c\u5e38\u89c4\u4f8b\u5916\u5165\u53e3\u5219\u53ef\u4ee5\u6839\u636e\u76ee\u524d\u5904\u7406\u5668\u7684\u8fd0\u884c\u72b6\u6001\u9009\u62e9\u4f7f\u7528\u865a\u62df\u5730\u5740\u6216\u7269\u7406\u5730\u5740\u3002\u8fd9\u4e24\u4e2a\u4f8b\u5916\u5165\u53e3\u4e5f\u5b58\u50a8\u5728CSR\u5bc4\u5b58\u5668\u4e2d\uff0c\u540d\u79f0\u5206\u522b\u4e3aCSR.EBASE\u4e0eCSR.RFBASE\u3002uCore\u5bf9\u4e8eCSR.RFBASE\u7684\u5904\u7406\u91c7\u7528\u4e86\u4e24\u5c42\u8df3\u8f6c\u7684\u65b9\u5f0f\uff0c\u672c\u6b21\u5b9e\u9a8c\u6211\u4eec\u6682\u65f6\u4e0d\u8003\u8651RFBASE\u7684\u5904\u7406\u8fc7\u7a0b\u3002","title":"\u4e2d\u65ad\u4e0e\u5f02\u5e38"},{"location":"lab1/intro/#_5","text":"LoongArch32\u7684CSR\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65f6\u949f\u5b9a\u65f6\u5668\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u4ee5\u901a\u8fc7CSR\u6307\u4ee4\u914d\u7f6e\u8be5\u5b9a\u65f6\u5668\uff0c\u4ece\u800c\u5b9e\u73b0\u786c\u4ef6\u4ea7\u751f\u65f6\u949f\u4e2d\u65ad\uff0c\u4f7f\u5f97\u64cd\u4f5c\u7cfb\u7edf\u80fd\u591f\u8fdb\u884c\u5206\u65f6\u8c03\u5ea6\u3002 \u8fd9\u4e00\u90e8\u5206\u5927\u5bb6\u8bf7\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u7684 7.6\u5b9a\u65f6\u5668\u76f8\u5173\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668 \uff0c\u4ee5\u53ca 7.4.5\u4f8b\u5916\u72b6\u6001\uff08ESTAT\uff09 \u7684\u4ecb\u7ecd\u3002","title":"\u65f6\u949f\u4e2d\u65ad"},{"location":"lab1/intro/#_6","text":"\u6211\u4eec\u7684QEMU\u4ee5\u53caChiplab SoC\u4e0a\u90fd\u6709\u4e00\u4e2aNS16550a\u517c\u5bb9\u7684\u4e32\u53e3\u63a7\u5236\u5668\uff0c\u8be5\u63a7\u5236\u5668\u5728\u5f88\u591a\u79cd\u60c5\u51b5\u4e0b\u90fd\u4f1a\u6709\u4e2d\u65ad\u4ea7\u751f\uff08\u5927\u5bb6\u53ef\u4ee5\u81ea\u884c\u67e5\u9605ns16550\u6709\u5173\u8d44\u6599\uff09\uff0c\u5728\u672c\u5b9e\u9a8c\u4e2d\u6211\u4eec\u6682\u65f6\u53ea\u9700\u8981\u77e5\u9053\uff0c\u4e32\u53e3\u6709\u8f93\u5165\u65f6\u4f1a\u4ea7\u751f\u4e2d\u65ad\u3002 \u5728LoongArch32\u7684QEMU\u4ee5\u53caChiplab SoC\u4e0a\uff0c\u4e32\u53e3\u8fde\u63a5\u7684\u4e2d\u65ad\u4e3aHWI[0]\u3002","title":"\u4e32\u53e3\u4e2d\u65ad"},{"location":"lab1/intro/#_7","text":"\u5f53\u4f8b\u5916\u4ea7\u751f\u65f6\uff0c\u5904\u7406\u5668 \u786c\u4ef6 \u4f1a\u8fdb\u884c\u5982\u4e0b\u64cd\u4f5c\uff08\u8fd9\u4e9b\u64cd\u4f5c\u7531\u786c\u4ef6\u5b8c\u6210\uff0c\u4e0d\u4f1a\u51fa\u73b0\u5728\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\u4e2d\uff09\uff1a \u5c06CSR.CRMD\u7684PLV\u3001IE\u5206\u522b\u5b58\u5230CSR.PRMD\u7684PPLV\u548cIE\u4e2d\uff0c\u7136\u540e\u5c06CSR.CRMD\u7684PLV\u7f6e\u4e3a0\uff0cIE\u7f6e\u4e3a0\u3002 \u5c06\u89e6\u53d1\u4f8b\u5916\u6307\u4ee4\u7684PC\u503c\u8bb0\u5f55\u5230CSR.ERA\u4e2d \u8df3\u8f6c\u5230\u4f8b\u5916\u5165\u53e3\u5904\u53d6\u503c\u3002\uff08\u5982\u679c\u662fTLB\u76f8\u5173\u4f8b\u5916\u8df3\u8f6c\u5230CSR.RFBASE\uff0c\u5426\u5219\u4e3aCSR.EBASE\uff09 \u7136\u540e\u5c06PC\u8df3\u8f6c\u5230\u5bf9\u5e94\u7684\u4f8b\u5916\u5165\u53e3\u5730\u5740\u5904\uff0c\u4ea4\u7ed9\u8f6f\u4ef6\u5b8c\u6210\u4f8b\u5916\u7684\u5904\u7406\u64cd\u4f5c\u3002 Note \u66f4\u52a0\u8be6\u7ec6\u7684\u4fe1\u606f\u8bf7\u540c\u5b66\u4eec\u81ea\u884c\u9605\u8bfb \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u3002\u5173\u4e8e\u4e2d\u65ad\u4ea7\u751f\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u9605\u8bfb\u8be5\u6587\u6863\u76846.1.4\u90e8\u5206\u3002 Note \u5c0f\u601d\u8003\uff1a\u4e3a\u4ec0\u4e48\u8fdb\u5165\u5f02\u5e38\u5904\u7406\u65f6\u8981\u5173\u95ed\u4e2d\u65ad\uff1f \u8fd9\u91cc\u7ed9\u51fa\u53c2\u8003\u7b54\u6848\uff1a \u82e5\u4e0d\u5173\u95ed\uff0c\u8003\u8651\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\uff1a \u5f02\u5e38\u7c7b\u578b\u662f\u4e2d\u65ad \u5904\u7406\u5668\u7531\u4e8e\u4e2d\u65ad\u5f02\u5e38\u8df3\u8f6c\u5230\u4e86\u5f02\u5e38\u5165\u53e3\u70b9\uff0c\u6b64\u65f6\u4e2d\u65ad\u4fe1\u53f7\u8fd8\u6ca1\u6709\u54cd\u5e94\u4f7f\u5176\u6e05\u9664\uff0c\u5904\u7406\u5668\u7ee7\u7eed\u6ee1\u8db3\u4e2d\u65ad\u4ea7\u751f\u6761\u4ef6\uff0c\u5219\u7ee7\u7eed\u8df3\u8f6c\u4e2d\u65ad\u5165\u53e3\u70b9\uff0c\u4f1a\u5bfc\u81f4\u6b7b\u5faa\u73af\u3002 \u5f02\u5e38\u7c7b\u578b\u4e0d\u662f\u4e2d\u65ad \u82e5\u5728\u5f02\u5e38\u5904\u7406\u65f6\u53d1\u751f\u4e2d\u65ad\uff08\u4f8b\u5982\u5916\u8bbe\u6709\u6570\u636e\u5230\u8fbe\u3001\u5b9a\u65f6\u5668\u4ea7\u751f\u65f6\u949f\u4e2d\u65ad\u7b49\u60c5\u51b5\uff09\uff0c\u4f1a\u5bfc\u81f4\u5f02\u5e38\u4e0a\u4e0b\u6587\u88ab\u7834\u574f\uff0c\u4ece\u800c\u5bfc\u81f4\u4e0a\u4e00\u4e2a\u5f02\u5e38\u5e94\u8be5\u4fdd\u5b58\u7684\u72b6\u6001\u8fd8\u6ca1\u5b58\u4e0b\u6765\uff0c\u4e0b\u4e00\u4e2a\u5f02\u5e38\u7ee7\u7eed\u4ea7\u751f\uff0c\u4ece\u800c\u65e0\u6cd5\u6062\u590d\u539f\u6765\u7684\u73b0\u573a\u3002 \uff08\u540c\u5b66\u4eec\u53ef\u4ee5\u601d\u8003uCore\u4e2d\u7684trapframe\u4fdd\u5b58\u65f6\u518d\u6b21\u51fa\u73b0\u4e00\u4e2a\u4e2d\u65ad\u4f1a\u51fa\u73b0\u4ec0\u4e48\u60c5\u51b5\uff1f\uff09 Note \u5c0f\u601d\u8003\uff1a\u4e3a\u4ec0\u4e48TLB\u91cd\u586b\u5f02\u5e38\u91c7\u7528\u4e86\u5173\u95ed\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u91c7\u7528\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u7684\u8bbe\u8ba1\uff1f \u540c\u5b66\u4eec\u53ef\u4ee5\u505a\u5b8cLab2\u540e\u5c1d\u8bd5\u56de\u7b54\u6b64\u95ee\u9898\u3002 \u8be5\u95ee\u9898\u6709\u591a\u4e2a\u89d2\u5ea6\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u8003\u8651\u5206\u89e3\u540e\u7684\u4ee5\u4e0b\u5b50\u95ee\u9898\uff1a \u5982\u679c\u5185\u5b58\u8d85\u8fc7512M\uff0c\u4e14\u9875\u8868\u4f1a\u653e\u5728\u7269\u7406\u5185\u5b58\u4efb\u610f\u4f4d\u7f6e\uff0cDMW\u65b9\u6848\u8fd8\u662f\u5426\u53ef\u884c\uff1f TLB Miss\u76f8\u5bf9\u4e8e\u9875\u65e0\u6548/\u9875\u4fee\u6539\u662f\u9891\u7387\u9ad8\u5f97\u591a\u7684\u4e8b\u4ef6\uff0c\u5982\u679c\u5e0c\u671bTLB Miss\u65f6OS\u80fd\u591f\u5c3d\u5feb\u5b8c\u6210TLB\u91cd\u586b\uff0c\u5e94\u8be5\u5982\u4f55\u6539\u5199uCore\u4ee3\u7801\uff1f \u540c\u5b66\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u9605\u8bfbLinux\u4e2d\u5bf9\u4e8e\u540c\u6837\u662f\u8f6f\u4ef6\u63a7\u5236TLB\u7684MIPS\u67b6\u6784\u7684\u4ee3\u7801\u3002","title":"\u4f8b\u5916\u4ea7\u751f"},{"location":"lab1/intro/#_8","text":"\u5bf9\u4e8euCore\uff0cCSR.EBASE\u5728\u5185\u6838\u521d\u59cb\u5316\u9636\u6bb5\uff08\u4f4d\u4e8e kern/init/init.c \u7684 setup_exception_vector \u51fd\u6570\uff09\u4f1a\u88ab\u521d\u59cb\u5316\u4e3a exception_handler \u7b26\u53f7\u5bf9\u5e94\u7684\u6307\u9488\uff08\u4f4d\u4e8e kern/trap/exceptions.S \uff09\u3002 \u5728 kern/trap/exceptions.S \u4e2d\uff0c\u4f1a\u5b8c\u6210\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u5c06t0\u3001t1\u4fdd\u5b58\u5230CSR\u7684KS0\u3001KS1\u4e2d\uff0c\u4ee5\u4fbf\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e24\u4e2aGPR\u6765\u5b58\u50a8\u4e00\u4e9b\u6570\u636e\u800c\u4e0d\u5fc5\u7834\u574f\u4f8b\u5916\u73b0\u573a\u3002 \u5224\u65ad\u5f02\u5e38\u662f\u5426\u53d1\u751f\u5728\u7528\u6237\u6001\uff0c\u82e5\u662f\uff0c\u5207\u6362\u6808\u4e3a\u5185\u6838\u6808\u3002 \u5728\u6808\u4e0a\u5f00\u8f9f\u8db3\u591f\u5b58\u50a8 trapframe \u6570\u636e\u7ed3\u6784\u7684\u7a7a\u95f4\uff08\u4f4d\u4e8e kern/trap/loongarch_trapframe.h \uff09\uff0c\u5c06\u5f02\u5e38\u53d1\u751f\u73b0\u573a\u6309\u7167trapframe\u7ed3\u6784\u4fdd\u5b58\u5728\u6808\u4e2d\u3002 \u6ce8\uff1a\u5176\u4e2d\u7684pushreg\u7ed3\u6784\u53ea\u4fdd\u5b5830\u4e2aGPR\u5bc4\u5b58\u5668\uff0c\u800c\u4e0d\u662f32\u4e2a\u3002 \u8fd9\u662f\u56e0\u4e3a0\u53f7\u5bc4\u5b58\u5668\u6a2a\u4e3a0\u4e0d\u53ef\u5199\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u4fdd\u5b58\uff0c1\u53f7\u5bc4\u5b58\u5668\u5728ABI\u4e2d\u610f\u4e49\u662fRA\uff0c\u5df2\u7ecf\u4fdd\u5b58\u5728\u4e86trapframe\u4e2d\u7684tf_ra\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cra\u5bc4\u5b58\u5668\u4e0eCSR.ERA\u610f\u4e49\u4e0d\u540c\u3002ra\u5bc4\u5b58\u5668\u5728ABI\u4e0a\u5b58\u50a8\u7684\u662f\u7a0b\u5e8f\u8fd0\u884c\u4e2d\u51fd\u6570return\u7684\u8fd4\u56de\u5730\u5740\uff0c\u800cCSR.ERA\u5b58\u50a8\u7684\u662f\u4f8b\u5916\u4ea7\u751f\u65f6\u8fd8\u6ca1\u63d0\u4ea4\u7684PC\u5730\u5740\u3002 \u6570\u636e\u4fdd\u5b58\u540e\uff0c\u5c06a0\u5bc4\u5b58\u5668\u4fdd\u5b58\u4e3a\u6307\u5411trapframe\u7684\u6307\u9488 \u6839\u636eABI\u5b9a\u4e49\uff0ca0\u4fdd\u5b58\u7684\u662f\u51fd\u6570\u8c03\u7528\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\uff0c\u8fd9\u6837C\u8bed\u8a00\u7f16\u5199\u7684loongarch_trap\u51fd\u6570\u8bfb\u53d6\u8be5\u53c2\u6570\u5373\u8bfb\u53d6a0\u7684\u503c\u3002 \u8df3\u8f6c\u5230loongarch_trap\u51fd\u6570 \u4e4b\u540e\u7684C\u8bed\u8a00\u4ee3\u7801\u7f16\u5199\u7684\u90e8\u5206\u4e0d\u8be6\u7ec6\u5c55\u5f00\uff0c\u8bf7\u540c\u5b66\u4eec\u81ea\u884c\u9605\u8bfb\u4ee3\u7801\u3002 Note \u5c0f\u601d\u8003\uff1a\u4e3a\u4ec0\u4e48\u9700\u8981\u5207\u6362\u4e3a\u5185\u6838\u6808\uff1f\u76f4\u63a5\u8ba9\u5185\u6838\u8dd1\u5728\u7528\u6237\u7a0b\u5e8f\u7684\u6808\u4e0a\u662f\u5426\u53ef\u884c\uff1f \u8003\u8651\u4ee5\u4e0b\u89d2\u5ea6\uff1a 1. \u5185\u6838\u6808\u6cc4\u9732\u7ed9\u7528\u6237\u7a0b\u5e8f\u662f\u5426\u5bfc\u81f4\u5b89\u5168\u95ee\u9898\uff1f 2. \u7528\u6237\u7a0b\u5e8f\u8dd1\u5728\u865a\u62df\u5730\u5740\uff0c\u8bfb\u5199\u7528\u6237\u6808\u53ef\u80fd\u4f1a\u4ea7\u751f\u4ec0\u4e48\u95ee\u9898\uff1f\uff08\u53ef\u4ee5\u505a\u5b8c\u540e\u7eedLab\u540e\u518d\u601d\u8003\u8be5\u5b50\u95ee\u9898\uff09","title":"\u64cd\u4f5c\u7cfb\u7edf\u54cd\u5e94\u5f02\u5e38"},{"location":"lab1/intro/#_9","text":"\u5f53loongarch_trap\u51fd\u6570\u7ed3\u675f\u540e\uff0c\u7531\u4e8e\u6211\u4eec\u8df3\u8f6c\u65f6\u5199\u4e86ra\u5bc4\u5b58\u5668\uff0c\u6b64\u65f6\u4f1a\u56de\u5230\u8df3\u8f6c\u524d\u7684\u4f4d\u7f6e\u3002 \u8be5\u4f4d\u7f6e\u4e5f\u5c31\u662f kern/trap/exception.S \u7684jirl\u5230loongarch_trap\u7684\u4e0b\u4e00\u6761\u6307\u4ee4\uff0c\u5bf9\u5e94\u7684\u662fexception_return\u7b26\u53f7\u7684\u5f00\u59cb\u3002 \u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u5c06\u4e4b\u524d\u4fdd\u5b58\u7684trapframe\u4e2d\u7684\u4fe1\u606f\u4ece\u6808\u4e0a\u8fd8\u539f\uff0c\u7136\u540e\u8c03\u7528ertn\u6307\u4ee4\uff0c\u8be5\u6307\u4ee4\u4f1a\u5b8c\u6210\u5982\u4e0b\u64cd\u4f5c\uff1a \u5c06CSR.PRMD\u4e2d\u7684PPLV\u3001PIE\u503c\u56de\u590d\u5230CSR.CRMD\u7684PLV\u3001IE\u4e2d\u3002 \u8df3\u8f6c\u5230CSR.ERA\u6240\u8bb0\u5f55\u7684\u5730\u5740\u5904\u53d6\u6307\u3002 Note \u5c0f\u601d\u8003\uff1a\u6211\u4eec\u5728loongarch_trap\u51fd\u6570\u4e2d\u7ee7\u7eed\u8c03\u7528\u4e86trap_dispatch\uff0c\u6b64\u65f6\u662f\u5426\u4f1a\u6539\u53d8ra\u5bc4\u5b58\u5668\u7684\u503c\uff1f\u5982\u679c\u6539\u53d8\u4e86\uff0c\u539f\u672c\u7684ra\u4f1a\u88ab\u5b58\u50a8\u5728\u4ec0\u4e48\u4f4d\u7f6e\uff1f \u540c\u5b66\u4eec\u53ef\u4ee5\u56de\u5fc6\u7a0b\u5e8f\u8fd0\u884c\u65f6\u7684\u6808\u662f\u505a\u4ec0\u4e48\u7528\u7684\uff0c\u4ee5\u53ca\u9605\u8bfbLoongArch32\u7684ABI\u6587\u6863\u4ee5\u53ca\u5176\u4ed6\u67b6\u6784\u7684ABI\u6587\u6863\u3002","title":"\u4f8b\u5916\u5904\u7406\u8fd4\u56de"},{"location":"lab1/step/","text":"\u5b9e\u9a8c\u6b65\u9aa4\u5982\u4e0b \u00b6 \u5f02\u5e38\u4e2d\u65ad \u00b6 \u6839\u636e\u5b9e\u9a8c\u4efb\u52a1\u201c\u5f02\u5e38\u4e2d\u65ad\u201d\u7684\u95ee\u9898\uff082\uff09\u548c\uff083\uff09\u7ed3\u5408\u6240\u5b66\u77e5\u8bc6\u5b8c\u6210\u76f8\u5173\u7a0b\u5e8f\u7684\u64b0\u5199\uff0c\u800c\u540e\u6309\u7167\u5982\u4e0b\u6b65\u9aa4\u68c0\u9a8c\u7a0b\u5e8f\u3002 Makefile\u4fee\u6539 LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT # LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 # LAB3 := -DLAB3_EX1 -DLAB3_EX2 # LAB4 := -DLAB4_EX1 -DLAB4_EX2 -D_SHOW_100_TICKS\u9009\u9879\u53ef\u5728\u7ec8\u7aef\u6bcf\u662f\u6beb\u79d2\u6253\u5370\u4e00\u884c\"100 ticks\" -D_SHOW_SERIAL_INPUT\u9009\u9879\u4f1a\u5728\u7ec8\u7aef\u6253\u5370\u952e\u76d8\u7684\u8f93\u5165 \u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a make make qemu -j 16 \u6ce8\uff1a\u5982\u679cmake\u540e\u62a5\u9519\uff0c\u9996\u5148\u68c0\u67e5\u662f\u5426\u4f7f\u7528\u4e86Dockers\uff0c\u5176\u6b21\u5728\u5207\u6362\u5b9e\u9a8c\u7684\u65f6\u5019\uff08\u5373\u4f7f\u7528\u4e0d\u540c\u7684makefile\u65f6\uff09\u9700\u8981\u4f7f\u7528 make clean \u8fdb\u884c\u5207\u6362\uff09 \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 chenyu$ make qemu -j 16 ( THU.CST ) os is loading ... Special kernel symbols: entry 0xA00000A0 ( phys ) etext 0xA001F000 ( phys ) edata 0xA0151820 ( phys ) end 0xA0154B00 ( phys ) Kernel executable memory footprint: 1239KB LAB1 Check - Please press your keyboard manually and see what happend. 100 ticks 100 ticks 100 ticks 100 ticks 100 ticks 100 ticks 100 ticks got input 100 ticks got input s got input d got input g 100 ticks got input s got input g 100 ticks","title":"\u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab1/step/#_1","text":"","title":"\u5b9e\u9a8c\u6b65\u9aa4\u5982\u4e0b"},{"location":"lab1/step/#_2","text":"\u6839\u636e\u5b9e\u9a8c\u4efb\u52a1\u201c\u5f02\u5e38\u4e2d\u65ad\u201d\u7684\u95ee\u9898\uff082\uff09\u548c\uff083\uff09\u7ed3\u5408\u6240\u5b66\u77e5\u8bc6\u5b8c\u6210\u76f8\u5173\u7a0b\u5e8f\u7684\u64b0\u5199\uff0c\u800c\u540e\u6309\u7167\u5982\u4e0b\u6b65\u9aa4\u68c0\u9a8c\u7a0b\u5e8f\u3002 Makefile\u4fee\u6539 LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT # LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 # LAB3 := -DLAB3_EX1 -DLAB3_EX2 # LAB4 := -DLAB4_EX1 -DLAB4_EX2 -D_SHOW_100_TICKS\u9009\u9879\u53ef\u5728\u7ec8\u7aef\u6bcf\u662f\u6beb\u79d2\u6253\u5370\u4e00\u884c\"100 ticks\" -D_SHOW_SERIAL_INPUT\u9009\u9879\u4f1a\u5728\u7ec8\u7aef\u6253\u5370\u952e\u76d8\u7684\u8f93\u5165 \u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a make make qemu -j 16 \u6ce8\uff1a\u5982\u679cmake\u540e\u62a5\u9519\uff0c\u9996\u5148\u68c0\u67e5\u662f\u5426\u4f7f\u7528\u4e86Dockers\uff0c\u5176\u6b21\u5728\u5207\u6362\u5b9e\u9a8c\u7684\u65f6\u5019\uff08\u5373\u4f7f\u7528\u4e0d\u540c\u7684makefile\u65f6\uff09\u9700\u8981\u4f7f\u7528 make clean \u8fdb\u884c\u5207\u6362\uff09 \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 chenyu$ make qemu -j 16 ( THU.CST ) os is loading ... Special kernel symbols: entry 0xA00000A0 ( phys ) etext 0xA001F000 ( phys ) edata 0xA0151820 ( phys ) end 0xA0154B00 ( phys ) Kernel executable memory footprint: 1239KB LAB1 Check - Please press your keyboard manually and see what happend. 100 ticks 100 ticks 100 ticks 100 ticks 100 ticks 100 ticks 100 ticks got input 100 ticks got input s got input d got input g 100 ticks got input s got input g 100 ticks","title":"\u5f02\u5e38\u4e2d\u65ad"},{"location":"lab1/task/","text":"\u5b9e\u9a8c\u4efb\u52a1 \u00b6 \u5f02\u5e38\u4e2d\u65ad \u00b6 \u7ec3\u4e601 \u00b6 \u7ed3\u5408LoongArch32\u7684\u6587\u6863\uff0c\u5217\u51faLoongArch32\u6709\u54ea\u4e9b\u4f8b\u5916\uff1f\u4ee5\u53ca\u8fd9\u4e9b\u4f8b\u5916\u6709\u54ea\u4e24\u4e2a\u4f8b\u5916\u5411\u91cf\u5165\u53e3\uff1f \u7ec3\u4e602 \u00b6 \u8bf7\u7f16\u7a0b\u5b8c\u5584 kern/driver/clock.c \u4e2d\u7684\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u51fd\u6570 clock_int_handler \uff0c\u5728\u5bf9\u65f6\u949f\u4e2d\u65ad\u8fdb\u884c\u5904\u7406\u7684\u90e8\u5206\u586b\u5199trap\u51fd\u6570\u4e2d\u5904\u7406\u65f6\u949f\u4e2d\u65ad\u7684\u90e8\u5206\uff0c\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u6bcf\u9047\u5230100\u6b21\u65f6\u949f\u4e2d\u65ad\u540e\uff0c\u8c03\u7528kprintf\uff0c\u5411\u5c4f\u5e55\u4e0a\u6253\u5370\u4e00\u884c\u6587\u5b57\u201d100 ticks\u201d\u3002 \u7ec3\u4e603 \u00b6 \u8bf7\u7f16\u7a0b\u5b8c\u5584 kern/driver/console.c \u4e2d\u7684\u4e32\u53e3\u4e2d\u65ad\u5904\u7406\u51fd\u6570 serial_int_handler \uff0c\u5728\u63a5\u6536\u5230\u4e00\u4e2a\u5b57\u7b26\u540e\u8bfb\u53d6\u8be5\u5b57\u7b26\uff0c\u5e76\u8c03\u7528kprintf\u8f93\u51fa\u8be5\u5b57\u7b26\u3002 \u8981\u6c42\u5b8c\u6210\u7ec3\u4e60\uff082\uff09\u3001\uff083\uff09\u63d0\u51fa\u7684\u76f8\u5173\u51fd\u6570\u5b9e\u73b0\uff0c\u63d0\u4ea4\u6539\u8fdb\u540e\u7684\u6e90\u4ee3\u7801\u5305\uff08\u53ef\u4ee5\u7f16\u8bd1\u6267\u884c\uff09\uff0c\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u5b9e\u73b0\u8fc7\u7a0b\uff0c\u5e76\u5199\u51fa\u5bf9\u7ec3\u4e60\uff081\uff09\u7684\u56de\u7b54\u3002\u5b8c\u6210\u8fd9\u7ec3\u4e60\uff082\uff09\u548c\uff083\uff09\u8981\u6c42\u7684\u90e8\u5206\u4ee3\u7801\u540e\uff0c\u8fd0\u884c\u6574\u4e2a\u7cfb\u7edf\uff0c\u53ef\u4ee5\u770b\u5230\u5927\u7ea6\u6bcf1\u79d2\u4f1a\u8f93\u51fa\u4e00\u6b21\u201d100 ticks\u201d\uff0c\u800c\u6309\u4e0b\u7684\u952e\u4e5f\u4f1a\u5728\u5c4f\u5e55\u4e0a\u663e\u793a\u3002 \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u5b8c\u6210\u4ee5\u4e0a\u4e09\u4e2a\u7ec3\u4e60\uff0c\u7ed9\u51fa\u7f16\u8bd1\u8fd0\u884c\u540e\u8f93\u51fa\u7ed3\u679c\u7684\u622a\u56fe\u3002\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u5bf9\u6240\u5199\u4ee3\u7801\u8c03\u7528\u7684\u51fd\u6570\u7684\u4f5c\u7528\u52a0\u4ee5\u8bf4\u660e\u3002 \u9700\u63d0\u4ea4\u53ef\u4ee5\u5728\u6211\u4eec\u7ed9\u5b9a\u7684Docker\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528make qemu\u7f16\u8bd1\u5e76\u8fd0\u884c\u7684\u6587\u4ef6\u5939\u7684\u538b\u7f29\u5305\u3002 \u7ec4\u961f\u5206\u5de5\u5efa\u8bae \u00b6 \u5efa\u8bae\u4e09\u4eba\u90fd\u9605\u8bfbLoongArch32\u6587\u6863\u4e0euCore\u4ee3\u7801\u540e\uff0c\u5206\u522b\u5b8c\u6210\u4e0a\u8ff03\u4e2a\u7ec3\u4e60\u3002","title":"\u5b9e\u9a8c\u4efb\u52a1"},{"location":"lab1/task/#_1","text":"","title":"\u5b9e\u9a8c\u4efb\u52a1"},{"location":"lab1/task/#_2","text":"","title":"\u5f02\u5e38\u4e2d\u65ad"},{"location":"lab1/task/#1","text":"\u7ed3\u5408LoongArch32\u7684\u6587\u6863\uff0c\u5217\u51faLoongArch32\u6709\u54ea\u4e9b\u4f8b\u5916\uff1f\u4ee5\u53ca\u8fd9\u4e9b\u4f8b\u5916\u6709\u54ea\u4e24\u4e2a\u4f8b\u5916\u5411\u91cf\u5165\u53e3\uff1f","title":"\u7ec3\u4e601"},{"location":"lab1/task/#2","text":"\u8bf7\u7f16\u7a0b\u5b8c\u5584 kern/driver/clock.c \u4e2d\u7684\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u51fd\u6570 clock_int_handler \uff0c\u5728\u5bf9\u65f6\u949f\u4e2d\u65ad\u8fdb\u884c\u5904\u7406\u7684\u90e8\u5206\u586b\u5199trap\u51fd\u6570\u4e2d\u5904\u7406\u65f6\u949f\u4e2d\u65ad\u7684\u90e8\u5206\uff0c\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u6bcf\u9047\u5230100\u6b21\u65f6\u949f\u4e2d\u65ad\u540e\uff0c\u8c03\u7528kprintf\uff0c\u5411\u5c4f\u5e55\u4e0a\u6253\u5370\u4e00\u884c\u6587\u5b57\u201d100 ticks\u201d\u3002","title":"\u7ec3\u4e602"},{"location":"lab1/task/#3","text":"\u8bf7\u7f16\u7a0b\u5b8c\u5584 kern/driver/console.c \u4e2d\u7684\u4e32\u53e3\u4e2d\u65ad\u5904\u7406\u51fd\u6570 serial_int_handler \uff0c\u5728\u63a5\u6536\u5230\u4e00\u4e2a\u5b57\u7b26\u540e\u8bfb\u53d6\u8be5\u5b57\u7b26\uff0c\u5e76\u8c03\u7528kprintf\u8f93\u51fa\u8be5\u5b57\u7b26\u3002 \u8981\u6c42\u5b8c\u6210\u7ec3\u4e60\uff082\uff09\u3001\uff083\uff09\u63d0\u51fa\u7684\u76f8\u5173\u51fd\u6570\u5b9e\u73b0\uff0c\u63d0\u4ea4\u6539\u8fdb\u540e\u7684\u6e90\u4ee3\u7801\u5305\uff08\u53ef\u4ee5\u7f16\u8bd1\u6267\u884c\uff09\uff0c\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u5b9e\u73b0\u8fc7\u7a0b\uff0c\u5e76\u5199\u51fa\u5bf9\u7ec3\u4e60\uff081\uff09\u7684\u56de\u7b54\u3002\u5b8c\u6210\u8fd9\u7ec3\u4e60\uff082\uff09\u548c\uff083\uff09\u8981\u6c42\u7684\u90e8\u5206\u4ee3\u7801\u540e\uff0c\u8fd0\u884c\u6574\u4e2a\u7cfb\u7edf\uff0c\u53ef\u4ee5\u770b\u5230\u5927\u7ea6\u6bcf1\u79d2\u4f1a\u8f93\u51fa\u4e00\u6b21\u201d100 ticks\u201d\uff0c\u800c\u6309\u4e0b\u7684\u952e\u4e5f\u4f1a\u5728\u5c4f\u5e55\u4e0a\u663e\u793a\u3002","title":"\u7ec3\u4e603"},{"location":"lab1/task/#_3","text":"\u5b8c\u6210\u4ee5\u4e0a\u4e09\u4e2a\u7ec3\u4e60\uff0c\u7ed9\u51fa\u7f16\u8bd1\u8fd0\u884c\u540e\u8f93\u51fa\u7ed3\u679c\u7684\u622a\u56fe\u3002\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u5bf9\u6240\u5199\u4ee3\u7801\u8c03\u7528\u7684\u51fd\u6570\u7684\u4f5c\u7528\u52a0\u4ee5\u8bf4\u660e\u3002 \u9700\u63d0\u4ea4\u53ef\u4ee5\u5728\u6211\u4eec\u7ed9\u5b9a\u7684Docker\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528make qemu\u7f16\u8bd1\u5e76\u8fd0\u884c\u7684\u6587\u4ef6\u5939\u7684\u538b\u7f29\u5305\u3002","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab1/task/#_4","text":"\u5efa\u8bae\u4e09\u4eba\u90fd\u9605\u8bfbLoongArch32\u6587\u6863\u4e0euCore\u4ee3\u7801\u540e\uff0c\u5206\u522b\u5b8c\u6210\u4e0a\u8ff03\u4e2a\u7ec3\u4e60\u3002","title":"\u7ec4\u961f\u5206\u5de5\u5efa\u8bae"},{"location":"lab2/code/","text":"\u4ee5\u9875\u4e3a\u5355\u4f4d\u7ba1\u7406\u7269\u7406\u5185\u5b58 \u00b6 \u5728\u83b7\u5f97\u53ef\u7528\u7269\u7406\u5185\u5b58\u8303\u56f4\u540e\uff0c\u7cfb\u7edf\u9700\u8981\u5efa\u7acb\u76f8\u5e94\u7684\u6570\u636e\u7ed3\u6784\u6765\u7ba1\u7406\u4ee5\u7269\u7406\u9875\uff08\u63094KB\u5bf9\u9f50\uff0c\u4e14\u5927\u5c0f\u4e3a4KB\u7684\u7269\u7406\u5185\u5b58\u5355\u5143\uff09\u4e3a\u6700\u5c0f\u5355\u4f4d\u7684\u6574\u4e2a\u7269\u7406\u5185\u5b58\uff0c\u4ee5\u914d\u5408\u540e\u7eed\u6d89\u53ca\u7684\u5206\u9875\u7ba1\u7406\u673a\u5236\u3002\u6bcf\u4e2a\u7269\u7406\u9875\u53ef\u4ee5\u7528\u4e00\u4e2aPage\u6570\u636e\u7ed3\u6784\u6765\u8868\u793a\u3002\u7531\u4e8e\u4e00\u4e2a\u7269\u7406\u9875\u9700\u8981\u5360\u7528\u4e00\u4e2aPage\u7ed3\u6784\u7684\u7a7a\u95f4\uff0cPage\u7ed3\u6784\u5728\u8bbe\u8ba1\u65f6\u987b\u5c3d\u53ef\u80fd\u5c0f\uff0c\u4ee5\u51cf\u5c11\u5bf9\u5185\u5b58\u7684\u5360\u7528\u3002Page\u7684\u5b9a\u4e49\u5728kern/mm/memlayout.h\u4e2d\u3002\u4ee5\u9875\u4e3a\u5355\u4f4d\u7684\u7269\u7406\u5185\u5b58\u5206\u914d\u7ba1\u7406\u7684\u5b9e\u73b0\u5728kern/default_pmm.c\u4e2d\u3002 \u4e3a\u4e86\u4e0e\u4ee5\u540e\u7684\u5206\u9875\u673a\u5236\u914d\u5408\uff0c\u6211\u4eec\u9996\u5148\u9700\u8981\u5efa\u7acb\u5bf9\u6574\u4e2a\u8ba1\u7b97\u673a\u7684\u6bcf\u4e00\u4e2a\u7269\u7406\u9875\u7684\u5c5e\u6027\u7528\u7ed3\u6784Page\u6765\u8868\u793a\uff0c\u5b83\u5305\u542b\u4e86\u6620\u5c04\u6b64\u7269\u7406\u9875\u7684\u865a\u62df\u9875\u4e2a\u6570\uff0c\u63cf\u8ff0\u7269\u7406\u9875\u5c5e\u6027\u7684flags\u548c\u53cc\u5411\u94fe\u63a5\u5404\u4e2aPage\u7ed3\u6784\u7684page_link\u53cc\u5411\u94fe\u8868\u3002 struct Page { int ref ; // page frame's reference counter uint32_t flags ; // array of flags that describe the status of the page frame unsigned int property ; // used in buddy system, stores the order (the X in 2^X) of the continuous memory block int zone_num ; // used in buddy system, the No. of zone which the page belongs to list_entry_t page_link ; // free list link list_entry_t swap_link ; // swap hash link }; \u8fd9\u91cc\u770b\u770bPage\u6570\u636e\u7ed3\u6784\u7684\u5404\u4e2a\u6210\u5458\u53d8\u91cf\u6709\u4f55\u5177\u4f53\u542b\u4e49\u3002ref\u8868\u793a\u8fd9\u9875\u88ab\u9875\u8868\u7684\u5f15\u7528\u8bb0\u6570\uff08\u5728\u201c\u5b9e\u73b0\u5206\u9875\u673a\u5236\u201d\u4e00\u8282\u4f1a\u8bb2\u5230\uff09\u3002\u5982\u679c\u8fd9\u4e2a\u9875\u88ab\u9875\u8868\u5f15\u7528\u4e86\uff0c\u5373\u5728\u67d0\u9875\u8868\u4e2d\u6709\u4e00\u4e2a\u9875\u8868\u9879\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u865a\u62df\u9875\u5230\u8fd9\u4e2aPage\u7ba1\u7406\u7684\u7269\u7406\u9875\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u5c31\u4f1a\u628aPage\u7684ref\u52a0\u4e00\uff1b\u53cd\u4e4b\uff0c\u82e5\u9875\u8868\u9879\u53d6\u6d88\uff0c\u5373\u6620\u5c04\u5173\u7cfb\u89e3\u9664\uff0c\u5c31\u4f1a\u628aPage\u7684ref\u51cf\u4e00\u3002flags\u8868\u793a\u6b64\u7269\u7406\u9875\u7684\u72b6\u6001\u6807\u8bb0\uff0c\u8fdb\u4e00\u6b65\u67e5\u770bkern/mm/memlayout.h\u4e2d\u7684\u5b9a\u4e49\uff0c\u53ef\u4ee5\u770b\u5230\uff1a /* Flags describing the status of a page frame */ #define PG_reserved 0 // the page descriptor is reserved for kernel or unusable #define PG_property 1 // the member 'property' is valid #define PG_slab 2 // page frame is included in a slab #define PG_dirty 3 // the page has been modified #define PG_swap 4 // the page is in the active or inactive page list (and swap hash table) #define PG_active 5 // the page is in the active page list \u8fd9\u8868\u793aflags\u76ee\u524d\u7528\u5230\u4e86\u516d\u4e2abit\u8868\u793a\u9875\u76ee\u524d\u5177\u6709\u7684\u516d\u79cd\u5c5e\u6027\uff0cbit 0\u8868\u793a\u6b64\u9875\u662f\u5426\u88ab\u4fdd\u7559\uff08reserved\uff09\uff0c\u5982\u679c\u662f\u88ab\u4fdd\u7559\u7684\u9875\uff0c\u5219bit 0\u4f1a\u8bbe\u7f6e\u4e3a1\uff0c\u4e14\u4e0d\u80fd\u653e\u5230\u7a7a\u95f2\u9875\u94fe\u8868\u4e2d\uff0c\u5373\u8fd9\u6837\u7684\u9875\u4e0d\u662f\u7a7a\u95f2\u9875\uff0c\u4e0d\u80fd\u52a8\u6001\u5206\u914d\u4e0e\u91ca\u653e\u3002\u6bd4\u5982\u76ee\u524d\u5185\u6838\u4ee3\u7801\u5360\u7528\u7684\u7a7a\u95f4\u5c31\u5c5e\u4e8e\u8fd9\u6837\u201c\u88ab\u4fdd\u7559\u201d\u7684\u9875\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0cbit 1\u8868\u793a\u6b64\u9875\u662f\u5426\u662ffree\u7684\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a1\uff0c\u8868\u793a\u8fd9\u9875\u662ffree\u7684\uff0c\u53ef\u4ee5\u88ab\u5206\u914d\uff1b\u5982\u679c\u8bbe\u7f6e\u4e3a0\uff0c\u8868\u793a\u8fd9\u9875\u5df2\u7ecf\u88ab\u5206\u914d\u51fa\u53bb\u4e86\uff0c\u4e0d\u80fd\u88ab\u518d\u4e8c\u6b21\u5206\u914d\u3002 \u53e6\u5916\uff0c\u672c\u5b9e\u9a8c\u8fd9\u91cc\u53d6\u7684\u540d\u5b57PG_property\u6bd4\u8f83\u4e0d\u76f4\u89c2\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u8bbe\u8ba1\u4e0d\u540c\u7684\u9875\u5206\u914d\u7b97\u6cd5\uff08best fit, buddy system\u7b49\uff09\uff0c\u90a3\u4e48\u8fd9\u4e2aPG_property\u5c31\u6709\u4e0d\u540c\u7684\u542b\u4e49\u4e86\u3002 \u5728\u672c\u5b9e\u9a8c\u4e2d\uff0cPage\u6570\u636e\u7ed3\u6784\u7684\u6210\u5458\u53d8\u91cfproperty\u7528\u6765\u8bb0\u5f55\u67d0\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\uff08\u5373\u5730\u5740\u8fde\u7eed\u7684\u7a7a\u95f2\u9875\u7684\u4e2a\u6570\uff09\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u7528\u5230\u6b64\u6210\u5458\u53d8\u91cf\u7684\u8fd9\u4e2aPage\u6bd4\u8f83\u7279\u6b8a\uff0c\u662f\u8fd9\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5730\u5740\u6700\u5c0f\u7684\u4e00\u9875\uff08\u5373\u5934\u4e00\u9875\uff0cHead Page\uff09\u3002\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5229\u7528\u8fd9\u4e2a\u9875\u7684\u6210\u5458\u53d8\u91cfproperty\u6765\u8bb0\u5f55\u5728\u6b64\u5757\u5185\u7684\u7a7a\u95f2\u9875\u7684\u4e2a\u6570\u3002\u8fd9\u91cc\u53d6\u7684\u540d\u5b57property\u4e5f\u4e0d\u662f\u5f88\u76f4\u89c2\uff0c\u539f\u56e0\u4e0e\u4e0a\u9762\u7c7b\u4f3c\uff0c\u5728\u4e0d\u540c\u7684\u9875\u5206\u914d\u7b97\u6cd5\u4e2d\uff0cproperty\u6709\u4e0d\u540c\u7684\u542b\u4e49\u3002 Page\u6570\u636e\u7ed3\u6784\u7684\u6210\u5458\u53d8\u91cfpage_link\u662f\u4fbf\u4e8e\u628a\u591a\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u94fe\u63a5\u5728\u4e00\u8d77\u7684\u53cc\u5411\u94fe\u8868\u6307\u9488\uff08\u53ef\u56de\u987e\u5728lab0\u5b9e\u9a8c\u6307\u5bfc\u4e66\u4e2d\u6709\u5173\u53cc\u5411\u94fe\u8868\u6570\u636e\u7ed3\u6784\u7684\u4ecb\u7ecd\uff09\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u7528\u5230\u6b64\u6210\u5458\u53d8\u91cf\u7684\u8fd9\u4e2aPage\u6bd4\u8f83\u7279\u6b8a\uff0c\u662f\u8fd9\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5730\u5740\u6700\u5c0f\u7684\u4e00\u9875\uff08\u5373\u5934\u4e00\u9875\uff0cHead Page\uff09\u3002\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5229\u7528\u8fd9\u4e2a\u9875\u7684\u6210\u5458\u53d8\u91cfpage_link\u6765\u94fe\u63a5\u6bd4\u5b83\u5730\u5740\u5c0f\u548c\u5927\u7684\u5176\u4ed6\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u3002 \u5728\u521d\u59cb\u60c5\u51b5\u4e0b\uff0c\u4e5f\u8bb8\u8fd9\u4e2a\u7269\u7406\u5185\u5b58\u7684\u7a7a\u95f2\u7269\u7406\u9875\u90fd\u662f\u8fde\u7eed\u7684\uff0c\u8fd9\u6837\u5c31\u5f62\u6210\u4e86\u4e00\u4e2a\u5927\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u3002\u4f46\u968f\u7740\u7269\u7406\u9875\u7684\u5206\u914d\u4e0e\u91ca\u653e\uff0c\u8fd9\u4e2a\u5927\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u4f1a\u5206\u88c2\u4e3a\u4e00\u7cfb\u5217\u5730\u5740\u4e0d\u8fde\u7eed\u7684\u591a\u4e2a\u5c0f\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\uff0c\u4e14\u6bcf\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5185\u90e8\u7684\u7269\u7406\u9875\u662f\u8fde\u7eed\u7684\u3002\u90a3\u4e48\u4e3a\u4e86\u6709\u6548\u5730\u7ba1\u7406\u8fd9\u4e9b\u5c0f\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u3002\u6240\u6709\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u53ef\u7528\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\u7ba1\u7406\u8d77\u6765\uff0c\u4fbf\u4e8e\u5206\u914d\u548c\u91ca\u653e\uff0c\u4e3a\u6b64\u5b9a\u4e49\u4e86\u4e00\u4e2afree_area_t\u6570\u636e\u7ed3\u6784\uff0c\u5305\u542b\u4e86\u4e00\u4e2alist_entry\u7ed3\u6784\u7684\u53cc\u5411\u94fe\u8868\u6307\u9488\u548c\u8bb0\u5f55\u5f53\u524d\u7a7a\u95f2\u9875\u7684\u4e2a\u6570\u7684\u65e0\u7b26\u53f7\u6574\u578b\u53d8\u91cfnr_free\u3002\u5176\u4e2d\u7684\u94fe\u8868\u6307\u9488\u6307\u5411\u4e86\u7a7a\u95f2\u7684\u7269\u7406\u9875\u3002 /* free_area_t - maintains a doubly linked list to record free (unused) pages */ typedef struct { list_entry_t free_list ; // the list header unsigned int nr_free ; // # of free pages in this free list } free_area_t ; \u6709\u4e86\u8fd9\u4e24\u4e2a\u6570\u636e\u7ed3\u6784\uff0cucore\u5c31\u53ef\u4ee5\u7ba1\u7406\u8d77\u6765\u6574\u4e2a\u4ee5\u9875\u4e3a\u5355\u4f4d\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u3002\u63a5\u4e0b\u6765\u9700\u8981\u89e3\u51b3\u4e24\u4e2a\u95ee\u9898\uff1a \u7ba1\u7406\u9875\u7ea7\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684Page\u7ed3\u6784\u7684\u5185\u5b58\u7a7a\u95f4\u4ece\u54ea\u91cc\u5f00\u59cb\uff0c\u5360\u591a\u5927\u7a7a\u95f4\uff1f \u7a7a\u95f2\u5185\u5b58\u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\u5728\u54ea\u91cc\uff1f \u5bf9\u4e8e\u8fd9\u4e24\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u9996\u5148\u6839\u636ememlayout.h\u7ed9\u51fa\u7684\u6838\u5fc3\u6001\u5185\u5b58\u57fa\u5730\u5740KERNBASE\uff080xa0000000\uff09\u548cKMEMSIZE\uff08512M\uff09\u8ba1\u7b97\u51fa\u6700\u5927\u7684\u7269\u7406\u5185\u5b58\u5730\u5740KERNTOP\uff08\u5b9a\u4e49\u5728memlayout.h\u4e2d\uff09\uff0c\u6700\u5927\u7269\u7406\u5185\u5b58\u5730\u5740maxpa\u7b49\u4e8eKERNTOP\uff08\u5b9a\u4e49\u5728page_init\u51fd\u6570\u4e2d\u7684\u5c40\u90e8\u53d8\u91cf\uff09\uff0c\u5728\u8be5\u5b9e\u9a8c\u4e2dPage size\u4e3a4096 bytes\u53732^12 bytes\uff0c\u6240\u4ee5\u9700\u8981\u7ba1\u7406\u7684\u7269\u7406\u9875\u7684\u4e2a\u6570npage\u7684\u8ba1\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a #define KERNTOP (KERNBASE + KMEMSIZE) maxpa = KERNTOP npage = KMEMSIZE >> PGSHIFT # PGSHIFT = 12 \u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u9884\u4f30\u51fa\u7ba1\u7406\u9875\u7ea7\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684Page\u7ed3\u6784\u7684\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684\u5185\u5b58\u5927\u5c0f\u4e3a\uff1a sizeof ( struct Page ) * npage \u7531\u4e8e\u52a0\u8f7d\u5185\u6838\u7684\u7ed3\u675f\u5730\u5740\uff08\u7528\u5168\u5c40\u6307\u9488\u53d8\u91cfend\u8bb0\u5f55\uff09\u4ee5\u4e0a\u7684\u7a7a\u95f4\u6ca1\u6709\u88ab\u4f7f\u7528\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u628aend\u6309\u9875\u5927\u5c0f\u4e3a\u8fb9\u754c\u53d6\u6574\u540e\uff0c\u4f5c\u4e3a\u7ba1\u7406\u9875\u7ea7\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684Page\u7ed3\u6784\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u8bb0\u4e3a\uff1a pages = ( struct Page * ) ROUNDUP_2N (( void * ) end , PGSHIFT ); \u4e3a\u4e86\u7b80\u5316\u8d77\u89c1\uff0c\u4ece\u5730\u57400\u5230\u5730\u5740pages+ sizeof(struct Page) *npage)\u7ed3\u675f\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u8bbe\u5b9a\u4e3a\u5df2\u5360\u7528\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff08\u8d77\u59cb0~640KB\u7684\u7a7a\u95f4\u662f\u7a7a\u95f2\u7684\uff09\uff0c\u5730\u5740pages+sizeof(struct Page) *npage)\u4ee5\u4e0a\u7684\u7a7a\u95f4\u4e3a\u7a7a\u95f2\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u8fd9\u65f6\u7684\u7a7a\u95f2\u7a7a\u95f4\u8d77\u59cb\u5730\u5740\u4e3a uintptr_t freemem = PADDR (( uintptr_t ) pages + sizeof ( struct Page ) * npage ); \u4e3a\u6b64\u6211\u4eec\u9700\u8981\u628a\u8fd9\u4e24\u90e8\u5206\u7a7a\u95f4\u7ed9\u6807\u8bc6\u51fa\u6765\u3002\u9996\u5148\uff0c\u5bf9\u4e8e\u6240\u6709\u7269\u7406\u7a7a\u95f4\uff0c\u901a\u8fc7\u5982\u4e0b\u8bed\u53e5\u5373\u53ef\u5b9e\u73b0\u5360\u7528\u6807\u8bb0\uff1a for ( i = 0 ; i < npage ; i ++ ) { SetPageReserved ( pages + i ); } \u7136\u540e\uff0c\u6839\u636e\u63a2\u6d4b\u5230\u7684\u7a7a\u95f2\u7269\u7406\u7a7a\u95f4\uff0c\u901a\u8fc7\u5982\u4e0b\u8bed\u53e5\u5373\u53ef\u5b9e\u73b0\u7a7a\u95f2\u6807\u8bb0\uff1a //\u83b7\u5f97\u7a7a\u95f2\u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740begin\u548c\u7ed3\u675f\u5730\u5740end ... init_memmap ( pa2page ( mbegin ), ( mend - mbegin ) >> PGSHIFT ); \u5176\u5b9eSetPageReserved\u53ea\u9700\u628a\u7269\u7406\u5730\u5740\u5bf9\u5e94\u7684Page\u7ed3\u6784\u4e2d\u7684flags\u6807\u5fd7\u8bbe\u7f6e\u4e3aPG_reserved\uff0c\u8868\u793a\u8fd9\u4e9b\u9875\u5df2\u7ecf\u88ab\u4f7f\u7528\u4e86\uff0c\u5c06\u6765\u4e0d\u80fd\u88ab\u7528\u4e8e\u5206\u914d\u3002\u800cinit_memmap\u51fd\u6570\u5219\u662f\u628a\u7a7a\u95f2\u7269\u7406\u9875\u5bf9\u5e94\u7684Page\u7ed3\u6784\u4e2d\u7684flags\u548c\u5f15\u7528\u8ba1\u6570ref\u6e05\u96f6\uff0c\u5e76\u52a0\u5230free_area.free_list\u6307\u5411\u7684\u53cc\u5411\u5217\u8868\u4e2d\uff0c\u4e3a\u5c06\u6765\u7684\u7a7a\u95f2\u9875\u7ba1\u7406\u505a\u597d\u521d\u59cb\u5316\u51c6\u5907\u5de5\u4f5c\u3002 \u5173\u4e8e\u5185\u5b58\u5206\u914d\u7684\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u65b9\u9762\u7684\u77e5\u8bc6\u6709\u5f88\u591a\uff0c\u4f46\u5728\u672c\u5b9e\u9a8c\u4e2d\u53ea\u5b9e\u73b0\u4e86\u6700\u7b80\u5355\u7684\u5185\u5b58\u9875\u5206\u914d\u7b97\u6cd5\u3002\u76f8\u5e94\u7684\u5b9e\u73b0\u5728default_pmm.c\u4e2d\u7684default_alloc_pages\u51fd\u6570\u548cdefault_free_pages\u51fd\u6570\uff0c\u76f8\u5173\u5b9e\u73b0\u5f88\u7b80\u5355\uff0c\u8fd9\u91cc\u5c31\u4e0d\u5177\u4f53\u5206\u6790\u4e86\uff0c\u76f4\u63a5\u770b\u6e90\u7801\uff0c\u5e94\u8be5\u5f88\u597d\u7406\u89e3\u3002 \u5176\u5b9e\u5b9e\u9a8c\u4e8c\u5728\u5185\u5b58\u5206\u914d\u548c\u91ca\u653e\u65b9\u9762\u6700\u4e3b\u8981\u7684\u4f5c\u7528\u662f\u5efa\u7acb\u4e86\u4e00\u4e2a\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668\u6846\u67b6\uff0c\u8fd9\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u5217\u8868\uff0c\u5b9a\u4e49\u5982\u4e0b\uff1a struct pmm_manager { const char * name ; // XXX_pmm_manager's name void ( * init )( void ); // initialize internal description&management data structure // (free block list, number of free block) of XXX_pmm_manager void ( * init_memmap )( struct Page * base , size_t n ); // setup description&management data structcure according to // the initial free physical memory space struct Page * ( * alloc_pages )( size_t n ); // allocate >=n pages, depend on the allocation algorithm void ( * free_pages )( struct Page * base , size_t n ); // free >=n pages with \"base\" addr of Page descriptor structures(memlayout.h) size_t ( * nr_free_pages )( void ); // return the number of free pages void ( * check )( void ); // check the correctness of XXX_pmm_manager }; \u91cd\u70b9\u662f\u5b9e\u73b0init_memmap/ alloc_pages/free_pages\u8fd9\u4e09\u4e2a\u51fd\u6570\u3002 \u7269\u7406\u5185\u5b58\u9875\u5206\u914d\u7b97\u6cd5\u5b9e\u73b0 \u00b6 \u5982\u679c\u8981\u5728ucore\u4e2d\u5b9e\u73b0\u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\uff0c\u5219\u9700\u8981\u8003\u8651\u7684\u4e8b\u60c5\u6bd4\u8f83\u591a\uff0c\u76f8\u5bf9\u8bfe\u672c\u4e0a\u7684\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u63cf\u8ff0\u8981\u590d\u6742\u4e0d\u5c11\u3002\u4e0b\u9762\u4ecb\u7ecd\u4e00\u4e0b\u5982\u679c\u8981\u5b9e\u73b0\u4e00\u4e2aFirstFit\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u5927\u81f4\u6d41\u7a0b\u3002 lab2\u7684\u7b2c\u4e00\u90e8\u5206\u662f\u5b8c\u6210first_fit\u7684\u5206\u914d\u7b97\u6cd5\u3002\u539f\u7406FirstFit\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u4e0a\u5f88\u7b80\u5355\uff0c\u4f46\u8981\u5728ucore\u4e2d\u5b9e\u73b0\uff0c\u9700\u8981\u5145\u5206\u4e86\u89e3\u548c\u5229\u7528ucore\u5df2\u6709\u7684\u6570\u636e\u7ed3\u6784\u548c\u76f8\u5173\u64cd\u4f5c\u3001\u5173\u952e\u7684\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf\u7b49\u3002 \u5173\u952e\u6570\u636e\u7ed3\u6784\u548c\u53d8\u91cf first_fit\u5206\u914d\u7b97\u6cd5\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u67e5\u627e\u6709\u5e8f\uff08\u5730\u5740\u6309\u4ece\u5c0f\u5230\u5927\u6392\u5217\uff09\u7a7a\u95f2\u5757\uff08\u4ee5\u9875\u4e3a\u6700\u5c0f\u5355\u4f4d\u7684\u8fde\u7eed\u5730\u5740\u7a7a\u95f4\uff09\u7684\u6570\u636e\u7ed3\u6784\uff0c\u800c\u53cc\u5411\u94fe\u8868\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u9009\u62e9\u3002 kernel/include/list.h\u5b9a\u4e49\u4e86\u53ef\u6302\u63a5\u4efb\u610f\u5143\u7d20\u7684\u901a\u7528\u53cc\u5411\u94fe\u8868\u7ed3\u6784\u548c\u5bf9\u5e94\u7684\u64cd\u4f5c\uff0c\u6240\u4ee5\u9700\u8981\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8fd9\u4e2a\u6587\u4ef6\u63d0\u4f9b\u7684\u5404\u79cd\u51fd\u6570\uff0c\u4ece\u800c\u53ef\u4ee5\u5b8c\u6210\u5bf9\u53cc\u5411\u94fe\u8868\u7684\u521d\u59cb\u5316/\u63d2\u5165/\u5220\u9664\u7b49\u3002 kern/mm/memlayout.h\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a free_area_t \u6570\u636e\u7ed3\u6784\uff0c\u5305\u542b\u6210\u5458\u7ed3\u6784 list_entry_t free_list ; // the list header \u7a7a\u95f2\u5757\u53cc\u5411\u94fe\u8868\u7684\u5934 unsigned int nr_free ; // # of free pages in this free list \u7a7a\u95f2\u5757\u7684\u603b\u6570\uff08\u4ee5\u9875\u4e3a\u5355\u4f4d\uff09 \u663e\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6b64\u6570\u636e\u7ed3\u6784\u6765\u5b8c\u6210\u5bf9\u7a7a\u95f2\u5757\u7684\u7ba1\u7406\u3002\u800cbuddy_pmm.c\u4e2d\u5b9a\u4e49\u7684free_area\u53d8\u91cf\u5c31\u662f\u5e72\u8fd9\u4e2a\u4e8b\u60c5\u7684\u3002 kern/mm/pmm.h\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a\u901a\u7528\u7684\u5206\u914d\u7b97\u6cd5\u7684\u51fd\u6570\u5217\u8868\uff0c\u7528pmm_manager\u8868\u793a\u3002\u5176\u4e2dinit\u51fd\u6570\u5c31\u662f\u7528\u6765\u521d\u59cb\u5316free_area\u53d8\u91cf\u7684,first_fit\u5206\u914d\u7b97\u6cd5\u53ef\u76f4\u63a5\u91cd\u7528buddy_init\u51fd\u6570\u7684\u5b9e\u73b0\u3002init_memmap\u51fd\u6570\u9700\u8981\u6839\u636e\u73b0\u6709\u7684\u5185\u5b58\u60c5\u51b5\u6784\u5efa\u7a7a\u95f2\u5757\u5217\u8868\u7684\u521d\u59cb\u72b6\u6001\u3002\u4f55\u65f6\u5e94\u8be5\u6267\u884c\u8fd9\u4e2a\u51fd\u6570\u5462\uff1f \u901a\u8fc7\u5206\u6790\u4ee3\u7801\uff0c\u53ef\u4ee5\u77e5\u9053\uff1a kern_init --> pmm_init-->page_init-->init_memmap--> pmm_manager->init_memmap \u6240\u4ee5\uff0cdefault_init_memmap\u9700\u8981\u6839\u636epage_init\u51fd\u6570\u4e2d\u4f20\u9012\u8fc7\u6765\u7684\u53c2\u6570\uff08\u67d0\u4e2a\u8fde\u7eed\u5730\u5740\u7684\u7a7a\u95f2\u5757\u7684\u8d77\u59cb\u9875\uff0c\u9875\u4e2a\u6570\uff09\u6765\u5efa\u7acb\u4e00\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u7684\u53cc\u5411\u94fe\u8868\u3002\u8fd9\u91cc\u6709\u4e00\u4e2a\u5047\u5b9apage_init\u51fd\u6570\u662f\u6309\u5730\u5740\u4ece\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u4f20\u6765\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u7684\u3002\u94fe\u8868\u5934\u662ffree_area.free_list\uff0c\u94fe\u8868\u9879\u662fPage\u6570\u636e\u7ed3\u6784\u7684base->page_link\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u4f9d\u9760Page\u6570\u636e\u7ed3\u6784\u4e2d\u7684\u6210\u5458\u53d8\u91cfpage_link\u5f62\u6210\u4e86\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5217\u8868\u3002 \u8bbe\u8ba1\u5b9e\u73b0 default_init_memmap\u51fd\u6570\u5c06\u6839\u636e\u6bcf\u4e2a\u7269\u7406\u9875\u5e27\u7684\u60c5\u51b5\u6765\u5efa\u7acb\u7a7a\u95f2\u9875\u94fe\u8868\uff0c\u4e14\u7a7a\u95f2\u9875\u5757\u5e94\u8be5\u662f\u6839\u636e\u5730\u5740\u9ad8\u4f4e\u5f62\u6210\u4e00\u4e2a\u6709\u5e8f\u94fe\u8868\u3002\u6839\u636e\u4e0a\u8ff0\u53d8\u91cf\u7684\u5b9a\u4e49\uff0cdefault_init_memmap\u53ef\u5927\u81f4\u5b9e\u73b0\u5982\u4e0b\uff1a default_init_memmap ( struct Page * base , size_t n ) { assert ( n > 0 ); struct Page * p = base ; for (; p != base + n ; p ++ ) { assert ( PageReserved ( p )); p -> flags = p -> property = 0 ; set_page_ref ( p , 0 ); } base -> property = n ; SetPageProperty ( base ); nr_free += n ; list_add_before ( & free_list , & ( base -> page_link )); } \u5982\u679c\u8981\u5206\u914d\u4e00\u4e2a\u9875\uff0c\u90a3\u8981\u8003\u8651\u54ea\u4e9b\u5462\uff1f\u8fd9\u91cc\u5c31\u9700\u8981\u8003\u8651\u5b9e\u73b0default_alloc_pages\u51fd\u6570\uff0c\u6ce8\u610f\u53c2\u6570n\u8868\u793a\u8981\u5206\u914dn\u4e2a\u9875\u3002\u53e6\u5916\uff0c\u9700\u8981\u6ce8\u610f\u5b9e\u73b0\u65f6\u5c3d\u91cf\u591a\u8003\u8651\u4e00\u4e9b\u8fb9\u754c\u60c5\u51b5\uff0c\u8fd9\u6837\u786e\u4fdd\u8f6f\u4ef6\u7684\u9c81\u68d2\u6027\u3002\u6bd4\u5982 if ( n > nr_free ) { return NULL ; } \u8fd9\u6837\u53ef\u4ee5\u786e\u4fdd\u5206\u914d\u4e0d\u4f1a\u8d85\u51fa\u8303\u56f4\u3002\u4e5f\u53ef\u52a0\u4e00\u4e9bassert\u51fd\u6570\uff0c\u5728\u6709\u9519\u8bef\u51fa\u73b0\u65f6\uff0c\u80fd\u591f\u8fc5\u901f\u53d1\u73b0\u3002\u6bd4\u5982 n\u5e94\u8be5\u5927\u4e8e0\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u52a0\u4e0a assert ( n > 0 ); \u8fd9\u6837\u5728n<=0\u7684\u60c5\u51b5\u4e0b\uff0cucore\u4f1a\u8fc5\u901f\u62a5\u9519\u3002firstfit\u9700\u8981\u4ece\u7a7a\u95f2\u94fe\u8868\u5934\u5f00\u59cb\u67e5\u627e\u6700\u5c0f\u7684\u5730\u5740\uff0c\u901a\u8fc7list_next\u627e\u5230\u4e0b\u4e00\u4e2a\u7a7a\u95f2\u5757\u5143\u7d20\uff0c\u901a\u8fc7le2page\u5b8f\u53ef\u4ee5\u7531\u94fe\u8868\u5143\u7d20\u83b7\u5f97\u5bf9\u5e94\u7684Page\u6307\u9488p\u3002\u901a\u8fc7p->property\u53ef\u4ee5\u4e86\u89e3\u6b64\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u3002\u5982\u679c>=n\uff0c\u8fd9\u5c31\u627e\u5230\u4e86\uff01\u5982\u679c<n\uff0c\u5219list_next\uff0c\u7ee7\u7eed\u67e5\u627e\u3002\u76f4\u5230list_next== &free_list\uff0c\u8fd9\u8868\u793a\u627e\u5b8c\u4e86\u4e00\u904d\u4e86\u3002\u627e\u5230\u540e\uff0c\u5c31\u8981\u4ece\u65b0\u7ec4\u7ec7\u7a7a\u95f2\u5757\uff0c\u7136\u540e\u628a\u627e\u5230\u7684page\u8fd4\u56de\u3002\u6240\u4ee5default_alloc_pages\u53ef\u5927\u81f4\u5b9e\u73b0\u5982\u4e0b\uff1a default_alloc_pages ( size_t n ) { assert ( n > 0 ); if ( n > nr_free ) { return NULL ; } struct Page * page = NULL ; list_entry_t * le = & free_list ; // TODO: optimize (next-fit) while (( le = list_next ( le )) != & free_list ) { struct Page * p = le2page ( le , page_link ); if ( p -> property >= n ) { page = p ; break ; } } if ( page != NULL ) { if ( page -> property > n ) { struct Page * p = page + n ; p -> property = page -> property - n ; SetPageProperty ( p ); list_add_after ( & ( page -> page_link ), & ( p -> page_link )); } list_del ( & ( page -> page_link )); nr_free -= n ; ClearPageProperty ( page ); } return page ; } default_free_pages\u51fd\u6570\u7684\u5b9e\u73b0\u5176\u5b9e\u662fdefault_alloc_pages\u7684\u9006\u8fc7\u7a0b\uff0c\u4e0d\u8fc7\u9700\u8981\u8003\u8651\u7a7a\u95f2\u5757\u7684\u5408\u5e76\u95ee\u9898\u3002\u8fd9\u91cc\u5c31\u4e0d\u518d\u7ec6\u8bb2\u4e86\u3002\u6ce8\u610f\uff0c\u4e0a\u8bc9\u4ee3\u7801\u53ea\u662f\u53c2\u8003\u8bbe\u8ba1\uff0c\u4e0d\u662f\u5b8c\u6574\u7684\u6b63\u786e\u8bbe\u8ba1\u3002\u66f4\u8be6\u7ec6\u7684\u8bf4\u660e\u4f4d\u4e8elab2/kernel/mm/default_pmm.c\u7684\u6ce8\u91ca\u4e2d\u3002\u5e0c\u671b\u540c\u5b66\u80fd\u591f\u987a\u5229\u5b8c\u6210\u672c\u5b9e\u9a8c\u7684\u7b2c\u4e00\u90e8\u5206\u3002 \u7cfb\u7edf\u6267\u884c\u4e2d\u5730\u5740\u6620\u5c04\u7684\u8fc7\u7a0b \u00b6 \u5728lab1\u548clab2\u4e2d\u90fd\u4f1a\u6d89\u53ca\u5982\u4f55\u5efa\u7acb\u6620\u5c04\u5173\u7cfb\u7684\u64cd\u4f5c\uff0c\u5728\u9f99\u82af\u67b6\u6784\u4e2dMMU\u652f\u6301\u4e24\u79cd\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff1a\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u548c\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u4e0b\u7269\u7406\u5730\u5740\u9ed8\u8ba4\u76f4\u63a5\u7b49\u4e8e\u865a\u62df\u5730\u5740\u7684[PALEN-1:0]\u4f4d\uff08\u4e0d\u8db3\u88650\uff09\u3002\u5f53\u5904\u7406\u5668\u6838\u7684MMU\u5904\u4e8e\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u5177\u4f53\u53c8\u5206\u4e3a\u76f4\u63a5\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u548c\u9875\u8868\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002\u76f4\u63a5\u6620\u5c04\u5730\u5740\u6a21\u5f0f\u662f\u901a\u8fc7\u76f4\u63a5\u6620\u5c04\u914d\u7f6e\u7a97\u53e3\u673a\u5236\u5b8c\u6210\u865a\u5b9e\u5730\u5740\u7684\u76f4\u63a5\u6620\u5c04\uff0c\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u901a\u8fc7\u9875\u8868\u5b8c\u6210\u6620\u5c04\u3002 \u5728lab1\u548clab2\u4e2d\u6211\u4eec\u5728ucore\u7684\u5165\u53e3\u51fd\u6570kernel_entry\uff08entry.S\u6587\u4ef6\u4e2d\uff09\u4e2d\u8bbe\u7f6e\u4e86CSR.CRMD\u7684DA=0\u4e14PG=1\uff0c\u5373\u5904\u7406\u5668\u6838\u7684MMU\u5904\u4e8e\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002\u540c\u65f6\uff0c\u6211\u4eec\u5c06CSR.DWM0\u5bc4\u5b58\u5668\u7684\u503c\u8bbe\u7f6e\u4e3a0xa0000001\uff0c\u8868\u793a 0xa0000000-0xbfffffff\u6bb5\u7684\u865a\u62df\u5730\u5740\u901a\u8fc7\u76f4\u63a5\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u6620\u5c04\u52300x00000000-0x1fffffff\u7684\u7269\u7406\u5730\u5740\u3002\u5c06CSR.DWM1\u5bc4\u5b58\u5668\u7684\u503c\u8bbe\u7f6e\u4e3a0x80000011\uff0c\u8868\u793a0x80000000-0x9fffffff\u6bb5\u7684\u865a\u62df\u5730\u5740\u7528\u8fc7\u76f4\u63a5\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u6620\u5c04\u52300x00000000-0x1fffffff\u7684\u7269\u7406\u5730\u5740\u3002\u9664\u4e86\u8fd9\u4e24\u6bb5\u865a\u62df\u5730\u5740\u4e4b\u5916\u7684\u865a\u62df\u5730\u5740\u90fd\u662f\u901a\u8fc7\u9875\u8868\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u8fdb\u884c\u6620\u5c04\u3002 \u4e0b\u9762\uff0c\u6211\u4eec\u6765\u770b\u770b\u5982\u4f55\u6539\u53d8\u5185\u6838\u7684\u8d77\u59cb\u5730\u5740\u3002\u89c2\u5bdf\u4e00\u4e0b\u94fe\u63a5\u811a\u672c\uff0c\u5373tools/kernel.ld\u6587\u4ef6\uff1a OUTPUT_ARCH(loongarch) ENTRY(kernel_entry) SECTIONS { . = 0xa0000000; .text : { . = ALIGN(4); wrs_kernel_text_start = .; _wrs_kernel_text_start = .; *(.startup) *(.text) *(.text.*) *(.gnu.linkonce.t*) *(.mips16.fn.*) *(.mips16.call.*) /* for MIPS */ *(.rodata) *(.rodata.*) *(.gnu.linkonce.r*) *(.rodata1) . = ALIGN(4096); *(.ramexv) } \u4ece\u4e0a\u8ff0\u4ee3\u7801\u53ef\u4ee5\u770b\u51fald\u5de5\u5177\u5f62\u6210\u7684ucore\u7684\u8d77\u59cb\u865a\u62df\u5730\u5740\u4ece0xa0000000\u5f00\u59cb\uff0c\u7531\u4e8e\u8fd9\u4e2a\u6bb5\u7684\u5730\u5740\u662f\u76f4\u63a5\u6620\u5c04\u5730\u5740\u6bb5\uff0c\u6240\u4ee5\u5176\u8d77\u59cb\u7684\u7269\u7406\u5730\u5740\u4e3a0x00000000\uff0c\u5373 phy addr = CSR.DMW0[31:29] : virtual addr[28:0] \u7b2c\u4e00\u4e2a\u9636\u6bb5 \u4ecekernel_entry\u51fd\u6570\u5f00\u59cb\u5230pmm_init\u51fd\u6570\u6267\u884c\u4e4b\u524d\uff0cucore\u91c7\u7528\u76f4\u63a5\u6620\u5c04\u5730\u5740\u65b9\u5f0f\u8fdb\u884c\u5730\u5740\u7ffb\u8bd1\uff0c\u7ffb\u8bd1\u65b9\u5f0f\u5982\u4e0a\u3002\u6ce8\u610f\uff0c\u7531\u4e8e0x80000000-0x9fffffff\u548c0xa0000000-0xbfffffff\u624d\u80fd\u8fdb\u884c\u76f4\u63a5\u6620\u5c04\uff0c\u6240\u4ee5\u5185\u6838\u7684\u5927\u5c0f\u4e0d\u80fd\u8d85\u8fc7512M\u3002 \u7b2c\u4e8c\u4e2a\u9636\u6bb5 \uff08\u521b\u5efa\u521d\u59cb\u9875\u76ee\u5f55\u8868\uff0c\u5f00\u542f\u5206\u9875\u6a21\u5f0f\uff09\u4ecepmm_init\u51fd\u6570\u88ab\u8c03\u7528\u5f00\u59cb\uff0c\u5728pmm_init\u51fd\u6570\u4e2d\u521b\u5efa\u4e86boot_pgdir\uff0c\u521d\u59cb\u5316\u4e86\u9875\u76ee\u5f55\u8868\uff0c\u6b63\u5f0f\u5f00\u59cb\u4e86\u9875\u8868\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002 \u5efa\u7acb\u865a\u62df\u9875\u548c\u7269\u7406\u9875\u5e27\u7684\u5730\u5740\u6620\u5c04\u5173\u7cfb \u00b6 \u5efa\u7acb\u4e8c\u7ea7\u9875\u8868 \u5728LoongArch32\u91c7\u7528\u4e86\u4e0eMIPS\u76f8\u540c\u7684\u8f6f\u4ef6\u5b9a\u4e49\u9875\u8868\u7684\u65b9\u5f0f\uff0c\u56e0\u6b64\u5185\u6838\u53ef\u4ee5\u81ea\u7531\u91c7\u53d6\u9875\u8868\u7684\u5b9a\u4e49\u65b9\u5f0f\u3002\u7531\u4e8e\u8be5\u7248\u672cuCore\u81eax86\u67b6\u6784\u79fb\u690d\u800c\u6765\uff0c\u56e0\u6b64\u6cbf\u7528\u4e86x86\u7684\u7c7b\u4f3c\u65b9\u5f0f\u91c7\u7528\u4e8c\u7ea7\u9875\u8868\u6765\u5efa\u7acb\u903b\u8f91\u5730\u5740\u4e0e\u7269\u7406\u5730\u5740\u4e4b\u95f4\u7684\u6620\u5c04\u5173\u7cfb\u3002\u7531\u4e8e\u6211\u4eec\u5df2\u7ecf\u5177\u6709\u4e86\u4e00\u4e2a\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668default_pmm_manager\uff0c\u652f\u6301\u52a8\u6001\u5206\u914d\u548c\u91ca\u653e\u5185\u5b58\u9875\u7684\u529f\u80fd\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u5b83\u6765\u83b7\u5f97\u6240\u9700\u7684\u7a7a\u95f2\u7269\u7406\u9875\u3002\u5728\u4e8c\u7ea7\u9875\u8868\u7ed3\u6784\u4e2d\uff0c\u9875\u76ee\u5f55\u8868\u53604KB\u7a7a\u95f4\uff0c\u53ef\u901a\u8fc7alloc_page\u51fd\u6570\u83b7\u5f97\u4e00\u4e2a\u7a7a\u95f2\u7269\u7406\u9875\u4f5c\u4e3a\u9875\u76ee\u5f55\u8868\uff08Page Directory Table\uff0cPDT\uff09\u3002\u540c\u7406\uff0cucore\u4e5f\u901a\u8fc7\u8fd9\u79cd\u7c7b\u4f3c\u65b9\u5f0f\u83b7\u5f97\u4e00\u4e2a\u9875\u8868\uff08Page Table\uff0cPT\uff09\u6240\u9700\u76844KB\u7a7a\u95f4\u3002 \u6574\u4e2a\u9875\u76ee\u5f55\u8868\u548c\u9875\u8868\u6240\u5360\u7a7a\u95f4\u5927\u5c0f\u53d6\u51b3\u4e0e\u4e8c\u7ea7\u9875\u8868\u8981\u7ba1\u7406\u548c\u6620\u5c04\u7684\u7269\u7406\u9875\u6570\u3002\u5047\u5b9a\u5f53\u524d\u7269\u7406\u5185\u5b580~16MB\uff0c\u6bcf\u7269\u7406\u9875\uff08\u4e5f\u79f0Page Frame\uff09\u5927\u5c0f\u4e3a4KB\uff0c\u5219\u67094096\u4e2a\u7269\u7406\u9875\uff0c\u4e5f\u5c31\u610f\u5473\u8fd9\u67094\u4e2a\u9875\u76ee\u5f55\u9879\u548c4096\u4e2a\u9875\u8868\u9879\u9700\u8981\u8bbe\u7f6e\u3002\u4e00\u4e2a\u9875\u76ee\u5f55\u9879\uff08Page Directory Entry\uff0cPDE\uff09\u548c\u4e00\u4e2a\u9875\u8868\u9879\uff08Page Table Entry\uff0cPTE\uff09\u53604B\u3002\u5373\u4f7f\u662f4\u4e2a\u9875\u76ee\u5f55\u9879\u4e5f\u9700\u8981\u4e00\u4e2a\u5b8c\u6574\u7684\u9875\u76ee\u5f55\u8868\uff08\u53604KB\uff09\u3002\u800c4096\u4e2a\u9875\u8868\u9879\u9700\u898116KB\uff08\u53734096*4B\uff09\u7684\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f4\u4e2a\u7269\u7406\u9875\uff0c16KB\u7684\u7a7a\u95f4\u3002\u6240\u4ee5\u5bf916MB\u7269\u7406\u9875\u5efa\u7acb\u4e00\u4e00\u6620\u5c04\u768416MB\u865a\u62df\u9875\uff0c\u9700\u89815\u4e2a\u7269\u7406\u9875\uff0c\u537320KB\u7684\u7a7a\u95f4\u6765\u5f62\u6210\u4e8c\u7ea7\u9875\u8868\u3002 \u5b8c\u6210\u524d\u4e00\u8282\u6240\u8ff0\u7684\u524d\u4e24\u4e2a\u9636\u6bb5\u7684\u5730\u5740\u6620\u5c04\u53d8\u5316\u540e\uff0c\u4e3a\u628a0~KERNSIZE\uff08\u660e\u786eucore\u8bbe\u5b9a\u5b9e\u9645\u7269\u7406\u5185\u5b58\u4e0d\u80fd\u8d85\u8fc7KERNSIZE\u503c\uff0c\u5373512MB\uff0c131072\u4e2a\u7269\u7406\u9875\uff09\u7684\u7269\u7406\u5730\u5740\u4e00\u4e00\u6620\u5c04\u5230\u9875\u76ee\u5f55\u9879\u548c\u9875\u8868\u9879\u7684\u5185\u5bb9\uff0c\u5176\u5927\u81f4\u6d41\u7a0b\u5982\u4e0b\uff1a \u6307\u5411\u9875\u76ee\u5f55\u8868\u7684\u6307\u9488\u5df2\u5b58\u50a8\u5728boot_pgdir\u53d8\u91cf\u4e2d\u3002 \u8c03\u7528boot_map_segment\u51fd\u6570\u8fdb\u4e00\u6b65\u5efa\u7acb\u4e00\u4e00\u6620\u5c04\u5173\u7cfb\uff0c\u5177\u4f53\u5904\u7406\u8fc7\u7a0b\u4ee5\u9875\u4e3a\u5355\u4f4d\u8fdb\u884c\u8bbe\u7f6e\uff0c\u5373 linear addr = phy addr + 0xa0000000 \u8bbe\u4e00\u4e2a32bit\u7ebf\u6027\u5730\u5740la\u6709\u4e00\u4e2a\u5bf9\u5e94\u768432bit\u7269\u7406\u5730\u5740pa\uff0c\u5982\u679c\u5728\u4ee5la\u7684\u9ad810\u4f4d\u4e3a\u7d22\u5f15\u503c\u7684\u9875\u76ee\u5f55\u9879\u4e2d\u7684\u5b58\u5728\u4f4d\uff08PTE_P\uff09\u4e3a0\uff0c\u8868\u793a\u7f3a\u5c11\u5bf9\u5e94\u7684\u9875\u8868\u7a7a\u95f4\uff0c\u5219\u53ef\u901a\u8fc7alloc_page\u83b7\u5f97\u4e00\u4e2a\u7a7a\u95f2\u7269\u7406\u9875\u7ed9\u9875\u8868\uff0c\u9875\u8868\u8d77\u59cb\u7269\u7406\u5730\u5740\u662f\u63094096\u5b57\u8282\u5bf9\u9f50\u7684\uff0c\u8fd9\u6837\u586b\u5199\u9875\u76ee\u5f55\u9879\u7684\u5185\u5bb9\u4e3a \u9875\u76ee\u5f55\u9879\u5185\u5bb9 = (\u9875\u8868\u8d77\u59cb\u7269\u7406\u5730\u5740 & ~0x0FFF) | PTE_U | PTE_W | PTE_P \u8fdb\u4e00\u6b65\u5bf9\u4e8e\u9875\u8868\u4e2d\u4ee5\u7ebf\u6027\u5730\u5740la\u7684\u4e2d10\u4f4d\u4e3a\u7d22\u5f15\u503c\u5bf9\u5e94\u9875\u8868\u9879\u7684\u5185\u5bb9\u4e3a \u9875\u8868\u9879\u5185\u5bb9 = (pa & ~0x0FFF) | PTE_P | PTE_W \u5176\u4e2d\uff1a PTE_U\uff1a\u4f4d3\uff0c\u8868\u793a\u7528\u6237\u6001\u7684\u8f6f\u4ef6\u53ef\u4ee5\u8bfb\u53d6\u5bf9\u5e94\u5730\u5740\u7684\u7269\u7406\u5185\u5b58\u9875\u5185\u5bb9 PTE_W\uff1a\u4f4d2\uff0c\u8868\u793a\u7269\u7406\u5185\u5b58\u9875\u5185\u5bb9\u53ef\u5199 PTE_P\uff1a\u4f4d1\uff0c\u8868\u793a\u7269\u7406\u5185\u5b58\u9875\u5b58\u5728 ucore\u7684\u5185\u5b58\u7ba1\u7406\u7ecf\u5e38\u9700\u8981\u67e5\u627e\u9875\u8868\uff1a\u7ed9\u5b9a\u4e00\u4e2a\u865a\u62df\u5730\u5740\uff0c\u627e\u51fa\u8fd9\u4e2a\u865a\u62df\u5730\u5740\u5728\u4e8c\u7ea7\u9875\u8868\u4e2d\u5bf9\u5e94\u7684\u9879\u3002\u901a\u8fc7\u66f4\u6539\u6b64\u9879\u7684\u503c\u53ef\u4ee5\u65b9\u4fbf\u5730\u5c06\u865a\u62df\u5730\u5740\u6620\u5c04\u5230\u53e6\u5916\u7684\u9875\u4e0a\u3002\u53ef\u5b8c\u6210\u6b64\u529f\u80fd\u7684\u8fd9\u4e2a\u51fd\u6570\u662fget_pte\u51fd\u6570\u3002\u5b83\u7684\u539f\u578b\u4e3a pte_t * get_pte ( pde_t * pgdir , uintptr_t la , bool create ) \u4e0b\u9762\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u53ef\u4ee5\u6bd4\u8f83\u597d\u5730\u770b\u51faget_pte\u5728\u5b9e\u73b0\u4e0a\u8ff0\u6d41\u7a0b\u4e2d\u7684\u4f4d\u7f6e\uff1a \u56fe6 get_pte\u8c03\u7528\u5173\u7cfb\u56fe \u8fd9\u91cc\u6d89\u53ca\u5230\u4e09\u4e2a\u7c7b\u578bpte_t\u3001pde_t\u548cuintptr_t\u3002\u901a\u8fc7\u53c2\u89c1mm/mmlayout.h\u548clibs/types.h\uff0c\u53ef\u77e5\u5b83\u4eec\u5176\u5b9e\u90fd\u662funsigned int\u7c7b\u578b\u3002\u5728\u6b64\u505a\u533a\u5206\uff0c\u662f\u4e3a\u4e86\u5206\u6e05\u6982\u5ff5\u3002 pde_t\u5168\u79f0\u4e3a page directory entry\uff0c\u4e5f\u5c31\u662f\u4e00\u7ea7\u9875\u8868\u7684\u8868\u9879\uff08\u6ce8\u610f\uff1apgdir\u5b9e\u9645\u4e0d\u662f\u8868\u9879\uff0c\u800c\u662f\u4e00\u7ea7\u9875\u8868\u672c\u8eab\u3002\u5b9e\u9645\u4e0a\u5e94\u8be5\u65b0\u5b9a\u4e49\u4e00\u4e2a\u7c7b\u578bpgd_t\u6765\u8868\u793a\u4e00\u7ea7\u9875\u8868\u672c\u8eab\uff09\u3002pte_t\u5168\u79f0\u4e3a page table entry\uff0c\u8868\u793a\u4e8c\u7ea7\u9875\u8868\u7684\u8868\u9879\u3002uintptr_t\u8868\u793a\u4e3a\u7ebf\u6027\u5730\u5740\uff0c\u7531\u4e8e\u6bb5\u5f0f\u7ba1\u7406\u53ea\u505a\u76f4\u63a5\u6620\u5c04\uff0c\u6240\u4ee5\u5b83\u4e5f\u662f\u903b\u8f91\u5730\u5740\u3002 pgdir\u7ed9\u51fa\u9875\u8868\u8d77\u59cb\u5730\u5740\u3002\u901a\u8fc7\u67e5\u627e\u8fd9\u4e2a\u9875\u8868\uff0c\u6211\u4eec\u9700\u8981\u7ed9\u51fa\u4e8c\u7ea7\u9875\u8868\u4e2d\u5bf9\u5e94\u9879\u7684\u5730\u5740\u3002\u867d\u7136\u76ee\u524d\u6211\u4eec\u53ea\u6709boot_pgdir\u4e00\u4e2a\u9875\u8868\uff0c\u4f46\u662f\u5f15\u5165\u8fdb\u7a0b\u7684\u6982\u5ff5\u4e4b\u540e\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u4f1a\u6709\u81ea\u5df1\u7684\u9875\u8868\u3002 \u6709\u53ef\u80fd\u6839\u672c\u5c31\u6ca1\u6709\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u4e8c\u7ea7\u9875\u8868\u4e0d\u5fc5\u8981\u4e00\u5f00\u59cb\u5c31\u5206\u914d\uff0c\u800c\u662f\u7b49\u5230\u9700\u8981\u7684\u65f6\u5019\u518d\u6dfb\u52a0\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u3002\u5982\u679c\u5728\u67e5\u627e\u4e8c\u7ea7\u9875\u8868\u9879\u65f6\uff0c\u53d1\u73b0\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u4e0d\u5b58\u5728\uff0c\u5219\u9700\u8981\u6839\u636ecreate\u53c2\u6570\u7684\u503c\u6765\u5904\u7406\u662f\u5426\u521b\u5efa\u65b0\u7684\u4e8c\u7ea7\u9875\u8868\u3002\u5982\u679ccreate\u53c2\u6570\u4e3a0\uff0c\u5219get_pte\u8fd4\u56deNULL\uff1b\u5982\u679ccreate\u53c2\u6570\u4e0d\u4e3a0\uff0c\u5219get_pte\u9700\u8981\u7533\u8bf7\u4e00\u4e2a\u65b0\u7684\u7269\u7406\u9875\uff08\u901a\u8fc7alloc_page\u6765\u5b9e\u73b0\uff0c\u53ef\u5728mm/pmm.h\u4e2d\u627e\u5230\u5b83\u7684\u5b9a\u4e49\uff09\uff0c\u518d\u5728\u4e00\u7ea7\u9875\u8868\u4e2d\u6dfb\u52a0\u9875\u76ee\u5f55\u9879\u6307\u5411\u8868\u793a\u4e8c\u7ea7\u9875\u8868\u7684\u65b0\u7269\u7406\u9875\u3002\u6ce8\u610f\uff0c\u65b0\u7533\u8bf7\u7684\u9875\u5fc5\u987b\u5168\u90e8\u8bbe\u5b9a\u4e3a\u96f6\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u9875\u6240\u4ee3\u8868\u7684\u865a\u62df\u5730\u5740\u90fd\u6ca1\u6709\u88ab\u6620\u5c04\u3002 \u5f53\u5efa\u7acb\u4ece\u4e00\u7ea7\u9875\u8868\u5230\u4e8c\u7ea7\u9875\u8868\u7684\u6620\u5c04\u65f6\uff0c\u9700\u8981\u6ce8\u610f\u8bbe\u7f6e\u63a7\u5236\u4f4d\u3002\u8fd9\u91cc\u5e94\u8be5\u8bbe\u7f6e\u540c\u65f6\u8bbe\u7f6e\u4e0aPTE_U\u3001PTE_W\u548cPTE_P\uff08\u5b9a\u4e49\u5728mm/mmu.h\uff09\u3002\u5982\u679c\u539f\u6765\u5c31\u6709\u4e8c\u7ea7\u9875\u8868\uff0c\u6216\u8005\u65b0\u5efa\u7acb\u4e86\u9875\u8868\uff0c\u5219\u53ea\u9700\u8fd4\u56de\u5bf9\u5e94\u9879\u7684\u5730\u5740\u5373\u53ef\u3002 \u865a\u62df\u5730\u5740\u53ea\u6709\u6620\u5c04\u4e0a\u4e86\u7269\u7406\u9875\u624d\u53ef\u4ee5\u6b63\u5e38\u7684\u8bfb\u5199\u3002\u5728\u5b8c\u6210\u6620\u5c04\u7269\u7406\u9875\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9664\u4e86\u8981\u50cf\u4e0a\u9762\u90a3\u6837\u5728\u9875\u8868\u7684\u5bf9\u5e94\u8868\u9879\u4e0a\u586b\u4e0a\u76f8\u5e94\u7684\u7269\u7406\u5730\u5740\u5916\uff0c\u8fd8\u8981\u8bbe\u7f6e\u6b63\u786e\u7684\u63a7\u5236\u4f4d\u3002 \u53ea\u6709\u5f53\u4e00\u7ea7\u4e8c\u7ea7\u9875\u8868\u7684\u9879\u90fd\u8bbe\u7f6e\u4e86\u7528\u6237\u5199\u6743\u9650\u540e\uff0c\u7528\u6237\u624d\u80fd\u5bf9\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\u8fdb\u884c\u8bfb\u5199\u3002\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u7ea7\u9875\u8868\u5148\u7ed9\u7528\u6237\u5199\u6743\u9650\uff0c\u518d\u5728\u4e8c\u7ea7\u9875\u8868\u4e0a\u9762\u6839\u636e\u9700\u8981\u9650\u5236\u7528\u6237\u7684\u6743\u9650\uff0c\u5bf9\u7269\u7406\u9875\u8fdb\u884c\u4fdd\u62a4\u3002\u7531\u4e8e\u4e00\u4e2a\u7269\u7406\u9875\u53ef\u80fd\u88ab\u6620\u5c04\u5230\u4e0d\u540c\u7684\u865a\u62df\u5730\u5740\u4e0a\u53bb\uff08\u8b6c\u5982\u4e00\u5757\u5185\u5b58\u5728\u4e0d\u540c\u8fdb\u7a0b\u95f4\u5171\u4eab\uff09\uff0c\u5f53\u8fd9\u4e2a\u9875\u9700\u8981\u5728\u4e00\u4e2a\u5730\u5740\u4e0a\u89e3\u9664\u6620\u5c04\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u80fd\u76f4\u63a5\u628a\u8fd9\u4e2a\u9875\u56de\u6536\uff0c\u800c\u662f\u8981\u5148\u770b\u770b\u5b83\u8fd8\u6709\u6ca1\u6709\u6620\u5c04\u5230\u522b\u7684\u865a\u62df\u5730\u5740\u4e0a\u3002\u8fd9\u662f\u901a\u8fc7\u67e5\u627e\u7ba1\u7406\u8be5\u7269\u7406\u9875\u7684Page\u6570\u636e\u7ed3\u6784\u7684\u6210\u5458\u53d8\u91cfref\uff08\u7528\u6765\u8868\u793a\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\u5173\u7cfb\u7684\u4e2a\u6570\uff09\u6765\u5b9e\u73b0\u7684\uff0c\u5982\u679cref\u4e3a0\u4e86\uff0c\u8868\u793a\u6ca1\u6709\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\u5173\u7cfb\u4e86\uff0c\u5c31\u53ef\u4ee5\u628a\u8fd9\u4e2a\u7269\u7406\u9875\u7ed9\u56de\u6536\u4e86\uff0c\u4ece\u800c\u8fd9\u4e2a\u7269\u7406\u9875\u662ffree\u7684\u4e86\uff0c\u53ef\u4ee5\u518d\u88ab\u5206\u914d\u3002page_insert\u51fd\u6570\u5c06\u7269\u7406\u9875\u6620\u5c04\u5728\u4e86\u9875\u8868\u4e0a\u3002\u53ef\u53c2\u770bpage_insert\u51fd\u6570\u7684\u5b9e\u73b0\u6765\u4e86\u89e3ucore\u5185\u6838\u662f\u5982\u4f55\u7ef4\u62a4\u8fd9\u4e2a\u53d8\u91cf\u7684\u3002\u5f53\u4e0d\u9700\u8981\u518d\u8bbf\u95ee\u8fd9\u5757\u865a\u62df\u5730\u5740\u65f6\uff0c\u53ef\u4ee5\u628a\u8fd9\u5757\u7269\u7406\u9875\u56de\u6536\u5e76\u5728\u5c06\u6765\u7528\u5728\u5176\u4ed6\u5730\u65b9\u3002\u53d6\u6d88\u6620\u5c04\u7531page_remove\u6765\u505a\uff0c\u8fd9\u5176\u5b9e\u662fpage_insert\u7684\u9006\u64cd\u4f5c\u3002 \u5efa\u7acb\u597d\u4e00\u4e00\u6620\u5c04\u7684\u4e8c\u7ea7\u9875\u8868\u7ed3\u6784\u540e\uff0c\u7531\u4e8e\u5206\u9875\u673a\u5236\u5728\u524d\u4e00\u8282\u6240\u8ff0\u7684\u524d\u4e24\u4e2a\u9636\u6bb5\u5df2\u7ecf\u5f00\u542f\uff0c\u5206\u9875\u673a\u5236\u5230\u6b64\u521d\u59cb\u5316\u5b8c\u6bd5\u3002\u5f53\u6267\u884c\u5b8c\u6bd5gdt_init\u51fd\u6570\u540e\uff0c\u65b0\u7684\u6bb5\u9875\u5f0f\u6620\u5c04\u5df2\u7ecf\u5efa\u7acb\u597d\u4e86\u3002 \u5728pmm_init\u51fd\u6570\u5efa\u7acb\u5b8c\u5b9e\u73b0\u7269\u7406\u5185\u5b58\u4e00\u4e00\u6620\u5c04\u548c\u9875\u76ee\u5f55\u8868\u81ea\u6620\u5c04\u7684\u9875\u76ee\u5f55\u8868\u548c\u9875\u8868\u540e\uff0cucore\u770b\u5230\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5982\u4e0b\u56fe\u6240\u793a\uff1a Virtual memory map: Permissions kernel/user 4G ------------------> +---------------------------------+ | | | Mapped(2G) | | | KERNTOP ------------> +---------------------------------+ 0xBFFF_FFFF | | | Unmapped cached(DMW0 512M) | | | KERNBASE-------------> +---------------------------------+ 0xa0000000 | | | Unmapped uncached(DMW1 512M) | RW/-- KMEMSIZE | | +---------------------------------+ 0x80000000 | | | User Mapped | | | ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 0x00000000","title":"\u4ee3\u7801\u8bb2\u89e3"},{"location":"lab2/code/#_1","text":"\u5728\u83b7\u5f97\u53ef\u7528\u7269\u7406\u5185\u5b58\u8303\u56f4\u540e\uff0c\u7cfb\u7edf\u9700\u8981\u5efa\u7acb\u76f8\u5e94\u7684\u6570\u636e\u7ed3\u6784\u6765\u7ba1\u7406\u4ee5\u7269\u7406\u9875\uff08\u63094KB\u5bf9\u9f50\uff0c\u4e14\u5927\u5c0f\u4e3a4KB\u7684\u7269\u7406\u5185\u5b58\u5355\u5143\uff09\u4e3a\u6700\u5c0f\u5355\u4f4d\u7684\u6574\u4e2a\u7269\u7406\u5185\u5b58\uff0c\u4ee5\u914d\u5408\u540e\u7eed\u6d89\u53ca\u7684\u5206\u9875\u7ba1\u7406\u673a\u5236\u3002\u6bcf\u4e2a\u7269\u7406\u9875\u53ef\u4ee5\u7528\u4e00\u4e2aPage\u6570\u636e\u7ed3\u6784\u6765\u8868\u793a\u3002\u7531\u4e8e\u4e00\u4e2a\u7269\u7406\u9875\u9700\u8981\u5360\u7528\u4e00\u4e2aPage\u7ed3\u6784\u7684\u7a7a\u95f4\uff0cPage\u7ed3\u6784\u5728\u8bbe\u8ba1\u65f6\u987b\u5c3d\u53ef\u80fd\u5c0f\uff0c\u4ee5\u51cf\u5c11\u5bf9\u5185\u5b58\u7684\u5360\u7528\u3002Page\u7684\u5b9a\u4e49\u5728kern/mm/memlayout.h\u4e2d\u3002\u4ee5\u9875\u4e3a\u5355\u4f4d\u7684\u7269\u7406\u5185\u5b58\u5206\u914d\u7ba1\u7406\u7684\u5b9e\u73b0\u5728kern/default_pmm.c\u4e2d\u3002 \u4e3a\u4e86\u4e0e\u4ee5\u540e\u7684\u5206\u9875\u673a\u5236\u914d\u5408\uff0c\u6211\u4eec\u9996\u5148\u9700\u8981\u5efa\u7acb\u5bf9\u6574\u4e2a\u8ba1\u7b97\u673a\u7684\u6bcf\u4e00\u4e2a\u7269\u7406\u9875\u7684\u5c5e\u6027\u7528\u7ed3\u6784Page\u6765\u8868\u793a\uff0c\u5b83\u5305\u542b\u4e86\u6620\u5c04\u6b64\u7269\u7406\u9875\u7684\u865a\u62df\u9875\u4e2a\u6570\uff0c\u63cf\u8ff0\u7269\u7406\u9875\u5c5e\u6027\u7684flags\u548c\u53cc\u5411\u94fe\u63a5\u5404\u4e2aPage\u7ed3\u6784\u7684page_link\u53cc\u5411\u94fe\u8868\u3002 struct Page { int ref ; // page frame's reference counter uint32_t flags ; // array of flags that describe the status of the page frame unsigned int property ; // used in buddy system, stores the order (the X in 2^X) of the continuous memory block int zone_num ; // used in buddy system, the No. of zone which the page belongs to list_entry_t page_link ; // free list link list_entry_t swap_link ; // swap hash link }; \u8fd9\u91cc\u770b\u770bPage\u6570\u636e\u7ed3\u6784\u7684\u5404\u4e2a\u6210\u5458\u53d8\u91cf\u6709\u4f55\u5177\u4f53\u542b\u4e49\u3002ref\u8868\u793a\u8fd9\u9875\u88ab\u9875\u8868\u7684\u5f15\u7528\u8bb0\u6570\uff08\u5728\u201c\u5b9e\u73b0\u5206\u9875\u673a\u5236\u201d\u4e00\u8282\u4f1a\u8bb2\u5230\uff09\u3002\u5982\u679c\u8fd9\u4e2a\u9875\u88ab\u9875\u8868\u5f15\u7528\u4e86\uff0c\u5373\u5728\u67d0\u9875\u8868\u4e2d\u6709\u4e00\u4e2a\u9875\u8868\u9879\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u865a\u62df\u9875\u5230\u8fd9\u4e2aPage\u7ba1\u7406\u7684\u7269\u7406\u9875\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u5c31\u4f1a\u628aPage\u7684ref\u52a0\u4e00\uff1b\u53cd\u4e4b\uff0c\u82e5\u9875\u8868\u9879\u53d6\u6d88\uff0c\u5373\u6620\u5c04\u5173\u7cfb\u89e3\u9664\uff0c\u5c31\u4f1a\u628aPage\u7684ref\u51cf\u4e00\u3002flags\u8868\u793a\u6b64\u7269\u7406\u9875\u7684\u72b6\u6001\u6807\u8bb0\uff0c\u8fdb\u4e00\u6b65\u67e5\u770bkern/mm/memlayout.h\u4e2d\u7684\u5b9a\u4e49\uff0c\u53ef\u4ee5\u770b\u5230\uff1a /* Flags describing the status of a page frame */ #define PG_reserved 0 // the page descriptor is reserved for kernel or unusable #define PG_property 1 // the member 'property' is valid #define PG_slab 2 // page frame is included in a slab #define PG_dirty 3 // the page has been modified #define PG_swap 4 // the page is in the active or inactive page list (and swap hash table) #define PG_active 5 // the page is in the active page list \u8fd9\u8868\u793aflags\u76ee\u524d\u7528\u5230\u4e86\u516d\u4e2abit\u8868\u793a\u9875\u76ee\u524d\u5177\u6709\u7684\u516d\u79cd\u5c5e\u6027\uff0cbit 0\u8868\u793a\u6b64\u9875\u662f\u5426\u88ab\u4fdd\u7559\uff08reserved\uff09\uff0c\u5982\u679c\u662f\u88ab\u4fdd\u7559\u7684\u9875\uff0c\u5219bit 0\u4f1a\u8bbe\u7f6e\u4e3a1\uff0c\u4e14\u4e0d\u80fd\u653e\u5230\u7a7a\u95f2\u9875\u94fe\u8868\u4e2d\uff0c\u5373\u8fd9\u6837\u7684\u9875\u4e0d\u662f\u7a7a\u95f2\u9875\uff0c\u4e0d\u80fd\u52a8\u6001\u5206\u914d\u4e0e\u91ca\u653e\u3002\u6bd4\u5982\u76ee\u524d\u5185\u6838\u4ee3\u7801\u5360\u7528\u7684\u7a7a\u95f4\u5c31\u5c5e\u4e8e\u8fd9\u6837\u201c\u88ab\u4fdd\u7559\u201d\u7684\u9875\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0cbit 1\u8868\u793a\u6b64\u9875\u662f\u5426\u662ffree\u7684\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a1\uff0c\u8868\u793a\u8fd9\u9875\u662ffree\u7684\uff0c\u53ef\u4ee5\u88ab\u5206\u914d\uff1b\u5982\u679c\u8bbe\u7f6e\u4e3a0\uff0c\u8868\u793a\u8fd9\u9875\u5df2\u7ecf\u88ab\u5206\u914d\u51fa\u53bb\u4e86\uff0c\u4e0d\u80fd\u88ab\u518d\u4e8c\u6b21\u5206\u914d\u3002 \u53e6\u5916\uff0c\u672c\u5b9e\u9a8c\u8fd9\u91cc\u53d6\u7684\u540d\u5b57PG_property\u6bd4\u8f83\u4e0d\u76f4\u89c2\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u8bbe\u8ba1\u4e0d\u540c\u7684\u9875\u5206\u914d\u7b97\u6cd5\uff08best fit, buddy system\u7b49\uff09\uff0c\u90a3\u4e48\u8fd9\u4e2aPG_property\u5c31\u6709\u4e0d\u540c\u7684\u542b\u4e49\u4e86\u3002 \u5728\u672c\u5b9e\u9a8c\u4e2d\uff0cPage\u6570\u636e\u7ed3\u6784\u7684\u6210\u5458\u53d8\u91cfproperty\u7528\u6765\u8bb0\u5f55\u67d0\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\uff08\u5373\u5730\u5740\u8fde\u7eed\u7684\u7a7a\u95f2\u9875\u7684\u4e2a\u6570\uff09\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u7528\u5230\u6b64\u6210\u5458\u53d8\u91cf\u7684\u8fd9\u4e2aPage\u6bd4\u8f83\u7279\u6b8a\uff0c\u662f\u8fd9\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5730\u5740\u6700\u5c0f\u7684\u4e00\u9875\uff08\u5373\u5934\u4e00\u9875\uff0cHead Page\uff09\u3002\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5229\u7528\u8fd9\u4e2a\u9875\u7684\u6210\u5458\u53d8\u91cfproperty\u6765\u8bb0\u5f55\u5728\u6b64\u5757\u5185\u7684\u7a7a\u95f2\u9875\u7684\u4e2a\u6570\u3002\u8fd9\u91cc\u53d6\u7684\u540d\u5b57property\u4e5f\u4e0d\u662f\u5f88\u76f4\u89c2\uff0c\u539f\u56e0\u4e0e\u4e0a\u9762\u7c7b\u4f3c\uff0c\u5728\u4e0d\u540c\u7684\u9875\u5206\u914d\u7b97\u6cd5\u4e2d\uff0cproperty\u6709\u4e0d\u540c\u7684\u542b\u4e49\u3002 Page\u6570\u636e\u7ed3\u6784\u7684\u6210\u5458\u53d8\u91cfpage_link\u662f\u4fbf\u4e8e\u628a\u591a\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u94fe\u63a5\u5728\u4e00\u8d77\u7684\u53cc\u5411\u94fe\u8868\u6307\u9488\uff08\u53ef\u56de\u987e\u5728lab0\u5b9e\u9a8c\u6307\u5bfc\u4e66\u4e2d\u6709\u5173\u53cc\u5411\u94fe\u8868\u6570\u636e\u7ed3\u6784\u7684\u4ecb\u7ecd\uff09\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u7528\u5230\u6b64\u6210\u5458\u53d8\u91cf\u7684\u8fd9\u4e2aPage\u6bd4\u8f83\u7279\u6b8a\uff0c\u662f\u8fd9\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5730\u5740\u6700\u5c0f\u7684\u4e00\u9875\uff08\u5373\u5934\u4e00\u9875\uff0cHead Page\uff09\u3002\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5229\u7528\u8fd9\u4e2a\u9875\u7684\u6210\u5458\u53d8\u91cfpage_link\u6765\u94fe\u63a5\u6bd4\u5b83\u5730\u5740\u5c0f\u548c\u5927\u7684\u5176\u4ed6\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u3002 \u5728\u521d\u59cb\u60c5\u51b5\u4e0b\uff0c\u4e5f\u8bb8\u8fd9\u4e2a\u7269\u7406\u5185\u5b58\u7684\u7a7a\u95f2\u7269\u7406\u9875\u90fd\u662f\u8fde\u7eed\u7684\uff0c\u8fd9\u6837\u5c31\u5f62\u6210\u4e86\u4e00\u4e2a\u5927\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u3002\u4f46\u968f\u7740\u7269\u7406\u9875\u7684\u5206\u914d\u4e0e\u91ca\u653e\uff0c\u8fd9\u4e2a\u5927\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u4f1a\u5206\u88c2\u4e3a\u4e00\u7cfb\u5217\u5730\u5740\u4e0d\u8fde\u7eed\u7684\u591a\u4e2a\u5c0f\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\uff0c\u4e14\u6bcf\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5185\u90e8\u7684\u7269\u7406\u9875\u662f\u8fde\u7eed\u7684\u3002\u90a3\u4e48\u4e3a\u4e86\u6709\u6548\u5730\u7ba1\u7406\u8fd9\u4e9b\u5c0f\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u3002\u6240\u6709\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u53ef\u7528\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\u7ba1\u7406\u8d77\u6765\uff0c\u4fbf\u4e8e\u5206\u914d\u548c\u91ca\u653e\uff0c\u4e3a\u6b64\u5b9a\u4e49\u4e86\u4e00\u4e2afree_area_t\u6570\u636e\u7ed3\u6784\uff0c\u5305\u542b\u4e86\u4e00\u4e2alist_entry\u7ed3\u6784\u7684\u53cc\u5411\u94fe\u8868\u6307\u9488\u548c\u8bb0\u5f55\u5f53\u524d\u7a7a\u95f2\u9875\u7684\u4e2a\u6570\u7684\u65e0\u7b26\u53f7\u6574\u578b\u53d8\u91cfnr_free\u3002\u5176\u4e2d\u7684\u94fe\u8868\u6307\u9488\u6307\u5411\u4e86\u7a7a\u95f2\u7684\u7269\u7406\u9875\u3002 /* free_area_t - maintains a doubly linked list to record free (unused) pages */ typedef struct { list_entry_t free_list ; // the list header unsigned int nr_free ; // # of free pages in this free list } free_area_t ; \u6709\u4e86\u8fd9\u4e24\u4e2a\u6570\u636e\u7ed3\u6784\uff0cucore\u5c31\u53ef\u4ee5\u7ba1\u7406\u8d77\u6765\u6574\u4e2a\u4ee5\u9875\u4e3a\u5355\u4f4d\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u3002\u63a5\u4e0b\u6765\u9700\u8981\u89e3\u51b3\u4e24\u4e2a\u95ee\u9898\uff1a \u7ba1\u7406\u9875\u7ea7\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684Page\u7ed3\u6784\u7684\u5185\u5b58\u7a7a\u95f4\u4ece\u54ea\u91cc\u5f00\u59cb\uff0c\u5360\u591a\u5927\u7a7a\u95f4\uff1f \u7a7a\u95f2\u5185\u5b58\u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740\u5728\u54ea\u91cc\uff1f \u5bf9\u4e8e\u8fd9\u4e24\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u9996\u5148\u6839\u636ememlayout.h\u7ed9\u51fa\u7684\u6838\u5fc3\u6001\u5185\u5b58\u57fa\u5730\u5740KERNBASE\uff080xa0000000\uff09\u548cKMEMSIZE\uff08512M\uff09\u8ba1\u7b97\u51fa\u6700\u5927\u7684\u7269\u7406\u5185\u5b58\u5730\u5740KERNTOP\uff08\u5b9a\u4e49\u5728memlayout.h\u4e2d\uff09\uff0c\u6700\u5927\u7269\u7406\u5185\u5b58\u5730\u5740maxpa\u7b49\u4e8eKERNTOP\uff08\u5b9a\u4e49\u5728page_init\u51fd\u6570\u4e2d\u7684\u5c40\u90e8\u53d8\u91cf\uff09\uff0c\u5728\u8be5\u5b9e\u9a8c\u4e2dPage size\u4e3a4096 bytes\u53732^12 bytes\uff0c\u6240\u4ee5\u9700\u8981\u7ba1\u7406\u7684\u7269\u7406\u9875\u7684\u4e2a\u6570npage\u7684\u8ba1\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a #define KERNTOP (KERNBASE + KMEMSIZE) maxpa = KERNTOP npage = KMEMSIZE >> PGSHIFT # PGSHIFT = 12 \u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u9884\u4f30\u51fa\u7ba1\u7406\u9875\u7ea7\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684Page\u7ed3\u6784\u7684\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684\u5185\u5b58\u5927\u5c0f\u4e3a\uff1a sizeof ( struct Page ) * npage \u7531\u4e8e\u52a0\u8f7d\u5185\u6838\u7684\u7ed3\u675f\u5730\u5740\uff08\u7528\u5168\u5c40\u6307\u9488\u53d8\u91cfend\u8bb0\u5f55\uff09\u4ee5\u4e0a\u7684\u7a7a\u95f4\u6ca1\u6709\u88ab\u4f7f\u7528\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u628aend\u6309\u9875\u5927\u5c0f\u4e3a\u8fb9\u754c\u53d6\u6574\u540e\uff0c\u4f5c\u4e3a\u7ba1\u7406\u9875\u7ea7\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u6240\u9700\u7684Page\u7ed3\u6784\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u8bb0\u4e3a\uff1a pages = ( struct Page * ) ROUNDUP_2N (( void * ) end , PGSHIFT ); \u4e3a\u4e86\u7b80\u5316\u8d77\u89c1\uff0c\u4ece\u5730\u57400\u5230\u5730\u5740pages+ sizeof(struct Page) *npage)\u7ed3\u675f\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u8bbe\u5b9a\u4e3a\u5df2\u5360\u7528\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff08\u8d77\u59cb0~640KB\u7684\u7a7a\u95f4\u662f\u7a7a\u95f2\u7684\uff09\uff0c\u5730\u5740pages+sizeof(struct Page) *npage)\u4ee5\u4e0a\u7684\u7a7a\u95f4\u4e3a\u7a7a\u95f2\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u8fd9\u65f6\u7684\u7a7a\u95f2\u7a7a\u95f4\u8d77\u59cb\u5730\u5740\u4e3a uintptr_t freemem = PADDR (( uintptr_t ) pages + sizeof ( struct Page ) * npage ); \u4e3a\u6b64\u6211\u4eec\u9700\u8981\u628a\u8fd9\u4e24\u90e8\u5206\u7a7a\u95f4\u7ed9\u6807\u8bc6\u51fa\u6765\u3002\u9996\u5148\uff0c\u5bf9\u4e8e\u6240\u6709\u7269\u7406\u7a7a\u95f4\uff0c\u901a\u8fc7\u5982\u4e0b\u8bed\u53e5\u5373\u53ef\u5b9e\u73b0\u5360\u7528\u6807\u8bb0\uff1a for ( i = 0 ; i < npage ; i ++ ) { SetPageReserved ( pages + i ); } \u7136\u540e\uff0c\u6839\u636e\u63a2\u6d4b\u5230\u7684\u7a7a\u95f2\u7269\u7406\u7a7a\u95f4\uff0c\u901a\u8fc7\u5982\u4e0b\u8bed\u53e5\u5373\u53ef\u5b9e\u73b0\u7a7a\u95f2\u6807\u8bb0\uff1a //\u83b7\u5f97\u7a7a\u95f2\u7a7a\u95f4\u7684\u8d77\u59cb\u5730\u5740begin\u548c\u7ed3\u675f\u5730\u5740end ... init_memmap ( pa2page ( mbegin ), ( mend - mbegin ) >> PGSHIFT ); \u5176\u5b9eSetPageReserved\u53ea\u9700\u628a\u7269\u7406\u5730\u5740\u5bf9\u5e94\u7684Page\u7ed3\u6784\u4e2d\u7684flags\u6807\u5fd7\u8bbe\u7f6e\u4e3aPG_reserved\uff0c\u8868\u793a\u8fd9\u4e9b\u9875\u5df2\u7ecf\u88ab\u4f7f\u7528\u4e86\uff0c\u5c06\u6765\u4e0d\u80fd\u88ab\u7528\u4e8e\u5206\u914d\u3002\u800cinit_memmap\u51fd\u6570\u5219\u662f\u628a\u7a7a\u95f2\u7269\u7406\u9875\u5bf9\u5e94\u7684Page\u7ed3\u6784\u4e2d\u7684flags\u548c\u5f15\u7528\u8ba1\u6570ref\u6e05\u96f6\uff0c\u5e76\u52a0\u5230free_area.free_list\u6307\u5411\u7684\u53cc\u5411\u5217\u8868\u4e2d\uff0c\u4e3a\u5c06\u6765\u7684\u7a7a\u95f2\u9875\u7ba1\u7406\u505a\u597d\u521d\u59cb\u5316\u51c6\u5907\u5de5\u4f5c\u3002 \u5173\u4e8e\u5185\u5b58\u5206\u914d\u7684\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u65b9\u9762\u7684\u77e5\u8bc6\u6709\u5f88\u591a\uff0c\u4f46\u5728\u672c\u5b9e\u9a8c\u4e2d\u53ea\u5b9e\u73b0\u4e86\u6700\u7b80\u5355\u7684\u5185\u5b58\u9875\u5206\u914d\u7b97\u6cd5\u3002\u76f8\u5e94\u7684\u5b9e\u73b0\u5728default_pmm.c\u4e2d\u7684default_alloc_pages\u51fd\u6570\u548cdefault_free_pages\u51fd\u6570\uff0c\u76f8\u5173\u5b9e\u73b0\u5f88\u7b80\u5355\uff0c\u8fd9\u91cc\u5c31\u4e0d\u5177\u4f53\u5206\u6790\u4e86\uff0c\u76f4\u63a5\u770b\u6e90\u7801\uff0c\u5e94\u8be5\u5f88\u597d\u7406\u89e3\u3002 \u5176\u5b9e\u5b9e\u9a8c\u4e8c\u5728\u5185\u5b58\u5206\u914d\u548c\u91ca\u653e\u65b9\u9762\u6700\u4e3b\u8981\u7684\u4f5c\u7528\u662f\u5efa\u7acb\u4e86\u4e00\u4e2a\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668\u6846\u67b6\uff0c\u8fd9\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u5217\u8868\uff0c\u5b9a\u4e49\u5982\u4e0b\uff1a struct pmm_manager { const char * name ; // XXX_pmm_manager's name void ( * init )( void ); // initialize internal description&management data structure // (free block list, number of free block) of XXX_pmm_manager void ( * init_memmap )( struct Page * base , size_t n ); // setup description&management data structcure according to // the initial free physical memory space struct Page * ( * alloc_pages )( size_t n ); // allocate >=n pages, depend on the allocation algorithm void ( * free_pages )( struct Page * base , size_t n ); // free >=n pages with \"base\" addr of Page descriptor structures(memlayout.h) size_t ( * nr_free_pages )( void ); // return the number of free pages void ( * check )( void ); // check the correctness of XXX_pmm_manager }; \u91cd\u70b9\u662f\u5b9e\u73b0init_memmap/ alloc_pages/free_pages\u8fd9\u4e09\u4e2a\u51fd\u6570\u3002","title":"\u4ee5\u9875\u4e3a\u5355\u4f4d\u7ba1\u7406\u7269\u7406\u5185\u5b58"},{"location":"lab2/code/#_2","text":"\u5982\u679c\u8981\u5728ucore\u4e2d\u5b9e\u73b0\u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\uff0c\u5219\u9700\u8981\u8003\u8651\u7684\u4e8b\u60c5\u6bd4\u8f83\u591a\uff0c\u76f8\u5bf9\u8bfe\u672c\u4e0a\u7684\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u63cf\u8ff0\u8981\u590d\u6742\u4e0d\u5c11\u3002\u4e0b\u9762\u4ecb\u7ecd\u4e00\u4e0b\u5982\u679c\u8981\u5b9e\u73b0\u4e00\u4e2aFirstFit\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u5927\u81f4\u6d41\u7a0b\u3002 lab2\u7684\u7b2c\u4e00\u90e8\u5206\u662f\u5b8c\u6210first_fit\u7684\u5206\u914d\u7b97\u6cd5\u3002\u539f\u7406FirstFit\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u4e0a\u5f88\u7b80\u5355\uff0c\u4f46\u8981\u5728ucore\u4e2d\u5b9e\u73b0\uff0c\u9700\u8981\u5145\u5206\u4e86\u89e3\u548c\u5229\u7528ucore\u5df2\u6709\u7684\u6570\u636e\u7ed3\u6784\u548c\u76f8\u5173\u64cd\u4f5c\u3001\u5173\u952e\u7684\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf\u7b49\u3002 \u5173\u952e\u6570\u636e\u7ed3\u6784\u548c\u53d8\u91cf first_fit\u5206\u914d\u7b97\u6cd5\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u67e5\u627e\u6709\u5e8f\uff08\u5730\u5740\u6309\u4ece\u5c0f\u5230\u5927\u6392\u5217\uff09\u7a7a\u95f2\u5757\uff08\u4ee5\u9875\u4e3a\u6700\u5c0f\u5355\u4f4d\u7684\u8fde\u7eed\u5730\u5740\u7a7a\u95f4\uff09\u7684\u6570\u636e\u7ed3\u6784\uff0c\u800c\u53cc\u5411\u94fe\u8868\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u9009\u62e9\u3002 kernel/include/list.h\u5b9a\u4e49\u4e86\u53ef\u6302\u63a5\u4efb\u610f\u5143\u7d20\u7684\u901a\u7528\u53cc\u5411\u94fe\u8868\u7ed3\u6784\u548c\u5bf9\u5e94\u7684\u64cd\u4f5c\uff0c\u6240\u4ee5\u9700\u8981\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u8fd9\u4e2a\u6587\u4ef6\u63d0\u4f9b\u7684\u5404\u79cd\u51fd\u6570\uff0c\u4ece\u800c\u53ef\u4ee5\u5b8c\u6210\u5bf9\u53cc\u5411\u94fe\u8868\u7684\u521d\u59cb\u5316/\u63d2\u5165/\u5220\u9664\u7b49\u3002 kern/mm/memlayout.h\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a free_area_t \u6570\u636e\u7ed3\u6784\uff0c\u5305\u542b\u6210\u5458\u7ed3\u6784 list_entry_t free_list ; // the list header \u7a7a\u95f2\u5757\u53cc\u5411\u94fe\u8868\u7684\u5934 unsigned int nr_free ; // # of free pages in this free list \u7a7a\u95f2\u5757\u7684\u603b\u6570\uff08\u4ee5\u9875\u4e3a\u5355\u4f4d\uff09 \u663e\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6b64\u6570\u636e\u7ed3\u6784\u6765\u5b8c\u6210\u5bf9\u7a7a\u95f2\u5757\u7684\u7ba1\u7406\u3002\u800cbuddy_pmm.c\u4e2d\u5b9a\u4e49\u7684free_area\u53d8\u91cf\u5c31\u662f\u5e72\u8fd9\u4e2a\u4e8b\u60c5\u7684\u3002 kern/mm/pmm.h\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a\u901a\u7528\u7684\u5206\u914d\u7b97\u6cd5\u7684\u51fd\u6570\u5217\u8868\uff0c\u7528pmm_manager\u8868\u793a\u3002\u5176\u4e2dinit\u51fd\u6570\u5c31\u662f\u7528\u6765\u521d\u59cb\u5316free_area\u53d8\u91cf\u7684,first_fit\u5206\u914d\u7b97\u6cd5\u53ef\u76f4\u63a5\u91cd\u7528buddy_init\u51fd\u6570\u7684\u5b9e\u73b0\u3002init_memmap\u51fd\u6570\u9700\u8981\u6839\u636e\u73b0\u6709\u7684\u5185\u5b58\u60c5\u51b5\u6784\u5efa\u7a7a\u95f2\u5757\u5217\u8868\u7684\u521d\u59cb\u72b6\u6001\u3002\u4f55\u65f6\u5e94\u8be5\u6267\u884c\u8fd9\u4e2a\u51fd\u6570\u5462\uff1f \u901a\u8fc7\u5206\u6790\u4ee3\u7801\uff0c\u53ef\u4ee5\u77e5\u9053\uff1a kern_init --> pmm_init-->page_init-->init_memmap--> pmm_manager->init_memmap \u6240\u4ee5\uff0cdefault_init_memmap\u9700\u8981\u6839\u636epage_init\u51fd\u6570\u4e2d\u4f20\u9012\u8fc7\u6765\u7684\u53c2\u6570\uff08\u67d0\u4e2a\u8fde\u7eed\u5730\u5740\u7684\u7a7a\u95f2\u5757\u7684\u8d77\u59cb\u9875\uff0c\u9875\u4e2a\u6570\uff09\u6765\u5efa\u7acb\u4e00\u4e2a\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u7684\u53cc\u5411\u94fe\u8868\u3002\u8fd9\u91cc\u6709\u4e00\u4e2a\u5047\u5b9apage_init\u51fd\u6570\u662f\u6309\u5730\u5740\u4ece\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u4f20\u6765\u7684\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u7684\u3002\u94fe\u8868\u5934\u662ffree_area.free_list\uff0c\u94fe\u8868\u9879\u662fPage\u6570\u636e\u7ed3\u6784\u7684base->page_link\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u4f9d\u9760Page\u6570\u636e\u7ed3\u6784\u4e2d\u7684\u6210\u5458\u53d8\u91cfpage_link\u5f62\u6210\u4e86\u8fde\u7eed\u5185\u5b58\u7a7a\u95f2\u5757\u5217\u8868\u3002 \u8bbe\u8ba1\u5b9e\u73b0 default_init_memmap\u51fd\u6570\u5c06\u6839\u636e\u6bcf\u4e2a\u7269\u7406\u9875\u5e27\u7684\u60c5\u51b5\u6765\u5efa\u7acb\u7a7a\u95f2\u9875\u94fe\u8868\uff0c\u4e14\u7a7a\u95f2\u9875\u5757\u5e94\u8be5\u662f\u6839\u636e\u5730\u5740\u9ad8\u4f4e\u5f62\u6210\u4e00\u4e2a\u6709\u5e8f\u94fe\u8868\u3002\u6839\u636e\u4e0a\u8ff0\u53d8\u91cf\u7684\u5b9a\u4e49\uff0cdefault_init_memmap\u53ef\u5927\u81f4\u5b9e\u73b0\u5982\u4e0b\uff1a default_init_memmap ( struct Page * base , size_t n ) { assert ( n > 0 ); struct Page * p = base ; for (; p != base + n ; p ++ ) { assert ( PageReserved ( p )); p -> flags = p -> property = 0 ; set_page_ref ( p , 0 ); } base -> property = n ; SetPageProperty ( base ); nr_free += n ; list_add_before ( & free_list , & ( base -> page_link )); } \u5982\u679c\u8981\u5206\u914d\u4e00\u4e2a\u9875\uff0c\u90a3\u8981\u8003\u8651\u54ea\u4e9b\u5462\uff1f\u8fd9\u91cc\u5c31\u9700\u8981\u8003\u8651\u5b9e\u73b0default_alloc_pages\u51fd\u6570\uff0c\u6ce8\u610f\u53c2\u6570n\u8868\u793a\u8981\u5206\u914dn\u4e2a\u9875\u3002\u53e6\u5916\uff0c\u9700\u8981\u6ce8\u610f\u5b9e\u73b0\u65f6\u5c3d\u91cf\u591a\u8003\u8651\u4e00\u4e9b\u8fb9\u754c\u60c5\u51b5\uff0c\u8fd9\u6837\u786e\u4fdd\u8f6f\u4ef6\u7684\u9c81\u68d2\u6027\u3002\u6bd4\u5982 if ( n > nr_free ) { return NULL ; } \u8fd9\u6837\u53ef\u4ee5\u786e\u4fdd\u5206\u914d\u4e0d\u4f1a\u8d85\u51fa\u8303\u56f4\u3002\u4e5f\u53ef\u52a0\u4e00\u4e9bassert\u51fd\u6570\uff0c\u5728\u6709\u9519\u8bef\u51fa\u73b0\u65f6\uff0c\u80fd\u591f\u8fc5\u901f\u53d1\u73b0\u3002\u6bd4\u5982 n\u5e94\u8be5\u5927\u4e8e0\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u52a0\u4e0a assert ( n > 0 ); \u8fd9\u6837\u5728n<=0\u7684\u60c5\u51b5\u4e0b\uff0cucore\u4f1a\u8fc5\u901f\u62a5\u9519\u3002firstfit\u9700\u8981\u4ece\u7a7a\u95f2\u94fe\u8868\u5934\u5f00\u59cb\u67e5\u627e\u6700\u5c0f\u7684\u5730\u5740\uff0c\u901a\u8fc7list_next\u627e\u5230\u4e0b\u4e00\u4e2a\u7a7a\u95f2\u5757\u5143\u7d20\uff0c\u901a\u8fc7le2page\u5b8f\u53ef\u4ee5\u7531\u94fe\u8868\u5143\u7d20\u83b7\u5f97\u5bf9\u5e94\u7684Page\u6307\u9488p\u3002\u901a\u8fc7p->property\u53ef\u4ee5\u4e86\u89e3\u6b64\u7a7a\u95f2\u5757\u7684\u5927\u5c0f\u3002\u5982\u679c>=n\uff0c\u8fd9\u5c31\u627e\u5230\u4e86\uff01\u5982\u679c<n\uff0c\u5219list_next\uff0c\u7ee7\u7eed\u67e5\u627e\u3002\u76f4\u5230list_next== &free_list\uff0c\u8fd9\u8868\u793a\u627e\u5b8c\u4e86\u4e00\u904d\u4e86\u3002\u627e\u5230\u540e\uff0c\u5c31\u8981\u4ece\u65b0\u7ec4\u7ec7\u7a7a\u95f2\u5757\uff0c\u7136\u540e\u628a\u627e\u5230\u7684page\u8fd4\u56de\u3002\u6240\u4ee5default_alloc_pages\u53ef\u5927\u81f4\u5b9e\u73b0\u5982\u4e0b\uff1a default_alloc_pages ( size_t n ) { assert ( n > 0 ); if ( n > nr_free ) { return NULL ; } struct Page * page = NULL ; list_entry_t * le = & free_list ; // TODO: optimize (next-fit) while (( le = list_next ( le )) != & free_list ) { struct Page * p = le2page ( le , page_link ); if ( p -> property >= n ) { page = p ; break ; } } if ( page != NULL ) { if ( page -> property > n ) { struct Page * p = page + n ; p -> property = page -> property - n ; SetPageProperty ( p ); list_add_after ( & ( page -> page_link ), & ( p -> page_link )); } list_del ( & ( page -> page_link )); nr_free -= n ; ClearPageProperty ( page ); } return page ; } default_free_pages\u51fd\u6570\u7684\u5b9e\u73b0\u5176\u5b9e\u662fdefault_alloc_pages\u7684\u9006\u8fc7\u7a0b\uff0c\u4e0d\u8fc7\u9700\u8981\u8003\u8651\u7a7a\u95f2\u5757\u7684\u5408\u5e76\u95ee\u9898\u3002\u8fd9\u91cc\u5c31\u4e0d\u518d\u7ec6\u8bb2\u4e86\u3002\u6ce8\u610f\uff0c\u4e0a\u8bc9\u4ee3\u7801\u53ea\u662f\u53c2\u8003\u8bbe\u8ba1\uff0c\u4e0d\u662f\u5b8c\u6574\u7684\u6b63\u786e\u8bbe\u8ba1\u3002\u66f4\u8be6\u7ec6\u7684\u8bf4\u660e\u4f4d\u4e8elab2/kernel/mm/default_pmm.c\u7684\u6ce8\u91ca\u4e2d\u3002\u5e0c\u671b\u540c\u5b66\u80fd\u591f\u987a\u5229\u5b8c\u6210\u672c\u5b9e\u9a8c\u7684\u7b2c\u4e00\u90e8\u5206\u3002","title":"\u7269\u7406\u5185\u5b58\u9875\u5206\u914d\u7b97\u6cd5\u5b9e\u73b0"},{"location":"lab2/code/#_3","text":"\u5728lab1\u548clab2\u4e2d\u90fd\u4f1a\u6d89\u53ca\u5982\u4f55\u5efa\u7acb\u6620\u5c04\u5173\u7cfb\u7684\u64cd\u4f5c\uff0c\u5728\u9f99\u82af\u67b6\u6784\u4e2dMMU\u652f\u6301\u4e24\u79cd\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff1a\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u548c\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002\u76f4\u63a5\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u4e0b\u7269\u7406\u5730\u5740\u9ed8\u8ba4\u76f4\u63a5\u7b49\u4e8e\u865a\u62df\u5730\u5740\u7684[PALEN-1:0]\u4f4d\uff08\u4e0d\u8db3\u88650\uff09\u3002\u5f53\u5904\u7406\u5668\u6838\u7684MMU\u5904\u4e8e\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\uff0c\u5177\u4f53\u53c8\u5206\u4e3a\u76f4\u63a5\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u548c\u9875\u8868\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002\u76f4\u63a5\u6620\u5c04\u5730\u5740\u6a21\u5f0f\u662f\u901a\u8fc7\u76f4\u63a5\u6620\u5c04\u914d\u7f6e\u7a97\u53e3\u673a\u5236\u5b8c\u6210\u865a\u5b9e\u5730\u5740\u7684\u76f4\u63a5\u6620\u5c04\uff0c\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u901a\u8fc7\u9875\u8868\u5b8c\u6210\u6620\u5c04\u3002 \u5728lab1\u548clab2\u4e2d\u6211\u4eec\u5728ucore\u7684\u5165\u53e3\u51fd\u6570kernel_entry\uff08entry.S\u6587\u4ef6\u4e2d\uff09\u4e2d\u8bbe\u7f6e\u4e86CSR.CRMD\u7684DA=0\u4e14PG=1\uff0c\u5373\u5904\u7406\u5668\u6838\u7684MMU\u5904\u4e8e\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002\u540c\u65f6\uff0c\u6211\u4eec\u5c06CSR.DWM0\u5bc4\u5b58\u5668\u7684\u503c\u8bbe\u7f6e\u4e3a0xa0000001\uff0c\u8868\u793a 0xa0000000-0xbfffffff\u6bb5\u7684\u865a\u62df\u5730\u5740\u901a\u8fc7\u76f4\u63a5\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u6620\u5c04\u52300x00000000-0x1fffffff\u7684\u7269\u7406\u5730\u5740\u3002\u5c06CSR.DWM1\u5bc4\u5b58\u5668\u7684\u503c\u8bbe\u7f6e\u4e3a0x80000011\uff0c\u8868\u793a0x80000000-0x9fffffff\u6bb5\u7684\u865a\u62df\u5730\u5740\u7528\u8fc7\u76f4\u63a5\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u6620\u5c04\u52300x00000000-0x1fffffff\u7684\u7269\u7406\u5730\u5740\u3002\u9664\u4e86\u8fd9\u4e24\u6bb5\u865a\u62df\u5730\u5740\u4e4b\u5916\u7684\u865a\u62df\u5730\u5740\u90fd\u662f\u901a\u8fc7\u9875\u8868\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u8fdb\u884c\u6620\u5c04\u3002 \u4e0b\u9762\uff0c\u6211\u4eec\u6765\u770b\u770b\u5982\u4f55\u6539\u53d8\u5185\u6838\u7684\u8d77\u59cb\u5730\u5740\u3002\u89c2\u5bdf\u4e00\u4e0b\u94fe\u63a5\u811a\u672c\uff0c\u5373tools/kernel.ld\u6587\u4ef6\uff1a OUTPUT_ARCH(loongarch) ENTRY(kernel_entry) SECTIONS { . = 0xa0000000; .text : { . = ALIGN(4); wrs_kernel_text_start = .; _wrs_kernel_text_start = .; *(.startup) *(.text) *(.text.*) *(.gnu.linkonce.t*) *(.mips16.fn.*) *(.mips16.call.*) /* for MIPS */ *(.rodata) *(.rodata.*) *(.gnu.linkonce.r*) *(.rodata1) . = ALIGN(4096); *(.ramexv) } \u4ece\u4e0a\u8ff0\u4ee3\u7801\u53ef\u4ee5\u770b\u51fald\u5de5\u5177\u5f62\u6210\u7684ucore\u7684\u8d77\u59cb\u865a\u62df\u5730\u5740\u4ece0xa0000000\u5f00\u59cb\uff0c\u7531\u4e8e\u8fd9\u4e2a\u6bb5\u7684\u5730\u5740\u662f\u76f4\u63a5\u6620\u5c04\u5730\u5740\u6bb5\uff0c\u6240\u4ee5\u5176\u8d77\u59cb\u7684\u7269\u7406\u5730\u5740\u4e3a0x00000000\uff0c\u5373 phy addr = CSR.DMW0[31:29] : virtual addr[28:0] \u7b2c\u4e00\u4e2a\u9636\u6bb5 \u4ecekernel_entry\u51fd\u6570\u5f00\u59cb\u5230pmm_init\u51fd\u6570\u6267\u884c\u4e4b\u524d\uff0cucore\u91c7\u7528\u76f4\u63a5\u6620\u5c04\u5730\u5740\u65b9\u5f0f\u8fdb\u884c\u5730\u5740\u7ffb\u8bd1\uff0c\u7ffb\u8bd1\u65b9\u5f0f\u5982\u4e0a\u3002\u6ce8\u610f\uff0c\u7531\u4e8e0x80000000-0x9fffffff\u548c0xa0000000-0xbfffffff\u624d\u80fd\u8fdb\u884c\u76f4\u63a5\u6620\u5c04\uff0c\u6240\u4ee5\u5185\u6838\u7684\u5927\u5c0f\u4e0d\u80fd\u8d85\u8fc7512M\u3002 \u7b2c\u4e8c\u4e2a\u9636\u6bb5 \uff08\u521b\u5efa\u521d\u59cb\u9875\u76ee\u5f55\u8868\uff0c\u5f00\u542f\u5206\u9875\u6a21\u5f0f\uff09\u4ecepmm_init\u51fd\u6570\u88ab\u8c03\u7528\u5f00\u59cb\uff0c\u5728pmm_init\u51fd\u6570\u4e2d\u521b\u5efa\u4e86boot_pgdir\uff0c\u521d\u59cb\u5316\u4e86\u9875\u76ee\u5f55\u8868\uff0c\u6b63\u5f0f\u5f00\u59cb\u4e86\u9875\u8868\u6620\u5c04\u5730\u5740\u7ffb\u8bd1\u6a21\u5f0f\u3002","title":"\u7cfb\u7edf\u6267\u884c\u4e2d\u5730\u5740\u6620\u5c04\u7684\u8fc7\u7a0b"},{"location":"lab2/code/#_4","text":"\u5efa\u7acb\u4e8c\u7ea7\u9875\u8868 \u5728LoongArch32\u91c7\u7528\u4e86\u4e0eMIPS\u76f8\u540c\u7684\u8f6f\u4ef6\u5b9a\u4e49\u9875\u8868\u7684\u65b9\u5f0f\uff0c\u56e0\u6b64\u5185\u6838\u53ef\u4ee5\u81ea\u7531\u91c7\u53d6\u9875\u8868\u7684\u5b9a\u4e49\u65b9\u5f0f\u3002\u7531\u4e8e\u8be5\u7248\u672cuCore\u81eax86\u67b6\u6784\u79fb\u690d\u800c\u6765\uff0c\u56e0\u6b64\u6cbf\u7528\u4e86x86\u7684\u7c7b\u4f3c\u65b9\u5f0f\u91c7\u7528\u4e8c\u7ea7\u9875\u8868\u6765\u5efa\u7acb\u903b\u8f91\u5730\u5740\u4e0e\u7269\u7406\u5730\u5740\u4e4b\u95f4\u7684\u6620\u5c04\u5173\u7cfb\u3002\u7531\u4e8e\u6211\u4eec\u5df2\u7ecf\u5177\u6709\u4e86\u4e00\u4e2a\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668default_pmm_manager\uff0c\u652f\u6301\u52a8\u6001\u5206\u914d\u548c\u91ca\u653e\u5185\u5b58\u9875\u7684\u529f\u80fd\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u5b83\u6765\u83b7\u5f97\u6240\u9700\u7684\u7a7a\u95f2\u7269\u7406\u9875\u3002\u5728\u4e8c\u7ea7\u9875\u8868\u7ed3\u6784\u4e2d\uff0c\u9875\u76ee\u5f55\u8868\u53604KB\u7a7a\u95f4\uff0c\u53ef\u901a\u8fc7alloc_page\u51fd\u6570\u83b7\u5f97\u4e00\u4e2a\u7a7a\u95f2\u7269\u7406\u9875\u4f5c\u4e3a\u9875\u76ee\u5f55\u8868\uff08Page Directory Table\uff0cPDT\uff09\u3002\u540c\u7406\uff0cucore\u4e5f\u901a\u8fc7\u8fd9\u79cd\u7c7b\u4f3c\u65b9\u5f0f\u83b7\u5f97\u4e00\u4e2a\u9875\u8868\uff08Page Table\uff0cPT\uff09\u6240\u9700\u76844KB\u7a7a\u95f4\u3002 \u6574\u4e2a\u9875\u76ee\u5f55\u8868\u548c\u9875\u8868\u6240\u5360\u7a7a\u95f4\u5927\u5c0f\u53d6\u51b3\u4e0e\u4e8c\u7ea7\u9875\u8868\u8981\u7ba1\u7406\u548c\u6620\u5c04\u7684\u7269\u7406\u9875\u6570\u3002\u5047\u5b9a\u5f53\u524d\u7269\u7406\u5185\u5b580~16MB\uff0c\u6bcf\u7269\u7406\u9875\uff08\u4e5f\u79f0Page Frame\uff09\u5927\u5c0f\u4e3a4KB\uff0c\u5219\u67094096\u4e2a\u7269\u7406\u9875\uff0c\u4e5f\u5c31\u610f\u5473\u8fd9\u67094\u4e2a\u9875\u76ee\u5f55\u9879\u548c4096\u4e2a\u9875\u8868\u9879\u9700\u8981\u8bbe\u7f6e\u3002\u4e00\u4e2a\u9875\u76ee\u5f55\u9879\uff08Page Directory Entry\uff0cPDE\uff09\u548c\u4e00\u4e2a\u9875\u8868\u9879\uff08Page Table Entry\uff0cPTE\uff09\u53604B\u3002\u5373\u4f7f\u662f4\u4e2a\u9875\u76ee\u5f55\u9879\u4e5f\u9700\u8981\u4e00\u4e2a\u5b8c\u6574\u7684\u9875\u76ee\u5f55\u8868\uff08\u53604KB\uff09\u3002\u800c4096\u4e2a\u9875\u8868\u9879\u9700\u898116KB\uff08\u53734096*4B\uff09\u7684\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f4\u4e2a\u7269\u7406\u9875\uff0c16KB\u7684\u7a7a\u95f4\u3002\u6240\u4ee5\u5bf916MB\u7269\u7406\u9875\u5efa\u7acb\u4e00\u4e00\u6620\u5c04\u768416MB\u865a\u62df\u9875\uff0c\u9700\u89815\u4e2a\u7269\u7406\u9875\uff0c\u537320KB\u7684\u7a7a\u95f4\u6765\u5f62\u6210\u4e8c\u7ea7\u9875\u8868\u3002 \u5b8c\u6210\u524d\u4e00\u8282\u6240\u8ff0\u7684\u524d\u4e24\u4e2a\u9636\u6bb5\u7684\u5730\u5740\u6620\u5c04\u53d8\u5316\u540e\uff0c\u4e3a\u628a0~KERNSIZE\uff08\u660e\u786eucore\u8bbe\u5b9a\u5b9e\u9645\u7269\u7406\u5185\u5b58\u4e0d\u80fd\u8d85\u8fc7KERNSIZE\u503c\uff0c\u5373512MB\uff0c131072\u4e2a\u7269\u7406\u9875\uff09\u7684\u7269\u7406\u5730\u5740\u4e00\u4e00\u6620\u5c04\u5230\u9875\u76ee\u5f55\u9879\u548c\u9875\u8868\u9879\u7684\u5185\u5bb9\uff0c\u5176\u5927\u81f4\u6d41\u7a0b\u5982\u4e0b\uff1a \u6307\u5411\u9875\u76ee\u5f55\u8868\u7684\u6307\u9488\u5df2\u5b58\u50a8\u5728boot_pgdir\u53d8\u91cf\u4e2d\u3002 \u8c03\u7528boot_map_segment\u51fd\u6570\u8fdb\u4e00\u6b65\u5efa\u7acb\u4e00\u4e00\u6620\u5c04\u5173\u7cfb\uff0c\u5177\u4f53\u5904\u7406\u8fc7\u7a0b\u4ee5\u9875\u4e3a\u5355\u4f4d\u8fdb\u884c\u8bbe\u7f6e\uff0c\u5373 linear addr = phy addr + 0xa0000000 \u8bbe\u4e00\u4e2a32bit\u7ebf\u6027\u5730\u5740la\u6709\u4e00\u4e2a\u5bf9\u5e94\u768432bit\u7269\u7406\u5730\u5740pa\uff0c\u5982\u679c\u5728\u4ee5la\u7684\u9ad810\u4f4d\u4e3a\u7d22\u5f15\u503c\u7684\u9875\u76ee\u5f55\u9879\u4e2d\u7684\u5b58\u5728\u4f4d\uff08PTE_P\uff09\u4e3a0\uff0c\u8868\u793a\u7f3a\u5c11\u5bf9\u5e94\u7684\u9875\u8868\u7a7a\u95f4\uff0c\u5219\u53ef\u901a\u8fc7alloc_page\u83b7\u5f97\u4e00\u4e2a\u7a7a\u95f2\u7269\u7406\u9875\u7ed9\u9875\u8868\uff0c\u9875\u8868\u8d77\u59cb\u7269\u7406\u5730\u5740\u662f\u63094096\u5b57\u8282\u5bf9\u9f50\u7684\uff0c\u8fd9\u6837\u586b\u5199\u9875\u76ee\u5f55\u9879\u7684\u5185\u5bb9\u4e3a \u9875\u76ee\u5f55\u9879\u5185\u5bb9 = (\u9875\u8868\u8d77\u59cb\u7269\u7406\u5730\u5740 & ~0x0FFF) | PTE_U | PTE_W | PTE_P \u8fdb\u4e00\u6b65\u5bf9\u4e8e\u9875\u8868\u4e2d\u4ee5\u7ebf\u6027\u5730\u5740la\u7684\u4e2d10\u4f4d\u4e3a\u7d22\u5f15\u503c\u5bf9\u5e94\u9875\u8868\u9879\u7684\u5185\u5bb9\u4e3a \u9875\u8868\u9879\u5185\u5bb9 = (pa & ~0x0FFF) | PTE_P | PTE_W \u5176\u4e2d\uff1a PTE_U\uff1a\u4f4d3\uff0c\u8868\u793a\u7528\u6237\u6001\u7684\u8f6f\u4ef6\u53ef\u4ee5\u8bfb\u53d6\u5bf9\u5e94\u5730\u5740\u7684\u7269\u7406\u5185\u5b58\u9875\u5185\u5bb9 PTE_W\uff1a\u4f4d2\uff0c\u8868\u793a\u7269\u7406\u5185\u5b58\u9875\u5185\u5bb9\u53ef\u5199 PTE_P\uff1a\u4f4d1\uff0c\u8868\u793a\u7269\u7406\u5185\u5b58\u9875\u5b58\u5728 ucore\u7684\u5185\u5b58\u7ba1\u7406\u7ecf\u5e38\u9700\u8981\u67e5\u627e\u9875\u8868\uff1a\u7ed9\u5b9a\u4e00\u4e2a\u865a\u62df\u5730\u5740\uff0c\u627e\u51fa\u8fd9\u4e2a\u865a\u62df\u5730\u5740\u5728\u4e8c\u7ea7\u9875\u8868\u4e2d\u5bf9\u5e94\u7684\u9879\u3002\u901a\u8fc7\u66f4\u6539\u6b64\u9879\u7684\u503c\u53ef\u4ee5\u65b9\u4fbf\u5730\u5c06\u865a\u62df\u5730\u5740\u6620\u5c04\u5230\u53e6\u5916\u7684\u9875\u4e0a\u3002\u53ef\u5b8c\u6210\u6b64\u529f\u80fd\u7684\u8fd9\u4e2a\u51fd\u6570\u662fget_pte\u51fd\u6570\u3002\u5b83\u7684\u539f\u578b\u4e3a pte_t * get_pte ( pde_t * pgdir , uintptr_t la , bool create ) \u4e0b\u9762\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u53ef\u4ee5\u6bd4\u8f83\u597d\u5730\u770b\u51faget_pte\u5728\u5b9e\u73b0\u4e0a\u8ff0\u6d41\u7a0b\u4e2d\u7684\u4f4d\u7f6e\uff1a \u56fe6 get_pte\u8c03\u7528\u5173\u7cfb\u56fe \u8fd9\u91cc\u6d89\u53ca\u5230\u4e09\u4e2a\u7c7b\u578bpte_t\u3001pde_t\u548cuintptr_t\u3002\u901a\u8fc7\u53c2\u89c1mm/mmlayout.h\u548clibs/types.h\uff0c\u53ef\u77e5\u5b83\u4eec\u5176\u5b9e\u90fd\u662funsigned int\u7c7b\u578b\u3002\u5728\u6b64\u505a\u533a\u5206\uff0c\u662f\u4e3a\u4e86\u5206\u6e05\u6982\u5ff5\u3002 pde_t\u5168\u79f0\u4e3a page directory entry\uff0c\u4e5f\u5c31\u662f\u4e00\u7ea7\u9875\u8868\u7684\u8868\u9879\uff08\u6ce8\u610f\uff1apgdir\u5b9e\u9645\u4e0d\u662f\u8868\u9879\uff0c\u800c\u662f\u4e00\u7ea7\u9875\u8868\u672c\u8eab\u3002\u5b9e\u9645\u4e0a\u5e94\u8be5\u65b0\u5b9a\u4e49\u4e00\u4e2a\u7c7b\u578bpgd_t\u6765\u8868\u793a\u4e00\u7ea7\u9875\u8868\u672c\u8eab\uff09\u3002pte_t\u5168\u79f0\u4e3a page table entry\uff0c\u8868\u793a\u4e8c\u7ea7\u9875\u8868\u7684\u8868\u9879\u3002uintptr_t\u8868\u793a\u4e3a\u7ebf\u6027\u5730\u5740\uff0c\u7531\u4e8e\u6bb5\u5f0f\u7ba1\u7406\u53ea\u505a\u76f4\u63a5\u6620\u5c04\uff0c\u6240\u4ee5\u5b83\u4e5f\u662f\u903b\u8f91\u5730\u5740\u3002 pgdir\u7ed9\u51fa\u9875\u8868\u8d77\u59cb\u5730\u5740\u3002\u901a\u8fc7\u67e5\u627e\u8fd9\u4e2a\u9875\u8868\uff0c\u6211\u4eec\u9700\u8981\u7ed9\u51fa\u4e8c\u7ea7\u9875\u8868\u4e2d\u5bf9\u5e94\u9879\u7684\u5730\u5740\u3002\u867d\u7136\u76ee\u524d\u6211\u4eec\u53ea\u6709boot_pgdir\u4e00\u4e2a\u9875\u8868\uff0c\u4f46\u662f\u5f15\u5165\u8fdb\u7a0b\u7684\u6982\u5ff5\u4e4b\u540e\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u4f1a\u6709\u81ea\u5df1\u7684\u9875\u8868\u3002 \u6709\u53ef\u80fd\u6839\u672c\u5c31\u6ca1\u6709\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u4e8c\u7ea7\u9875\u8868\u4e0d\u5fc5\u8981\u4e00\u5f00\u59cb\u5c31\u5206\u914d\uff0c\u800c\u662f\u7b49\u5230\u9700\u8981\u7684\u65f6\u5019\u518d\u6dfb\u52a0\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u3002\u5982\u679c\u5728\u67e5\u627e\u4e8c\u7ea7\u9875\u8868\u9879\u65f6\uff0c\u53d1\u73b0\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u4e0d\u5b58\u5728\uff0c\u5219\u9700\u8981\u6839\u636ecreate\u53c2\u6570\u7684\u503c\u6765\u5904\u7406\u662f\u5426\u521b\u5efa\u65b0\u7684\u4e8c\u7ea7\u9875\u8868\u3002\u5982\u679ccreate\u53c2\u6570\u4e3a0\uff0c\u5219get_pte\u8fd4\u56deNULL\uff1b\u5982\u679ccreate\u53c2\u6570\u4e0d\u4e3a0\uff0c\u5219get_pte\u9700\u8981\u7533\u8bf7\u4e00\u4e2a\u65b0\u7684\u7269\u7406\u9875\uff08\u901a\u8fc7alloc_page\u6765\u5b9e\u73b0\uff0c\u53ef\u5728mm/pmm.h\u4e2d\u627e\u5230\u5b83\u7684\u5b9a\u4e49\uff09\uff0c\u518d\u5728\u4e00\u7ea7\u9875\u8868\u4e2d\u6dfb\u52a0\u9875\u76ee\u5f55\u9879\u6307\u5411\u8868\u793a\u4e8c\u7ea7\u9875\u8868\u7684\u65b0\u7269\u7406\u9875\u3002\u6ce8\u610f\uff0c\u65b0\u7533\u8bf7\u7684\u9875\u5fc5\u987b\u5168\u90e8\u8bbe\u5b9a\u4e3a\u96f6\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u9875\u6240\u4ee3\u8868\u7684\u865a\u62df\u5730\u5740\u90fd\u6ca1\u6709\u88ab\u6620\u5c04\u3002 \u5f53\u5efa\u7acb\u4ece\u4e00\u7ea7\u9875\u8868\u5230\u4e8c\u7ea7\u9875\u8868\u7684\u6620\u5c04\u65f6\uff0c\u9700\u8981\u6ce8\u610f\u8bbe\u7f6e\u63a7\u5236\u4f4d\u3002\u8fd9\u91cc\u5e94\u8be5\u8bbe\u7f6e\u540c\u65f6\u8bbe\u7f6e\u4e0aPTE_U\u3001PTE_W\u548cPTE_P\uff08\u5b9a\u4e49\u5728mm/mmu.h\uff09\u3002\u5982\u679c\u539f\u6765\u5c31\u6709\u4e8c\u7ea7\u9875\u8868\uff0c\u6216\u8005\u65b0\u5efa\u7acb\u4e86\u9875\u8868\uff0c\u5219\u53ea\u9700\u8fd4\u56de\u5bf9\u5e94\u9879\u7684\u5730\u5740\u5373\u53ef\u3002 \u865a\u62df\u5730\u5740\u53ea\u6709\u6620\u5c04\u4e0a\u4e86\u7269\u7406\u9875\u624d\u53ef\u4ee5\u6b63\u5e38\u7684\u8bfb\u5199\u3002\u5728\u5b8c\u6210\u6620\u5c04\u7269\u7406\u9875\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9664\u4e86\u8981\u50cf\u4e0a\u9762\u90a3\u6837\u5728\u9875\u8868\u7684\u5bf9\u5e94\u8868\u9879\u4e0a\u586b\u4e0a\u76f8\u5e94\u7684\u7269\u7406\u5730\u5740\u5916\uff0c\u8fd8\u8981\u8bbe\u7f6e\u6b63\u786e\u7684\u63a7\u5236\u4f4d\u3002 \u53ea\u6709\u5f53\u4e00\u7ea7\u4e8c\u7ea7\u9875\u8868\u7684\u9879\u90fd\u8bbe\u7f6e\u4e86\u7528\u6237\u5199\u6743\u9650\u540e\uff0c\u7528\u6237\u624d\u80fd\u5bf9\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\u8fdb\u884c\u8bfb\u5199\u3002\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u7ea7\u9875\u8868\u5148\u7ed9\u7528\u6237\u5199\u6743\u9650\uff0c\u518d\u5728\u4e8c\u7ea7\u9875\u8868\u4e0a\u9762\u6839\u636e\u9700\u8981\u9650\u5236\u7528\u6237\u7684\u6743\u9650\uff0c\u5bf9\u7269\u7406\u9875\u8fdb\u884c\u4fdd\u62a4\u3002\u7531\u4e8e\u4e00\u4e2a\u7269\u7406\u9875\u53ef\u80fd\u88ab\u6620\u5c04\u5230\u4e0d\u540c\u7684\u865a\u62df\u5730\u5740\u4e0a\u53bb\uff08\u8b6c\u5982\u4e00\u5757\u5185\u5b58\u5728\u4e0d\u540c\u8fdb\u7a0b\u95f4\u5171\u4eab\uff09\uff0c\u5f53\u8fd9\u4e2a\u9875\u9700\u8981\u5728\u4e00\u4e2a\u5730\u5740\u4e0a\u89e3\u9664\u6620\u5c04\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u80fd\u76f4\u63a5\u628a\u8fd9\u4e2a\u9875\u56de\u6536\uff0c\u800c\u662f\u8981\u5148\u770b\u770b\u5b83\u8fd8\u6709\u6ca1\u6709\u6620\u5c04\u5230\u522b\u7684\u865a\u62df\u5730\u5740\u4e0a\u3002\u8fd9\u662f\u901a\u8fc7\u67e5\u627e\u7ba1\u7406\u8be5\u7269\u7406\u9875\u7684Page\u6570\u636e\u7ed3\u6784\u7684\u6210\u5458\u53d8\u91cfref\uff08\u7528\u6765\u8868\u793a\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\u5173\u7cfb\u7684\u4e2a\u6570\uff09\u6765\u5b9e\u73b0\u7684\uff0c\u5982\u679cref\u4e3a0\u4e86\uff0c\u8868\u793a\u6ca1\u6709\u865a\u62df\u9875\u5230\u7269\u7406\u9875\u7684\u6620\u5c04\u5173\u7cfb\u4e86\uff0c\u5c31\u53ef\u4ee5\u628a\u8fd9\u4e2a\u7269\u7406\u9875\u7ed9\u56de\u6536\u4e86\uff0c\u4ece\u800c\u8fd9\u4e2a\u7269\u7406\u9875\u662ffree\u7684\u4e86\uff0c\u53ef\u4ee5\u518d\u88ab\u5206\u914d\u3002page_insert\u51fd\u6570\u5c06\u7269\u7406\u9875\u6620\u5c04\u5728\u4e86\u9875\u8868\u4e0a\u3002\u53ef\u53c2\u770bpage_insert\u51fd\u6570\u7684\u5b9e\u73b0\u6765\u4e86\u89e3ucore\u5185\u6838\u662f\u5982\u4f55\u7ef4\u62a4\u8fd9\u4e2a\u53d8\u91cf\u7684\u3002\u5f53\u4e0d\u9700\u8981\u518d\u8bbf\u95ee\u8fd9\u5757\u865a\u62df\u5730\u5740\u65f6\uff0c\u53ef\u4ee5\u628a\u8fd9\u5757\u7269\u7406\u9875\u56de\u6536\u5e76\u5728\u5c06\u6765\u7528\u5728\u5176\u4ed6\u5730\u65b9\u3002\u53d6\u6d88\u6620\u5c04\u7531page_remove\u6765\u505a\uff0c\u8fd9\u5176\u5b9e\u662fpage_insert\u7684\u9006\u64cd\u4f5c\u3002 \u5efa\u7acb\u597d\u4e00\u4e00\u6620\u5c04\u7684\u4e8c\u7ea7\u9875\u8868\u7ed3\u6784\u540e\uff0c\u7531\u4e8e\u5206\u9875\u673a\u5236\u5728\u524d\u4e00\u8282\u6240\u8ff0\u7684\u524d\u4e24\u4e2a\u9636\u6bb5\u5df2\u7ecf\u5f00\u542f\uff0c\u5206\u9875\u673a\u5236\u5230\u6b64\u521d\u59cb\u5316\u5b8c\u6bd5\u3002\u5f53\u6267\u884c\u5b8c\u6bd5gdt_init\u51fd\u6570\u540e\uff0c\u65b0\u7684\u6bb5\u9875\u5f0f\u6620\u5c04\u5df2\u7ecf\u5efa\u7acb\u597d\u4e86\u3002 \u5728pmm_init\u51fd\u6570\u5efa\u7acb\u5b8c\u5b9e\u73b0\u7269\u7406\u5185\u5b58\u4e00\u4e00\u6620\u5c04\u548c\u9875\u76ee\u5f55\u8868\u81ea\u6620\u5c04\u7684\u9875\u76ee\u5f55\u8868\u548c\u9875\u8868\u540e\uff0cucore\u770b\u5230\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5982\u4e0b\u56fe\u6240\u793a\uff1a Virtual memory map: Permissions kernel/user 4G ------------------> +---------------------------------+ | | | Mapped(2G) | | | KERNTOP ------------> +---------------------------------+ 0xBFFF_FFFF | | | Unmapped cached(DMW0 512M) | | | KERNBASE-------------> +---------------------------------+ 0xa0000000 | | | Unmapped uncached(DMW1 512M) | RW/-- KMEMSIZE | | +---------------------------------+ 0x80000000 | | | User Mapped | | | ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 0x00000000","title":"\u5efa\u7acb\u865a\u62df\u9875\u548c\u7269\u7406\u9875\u5e27\u7684\u5730\u5740\u6620\u5c04\u5173\u7cfb"},{"location":"lab2/intro/","text":"\u5185\u5b58\u7ba1\u7406\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0 \u00b6 \u672c\u6b21\u5b9e\u9a8c\u4e3b\u8981\u5b8c\u6210ucore\u5185\u6838\u5bf9\u7269\u7406\u5185\u5b58\u7684\u7ba1\u7406\u5de5\u4f5c\u3002 kern_init\u51fd\u6570\u5728\u5b8c\u6210\u4e00\u4e9b\u8f93\u51fa\u5e76\u5bf9lab1\u5b9e\u9a8c\u7ed3\u679c\u7684\u68c0\u67e5\u540e\uff0c\u5c06\u8fdb\u5165\u7269\u7406\u5185\u5b58\u7ba1\u7406\u521d\u59cb\u5316\u7684\u5de5\u4f5c\uff0c\u5373\u8c03\u7528pmm_init\u51fd\u6570\u5b8c\u6210\u7269\u7406\u5185\u5b58\u7684\u7ba1\u7406\uff0c\u8fd9\u4e5f\u662f\u6211\u4eeclab2\u7684\u5185\u5bb9\u3002\u63a5\u7740\u6267\u884cintr_enable\u51fd\u6570\u5f00\u542f\u4e2d\u65ad\uff0c\u8fd9\u4e9b\u5de5\u4f5c\u4e0elab1\u7684\u4e2d\u65ad\u5f02\u5e38\u5de5\u4f5c\u7684\u5185\u5bb9\u662f\u76f8\u540c\u7684\u3002 \u4e3a\u4e86\u5b8c\u6210\u7269\u7406\u5185\u5b58\u7ba1\u7406\uff0c\u8fd9\u91cc\u9996\u5148\u9700\u8981\u63a2\u6d4b\u53ef\u7528\u7684\u7269\u7406\u5185\u5b58\u8d44\u6e90\uff1b\u4e86\u89e3\u5230\u7269\u7406\u5185\u5b58\u4f4d\u4e8e\u4ec0\u4e48\u5730\u65b9\uff0c\u6709\u591a\u5927\u3002 \u8fd9\u91cc\u7ec6\u5fc3\u7684\u8bfb\u8005\u4e00\u5b9a\u4f1a\u6709\u7591\u95ee\uff0c\u5728\u7ffb\u9605uCore(LoongArch32\u7248\u672c)\u4ee3\u7801\u540e\u53d1\u73b0\u5185\u5b58\u5927\u5c0f\u4f3c\u4e4e\u662f\u5199\u6b7b\u768432M\uff0c\u5e76\u6ca1\u6709\u50cfx86\u7b49\u67b6\u6784\u4e00\u6837\u901a\u8fc7e820\u53bb\u5f97\u5230\u4e00\u4e2a\u53ef\u7528\u5185\u5b58\u7684\u5927\u5c0f\uff0c\u4ece\u800c\u64cd\u4f5c\u7cfb\u7edf\u4f3c\u4e4e\u6ca1\u6709\u5b8c\u6210\u7269\u7406\u5185\u5b58\u63a2\u6d4b\u7684\u64cd\u4f5c\u3002\u786e\u5b9e\u662f\u8fd9\u6837\uff0c\u5728\u8bb8\u591aRISC\u67b6\u6784\u4e0b\uff0c\u901a\u5e38\u542f\u52a8\u7cfb\u7edf\u5185\u6838\u4f1a\u8bfb\u53d6\u4e00\u4e2a\u53eb\u505a\u8bbe\u5907\u6811(Device Tree)\u7684\u6587\u4ef6\uff0c\u6765\u63cf\u8ff0\u786c\u4ef6\u4e0a\u5404\u4e2a\u8bbe\u5907\u7684\u5730\u5740\u548c\u7279\u6027\uff0c\u8bbe\u5907\u6811\u4e2d\u4e5f\u5305\u62ec\u4e86\u5185\u5b58\u5927\u5c0f\uff0c\u800c\u5e76\u4e0d\u662f\u4ea4\u7ed9\u7cfb\u7edf\u5185\u6838\u81ea\u5df1\u53bb\u63a2\u6d4b\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u89c1\u5230\u8bb8\u591aARM\u548cRISC-V\u67b6\u6784\u7684Linux\u5f00\u53d1\u677f\uff0c\u4e0d\u540c\u5185\u5b58\u5bb9\u91cf\u7684\u7248\u672c\u8981\u4f7f\u7528\u4e0d\u540c\u7684\u955c\u50cf\uff0c\u4e5f\u662f\u56e0\u4e3a\u8bbe\u5907\u6811\u4e0d\u540c\u5bfc\u81f4\u7684\u3002\u800c\u4e3a\u4e86\u7b80\u5316\u7cfb\u7edf\u7684\u8bbe\u8ba1\uff0c\u6211\u4eec\u5e76\u6ca1\u6709\u5b9e\u73b0\u8bbe\u5907\u6811\u7684\u8bfb\u53d6\uff0c\u56e0\u6b64\u91c7\u7528\u4e86\u5199\u6b7b\u768432M\u3002 \u5728\u786e\u5b9a\u4e86\u7269\u7406\u5185\u5b58\u5927\u5c0f\u540e\uff0c\u5c31\u4ee5\u56fa\u5b9a\u9875\u9762\u5927\u5c0f\u6765\u5212\u5206\u6574\u4e2a\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u51c6\u5907\u4ee5\u6b64\u4e3a\u6700\u5c0f\u5185\u5b58\u5206\u914d\u5355\u4f4d\u6765\u7ba1\u7406\u6574\u4e2a\u7269\u7406\u5185\u5b58\uff0c\u7ba1\u7406\u5728\u5185\u6838\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u6bcf\u9875\u5185\u5b58\uff0c\u8bbe\u5b9a\u5176\u53ef\u7528\u72b6\u6001\uff08free\u7684\uff0cused\u7684\uff0c\u8fd8\u662freserved\u7684\uff09\uff0c\u8fd9\u5176\u5b9e\u5c31\u5bf9\u5e94\u4e86\u6211\u4eec\u5728\u8bfe\u672c\u4e0a\u8bb2\u5230\u7684\u8fde\u7eed\u5185\u5b58\u5206\u914d\u6982\u5ff5\u548c\u539f\u7406\u7684\u5177\u4f53\u5b9e\u73b0\uff1b\u63a5\u7740ucore kernel\u5c31\u8981\u5efa\u7acb\u9875\u8868\uff0c\u542f\u52a8\u5206\u9875\u673a\u5236\uff0c\u5f53\u7f3a\u9875\u5f02\u5e38\u53d1\u751f\u65f6\uff0c\u5c31\u4f1a\u8df3\u8f6c\u5230\u5185\u6838\u7684\u5f02\u5e38\u5904\u7406\u5730\u5740\u4e0a\uff0c\u7531\u5185\u6838\u5b8c\u6210TLB\u586b\u5145\uff0c\u6839\u636e\u9875\u8868\u9879\u63cf\u8ff0\u7684\u865a\u62df\u9875\uff08Page\uff09\u4e0e\u7269\u7406\u9875\u5e27\uff08Page Frame\uff09\u7684\u5bf9\u5e94\u5173\u7cfb\u5b8c\u6210CPU\u5bf9\u5185\u5b58\u7684\u8bfb\u3001\u5199\u548c\u6267\u884c\u64cd\u4f5c\u3002\u8fd9\u4e00\u90e8\u5206\u5176\u5b9e\u5c31\u5bf9\u5e94\u4e86\u6211\u4eec\u5728\u8bfe\u672c\u4e0a\u8bb2\u5230\u5185\u5b58\u6620\u5c04\u3001\u9875\u8868\u3001\u591a\u7ea7\u9875\u8868\u7b49\u6982\u5ff5\u548c\u539f\u7406\u7684\u5177\u4f53\u5b9e\u73b0\u3002 \u5728\u4ee3\u7801\u5206\u6790\u4e0a\uff0c\u5efa\u8bae\u6839\u636e\u6267\u884c\u6d41\u7a0b\u6765\u76f4\u63a5\u770b\u6e90\u4ee3\u7801\uff0c\u5e76\u53ef\u91c7\u7528GDB\u6e90\u7801\u8c03\u8bd5\u7684\u624b\u6bb5\u6765\u52a8\u6001\u5730\u5206\u6790ucore\u7684\u6267\u884c\u8fc7\u7a0b\u3002\u5185\u5b58\u7ba1\u7406\u76f8\u5173\u7684\u603b\u4f53\u63a7\u5236\u51fd\u6570\u662fpmm_init\u51fd\u6570\uff0c\u5b83\u5b8c\u6210\u7684\u4e3b\u8981\u5de5\u4f5c\u5305\u62ec\uff1a 1. \u521d\u59cb\u5316\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668\u6846\u67b6pmm_manager\uff1b 2. \u5efa\u7acb\u7a7a\u95f2\u7684page\u94fe\u8868\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5206\u914d\u4ee5\u9875\uff084KB\uff09\u4e3a\u5355\u4f4d\u7684\u7a7a\u95f2\u5185\u5b58\u4e86\uff1b 3. \u68c0\u67e5\u7269\u7406\u5185\u5b58\u9875\u5206\u914d\u7b97\u6cd5\uff1b 4. \u5efa\u7acb\u4e00\u4e00\u6620\u5c04\u5173\u7cfb\u7684\u4e8c\u7ea7\u9875\u8868\uff1b 5. \u4f7f\u80fd\u5206\u9875\u673a\u5236\uff1b 6. \u68c0\u67e5\u9875\u8868\u5efa\u7acb\u662f\u5426\u6b63\u786e\uff1b \u53e6\u5916\uff0c\u4e3b\u8981\u6ce8\u610f\u7684\u76f8\u5173\u4ee3\u7801\u5185\u5bb9\u5305\u62ec\uff1a * \u7ba1\u7406\u6bcf\u4e2a\u7269\u7406\u9875\u7684Page\u6570\u636e\u7ed3\u6784\uff08\u5728mm/memlayout.h\u4e2d\uff09\uff0c\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u4e5f\u662f\u5b9e\u73b0\u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u5173\u952e\u6570\u636e\u7ed3\u6784\uff0c\u53ef\u901a\u8fc7\u6b64\u6570\u636e\u7ed3\u6784\u6765\u5b8c\u6210\u7a7a\u95f2\u5757\u7684\u94fe\u63a5\u548c\u4fe1\u606f\u5b58\u50a8\uff0c\u800c\u57fa\u4e8e\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u7684\u7ba1\u7406\u7269\u7406\u9875\u6570\u7ec4\u8d77\u59cb\u5730\u5740\u5c31\u662f\u5168\u5c40\u53d8\u91cfpages\uff0c\u5177\u4f53\u521d\u59cb\u5316\u6b64\u6570\u7ec4\u7684\u51fd\u6570\u4f4d\u4e8epage_init\u51fd\u6570\u4e2d\uff1b * \u7528\u4e8e\u5b9e\u73b0\u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668\u6846\u67b6pmm_manager\uff0c\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u4e86\u5b9e\u73b0\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u5173\u952e\u51fd\u6570\u6307\u9488\uff0c\u800c\u540c\u5b66\u4eec\u9700\u8981\u5b8c\u6210\u8fd9\u4e9b\u51fd\u6570\u7684\u5177\u4f53\u5b9e\u73b0\uff1b * \u8bbe\u5b9a\u4e8c\u7ea7\u9875\u8868\u548c\u5efa\u7acb\u9875\u8868\u9879\u4ee5\u5b8c\u6210\u865a\u5b9e\u5730\u5740\u6620\u5c04\u5173\u7cfb\uff0c\u8fd9\u4e0e\u786c\u4ef6\u76f8\u5173\uff0c\u4e14\u7528\u5230\u4e0d\u5c11\u5185\u8054\u51fd\u6570\uff0c\u6e90\u4ee3\u7801\u76f8\u5bf9\u96be\u61c2\u4e00\u4e9b\u3002\u5177\u4f53\u5b8c\u6210\u9875\u8868\u548c\u9875\u8868\u9879\u5efa\u7acb\u7684\u91cd\u8981\u51fd\u6570\u662fboot_map_segment\u51fd\u6570\uff0c\u800cget_pte\u51fd\u6570\u662f\u5b8c\u6210\u865a\u5b9e\u6620\u5c04\u5173\u952e\u7684\u5173\u952e\u3002","title":"\u80cc\u666f\u4ecb\u7ecd"},{"location":"lab2/intro/#_1","text":"\u672c\u6b21\u5b9e\u9a8c\u4e3b\u8981\u5b8c\u6210ucore\u5185\u6838\u5bf9\u7269\u7406\u5185\u5b58\u7684\u7ba1\u7406\u5de5\u4f5c\u3002 kern_init\u51fd\u6570\u5728\u5b8c\u6210\u4e00\u4e9b\u8f93\u51fa\u5e76\u5bf9lab1\u5b9e\u9a8c\u7ed3\u679c\u7684\u68c0\u67e5\u540e\uff0c\u5c06\u8fdb\u5165\u7269\u7406\u5185\u5b58\u7ba1\u7406\u521d\u59cb\u5316\u7684\u5de5\u4f5c\uff0c\u5373\u8c03\u7528pmm_init\u51fd\u6570\u5b8c\u6210\u7269\u7406\u5185\u5b58\u7684\u7ba1\u7406\uff0c\u8fd9\u4e5f\u662f\u6211\u4eeclab2\u7684\u5185\u5bb9\u3002\u63a5\u7740\u6267\u884cintr_enable\u51fd\u6570\u5f00\u542f\u4e2d\u65ad\uff0c\u8fd9\u4e9b\u5de5\u4f5c\u4e0elab1\u7684\u4e2d\u65ad\u5f02\u5e38\u5de5\u4f5c\u7684\u5185\u5bb9\u662f\u76f8\u540c\u7684\u3002 \u4e3a\u4e86\u5b8c\u6210\u7269\u7406\u5185\u5b58\u7ba1\u7406\uff0c\u8fd9\u91cc\u9996\u5148\u9700\u8981\u63a2\u6d4b\u53ef\u7528\u7684\u7269\u7406\u5185\u5b58\u8d44\u6e90\uff1b\u4e86\u89e3\u5230\u7269\u7406\u5185\u5b58\u4f4d\u4e8e\u4ec0\u4e48\u5730\u65b9\uff0c\u6709\u591a\u5927\u3002 \u8fd9\u91cc\u7ec6\u5fc3\u7684\u8bfb\u8005\u4e00\u5b9a\u4f1a\u6709\u7591\u95ee\uff0c\u5728\u7ffb\u9605uCore(LoongArch32\u7248\u672c)\u4ee3\u7801\u540e\u53d1\u73b0\u5185\u5b58\u5927\u5c0f\u4f3c\u4e4e\u662f\u5199\u6b7b\u768432M\uff0c\u5e76\u6ca1\u6709\u50cfx86\u7b49\u67b6\u6784\u4e00\u6837\u901a\u8fc7e820\u53bb\u5f97\u5230\u4e00\u4e2a\u53ef\u7528\u5185\u5b58\u7684\u5927\u5c0f\uff0c\u4ece\u800c\u64cd\u4f5c\u7cfb\u7edf\u4f3c\u4e4e\u6ca1\u6709\u5b8c\u6210\u7269\u7406\u5185\u5b58\u63a2\u6d4b\u7684\u64cd\u4f5c\u3002\u786e\u5b9e\u662f\u8fd9\u6837\uff0c\u5728\u8bb8\u591aRISC\u67b6\u6784\u4e0b\uff0c\u901a\u5e38\u542f\u52a8\u7cfb\u7edf\u5185\u6838\u4f1a\u8bfb\u53d6\u4e00\u4e2a\u53eb\u505a\u8bbe\u5907\u6811(Device Tree)\u7684\u6587\u4ef6\uff0c\u6765\u63cf\u8ff0\u786c\u4ef6\u4e0a\u5404\u4e2a\u8bbe\u5907\u7684\u5730\u5740\u548c\u7279\u6027\uff0c\u8bbe\u5907\u6811\u4e2d\u4e5f\u5305\u62ec\u4e86\u5185\u5b58\u5927\u5c0f\uff0c\u800c\u5e76\u4e0d\u662f\u4ea4\u7ed9\u7cfb\u7edf\u5185\u6838\u81ea\u5df1\u53bb\u63a2\u6d4b\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u89c1\u5230\u8bb8\u591aARM\u548cRISC-V\u67b6\u6784\u7684Linux\u5f00\u53d1\u677f\uff0c\u4e0d\u540c\u5185\u5b58\u5bb9\u91cf\u7684\u7248\u672c\u8981\u4f7f\u7528\u4e0d\u540c\u7684\u955c\u50cf\uff0c\u4e5f\u662f\u56e0\u4e3a\u8bbe\u5907\u6811\u4e0d\u540c\u5bfc\u81f4\u7684\u3002\u800c\u4e3a\u4e86\u7b80\u5316\u7cfb\u7edf\u7684\u8bbe\u8ba1\uff0c\u6211\u4eec\u5e76\u6ca1\u6709\u5b9e\u73b0\u8bbe\u5907\u6811\u7684\u8bfb\u53d6\uff0c\u56e0\u6b64\u91c7\u7528\u4e86\u5199\u6b7b\u768432M\u3002 \u5728\u786e\u5b9a\u4e86\u7269\u7406\u5185\u5b58\u5927\u5c0f\u540e\uff0c\u5c31\u4ee5\u56fa\u5b9a\u9875\u9762\u5927\u5c0f\u6765\u5212\u5206\u6574\u4e2a\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u51c6\u5907\u4ee5\u6b64\u4e3a\u6700\u5c0f\u5185\u5b58\u5206\u914d\u5355\u4f4d\u6765\u7ba1\u7406\u6574\u4e2a\u7269\u7406\u5185\u5b58\uff0c\u7ba1\u7406\u5728\u5185\u6838\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u6bcf\u9875\u5185\u5b58\uff0c\u8bbe\u5b9a\u5176\u53ef\u7528\u72b6\u6001\uff08free\u7684\uff0cused\u7684\uff0c\u8fd8\u662freserved\u7684\uff09\uff0c\u8fd9\u5176\u5b9e\u5c31\u5bf9\u5e94\u4e86\u6211\u4eec\u5728\u8bfe\u672c\u4e0a\u8bb2\u5230\u7684\u8fde\u7eed\u5185\u5b58\u5206\u914d\u6982\u5ff5\u548c\u539f\u7406\u7684\u5177\u4f53\u5b9e\u73b0\uff1b\u63a5\u7740ucore kernel\u5c31\u8981\u5efa\u7acb\u9875\u8868\uff0c\u542f\u52a8\u5206\u9875\u673a\u5236\uff0c\u5f53\u7f3a\u9875\u5f02\u5e38\u53d1\u751f\u65f6\uff0c\u5c31\u4f1a\u8df3\u8f6c\u5230\u5185\u6838\u7684\u5f02\u5e38\u5904\u7406\u5730\u5740\u4e0a\uff0c\u7531\u5185\u6838\u5b8c\u6210TLB\u586b\u5145\uff0c\u6839\u636e\u9875\u8868\u9879\u63cf\u8ff0\u7684\u865a\u62df\u9875\uff08Page\uff09\u4e0e\u7269\u7406\u9875\u5e27\uff08Page Frame\uff09\u7684\u5bf9\u5e94\u5173\u7cfb\u5b8c\u6210CPU\u5bf9\u5185\u5b58\u7684\u8bfb\u3001\u5199\u548c\u6267\u884c\u64cd\u4f5c\u3002\u8fd9\u4e00\u90e8\u5206\u5176\u5b9e\u5c31\u5bf9\u5e94\u4e86\u6211\u4eec\u5728\u8bfe\u672c\u4e0a\u8bb2\u5230\u5185\u5b58\u6620\u5c04\u3001\u9875\u8868\u3001\u591a\u7ea7\u9875\u8868\u7b49\u6982\u5ff5\u548c\u539f\u7406\u7684\u5177\u4f53\u5b9e\u73b0\u3002 \u5728\u4ee3\u7801\u5206\u6790\u4e0a\uff0c\u5efa\u8bae\u6839\u636e\u6267\u884c\u6d41\u7a0b\u6765\u76f4\u63a5\u770b\u6e90\u4ee3\u7801\uff0c\u5e76\u53ef\u91c7\u7528GDB\u6e90\u7801\u8c03\u8bd5\u7684\u624b\u6bb5\u6765\u52a8\u6001\u5730\u5206\u6790ucore\u7684\u6267\u884c\u8fc7\u7a0b\u3002\u5185\u5b58\u7ba1\u7406\u76f8\u5173\u7684\u603b\u4f53\u63a7\u5236\u51fd\u6570\u662fpmm_init\u51fd\u6570\uff0c\u5b83\u5b8c\u6210\u7684\u4e3b\u8981\u5de5\u4f5c\u5305\u62ec\uff1a 1. \u521d\u59cb\u5316\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668\u6846\u67b6pmm_manager\uff1b 2. \u5efa\u7acb\u7a7a\u95f2\u7684page\u94fe\u8868\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5206\u914d\u4ee5\u9875\uff084KB\uff09\u4e3a\u5355\u4f4d\u7684\u7a7a\u95f2\u5185\u5b58\u4e86\uff1b 3. \u68c0\u67e5\u7269\u7406\u5185\u5b58\u9875\u5206\u914d\u7b97\u6cd5\uff1b 4. \u5efa\u7acb\u4e00\u4e00\u6620\u5c04\u5173\u7cfb\u7684\u4e8c\u7ea7\u9875\u8868\uff1b 5. \u4f7f\u80fd\u5206\u9875\u673a\u5236\uff1b 6. \u68c0\u67e5\u9875\u8868\u5efa\u7acb\u662f\u5426\u6b63\u786e\uff1b \u53e6\u5916\uff0c\u4e3b\u8981\u6ce8\u610f\u7684\u76f8\u5173\u4ee3\u7801\u5185\u5bb9\u5305\u62ec\uff1a * \u7ba1\u7406\u6bcf\u4e2a\u7269\u7406\u9875\u7684Page\u6570\u636e\u7ed3\u6784\uff08\u5728mm/memlayout.h\u4e2d\uff09\uff0c\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u4e5f\u662f\u5b9e\u73b0\u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u5173\u952e\u6570\u636e\u7ed3\u6784\uff0c\u53ef\u901a\u8fc7\u6b64\u6570\u636e\u7ed3\u6784\u6765\u5b8c\u6210\u7a7a\u95f2\u5757\u7684\u94fe\u63a5\u548c\u4fe1\u606f\u5b58\u50a8\uff0c\u800c\u57fa\u4e8e\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u7684\u7ba1\u7406\u7269\u7406\u9875\u6570\u7ec4\u8d77\u59cb\u5730\u5740\u5c31\u662f\u5168\u5c40\u53d8\u91cfpages\uff0c\u5177\u4f53\u521d\u59cb\u5316\u6b64\u6570\u7ec4\u7684\u51fd\u6570\u4f4d\u4e8epage_init\u51fd\u6570\u4e2d\uff1b * \u7528\u4e8e\u5b9e\u73b0\u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u7269\u7406\u5185\u5b58\u9875\u7ba1\u7406\u5668\u6846\u67b6pmm_manager\uff0c\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u4e86\u5b9e\u73b0\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u5173\u952e\u51fd\u6570\u6307\u9488\uff0c\u800c\u540c\u5b66\u4eec\u9700\u8981\u5b8c\u6210\u8fd9\u4e9b\u51fd\u6570\u7684\u5177\u4f53\u5b9e\u73b0\uff1b * \u8bbe\u5b9a\u4e8c\u7ea7\u9875\u8868\u548c\u5efa\u7acb\u9875\u8868\u9879\u4ee5\u5b8c\u6210\u865a\u5b9e\u5730\u5740\u6620\u5c04\u5173\u7cfb\uff0c\u8fd9\u4e0e\u786c\u4ef6\u76f8\u5173\uff0c\u4e14\u7528\u5230\u4e0d\u5c11\u5185\u8054\u51fd\u6570\uff0c\u6e90\u4ee3\u7801\u76f8\u5bf9\u96be\u61c2\u4e00\u4e9b\u3002\u5177\u4f53\u5b8c\u6210\u9875\u8868\u548c\u9875\u8868\u9879\u5efa\u7acb\u7684\u91cd\u8981\u51fd\u6570\u662fboot_map_segment\u51fd\u6570\uff0c\u800cget_pte\u51fd\u6570\u662f\u5b8c\u6210\u865a\u5b9e\u6620\u5c04\u5173\u952e\u7684\u5173\u952e\u3002","title":"\u5185\u5b58\u7ba1\u7406\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0"},{"location":"lab2/step/","text":"\u5b9e\u9a8c\u6b65\u9aa4\u5982\u4e0b \u00b6 \u5185\u5b58\u7ba1\u7406 \u00b6 Makefile\u4fee\u6539 LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 # LAB3 := -DLAB3_EX1 -DLAB3_EX2 # LAB4 := -DLAB4_EX1 -DLAB4_EX2 \u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a make make qemu -j 16 \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 chenyu$ make qemu -j 16 ( THU.CST ) os is loading ... Special kernel symbols: entry 0xA00000A0 ( phys ) etext 0xA0020000 ( phys ) edata 0xA0153370 ( phys ) end 0xA0156650 ( phys ) Kernel executable memory footprint: 1242KB memory management: default_pmm_manager memory map: [ A0000000, A2000000 ] freemem start at: A0197000 free pages: 00001E69 ## 00000020 check_alloc_page () succeeded! check_pgdir () succeeded! check_boot_pgdir () succeeded! check_slab () succeeded! kmalloc_init () succeeded! LAB2 Check Pass! \u901a\u8fc7\u4e0a\u56fe\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230ucore\u5728\u663e\u793a\u5176entry\uff08\u5165\u53e3\u5730\u5740\uff09\u3001etext\uff08\u4ee3\u7801\u6bb5\u622a\u6b62\u5904\u5730\u5740\uff09\u3001edata\uff08\u6570\u636e\u6bb5\u622a\u6b62\u5904\u5730\u5740\uff09\u3001\u548cend\uff08ucore\u622a\u6b62\u5904\u5730\u5740\uff09\u7684\u503c\u540e\uff0c\u63a2\u6d4b\u51fa\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u7269\u7406\u5185\u5b58\u7684\u5e03\u5c40\u3002\u7136\u540e\u4f1a\u663e\u793a\u5185\u5b58\u8303\u56f4\u548c\u7a7a\u95f2\u5185\u5b58\u7684\u8d77\u59cb\u5730\u5740\uff0c\u663e\u793a\u53ef\u4ee5\u5206\u4e3a\u591a\u5c11\u4e2apage\u3002\u63a5\u4e0b\u6765\u4f1a\u6267\u884c\u5404\u79cd\u6211\u4eec\u8bbe\u7f6e\u7684\u68c0\u67e5\uff0c\u6700\u540e\u54cd\u5e94\u65f6\u949f\u4e2d\u65ad\u3002","title":"\u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab2/step/#_1","text":"","title":"\u5b9e\u9a8c\u6b65\u9aa4\u5982\u4e0b"},{"location":"lab2/step/#_2","text":"Makefile\u4fee\u6539 LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 # LAB3 := -DLAB3_EX1 -DLAB3_EX2 # LAB4 := -DLAB4_EX1 -DLAB4_EX2 \u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a make make qemu -j 16 \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 chenyu$ make qemu -j 16 ( THU.CST ) os is loading ... Special kernel symbols: entry 0xA00000A0 ( phys ) etext 0xA0020000 ( phys ) edata 0xA0153370 ( phys ) end 0xA0156650 ( phys ) Kernel executable memory footprint: 1242KB memory management: default_pmm_manager memory map: [ A0000000, A2000000 ] freemem start at: A0197000 free pages: 00001E69 ## 00000020 check_alloc_page () succeeded! check_pgdir () succeeded! check_boot_pgdir () succeeded! check_slab () succeeded! kmalloc_init () succeeded! LAB2 Check Pass! \u901a\u8fc7\u4e0a\u56fe\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230ucore\u5728\u663e\u793a\u5176entry\uff08\u5165\u53e3\u5730\u5740\uff09\u3001etext\uff08\u4ee3\u7801\u6bb5\u622a\u6b62\u5904\u5730\u5740\uff09\u3001edata\uff08\u6570\u636e\u6bb5\u622a\u6b62\u5904\u5730\u5740\uff09\u3001\u548cend\uff08ucore\u622a\u6b62\u5904\u5730\u5740\uff09\u7684\u503c\u540e\uff0c\u63a2\u6d4b\u51fa\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u7269\u7406\u5185\u5b58\u7684\u5e03\u5c40\u3002\u7136\u540e\u4f1a\u663e\u793a\u5185\u5b58\u8303\u56f4\u548c\u7a7a\u95f2\u5185\u5b58\u7684\u8d77\u59cb\u5730\u5740\uff0c\u663e\u793a\u53ef\u4ee5\u5206\u4e3a\u591a\u5c11\u4e2apage\u3002\u63a5\u4e0b\u6765\u4f1a\u6267\u884c\u5404\u79cd\u6211\u4eec\u8bbe\u7f6e\u7684\u68c0\u67e5\uff0c\u6700\u540e\u54cd\u5e94\u65f6\u949f\u4e2d\u65ad\u3002","title":"\u5185\u5b58\u7ba1\u7406"},{"location":"lab2/task/","text":"\u5b9e\u9a8c\u4efb\u52a1 \u00b6 \u7ec3\u4e601\uff1a\u5b9e\u73b0 first-fit \u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\uff08\u9700\u8981\u7f16\u7a0b\uff09 \u00b6 \u5728\u5b9e\u73b0first fit\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u56de\u6536\u51fd\u6570\u65f6\uff0c\u8981\u8003\u8651\u5730\u5740\u8fde\u7eed\u7684\u7a7a\u95f2\u5757\u4e4b\u95f4\u7684\u5408\u5e76\u64cd\u4f5c\u3002\u63d0\u793a:\u5728\u5efa\u7acb\u7a7a\u95f2\u9875\u5757\u94fe\u8868\u65f6\uff0c\u9700\u8981\u6309\u7167\u7a7a\u95f2\u9875\u5757\u8d77\u59cb\u5730\u5740\u6765\u6392\u5e8f\uff0c\u5f62\u6210\u4e00\u4e2a\u6709\u5e8f\u7684\u94fe\u8868\u3002\u53ef\u80fd\u4f1a\u4fee\u6539default_pmm.c\u4e2d\u7684default_init\uff0cdefault_init_memmap\uff0cdefault_alloc_pages\uff0cdefault_free_pages\u7b49\u76f8\u5173\u51fd\u6570\u3002\u8bf7\u4ed4\u7ec6\u67e5\u770b\u548c\u7406\u89e3default_pmm.c\u4e2d\u7684\u6ce8\u91ca\u3002 \u6ce8\u610f\uff0c\u76ee\u524d\u5b9e\u9a8c\u63d0\u4f9b\u7684\u4ee3\u7801\u5df2\u7ecf\u53ef\u4ee5\u8fd0\u884c\uff0c\u4f46\u5e0c\u671b\u8bfb\u8005\u5728\u7406\u89e3\u7684\u57fa\u7840\u4e0a\u80fd\u81ea\u5df1\u91cd\u65b0\u5b9e\u73b0\u6709\u5173\u51fd\u6570\u3002 \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a - \u4f60\u7684first fit\u7b97\u6cd5\u662f\u5426\u6709\u8fdb\u4e00\u6b65\u7684\u6539\u8fdb\u7a7a\u95f4 \u7ec3\u4e602\uff1a\u5b9e\u73b0\u5bfb\u627e\u865a\u62df\u5730\u5740\u5bf9\u5e94\u7684\u9875\u8868\u9879\uff08\u9700\u8981\u7f16\u7a0b\uff09 \u00b6 \u901a\u8fc7\u8bbe\u7f6e\u9875\u8868\u548c\u5bf9\u5e94\u7684\u9875\u8868\u9879\uff0c\u53ef\u5efa\u7acb\u865a\u62df\u5185\u5b58\u5730\u5740\u548c\u7269\u7406\u5185\u5b58\u5730\u5740\u7684\u5bf9\u5e94\u5173\u7cfb\u3002\u5176\u4e2d\u7684get_pte\u51fd\u6570\u662f\u8bbe\u7f6e\u9875\u8868\u9879\u73af\u8282\u4e2d\u7684\u4e00\u4e2a\u91cd\u8981\u6b65\u9aa4\u3002\u6b64\u51fd\u6570\u627e\u5230\u4e00\u4e2a\u865a\u5730\u5740\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u9879\u7684\u5185\u6838\u865a\u5730\u5740\uff0c\u5982\u679c\u6b64\u4e8c\u7ea7\u9875\u8868\u9879\u4e0d\u5b58\u5728\uff0c\u5219\u5206\u914d\u4e00\u4e2a\u5305\u542b\u6b64\u9879\u7684\u4e8c\u7ea7\u9875\u8868\u3002\u672c\u7ec3\u4e60\u9700\u8981\u8865\u5168get_pte\u51fd\u6570\uff08kern/mm/pmm.c\u4e2d\uff09\uff0c\u5b9e\u73b0\u5176\u529f\u80fd\u3002\u8bf7\u4ed4\u7ec6\u67e5\u770b\u548c\u7406\u89e3get_pte\u51fd\u6570\u4e2d\u7684\u6ce8\u91ca\u3002get_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a \u56fe1 get_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a - \u8bf7\u63cf\u8ff0\u9875\u76ee\u5f55\u9879\uff08Page Directory Entry\uff09\u548c\u9875\u8868\u9879\uff08Page Table Entry\uff09\u4e2d\u6bcf\u4e2a\u7ec4\u6210\u90e8\u5206\u7684\u542b\u4e49\u4ee5\u53ca\u5bf9ucore\u800c\u8a00\u7684\u6f5c\u5728\u7528\u5904\u3002 \u7ec3\u4e603\uff1a\u91ca\u653e\u67d0\u865a\u5730\u5740\u6240\u5728\u7684\u9875\u5e76\u53d6\u6d88\u5bf9\u5e94\u4e8c\u7ea7\u9875\u8868\u9879\u7684\u6620\u5c04\uff08\u9700\u8981\u7f16\u7a0b\uff09 \u00b6 \u5f53\u91ca\u653e\u4e00\u4e2a\u5305\u542b\u67d0\u865a\u5730\u5740\u7684\u7269\u7406\u5185\u5b58\u9875\u65f6\uff0c\u9700\u8981\u8ba9\u5bf9\u5e94\u6b64\u7269\u7406\u5185\u5b58\u9875\u7684\u7ba1\u7406\u6570\u636e\u7ed3\u6784Page\u505a\u76f8\u5173\u7684\u6e05\u9664\u5904\u7406\uff0c\u4f7f\u5f97\u6b64\u7269\u7406\u5185\u5b58\u9875\u6210\u4e3a\u7a7a\u95f2\uff1b\u53e6\u5916\u8fd8\u9700\u628a\u8868\u793a\u865a\u5730\u5740\u4e0e\u7269\u7406\u5730\u5740\u5bf9\u5e94\u5173\u7cfb\u7684\u4e8c\u7ea7\u9875\u8868\u9879\u6e05\u9664\u3002\u8bf7\u4ed4\u7ec6\u67e5\u770b\u548c\u7406\u89e3page_remove_pte\u51fd\u6570\u4e2d\u7684\u6ce8\u91ca\u3002\u4e3a\u6b64\uff0c\u9700\u8981\u8865\u5168\u5728kern/mm/pmm.c\u4e2d\u7684page_remove_pte\u51fd\u6570\u3002page_remove_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a \u56fe2 page_remove_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a - \u6570\u636e\u7ed3\u6784Page\u7684\u5168\u5c40\u53d8\u91cf\uff08\u5176\u5b9e\u662f\u4e00\u4e2a\u6570\u7ec4\uff09\u7684\u6bcf\u4e00\u9879\u4e0e\u9875\u8868\u4e2d\u7684\u9875\u76ee\u5f55\u9879\u548c\u9875\u8868\u9879\u6709\u65e0\u5bf9\u5e94\u5173\u7cfb\uff1f\u5982\u679c\u6709\uff0c\u5176\u5bf9\u5e94\u5173\u7cfb\u662f\u5565\uff1f \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u5b8c\u6210\u4ee5\u4e0a\u4e09\u4e2a\u7ec3\u4e60\uff0c\u7ed9\u51fa\u7f16\u8bd1\u8fd0\u884c\u540e\u8f93\u51fa\u7ed3\u679c\u7684\u622a\u56fe\u3002\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u5bf9\u6240\u5199\u4ee3\u7801\u8c03\u7528\u7684\u51fd\u6570\u7684\u4f5c\u7528\u52a0\u4ee5\u8bf4\u660e\u3002 \u9700\u63d0\u4ea4\u53ef\u4ee5\u5728\u6211\u4eec\u7ed9\u5b9a\u7684Docker\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528make qemu\u7f16\u8bd1\u5e76\u8fd0\u884c\u7684\u6587\u4ef6\u5939\u7684\u538b\u7f29\u5305\u3002","title":"\u5b9e\u9a8c\u4efb\u52a1"},{"location":"lab2/task/#_1","text":"","title":"\u5b9e\u9a8c\u4efb\u52a1"},{"location":"lab2/task/#1-first-fit","text":"\u5728\u5b9e\u73b0first fit\u5185\u5b58\u5206\u914d\u7b97\u6cd5\u7684\u56de\u6536\u51fd\u6570\u65f6\uff0c\u8981\u8003\u8651\u5730\u5740\u8fde\u7eed\u7684\u7a7a\u95f2\u5757\u4e4b\u95f4\u7684\u5408\u5e76\u64cd\u4f5c\u3002\u63d0\u793a:\u5728\u5efa\u7acb\u7a7a\u95f2\u9875\u5757\u94fe\u8868\u65f6\uff0c\u9700\u8981\u6309\u7167\u7a7a\u95f2\u9875\u5757\u8d77\u59cb\u5730\u5740\u6765\u6392\u5e8f\uff0c\u5f62\u6210\u4e00\u4e2a\u6709\u5e8f\u7684\u94fe\u8868\u3002\u53ef\u80fd\u4f1a\u4fee\u6539default_pmm.c\u4e2d\u7684default_init\uff0cdefault_init_memmap\uff0cdefault_alloc_pages\uff0cdefault_free_pages\u7b49\u76f8\u5173\u51fd\u6570\u3002\u8bf7\u4ed4\u7ec6\u67e5\u770b\u548c\u7406\u89e3default_pmm.c\u4e2d\u7684\u6ce8\u91ca\u3002 \u6ce8\u610f\uff0c\u76ee\u524d\u5b9e\u9a8c\u63d0\u4f9b\u7684\u4ee3\u7801\u5df2\u7ecf\u53ef\u4ee5\u8fd0\u884c\uff0c\u4f46\u5e0c\u671b\u8bfb\u8005\u5728\u7406\u89e3\u7684\u57fa\u7840\u4e0a\u80fd\u81ea\u5df1\u91cd\u65b0\u5b9e\u73b0\u6709\u5173\u51fd\u6570\u3002 \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a - \u4f60\u7684first fit\u7b97\u6cd5\u662f\u5426\u6709\u8fdb\u4e00\u6b65\u7684\u6539\u8fdb\u7a7a\u95f4","title":"\u7ec3\u4e601\uff1a\u5b9e\u73b0 first-fit \u8fde\u7eed\u7269\u7406\u5185\u5b58\u5206\u914d\u7b97\u6cd5\uff08\u9700\u8981\u7f16\u7a0b\uff09"},{"location":"lab2/task/#2","text":"\u901a\u8fc7\u8bbe\u7f6e\u9875\u8868\u548c\u5bf9\u5e94\u7684\u9875\u8868\u9879\uff0c\u53ef\u5efa\u7acb\u865a\u62df\u5185\u5b58\u5730\u5740\u548c\u7269\u7406\u5185\u5b58\u5730\u5740\u7684\u5bf9\u5e94\u5173\u7cfb\u3002\u5176\u4e2d\u7684get_pte\u51fd\u6570\u662f\u8bbe\u7f6e\u9875\u8868\u9879\u73af\u8282\u4e2d\u7684\u4e00\u4e2a\u91cd\u8981\u6b65\u9aa4\u3002\u6b64\u51fd\u6570\u627e\u5230\u4e00\u4e2a\u865a\u5730\u5740\u5bf9\u5e94\u7684\u4e8c\u7ea7\u9875\u8868\u9879\u7684\u5185\u6838\u865a\u5730\u5740\uff0c\u5982\u679c\u6b64\u4e8c\u7ea7\u9875\u8868\u9879\u4e0d\u5b58\u5728\uff0c\u5219\u5206\u914d\u4e00\u4e2a\u5305\u542b\u6b64\u9879\u7684\u4e8c\u7ea7\u9875\u8868\u3002\u672c\u7ec3\u4e60\u9700\u8981\u8865\u5168get_pte\u51fd\u6570\uff08kern/mm/pmm.c\u4e2d\uff09\uff0c\u5b9e\u73b0\u5176\u529f\u80fd\u3002\u8bf7\u4ed4\u7ec6\u67e5\u770b\u548c\u7406\u89e3get_pte\u51fd\u6570\u4e2d\u7684\u6ce8\u91ca\u3002get_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a \u56fe1 get_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a - \u8bf7\u63cf\u8ff0\u9875\u76ee\u5f55\u9879\uff08Page Directory Entry\uff09\u548c\u9875\u8868\u9879\uff08Page Table Entry\uff09\u4e2d\u6bcf\u4e2a\u7ec4\u6210\u90e8\u5206\u7684\u542b\u4e49\u4ee5\u53ca\u5bf9ucore\u800c\u8a00\u7684\u6f5c\u5728\u7528\u5904\u3002","title":"\u7ec3\u4e602\uff1a\u5b9e\u73b0\u5bfb\u627e\u865a\u62df\u5730\u5740\u5bf9\u5e94\u7684\u9875\u8868\u9879\uff08\u9700\u8981\u7f16\u7a0b\uff09"},{"location":"lab2/task/#3","text":"\u5f53\u91ca\u653e\u4e00\u4e2a\u5305\u542b\u67d0\u865a\u5730\u5740\u7684\u7269\u7406\u5185\u5b58\u9875\u65f6\uff0c\u9700\u8981\u8ba9\u5bf9\u5e94\u6b64\u7269\u7406\u5185\u5b58\u9875\u7684\u7ba1\u7406\u6570\u636e\u7ed3\u6784Page\u505a\u76f8\u5173\u7684\u6e05\u9664\u5904\u7406\uff0c\u4f7f\u5f97\u6b64\u7269\u7406\u5185\u5b58\u9875\u6210\u4e3a\u7a7a\u95f2\uff1b\u53e6\u5916\u8fd8\u9700\u628a\u8868\u793a\u865a\u5730\u5740\u4e0e\u7269\u7406\u5730\u5740\u5bf9\u5e94\u5173\u7cfb\u7684\u4e8c\u7ea7\u9875\u8868\u9879\u6e05\u9664\u3002\u8bf7\u4ed4\u7ec6\u67e5\u770b\u548c\u7406\u89e3page_remove_pte\u51fd\u6570\u4e2d\u7684\u6ce8\u91ca\u3002\u4e3a\u6b64\uff0c\u9700\u8981\u8865\u5168\u5728kern/mm/pmm.c\u4e2d\u7684page_remove_pte\u51fd\u6570\u3002page_remove_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a \u56fe2 page_remove_pte\u51fd\u6570\u7684\u8c03\u7528\u5173\u7cfb\u56fe \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a - \u6570\u636e\u7ed3\u6784Page\u7684\u5168\u5c40\u53d8\u91cf\uff08\u5176\u5b9e\u662f\u4e00\u4e2a\u6570\u7ec4\uff09\u7684\u6bcf\u4e00\u9879\u4e0e\u9875\u8868\u4e2d\u7684\u9875\u76ee\u5f55\u9879\u548c\u9875\u8868\u9879\u6709\u65e0\u5bf9\u5e94\u5173\u7cfb\uff1f\u5982\u679c\u6709\uff0c\u5176\u5bf9\u5e94\u5173\u7cfb\u662f\u5565\uff1f","title":"\u7ec3\u4e603\uff1a\u91ca\u653e\u67d0\u865a\u5730\u5740\u6240\u5728\u7684\u9875\u5e76\u53d6\u6d88\u5bf9\u5e94\u4e8c\u7ea7\u9875\u8868\u9879\u7684\u6620\u5c04\uff08\u9700\u8981\u7f16\u7a0b\uff09"},{"location":"lab2/task/#_2","text":"\u5b8c\u6210\u4ee5\u4e0a\u4e09\u4e2a\u7ec3\u4e60\uff0c\u7ed9\u51fa\u7f16\u8bd1\u8fd0\u884c\u540e\u8f93\u51fa\u7ed3\u679c\u7684\u622a\u56fe\u3002\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u5bf9\u6240\u5199\u4ee3\u7801\u8c03\u7528\u7684\u51fd\u6570\u7684\u4f5c\u7528\u52a0\u4ee5\u8bf4\u660e\u3002 \u9700\u63d0\u4ea4\u53ef\u4ee5\u5728\u6211\u4eec\u7ed9\u5b9a\u7684Docker\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528make qemu\u7f16\u8bd1\u5e76\u8fd0\u884c\u7684\u6587\u4ef6\u5939\u7684\u538b\u7f29\u5305\u3002","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab3/goal/","text":"\u4e86\u89e3\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u521b\u5efa\u8fc7\u7a0b\uff1b \u4e86\u89e3\u7cfb\u7edf\u8c03\u7528\u6846\u67b6\u7684\u5b9e\u73b0\u673a\u5236\uff1b \u4e86\u89e3ucore\u5982\u4f55\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528sys_fork/sys_exec/sys_exit/sys_wait\u6765\u8fdb\u884c\u8fdb\u7a0b\u7ba1\u7406\u3002","title":"\u5b9e\u9a8c\u76ee\u7684"},{"location":"lab3/intro/","text":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0 \u00b6 \u5230\u73b0\u5728\u4e3a\u6b62\uff0cucore\u8fd8\u4e00\u76f4\u5728\u6838\u5fc3\u6001\u201c\u6253\u8f6c\u201d\uff0c\u6ca1\u6709\u5230\u7528\u6237\u6001\u6267\u884c\u3002\u63d0\u4f9b\u5404\u79cd\u64cd\u4f5c\u7cfb\u7edf\u529f\u80fd\u7684\u5185\u6838\u7ebf\u7a0b\u53ea\u80fd\u5728CPU\u6838\u5fc3\u6001\u8fd0\u884c\u662f\u64cd\u4f5c\u7cfb\u7edf\u81ea\u8eab\u7684\u8981\u6c42\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c31\u8981\u5446\u5728\u6838\u5fc3\u6001\uff0c\u624d\u80fd\u7ba1\u7406\u6574\u4e2a\u8ba1\u7b97\u673a\u7cfb\u7edf\u3002\u4f46\u5e94\u7528\u7a0b\u5e8f\u5458\u4e5f\u9700\u8981\u7f16\u5199\u5404\u79cd\u5e94\u7528\u8f6f\u4ef6\uff0c\u4e14\u8981\u5728\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e0a\u8fd0\u884c\u3002\u5982\u679c\u628a\u8fd9\u4e9b\u5e94\u7528\u8f6f\u4ef6\u90fd\u4f5c\u4e3a\u5185\u6838\u7ebf\u7a0b\u6765\u6267\u884c\uff0c\u90a3\u7cfb\u7edf\u7684\u5b89\u5168\u6027\u5c31\u65e0\u6cd5\u5f97\u5230\u4fdd\u8bc1\u4e86\u3002\u6240\u4ee5\uff0cucore\u8981\u63d0\u4f9b\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u521b\u5efa\u548c\u6267\u884c\u673a\u5236\uff0c\u7ed9\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u63d0\u4f9b\u4e00\u4e2a\u7528\u6237\u6001\u8fd0\u884c\u73af\u5883\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7b80\u8981\u5206\u6790\u672c\u5b9e\u9a8c\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u4ee5\u53ca\u5206\u6790\u7528\u6237\u8fdb\u7a0b\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u6765\u9610\u8ff0\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406\u7684\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\u3002 \u663e\u7136\uff0c\u7531\u4e8e\u8fdb\u7a0b\u7684\u6267\u884c\u7a7a\u95f4\u6269\u5c55\u5230\u4e86\u7528\u6237\u6001\u7a7a\u95f4\uff0c\u4e14\u51fa\u73b0\u4e86\u521b\u5efa\u5b50\u8fdb\u7a0b\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7b49\u4e0e\u524d\u9762\u7684\u5b9e\u9a8c\u6709\u8f83\u5927\u4e0d\u540c\u7684\u5730\u65b9\uff0c\u6240\u4ee5\u5177\u4f53\u5b9e\u73b0\u7684\u4e0d\u540c\u4e3b\u8981\u96c6\u4e2d\u5728\u8fdb\u7a0b\u7ba1\u7406\u548c\u5185\u5b58\u7ba1\u7406\u90e8\u5206\u3002\u9996\u5148\uff0c\u6211\u4eec\u4eceucore\u7684\u521d\u59cb\u5316\u90e8\u5206\u6765\u770b\uff0c\u4f1a\u53d1\u73b0\u521d\u59cb\u5316\u7684\u603b\u63a7\u51fd\u6570kern_init\u6ca1\u6709\u4efb\u4f55\u53d8\u5316\u3002\u4f46\u8fd9\u5e76\u4e0d\u610f\u5473\u7740\u4e8c\u8005\u5dee\u522b\u4e0d\u5927\u3002\u5176\u5b9ekern_init\u8c03\u7528\u7684\u7269\u7406\u5185\u5b58\u521d\u59cb\u5316\uff0c\u8fdb\u7a0b\u7ba1\u7406\u521d\u59cb\u5316\u7b49\u90fd\u6709\u4e00\u5b9a\u7684\u53d8\u5316\u3002 \u5728\u5185\u5b58\u7ba1\u7406\u90e8\u5206\uff0c\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406\u9700\u8981\u589e\u52a0\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\u7684\u7ba1\u7406 \u3002\u4e3a\u4e86\u7ba1\u7406\u7528\u6237\u6001\u7684\u865a\u62df\u5185\u5b58\uff0c\u9700\u8981\u5bf9\u9875\u8868\u7684\u5185\u5bb9\u8fdb\u884c\u6269\u5c55\uff0c\u80fd\u591f\u628a\u90e8\u5206\u7269\u7406\u5185\u5b58\u6620\u5c04\u4e3a\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\u3002\u5982\u679c\u67d0\u8fdb\u7a0b\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0cCPU\u5728\u7528\u6237\u6001\u4e0b\u6267\u884c\uff08 \u5728CSR.CRMD\u4e2d\u7684PLV\u57df\uff0c\u5982\u679c\u4e3a0\uff0c\u8868\u793aCPU\u8fd0\u884c\u5728\u7279\u6743\u6001\uff1b\u5982\u679c\u4e3a3\uff0c\u8868\u793aCPU\u8fd0\u884c\u5728\u7528\u6237\u6001 \u3002\uff09\uff0c\u5219\u53ef\u4ee5\u8bbf\u95ee\u672c\u8fdb\u7a0b\u9875\u8868\u63cf\u8ff0\u7684\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\uff0c\u4f46\u7531\u4e8e\u6743\u9650\u4e0d\u591f\uff0c\u4e0d\u80fd\u8bbf\u95ee\u5185\u6838\u6001\u865a\u62df\u5185\u5b58\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4e0d\u540c\u7684\u8fdb\u7a0b\u6709\u5404\u81ea\u7684\u9875\u8868\uff0c\u6240\u4ee5\u5373\u4f7f\u4e0d\u540c\u8fdb\u7a0b\u7684\u7528\u6237\u6001\u865a\u62df\u5730\u5740\u76f8\u540c\uff0c\u4f46\u7531\u4e8e\u9875\u8868\u628a\u865a\u62df\u9875\u6620\u5c04\u5230\u4e86\u4e0d\u540c\u7684\u7269\u7406\u9875\u5e27\uff0c\u6240\u4ee5\u4e0d\u540c\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u662f\u88ab\u9694\u79bb\u5f00\u7684\uff0c\u76f8\u4e92\u4e4b\u95f4\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u3002\u5728\u7528\u6237\u6001\u5185\u5b58\u7a7a\u95f4\u548c\u5185\u6838\u6001\u5185\u5b58\u7a7a\u95f4\u4e4b\u95f4\u9700\u8981\u62f7\u8d1d\u6570\u636e\uff0c\u8ba9CPU\u5904\u5728\u5185\u6838\u6001\u624d\u80fd\u5b8c\u6210\u5bf9\u7528\u6237\u7a7a\u95f4\u7684\u8bfb\u6216\u5199\uff0c\u4e3a\u6b64\u9700\u8981\u8bbe\u8ba1\u4e13\u95e8\u7684\u62f7\u8d1d\u51fd\u6570\uff08copy_from_user\u548ccopy_to_user\uff09\u5b8c\u6210\u3002\u4f46\u53cd\u4e4b\u5219\u4f1a\u5bfc\u81f4\u8fdd\u53cdCPU\u7684\u6743\u9650\u7ba1\u7406\uff0c\u5bfc\u81f4\u5185\u5b58\u8bbf\u95ee\u5f02\u5e38\u3002 \u5728\u8fdb\u7a0b\u7ba1\u7406\u65b9\u9762\uff0c\u4e3b\u8981\u6d89\u53ca\u5230\u7684\u662f\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2d\u4e0e\u5185\u5b58\u7ba1\u7406\u76f8\u5173\u7684\u90e8\u5206 \uff0c\u5305\u62ec\u2460\u5efa\u7acb\u8fdb\u7a0b\u7684\u9875\u8868\u548c\u7ef4\u62a4\u8fdb\u7a0b\u53ef\u8bbf\u95ee\u7a7a\u95f4\uff08\u53ef\u80fd\u8fd8\u6ca1\u6709\u5efa\u7acb\u865a\u5b9e\u6620\u5c04\u5173\u7cfb\uff09\u7684\u4fe1\u606f\uff1b\u2461\u52a0\u8f7d\u4e00\u4e2aELF\u683c\u5f0f\u7684\u7a0b\u5e8f\u5230\u8fdb\u7a0b\u63a7\u5236\u5757\u7ba1\u7406\u7684\u5185\u5b58\u4e2d\u7684\u65b9\u6cd5\uff1b\u2462\u5728\u8fdb\u7a0b\u590d\u5236\uff08fork\uff09\u8fc7\u7a0b\u4e2d\uff0c\u628a\u7236\u8fdb\u7a0b\u7684\u5185\u5b58\u7a7a\u95f4\u62f7\u8d1d\u5230\u5b50\u8fdb\u7a0b\u5185\u5b58\u7a7a\u95f4\u7684\u6280\u672f\u3002\u53e6\u5916\u4e00\u90e8\u5206\u4e0e\u7528\u6237\u6001\u8fdb\u7a0b\u751f\u547d\u5468\u671f\u7ba1\u7406\u76f8\u5173\uff0c\u5305\u62ec\u8ba9\u8fdb\u7a0b\u653e\u5f03CPU\u800c\u7761\u7720\u7b49\u5f85\u67d0\u4e8b\u4ef6\uff1b\u8ba9\u7236\u8fdb\u7a0b\u7b49\u5f85\u5b50\u8fdb\u7a0b\u7ed3\u675f\uff1b\u4e00\u4e2a\u8fdb\u7a0b\u6740\u6b7b\u53e6\u4e00\u4e2a\u8fdb\u7a0b\uff1b\u7ed9\u8fdb\u7a0b\u53d1\u6d88\u606f\uff1b\u5efa\u7acb\u8fdb\u7a0b\u7684\u8840\u7f18\u5173\u7cfb\u94fe\u8868\u3002 \u5f53\u5b9e\u73b0\u4e86\u4e0a\u8ff0\u5185\u5b58\u7ba1\u7406\u548c\u8fdb\u7a0b\u7ba1\u7406\u7684\u9700\u6c42\u540e\uff0c\u63a5\u4e0b\u6765ucore\u7684\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406\u5de5\u4f5c\u5c31\u6bd4\u8f83\u7b80\u5355\u4e86\u3002\u9996\u5148\uff0c\u201c\u786c\u201d\u6784\u9020\u51fa\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u5b83\u662f\u540e\u7eed\u6240\u6709\u8fdb\u7a0b\u7684\u7956\u5148\uff1b\u7136\u540e\uff0c\u5728proc_init\u51fd\u6570\u4e2d\uff0c\u901a\u8fc7alloc\u628a\u5f53\u524ducore\u7684\u6267\u884c\u73af\u5883\u8f6c\u53d8\u6210idle\u5185\u6838\u7ebf\u7a0b\u7684\u6267\u884c\u73b0\u573a\uff1b\u7136\u540e\u8c03\u7528kernl_thread\u6765\u521b\u5efa\u7b2c\u4e8c\u4e2a\u5185\u6838\u7ebf\u7a0binit_main\uff0c\u800cinit_main\u5185\u6838\u7ebf\u7a0b\u6709\u521b\u5efa\u4e86user_main\u5185\u6838\u7ebf\u7a0b\u3002\u5230\u6b64\uff0c\u5185\u6838\u7ebf\u7a0b\u521b\u5efa\u5b8c\u6bd5\uff0c\u5e94\u8be5\u5f00\u59cb\u7528\u6237\u8fdb\u7a0b\u7684\u521b\u5efa\u8fc7\u7a0b\uff0c\u8fd9\u7b2c\u4e00\u6b65\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7user_main\u51fd\u6570\u8c03\u7528kernel_tread\u521b\u5efa\u5b50\u8fdb\u7a0b\uff0c\u901a\u8fc7kernel_execve\u8c03\u7528\u6765\u628a\u67d0\u4e00\u5177\u4f53\u7a0b\u5e8f\u7684\u6267\u884c\u5185\u5bb9\u653e\u5165\u5185\u5b58\u3002\u5177\u4f53\u7684\u653e\u7f6e\u65b9\u5f0f\u662f\u6839\u636eld\u5728\u6b64\u6587\u4ef6\u4e0a\u7684\u5730\u5740\u5206\u914d\u4e3a\u57fa\u672c\u539f\u5219\uff0c\u628a\u7a0b\u5e8f\u7684\u4e0d\u540c\u90e8\u5206\u653e\u5230\u67d0\u8fdb\u7a0b\u7684\u7528\u6237\u7a7a\u95f4\u4e2d\uff0c\u4ece\u800c\u901a\u8fc7\u6b64\u8fdb\u7a0b\u6765\u5b8c\u6210\u7a0b\u5e8f\u63cf\u8ff0\u7684\u4efb\u52a1\u3002\u4e00\u65e6\u6267\u884c\u4e86\u8fd9\u4e00\u7a0b\u5e8f\u5bf9\u5e94\u7684\u8fdb\u7a0b\uff0c\u5c31\u4f1a\u4ece\u5185\u6838\u6001\u5207\u6362\u5230\u7528\u6237\u6001\u7ee7\u7eed\u6267\u884c\u3002\u4ee5\u6b64\u7c7b\u63a8\uff0cCPU\u5728\u7528\u6237\u7a7a\u95f4\u6267\u884c\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u5176\u5730\u5740\u7a7a\u95f4\u4e0d\u4f1a\u88ab\u5176\u4ed6\u7528\u6237\u7684\u8fdb\u7a0b\u5f71\u54cd\uff0c\u4f46\u7531\u4e8e\u7cfb\u7edf\u8c03\u7528\uff08\u7528\u6237\u8fdb\u7a0b\u76f4\u63a5\u83b7\u5f97\u64cd\u4f5c\u7cfb\u7edf\u670d\u52a1\u7684\u552f\u4e00\u901a\u9053\uff09\u3001\u5916\u8bbe\u4e2d\u65ad\u548c\u5f02\u5e38\u4e2d\u65ad\u7684\u4f1a\u968f\u65f6\u4ea7\u751f\uff0c\u4ece\u800c\u95f4\u63a5\u63a8\u52a8\u4e86\u7528\u6237\u8fdb\u7a0b\u5b9e\u73b0\u7528\u6237\u6001\u5230\u5230\u5185\u6838\u6001\u7684\u5207\u6362\u5de5\u4f5c\u3002ucore\u5bf9CPU\u5185\u6838\u6001\u4e0e\u7528\u6237\u6001\u7684\u5207\u6362\u8fc7\u7a0b\u9700\u8981\u6bd4\u8f83\u4ed4\u7ec6\u5730\u5206\u6790\u3002\u5f53\u8fdb\u7a0b\u6267\u884c\u7ed3\u675f\u540e\uff0c\u9700\u56de\u6536\u8fdb\u7a0b\u5360\u7528\u548c\u6ca1\u6d88\u8017\u5b8c\u6bd5\u7684\u8bbe\u5907\u6574\u4e2a\u8fc7\u7a0b\uff0c\u4e14\u4e3a\u65b0\u7684\u521b\u5efa\u8fdb\u7a0b\u8bf7\u6c42\u63d0\u4f9b\u670d\u52a1\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u5f53\u7cfb\u7edf\u4e2d\u5b58\u5728\u591a\u4e2a\u8fdb\u7a0b\u6216\u5185\u6838\u7ebf\u7a0b\u65f6\uff0cucore\u91c7\u7528\u4e86\u4e00\u79cdFIFO\u7684\u5f88\u7b80\u5355\u7684\u8c03\u5ea6\u65b9\u6cd5\u6765\u7ba1\u7406\u6bcf\u4e2a\u8fdb\u7a0b\u5360\u7528CPU\u7684\u65f6\u95f4\u548c\u9891\u5ea6\u7b49\u3002\u5728ucore\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0c\u7531\u4e8e\u8c03\u5ea6\u3001\u65f6\u95f4\u4e2d\u65ad\u3001\u7cfb\u7edf\u8c03\u7528\u7b49\u539f\u56e0\uff0c\u4f7f\u5f97\u8fdb\u7a0b\u4f1a\u8fdb\u884c\u5207\u6362\u3001\u521b\u5efa\u3001\u7761\u7720\u3001\u7b49\u5f85\u3001\u53d1\u6d88\u606f\u7b49\u5404\u79cd\u4e0d\u540c\u7684\u64cd\u4f5c\uff0c\u5468\u800c\u590d\u59cb\uff0c\u751f\u751f\u4e0d\u606f\u3002 \u8fdb\u7a0b\u63a7\u5236\u5757 \u00b6 \u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u5e76\u6267\u884c\u5b9e\u9645\u4e0a\u5c5e\u4e8e\u6267\u884c\u7528\u6237\u8fdb\u7a0b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5728\u521b\u5efa\u5e76\u6267\u884c\u7528\u6237\u8fdb\u7a0b\u4e4b\u524d\uff0c\u9996\u5148\u8981\u521b\u5efa\u5185\u6838\u8fdb\u7a0b\u3002\u5728\u4e86\u89e3\u8fd9\u4e9b\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u4ecb\u7ecd\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u8bbe\u8ba1\u3002\u8fdb\u7a0b\u7ba1\u7406\u4fe1\u606f\u7528\u4e00\u4e2a\u540d\u4e3aproc_struct\u7684\u6570\u636e\u7ed3\u6784\u8868\u793a\uff0c\u5728kern/process/proc.h\u4e2d\u5b9a\u4e49\u5982\u4e0b\uff1a struct proc_struct { enum proc_state state ; // Process state int pid ; // Process ID int runs ; // the running times of Proces uintptr_t kstack ; // Process kernel stack volatile bool need_resched ; // bool value: need to be rescheduled to release CPU? struct proc_struct * parent ; // the parent process struct mm_struct * mm ; // Process's memory management field struct context context ; // Switch here to run process struct trapframe * tf ; // Trap frame for current interrupt uintptr_t cr3 ; // CR3 register: the base addr of Page Directroy Table(PDT) uint32_t flags ; // Process flag char name [ PROC_NAME_LEN + 1 ]; // Process name list_entry_t list_link ; // Process link list list_entry_t hash_link ; // Process hash list int exit_code ; // exit code (be sent to parent proc) uint32_t wait_state ; // waiting state struct proc_struct * cptr , * yptr , * optr ; // relations between processes struct run_queue * rq ; // running queue contains Process list_entry_t run_link ; // the entry linked in run queue int time_slice ; // time slice for occupying the CPU struct fs_struct * fs_struct ; // the file related info(pwd, files_count, files_array, fs_semaphore) of process skew_heap_entry_t lab6_run_pool ; // FOR LAB6 ONLY: the entry in the run pool uint32_t lab6_stride ; // FOR LAB6 ONLY: the current stride of the process uint32_t lab6_priority ; // FOR LAB6 ONLY: the priority of process, set by lab6_set_priority(uint32_t) }; \u4e0b\u9762\u91cd\u70b9\u89e3\u91ca\u4e00\u4e0b\u51e0\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u6210\u5458\u53d8\u91cf\uff1a \u25cf mm\uff1a\u5185\u5b58\u7ba1\u7406\u7684\u4fe1\u606f \uff0c\u5305\u62ec\u5185\u5b58\u6620\u5c04\u5217\u8868\u3001\u9875\u8868\u6307\u9488\u7b49\u3002mm\u91cc\u6709\u4e2a\u5f88\u91cd\u8981\u7684\u9879pgdir\uff0c\u8bb0\u5f55\u7684\u662f\u8be5\u8fdb\u7a0b\u4f7f\u7528\u7684\u4e00\u7ea7\u9875\u8868\u7684\u7269\u7406\u5730\u5740\u3002\u7531\u4e8e*mm=NULL\uff0c\u6240\u4ee5\u5728proc_struct\u6570\u636e\u7ed3\u6784\u4e2d\u9700\u8981\u6709\u4e00\u4e2a\u4ee3\u66ffpgdir\u9879\u6765\u8bb0\u5f55\u9875\u8868\u8d77\u59cb\u5730\u5740\uff0c\u8fd9\u5c31\u662fproc_struct\u6570\u636e\u7ed3\u6784\u4e2d\u7684cr3\u6210\u5458\u53d8\u91cf\u3002 \u25cf state\uff1a\u8fdb\u7a0b\u6240\u5904\u7684\u72b6\u6001\u3002 \u25cf parent\uff1a\u7528\u6237\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\uff08\u521b\u5efa\u5b83\u7684\u8fdb\u7a0b\uff09\u3002\u5728\u6240\u6709\u8fdb\u7a0b\u4e2d\uff0c\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b\u6ca1\u6709\u7236\u8fdb\u7a0b\uff0c\u5c31\u662f\u5185\u6838\u521b\u5efa\u7684\u7b2c\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0bidleproc\u3002\u5185\u6838\u6839\u636e\u8fd9\u4e2a\u7236\u5b50\u5173\u7cfb\u5efa\u7acb\u4e00\u4e2a\u6811\u5f62\u7ed3\u6784\uff0c\u7528\u4e8e\u7ef4\u62a4\u4e00\u4e9b\u7279\u6b8a\u7684\u64cd\u4f5c\uff0c\u4f8b\u5982\u786e\u5b9a\u67d0\u4e2a\u8fdb\u7a0b\u662f\u5426\u53ef\u4ee5\u5bf9\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u8fdb\u884c\u67d0\u79cd\u64cd\u4f5c\u7b49\u7b49\u3002 \u25cf kstack: \u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u4e00\u4e2a\u5185\u6838\u6808\uff0c\u5e76\u4e14\u4f4d\u4e8e\u5185\u6838\u5730\u5740\u7a7a\u95f4\u7684\u4e0d\u540c\u4f4d\u7f6e\u3002\u5bf9\u4e8e\u5185\u6838\u7ebf\u7a0b\uff0c\u8be5\u6808\u5c31\u662f\u8fd0\u884c\u65f6\u7684\u7a0b\u5e8f\u4f7f\u7528\u7684\u6808\uff1b\u800c\u5bf9\u4e8e\u666e\u901a\u8fdb\u7a0b\uff0c\u8be5\u6808\u662f\u53d1\u751f\u7279\u6743\u7ea7\u6539\u53d8\u7684\u65f6\u5019\u4f7f\u4fdd\u5b58\u88ab\u6253\u65ad\u7684\u786c\u4ef6\u4fe1\u606f\u7528\u7684\u6808\u3002uCore\u5728\u521b\u5efa\u8fdb\u7a0b\u65f6\u5206\u914d\u4e86 2 \u4e2a\u8fde\u7eed\u7684\u7269\u7406\u9875\uff08\u53c2\u89c1memlayout.h\u4e2dKSTACKSIZE\u7684\u5b9a\u4e49\uff09\u4f5c\u4e3a\u5185\u6838\u6808\u7684\u7a7a\u95f4\u3002\u8fd9\u4e2a\u6808\u5f88\u5c0f\uff0c\u6240\u4ee5\u5185\u6838\u4e2d\u7684\u4ee3\u7801\u5e94\u8be5\u5c3d\u53ef\u80fd\u7684\u7d27\u51d1\uff0c\u5e76\u4e14\u907f\u514d\u5728\u6808\u4e0a\u5206\u914d\u5927\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4ee5\u514d\u6808\u6ea2\u51fa\uff0c\u5bfc\u81f4\u7cfb\u7edf\u5d29\u6e83\u3002 kstack\u8bb0\u5f55\u4e86\u5206\u914d\u7ed9\u8be5\u8fdb\u7a0b/\u7ebf\u7a0b\u7684\u5185\u6838\u6808\u7684\u4f4d\u7f6e \u3002\u4e3b\u8981\u4f5c\u7528\u6709\u4ee5\u4e0b\u51e0\u70b9\u3002\u9996\u5148\uff0c\u5f53\u5185\u6838\u51c6\u5907\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u7684\u65f6\u5019\uff0c\u9700\u8981\u6839\u636ekstack \u7684\u503c\u6b63\u786e\u7684\u8bbe\u7f6e\u597d tss\uff0c\u4ee5\u4fbf\u5728\u8fdb\u7a0b\u5207\u6362\u4ee5\u540e\u518d\u53d1\u751f\u4e2d\u65ad\u65f6\u80fd\u591f\u4f7f\u7528\u6b63\u786e\u7684\u6808\u3002\u5176\u6b21\uff0c\u5185\u6838\u6808\u4f4d\u4e8e\u5185\u6838\u5730\u5740\u7a7a\u95f4\uff0c\u5e76\u4e14\u662f\u4e0d\u5171\u4eab\u7684\uff08\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u62e5\u6709\u81ea\u5df1\u7684\u5185\u6838\u6808\uff09\uff0c\u56e0\u6b64\u4e0d\u53d7\u5230 mm \u7684\u7ba1\u7406\uff0c\u5f53\u8fdb\u7a0b\u9000\u51fa\u7684\u65f6\u5019\uff0c\u5185\u6838\u80fd\u591f\u6839\u636e kstack \u7684\u503c\u5feb\u901f\u5b9a\u4f4d\u6808\u7684\u4f4d\u7f6e\u5e76\u8fdb\u884c\u56de\u6536\u3002 \u25cf tf\uff1a\u4e2d\u65ad\u5e27\u7684\u6307\u9488 \uff0c\u603b\u662f\u6307\u5411\u5185\u6838\u6808\u7684\u67d0\u4e2a\u4f4d\u7f6e\uff1a\u5f53\u8fdb\u7a0b\u4ece\u7528\u6237\u7a7a\u95f4\u8df3\u5230\u5185\u6838\u7a7a\u95f4\u65f6\uff0c\u4e2d\u65ad\u5e27\u8bb0\u5f55\u4e86\u8fdb\u7a0b\u5728\u88ab\u4e2d\u65ad\u524d\u7684\u72b6\u6001\u3002 \u5f53\u5185\u6838\u9700\u8981\u8df3\u56de\u7528\u6237\u7a7a\u95f4\u65f6\uff0c\u9700\u8981\u8c03\u6574\u4e2d\u65ad\u5e27\u4ee5\u6062\u590d\u8ba9\u8fdb\u7a0b\u7ee7\u7eed\u6267\u884c\u7684\u5404\u5bc4\u5b58\u5668\u503c \u3002\u9664\u6b64\u4e4b\u5916\uff0cuCore\u5185\u6838\u5141\u8bb8\u5d4c\u5957\u4e2d\u65ad\u3002\u56e0\u6b64\u4e3a\u4e86\u4fdd\u8bc1\u5d4c\u5957\u4e2d\u65ad\u53d1\u751f\u65f6tf \u603b\u662f\u80fd\u591f\u6307\u5411\u5f53\u524d\u7684trapframe\uff0cuCore \u5728\u5185\u6838\u6808\u4e0a\u7ef4\u62a4\u4e86 tf \u7684\u94fe\uff0c\u53ef\u4ee5\u53c2\u8003trap.c::trap\u51fd\u6570\u505a\u8fdb\u4e00\u6b65\u7684\u4e86\u89e3\u3002 \u25cf cr3: cr3 \u4fdd\u5b58\u9875\u8868\u7684\u7269\u7406\u5730\u5740\uff0c\u76ee\u7684\u5c31\u662f\u8fdb\u7a0b\u5207\u6362\u7684\u65f6\u5019\u65b9\u4fbf\u76f4\u63a5\u4f7f\u7528 lcr3\u5b9e\u73b0\u9875\u8868\u5207\u6362\uff0c\u907f\u514d\u6bcf\u6b21\u90fd\u6839\u636e mm \u6765\u8ba1\u7b97 cr3\u3002mm\u6570\u636e\u7ed3\u6784\u662f\u7528\u6765\u5b9e\u73b0\u7528\u6237\u7a7a\u95f4\u7684\u865a\u5b58\u7ba1\u7406\u7684\uff0c\u5f53\u67d0\u4e2a\u8fdb\u7a0b\u662f\u4e00\u4e2a\u666e\u901a\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u65f6\u5019\uff0cPCB \u4e2d\u7684 cr3 \u5c31\u662f mm \u4e2d\u9875\u8868\uff08pgdir\uff09\u7684\u7269\u7406\u5730\u5740\uff1b\u800c\u5f53\u5b83\u662f\u5185\u6838\u7ebf\u7a0b\u7684\u65f6\u5019\uff0ccr3 \u7b49\u4e8eboot_cr3\u3002\u800cboot_cr3\u6307\u5411\u4e86uCore\u542f\u52a8\u65f6\u5efa\u7acb\u597d\u7684\u997f\u5185\u6838\u865a\u62df\u7a7a\u95f4\u7684\u9875\u76ee\u5f55\u8868\u9996\u5730\u5740\u3002 \u4e3a\u4e86\u7ba1\u7406\u7cfb\u7edf\u4e2d\u6240\u6709\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\uff0cuCore\u7ef4\u62a4\u4e86\u5982\u4e0b\u5168\u5c40\u53d8\u91cf\uff08\u4f4d\u4e8ekern/process/proc.c\uff09\uff1a \u25cf static struct proc *current\uff1a\u5f53\u524d\u5360\u7528CPU\u4e14\u5904\u4e8e\u201c\u8fd0\u884c\u201d\u72b6\u6001\u8fdb\u7a0b\u63a7\u5236\u5757\u6307\u9488\u3002\u901a\u5e38\u8fd9\u4e2a\u53d8\u91cf\u662f\u53ea\u8bfb\u7684\uff0c\u53ea\u6709\u5728\u8fdb\u7a0b\u5207\u6362\u7684\u65f6\u5019\u624d\u8fdb\u884c\u4fee\u6539\u3002 \u25cf static struct proc *initproc\uff1a\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6b64\u6307\u9488\u5c06\u6307\u5411\u7b2c\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b \u3002 \u25cf static list_entry_t hash_list[HASH_LIST_SIZE]\uff1a\u6240\u6709\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u54c8\u5e0c\u8868\uff0cproc_struct\u4e2d\u7684\u6210\u5458\u53d8\u91cfhash_link\u5c06\u57fa\u4e8epid\u94fe\u63a5\u5165\u8fd9\u4e2a\u54c8\u5e0c\u8868\u4e2d\u3002 \u25cf list_entry_t proc_list\uff1a\u6240\u6709\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u53cc\u5411\u7ebf\u6027\u5217\u8868\uff0cproc_struct\u4e2d\u7684\u6210\u5458\u53d8\u91cflist_link\u5c06\u94fe\u63a5\u5165\u8fd9\u4e2a\u94fe\u8868\u4e2d\u3002 \u521b\u5efa\u7528\u6237\u8fdb\u7a0b \u00b6 1. \u5e94\u7528\u7a0b\u5e8f\u7684\u7ec4\u6210\u548c\u7f16\u8bd1 \u00b6 \u6211\u4eec\u9996\u5148\u6765\u770b\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd9\u91cc\u6211\u4eec\u5047\u5b9a\u662fhello\u5e94\u7528\u7a0b\u5e8f\uff0c\u5728user/hello.c\u4e2d\u5b9e\u73b0\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a #include <stdio.h> #include <ulib.h> int main ( void ) { cprintf ( \"Hello world!!. \\n \" ); cprintf ( \"I am process %d. \\n \" , getpid ()); cprintf ( \"hello pass. \\n \" ); return 0 ; } hello\u5e94\u7528\u7a0b\u5e8f\u53ea\u662f\u8f93\u51fa\u4e00\u4e9b\u5b57\u7b26\u4e32\uff0c\u5e76\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_getpid\uff08\u5728getpid\u51fd\u6570\u4e2d\u8c03\u7528\uff09\u8f93\u51fa\u4ee3\u8868hello\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u7528\u6237\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u6807\u8bc6--pid\u3002 \u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3ucore\u64cd\u4f5c\u7cfb\u7edf\u5982\u4f55\u80fd\u591f\u627e\u5230hello\u5e94\u7528\u7a0b\u5e8f\u3002\u8fd9\u9700\u8981\u5206\u6790ucore\u548chello\u662f\u5982\u4f55\u7f16\u8bd1\u7684\u3002\u5728\u672c\u5b9e\u9a8c\u6e90\u7801\u76ee\u5f55\u4e0b\u6267\u884cmake\uff0c\u53ef\u5f97\u5230\u5982\u4e0b\u8f93\u51fa\uff1a \u2026\u2026 + cc user/hello.c loongarch32-linux-gnu-gcc -c -Iuser/libs -Ikern/include -fno-builtin-fprintf -fno-builtin -nostdlib -nostdinc -g -G0 -Wa,-O0 -fno-pic -mno-shared -msoft-float -ggdb -gstabs -mlcsr user/hello.c -o obj/user/hello.o loongarch32-linux-gnu-ld -T user/libs/user.ld obj/user/hello.o --whole-archive obj/user/libuser.a -o obj/user/hello \u2026\u2026 sed 's/$FILE/hello/g' tools/piggy.S.in > obj/user/hello.S \u2026\u2026 # \u6ce8\u610f\uff0c\u53ef\u4ee5\u89c2\u5bdfobj/user/hello.S\u6587\u4ef6\uff0c\u8fd9\u91cc\u6709\u4f7f\u7528.incbin\u53bb\u5f15\u5165\u5148\u524d\u7f16\u8bd1\u597d\u7684obj/user/hello loongarch32-linux-gnu-gcc -c obj/user/hello.S -o obj/user/hello.piggy.o loongarch32-linux-gnu-ld -nostdlib -n -G 0 -static -T tools/kernel.ld obj/init/init.o \u2026\u2026 obj/user/hello.piggy.o \u2026\u2026 -o obj/ucore-kernel-piggy \u4ece\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0chello\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4ec5\u4ec5\u662fhello.c\uff0c\u8fd8\u5305\u542b\u4e86\u652f\u6301hello\u5e94\u7528\u7a0b\u5e8f\u7684\u7528\u6237\u6001\u5e93\uff1a user/libs/initcode.S\uff1a\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u7684\u8d77\u59cb\u7528\u6237\u6001\u6267\u884c\u5730\u5740\u201c_start\u201d\uff0c\u8c03\u6574\u4e86gp\u548csp\u540e\uff0c\u8c03\u7528umain\u51fd\u6570\u3002 user/libs/umain.c\uff1a\u5b9e\u73b0\u4e86umain\u51fd\u6570\uff0c\u8fd9\u662f\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u7b2c\u4e00\u4e2aC\u51fd\u6570\uff0c\u5b83\u5c06\u8c03\u7528\u5e94\u7528\u7a0b\u5e8f\u7684main\u51fd\u6570\uff0c\u5e76\u5728main\u51fd\u6570\u7ed3\u675f\u540e\u8c03\u7528exit\u51fd\u6570\uff0c\u800cexit\u51fd\u6570\u6700\u7ec8\u5c06\u8c03\u7528sys_exit\u7cfb\u7edf\u8c03\u7528\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u56de\u6536\u8fdb\u7a0b\u8d44\u6e90\u3002 user/libs/ulib.[ch]\uff1a\u5b9e\u73b0\u4e86\u6700\u5c0f\u7684C\u51fd\u6570\u5e93\uff0c\u9664\u4e86\u4e00\u4e9b\u4e0e\u7cfb\u7edf\u8c03\u7528\u65e0\u5173\u7684\u51fd\u6570\uff0c\u5176\u4ed6\u51fd\u6570\u662f\u5bf9\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u7684\u5305\u88c5\u3002 user/libs/syscall.[ch]\uff1a\u7528\u6237\u5c42\u53d1\u51fa\u7cfb\u7edf\u8c03\u7528\u7684\u5177\u4f53\u5b9e\u73b0\u3002 user/libs/stdio.c\uff1a\u5b9e\u73b0cprintf\u51fd\u6570\uff0c\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_putc\u6765\u5b8c\u6210\u5b57\u7b26\u8f93\u51fa\u3002 user/libs/panic.c\uff1a\u5b9e\u73b0__panic/__warn\u51fd\u6570\uff0c\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_exit\u5b8c\u6210\u7528\u6237\u8fdb\u7a0b\u9000\u51fa\u3002 \u9664\u4e86\u8fd9\u4e9b\u7528\u6237\u6001\u5e93\u51fd\u6570\u5b9e\u73b0\u5916\uff0c\u8fd8\u6709\u4e00\u4e9blibs/*.[ch]\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u548c\u5e94\u7528\u7a0b\u5e8f\u5171\u7528\u7684\u51fd\u6570\u5b9e\u73b0\u3002\u8fd9\u4e9b\u7528\u6237\u5e93\u51fd\u6570\u5176\u5b9e\u5728\u672c\u8d28\u4e0a\u4e0eUNIX\u7cfb\u7edf\u4e2d\u7684\u6807\u51c6libc\u6ca1\u6709\u533a\u522b\uff0c\u53ea\u662f\u5b9e\u73b0\u5f97\u5f88\u7b80\u5355\uff0c\u4f46hello\u5e94\u7528\u7a0b\u5e8f\u7684\u6b63\u786e\u6267\u884c\u79bb\u4e0d\u5f00\u8fd9\u4e9b\u5e93\u51fd\u6570\u3002 \u3010 \u6ce8\u610f \u3011libs/ .[ch]\u3001user/libs/ .[ch]\u3001user/*.[ch]\u7684\u6e90\u7801\u4e2d\u6ca1\u6709\u4efb\u4f55\u7279\u6743\u6307\u4ee4\u3002 a00c3160 _binary_obj_user_hello_end a00125ac file_open a00018d0 strcpy a0000240 ide_device_valid a01455c0 _binary_obj_user_forktree_start a000cb30 wakeup_queue a00156f0 vfs_set_bootfs a000d12c cond_signal a0011850 sysfile_fsync a001a57c dev_init_stdout a00b4ac0 _binary_obj_user_hello_start \u5728make\u7684\u6700\u540e\u4e00\u6b65\u6267\u884c\u4e86\u4e00\u4e2ald\u547d\u4ee4\uff0c\u628ahello\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u7801obj/user/hello.piggy.o\u8fde\u63a5\u5728\u4e86ucore kernel\u7684\u672b\u5c3e\u3002\u5e76\u89c2\u5bdftools/piggy.S.in\u6587\u4ef6\u53ef\u4ee5\u53d1\u73b0\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86.global binary_obj_user FILE_start\u548c.global _binary_obj_user_ FILE_start\u548c.global _binary_obj_user_ FILE_end\u3002\u8fd9\u6837\u8fd9\u4e24\u4e2a\u7b26\u53f7\u5c31\u4f1a\u4fdd\u7559\u5728\u6700\u7ec8ld\u751f\u6210\u7684\u6587\u4ef6\u4e2d\uff0c\u8fd9\u6837\u8fd9\u4e2ahello\u7528\u6237\u7a0b\u5e8f\u5c31\u80fd\u591f\u548cucore\u5185\u6838\u4e00\u8d77\u88ab bootloader \u52a0\u8f7d\u5230\u5185\u5b58\u91cc\u4e2d\uff0c\u5e76\u4e14\u901a\u8fc7\u8fd9\u4e24\u4e2a\u5168\u5c40\u53d8\u91cf\u5b9a\u4f4dhello\u7528\u6237\u7a0b\u5e8f\u6267\u884c\u7801\u7684\u8d77\u59cb\u4f4d\u7f6e\u548c\u5927\u5c0f\u3002\u800c\u5230\u4e86\u4e0e\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u5b9e\u9a8c\u540e\uff0cucore\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u90a3\u65f6\u6240\u6709\u7684\u7528\u6237\u7a0b\u5e8f\u5c31\u90fd\u4e0d\u518d\u7528\u8fd9\u79cd\u65b9\u6cd5\u8fdb\u884c\u52a0\u8f7d\u4e86\uff0c\u800c\u53ef\u4ee5\u7528\u5927\u5bb6\u719f\u6089\u7684\u6587\u4ef6\u65b9\u5f0f\u8fdb\u884c\u52a0\u8f7d\u4e86\u3002 \uff08\u6ce8\uff0c\u540e\u7eed\u7684\u6587\u4ef6\u7cfb\u7edf\u91c7\u7528initrd\u7684\u65b9\u5f0f\uff0c\u5e76\u975e\u4f4d\u4e8e\u78c1\u76d8\u3002\uff09 2. \u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4 \u00b6 \u5728user/libs/user.ld\u63cf\u8ff0\u4e86\u7528\u6237\u7a0b\u5e8f\u7684\u7528\u6237\u865a\u62df\u7a7a\u95f4\u7684\u6267\u884c\u5165\u53e3\u865a\u62df\u5730\u5740\uff1a SECTIONS { /* Load programs at this address: \".\" means the current address */ . = 0x10000000 ; \u5728tools/kernel.ld\u63cf\u8ff0\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u6838\u865a\u62df\u7a7a\u95f4\u7684\u8d77\u59cb\u5165\u53e3\u865a\u62df\u5730\u5740\uff1a SECTIONS { /* Load the kernel at this address: \".\" means the current address */ . = 0xa0000000 ; \u8fd9\u6837ucore\u628a\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5206\u4e86\u4e24\u5757\uff0c\u4e00\u5757\u4e0e\u5185\u6838\u7ebf\u7a0b\u4e00\u6837\uff0c\u662f\u6240\u6709\u7528\u6237\u8fdb\u7a0b\u90fd\u5171\u4eab\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u6620\u5c04\u5230\u540c\u6837\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u4e2d\uff0c\u8fd9\u6837\u5728\u7269\u7406\u5185\u5b58\u4e2d\u53ea\u9700\u653e\u7f6e\u4e00\u4efd\u5185\u6838\u4ee3\u7801\uff0c\u4f7f\u5f97\u7528\u6237\u8fdb\u7a0b\u4ece\u7528\u6237\u6001\u8fdb\u5165\u6838\u5fc3\u6001\u65f6\uff0c\u5185\u6838\u4ee3\u7801\u53ef\u4ee5\u7edf\u4e00\u5e94\u5bf9\u4e0d\u540c\u7684\u5185\u6838\u7a0b\u5e8f\uff1b\u53e6\u5916\u4e00\u5757\u662f\u7528\u6237\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u867d\u7136\u865a\u62df\u5730\u5740\u8303\u56f4\u4e00\u6837\uff0c\u4f46\u6620\u5c04\u5230\u4e0d\u540c\u4e14\u6ca1\u6709\u4ea4\u96c6\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u4e2d\u3002\u8fd9\u6837\u5f53ucore\u628a\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u4ee3\u7801\uff08\u5373\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u4ee3\u7801\uff09\u548c\u6570\u636e\uff08\u5373\u5e94\u7528\u7a0b\u5e8f\u7684\u5168\u5c40\u53d8\u91cf\u7b49\uff09\u653e\u5230\u7528\u6237\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4e2d\u65f6\uff0c\u786e\u4fdd\u4e86\u5404\u4e2a\u8fdb\u7a0b\u4e0d\u4f1a\u201c\u975e\u6cd5\u201d\u8bbf\u95ee\u5230\u5176\u4ed6\u8fdb\u7a0b\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u3002 \u8fd9\u6837ucore\u7ed9\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u5177\u4f53\u8bbe\u5b9a\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff08kern/mm/memlayout.h\uff09\u5982\u4e0b\u6240\u793a\uff1a 3. \u521b\u5efa\u5e76\u6267\u884c\u7528\u6237\u8fdb\u7a0b \u00b6 \u5728\u786e\u5b9a\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u4ee3\u7801\u548c\u6570\u636e\uff0c\u4ee5\u53ca\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u7a7a\u95f4\u5e03\u5c40\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6765\u521b\u5efa\u7528\u6237\u8fdb\u7a0b\u4e86\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u662f\u7531\u7b2c\u4e8c\u4e2a\u5185\u6838\u7ebf\u7a0binitproc\u901a\u8fc7\u628ahello\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u8986\u76d6\u5230initproc\u7684\u7528\u6237\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u6765\u521b\u5efa\u7684\uff0c\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a // kernel_execve - do SYS_exec syscall to exec a user program called by user_main kernel_thread static int kernel_execve ( const char * name , unsigned char * binary , size_t size ) { int ret , len = strlen ( name ); asm volatile ( \"addi.w $a7, $zero,%1; \\n \" // syscall no. \"move $a0, %2; \\n \" \"move $a1, %3; \\n \" \"move $a2, %4; \\n \" \"move $a3, %5; \\n \" \"syscall 0; \\n \" \"move %0, $a7; \\n \" : \"=r\" ( ret ) : \"i\" ( SYSCALL_BASE + SYS_exec ), \"r\" ( name ), \"r\" ( len ), \"r\" ( binary ), \"r\" ( size ) : \"a0\" , \"a1\" , \"a2\" , \"a3\" , \"a7\" ); return ret ; } #define __KERNEL_EXECVE(name, path, ...) ({ \\ const char *argv[] = {path, ##__VA_ARGS__, NULL}; \\ kprintf(\"kernel_execve: pid = %d, name = \\\"%s\\\".\\n\", \\ current->pid, name); \\ kernel_execve(name, argv); \\ }) #define KERNEL_EXECVE(x, ...) __KERNEL_EXECVE(#x, #x, ##__VA_ARGS__) \u2026\u2026 // init_main - the second kernel thread used to create kswapd_main & user_main kernel threads static int init_main ( void * arg ) { #ifdef TEST KERNEL_EXECVE2 ( TEST , TESTSTART , TESTSIZE ); #else KERNEL_EXECVE ( hello ); #endif panic ( \"kernel_execve failed. \\n \" ); return 0 ; } \u5bf9\u4e8e\u4e0a\u8ff0\u4ee3\u7801\uff0c\u6211\u4eec\u9700\u8981\u4ece\u540e\u5411\u524d\u6309\u7167\u51fd\u6570/\u5b8f\u7684\u5b9e\u73b0\u4e00\u4e2a\u4e00\u4e2a\u6765\u5206\u6790\u3002Initproc\u7684\u6267\u884c\u4e3b\u4f53\u662finit_main\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u5728\u7f3a\u7701\u60c5\u51b5\u4e0b\u662f\u6267\u884c\u5b8fKERNEL_EXECVE(hello)\uff0c\u800c\u8fd9\u4e2a\u5b8f\u6700\u7ec8\u662f\u8c03\u7528kernel_execve\u51fd\u6570\u6765\u8c03\u7528SYS_exec\u7cfb\u7edf\u8c03\u7528\uff0c\u7531\u4e8eld\u5728\u94fe\u63a5hello\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u65f6\u5b9a\u4e49\u4e86\u4e24\u5168\u5c40\u53d8\u91cf\uff1a _binary_obj___user_hello_out_start\uff1ahello\u6267\u884c\u7801\u7684\u8d77\u59cb\u4f4d\u7f6e _binary_obj___user_hello_out_size\u4e2d\uff1ahello\u6267\u884c\u7801\u7684\u5927\u5c0f kernel_execve\u628a\u8fd9\u4e24\u4e2a\u53d8\u91cf\u4f5c\u4e3aSYS_exec\u7cfb\u7edf\u8c03\u7528\u7684\u53c2\u6570\uff0c\u8ba9ucore\u6765\u521b\u5efa\u6b64\u7528\u6237\u8fdb\u7a0b\u3002\u5f53ucore\u6536\u5230\u6b64\u7cfb\u7edf\u8c03\u7528\u540e\uff0c\u5c06\u4f9d\u6b21\u8c03\u7528\u5982\u4e0b\u51fd\u6570: vector128 ( vectors . S ) -- \\ > \\ _ \\ _alltraps ( trapentry . S ) -- \\ > trap ( trap . c ) -- \\ > trap \\ _dispatch ( trap . c ) -- -- \\ > syscall ( syscall . c ) -- \\ > sys \\ _exec \uff08 syscall . c \uff09 -- \\ > do \\ _execve ( proc . c ) \u6700\u7ec8\u901a\u8fc7do_execve\u51fd\u6570\u6765\u5b8c\u6210\u7528\u6237\u8fdb\u7a0b\u7684\u521b\u5efa\u5de5\u4f5c\u3002\u6b64\u51fd\u6570\u7684\u4e3b\u8981\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\uff1a \u9996\u5148\u4e3a\u52a0\u8f7d\u65b0\u7684\u6267\u884c\u7801\u505a\u597d\u7528\u6237\u6001\u5185\u5b58\u7a7a\u95f4\u6e05\u7a7a\u51c6\u5907 \u3002\u5982\u679cmm\u4e0d\u4e3aNULL\uff0c\u5219\u8bbe\u7f6e\u9875\u8868\u4e3a\u5185\u6838\u7a7a\u95f4\u9875\u8868\uff0c\u4e14\u8fdb\u4e00\u6b65\u5224\u65admm\u7684\u5f15\u7528\u8ba1\u6570\u51cf1\u540e\u662f\u5426\u4e3a0\uff0c\u5982\u679c\u4e3a0\uff0c\u5219\u8868\u660e\u6ca1\u6709\u8fdb\u7a0b\u518d\u9700\u8981\u6b64\u8fdb\u7a0b\u6240\u5360\u7528\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u4e3a\u6b64\u5c06\u6839\u636emm\u4e2d\u7684\u8bb0\u5f55\uff0c\u91ca\u653e\u8fdb\u7a0b\u6240\u5360\u7528\u6237\u7a7a\u95f4\u5185\u5b58\u548c\u8fdb\u7a0b\u9875\u8868\u672c\u8eab\u6240\u5360\u7a7a\u95f4\u3002\u6700\u540e\u628a\u5f53\u524d\u8fdb\u7a0b\u7684mm\u5185\u5b58\u7ba1\u7406\u6307\u9488\u4e3a\u7a7a\u3002\u7531\u4e8e\u6b64\u5904\u7684initproc\u662f\u5185\u6838\u7ebf\u7a0b\uff0c\u6240\u4ee5mm\u4e3aNULL\uff0c\u6574\u4e2a\u5904\u7406\u90fd\u4e0d\u4f1a\u505a\u3002 \u63a5\u4e0b\u6765\u7684\u4e00\u6b65\u662f\u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u5230\u5f53\u524d\u8fdb\u7a0b\u7684\u65b0\u521b\u5efa\u7684\u7528\u6237\u6001\u865a\u62df\u7a7a\u95f4\u4e2d\u3002\u8fd9\u91cc\u6d89\u53ca\u5230\u8bfbELF\u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u7533\u8bf7\u5185\u5b58\u7a7a\u95f4\uff0c\u5efa\u7acb\u7528\u6237\u6001\u865a\u5b58\u7a7a\u95f4\uff0c\u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u7b49\u3002load_icode\u51fd\u6570\u5b8c\u6210\u4e86\u6574\u4e2a\u590d\u6742\u7684\u5de5\u4f5c\u3002 load_icode\u51fd\u6570\u7684\u4e3b\u8981\u5de5\u4f5c\u5c31\u662f\u7ed9\u7528\u6237\u8fdb\u7a0b\u5efa\u7acb\u4e00\u4e2a\u80fd\u591f\u8ba9\u7528\u6237\u8fdb\u7a0b\u6b63\u5e38\u8fd0\u884c\u7684\u7528\u6237\u73af\u5883\u3002\u6b64\u51fd\u6570\u6709\u4e00\u767e\u591a\u884c\uff0c\u5b8c\u6210\u4e86\u5982\u4e0b\u91cd\u8981\u5de5\u4f5c\uff1a \u8c03\u7528mm_create\u51fd\u6570\u6765\u7533\u8bf7\u8fdb\u7a0b\u7684\u5185\u5b58\u7ba1\u7406\u6570\u636e\u7ed3\u6784mm\u6240\u9700\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u5bf9mm\u8fdb\u884c\u521d\u59cb\u5316\uff1b mm\u662f\u4e00\u4e2amm_struct\u7ed3\u6784\u7684\u53d8\u91cf\uff0c\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u8868\u793a\u4e86\u5305\u542b\u6240\u6709\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u5171\u540c\u5c5e\u6027(\u5b9a\u4e49\u4f4d\u4e8ekern/mm/vmm.h)\uff0c\u5177\u4f53\u5b9a\u4e49\u5982\u4e0b\uff1a // the control struct for a set of vma using the same PDT struct mm_struct { list_entry_t mmap_list ; // linear list link which sorted by start addr of vma struct vma_struct * mmap_cache ; // current accessed vma, used for speed purpose pde_t * pgdir ; // the PDT of these vma int map_count ; // the count of these vma atomic_t mm_count ; semaphore_t mm_sem ; int locked_by ; }; mmap_list\u662f\u53cc\u5411\u94fe\u8868\u5934\uff0c\u94fe\u63a5\u4e86\u6240\u6709\u5c5e\u4e8e\u540c\u4e00\u9875\u76ee\u5f55\u8868\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u3002 mmap_cache\u662f\u6307\u5411\u5f53\u524d\u6b63\u5728\u4f7f\u7528\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u7531\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u6267\u884c\u7684\u201c\u5c40\u90e8\u6027\u201d\u539f\u7406\uff0c\u5f53\u524d\u6b63\u5728\u7528\u5230\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u5728\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u4e2d\u53ef\u80fd\u8fd8\u4f1a\u7528\u5230\uff0c\u8fd9\u65f6\u5c31\u4e0d\u9700\u8981\u67e5\u94fe\u8868\uff0c\u800c\u662f\u76f4\u63a5\u4f7f\u7528\u6b64\u6307\u9488\u5c31\u53ef\u627e\u5230\u4e0b\u4e00\u6b21\u8981\u7528\u5230\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u3002\u7531\u4e8emmap_cache \u7684\u5f15\u5165\uff0c\u53ef\u4f7f\u5f97 mm_struct \u6570\u636e\u7ed3\u6784\u7684\u67e5\u8be2\u52a0\u901f 30% \u4ee5\u4e0a\u3002 pgdir \u6240\u6307\u5411\u7684\u5c31\u662fmm_struct\u6570\u636e\u7ed3\u6784\u6240\u7ef4\u62a4\u7684\u9875\u8868\u3002\u901a\u8fc7\u8bbf\u95eepgdir\u53ef\u4ee5\u67e5\u627e\u67d0\u865a\u62df\u5730\u5740\u5bf9\u5e94\u7684\u9875\u8868\u9879\u662f\u5426\u5b58\u5728\u4ee5\u53ca\u9875\u8868\u9879\u7684\u5c5e\u6027\u7b49 \u3002 map_count\u8bb0\u5f55mmap_list \u91cc\u9762\u94fe\u63a5\u7684 vma_struct\u7684\u4e2a\u6570\u3002 \u6d89\u53camm_struct\u7684\u64cd\u4f5c\u51fd\u6570\u6bd4\u8f83\u7b80\u5355\uff0c\u53ea\u6709mm_create\u548cmm_destroy\u4e24\u4e2a\u51fd\u6570\uff0c\u4ece\u5b57\u9762\u610f\u601d\u5c31\u53ef\u4ee5\u770b\u51fa\u662f\u662f\u5b8c\u6210mm_struct\u7ed3\u6784\u7684\u53d8\u91cf\u521b\u5efa\u548c\u5220\u9664\u3002 \u8c03\u7528setup_pgdir\u6765\u7533\u8bf7\u4e00\u4e2a\u9875\u76ee\u5f55\u8868\u6240\u9700\u7684\u4e00\u4e2a\u9875\u5927\u5c0f\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u628a\u63cf\u8ff0ucore\u5185\u6838\u865a\u7a7a\u95f4\u6620\u5c04\u7684\u5185\u6838\u9875\u8868\uff08boot_pgdir\u6240\u6307\uff09\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u6b64\u65b0\u76ee\u5f55\u8868\u4e2d\uff0c\u6700\u540e\u8ba9mm->pgdir\u6307\u5411\u6b64\u9875\u76ee\u5f55\u8868\uff0c\u8fd9\u5c31\u662f\u8fdb\u7a0b\u65b0\u7684\u9875\u76ee\u5f55\u8868\u4e86\uff0c\u4e14\u80fd\u591f\u6b63\u786e\u6620\u5c04\u5185\u6838\u865a\u7a7a\u95f4\uff1b setup_pgdir\u51fd\u6570\u7684\u5b9a\u4e49\u5982\u4e0b(kern/process/proc.c)\uff1a // setup_pgdir - alloc one page as PDT static int setup_pgdir ( struct mm_struct * mm ) { struct Page * page ; if (( page = alloc_page ()) == NULL ) { //\u7533\u8bf7\u4e00\u9875\u7684\u5185\u5b58\u7a7a\u95f4 return - E_NO_MEM ; } pde_t * pgdir = page2kva ( page ); memcpy ( pgdir , boot_pgdir , PGSIZE ); //\u5c06\u63cf\u8ff0ucore\u5185\u6838\u865a\u7a7a\u95f4\u6620\u5c04\u7684\u5185\u6838\u9875\u8868\uff08boot_pgdir\u6240\u6307\uff09\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u6b64\u65b0\u76ee\u5f55\u8868\u4e2d //panic(\"unimpl\"); //pgdir[PDX(VPT)] = PADDR(pgdir) | PTE_P | PTE_W; mm -> pgdir = pgdir ; //\u5c06mm->pgdir\u6307\u5411\u6b64\u9875\u76ee\u5f55\u8868\uff0c\u4f7f\u8fdb\u7a0b\u7684\u9875\u76ee\u5f55\u8868\u80fd\u6b63\u786e\u7684\u6620\u5c04\u5185\u6838\u865a\u7a7a\u95f4 return 0 ; } \u6839\u636e\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u7684\u8d77\u59cb\u4f4d\u7f6e\u6765\u89e3\u6790\u6b64ELF\u683c\u5f0f\u7684\u6267\u884c\u7a0b\u5e8f\uff0c\u5e76\u8c03\u7528mm_map\u51fd\u6570\u6839\u636eELF\u683c\u5f0f\u7684\u6267\u884c\u7a0b\u5e8f\u8bf4\u660e\u7684\u5404\u4e2a\u6bb5\uff08\u4ee3\u7801\u6bb5\u3001\u6570\u636e\u6bb5\u3001BSS\u6bb5\u7b49\uff09\u7684\u8d77\u59cb\u4f4d\u7f6e\u548c\u5927\u5c0f\u5efa\u7acb\u5bf9\u5e94\u7684vma\u7ed3\u6784\uff0c\u5e76\u628avma\u63d2\u5165\u5230mm\u7ed3\u6784\u4e2d\uff0c\u4ece\u800c\u8868\u660e\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u5408\u6cd5\u7528\u6237\u6001\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff1b mm_map ( mm , ph -> p_va , ph -> p_memsz , vm_flags , NULL ) \u5728ucore\u4e2d\u63cf\u8ff0\u5e94\u7528\u7a0b\u5e8f\u5bf9\u865a\u62df\u5185\u5b58\u201c\u9700\u6c42\u201d\u7684\u6570\u636e\u7ed3\u6784\u662fvma_struct\uff08\u5b9a\u4e49\u5728vmm.h\u4e2d\uff09\uff0c\u4ee5\u53ca\u9488\u5bf9vma_struct\u7684\u51fd\u6570\u64cd\u4f5c\u3002\u8fd9\u91cc\u628a\u4e00\u4e2avma_struct\u7ed3\u6784\u7684\u53d8\u91cf\u7b80\u79f0\u4e3avma\u53d8\u91cf\u3002vma_struct\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a struct vma_struct { // the set of vma using the same PDT struct mm_struct * vm_mm ; uintptr_t vm_start ; // start addr of vma uintptr_t vm_end ; // end addr of vma uint32_t vm_flags ; // flags of vma //linear list link which sorted by start addr of vma list_entry_t list_link ; }; vm_start\u548cvm_end\u63cf\u8ff0\u4e86\u4e00\u4e2a\u8fde\u7eed\u5730\u5740\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u8d77\u59cb\u4f4d\u7f6e\u548c\u7ed3\u675f\u4f4d\u7f6e\uff0c\u8fd9\u4e24\u4e2a\u503c\u90fd\u5e94\u8be5\u662fPGSIZE \u5bf9\u9f50\u7684\uff0c\u800c\u4e14\u63cf\u8ff0\u7684\u662f\u4e00\u4e2a\u5408\u7406\u7684\u5730\u5740\u7a7a\u95f4\u8303\u56f4\uff08\u5373\u4e25\u683c\u786e\u4fdd vm_start < vm_end\u7684\u5173\u7cfb\uff09\uff1blist_link\u662f\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\uff0c\u6309\u7167\u4ece\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u628a\u4e00\u7cfb\u5217\u7528vma_struct\u8868\u793a\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u94fe\u63a5\u8d77\u6765\uff0c\u5e76\u4e14\u8fd8\u8981\u6c42\u8fd9\u4e9b\u94fe\u8d77\u6765\u7684vma_struct\u5e94\u8be5\u662f\u4e0d\u76f8\u4ea4\u7684\uff0c\u5373vma\u4e4b\u95f4\u7684\u5730\u5740\u7a7a\u95f4\u65e0\u4ea4\u96c6\uff1bvm_flags\u8868\u793a\u4e86\u8fd9\u4e2a\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u5c5e\u6027\uff0c\u76ee\u524d\u7684\u5c5e\u6027\u5305\u62ec\uff1a #define VM_READ 0x00000001 //\u53ea\u8bfb #define VM_WRITE 0x00000002 //\u53ef\u8bfb\u5199 #define VM_EXEC 0x00000004 //\u53ef\u6267\u884c \u8c03\u7528\u6839\u636e\u6267\u884c\u7a0b\u5e8f\u5404\u4e2a\u6bb5\u7684\u5927\u5c0f\u5206\u914d\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u6839\u636e\u6267\u884c\u7a0b\u5e8f\u5404\u4e2a\u6bb5\u7684\u8d77\u59cb\u4f4d\u7f6e\u786e\u5b9a\u865a\u62df\u5730\u5740\uff0c\u5e76\u5728\u9875\u8868\u4e2d\u5efa\u7acb\u597d\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u7136\u540e\u628a\u6267\u884c\u7a0b\u5e8f\u5404\u4e2a\u6bb5\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u76f8\u5e94\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u4e2d\uff0c\u81f3\u6b64\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u548c\u6570\u636e\u5df2\u7ecf\u6839\u636e\u7f16\u8bd1\u65f6\u8bbe\u5b9a\u5730\u5740\u653e\u7f6e\u5230\u865a\u62df\u5185\u5b58\u4e2d\u4e86\uff1b \u9700\u8981\u7ed9\u7528\u6237\u8fdb\u7a0b\u8bbe\u7f6e\u7528\u6237\u6808\uff0c\u4e3a\u6b64\u8c03\u7528mm_mmap\u51fd\u6570\u5efa\u7acb\u7528\u6237\u6808\u7684vma\u7ed3\u6784\uff0c\u660e\u786e\u7528\u6237\u6808\u7684\u4f4d\u7f6e\u5728\u7528\u6237\u865a\u7a7a\u95f4\u7684\u9876\u7aef\uff0c\u5927\u5c0f\u4e3a256\u4e2a\u9875\uff0c\u53731MB\uff0c\u5e76\u5206\u914d\u4e00\u5b9a\u6570\u91cf\u7684\u7269\u7406\u5185\u5b58\u4e14\u5efa\u7acb\u597d\u6808\u7684\u865a\u5730\u5740\u2194\u7269\u7406\u5730\u5740\u6620\u5c04\u5173\u7cfb\uff1b \u81f3\u6b64,\u8fdb\u7a0b\u5185\u7684\u5185\u5b58\u7ba1\u7406vma\u548cmm\u6570\u636e\u7ed3\u6784\u5df2\u7ecf\u5efa\u7acb\u5b8c\u6210\uff0c\u4e8e\u662f\u628amm->pgdir\u8d4b\u503c\u5230\u53d8\u91cfcurrent_pgdir\u4e2d\uff0c\u5373\u66f4\u65b0\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u6b64\u65f6\u7684initproc\u5df2\u7ecf\u88abhello\u7684\u4ee3\u7801\u548c\u6570\u636e\u8986\u76d6\uff0c\u6210\u4e3a\u4e86\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\uff0c\u4f46\u6b64\u65f6\u8fd9\u4e2a\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u73b0\u573a\u8fd8\u6ca1\u5efa\u7acb\u597d\uff1b \u5148\u6e05\u7a7a\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\uff0c\u518d\u91cd\u65b0\u8bbe\u7f6e\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\uff0c\u4f7f\u5f97\u5728\u6267\u884c\u4e2d\u65ad\u8fd4\u56de\u6307\u4ee4\u540e\uff0c\u80fd\u591f\u8ba9CPU\u8f6c\u5230\u7528\u6237\u6001\u7279\u6743\u7ea7\uff0c\u5e76\u56de\u5230\u7528\u6237\u6001\u5185\u5b58\u7a7a\u95f4\uff0c\u4e14\u80fd\u591f\u8df3\u8f6c\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u6267\u884c\uff0c\u5e76\u786e\u4fdd\u5728\u7528\u6237\u6001\u80fd\u591f\u54cd\u5e94\u4e2d\u65ad\uff1b \u8fd9\u4e00\u6b65\u6d89\u53ca\u7ec3\u4e601\u4e2d\u9700\u8981\u8865\u5145\u7684\u4ee3\u7801\u3002\u5982\u4e0b\u6240\u793a\uff1a #ifdef LAB3_EX1 /* LAB3:EXERCISE1 YOUR CODE * should set tf_era,tf_regs.reg_r[LOONGARCH_REG_SP],tf->tf_prmd * NOTICE: If we set trapframe correctly, then the user level process can return to USER MODE from kernel and enable interrupt. So * tf->tf_prmd should be PLV_USER | CSR_CRMD_IE * tf->tf_era should be the entry point of this binary program (elf->e_entry) * tf->tf_regs.reg_r[LOONGARCH_REG_SP] should be the top addr of user stack (USTACKTOP) */ // \u6839\u636e\u63d0\u793a\u8865\u5145\u4ee3\u7801\uff0c\u5b8c\u6210\u7ec3\u4e60\u3002 #endif \u6211\u4eec\u9700\u8981\u8865\u5145\u7684\u4ee3\u7801\u5c31\u662f\u8bbe\u7f6etf_era, tf_regs.regr[LOONGARCH_REG_SP],tf->tf_prmd\u8fd9\u4e09\u4e2a\u53d8\u91cf\u7684\u5185\u5bb9\u3002\u5982\u679c\u6211\u4eec\u6b63\u786e\u5730\u8bbe\u7f6e\u4e86\u4e2d\u65ad\u5e27\u7684\u5185\u5bb9\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u4ee5\u7531\u5185\u6838\u6001\u8f6c\u4e3a\u7528\u6237\u6001\u8fd0\u884c\uff0c\u4e14\u91cd\u65b0\u5f00\u542f\u4e2d\u65ad\u54cd\u5e94\u3002\u4e2d\u65ad\u5e27trapframe\u7684\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b(kern/trap/loongarch_trapframe.h)\uff1a struct trapframe { uint32_t tf_badv ; // CSR[0x7] uint32_t tf_estat ; // CSR[0x5] uint32_t tf_prmd ; // CSR[0x1] uint32_t tf_ra ; struct pushregs tf_regs ; uint32_t tf_era ; // CSR[0x6] same as epc on LOONGARCH }; tf_regs: \u5f53\u8fdb\u7a0b\u4ece\u5185\u6838\u6001\u8f6c\u4e3a\u7528\u6237\u6001\u65f6\uff0c\u8981\u628a\u5806\u6808\u5bc4\u5b58\u5668\u7684\u6808\u6307\u9488($sp)\u6539\u4e3a\u7528\u6237\u6808\u7684\u5730\u5740\uff0c \u5373tf_regs[LOONGARCH_REG_SP]\u5e94\u8bbe\u7f6e\u4e3aUSTACKTOP \u3002 tf_era: \u8868\u793a\u7684\u662f\u4f8b\u5916\u8fd4\u56de\u5730\u5740\uff08\u89e6\u53d1\u4f8b\u5916\u6307\u4ee4\u7684PC\uff09\uff0c\u4e3a\u4e86\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u8df3\u8f6c\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u6267\u884c\uff0c\u7ec3\u4e601\u4e2d\u7684tf_era\u5e94\u8bbe\u7f6e\u4e3aELF\u6267\u884c\u6587\u4ef6\u8bbe\u5b9a\u7684\u8d77\u59cb\u5730\u5740\uff0c \u5373tf_era\u5e94\u8bbe\u7f6e\u4e3aelf->e_entry \u3002 tf_prmd: CSR[0x1]\u6307\u7684\u662f\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668\u4f8b\u5916\u524d\u6a21\u5f0f\u4fe1\u606f(PRMD)\u7684\u5185\u5bb9(\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u4e2dp53)\uff0c\u82e5\u64cd\u4f5c\u7cfb\u7edf\u8981\u4ece\u5185\u6838\u6001\u5207\u6362\u81f3\u7528\u6237\u6001\uff0c\u4e14\u5f00\u542f\u4e2d\u65ad\u54cd\u5e94\uff0c tf_prmd\u5e94\u8bbe\u7f6e\u4e3aPLV_USER | CSR_CRMD_IE \u3002 \u81f3\u6b64\uff0c\u7528\u6237\u8fdb\u7a0b\u7684\u7528\u6237\u73af\u5883\u5df2\u7ecf\u642d\u5efa\u5b8c\u6bd5\u3002\u6b64\u65f6initproc\u5c06\u6309\u4ea7\u751f\u7cfb\u7edf\u8c03\u7528\u7684\u51fd\u6570\u8c03\u7528\u8def\u5f84\u539f\u8def\u8fd4\u56de\uff0c\u6267\u884c\u4e2d\u65ad\u8fd4\u56de\u6307\u4ee4\u201certn\u201d\uff08\u4f4d\u4e8eexception.S\u7684\u6700\u540e\u4e00\u53e5\uff09\u540e\uff0c\u5c06\u5207\u6362\u5230\u7528\u6237\u8fdb\u7a0bhello\u7684\u7b2c\u4e00\u6761\u8bed\u53e5\u4f4d\u7f6e_start\u5904\uff08\u4f4d\u4e8euser/libs/initcode.S\u7684\u7b2c\u4e09\u53e5\uff09\u5f00\u59cb\u6267\u884c\u3002 \u8fdb\u7a0b\u9000\u51fa\u548c\u7b49\u5f85\u8fdb\u7a0b \u00b6 \u5f53\u8fdb\u7a0b\u6267\u884c\u5b8c\u5b83\u7684\u5de5\u4f5c\u540e\uff0c\u5c31\u9700\u8981\u6267\u884c\u9000\u51fa\u64cd\u4f5c\uff0c\u91ca\u653e\u8fdb\u7a0b\u5360\u7528\u7684\u8d44\u6e90\u3002ucore\u5206\u4e86\u4e24\u6b65\u6765\u5b8c\u6210\u8fd9\u4e2a\u5de5\u4f5c\uff0c\u9996\u5148\u7531\u8fdb\u7a0b\u672c\u8eab\u5b8c\u6210\u5927\u90e8\u5206\u8d44\u6e90\u7684\u5360\u7528\u5185\u5b58\u56de\u6536\u5de5\u4f5c\uff0c\u7136\u540e\u7531\u6b64\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u5b8c\u6210\u5269\u4f59\u8d44\u6e90\u5360\u7528\u5185\u5b58\u7684\u56de\u6536\u5de5\u4f5c\u3002 Note \u4e3a\u4f55\u4e0d\u8ba9\u8fdb\u7a0b\u672c\u8eab\u5b8c\u6210\u6240\u6709\u7684\u8d44\u6e90\u56de\u6536\u5de5\u4f5c\u5462\uff1f \u8fd9\u662f\u56e0\u4e3a\u8fdb\u7a0b\u8981\u6267\u884c\u56de\u6536\u64cd\u4f5c\uff0c\u5c31\u8868\u660e\u6b64\u8fdb\u7a0b\u8fd8\u5b58\u5728\uff0c\u8fd8\u5728\u6267\u884c\u6307\u4ee4\uff0c\u8fd9\u5c31\u9700\u8981\u4fdd\u8bc1\u5185\u6838\u6808\u7684\u7a7a\u95f4\u548c\u8868\u793a\u8fdb\u7a0b\u5b58\u5728\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u4e0d\u88ab\u91ca\u653e\uff0c\u6240\u4ee5\u9700\u8981\u7236\u8fdb\u7a0b\u6765\u5e2e\u5fd9\u91ca\u653e\u5b50\u8fdb\u7a0b\u65e0\u6cd5\u5b8c\u6210\u7684\u8fd9\u4e24\u4e2a\u8d44\u6e90\u7684\u56de\u6536\u5de5\u4f5c\u3002 \u4e3a\u5b9e\u73b0\u8fdb\u7a0b\u9000\u51fa\uff0c\u7528\u6237\u6001\u7684\u51fd\u6570\u5e93\u4e2d\u63d0\u4f9b\u4e86exit\u51fd\u6570\uff0c\u6b64\u51fd\u6570\u6700\u7ec8\u8bbf\u95eesys_exit\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u6765\u5e2e\u52a9\u5f53\u524d\u8fdb\u7a0b\u6267\u884c\u9000\u51fa\u8fc7\u7a0b\u4e2d\u7684\u90e8\u5206\u8d44\u6e90\u56de\u6536\u3002\u6211\u4eec\u6765\u770b\u770bucore\u662f\u5982\u4f55\u505a\u8fdb\u7a0b\u9000\u51fa\u5de5\u4f5c\u7684\u3002 ucore\u662f\u5982\u4f55\u505a\u8fdb\u7a0b\u9000\u51fa\u5de5\u4f5c\u7684 \u00b6 \u9996\u5148\uff0cexit\u51fd\u6570\u4f1a\u628a\u4e00\u4e2a\u9000\u51fa\u7801error_code\u4f20\u9012\u7ed9ucore\uff0cucore\u901a\u8fc7\u6267\u884c\u5185\u6838\u51fd\u6570do_exit\u6765\u5b8c\u6210\u5bf9\u5f53\u524d\u8fdb\u7a0b\u7684\u9000\u51fa\u5904\u7406\uff0c\u4e3b\u8981\u5de5\u4f5c\u5c31\u662f\u56de\u6536\u5f53\u524d\u8fdb\u7a0b\u6240\u5360\u7684\u5927\u90e8\u5206\u5185\u5b58\u8d44\u6e90\uff0c\u5e76\u901a\u77e5\u7236\u8fdb\u7a0b\u5b8c\u6210\u6700\u540e\u7684\u56de\u6536\u5de5\u4f5c\u3002\u5177\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a 1. \u5982\u679ccurrent->mm != NULL\uff0c\u8868\u793a\u662f\u7528\u6237\u8fdb\u7a0b\uff0c\u5219\u5f00\u59cb\u56de\u6536\u6b64\u7528\u6237\u8fdb\u7a0b\u6240\u5360\u7528\u7684\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff1b a) \u9996\u5148\u6267\u884c\u201clcr3(boot_cr3)\u201d\uff0c\u5207\u6362\u5230\u5185\u6838\u6001\u7684\u9875\u8868\u4e0a\uff0c\u8fd9\u6837\u5f53\u524d\u7528\u6237\u8fdb\u7a0b\u76ee\u524d\u53ea\u80fd\u5728\u5185\u6838\u865a\u62df\u5730\u5740\u7a7a\u95f4\u6267\u884c\u4e86\uff0c\u8fd9\u662f\u4e3a\u4e86\u786e\u4fdd\u540e\u7eed\u91ca\u653e\u7528\u6237\u6001\u5185\u5b58\u548c\u8fdb\u7a0b\u9875\u8868\u7684\u5de5\u4f5c\u80fd\u591f\u6b63\u5e38\u6267\u884c\uff1b b) \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u6210\u5458\u53d8\u91cfmm\u7684\u6210\u5458\u53d8\u91cfmm_count\u51cf1\u540e\u4e3a0\uff08\u8868\u660e\u8fd9\u4e2amm\u6ca1\u6709\u518d\u88ab\u5176\u4ed6\u8fdb\u7a0b\u5171\u4eab\uff0c\u53ef\u4ee5\u5f7b\u5e95\u91ca\u653e\u8fdb\u7a0b\u6240\u5360\u7684\u7528\u6237\u865a\u62df\u7a7a\u95f4\u4e86\u3002\uff09\uff0c\u5219\u5f00\u59cb\u56de\u6536\u7528\u6237\u8fdb\u7a0b\u6240\u5360\u7684\u5185\u5b58\u8d44\u6e90\uff1a i. \u8c03\u7528exit_mmap\u51fd\u6570\u91ca\u653ecurrent->mm->vma\u94fe\u8868\u4e2d\u6bcf\u4e2avma\u63cf\u8ff0\u7684\u8fdb\u7a0b\u5408\u6cd5\u7a7a\u95f4\u4e2d\u5b9e\u9645\u5206\u914d\u7684\u5185\u5b58\uff0c\u7136\u540e\u628a\u5bf9\u5e94\u7684\u9875\u8868\u9879\u5185\u5bb9\u6e05\u7a7a\uff0c\u6700\u540e\u8fd8\u628a\u9875\u8868\u6240\u5360\u7528\u7684\u7a7a\u95f4\u91ca\u653e\u5e76\u628a\u5bf9\u5e94\u7684\u9875\u76ee\u5f55\u8868\u9879\u6e05\u7a7a\uff1b ii. \u8c03\u7528put_pgdir\u51fd\u6570\u91ca\u653e\u5f53\u524d\u8fdb\u7a0b\u7684\u9875\u76ee\u5f55\u6240\u5360\u7684\u5185\u5b58\uff1b iii. \u8c03\u7528mm_destroy\u51fd\u6570\u91ca\u653emm\u4e2d\u7684vma\u6240\u5360\u5185\u5b58\uff0c\u6700\u540e\u91ca\u653emm\u6240\u5360\u5185\u5b58\uff1b c) \u6b64\u65f6\u8bbe\u7f6ecurrent->mm\u4e3aNULL\uff0c\u8868\u793a\u4e0e\u5f53\u524d\u8fdb\u7a0b\u76f8\u5173\u7684\u7528\u6237\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u548c\u5bf9\u5e94\u7684\u5185\u5b58\u7ba1\u7406\u6210\u5458\u53d8\u91cf\u6240\u5360\u7684\u5185\u6838\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u5df2\u7ecf\u56de\u6536\u5b8c\u6bd5\uff1b 2. \u8fd9\u65f6\uff0c\u8bbe\u7f6e\u5f53\u524d\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001current->state=PROC_ZOMBIE\uff0c\u5f53\u524d\u8fdb\u7a0b\u7684\u9000\u51fa\u7801current->exit_code=error_code\u3002\u6b64\u65f6\u5f53\u524d\u8fdb\u7a0b\u5df2\u7ecf\u4e0d\u80fd\u88ab\u8c03\u5ea6\u4e86\uff0c\u9700\u8981\u6b64\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u6765\u505a\u6700\u540e\u7684\u56de\u6536\u5de5\u4f5c\uff08\u5373\u56de\u6536\u63cf\u8ff0\u6b64\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u8fdb\u7a0b\u63a7\u5236\u5757\uff09\uff1b 3. \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0bcurrent->parent\u5904\u4e8e\u7b49\u5f85\u5b50\u8fdb\u7a0b\u72b6\u6001\uff1a current->parent->wait_state==WT_CHILD\uff0c \u5219\u5524\u9192\u7236\u8fdb\u7a0b\uff08\u5373\u6267\u884c\u201cwakup_proc(current->parent)\u201d\uff09\uff0c\u8ba9\u7236\u8fdb\u7a0b\u5e2e\u52a9\u81ea\u5df1\u5b8c\u6210\u6700\u540e\u7684\u8d44\u6e90\u56de\u6536\uff1b 4. \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u8fd8\u6709\u5b50\u8fdb\u7a0b\uff0c\u5219\u9700\u8981\u628a\u8fd9\u4e9b\u5b50\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u6307\u9488\u8bbe\u7f6e\u4e3a\u5185\u6838\u7ebf\u7a0binitproc\uff0c\u4e14\u5404\u4e2a\u5b50\u8fdb\u7a0b\u6307\u9488\u9700\u8981\u63d2\u5165\u5230initproc\u7684\u5b50\u8fdb\u7a0b\u94fe\u8868\u4e2d\u3002\u5982\u679c\u67d0\u4e2a\u5b50\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u662fPROC_ZOMBIE\uff0c\u5219\u9700\u8981\u5524\u9192initproc\u6765\u5b8c\u6210\u5bf9\u6b64\u5b50\u8fdb\u7a0b\u7684\u6700\u540e\u56de\u6536\u5de5\u4f5c\u3002 5. \u6267\u884cschedule()\u51fd\u6570\uff0c\u9009\u62e9\u65b0\u7684\u8fdb\u7a0b\u6267\u884c\u3002 \u7236\u8fdb\u7a0b\u5982\u4f55\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b\u7684\u6700\u540e\u56de\u6536\u5de5\u4f5c \u00b6 \u8fd9\u8981\u6c42\u7236\u8fdb\u7a0b\u8981\u6267\u884cwait\u7528\u6237\u51fd\u6570\u6216wait_pid\u7528\u6237\u51fd\u6570\uff0c\u8fd9\u4e24\u4e2a\u51fd\u6570\u7684\u533a\u522b\u662f\uff0cwait\u51fd\u6570\u7b49\u5f85\u4efb\u610f\u5b50\u8fdb\u7a0b\u7684\u7ed3\u675f\u901a\u77e5\uff0c\u800cwait_pid\u51fd\u6570\u7b49\u5f85\u8fdb\u7a0bid\u53f7\u4e3apid\u7684\u5b50\u8fdb\u7a0b\u7ed3\u675f\u901a\u77e5\u3002\u8fd9\u4e24\u4e2a\u51fd\u6570\u6700\u7ec8\u8bbf\u95eesys_wait\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u8ba9ucore\u6765\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b\u7684\u6700\u540e\u56de\u6536\u5de5\u4f5c\uff0c\u5373\u56de\u6536\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u8fdb\u7a0b\u63a7\u5236\u5757\u6240\u5360\u5185\u5b58\u7a7a\u95f4\uff0c\u5177\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a 1. \u5982\u679cpid!=0\uff0c\u8868\u793a\u53ea\u627e\u4e00\u4e2a\u8fdb\u7a0bid\u53f7\u4e3apid\u7684\u9000\u51fa\u72b6\u6001\u7684\u5b50\u8fdb\u7a0b\uff0c\u5426\u5219\u627e\u4efb\u610f\u4e00\u4e2a\u5904\u4e8e\u9000\u51fa\u72b6\u6001\u7684\u5b50\u8fdb\u7a0b\uff1b 2. \u5982\u679c\u6b64\u5b50\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u4e0d\u4e3aPROC_ZOMBIE\uff0c\u8868\u660e\u6b64\u5b50\u8fdb\u7a0b\u8fd8\u6ca1\u6709\u9000\u51fa\uff0c\u5219\u5f53\u524d\u8fdb\u7a0b\uff08\u5373\u5b50\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\uff09\u53ea\u597d\u8bbe\u7f6e\u81ea\u5df1\u7684\u6267\u884c\u72b6\u6001\u4e3aPROC_SLEEPING\uff0c\u7761\u7720\u539f\u56e0\u4e3aWT_CHILD\uff08\u5373\u7b49\u5f85\u5b50\u8fdb\u7a0b\u9000\u51fa\uff09\uff0c\u8c03\u7528schedule()\u51fd\u6570\u9009\u62e9\u65b0\u7684\u8fdb\u7a0b\u6267\u884c\uff0c\u81ea\u5df1\u7761\u7720\u7b49\u5f85\uff0c\u5982\u679c\u88ab\u5524\u9192\uff0c\u5219\u91cd\u590d\u8df3\u56de\u6b65\u9aa41\u5904\u6267\u884c\uff1b 3. \u5982\u679c\u6b64\u5b50\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u4e3aPROC_ZOMBIE\uff0c\u8868\u660e\u6b64\u5b50\u8fdb\u7a0b\u5904\u4e8e\u9000\u51fa\u72b6\u6001\uff0c\u9700\u8981\u5f53\u524d\u8fdb\u7a0b\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b\u7684\u6700\u7ec8\u56de\u6536\u5de5\u4f5c\uff0c\u5373\u9996\u5148\u628a\u5b50\u8fdb\u7a0b\u63a7\u5236\u5757\u4ece\u4e24\u4e2a\u8fdb\u7a0b\u961f\u5217proc_list\u548chash_list\u4e2d\u5220\u9664\uff0c\u5e76\u91ca\u653e\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u5806\u6808\u548c\u8fdb\u7a0b\u63a7\u5236\u5757\u3002\u81ea\u6b64\uff0c\u5b50\u8fdb\u7a0b\u624d\u5f7b\u5e95\u5730\u7ed3\u675f\u4e86\u5b83\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u6d88\u9664\u4e86\u5b83\u6240\u5360\u7528\u7684\u6240\u6709\u8d44\u6e90\u3002 \u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0 \u00b6 \u7cfb\u7edf\u8c03\u7528\u7684\u82f1\u6587\u540d\u5b57\u662fSystem Call\u3002\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u4ec0\u4e48\u9700\u8981\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u5462\uff1f\u5176\u5b9e\u8fd9\u662f\u5b9e\u73b0\u4e86\u7528\u6237\u8fdb\u7a0b\u540e\uff0c\u81ea\u7136\u5f15\u7533\u51fa\u6765\u9700\u8981\u5b9e\u73b0\u7684\u64cd\u4f5c\u7cfb\u7edf\u529f\u80fd\u3002\u7528\u6237\u8fdb\u7a0b\u53ea\u80fd\u5728\u64cd\u4f5c\u7cfb\u7edf\u7ed9\u5b83\u5708\u5b9a\u597d\u7684\u201c\u7528\u6237\u73af\u5883\u201d\u4e2d\u6267\u884c\uff0c\u4f46\u201c\u7528\u6237\u73af\u5883\u201d\u9650\u5236\u4e86\u7528\u6237\u8fdb\u7a0b\u80fd\u591f\u6267\u884c\u7684\u6307\u4ee4\uff0c\u5373\u7528\u6237\u8fdb\u7a0b\u53ea\u80fd\u6267\u884c\u4e00\u822c\u7684\u6307\u4ee4\uff0c\u65e0\u6cd5\u6267\u884c\u7279\u6743\u6307\u4ee4\u3002\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u60f3\u6267\u884c\u4e00\u4e9b\u9700\u8981\u7279\u6743\u6307\u4ee4\u7684\u4efb\u52a1\uff0c\u6bd4\u5982\u901a\u8fc7\u7f51\u5361\u53d1\u7f51\u7edc\u5305\u7b49\uff0c\u53ea\u80fd\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u6765\u4ee3\u52b3\u4e86\u3002\u4e8e\u662f\u5c31\u9700\u8981\u4e00\u79cd\u673a\u5236\u6765\u786e\u4fdd\u7528\u6237\u8fdb\u7a0b\u4e0d\u80fd\u6267\u884c\u7279\u6743\u6307\u4ee4\uff0c\u4f46\u80fd\u591f\u8bf7\u64cd\u4f5c\u7cfb\u7edf\u201c\u5e2e\u5fd9\u201d\u5b8c\u6210\u9700\u8981\u7279\u6743\u6307\u4ee4\u7684\u4efb\u52a1\uff0c\u8fd9\u79cd\u673a\u5236\u5c31\u662f\u7cfb\u7edf\u8c03\u7528\u3002 \u91c7\u7528\u7cfb\u7edf\u8c03\u7528\u673a\u5236\u4e3a\u7528\u6237\u8fdb\u7a0b\u63d0\u4f9b\u4e00\u4e2a\u83b7\u5f97\u64cd\u4f5c\u7cfb\u7edf\u670d\u52a1\u7684\u7edf\u4e00\u63a5\u53e3\u5c42\uff0c\u8fd9\u6837\u4e00\u6765\u53ef\u7b80\u5316\u7528\u6237\u8fdb\u7a0b\u7684\u5b9e\u73b0\uff0c\u628a\u4e00\u4e9b\u5171\u6027\u7684\u3001\u7e41\u7410\u7684\u3001\u4e0e\u786c\u4ef6\u76f8\u5173\u3001\u4e0e\u7279\u6743\u6307\u4ee4\u76f8\u5173\u7684\u4efb\u52a1\u653e\u5230\u64cd\u4f5c\u7cfb\u7edf\u5c42\u6765\u5b9e\u73b0\uff0c\u4f46\u63d0\u4f9b\u4e00\u4e2a\u7b80\u6d01\u7684\u63a5\u53e3\u7ed9\u7528\u6237\u8fdb\u7a0b\u8c03\u7528\uff1b\u4e8c\u6765\u8fd9\u5c42\u63a5\u53e3\u4e8b\u5148\u53ef\u89c4\u5b9a\u597d\uff0c\u4e14\u4e25\u683c\u68c0\u67e5\u7528\u6237\u8fdb\u7a0b\u4f20\u9012\u8fdb\u6765\u7684\u53c2\u6570\u548c\u64cd\u4f5c\u7cfb\u7edf\u8981\u8fd4\u56de\u7684\u6570\u636e\uff0c\u4f7f\u5f97\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u7ed9\u7528\u6237\u8fdb\u7a0b\u670d\u52a1\u7684\u540c\u65f6\uff0c\u4fdd\u62a4\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u4f1a\u88ab\u7528\u6237\u8fdb\u7a0b\u7834\u574f\u3002 \u4ece\u786c\u4ef6\u5c42\u9762\u4e0a\u770b\uff0c\u9700\u8981\u786c\u4ef6\u80fd\u591f\u652f\u6301\u5728\u7528\u6237\u6001\u7684\u7528\u6237\u8fdb\u7a0b\u901a\u8fc7\u67d0\u79cd\u673a\u5236\u5207\u6362\u5230\u5185\u6838\u6001\u3002lab1\u8bb2\u8ff0\u4e2d\u65ad\u786c\u4ef6\u652f\u6301\u548c\u8f6f\u4ef6\u5904\u7406\u8fc7\u7a0b\u5176\u5b9e\u5c31\u53ef\u4ee5\u7528\u6765\u5b8c\u6210\u7cfb\u7edf\u8c03\u7528\u6240\u9700\u7684\u8f6f\u786c\u4ef6\u652f\u6301\u3002\u4e0b\u9762\u6211\u4eec\u6765\u770b\u770b\u5982\u4f55\u5728ucore\u4e2d\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u3002 1. \u5efa\u7acb\u7cfb\u7edf\u8c03\u7528\u7684\u7528\u6237\u5e93\u51c6\u5907 \u00b6 \u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u521d\u59cb\u5316\u597d\u7cfb\u7edf\u8c03\u7528\u76f8\u5173\u7684\u4e2d\u65ad\u63cf\u8ff0\u7b26\u3001\u4e2d\u65ad\u5904\u7406\u8d77\u59cb\u5730\u5740\u7b49\u540e\uff0c\u8fd8\u9700\u5728\u7528\u6237\u6001\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u521d\u59cb\u5316\u597d\u76f8\u5173\u5de5\u4f5c\uff0c\u7b80\u5316\u5e94\u7528\u7a0b\u5e8f\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u7684\u590d\u6742\u6027\u3002\u4e3a\u6b64\u5728\u7528\u6237\u6001\u5efa\u7acb\u4e86\u4e00\u4e2a\u4e2d\u95f4\u5c42\uff0c\u5373\u7b80\u5316\u7684libc\u5b9e\u73b0\uff0c\u5728user/libs/ulib.[ch]\u548cuser/libs/syscall.[ch]\u4e2d\u5b8c\u6210\u4e86\u5bf9\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u7684\u5c01\u88c5\u3002\u7528\u6237\u6001\u6700\u7ec8\u7684\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u662fsyscall\uff0c\u5b9e\u73b0\u5982\u4e0b\uff1a static inline int syscall(int num, ...) { va_list ap; va_start(ap, num); uint32_t arg[MAX_ARGS]; int i, ret; for (i = 0; i < MAX_ARGS; i ++) { arg[i] = va_arg(ap, uint32_t); } va_end(ap); num += SYSCALL_BASE; asm volatile( \"move $a7, %1;\\n\" /* syscall no. */ \"move $a0, %2;\\n\" \"move $a1, %3;\\n\" \"move $a2, %4;\\n\" \"move $a3, %5;\\n\" \"syscall 0;\\n\" \"move %0, $a7;\\n\" : \"=r\"(ret) : \"r\"(num), \"r\"(arg[0]), \"r\"(arg[1]), \"r\"(arg[2]), \"r\"(arg[3]) : \"a0\", \"a1\", \"a2\", \"a3\", \"a7\" ); return ret; } 2. \u4e0e\u7528\u6237\u8fdb\u7a0b\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528 \u00b6 \u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u4e0e\u8fdb\u7a0b\u76f8\u5173\u7684\u5404\u4e2a\u7cfb\u7edf\u8c03\u7528\u5c5e\u6027\u5982\u4e0b\u8868\u6240\u793a\uff0c\u901a\u8fc7\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\uff0c\u53ef\u65b9\u4fbf\u5730\u5b8c\u6210\u4ece\u8fdb\u7a0b/\u7ebf\u7a0b\u521b\u5efa\u5230\u9000\u51fa\u7684\u6574\u4e2a\u8fd0\u884c\u8fc7\u7a0b\u3002 \u7cfb\u7edf\u8c03\u7528\u540d \u542b\u4e49 \u5177\u4f53\u5b8c\u6210\u670d\u52a1\u7684\u51fd\u6570 SYS_exit process exit do_exit SYS_fork create child process, dup mm do_fork\u2192wakeup_proc SYS_wait wait child process do_wait SYS_exec after fork, process execute a new program load a program and refresh the mm SYS_yield process flag itself need resecheduling proc->need_sched=1, then scheduler will rescheule this process SYS_kill kill process do_kill\u2192proc->flags |= PF_EXITING, \u2192wakeup_proc\u2192do_wait\u2192do_exit SYS_getpid get the process's pid 3. \u7cfb\u7edf\u8c03\u7528\u7684\u6267\u884c\u8fc7\u7a0b \u00b6 \u4e0e\u7528\u6237\u6001\u7684\u51fd\u6570\u5e93\u8c03\u7528\u6267\u884c\u8fc7\u7a0b\u76f8\u6bd4\uff0c\u7cfb\u7edf\u8c03\u7528\u6267\u884c\u8fc7\u7a0b\u7684\u6709\u56db\u70b9\u4e3b\u8981\u7684\u4e0d\u540c\uff1a \u901a\u8fc7\u201csyscall\u201d\u6307\u4ee4\u53d1\u8d77\u8c03\u7528\uff1b \u901a\u8fc7\u201certn\u201d\u6307\u4ee4\u5b8c\u6210\u8c03\u7528\u8fd4\u56de\uff1b \u5f53\u5230\u8fbe\u5185\u6838\u6001\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u4e25\u683c\u68c0\u67e5\u7cfb\u7edf\u8c03\u7528\u4f20\u9012\u7684\u53c2\u6570\uff0c\u786e\u4fdd\u4e0d\u7834\u574f\u6574\u4e2a\u7cfb\u7edf\u7684\u5b89\u5168\u6027\uff1b \u6267\u884c\u7cfb\u7edf\u8c03\u7528\u53ef\u5bfc\u81f4\u8fdb\u7a0b\u7b49\u5f85\u67d0\u4e8b\u4ef6\u53d1\u751f\uff0c\u4ece\u800c\u53ef\u5f15\u8d77\u8fdb\u7a0b\u5207\u6362\uff1b \u4e0b\u9762\u6211\u4eec\u4ee5getpid\u7cfb\u7edf\u8c03\u7528\u7684\u6267\u884c\u8fc7\u7a0b\u5927\u81f4\u770b\u770b\u64cd\u4f5c\u7cfb\u7edf\u662f\u5982\u4f55\u5b8c\u6210\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u7684\u3002\u5f53\u7528\u6237\u8fdb\u7a0b\u8c03\u7528getpid\u51fd\u6570\uff0c\u6700\u7ec8\u6267\u884c\u5230\u201csyscall\u201d\u6307\u4ee4\u540e\uff0cCPU\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u5efa\u7acb\u7684\u7cfb\u7edf\u8c03\u7528\u4e2d\u65ad\u63cf\u8ff0\u7b26\uff0c\u8f6c\u5165\u5185\u6838\u6001\uff0c\u5e76\u8df3\u8f6c\u5230exception13\u5904\uff08kern/trap/exception.S\uff09\uff0c\u5f00\u59cb\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u7cfb\u7edf\u8c03\u7528\u6267\u884c\u8fc7\u7a0b\uff0c\u51fd\u6570\u8c03\u7528\u548c\u8fd4\u56de\u64cd\u4f5c\u7684\u5173\u7cfb\u5982\u4e0b\u6240\u793a\uff1a exception13(exception.S)--> _\\loongarch_trap(trap.c)-->trap_dispatch(trap.c)-- -->syscall(syscall.c)-->sys_getpid(syscall.c)-->\u2026\u2026-->_\\exception_return(exception.S) \u5728\u6267\u884ctrap\u51fd\u6570\u524d\uff0c\u8f6f\u4ef6\u8fd8\u9700\u8fdb\u4e00\u6b65\u4fdd\u5b58\u6267\u884c\u7cfb\u7edf\u8c03\u7528\u524d\u7684\u6267\u884c\u73b0\u573a\uff0c\u628a\u4e0e\u7528\u6237\u8fdb\u7a0b\u7ee7\u7eed\u6267\u884c\u6240\u9700\u7684\u76f8\u5173\u5bc4\u5b58\u5668\u7b49\u5f53\u524d\u5185\u5bb9\u4fdd\u5b58\u5230\u5f53\u524d\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27trapframe\u4e2d\uff08\u6ce8\u610f\uff0c\u5728\u521b\u5efa\u8fdb\u7a0b\u65f6\uff0c\u628a\u8fdb\u7a0b\u7684trapframe\u653e\u5728\u8fdb\u7a0b\u5185\u6838\u6808\u5206\u914d\u7a7a\u95f4\u7684\u9876\u90e8\uff09\u3002\u8f6f\u4ef6\u505a\u7684\u5de5\u4f5c\u5728exception.S\u7684exception_handler\u51fd\u6570\u90e8\u5206\uff1a exception_handler: // Save t0 and t1 csrwr t0, LISA_CSR_KS0 csrwr t1, LISA_CSR_KS1 // Save previous stack pointer in t1 move t1, sp csrwr t1, LISA_CSR_KS2 //t1 saved the vaual of KS2,KS2 saved sp /* Warning: csrwr will bring the old csr register value into rd, not only just write rd to csr register, so you may see the rd changed. It's documented in the manual from loongarch. */ // check if user mode csrrd t0, LISA_CSR_PRMD andi t0, t0, 3 beq t0, zero, 1f /* Coming from user mode - load kernel stack into sp */ la t0, current // current pointer ld.w t0, t0, 0 // proc struct ld.w t0, t0, 12 // kstack pointer addi.w t1, zero, 1 slli.w t1, t1, 13 // KSTACKSIZE=8192=pow(2,13) add.w sp, t0, t1 csrrd t1, LISA_CSR_KS2 1: //saved EXST to t0 for save EXST to sp later(line 114) csrrd t0, LISA_CSR_EXST //return KS2 csrrd t1, LISA_CSR_KS2 b common_exception common_exception: /* * At this point: * Interrupts are off. (The processor did this for us.) * t0 contains the exception status(like exception cause on MIPS). * t1 contains the old stack pointer. * sp points into the kernel stack. * All other registers are untouched. */ /* * Allocate stack space for 35 words to hold the trap frame, * plus four more words for a minimal argument block. */ addi.w sp, sp, -156 st.w s8, sp, 148 st.w s7, sp, 144 st.w s6, sp, 140 st.w s5, sp, 136 st.w s4, sp, 132 st.w s3, sp, 128 st.w s2, sp, 124 st.w s1, sp, 120 st.w s0, sp, 116 st.w fp, sp, 112 st.w reserved_reg, sp, 108 st.w t8, sp, 104 st.w t7, sp, 100 st.w t6, sp, 96 st.w t5, sp, 92 st.w t4, sp, 88 st.w t3, sp, 84 st.w t2, sp, 80 //st.w t1, sp, 76 //st.w t0, sp, 72 st.w a7, sp, 68 st.w a6, sp, 64 st.w a5, sp, 60 st.w a4, sp, 56 st.w a3, sp, 52 st.w a2, sp, 48 st.w a1, sp, 44 st.w a0, sp, 40 st.w t1, sp, 36 // replace sp with real sp, now use t1 for free st.w tp, sp, 32 // save real t0 and t1 after real sp (stored in t1 previously) stored csrrd t1, LISA_CSR_KS1 st.w t1, sp, 76 csrrd t1, LISA_CSR_KS0 st.w t1, sp, 72 // replace with real value // save tf_era after t0 and t1 saved csrrd t1, LISA_CSR_EPC st.w t1, sp, 152 /* * Save remaining exception context information. */ // save ra (note: not in pushregs, it's tf_ra) st.w ra, sp, 28 // save prmd csrrd t1, LISA_CSR_PRMD st.w t1, sp, 24 // save estat st.w t0, sp, 20 // now use t0 for free // store badv csrrd t0, LISA_CSR_BADV st.w t0, sp, 16 st.w zero, sp, 12 // support nested interrupt // IE and PLV will automatically set to 0 when trap occur // set trapframe as function argument addi.w a0, sp, 16 li t0, 0xb0 # PLV=0, IE=0, PG=1 csrwr t0, LISA_CSR_CRMD la.abs t0, loongarch_trap jirl ra, t0, 0 //bl loongarch_trap \u2026\u2026 \u81ea\u6b64\uff0c\u7528\u4e8e\u4fdd\u5b58\u7528\u6237\u6001\u7684\u7528\u6237\u8fdb\u7a0b\u6267\u884c\u73b0\u573a\u7684trapframe\u7684\u5185\u5bb9\u586b\u5199\u5b8c\u6bd5\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u5f00\u59cb\u5b8c\u6210\u5177\u4f53\u7684\u7cfb\u7edf\u8c03\u7528\u670d\u52a1\u3002 \u5728sys_getpid\u51fd\u6570\u4e2d\uff0c\u7b80\u5355\u5730\u628a\u5f53\u524d\u8fdb\u7a0b\u7684pid\u6210\u5458\u53d8\u91cf\u505a\u4e3a\u51fd\u6570\u8fd4\u56de\u503c\u5c31\u662f\u4e00\u4e2a\u5177\u4f53\u7684\u7cfb\u7edf\u8c03\u7528\u670d\u52a1\u3002\u5b8c\u6210\u670d\u52a1\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u6309\u8c03\u7528\u5173\u7cfb\u7684\u8def\u5f84\u539f\u8def\u8fd4\u56de\u5230__exception.S\u4e2d\u3002\u7136\u540e\u64cd\u4f5c\u7cfb\u7edf\u5f00\u59cb\u6839\u636e\u5f53\u524d\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\u5185\u5bb9\u505a\u6062\u590d\u6267\u884c\u73b0\u573a\u64cd\u4f5c\u3002\u5176\u5b9e\u5c31\u662f\u628atrapframe\u7684\u4e00\u90e8\u5206\u5185\u5bb9\u4fdd\u5b58\u5230\u5bc4\u5b58\u5668\u5185\u5bb9\u3002\u8fd9\u65f6\u5185\u6838\u6808\u7684\u7ed3\u6784\u5982\u4e0b\uff1a exception_return: // restore prmd ld.w t0, sp, 24 li t1, 7 csrxchg t0, t1, LISA_CSR_PRMD // restore era no k0 and k1 for la32, so must do first ld.w t0, sp, 152 csrwr t0, LISA_CSR_EPC // restore general registers ld.w ra, sp, 28 ld.w tp, sp, 32 //ld.w sp, sp, 36 (do it finally) ld.w a0, sp, 40 ld.w a1, sp, 44 ld.w a2, sp, 48 ld.w a3, sp, 52 ld.w a4, sp, 56 ld.w a5, sp, 60 ld.w a6, sp, 64 ld.w a7, sp, 68 ld.w t0, sp, 72 ld.w t1, sp, 76 ld.w t2, sp, 80 ld.w t3, sp, 84 ld.w t4, sp, 88 ld.w t5, sp, 92 ld.w t6, sp, 96 ld.w t7, sp, 100 ld.w t8, sp, 104 ld.w reserved_reg, sp, 108 ld.w fp, sp, 112 ld.w s0, sp, 116 ld.w s1, sp, 120 ld.w s2, sp, 124 ld.w s3, sp, 128 ld.w s4, sp, 132 ld.w s5, sp, 136 ld.w s6, sp, 140 ld.w s7, sp, 144 ld.w s8, sp, 148 // restore sp ld.w sp, sp, 36 ertn .end exception_return .end common_exception \u8fd9\u65f6\u6267\u884c\u201certn\u201d\u6307\u4ee4\u540e\uff0cCPU\u6839\u636e\u5185\u6838\u6808\u7684\u60c5\u51b5\u6062\u590d\u5230\u7528\u6237\u6001\uff0c\u5373\u201csyscall\u201d\u540e\u7684\u90a3\u6761\u6307\u4ee4\u3002\u8fd9\u6837\u6574\u4e2a\u7cfb\u7edf\u8c03\u7528\u5c31\u6267\u884c\u5b8c\u6bd5\u4e86\u3002 \u81f3\u6b64\uff0c\u5b9e\u9a8c\u4e09\u4e2d\u7684\u4e3b\u8981\u5de5\u4f5c\u63cf\u8ff0\u5b8c\u6bd5\u3002 \u9644\u5f55 A\uff1a\u7528\u6237\u8fdb\u7a0b\u7684\u7279\u5f81 \u00b6 \u4ece\u5185\u6838\u7ebf\u7a0b\u5230\u7528\u6237\u8fdb\u7a0b \u00b6 \u5bf9\u4e8e\u5185\u6838\u7ebf\u7a0b\u6765\u8bf4\uff0c\u5b83\u4eec\u4e0d\u9700\u8981\u5728\u7528\u6237\u6001\u6267\u884c\u7528\u6237\u8fdb\u7a0b\u7684\u7ba1\u7406\u673a\u5236\uff0c\u65e2\u65e0\u6cd5\u4f53\u73b0\u7528\u6237\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u4ee5\u53ca\u7528\u6237\u8fdb\u7a0b\u95f4\u5730\u5740\u7a7a\u95f4\u9694\u79bb\u7684\u4fdd\u62a4\u673a\u5236\uff0c\u4e0d\u652f\u6301\u8fdb\u7a0b\u6267\u884c\u8fc7\u7a0b\u7684\u7528\u6237\u6001\u548c\u6838\u5fc3\u6001\u4e4b\u95f4\u7684\u5207\u6362\uff0c\u4e14\u6ca1\u6709\u7528\u6237\u8fdb\u7a0b\u7684\u5b8c\u6574\u72b6\u6001\u53d8\u5316\u7684\u751f\u547d\u5468\u671f\u3002 \u5185\u6838\u7ebf\u7a0b\u7684\u7ba1\u7406 \u5b9e\u73b0\u76f8\u5bf9\u662f\u7b80\u5355\u7684\uff0c\u5176\u7279\u70b9\u662f\u76f4\u63a5\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\uff08\u6bd4\u5982ucore\uff09\u5728\u521d\u59cb\u5316\u4e2d\u5efa\u7acb\u7684\u5185\u6838\u865a\u62df\u5185\u5b58\u5730\u5740\u7a7a\u95f4\uff0c\u4e0d\u540c\u7684\u5185\u6838\u7ebf\u7a0b\u4e4b\u95f4\u53ef\u4ee5\u901a\u8fc7\u8c03\u5ea6\u5668\u5b9e\u73b0\u7ebf\u7a0b\u95f4\u7684\u5207\u6362\uff0c\u8fbe\u5230\u5206\u65f6\u4f7f\u7528CPU\u7684\u76ee\u7684\u3002\u7531\u4e8e\u5185\u6838\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u662f\u4e00\u4e00\u6620\u5c04\u8ba1\u7b97\u673a\u7cfb\u7edf\u7684\u7269\u7406\u7a7a\u95f4\u7684\uff0c\u8fd9\u4f7f\u5f97\u53ef\u7528\u7a7a\u95f4\u7684\u5927\u5c0f\u4e0d\u4f1a\u8d85\u8fc7\u7269\u7406\u7a7a\u95f4\u5927\u5c0f\uff0c\u6240\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u7a0b\u5e8f\u5458\u7f16\u5199\u5185\u6838\u7ebf\u7a0b\u65f6\uff0c\u9700\u8981\u8003\u8651\u5230\u6709\u9650\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u9700\u8981\u4fdd\u8bc1\u5404\u4e2a\u5185\u6838\u7ebf\u7a0b\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u7834\u574f\u64cd\u4f5c\u7cfb\u7edf\u7684\u6b63\u5e38\u8fd0\u884c\u3002\u8fd9\u6837\u5728\u5b9e\u73b0\u5185\u6838\u7ebf\u7a0b\u7ba1\u7406\u65f6\uff0c\u4e0d\u5fc5\u8003\u8651\u6d89\u53ca\u4e0e\u8fdb\u7a0b\u76f8\u5173\u7684\u865a\u62df\u5185\u5b58\u7ba1\u7406\u4e2d\u7684\u7f3a\u9875\u5904\u7406\u3001\u6309\u9700\u5206\u9875\u3001\u5199\u65f6\u590d\u5236\u3001\u9875\u6362\u5165\u6362\u51fa\u7b49\u529f\u80fd\u3002\u5982\u679c\u5728\u5185\u6838\u7ebf\u7a0b\u6267\u884c\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e86\u8bbf\u5b58\u9519\u8bef\u5f02\u5e38\u6216\u5185\u5b58\u4e0d\u591f\u7684\u60c5\u51b5\uff0c\u5c31\u8ba4\u4e3a\u64cd\u4f5c\u7cfb\u7edf\u51fa\u73b0\u9519\u8bef\u4e86\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c06\u76f4\u63a5\u5b95\u673a\u3002\u5728ucore\u4e2d\uff0c\u5c31\u662f\u8c03\u7528panic\u51fd\u6570\uff0c\u8fdb\u5165\u5185\u6838\u8c03\u8bd5\u76d1\u63a7\u5668kernel_debug_monitor\u3002 \u5185\u6838\u7ebf\u7a0b\u7ba1\u7406\u601d\u60f3\u76f8\u5bf9\u7b80\u5355\uff0c\u4f46 \u7f16\u5199\u5185\u6838\u7ebf\u7a0b\u5bf9\u7a0b\u5e8f\u5458\u7684\u8981\u6c42\u5f88\u9ad8 \u3002\u4ece\u7406\u8bba\u4e0a\u8bb2\uff08\u7406\u60f3\u60c5\u51b5\uff09\uff0c\u5982\u679c\u7a0b\u5e8f\u5458\u90fd\u662f\u80fd\u591f\u7f16\u5199\u64cd\u4f5c\u7cfb\u7edf\u7ea7\u522b\u7684\u201c\u9ad8\u624b\u201d\uff0c\u80fd\u591f\u52e4\u4fed\u548c\u9ad8\u6548\u5730\u4f7f\u7528\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u8d44\u6e90\uff0c\u4e14\u8fd9\u4e9b\u201c\u9ad8\u624b\u201d\u90fd\u4e3a\u4ed6\u4eba\u7740\u60f3\uff0c\u5177\u6709\u5949\u732e\u7cbe\u795e\uff0c\u5728\u522b\u7684\u5e94\u7528\u9700\u8981\u8ba1\u7b97\u673a\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u80fd\u591f\u4ece\u5927\u5c40\u51fa\u53d1\uff0c\u4ece\u6574\u4e2a\u7cfb\u7edf\u7684\u6267\u884c\u6548\u7387\u51fa\u53d1\uff0c\u8ba9\u51fa\u81ea\u5df1\u5360\u7528\u7684\u8d44\u6e90\uff0c\u90a3\u8fd9\u4e9b\u201c\u9ad8\u624b\u201d\u7f16\u5199\u51fa\u6765\u7684\u7a0b\u5e8f\u76f4\u63a5\u4f5c\u4e3a\u5185\u6838\u7ebf\u7a0b\u8fd0\u884c\u5373\u53ef\uff0c\u4e5f\u5c31\u6ca1\u6709\u7528\u6237\u8fdb\u7a0b\u5b58\u5728\u7684\u5fc5\u8981\u4e86\u3002 \u4f46\u73b0\u5b9e\u4e0e\u7406\u8bba\u7684\u5dee\u8ddd\u662f\u5de8\u5927\u7684\uff0c\u80fd\u7f16\u5199\u64cd\u4f5c\u7cfb\u7edf\u7684\u7a0b\u5e8f\u5458\u662f\u6781\u5c11\u6570\u7684\uff0c\u4e0e\u5f53\u524d\u7684\u5e94\u7528\u7a0b\u5e8f\u5458\u76f8\u6bd4\uff0c\u4f30\u8ba1\u5927\u7ea6\u5dee\u4e863~4\u4e2a\u6570\u91cf\u7ea7\u3002\u5982\u679c\u8fd8\u8981\u6c42\u7f16\u5199\u64cd\u4f5c\u7cfb\u7edf\u7684\u7a0b\u5e8f\u5458\u8003\u8651\u5176\u4ed6\u672a\u77e5\u7a0b\u5e8f\u5458\u7684\u672a\u77e5\u9700\u6c42\uff0c\u90a3\u8fd9\u6837\u7684\u7a0b\u5e8f\u5458\u4f30\u8ba1\u53ef\u4ee5\u6210\u4e3a\u662f\u7f16\u7a0b\u754c\u7684\u201c\u4e0a\u5e1d\u201d\u4e86\u3002 \u4ece\u5e94\u7528\u7a0b\u5e8f\u7f16\u5199\u548c\u8fd0\u884c\u7684\u89d2\u5ea6\u770b\uff0c\u65e2\u7136\u7a0b\u5e8f\u5458\u90fd\u4e0d\u662f\u201c\u4e0a\u5e1d\u201d\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7a0b\u5e8f\u5458\u5c31\u9700\u8981\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5458\u7f16\u5199\u7684\u7a0b\u5e8f\u63d0\u4f9b\u4e00\u4e2a\u65e2\u201c\u5bbd\u677e\u201d\u53c8\u201c\u4e25\u683c\u201d\u7684\u6267\u884c\u73af\u5883\uff0c\u8ba9\u5bf9\u5185\u5b58\u5927\u5c0f\u548cCPU\u4f7f\u7528\u65f6\u95f4\u7b49\u8d44\u6e90\u7684\u9650\u5236\u6ca1\u6709\u4ed4\u7ec6\u8003\u8651\u7684\u5e94\u7528\u7a0b\u5e8f\u90fd\u80fd\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u6b63\u5e38\u8fd0\u884c\uff0c\u4e14\u5373\u4f7f\u7a0b\u5e8f\u592a\u53ef\u9760\uff0c\u4e5f\u53ea\u80fd\u7834\u574f\u81ea\u5df1\uff0c\u800c\u4e0d\u80fd\u7834\u574f\u5176\u4ed6\u8fd0\u884c\u7a0b\u5e8f\u548c\u6574\u4e2a\u7cfb\u7edf\u3002 \u4e25\u683c \u5c31\u662f\u5b89\u5168\u6027\u4fdd\u8bc1\uff0c\u5373\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u4e0d\u4f1a\u7834\u574f\u5728\u5185\u5b58\u4e2d\u5b58\u5728\u7684\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u548c\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u5b58\u7a7a\u95f4\u7b49\u72ec\u5360\u7684\u8d44\u6e90\uff1b \u5bbd\u677e \u5c31\u7b97\u662f\u65b9\u4fbf\u6027\u652f\u6301\uff0c\u5373\u63d0\u4f9b\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5c3d\u91cf\u4e30\u5bcc\u7684\u670d\u52a1\u529f\u80fd\u548c\u4e00\u4e2a\u8fdc\u5927\u4e8e\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5e94\u7528\u7a0b\u5e8f\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0d\u5fc5\u8003\u8651\u5f88\u591a\u7e41\u7410\u7684\u7ec6\u8282\uff08\u6bd4\u5982\u5982\u4f55\u521d\u59cb\u5316PCI\u603b\u7ebf\u548c\u5916\u8bbe\u7b49\uff0c\u5982\u4f55\u7ba1\u7406\u7269\u7406\u5185\u5b58\u7b49\uff09\u3002 \u8ba9\u7528\u6237\u8fdb\u7a0b\u6b63\u5e38\u8fd0\u884c\u7684\u7528\u6237\u73af\u5883 \u00b6 \u5728\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u7684\u4ecb\u7ecd\u4e2d\uff0c\u4e00\u822c\u63d0\u5230\u8fdb\u7a0b\u7684\u6982\u5ff5\u5176\u5b9e\u4e3b\u8981\u662f\u6307\u7528\u6237\u8fdb\u7a0b\u3002\u4ece\u64cd\u4f5c\u7cfb\u7edf\u7684\u8bbe\u8ba1\u548c\u5b9e\u73b0\u7684\u89d2\u5ea6\u770b\uff0c\u5176\u5b9e\u7528\u6237\u8fdb\u7a0b\u662f\u6307\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5728\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u4e00\u4e2a\u7528\u6237\u73af\u5883\u4e2d\u7684\u4e00\u6b21\u6267\u884c\u8fc7\u7a0b\u3002\u8fd9\u91cc\u7684\u91cd\u70b9\u662f\u7528\u6237\u73af\u5883\u3002 \u7528\u6237\u73af\u5883\u7684\u529f\u80fd \u00b6 \u4ece\u529f\u80fd\u4e0a\u770b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u8fd9\u4e2a\u7528\u6237\u73af\u5883\u6709\u4e24\u65b9\u9762\u7684\u7279\u70b9\u3002 \u4e00\u65b9\u9762\u4e0e \u5b58\u50a8\u7a7a\u95f4 \u76f8\u5173\uff0c\u5373\u9650\u5236\u7528\u6237\u8fdb\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u4e14\u8ba9\u5404\u4e2a\u7528\u6237\u8fdb\u7a0b\u4e4b\u95f4\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u8bbf\u95ee\u4e0d\u91cd\u53e0\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u4e0d\u540c\u7528\u6237\u8fdb\u7a0b\u4e4b\u95f4\u4e0d\u80fd\u76f8\u4e92\u7834\u574f\u5404\u81ea\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5229\u7528\u865a\u62df\u5185\u5b58\u7684\u529f\u80fd\uff08\u9875\u6362\u5165\u6362\u51fa\uff09\uff0c\u7ed9\u7528\u6237\u8fdb\u7a0b\u63d0\u4f9b\u4e86\u8fdc\u5927\u4e8e\u5b9e\u9645\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u3002 \u53e6\u4e00\u65b9\u9762\u4e0e \u6267\u884c\u6307\u4ee4 \u76f8\u5173\uff0c\u5373\u9650\u5236\u7528\u6237\u8fdb\u7a0b\u53ef\u6267\u884c\u7684\u6307\u4ee4\uff0c\u4e0d\u80fd\u8ba9\u7528\u6237\u8fdb\u7a0b\u6267\u884c\u7279\u6743\u6307\u4ee4\uff08\u6bd4\u5982\u4fee\u6539\u9875\u8868\u8d77\u59cb\u5730\u5740\uff09\uff0c\u4ece\u800c\u4fdd\u8bc1\u7528\u6237\u8fdb\u7a0b\u65e0\u6cd5\u7834\u574f\u7cfb\u7edf\u3002\u4f46\u5982\u679c\u4e0d\u80fd\u6267\u884c\u7279\u6743\u6307\u4ee4\uff0c\u5219\u5f88\u591a\u529f\u80fd\uff08\u6bd4\u5982\u8bbf\u95ee\u78c1\u76d8\u7b49\uff09\u65e0\u6cd5\u5b9e\u73b0\uff0c\u6240\u4ee5\u9700\u8981\u63d0\u4f9b\u67d0\u79cd\u673a\u5236\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u9700\u8981\u7279\u6743\u6307\u4ee4\u624d\u80fd\u505a\u7684\u5404\u79cd\u670d\u52a1\u529f\u80fd\uff0c\u7ed9\u7528\u6237\u8fdb\u7a0b\u4e00\u4e2a\u201c\u670d\u52a1\u7a97\u53e3\u201d,\u7528\u6237\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u201c\u7a97\u53e3\u201d\u5411\u64cd\u4f5c\u7cfb\u7edf\u63d0\u51fa\u670d\u52a1\u8bf7\u6c42\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u6765\u5e2e\u52a9\u7528\u6237\u8fdb\u7a0b\u5b8c\u6210\u9700\u8981\u7279\u6743\u6307\u4ee4\u624d\u80fd\u505a\u7684\u5404\u79cd\u670d\u52a1\u3002\u53e6\u5916\uff0c\u8fd8\u8981\u6709\u4e00\u4e2a\u201c\u4e2d\u65ad\u7a97\u53e3\u201d\uff0c\u8ba9\u7528\u6237\u8fdb\u7a0b\u4e0d\u4e3b\u52a8\u653e\u5f03\u4f7f\u7528CPU\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u80fd\u591f\u901a\u8fc7\u8fd9\u4e2a\u201c\u4e2d\u65ad\u7a97\u53e3\u201d\u5f3a\u5236\u8ba9\u7528\u6237\u8fdb\u7a0b\u653e\u5f03\u4f7f\u7528CPU\uff0c\u4ece\u800c\u8ba9\u5176\u4ed6\u7528\u6237\u8fdb\u7a0b\u6709\u673a\u4f1a\u6267\u884c\u3002 \u7528\u6237\u73af\u5883\u7684\u7ec4\u6210\u90e8\u5206 \u00b6 \u57fa\u4e8e\u529f\u80fd\u5206\u6790\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u7528\u6237\u73af\u5883\u5b9a\u4e49\u4e3a\u5982\u4e0b\u7ec4\u6210\u90e8\u5206\uff1a \u5efa\u7acb\u7528\u6237\u865a\u62df\u7a7a\u95f4\u7684\u9875\u8868\u548c\u652f\u6301\u9875\u6362\u5165\u6362\u51fa\u673a\u5236\u7684\u7528\u6237\u5185\u5b58\u8bbf\u5b58\u9519\u8bef\u5f02\u5e38\u670d\u52a1\u4f8b\u7a0b \uff1a\u63d0\u4f9b\u5730\u5740\u9694\u79bb\u548c\u8d85\u8fc7\u7269\u7406\u7a7a\u95f4\u5927\u5c0f\u7684\u865a\u5b58\u7a7a\u95f4\u3002 \u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u7528\u6237\u6001CPU\u7279\u6743\u7ea7 \uff1a\u5728\u7528\u6237\u6001CPU\u7279\u6743\u7ea7\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ea\u80fd\u6267\u884c\u4e00\u822c\u6307\u4ee4\uff0c\u5bf9\u4e8e\u7279\u6743\u6307\u4ee4\uff0c\u7ed3\u679c\u4e0d\u662f\u65e0\u6548\u5c31\u662f\u4ea7\u751f\u201c\u6267\u884c\u975e\u6cd5\u6307\u4ee4\u201d\u5f02\u5e38\uff1b \u7cfb\u7edf\u8c03\u7528\u673a\u5236 \uff1a\u7ed9\u7528\u6237\u8fdb\u7a0b\u63d0\u4f9b\u201c\u670d\u52a1\u7a97\u53e3\u201d\uff1b \u4e2d\u65ad\u54cd\u5e94\u673a\u5236 \uff1a\u7ed9\u7528\u6237\u8fdb\u7a0b\u8bbe\u7f6e\u201c\u4e2d\u65ad\u7a97\u53e3\u201d\uff0c\u8fd9\u6837\u4ea7\u751f\u4e2d\u65ad\u540e\uff0c\u5f53\u524d\u6267\u884c\u7684\u7528\u6237\u8fdb\u7a0b\u5c06\u88ab\u5f3a\u5236\u6253\u65ad\uff0cCPU\u63a7\u5236\u6743\u5c06\u88ab\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e2d\u65ad\u670d\u52a1\u4f8b\u7a0b\u4f7f\u7528\u3002 \u7528\u6237\u6001\u8fdb\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u5206\u6790 \u00b6 \u5728\u7528\u6237\u73af\u5883\u4e0b\u8fd0\u884c\u7684\u8fdb\u7a0b\u5c31\u662f\u7528\u6237\u8fdb\u7a0b\u3002\u90a3\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u7531\u4e8e\u67d0\u79cd\u539f\u56e0\u8fdb\u5165\u5185\u6838\u6001\uff0c\u90a3\u5728\u5185\u6838\u6001\u6267\u884c\u7684\u662f\u4ec0\u4e48\u5462\uff1f\u8fd8\u662f\u7528\u6237\u8fdb\u7a0b\u5417\uff1f \u9996\u5148\u5206\u6790\u4e00\u4e0b\u7528\u6237\u8fdb\u7a0b\u8fd9\u6837\u4f1a\u8fdb\u5165\u5185\u6838\u6001\u5462\uff1f\u56de\u987e\u4e00\u4e0blab1\uff0c\u5c31\u53ef\u4ee5\u77e5\u9053\u5f53\u4ea7\u751f\u5916\u8bbe\u4e2d\u65ad\u3001CPU\u6267\u884c\u5f02\u5e38\uff08\u6bd4\u5982\u8bbf\u5b58\u9519\u8bef\uff09\u3001\u9677\u5165\uff08\u7cfb\u7edf\u8c03\u7528\uff09\uff0c\u7528\u6237\u8fdb\u7a0b\u5c31\u4f1a\u5207\u6362\u5230\u5185\u6838\u4e2d\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u6765\u3002\u8868\u9762\u4e0a\u770b\uff0c\u5230\u5185\u6838\u6001\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53d6\u5f97\u4e86CPU\u63a7\u5236\u6743\uff0c\u6240\u4ee5\u73b0\u5728\u6267\u884c\u7684\u5e94\u8be5\u662f\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\uff0c\u7531\u4e8e\u6b64\u65f6CPU\u5904\u4e8e\u6838\u5fc3\u6001\u7279\u6743\u7ea7\uff0c\u6240\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u7684\u6267\u884c\u8fc7\u7a0b\u5c31\u5c31\u5e94\u8be5\u662f\u5185\u6838\u8fdb\u7a0b\u4e86\u3002\u4f46\u662f\u8fd9\u6837\u7406\u89e3\u5ffd\u7565\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u5177\u4f53\u5b9e\u73b0\u3002\u5982\u679c\u8003\u8651\u64cd\u4f5c\u7cfb\u7edf\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u5e94\u8be5\u5982\u679c\u6765\u7406\u89e3\u8fdb\u7a0b\u5462\uff1f \u4ece \u8fdb\u7a0b\u63a7\u5236\u5757 \u7684\u89d2\u5ea6\u770b\uff0c\u5982\u679c\u6267\u884c\u4e86\u8fdb\u7a0b\u6267\u884c\u73b0\u573a\uff08\u4e0a\u4e0b\u6587\uff09\u7684\u5207\u6362\uff0c\u5c31\u8ba4\u4e3a\u5230\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u6267\u884c\u4e86\uff0c\u53ca\u8fdb\u7a0b\u7684\u5206\u754c\u70b9\u8bbe\u5b9a\u5728\u6267\u884c\u8fdb\u7a0b\u5207\u6362\u7684\u524d\u540e\u3002\u5230\u5e95\u5207\u6362\u4e86\u4ec0\u4e48\u5462\uff1f\u5176\u5b9e\u53ea\u662f\u5207\u6362\u4e86\u8fdb\u7a0b\u7684\u9875\u8868\u548c\u76f8\u5173\u786c\u4ef6\u5bc4\u5b58\u5668\uff0c\u8fd9\u4e9b\u4fe1\u606f\u90fd\u4fdd\u5b58\u5728\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2d\u7684\u76f8\u5173\u57df\u4e2d\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u4e00\u76f4\u5230\u6267\u884c\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u8fdb\u7a0b\u5207\u6362\u5904\u4e3a\u6b62\u90fd\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u8fc7\u7a0b\uff08\u5176\u4e2d\u6709\u64cd\u4f5c\u7cfb\u7edf\u7684\u90e8\u5206\u4ee3\u7801\u6267\u884c\u8fc7\u8fc7\u7a0b\uff09\uff0c\u5373\u8fdb\u7a0b\u3002\u56e0\u4e3a\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6ca1\u6709\u66f4\u6362\u5230\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u8fdb\u7a0b\u7684\u9875\u8868\u548c\u76f8\u5173\u786c\u4ef6\u5bc4\u5b58\u5668\u3002 \u4ece \u6307\u4ee4\u6267\u884c \u7684\u89d2\u5ea6\u770b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e3b\u8981\u529f\u80fd\u662f\u7ed9\u4e0a\u5c42\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\uff0c\u7ba1\u7406\u6574\u4e2a\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u8d44\u6e90\u3002\u6240\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u867d\u7136\u662f\u4e00\u4e2a\u8f6f\u4ef6\uff0c\u4f46\u5176\u5b9e\u662f\u4e00\u4e2a\u57fa\u4e8e\u4e8b\u4ef6\u7684\u8f6f\u4ef6\uff0c\u8fd9\u91cc\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u54cd\u5e94\u7684\u4e8b\u4ef6\u5305\u62ec\u4e09\u7c7b\uff1a\u5916\u8bbe\u4e2d\u65ad\u3001CPU\u6267\u884c\u5f02\u5e38\uff08\u6bd4\u5982\u8bbf\u5b58\u9519\u8bef\uff09\u3001\u9677\u5165\uff08\u7cfb\u7edf\u8c03\u7528\uff09\u3002\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u8981\u6c42\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u670d\u52a1\uff0c\u90a3\u4e48\u4ece\u7528\u6237\u8fdb\u7a0b\u7684\u89d2\u5ea6\u770b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c31\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u8f6f\u4ef6\u5e93\uff08\u6bd4\u5982\u76f8\u5bf9\u4e8e\u7528\u6237\u6001\u7684libc\u5e93\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u770b\u4f5c\u662f\u5185\u6838\u6001\u7684libc\u5e93\uff09\uff0c\u5b8c\u6210\u7528\u6237\u8fdb\u7a0b\u7684\u9700\u6c42\u3002\u4ece\u6267\u884c\u903b\u8f91\u4e0a\u770b\uff0c\u662f\u7528\u6237\u8fdb\u7a0b\u201c\u4e3b\u89c2\u201d\u6267\u884c\u7684\u4e00\u90e8\u5206\uff0c\u5373\u7528\u6237\u8fdb\u7a0b\u201c\u77e5\u9053\u201d\u64cd\u4f5c\u7cfb\u7edf\u8981\u505a\u7684\u4e8b\u60c5\u3002\u90a3\u4e48\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8fdb\u7a0b\u7684\u4ee3\u7801\u7a7a\u95f4\u5305\u62ec\u7528\u6237\u6001\u7684\u6267\u884c\u7a0b\u5e8f\u548c\u5185\u6838\u6001\u54cd\u5e94\u7528\u6237\u8fdb\u7a0b\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u800c\u5728\u6838\u5fc3\u7279\u6743\u6001\u6267\u884c\u670d\u52a1\u8bf7\u6c42\u7684\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\u3002 \u4e3a\u6b64\u8fd9\u79cd\u60c5\u51b5\u4e0b\u7684\u8fdb\u7a0b\u7684\u5185\u5b58\u865a\u62df\u7a7a\u95f4\u4e5f\u5305\u62ec\u4e24\u90e8\u5206\uff1a\u7528\u6237\u6001\u7684\u865a\u5730\u5740\u7a7a\u95f4\u548c\u6838\u5fc3\u6001\u7684\u865a\u5730\u5740\u7a7a\u95f4\u3002\u4f46\u5982\u679c\u6b64\u65f6\u53d1\u751f\u7684\u4e8b\u4ef6\u662f\u5916\u8bbe\u4e2d\u65ad\u548cCPU\u6267\u884c\u5f02\u5e38\uff0c\u867d\u7136CPU\u63a7\u5236\u6743\u4e5f\u8f6c\u5165\u5230\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u4e2d\u65ad\u670d\u52a1\u4f8b\u7a0b\uff0c\u4f46\u8fd9\u4e9b\u5185\u6838\u6267\u884c\u4ee3\u7801\u6267\u884c\u8fc7\u7a0b\u662f\u7528\u6237\u8fdb\u7a0b\u201c\u4e0d\u77e5\u9053\u201d\u7684\uff0c\u662f\u53e6\u5916\u4e00\u6bb5\u6267\u884c\u903b\u8f91\u3002\u90a3\u4e48\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c \u5b9e\u9645\u4e0a\u662f\u6267\u884c\u4e86\u4e24\u6bb5\u76ee\u6807\u4e0d\u540c\u7684\u6267\u884c\u7a0b\u5e8f\uff0c\u4e00\u4e2a\u662f\u4ee3\u8868\u5e94\u7528\u7a0b\u5e8f\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u4e00\u4e2a\u662f\u4ee3\u8868\u4e2d\u65ad\u670d\u52a1\u4f8b\u7a0b\u5904\u7406\u5916\u8bbe\u4e2d\u65ad\u548cCPU\u6267\u884c\u5f02\u5e38\u7684\u5185\u6838\u7ebf\u7a0b \u3002\u8fd9\u4e2a\u7528\u6237\u8fdb\u7a0b\u548c\u5185\u6838\u7ebf\u7a0b\u5728\u4ea7\u751f\u4e2d\u65ad\u6216\u5f02\u5e38\u7684\u65f6\u5019\uff0cCPU\u786c\u4ef6\u5c31\u5b8c\u6210\u4e86\u5b83\u4eec\u4e4b\u95f4\u7684\u6307\u4ee4\u6d41\u5207\u6362\u3002 \u7528\u6237\u8fdb\u7a0b\u7684\u8fd0\u884c\u72b6\u6001\u5206\u6790 \u00b6 \u7528\u6237\u8fdb\u7a0b\u5728\u5176\u6267\u884c\u8fc7\u7a0b\u4e2d\u4f1a\u5b58\u5728\u5f88\u591a\u79cd\u4e0d\u540c\u7684\u6267\u884c\u72b6\u6001\uff0c\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\uff0c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u4e00\u822c\u7684\u8fd0\u884c\u72b6\u6001\u6709\u4e94\u79cd\uff1a\u521b\u5efa\uff08new\uff09\u6001\u3001\u5c31\u7eea\uff08ready\uff09\u6001\u3001\u8fd0\u884c\uff08running\uff09\u6001\u3001\u7b49\u5f85\uff08blocked\uff09\u6001\u3001\u9000\u51fa\uff08exit\uff09\u6001\u3002\u5404\u4e2a\u72b6\u6001\u4e4b\u95f4\u4f1a\u7531\u4e8e\u53d1\u751f\u4e86\u67d0\u4e8b\u4ef6\u800c\u8fdb\u884c\u72b6\u6001\u8f6c\u6362\u3002 \u8fdb\u7a0b\u8fd0\u884c\u72b6\u6001\u5982\u4f55\u8f6c\u53d8 \u00b6 \u9996\u5148\uff0c\u5728 \u521b\u5efa\uff08new\uff09\u6001 \uff0c\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u8fdb\u7a0b\u7684\u521b\u5efa\u5de5\u4f5c\uff0c\u800c\u4f53\u73b0\u8fdb\u7a0b\u5b58\u5728\u7684\u5c31\u662f\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u6240\u4ee5\u4e00\u65e6\u64cd\u4f5c\u7cfb\u7edf\u521b\u5efa\u4e86\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u5219\u53ef\u4ee5\u8ba4\u4e3a\u6b64\u65f6\u8fdb\u7a0b\u5c31\u5df2\u7ecf\u5b58\u5728\u4e86\uff0c\u4f46\u7531\u4e8e\u8fdb\u7a0b\u80fd\u591f\u8fd0\u884c\u7684\u5404\u79cd\u8d44\u6e90\u8fd8\u6ca1\u51c6\u5907\u597d\uff0c\u6240\u4ee5\u6b64\u65f6\u7684\u8fdb\u7a0b\u5904\u4e8e\u521b\u5efa\uff08new\uff09\u6001\u3002 \u521b\u5efa\u4e86\u8fdb\u7a0b\u63a7\u5236\u5757\u540e\uff0c\u8fdb\u7a0b\u5e76\u4e0d\u80fd\u76f4\u63a5\u6267\u884c\uff0c\u8fd8\u9700\u51c6\u5907\u597d\u5404\u79cd\u8d44\u6e90\uff0c\u5982\u679c\u628a\u8fdb\u7a0b\u6267\u884c\u6240\u9700\u8981\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u6267\u884c\u4ee3\u7801\uff0c\u8981\u5904\u7406\u7684\u6570\u636e\u7b49\u90fd\u51c6\u5907\u597d\u4e86\uff0c\u5219\u6b64\u65f6\u8fdb\u7a0b\u5df2\u7ecf\u53ef\u4ee5\u6267\u884c\u4e86\uff0c\u4f46\u8fd8\u6ca1\u6709\u88ab\u64cd\u4f5c\u7cfb\u7edf\u8c03\u5ea6\uff0c\u9700\u8981\u7b49\u5f85\u64cd\u4f5c\u7cfb\u7edf\u9009\u62e9\u8fd9\u4e2a\u8fdb\u7a0b\u6267\u884c\uff0c\u4e8e\u662f\u628a\u8fd9\u4e2a\u505a\u597d\u201c\u6267\u884c\u51c6\u5907\u201d\u7684\u8fdb\u7a0b\u653e\u5165\u5230\u4e00\u4e2a\u961f\u5217\u4e2d\uff0c\u5e76\u53ef\u4ee5\u8ba4\u4e3a\u6b64\u65f6\u8fdb\u7a0b\u5904\u4e8e \u5c31\u7eea\uff08ready\uff09\u6001 \u3002 \u5f53\u64cd\u4f5c\u7cfb\u7edf\u7684\u8c03\u5ea6\u5668\u4ece\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217\u4e2d\u9009\u62e9\u4e86\u4e00\u4e2a\u5c31\u7eea\u8fdb\u7a0b\u540e\uff0c\u901a\u8fc7\u6267\u884c\u8fdb\u7a0b\u5207\u6362\uff0c\u5c31\u8ba9\u8fd9\u4e2a\u88ab\u9009\u4e0a\u7684\u5c31\u7eea\u8fdb\u7a0b\u6267\u884c\u4e86\uff0c\u6b64\u65f6\u8fdb\u7a0b\u5c31\u5904\u4e8e \u8fd0\u884c\uff08running\uff09\u6001 \u4e86\u3002 \u5230\u4e86\u8fd0\u884c\u6001\u540e\uff0c\u4f1a\u51fa\u73b0\u4e09\u79cd\u4e8b\u4ef6\uff1a \u5982\u679c\u8fdb\u7a0b\u9700\u8981\u7b49\u5f85\u67d0\u4e2a\u4e8b\u4ef6\uff08\u6bd4\u5982\u4e3b\u52a8\u7761\u772010\u79d2\u949f\uff0c\u6216\u8fdb\u7a0b\u8bbf\u95ee\u67d0\u4e2a\u5185\u5b58\u7a7a\u95f4\uff0c\u4f46\u6b64\u5185\u5b58\u7a7a\u95f4\u88ab\u6362\u51fa\u5230\u786c\u76d8swap\u5206\u533a\u4e2d\u4e86\uff0c\u8fdb\u7a0b\u4e0d\u5f97\u4e0d\u7b49\u5f85\u64cd\u4f5c\u7cfb\u7edf\u628a\u7f13\u6162\u7684\u786c\u76d8\u4e0a\u7684\u6570\u636e\u91cd\u65b0\u8bfb\u56de\u5230\u5185\u5b58\u4e2d\uff09\uff0c\u90a3\u4e48\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u628aCPU\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\uff0c\u5e76\u628a\u8fdb\u7a0b\u72b6\u6001\u4ece\u8fd0\u884c\uff08running\uff09\u6001\u8f6c\u6362\u4e3a \u7b49\u5f85\uff08blocked\uff09\u6001 \u3002 \u5982\u679c\u7528\u6237\u8fdb\u7a0b\u7684\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u6d41\u7a0b\u6267\u884c\u7ed3\u675f\u4e86\uff0c\u90a3\u4e48\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u628aCPU\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\uff0c\u5e76\u628a\u8fdb\u7a0b\u72b6\u6001\u4ece\u8fd0\u884c\uff08running\uff09\u6001\u8f6c\u6362\u4e3a \u9000\u51fa\uff08exit\uff09\u6001 \uff0c\u5e76\u51c6\u5907\u56de\u6536\u7528\u6237\u8fdb\u7a0b\u5360\u7528\u7684\u5404\u79cd\u8d44\u6e90\uff0c\u5f53\u628a\u8868\u793a\u6574\u4e2a\u8fdb\u7a0b\u5b58\u5728\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u4e5f\u56de\u6536\u4e86\uff0c\u8fd9\u8fdb\u7a0b\u5c31\u4e0d\u5b58\u5728\u4e86\u3002\u5728\u8fd9\u6574\u4e2a\u56de\u6536\u8fc7\u7a0b\u4e2d\uff0c\u8fdb\u7a0b\u90fd\u5904\u4e8e\u9000\u51fa\uff08exit\uff09\u6001\u3002 Info \u8003\u8651\u5230\u5728\u5185\u5b58\u4e2d\u5b58\u5728\u591a\u4e2a\u5904\u4e8e\u5c31\u7eea(ready)\u6001\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u4f46\u53ea\u6709\u4e00\u4e2aCPU\uff0c\u6240\u4ee5\u4e3a\u4e86\u516c\u5e73\u8d77\u89c1\uff0c \u6bcf\u4e2a\u5c31\u7eea\u6001\u8fdb\u7a0b\u90fd\u53ea\u6709\u6709\u9650\u7684\u65f6\u95f4\u7247\u6bb5 \uff0c\u5f53\u4e00\u4e2a\u8fd0\u884c\u6001\u7684\u8fdb\u7a0b\u7528\u5b8c\u4e86\u5b83\u7684\u65f6\u95f4\u7247\u6bb5\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u5265\u593a\u6b64\u8fdb\u7a0b\u7684CPU\u4f7f\u7528\u6743\uff0c\u5e76\u628a\u6b64\u8fdb\u7a0b\u72b6\u6001\u4ece\u8fd0\u884c\uff08running\uff09\u6001\u8f6c\u6362\u4e3a\u5c31\u7eea\uff08ready\uff09\u6001\uff0c\u6700\u540e\u628aCPU\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\u3002 \u5982\u679c\u67d0\u4e2a\u5904\u4e8e\u7b49\u5f85\uff08blocked\uff09\u6001\u7684\u8fdb\u7a0b\u6240\u7b49\u5f85\u7684\u4e8b\u4ef6\u4ea7\u751f\u4e86\uff08\u6bd4\u5982\u7761\u7720\u65f6\u95f4\u5230\uff0c\u6216\u9700\u8981\u8bbf\u95ee\u7684\u6570\u636e\u5df2\u7ecf\u4ece\u786c\u76d8\u6362\u5165\u5230\u5185\u5b58\u4e2d\uff09\uff0c\u5219\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u901a\u8fc7\u628a\u7b49\u5f85\u6b64\u4e8b\u4ef6\u7684\u8fdb\u7a0b\u72b6\u6001\u4ece\u7b49\u5f85\uff08blocked\uff09\u6001\u8f6c\u5230 \u5c31\u7eea\uff08ready\uff09\u6001 \u3002\u8fd9\u6837\u8fdb\u7a0b\u7684\u6574\u4e2a\u72b6\u6001\u8f6c\u6362\u5f62\u6210\u4e86\u4e00\u4e2a\u6709\u9650\u72b6\u6001\u81ea\u52a8\u673a\u3002","title":"\u80cc\u666f\u4ecb\u7ecd"},{"location":"lab3/intro/#_1","text":"\u5230\u73b0\u5728\u4e3a\u6b62\uff0cucore\u8fd8\u4e00\u76f4\u5728\u6838\u5fc3\u6001\u201c\u6253\u8f6c\u201d\uff0c\u6ca1\u6709\u5230\u7528\u6237\u6001\u6267\u884c\u3002\u63d0\u4f9b\u5404\u79cd\u64cd\u4f5c\u7cfb\u7edf\u529f\u80fd\u7684\u5185\u6838\u7ebf\u7a0b\u53ea\u80fd\u5728CPU\u6838\u5fc3\u6001\u8fd0\u884c\u662f\u64cd\u4f5c\u7cfb\u7edf\u81ea\u8eab\u7684\u8981\u6c42\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c31\u8981\u5446\u5728\u6838\u5fc3\u6001\uff0c\u624d\u80fd\u7ba1\u7406\u6574\u4e2a\u8ba1\u7b97\u673a\u7cfb\u7edf\u3002\u4f46\u5e94\u7528\u7a0b\u5e8f\u5458\u4e5f\u9700\u8981\u7f16\u5199\u5404\u79cd\u5e94\u7528\u8f6f\u4ef6\uff0c\u4e14\u8981\u5728\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e0a\u8fd0\u884c\u3002\u5982\u679c\u628a\u8fd9\u4e9b\u5e94\u7528\u8f6f\u4ef6\u90fd\u4f5c\u4e3a\u5185\u6838\u7ebf\u7a0b\u6765\u6267\u884c\uff0c\u90a3\u7cfb\u7edf\u7684\u5b89\u5168\u6027\u5c31\u65e0\u6cd5\u5f97\u5230\u4fdd\u8bc1\u4e86\u3002\u6240\u4ee5\uff0cucore\u8981\u63d0\u4f9b\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u521b\u5efa\u548c\u6267\u884c\u673a\u5236\uff0c\u7ed9\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u63d0\u4f9b\u4e00\u4e2a\u7528\u6237\u6001\u8fd0\u884c\u73af\u5883\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u7b80\u8981\u5206\u6790\u672c\u5b9e\u9a8c\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u4ee5\u53ca\u5206\u6790\u7528\u6237\u8fdb\u7a0b\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u6765\u9610\u8ff0\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406\u7684\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\u3002 \u663e\u7136\uff0c\u7531\u4e8e\u8fdb\u7a0b\u7684\u6267\u884c\u7a7a\u95f4\u6269\u5c55\u5230\u4e86\u7528\u6237\u6001\u7a7a\u95f4\uff0c\u4e14\u51fa\u73b0\u4e86\u521b\u5efa\u5b50\u8fdb\u7a0b\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7b49\u4e0e\u524d\u9762\u7684\u5b9e\u9a8c\u6709\u8f83\u5927\u4e0d\u540c\u7684\u5730\u65b9\uff0c\u6240\u4ee5\u5177\u4f53\u5b9e\u73b0\u7684\u4e0d\u540c\u4e3b\u8981\u96c6\u4e2d\u5728\u8fdb\u7a0b\u7ba1\u7406\u548c\u5185\u5b58\u7ba1\u7406\u90e8\u5206\u3002\u9996\u5148\uff0c\u6211\u4eec\u4eceucore\u7684\u521d\u59cb\u5316\u90e8\u5206\u6765\u770b\uff0c\u4f1a\u53d1\u73b0\u521d\u59cb\u5316\u7684\u603b\u63a7\u51fd\u6570kern_init\u6ca1\u6709\u4efb\u4f55\u53d8\u5316\u3002\u4f46\u8fd9\u5e76\u4e0d\u610f\u5473\u7740\u4e8c\u8005\u5dee\u522b\u4e0d\u5927\u3002\u5176\u5b9ekern_init\u8c03\u7528\u7684\u7269\u7406\u5185\u5b58\u521d\u59cb\u5316\uff0c\u8fdb\u7a0b\u7ba1\u7406\u521d\u59cb\u5316\u7b49\u90fd\u6709\u4e00\u5b9a\u7684\u53d8\u5316\u3002 \u5728\u5185\u5b58\u7ba1\u7406\u90e8\u5206\uff0c\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406\u9700\u8981\u589e\u52a0\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\u7684\u7ba1\u7406 \u3002\u4e3a\u4e86\u7ba1\u7406\u7528\u6237\u6001\u7684\u865a\u62df\u5185\u5b58\uff0c\u9700\u8981\u5bf9\u9875\u8868\u7684\u5185\u5bb9\u8fdb\u884c\u6269\u5c55\uff0c\u80fd\u591f\u628a\u90e8\u5206\u7269\u7406\u5185\u5b58\u6620\u5c04\u4e3a\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\u3002\u5982\u679c\u67d0\u8fdb\u7a0b\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0cCPU\u5728\u7528\u6237\u6001\u4e0b\u6267\u884c\uff08 \u5728CSR.CRMD\u4e2d\u7684PLV\u57df\uff0c\u5982\u679c\u4e3a0\uff0c\u8868\u793aCPU\u8fd0\u884c\u5728\u7279\u6743\u6001\uff1b\u5982\u679c\u4e3a3\uff0c\u8868\u793aCPU\u8fd0\u884c\u5728\u7528\u6237\u6001 \u3002\uff09\uff0c\u5219\u53ef\u4ee5\u8bbf\u95ee\u672c\u8fdb\u7a0b\u9875\u8868\u63cf\u8ff0\u7684\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\uff0c\u4f46\u7531\u4e8e\u6743\u9650\u4e0d\u591f\uff0c\u4e0d\u80fd\u8bbf\u95ee\u5185\u6838\u6001\u865a\u62df\u5185\u5b58\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4e0d\u540c\u7684\u8fdb\u7a0b\u6709\u5404\u81ea\u7684\u9875\u8868\uff0c\u6240\u4ee5\u5373\u4f7f\u4e0d\u540c\u8fdb\u7a0b\u7684\u7528\u6237\u6001\u865a\u62df\u5730\u5740\u76f8\u540c\uff0c\u4f46\u7531\u4e8e\u9875\u8868\u628a\u865a\u62df\u9875\u6620\u5c04\u5230\u4e86\u4e0d\u540c\u7684\u7269\u7406\u9875\u5e27\uff0c\u6240\u4ee5\u4e0d\u540c\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u662f\u88ab\u9694\u79bb\u5f00\u7684\uff0c\u76f8\u4e92\u4e4b\u95f4\u65e0\u6cd5\u76f4\u63a5\u8bbf\u95ee\u3002\u5728\u7528\u6237\u6001\u5185\u5b58\u7a7a\u95f4\u548c\u5185\u6838\u6001\u5185\u5b58\u7a7a\u95f4\u4e4b\u95f4\u9700\u8981\u62f7\u8d1d\u6570\u636e\uff0c\u8ba9CPU\u5904\u5728\u5185\u6838\u6001\u624d\u80fd\u5b8c\u6210\u5bf9\u7528\u6237\u7a7a\u95f4\u7684\u8bfb\u6216\u5199\uff0c\u4e3a\u6b64\u9700\u8981\u8bbe\u8ba1\u4e13\u95e8\u7684\u62f7\u8d1d\u51fd\u6570\uff08copy_from_user\u548ccopy_to_user\uff09\u5b8c\u6210\u3002\u4f46\u53cd\u4e4b\u5219\u4f1a\u5bfc\u81f4\u8fdd\u53cdCPU\u7684\u6743\u9650\u7ba1\u7406\uff0c\u5bfc\u81f4\u5185\u5b58\u8bbf\u95ee\u5f02\u5e38\u3002 \u5728\u8fdb\u7a0b\u7ba1\u7406\u65b9\u9762\uff0c\u4e3b\u8981\u6d89\u53ca\u5230\u7684\u662f\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2d\u4e0e\u5185\u5b58\u7ba1\u7406\u76f8\u5173\u7684\u90e8\u5206 \uff0c\u5305\u62ec\u2460\u5efa\u7acb\u8fdb\u7a0b\u7684\u9875\u8868\u548c\u7ef4\u62a4\u8fdb\u7a0b\u53ef\u8bbf\u95ee\u7a7a\u95f4\uff08\u53ef\u80fd\u8fd8\u6ca1\u6709\u5efa\u7acb\u865a\u5b9e\u6620\u5c04\u5173\u7cfb\uff09\u7684\u4fe1\u606f\uff1b\u2461\u52a0\u8f7d\u4e00\u4e2aELF\u683c\u5f0f\u7684\u7a0b\u5e8f\u5230\u8fdb\u7a0b\u63a7\u5236\u5757\u7ba1\u7406\u7684\u5185\u5b58\u4e2d\u7684\u65b9\u6cd5\uff1b\u2462\u5728\u8fdb\u7a0b\u590d\u5236\uff08fork\uff09\u8fc7\u7a0b\u4e2d\uff0c\u628a\u7236\u8fdb\u7a0b\u7684\u5185\u5b58\u7a7a\u95f4\u62f7\u8d1d\u5230\u5b50\u8fdb\u7a0b\u5185\u5b58\u7a7a\u95f4\u7684\u6280\u672f\u3002\u53e6\u5916\u4e00\u90e8\u5206\u4e0e\u7528\u6237\u6001\u8fdb\u7a0b\u751f\u547d\u5468\u671f\u7ba1\u7406\u76f8\u5173\uff0c\u5305\u62ec\u8ba9\u8fdb\u7a0b\u653e\u5f03CPU\u800c\u7761\u7720\u7b49\u5f85\u67d0\u4e8b\u4ef6\uff1b\u8ba9\u7236\u8fdb\u7a0b\u7b49\u5f85\u5b50\u8fdb\u7a0b\u7ed3\u675f\uff1b\u4e00\u4e2a\u8fdb\u7a0b\u6740\u6b7b\u53e6\u4e00\u4e2a\u8fdb\u7a0b\uff1b\u7ed9\u8fdb\u7a0b\u53d1\u6d88\u606f\uff1b\u5efa\u7acb\u8fdb\u7a0b\u7684\u8840\u7f18\u5173\u7cfb\u94fe\u8868\u3002 \u5f53\u5b9e\u73b0\u4e86\u4e0a\u8ff0\u5185\u5b58\u7ba1\u7406\u548c\u8fdb\u7a0b\u7ba1\u7406\u7684\u9700\u6c42\u540e\uff0c\u63a5\u4e0b\u6765ucore\u7684\u7528\u6237\u8fdb\u7a0b\u7ba1\u7406\u5de5\u4f5c\u5c31\u6bd4\u8f83\u7b80\u5355\u4e86\u3002\u9996\u5148\uff0c\u201c\u786c\u201d\u6784\u9020\u51fa\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u5b83\u662f\u540e\u7eed\u6240\u6709\u8fdb\u7a0b\u7684\u7956\u5148\uff1b\u7136\u540e\uff0c\u5728proc_init\u51fd\u6570\u4e2d\uff0c\u901a\u8fc7alloc\u628a\u5f53\u524ducore\u7684\u6267\u884c\u73af\u5883\u8f6c\u53d8\u6210idle\u5185\u6838\u7ebf\u7a0b\u7684\u6267\u884c\u73b0\u573a\uff1b\u7136\u540e\u8c03\u7528kernl_thread\u6765\u521b\u5efa\u7b2c\u4e8c\u4e2a\u5185\u6838\u7ebf\u7a0binit_main\uff0c\u800cinit_main\u5185\u6838\u7ebf\u7a0b\u6709\u521b\u5efa\u4e86user_main\u5185\u6838\u7ebf\u7a0b\u3002\u5230\u6b64\uff0c\u5185\u6838\u7ebf\u7a0b\u521b\u5efa\u5b8c\u6bd5\uff0c\u5e94\u8be5\u5f00\u59cb\u7528\u6237\u8fdb\u7a0b\u7684\u521b\u5efa\u8fc7\u7a0b\uff0c\u8fd9\u7b2c\u4e00\u6b65\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7user_main\u51fd\u6570\u8c03\u7528kernel_tread\u521b\u5efa\u5b50\u8fdb\u7a0b\uff0c\u901a\u8fc7kernel_execve\u8c03\u7528\u6765\u628a\u67d0\u4e00\u5177\u4f53\u7a0b\u5e8f\u7684\u6267\u884c\u5185\u5bb9\u653e\u5165\u5185\u5b58\u3002\u5177\u4f53\u7684\u653e\u7f6e\u65b9\u5f0f\u662f\u6839\u636eld\u5728\u6b64\u6587\u4ef6\u4e0a\u7684\u5730\u5740\u5206\u914d\u4e3a\u57fa\u672c\u539f\u5219\uff0c\u628a\u7a0b\u5e8f\u7684\u4e0d\u540c\u90e8\u5206\u653e\u5230\u67d0\u8fdb\u7a0b\u7684\u7528\u6237\u7a7a\u95f4\u4e2d\uff0c\u4ece\u800c\u901a\u8fc7\u6b64\u8fdb\u7a0b\u6765\u5b8c\u6210\u7a0b\u5e8f\u63cf\u8ff0\u7684\u4efb\u52a1\u3002\u4e00\u65e6\u6267\u884c\u4e86\u8fd9\u4e00\u7a0b\u5e8f\u5bf9\u5e94\u7684\u8fdb\u7a0b\uff0c\u5c31\u4f1a\u4ece\u5185\u6838\u6001\u5207\u6362\u5230\u7528\u6237\u6001\u7ee7\u7eed\u6267\u884c\u3002\u4ee5\u6b64\u7c7b\u63a8\uff0cCPU\u5728\u7528\u6237\u7a7a\u95f4\u6267\u884c\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u5176\u5730\u5740\u7a7a\u95f4\u4e0d\u4f1a\u88ab\u5176\u4ed6\u7528\u6237\u7684\u8fdb\u7a0b\u5f71\u54cd\uff0c\u4f46\u7531\u4e8e\u7cfb\u7edf\u8c03\u7528\uff08\u7528\u6237\u8fdb\u7a0b\u76f4\u63a5\u83b7\u5f97\u64cd\u4f5c\u7cfb\u7edf\u670d\u52a1\u7684\u552f\u4e00\u901a\u9053\uff09\u3001\u5916\u8bbe\u4e2d\u65ad\u548c\u5f02\u5e38\u4e2d\u65ad\u7684\u4f1a\u968f\u65f6\u4ea7\u751f\uff0c\u4ece\u800c\u95f4\u63a5\u63a8\u52a8\u4e86\u7528\u6237\u8fdb\u7a0b\u5b9e\u73b0\u7528\u6237\u6001\u5230\u5230\u5185\u6838\u6001\u7684\u5207\u6362\u5de5\u4f5c\u3002ucore\u5bf9CPU\u5185\u6838\u6001\u4e0e\u7528\u6237\u6001\u7684\u5207\u6362\u8fc7\u7a0b\u9700\u8981\u6bd4\u8f83\u4ed4\u7ec6\u5730\u5206\u6790\u3002\u5f53\u8fdb\u7a0b\u6267\u884c\u7ed3\u675f\u540e\uff0c\u9700\u56de\u6536\u8fdb\u7a0b\u5360\u7528\u548c\u6ca1\u6d88\u8017\u5b8c\u6bd5\u7684\u8bbe\u5907\u6574\u4e2a\u8fc7\u7a0b\uff0c\u4e14\u4e3a\u65b0\u7684\u521b\u5efa\u8fdb\u7a0b\u8bf7\u6c42\u63d0\u4f9b\u670d\u52a1\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u5f53\u7cfb\u7edf\u4e2d\u5b58\u5728\u591a\u4e2a\u8fdb\u7a0b\u6216\u5185\u6838\u7ebf\u7a0b\u65f6\uff0cucore\u91c7\u7528\u4e86\u4e00\u79cdFIFO\u7684\u5f88\u7b80\u5355\u7684\u8c03\u5ea6\u65b9\u6cd5\u6765\u7ba1\u7406\u6bcf\u4e2a\u8fdb\u7a0b\u5360\u7528CPU\u7684\u65f6\u95f4\u548c\u9891\u5ea6\u7b49\u3002\u5728ucore\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0c\u7531\u4e8e\u8c03\u5ea6\u3001\u65f6\u95f4\u4e2d\u65ad\u3001\u7cfb\u7edf\u8c03\u7528\u7b49\u539f\u56e0\uff0c\u4f7f\u5f97\u8fdb\u7a0b\u4f1a\u8fdb\u884c\u5207\u6362\u3001\u521b\u5efa\u3001\u7761\u7720\u3001\u7b49\u5f85\u3001\u53d1\u6d88\u606f\u7b49\u5404\u79cd\u4e0d\u540c\u7684\u64cd\u4f5c\uff0c\u5468\u800c\u590d\u59cb\uff0c\u751f\u751f\u4e0d\u606f\u3002","title":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0"},{"location":"lab3/intro/#_2","text":"\u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u5e76\u6267\u884c\u5b9e\u9645\u4e0a\u5c5e\u4e8e\u6267\u884c\u7528\u6237\u8fdb\u7a0b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5728\u521b\u5efa\u5e76\u6267\u884c\u7528\u6237\u8fdb\u7a0b\u4e4b\u524d\uff0c\u9996\u5148\u8981\u521b\u5efa\u5185\u6838\u8fdb\u7a0b\u3002\u5728\u4e86\u89e3\u8fd9\u4e9b\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u4ecb\u7ecd\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u8bbe\u8ba1\u3002\u8fdb\u7a0b\u7ba1\u7406\u4fe1\u606f\u7528\u4e00\u4e2a\u540d\u4e3aproc_struct\u7684\u6570\u636e\u7ed3\u6784\u8868\u793a\uff0c\u5728kern/process/proc.h\u4e2d\u5b9a\u4e49\u5982\u4e0b\uff1a struct proc_struct { enum proc_state state ; // Process state int pid ; // Process ID int runs ; // the running times of Proces uintptr_t kstack ; // Process kernel stack volatile bool need_resched ; // bool value: need to be rescheduled to release CPU? struct proc_struct * parent ; // the parent process struct mm_struct * mm ; // Process's memory management field struct context context ; // Switch here to run process struct trapframe * tf ; // Trap frame for current interrupt uintptr_t cr3 ; // CR3 register: the base addr of Page Directroy Table(PDT) uint32_t flags ; // Process flag char name [ PROC_NAME_LEN + 1 ]; // Process name list_entry_t list_link ; // Process link list list_entry_t hash_link ; // Process hash list int exit_code ; // exit code (be sent to parent proc) uint32_t wait_state ; // waiting state struct proc_struct * cptr , * yptr , * optr ; // relations between processes struct run_queue * rq ; // running queue contains Process list_entry_t run_link ; // the entry linked in run queue int time_slice ; // time slice for occupying the CPU struct fs_struct * fs_struct ; // the file related info(pwd, files_count, files_array, fs_semaphore) of process skew_heap_entry_t lab6_run_pool ; // FOR LAB6 ONLY: the entry in the run pool uint32_t lab6_stride ; // FOR LAB6 ONLY: the current stride of the process uint32_t lab6_priority ; // FOR LAB6 ONLY: the priority of process, set by lab6_set_priority(uint32_t) }; \u4e0b\u9762\u91cd\u70b9\u89e3\u91ca\u4e00\u4e0b\u51e0\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u6210\u5458\u53d8\u91cf\uff1a \u25cf mm\uff1a\u5185\u5b58\u7ba1\u7406\u7684\u4fe1\u606f \uff0c\u5305\u62ec\u5185\u5b58\u6620\u5c04\u5217\u8868\u3001\u9875\u8868\u6307\u9488\u7b49\u3002mm\u91cc\u6709\u4e2a\u5f88\u91cd\u8981\u7684\u9879pgdir\uff0c\u8bb0\u5f55\u7684\u662f\u8be5\u8fdb\u7a0b\u4f7f\u7528\u7684\u4e00\u7ea7\u9875\u8868\u7684\u7269\u7406\u5730\u5740\u3002\u7531\u4e8e*mm=NULL\uff0c\u6240\u4ee5\u5728proc_struct\u6570\u636e\u7ed3\u6784\u4e2d\u9700\u8981\u6709\u4e00\u4e2a\u4ee3\u66ffpgdir\u9879\u6765\u8bb0\u5f55\u9875\u8868\u8d77\u59cb\u5730\u5740\uff0c\u8fd9\u5c31\u662fproc_struct\u6570\u636e\u7ed3\u6784\u4e2d\u7684cr3\u6210\u5458\u53d8\u91cf\u3002 \u25cf state\uff1a\u8fdb\u7a0b\u6240\u5904\u7684\u72b6\u6001\u3002 \u25cf parent\uff1a\u7528\u6237\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\uff08\u521b\u5efa\u5b83\u7684\u8fdb\u7a0b\uff09\u3002\u5728\u6240\u6709\u8fdb\u7a0b\u4e2d\uff0c\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b\u6ca1\u6709\u7236\u8fdb\u7a0b\uff0c\u5c31\u662f\u5185\u6838\u521b\u5efa\u7684\u7b2c\u4e00\u4e2a\u5185\u6838\u7ebf\u7a0bidleproc\u3002\u5185\u6838\u6839\u636e\u8fd9\u4e2a\u7236\u5b50\u5173\u7cfb\u5efa\u7acb\u4e00\u4e2a\u6811\u5f62\u7ed3\u6784\uff0c\u7528\u4e8e\u7ef4\u62a4\u4e00\u4e9b\u7279\u6b8a\u7684\u64cd\u4f5c\uff0c\u4f8b\u5982\u786e\u5b9a\u67d0\u4e2a\u8fdb\u7a0b\u662f\u5426\u53ef\u4ee5\u5bf9\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u8fdb\u884c\u67d0\u79cd\u64cd\u4f5c\u7b49\u7b49\u3002 \u25cf kstack: \u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u4e00\u4e2a\u5185\u6838\u6808\uff0c\u5e76\u4e14\u4f4d\u4e8e\u5185\u6838\u5730\u5740\u7a7a\u95f4\u7684\u4e0d\u540c\u4f4d\u7f6e\u3002\u5bf9\u4e8e\u5185\u6838\u7ebf\u7a0b\uff0c\u8be5\u6808\u5c31\u662f\u8fd0\u884c\u65f6\u7684\u7a0b\u5e8f\u4f7f\u7528\u7684\u6808\uff1b\u800c\u5bf9\u4e8e\u666e\u901a\u8fdb\u7a0b\uff0c\u8be5\u6808\u662f\u53d1\u751f\u7279\u6743\u7ea7\u6539\u53d8\u7684\u65f6\u5019\u4f7f\u4fdd\u5b58\u88ab\u6253\u65ad\u7684\u786c\u4ef6\u4fe1\u606f\u7528\u7684\u6808\u3002uCore\u5728\u521b\u5efa\u8fdb\u7a0b\u65f6\u5206\u914d\u4e86 2 \u4e2a\u8fde\u7eed\u7684\u7269\u7406\u9875\uff08\u53c2\u89c1memlayout.h\u4e2dKSTACKSIZE\u7684\u5b9a\u4e49\uff09\u4f5c\u4e3a\u5185\u6838\u6808\u7684\u7a7a\u95f4\u3002\u8fd9\u4e2a\u6808\u5f88\u5c0f\uff0c\u6240\u4ee5\u5185\u6838\u4e2d\u7684\u4ee3\u7801\u5e94\u8be5\u5c3d\u53ef\u80fd\u7684\u7d27\u51d1\uff0c\u5e76\u4e14\u907f\u514d\u5728\u6808\u4e0a\u5206\u914d\u5927\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4ee5\u514d\u6808\u6ea2\u51fa\uff0c\u5bfc\u81f4\u7cfb\u7edf\u5d29\u6e83\u3002 kstack\u8bb0\u5f55\u4e86\u5206\u914d\u7ed9\u8be5\u8fdb\u7a0b/\u7ebf\u7a0b\u7684\u5185\u6838\u6808\u7684\u4f4d\u7f6e \u3002\u4e3b\u8981\u4f5c\u7528\u6709\u4ee5\u4e0b\u51e0\u70b9\u3002\u9996\u5148\uff0c\u5f53\u5185\u6838\u51c6\u5907\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u7684\u65f6\u5019\uff0c\u9700\u8981\u6839\u636ekstack \u7684\u503c\u6b63\u786e\u7684\u8bbe\u7f6e\u597d tss\uff0c\u4ee5\u4fbf\u5728\u8fdb\u7a0b\u5207\u6362\u4ee5\u540e\u518d\u53d1\u751f\u4e2d\u65ad\u65f6\u80fd\u591f\u4f7f\u7528\u6b63\u786e\u7684\u6808\u3002\u5176\u6b21\uff0c\u5185\u6838\u6808\u4f4d\u4e8e\u5185\u6838\u5730\u5740\u7a7a\u95f4\uff0c\u5e76\u4e14\u662f\u4e0d\u5171\u4eab\u7684\uff08\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u62e5\u6709\u81ea\u5df1\u7684\u5185\u6838\u6808\uff09\uff0c\u56e0\u6b64\u4e0d\u53d7\u5230 mm \u7684\u7ba1\u7406\uff0c\u5f53\u8fdb\u7a0b\u9000\u51fa\u7684\u65f6\u5019\uff0c\u5185\u6838\u80fd\u591f\u6839\u636e kstack \u7684\u503c\u5feb\u901f\u5b9a\u4f4d\u6808\u7684\u4f4d\u7f6e\u5e76\u8fdb\u884c\u56de\u6536\u3002 \u25cf tf\uff1a\u4e2d\u65ad\u5e27\u7684\u6307\u9488 \uff0c\u603b\u662f\u6307\u5411\u5185\u6838\u6808\u7684\u67d0\u4e2a\u4f4d\u7f6e\uff1a\u5f53\u8fdb\u7a0b\u4ece\u7528\u6237\u7a7a\u95f4\u8df3\u5230\u5185\u6838\u7a7a\u95f4\u65f6\uff0c\u4e2d\u65ad\u5e27\u8bb0\u5f55\u4e86\u8fdb\u7a0b\u5728\u88ab\u4e2d\u65ad\u524d\u7684\u72b6\u6001\u3002 \u5f53\u5185\u6838\u9700\u8981\u8df3\u56de\u7528\u6237\u7a7a\u95f4\u65f6\uff0c\u9700\u8981\u8c03\u6574\u4e2d\u65ad\u5e27\u4ee5\u6062\u590d\u8ba9\u8fdb\u7a0b\u7ee7\u7eed\u6267\u884c\u7684\u5404\u5bc4\u5b58\u5668\u503c \u3002\u9664\u6b64\u4e4b\u5916\uff0cuCore\u5185\u6838\u5141\u8bb8\u5d4c\u5957\u4e2d\u65ad\u3002\u56e0\u6b64\u4e3a\u4e86\u4fdd\u8bc1\u5d4c\u5957\u4e2d\u65ad\u53d1\u751f\u65f6tf \u603b\u662f\u80fd\u591f\u6307\u5411\u5f53\u524d\u7684trapframe\uff0cuCore \u5728\u5185\u6838\u6808\u4e0a\u7ef4\u62a4\u4e86 tf \u7684\u94fe\uff0c\u53ef\u4ee5\u53c2\u8003trap.c::trap\u51fd\u6570\u505a\u8fdb\u4e00\u6b65\u7684\u4e86\u89e3\u3002 \u25cf cr3: cr3 \u4fdd\u5b58\u9875\u8868\u7684\u7269\u7406\u5730\u5740\uff0c\u76ee\u7684\u5c31\u662f\u8fdb\u7a0b\u5207\u6362\u7684\u65f6\u5019\u65b9\u4fbf\u76f4\u63a5\u4f7f\u7528 lcr3\u5b9e\u73b0\u9875\u8868\u5207\u6362\uff0c\u907f\u514d\u6bcf\u6b21\u90fd\u6839\u636e mm \u6765\u8ba1\u7b97 cr3\u3002mm\u6570\u636e\u7ed3\u6784\u662f\u7528\u6765\u5b9e\u73b0\u7528\u6237\u7a7a\u95f4\u7684\u865a\u5b58\u7ba1\u7406\u7684\uff0c\u5f53\u67d0\u4e2a\u8fdb\u7a0b\u662f\u4e00\u4e2a\u666e\u901a\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u65f6\u5019\uff0cPCB \u4e2d\u7684 cr3 \u5c31\u662f mm \u4e2d\u9875\u8868\uff08pgdir\uff09\u7684\u7269\u7406\u5730\u5740\uff1b\u800c\u5f53\u5b83\u662f\u5185\u6838\u7ebf\u7a0b\u7684\u65f6\u5019\uff0ccr3 \u7b49\u4e8eboot_cr3\u3002\u800cboot_cr3\u6307\u5411\u4e86uCore\u542f\u52a8\u65f6\u5efa\u7acb\u597d\u7684\u997f\u5185\u6838\u865a\u62df\u7a7a\u95f4\u7684\u9875\u76ee\u5f55\u8868\u9996\u5730\u5740\u3002 \u4e3a\u4e86\u7ba1\u7406\u7cfb\u7edf\u4e2d\u6240\u6709\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\uff0cuCore\u7ef4\u62a4\u4e86\u5982\u4e0b\u5168\u5c40\u53d8\u91cf\uff08\u4f4d\u4e8ekern/process/proc.c\uff09\uff1a \u25cf static struct proc *current\uff1a\u5f53\u524d\u5360\u7528CPU\u4e14\u5904\u4e8e\u201c\u8fd0\u884c\u201d\u72b6\u6001\u8fdb\u7a0b\u63a7\u5236\u5757\u6307\u9488\u3002\u901a\u5e38\u8fd9\u4e2a\u53d8\u91cf\u662f\u53ea\u8bfb\u7684\uff0c\u53ea\u6709\u5728\u8fdb\u7a0b\u5207\u6362\u7684\u65f6\u5019\u624d\u8fdb\u884c\u4fee\u6539\u3002 \u25cf static struct proc *initproc\uff1a\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6b64\u6307\u9488\u5c06\u6307\u5411\u7b2c\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b \u3002 \u25cf static list_entry_t hash_list[HASH_LIST_SIZE]\uff1a\u6240\u6709\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u54c8\u5e0c\u8868\uff0cproc_struct\u4e2d\u7684\u6210\u5458\u53d8\u91cfhash_link\u5c06\u57fa\u4e8epid\u94fe\u63a5\u5165\u8fd9\u4e2a\u54c8\u5e0c\u8868\u4e2d\u3002 \u25cf list_entry_t proc_list\uff1a\u6240\u6709\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u53cc\u5411\u7ebf\u6027\u5217\u8868\uff0cproc_struct\u4e2d\u7684\u6210\u5458\u53d8\u91cflist_link\u5c06\u94fe\u63a5\u5165\u8fd9\u4e2a\u94fe\u8868\u4e2d\u3002","title":"\u8fdb\u7a0b\u63a7\u5236\u5757"},{"location":"lab3/intro/#_3","text":"","title":"\u521b\u5efa\u7528\u6237\u8fdb\u7a0b"},{"location":"lab3/intro/#1","text":"\u6211\u4eec\u9996\u5148\u6765\u770b\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd9\u91cc\u6211\u4eec\u5047\u5b9a\u662fhello\u5e94\u7528\u7a0b\u5e8f\uff0c\u5728user/hello.c\u4e2d\u5b9e\u73b0\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a #include <stdio.h> #include <ulib.h> int main ( void ) { cprintf ( \"Hello world!!. \\n \" ); cprintf ( \"I am process %d. \\n \" , getpid ()); cprintf ( \"hello pass. \\n \" ); return 0 ; } hello\u5e94\u7528\u7a0b\u5e8f\u53ea\u662f\u8f93\u51fa\u4e00\u4e9b\u5b57\u7b26\u4e32\uff0c\u5e76\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_getpid\uff08\u5728getpid\u51fd\u6570\u4e2d\u8c03\u7528\uff09\u8f93\u51fa\u4ee3\u8868hello\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u7528\u6237\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u6807\u8bc6--pid\u3002 \u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3ucore\u64cd\u4f5c\u7cfb\u7edf\u5982\u4f55\u80fd\u591f\u627e\u5230hello\u5e94\u7528\u7a0b\u5e8f\u3002\u8fd9\u9700\u8981\u5206\u6790ucore\u548chello\u662f\u5982\u4f55\u7f16\u8bd1\u7684\u3002\u5728\u672c\u5b9e\u9a8c\u6e90\u7801\u76ee\u5f55\u4e0b\u6267\u884cmake\uff0c\u53ef\u5f97\u5230\u5982\u4e0b\u8f93\u51fa\uff1a \u2026\u2026 + cc user/hello.c loongarch32-linux-gnu-gcc -c -Iuser/libs -Ikern/include -fno-builtin-fprintf -fno-builtin -nostdlib -nostdinc -g -G0 -Wa,-O0 -fno-pic -mno-shared -msoft-float -ggdb -gstabs -mlcsr user/hello.c -o obj/user/hello.o loongarch32-linux-gnu-ld -T user/libs/user.ld obj/user/hello.o --whole-archive obj/user/libuser.a -o obj/user/hello \u2026\u2026 sed 's/$FILE/hello/g' tools/piggy.S.in > obj/user/hello.S \u2026\u2026 # \u6ce8\u610f\uff0c\u53ef\u4ee5\u89c2\u5bdfobj/user/hello.S\u6587\u4ef6\uff0c\u8fd9\u91cc\u6709\u4f7f\u7528.incbin\u53bb\u5f15\u5165\u5148\u524d\u7f16\u8bd1\u597d\u7684obj/user/hello loongarch32-linux-gnu-gcc -c obj/user/hello.S -o obj/user/hello.piggy.o loongarch32-linux-gnu-ld -nostdlib -n -G 0 -static -T tools/kernel.ld obj/init/init.o \u2026\u2026 obj/user/hello.piggy.o \u2026\u2026 -o obj/ucore-kernel-piggy \u4ece\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0chello\u5e94\u7528\u7a0b\u5e8f\u4e0d\u4ec5\u4ec5\u662fhello.c\uff0c\u8fd8\u5305\u542b\u4e86\u652f\u6301hello\u5e94\u7528\u7a0b\u5e8f\u7684\u7528\u6237\u6001\u5e93\uff1a user/libs/initcode.S\uff1a\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u7684\u8d77\u59cb\u7528\u6237\u6001\u6267\u884c\u5730\u5740\u201c_start\u201d\uff0c\u8c03\u6574\u4e86gp\u548csp\u540e\uff0c\u8c03\u7528umain\u51fd\u6570\u3002 user/libs/umain.c\uff1a\u5b9e\u73b0\u4e86umain\u51fd\u6570\uff0c\u8fd9\u662f\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u7b2c\u4e00\u4e2aC\u51fd\u6570\uff0c\u5b83\u5c06\u8c03\u7528\u5e94\u7528\u7a0b\u5e8f\u7684main\u51fd\u6570\uff0c\u5e76\u5728main\u51fd\u6570\u7ed3\u675f\u540e\u8c03\u7528exit\u51fd\u6570\uff0c\u800cexit\u51fd\u6570\u6700\u7ec8\u5c06\u8c03\u7528sys_exit\u7cfb\u7edf\u8c03\u7528\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u56de\u6536\u8fdb\u7a0b\u8d44\u6e90\u3002 user/libs/ulib.[ch]\uff1a\u5b9e\u73b0\u4e86\u6700\u5c0f\u7684C\u51fd\u6570\u5e93\uff0c\u9664\u4e86\u4e00\u4e9b\u4e0e\u7cfb\u7edf\u8c03\u7528\u65e0\u5173\u7684\u51fd\u6570\uff0c\u5176\u4ed6\u51fd\u6570\u662f\u5bf9\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u7684\u5305\u88c5\u3002 user/libs/syscall.[ch]\uff1a\u7528\u6237\u5c42\u53d1\u51fa\u7cfb\u7edf\u8c03\u7528\u7684\u5177\u4f53\u5b9e\u73b0\u3002 user/libs/stdio.c\uff1a\u5b9e\u73b0cprintf\u51fd\u6570\uff0c\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_putc\u6765\u5b8c\u6210\u5b57\u7b26\u8f93\u51fa\u3002 user/libs/panic.c\uff1a\u5b9e\u73b0__panic/__warn\u51fd\u6570\uff0c\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_exit\u5b8c\u6210\u7528\u6237\u8fdb\u7a0b\u9000\u51fa\u3002 \u9664\u4e86\u8fd9\u4e9b\u7528\u6237\u6001\u5e93\u51fd\u6570\u5b9e\u73b0\u5916\uff0c\u8fd8\u6709\u4e00\u4e9blibs/*.[ch]\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u548c\u5e94\u7528\u7a0b\u5e8f\u5171\u7528\u7684\u51fd\u6570\u5b9e\u73b0\u3002\u8fd9\u4e9b\u7528\u6237\u5e93\u51fd\u6570\u5176\u5b9e\u5728\u672c\u8d28\u4e0a\u4e0eUNIX\u7cfb\u7edf\u4e2d\u7684\u6807\u51c6libc\u6ca1\u6709\u533a\u522b\uff0c\u53ea\u662f\u5b9e\u73b0\u5f97\u5f88\u7b80\u5355\uff0c\u4f46hello\u5e94\u7528\u7a0b\u5e8f\u7684\u6b63\u786e\u6267\u884c\u79bb\u4e0d\u5f00\u8fd9\u4e9b\u5e93\u51fd\u6570\u3002 \u3010 \u6ce8\u610f \u3011libs/ .[ch]\u3001user/libs/ .[ch]\u3001user/*.[ch]\u7684\u6e90\u7801\u4e2d\u6ca1\u6709\u4efb\u4f55\u7279\u6743\u6307\u4ee4\u3002 a00c3160 _binary_obj_user_hello_end a00125ac file_open a00018d0 strcpy a0000240 ide_device_valid a01455c0 _binary_obj_user_forktree_start a000cb30 wakeup_queue a00156f0 vfs_set_bootfs a000d12c cond_signal a0011850 sysfile_fsync a001a57c dev_init_stdout a00b4ac0 _binary_obj_user_hello_start \u5728make\u7684\u6700\u540e\u4e00\u6b65\u6267\u884c\u4e86\u4e00\u4e2ald\u547d\u4ee4\uff0c\u628ahello\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u7801obj/user/hello.piggy.o\u8fde\u63a5\u5728\u4e86ucore kernel\u7684\u672b\u5c3e\u3002\u5e76\u89c2\u5bdftools/piggy.S.in\u6587\u4ef6\u53ef\u4ee5\u53d1\u73b0\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86.global binary_obj_user FILE_start\u548c.global _binary_obj_user_ FILE_start\u548c.global _binary_obj_user_ FILE_end\u3002\u8fd9\u6837\u8fd9\u4e24\u4e2a\u7b26\u53f7\u5c31\u4f1a\u4fdd\u7559\u5728\u6700\u7ec8ld\u751f\u6210\u7684\u6587\u4ef6\u4e2d\uff0c\u8fd9\u6837\u8fd9\u4e2ahello\u7528\u6237\u7a0b\u5e8f\u5c31\u80fd\u591f\u548cucore\u5185\u6838\u4e00\u8d77\u88ab bootloader \u52a0\u8f7d\u5230\u5185\u5b58\u91cc\u4e2d\uff0c\u5e76\u4e14\u901a\u8fc7\u8fd9\u4e24\u4e2a\u5168\u5c40\u53d8\u91cf\u5b9a\u4f4dhello\u7528\u6237\u7a0b\u5e8f\u6267\u884c\u7801\u7684\u8d77\u59cb\u4f4d\u7f6e\u548c\u5927\u5c0f\u3002\u800c\u5230\u4e86\u4e0e\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u5b9e\u9a8c\u540e\uff0cucore\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u90a3\u65f6\u6240\u6709\u7684\u7528\u6237\u7a0b\u5e8f\u5c31\u90fd\u4e0d\u518d\u7528\u8fd9\u79cd\u65b9\u6cd5\u8fdb\u884c\u52a0\u8f7d\u4e86\uff0c\u800c\u53ef\u4ee5\u7528\u5927\u5bb6\u719f\u6089\u7684\u6587\u4ef6\u65b9\u5f0f\u8fdb\u884c\u52a0\u8f7d\u4e86\u3002 \uff08\u6ce8\uff0c\u540e\u7eed\u7684\u6587\u4ef6\u7cfb\u7edf\u91c7\u7528initrd\u7684\u65b9\u5f0f\uff0c\u5e76\u975e\u4f4d\u4e8e\u78c1\u76d8\u3002\uff09","title":"1. \u5e94\u7528\u7a0b\u5e8f\u7684\u7ec4\u6210\u548c\u7f16\u8bd1"},{"location":"lab3/intro/#2","text":"\u5728user/libs/user.ld\u63cf\u8ff0\u4e86\u7528\u6237\u7a0b\u5e8f\u7684\u7528\u6237\u865a\u62df\u7a7a\u95f4\u7684\u6267\u884c\u5165\u53e3\u865a\u62df\u5730\u5740\uff1a SECTIONS { /* Load programs at this address: \".\" means the current address */ . = 0x10000000 ; \u5728tools/kernel.ld\u63cf\u8ff0\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u6838\u865a\u62df\u7a7a\u95f4\u7684\u8d77\u59cb\u5165\u53e3\u865a\u62df\u5730\u5740\uff1a SECTIONS { /* Load the kernel at this address: \".\" means the current address */ . = 0xa0000000 ; \u8fd9\u6837ucore\u628a\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5206\u4e86\u4e24\u5757\uff0c\u4e00\u5757\u4e0e\u5185\u6838\u7ebf\u7a0b\u4e00\u6837\uff0c\u662f\u6240\u6709\u7528\u6237\u8fdb\u7a0b\u90fd\u5171\u4eab\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u6620\u5c04\u5230\u540c\u6837\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u4e2d\uff0c\u8fd9\u6837\u5728\u7269\u7406\u5185\u5b58\u4e2d\u53ea\u9700\u653e\u7f6e\u4e00\u4efd\u5185\u6838\u4ee3\u7801\uff0c\u4f7f\u5f97\u7528\u6237\u8fdb\u7a0b\u4ece\u7528\u6237\u6001\u8fdb\u5165\u6838\u5fc3\u6001\u65f6\uff0c\u5185\u6838\u4ee3\u7801\u53ef\u4ee5\u7edf\u4e00\u5e94\u5bf9\u4e0d\u540c\u7684\u5185\u6838\u7a0b\u5e8f\uff1b\u53e6\u5916\u4e00\u5757\u662f\u7528\u6237\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u867d\u7136\u865a\u62df\u5730\u5740\u8303\u56f4\u4e00\u6837\uff0c\u4f46\u6620\u5c04\u5230\u4e0d\u540c\u4e14\u6ca1\u6709\u4ea4\u96c6\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u4e2d\u3002\u8fd9\u6837\u5f53ucore\u628a\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u4ee3\u7801\uff08\u5373\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u4ee3\u7801\uff09\u548c\u6570\u636e\uff08\u5373\u5e94\u7528\u7a0b\u5e8f\u7684\u5168\u5c40\u53d8\u91cf\u7b49\uff09\u653e\u5230\u7528\u6237\u865a\u62df\u5730\u5740\u7a7a\u95f4\u4e2d\u65f6\uff0c\u786e\u4fdd\u4e86\u5404\u4e2a\u8fdb\u7a0b\u4e0d\u4f1a\u201c\u975e\u6cd5\u201d\u8bbf\u95ee\u5230\u5176\u4ed6\u8fdb\u7a0b\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u3002 \u8fd9\u6837ucore\u7ed9\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u5177\u4f53\u8bbe\u5b9a\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff08kern/mm/memlayout.h\uff09\u5982\u4e0b\u6240\u793a\uff1a","title":"2. \u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4"},{"location":"lab3/intro/#3","text":"\u5728\u786e\u5b9a\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u4ee3\u7801\u548c\u6570\u636e\uff0c\u4ee5\u53ca\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u7a7a\u95f4\u5e03\u5c40\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6765\u521b\u5efa\u7528\u6237\u8fdb\u7a0b\u4e86\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u662f\u7531\u7b2c\u4e8c\u4e2a\u5185\u6838\u7ebf\u7a0binitproc\u901a\u8fc7\u628ahello\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u8986\u76d6\u5230initproc\u7684\u7528\u6237\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u6765\u521b\u5efa\u7684\uff0c\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a // kernel_execve - do SYS_exec syscall to exec a user program called by user_main kernel_thread static int kernel_execve ( const char * name , unsigned char * binary , size_t size ) { int ret , len = strlen ( name ); asm volatile ( \"addi.w $a7, $zero,%1; \\n \" // syscall no. \"move $a0, %2; \\n \" \"move $a1, %3; \\n \" \"move $a2, %4; \\n \" \"move $a3, %5; \\n \" \"syscall 0; \\n \" \"move %0, $a7; \\n \" : \"=r\" ( ret ) : \"i\" ( SYSCALL_BASE + SYS_exec ), \"r\" ( name ), \"r\" ( len ), \"r\" ( binary ), \"r\" ( size ) : \"a0\" , \"a1\" , \"a2\" , \"a3\" , \"a7\" ); return ret ; } #define __KERNEL_EXECVE(name, path, ...) ({ \\ const char *argv[] = {path, ##__VA_ARGS__, NULL}; \\ kprintf(\"kernel_execve: pid = %d, name = \\\"%s\\\".\\n\", \\ current->pid, name); \\ kernel_execve(name, argv); \\ }) #define KERNEL_EXECVE(x, ...) __KERNEL_EXECVE(#x, #x, ##__VA_ARGS__) \u2026\u2026 // init_main - the second kernel thread used to create kswapd_main & user_main kernel threads static int init_main ( void * arg ) { #ifdef TEST KERNEL_EXECVE2 ( TEST , TESTSTART , TESTSIZE ); #else KERNEL_EXECVE ( hello ); #endif panic ( \"kernel_execve failed. \\n \" ); return 0 ; } \u5bf9\u4e8e\u4e0a\u8ff0\u4ee3\u7801\uff0c\u6211\u4eec\u9700\u8981\u4ece\u540e\u5411\u524d\u6309\u7167\u51fd\u6570/\u5b8f\u7684\u5b9e\u73b0\u4e00\u4e2a\u4e00\u4e2a\u6765\u5206\u6790\u3002Initproc\u7684\u6267\u884c\u4e3b\u4f53\u662finit_main\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u5728\u7f3a\u7701\u60c5\u51b5\u4e0b\u662f\u6267\u884c\u5b8fKERNEL_EXECVE(hello)\uff0c\u800c\u8fd9\u4e2a\u5b8f\u6700\u7ec8\u662f\u8c03\u7528kernel_execve\u51fd\u6570\u6765\u8c03\u7528SYS_exec\u7cfb\u7edf\u8c03\u7528\uff0c\u7531\u4e8eld\u5728\u94fe\u63a5hello\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u65f6\u5b9a\u4e49\u4e86\u4e24\u5168\u5c40\u53d8\u91cf\uff1a _binary_obj___user_hello_out_start\uff1ahello\u6267\u884c\u7801\u7684\u8d77\u59cb\u4f4d\u7f6e _binary_obj___user_hello_out_size\u4e2d\uff1ahello\u6267\u884c\u7801\u7684\u5927\u5c0f kernel_execve\u628a\u8fd9\u4e24\u4e2a\u53d8\u91cf\u4f5c\u4e3aSYS_exec\u7cfb\u7edf\u8c03\u7528\u7684\u53c2\u6570\uff0c\u8ba9ucore\u6765\u521b\u5efa\u6b64\u7528\u6237\u8fdb\u7a0b\u3002\u5f53ucore\u6536\u5230\u6b64\u7cfb\u7edf\u8c03\u7528\u540e\uff0c\u5c06\u4f9d\u6b21\u8c03\u7528\u5982\u4e0b\u51fd\u6570: vector128 ( vectors . S ) -- \\ > \\ _ \\ _alltraps ( trapentry . S ) -- \\ > trap ( trap . c ) -- \\ > trap \\ _dispatch ( trap . c ) -- -- \\ > syscall ( syscall . c ) -- \\ > sys \\ _exec \uff08 syscall . c \uff09 -- \\ > do \\ _execve ( proc . c ) \u6700\u7ec8\u901a\u8fc7do_execve\u51fd\u6570\u6765\u5b8c\u6210\u7528\u6237\u8fdb\u7a0b\u7684\u521b\u5efa\u5de5\u4f5c\u3002\u6b64\u51fd\u6570\u7684\u4e3b\u8981\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\uff1a \u9996\u5148\u4e3a\u52a0\u8f7d\u65b0\u7684\u6267\u884c\u7801\u505a\u597d\u7528\u6237\u6001\u5185\u5b58\u7a7a\u95f4\u6e05\u7a7a\u51c6\u5907 \u3002\u5982\u679cmm\u4e0d\u4e3aNULL\uff0c\u5219\u8bbe\u7f6e\u9875\u8868\u4e3a\u5185\u6838\u7a7a\u95f4\u9875\u8868\uff0c\u4e14\u8fdb\u4e00\u6b65\u5224\u65admm\u7684\u5f15\u7528\u8ba1\u6570\u51cf1\u540e\u662f\u5426\u4e3a0\uff0c\u5982\u679c\u4e3a0\uff0c\u5219\u8868\u660e\u6ca1\u6709\u8fdb\u7a0b\u518d\u9700\u8981\u6b64\u8fdb\u7a0b\u6240\u5360\u7528\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u4e3a\u6b64\u5c06\u6839\u636emm\u4e2d\u7684\u8bb0\u5f55\uff0c\u91ca\u653e\u8fdb\u7a0b\u6240\u5360\u7528\u6237\u7a7a\u95f4\u5185\u5b58\u548c\u8fdb\u7a0b\u9875\u8868\u672c\u8eab\u6240\u5360\u7a7a\u95f4\u3002\u6700\u540e\u628a\u5f53\u524d\u8fdb\u7a0b\u7684mm\u5185\u5b58\u7ba1\u7406\u6307\u9488\u4e3a\u7a7a\u3002\u7531\u4e8e\u6b64\u5904\u7684initproc\u662f\u5185\u6838\u7ebf\u7a0b\uff0c\u6240\u4ee5mm\u4e3aNULL\uff0c\u6574\u4e2a\u5904\u7406\u90fd\u4e0d\u4f1a\u505a\u3002 \u63a5\u4e0b\u6765\u7684\u4e00\u6b65\u662f\u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u5230\u5f53\u524d\u8fdb\u7a0b\u7684\u65b0\u521b\u5efa\u7684\u7528\u6237\u6001\u865a\u62df\u7a7a\u95f4\u4e2d\u3002\u8fd9\u91cc\u6d89\u53ca\u5230\u8bfbELF\u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u7533\u8bf7\u5185\u5b58\u7a7a\u95f4\uff0c\u5efa\u7acb\u7528\u6237\u6001\u865a\u5b58\u7a7a\u95f4\uff0c\u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u7b49\u3002load_icode\u51fd\u6570\u5b8c\u6210\u4e86\u6574\u4e2a\u590d\u6742\u7684\u5de5\u4f5c\u3002 load_icode\u51fd\u6570\u7684\u4e3b\u8981\u5de5\u4f5c\u5c31\u662f\u7ed9\u7528\u6237\u8fdb\u7a0b\u5efa\u7acb\u4e00\u4e2a\u80fd\u591f\u8ba9\u7528\u6237\u8fdb\u7a0b\u6b63\u5e38\u8fd0\u884c\u7684\u7528\u6237\u73af\u5883\u3002\u6b64\u51fd\u6570\u6709\u4e00\u767e\u591a\u884c\uff0c\u5b8c\u6210\u4e86\u5982\u4e0b\u91cd\u8981\u5de5\u4f5c\uff1a \u8c03\u7528mm_create\u51fd\u6570\u6765\u7533\u8bf7\u8fdb\u7a0b\u7684\u5185\u5b58\u7ba1\u7406\u6570\u636e\u7ed3\u6784mm\u6240\u9700\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u5bf9mm\u8fdb\u884c\u521d\u59cb\u5316\uff1b mm\u662f\u4e00\u4e2amm_struct\u7ed3\u6784\u7684\u53d8\u91cf\uff0c\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u8868\u793a\u4e86\u5305\u542b\u6240\u6709\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u5171\u540c\u5c5e\u6027(\u5b9a\u4e49\u4f4d\u4e8ekern/mm/vmm.h)\uff0c\u5177\u4f53\u5b9a\u4e49\u5982\u4e0b\uff1a // the control struct for a set of vma using the same PDT struct mm_struct { list_entry_t mmap_list ; // linear list link which sorted by start addr of vma struct vma_struct * mmap_cache ; // current accessed vma, used for speed purpose pde_t * pgdir ; // the PDT of these vma int map_count ; // the count of these vma atomic_t mm_count ; semaphore_t mm_sem ; int locked_by ; }; mmap_list\u662f\u53cc\u5411\u94fe\u8868\u5934\uff0c\u94fe\u63a5\u4e86\u6240\u6709\u5c5e\u4e8e\u540c\u4e00\u9875\u76ee\u5f55\u8868\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u3002 mmap_cache\u662f\u6307\u5411\u5f53\u524d\u6b63\u5728\u4f7f\u7528\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u7531\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u6267\u884c\u7684\u201c\u5c40\u90e8\u6027\u201d\u539f\u7406\uff0c\u5f53\u524d\u6b63\u5728\u7528\u5230\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u5728\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u4e2d\u53ef\u80fd\u8fd8\u4f1a\u7528\u5230\uff0c\u8fd9\u65f6\u5c31\u4e0d\u9700\u8981\u67e5\u94fe\u8868\uff0c\u800c\u662f\u76f4\u63a5\u4f7f\u7528\u6b64\u6307\u9488\u5c31\u53ef\u627e\u5230\u4e0b\u4e00\u6b21\u8981\u7528\u5230\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u3002\u7531\u4e8emmap_cache \u7684\u5f15\u5165\uff0c\u53ef\u4f7f\u5f97 mm_struct \u6570\u636e\u7ed3\u6784\u7684\u67e5\u8be2\u52a0\u901f 30% \u4ee5\u4e0a\u3002 pgdir \u6240\u6307\u5411\u7684\u5c31\u662fmm_struct\u6570\u636e\u7ed3\u6784\u6240\u7ef4\u62a4\u7684\u9875\u8868\u3002\u901a\u8fc7\u8bbf\u95eepgdir\u53ef\u4ee5\u67e5\u627e\u67d0\u865a\u62df\u5730\u5740\u5bf9\u5e94\u7684\u9875\u8868\u9879\u662f\u5426\u5b58\u5728\u4ee5\u53ca\u9875\u8868\u9879\u7684\u5c5e\u6027\u7b49 \u3002 map_count\u8bb0\u5f55mmap_list \u91cc\u9762\u94fe\u63a5\u7684 vma_struct\u7684\u4e2a\u6570\u3002 \u6d89\u53camm_struct\u7684\u64cd\u4f5c\u51fd\u6570\u6bd4\u8f83\u7b80\u5355\uff0c\u53ea\u6709mm_create\u548cmm_destroy\u4e24\u4e2a\u51fd\u6570\uff0c\u4ece\u5b57\u9762\u610f\u601d\u5c31\u53ef\u4ee5\u770b\u51fa\u662f\u662f\u5b8c\u6210mm_struct\u7ed3\u6784\u7684\u53d8\u91cf\u521b\u5efa\u548c\u5220\u9664\u3002 \u8c03\u7528setup_pgdir\u6765\u7533\u8bf7\u4e00\u4e2a\u9875\u76ee\u5f55\u8868\u6240\u9700\u7684\u4e00\u4e2a\u9875\u5927\u5c0f\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u628a\u63cf\u8ff0ucore\u5185\u6838\u865a\u7a7a\u95f4\u6620\u5c04\u7684\u5185\u6838\u9875\u8868\uff08boot_pgdir\u6240\u6307\uff09\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u6b64\u65b0\u76ee\u5f55\u8868\u4e2d\uff0c\u6700\u540e\u8ba9mm->pgdir\u6307\u5411\u6b64\u9875\u76ee\u5f55\u8868\uff0c\u8fd9\u5c31\u662f\u8fdb\u7a0b\u65b0\u7684\u9875\u76ee\u5f55\u8868\u4e86\uff0c\u4e14\u80fd\u591f\u6b63\u786e\u6620\u5c04\u5185\u6838\u865a\u7a7a\u95f4\uff1b setup_pgdir\u51fd\u6570\u7684\u5b9a\u4e49\u5982\u4e0b(kern/process/proc.c)\uff1a // setup_pgdir - alloc one page as PDT static int setup_pgdir ( struct mm_struct * mm ) { struct Page * page ; if (( page = alloc_page ()) == NULL ) { //\u7533\u8bf7\u4e00\u9875\u7684\u5185\u5b58\u7a7a\u95f4 return - E_NO_MEM ; } pde_t * pgdir = page2kva ( page ); memcpy ( pgdir , boot_pgdir , PGSIZE ); //\u5c06\u63cf\u8ff0ucore\u5185\u6838\u865a\u7a7a\u95f4\u6620\u5c04\u7684\u5185\u6838\u9875\u8868\uff08boot_pgdir\u6240\u6307\uff09\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u6b64\u65b0\u76ee\u5f55\u8868\u4e2d //panic(\"unimpl\"); //pgdir[PDX(VPT)] = PADDR(pgdir) | PTE_P | PTE_W; mm -> pgdir = pgdir ; //\u5c06mm->pgdir\u6307\u5411\u6b64\u9875\u76ee\u5f55\u8868\uff0c\u4f7f\u8fdb\u7a0b\u7684\u9875\u76ee\u5f55\u8868\u80fd\u6b63\u786e\u7684\u6620\u5c04\u5185\u6838\u865a\u7a7a\u95f4 return 0 ; } \u6839\u636e\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u7684\u8d77\u59cb\u4f4d\u7f6e\u6765\u89e3\u6790\u6b64ELF\u683c\u5f0f\u7684\u6267\u884c\u7a0b\u5e8f\uff0c\u5e76\u8c03\u7528mm_map\u51fd\u6570\u6839\u636eELF\u683c\u5f0f\u7684\u6267\u884c\u7a0b\u5e8f\u8bf4\u660e\u7684\u5404\u4e2a\u6bb5\uff08\u4ee3\u7801\u6bb5\u3001\u6570\u636e\u6bb5\u3001BSS\u6bb5\u7b49\uff09\u7684\u8d77\u59cb\u4f4d\u7f6e\u548c\u5927\u5c0f\u5efa\u7acb\u5bf9\u5e94\u7684vma\u7ed3\u6784\uff0c\u5e76\u628avma\u63d2\u5165\u5230mm\u7ed3\u6784\u4e2d\uff0c\u4ece\u800c\u8868\u660e\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u5408\u6cd5\u7528\u6237\u6001\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff1b mm_map ( mm , ph -> p_va , ph -> p_memsz , vm_flags , NULL ) \u5728ucore\u4e2d\u63cf\u8ff0\u5e94\u7528\u7a0b\u5e8f\u5bf9\u865a\u62df\u5185\u5b58\u201c\u9700\u6c42\u201d\u7684\u6570\u636e\u7ed3\u6784\u662fvma_struct\uff08\u5b9a\u4e49\u5728vmm.h\u4e2d\uff09\uff0c\u4ee5\u53ca\u9488\u5bf9vma_struct\u7684\u51fd\u6570\u64cd\u4f5c\u3002\u8fd9\u91cc\u628a\u4e00\u4e2avma_struct\u7ed3\u6784\u7684\u53d8\u91cf\u7b80\u79f0\u4e3avma\u53d8\u91cf\u3002vma_struct\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a struct vma_struct { // the set of vma using the same PDT struct mm_struct * vm_mm ; uintptr_t vm_start ; // start addr of vma uintptr_t vm_end ; // end addr of vma uint32_t vm_flags ; // flags of vma //linear list link which sorted by start addr of vma list_entry_t list_link ; }; vm_start\u548cvm_end\u63cf\u8ff0\u4e86\u4e00\u4e2a\u8fde\u7eed\u5730\u5740\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u8d77\u59cb\u4f4d\u7f6e\u548c\u7ed3\u675f\u4f4d\u7f6e\uff0c\u8fd9\u4e24\u4e2a\u503c\u90fd\u5e94\u8be5\u662fPGSIZE \u5bf9\u9f50\u7684\uff0c\u800c\u4e14\u63cf\u8ff0\u7684\u662f\u4e00\u4e2a\u5408\u7406\u7684\u5730\u5740\u7a7a\u95f4\u8303\u56f4\uff08\u5373\u4e25\u683c\u786e\u4fdd vm_start < vm_end\u7684\u5173\u7cfb\uff09\uff1blist_link\u662f\u4e00\u4e2a\u53cc\u5411\u94fe\u8868\uff0c\u6309\u7167\u4ece\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u628a\u4e00\u7cfb\u5217\u7528vma_struct\u8868\u793a\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u94fe\u63a5\u8d77\u6765\uff0c\u5e76\u4e14\u8fd8\u8981\u6c42\u8fd9\u4e9b\u94fe\u8d77\u6765\u7684vma_struct\u5e94\u8be5\u662f\u4e0d\u76f8\u4ea4\u7684\uff0c\u5373vma\u4e4b\u95f4\u7684\u5730\u5740\u7a7a\u95f4\u65e0\u4ea4\u96c6\uff1bvm_flags\u8868\u793a\u4e86\u8fd9\u4e2a\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u7684\u5c5e\u6027\uff0c\u76ee\u524d\u7684\u5c5e\u6027\u5305\u62ec\uff1a #define VM_READ 0x00000001 //\u53ea\u8bfb #define VM_WRITE 0x00000002 //\u53ef\u8bfb\u5199 #define VM_EXEC 0x00000004 //\u53ef\u6267\u884c \u8c03\u7528\u6839\u636e\u6267\u884c\u7a0b\u5e8f\u5404\u4e2a\u6bb5\u7684\u5927\u5c0f\u5206\u914d\u7269\u7406\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u6839\u636e\u6267\u884c\u7a0b\u5e8f\u5404\u4e2a\u6bb5\u7684\u8d77\u59cb\u4f4d\u7f6e\u786e\u5b9a\u865a\u62df\u5730\u5740\uff0c\u5e76\u5728\u9875\u8868\u4e2d\u5efa\u7acb\u597d\u7269\u7406\u5730\u5740\u548c\u865a\u62df\u5730\u5740\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u7136\u540e\u628a\u6267\u884c\u7a0b\u5e8f\u5404\u4e2a\u6bb5\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u76f8\u5e94\u7684\u5185\u6838\u865a\u62df\u5730\u5740\u4e2d\uff0c\u81f3\u6b64\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7801\u548c\u6570\u636e\u5df2\u7ecf\u6839\u636e\u7f16\u8bd1\u65f6\u8bbe\u5b9a\u5730\u5740\u653e\u7f6e\u5230\u865a\u62df\u5185\u5b58\u4e2d\u4e86\uff1b \u9700\u8981\u7ed9\u7528\u6237\u8fdb\u7a0b\u8bbe\u7f6e\u7528\u6237\u6808\uff0c\u4e3a\u6b64\u8c03\u7528mm_mmap\u51fd\u6570\u5efa\u7acb\u7528\u6237\u6808\u7684vma\u7ed3\u6784\uff0c\u660e\u786e\u7528\u6237\u6808\u7684\u4f4d\u7f6e\u5728\u7528\u6237\u865a\u7a7a\u95f4\u7684\u9876\u7aef\uff0c\u5927\u5c0f\u4e3a256\u4e2a\u9875\uff0c\u53731MB\uff0c\u5e76\u5206\u914d\u4e00\u5b9a\u6570\u91cf\u7684\u7269\u7406\u5185\u5b58\u4e14\u5efa\u7acb\u597d\u6808\u7684\u865a\u5730\u5740\u2194\u7269\u7406\u5730\u5740\u6620\u5c04\u5173\u7cfb\uff1b \u81f3\u6b64,\u8fdb\u7a0b\u5185\u7684\u5185\u5b58\u7ba1\u7406vma\u548cmm\u6570\u636e\u7ed3\u6784\u5df2\u7ecf\u5efa\u7acb\u5b8c\u6210\uff0c\u4e8e\u662f\u628amm->pgdir\u8d4b\u503c\u5230\u53d8\u91cfcurrent_pgdir\u4e2d\uff0c\u5373\u66f4\u65b0\u4e86\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u6b64\u65f6\u7684initproc\u5df2\u7ecf\u88abhello\u7684\u4ee3\u7801\u548c\u6570\u636e\u8986\u76d6\uff0c\u6210\u4e3a\u4e86\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\uff0c\u4f46\u6b64\u65f6\u8fd9\u4e2a\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u73b0\u573a\u8fd8\u6ca1\u5efa\u7acb\u597d\uff1b \u5148\u6e05\u7a7a\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\uff0c\u518d\u91cd\u65b0\u8bbe\u7f6e\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\uff0c\u4f7f\u5f97\u5728\u6267\u884c\u4e2d\u65ad\u8fd4\u56de\u6307\u4ee4\u540e\uff0c\u80fd\u591f\u8ba9CPU\u8f6c\u5230\u7528\u6237\u6001\u7279\u6743\u7ea7\uff0c\u5e76\u56de\u5230\u7528\u6237\u6001\u5185\u5b58\u7a7a\u95f4\uff0c\u4e14\u80fd\u591f\u8df3\u8f6c\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u6267\u884c\uff0c\u5e76\u786e\u4fdd\u5728\u7528\u6237\u6001\u80fd\u591f\u54cd\u5e94\u4e2d\u65ad\uff1b \u8fd9\u4e00\u6b65\u6d89\u53ca\u7ec3\u4e601\u4e2d\u9700\u8981\u8865\u5145\u7684\u4ee3\u7801\u3002\u5982\u4e0b\u6240\u793a\uff1a #ifdef LAB3_EX1 /* LAB3:EXERCISE1 YOUR CODE * should set tf_era,tf_regs.reg_r[LOONGARCH_REG_SP],tf->tf_prmd * NOTICE: If we set trapframe correctly, then the user level process can return to USER MODE from kernel and enable interrupt. So * tf->tf_prmd should be PLV_USER | CSR_CRMD_IE * tf->tf_era should be the entry point of this binary program (elf->e_entry) * tf->tf_regs.reg_r[LOONGARCH_REG_SP] should be the top addr of user stack (USTACKTOP) */ // \u6839\u636e\u63d0\u793a\u8865\u5145\u4ee3\u7801\uff0c\u5b8c\u6210\u7ec3\u4e60\u3002 #endif \u6211\u4eec\u9700\u8981\u8865\u5145\u7684\u4ee3\u7801\u5c31\u662f\u8bbe\u7f6etf_era, tf_regs.regr[LOONGARCH_REG_SP],tf->tf_prmd\u8fd9\u4e09\u4e2a\u53d8\u91cf\u7684\u5185\u5bb9\u3002\u5982\u679c\u6211\u4eec\u6b63\u786e\u5730\u8bbe\u7f6e\u4e86\u4e2d\u65ad\u5e27\u7684\u5185\u5bb9\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u4ee5\u7531\u5185\u6838\u6001\u8f6c\u4e3a\u7528\u6237\u6001\u8fd0\u884c\uff0c\u4e14\u91cd\u65b0\u5f00\u542f\u4e2d\u65ad\u54cd\u5e94\u3002\u4e2d\u65ad\u5e27trapframe\u7684\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b(kern/trap/loongarch_trapframe.h)\uff1a struct trapframe { uint32_t tf_badv ; // CSR[0x7] uint32_t tf_estat ; // CSR[0x5] uint32_t tf_prmd ; // CSR[0x1] uint32_t tf_ra ; struct pushregs tf_regs ; uint32_t tf_era ; // CSR[0x6] same as epc on LOONGARCH }; tf_regs: \u5f53\u8fdb\u7a0b\u4ece\u5185\u6838\u6001\u8f6c\u4e3a\u7528\u6237\u6001\u65f6\uff0c\u8981\u628a\u5806\u6808\u5bc4\u5b58\u5668\u7684\u6808\u6307\u9488($sp)\u6539\u4e3a\u7528\u6237\u6808\u7684\u5730\u5740\uff0c \u5373tf_regs[LOONGARCH_REG_SP]\u5e94\u8bbe\u7f6e\u4e3aUSTACKTOP \u3002 tf_era: \u8868\u793a\u7684\u662f\u4f8b\u5916\u8fd4\u56de\u5730\u5740\uff08\u89e6\u53d1\u4f8b\u5916\u6307\u4ee4\u7684PC\uff09\uff0c\u4e3a\u4e86\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u8df3\u8f6c\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u7b2c\u4e00\u6761\u6307\u4ee4\u6267\u884c\uff0c\u7ec3\u4e601\u4e2d\u7684tf_era\u5e94\u8bbe\u7f6e\u4e3aELF\u6267\u884c\u6587\u4ef6\u8bbe\u5b9a\u7684\u8d77\u59cb\u5730\u5740\uff0c \u5373tf_era\u5e94\u8bbe\u7f6e\u4e3aelf->e_entry \u3002 tf_prmd: CSR[0x1]\u6307\u7684\u662f\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668\u4f8b\u5916\u524d\u6a21\u5f0f\u4fe1\u606f(PRMD)\u7684\u5185\u5bb9(\u53c2\u8003 \u9f99\u82af\u67b6\u678432\u4f4d\u7cbe\u7b80\u7248\u53c2\u8003\u624b\u518c_v1.02.pdf \u4e2dp53)\uff0c\u82e5\u64cd\u4f5c\u7cfb\u7edf\u8981\u4ece\u5185\u6838\u6001\u5207\u6362\u81f3\u7528\u6237\u6001\uff0c\u4e14\u5f00\u542f\u4e2d\u65ad\u54cd\u5e94\uff0c tf_prmd\u5e94\u8bbe\u7f6e\u4e3aPLV_USER | CSR_CRMD_IE \u3002 \u81f3\u6b64\uff0c\u7528\u6237\u8fdb\u7a0b\u7684\u7528\u6237\u73af\u5883\u5df2\u7ecf\u642d\u5efa\u5b8c\u6bd5\u3002\u6b64\u65f6initproc\u5c06\u6309\u4ea7\u751f\u7cfb\u7edf\u8c03\u7528\u7684\u51fd\u6570\u8c03\u7528\u8def\u5f84\u539f\u8def\u8fd4\u56de\uff0c\u6267\u884c\u4e2d\u65ad\u8fd4\u56de\u6307\u4ee4\u201certn\u201d\uff08\u4f4d\u4e8eexception.S\u7684\u6700\u540e\u4e00\u53e5\uff09\u540e\uff0c\u5c06\u5207\u6362\u5230\u7528\u6237\u8fdb\u7a0bhello\u7684\u7b2c\u4e00\u6761\u8bed\u53e5\u4f4d\u7f6e_start\u5904\uff08\u4f4d\u4e8euser/libs/initcode.S\u7684\u7b2c\u4e09\u53e5\uff09\u5f00\u59cb\u6267\u884c\u3002","title":"3. \u521b\u5efa\u5e76\u6267\u884c\u7528\u6237\u8fdb\u7a0b"},{"location":"lab3/intro/#_4","text":"\u5f53\u8fdb\u7a0b\u6267\u884c\u5b8c\u5b83\u7684\u5de5\u4f5c\u540e\uff0c\u5c31\u9700\u8981\u6267\u884c\u9000\u51fa\u64cd\u4f5c\uff0c\u91ca\u653e\u8fdb\u7a0b\u5360\u7528\u7684\u8d44\u6e90\u3002ucore\u5206\u4e86\u4e24\u6b65\u6765\u5b8c\u6210\u8fd9\u4e2a\u5de5\u4f5c\uff0c\u9996\u5148\u7531\u8fdb\u7a0b\u672c\u8eab\u5b8c\u6210\u5927\u90e8\u5206\u8d44\u6e90\u7684\u5360\u7528\u5185\u5b58\u56de\u6536\u5de5\u4f5c\uff0c\u7136\u540e\u7531\u6b64\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u5b8c\u6210\u5269\u4f59\u8d44\u6e90\u5360\u7528\u5185\u5b58\u7684\u56de\u6536\u5de5\u4f5c\u3002 Note \u4e3a\u4f55\u4e0d\u8ba9\u8fdb\u7a0b\u672c\u8eab\u5b8c\u6210\u6240\u6709\u7684\u8d44\u6e90\u56de\u6536\u5de5\u4f5c\u5462\uff1f \u8fd9\u662f\u56e0\u4e3a\u8fdb\u7a0b\u8981\u6267\u884c\u56de\u6536\u64cd\u4f5c\uff0c\u5c31\u8868\u660e\u6b64\u8fdb\u7a0b\u8fd8\u5b58\u5728\uff0c\u8fd8\u5728\u6267\u884c\u6307\u4ee4\uff0c\u8fd9\u5c31\u9700\u8981\u4fdd\u8bc1\u5185\u6838\u6808\u7684\u7a7a\u95f4\u548c\u8868\u793a\u8fdb\u7a0b\u5b58\u5728\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u4e0d\u88ab\u91ca\u653e\uff0c\u6240\u4ee5\u9700\u8981\u7236\u8fdb\u7a0b\u6765\u5e2e\u5fd9\u91ca\u653e\u5b50\u8fdb\u7a0b\u65e0\u6cd5\u5b8c\u6210\u7684\u8fd9\u4e24\u4e2a\u8d44\u6e90\u7684\u56de\u6536\u5de5\u4f5c\u3002 \u4e3a\u5b9e\u73b0\u8fdb\u7a0b\u9000\u51fa\uff0c\u7528\u6237\u6001\u7684\u51fd\u6570\u5e93\u4e2d\u63d0\u4f9b\u4e86exit\u51fd\u6570\uff0c\u6b64\u51fd\u6570\u6700\u7ec8\u8bbf\u95eesys_exit\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u6765\u5e2e\u52a9\u5f53\u524d\u8fdb\u7a0b\u6267\u884c\u9000\u51fa\u8fc7\u7a0b\u4e2d\u7684\u90e8\u5206\u8d44\u6e90\u56de\u6536\u3002\u6211\u4eec\u6765\u770b\u770bucore\u662f\u5982\u4f55\u505a\u8fdb\u7a0b\u9000\u51fa\u5de5\u4f5c\u7684\u3002","title":"\u8fdb\u7a0b\u9000\u51fa\u548c\u7b49\u5f85\u8fdb\u7a0b"},{"location":"lab3/intro/#ucore","text":"\u9996\u5148\uff0cexit\u51fd\u6570\u4f1a\u628a\u4e00\u4e2a\u9000\u51fa\u7801error_code\u4f20\u9012\u7ed9ucore\uff0cucore\u901a\u8fc7\u6267\u884c\u5185\u6838\u51fd\u6570do_exit\u6765\u5b8c\u6210\u5bf9\u5f53\u524d\u8fdb\u7a0b\u7684\u9000\u51fa\u5904\u7406\uff0c\u4e3b\u8981\u5de5\u4f5c\u5c31\u662f\u56de\u6536\u5f53\u524d\u8fdb\u7a0b\u6240\u5360\u7684\u5927\u90e8\u5206\u5185\u5b58\u8d44\u6e90\uff0c\u5e76\u901a\u77e5\u7236\u8fdb\u7a0b\u5b8c\u6210\u6700\u540e\u7684\u56de\u6536\u5de5\u4f5c\u3002\u5177\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a 1. \u5982\u679ccurrent->mm != NULL\uff0c\u8868\u793a\u662f\u7528\u6237\u8fdb\u7a0b\uff0c\u5219\u5f00\u59cb\u56de\u6536\u6b64\u7528\u6237\u8fdb\u7a0b\u6240\u5360\u7528\u7684\u7528\u6237\u6001\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff1b a) \u9996\u5148\u6267\u884c\u201clcr3(boot_cr3)\u201d\uff0c\u5207\u6362\u5230\u5185\u6838\u6001\u7684\u9875\u8868\u4e0a\uff0c\u8fd9\u6837\u5f53\u524d\u7528\u6237\u8fdb\u7a0b\u76ee\u524d\u53ea\u80fd\u5728\u5185\u6838\u865a\u62df\u5730\u5740\u7a7a\u95f4\u6267\u884c\u4e86\uff0c\u8fd9\u662f\u4e3a\u4e86\u786e\u4fdd\u540e\u7eed\u91ca\u653e\u7528\u6237\u6001\u5185\u5b58\u548c\u8fdb\u7a0b\u9875\u8868\u7684\u5de5\u4f5c\u80fd\u591f\u6b63\u5e38\u6267\u884c\uff1b b) \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u6210\u5458\u53d8\u91cfmm\u7684\u6210\u5458\u53d8\u91cfmm_count\u51cf1\u540e\u4e3a0\uff08\u8868\u660e\u8fd9\u4e2amm\u6ca1\u6709\u518d\u88ab\u5176\u4ed6\u8fdb\u7a0b\u5171\u4eab\uff0c\u53ef\u4ee5\u5f7b\u5e95\u91ca\u653e\u8fdb\u7a0b\u6240\u5360\u7684\u7528\u6237\u865a\u62df\u7a7a\u95f4\u4e86\u3002\uff09\uff0c\u5219\u5f00\u59cb\u56de\u6536\u7528\u6237\u8fdb\u7a0b\u6240\u5360\u7684\u5185\u5b58\u8d44\u6e90\uff1a i. \u8c03\u7528exit_mmap\u51fd\u6570\u91ca\u653ecurrent->mm->vma\u94fe\u8868\u4e2d\u6bcf\u4e2avma\u63cf\u8ff0\u7684\u8fdb\u7a0b\u5408\u6cd5\u7a7a\u95f4\u4e2d\u5b9e\u9645\u5206\u914d\u7684\u5185\u5b58\uff0c\u7136\u540e\u628a\u5bf9\u5e94\u7684\u9875\u8868\u9879\u5185\u5bb9\u6e05\u7a7a\uff0c\u6700\u540e\u8fd8\u628a\u9875\u8868\u6240\u5360\u7528\u7684\u7a7a\u95f4\u91ca\u653e\u5e76\u628a\u5bf9\u5e94\u7684\u9875\u76ee\u5f55\u8868\u9879\u6e05\u7a7a\uff1b ii. \u8c03\u7528put_pgdir\u51fd\u6570\u91ca\u653e\u5f53\u524d\u8fdb\u7a0b\u7684\u9875\u76ee\u5f55\u6240\u5360\u7684\u5185\u5b58\uff1b iii. \u8c03\u7528mm_destroy\u51fd\u6570\u91ca\u653emm\u4e2d\u7684vma\u6240\u5360\u5185\u5b58\uff0c\u6700\u540e\u91ca\u653emm\u6240\u5360\u5185\u5b58\uff1b c) \u6b64\u65f6\u8bbe\u7f6ecurrent->mm\u4e3aNULL\uff0c\u8868\u793a\u4e0e\u5f53\u524d\u8fdb\u7a0b\u76f8\u5173\u7684\u7528\u6237\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u548c\u5bf9\u5e94\u7684\u5185\u5b58\u7ba1\u7406\u6210\u5458\u53d8\u91cf\u6240\u5360\u7684\u5185\u6838\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u5df2\u7ecf\u56de\u6536\u5b8c\u6bd5\uff1b 2. \u8fd9\u65f6\uff0c\u8bbe\u7f6e\u5f53\u524d\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001current->state=PROC_ZOMBIE\uff0c\u5f53\u524d\u8fdb\u7a0b\u7684\u9000\u51fa\u7801current->exit_code=error_code\u3002\u6b64\u65f6\u5f53\u524d\u8fdb\u7a0b\u5df2\u7ecf\u4e0d\u80fd\u88ab\u8c03\u5ea6\u4e86\uff0c\u9700\u8981\u6b64\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u6765\u505a\u6700\u540e\u7684\u56de\u6536\u5de5\u4f5c\uff08\u5373\u56de\u6536\u63cf\u8ff0\u6b64\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u8fdb\u7a0b\u63a7\u5236\u5757\uff09\uff1b 3. \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0bcurrent->parent\u5904\u4e8e\u7b49\u5f85\u5b50\u8fdb\u7a0b\u72b6\u6001\uff1a current->parent->wait_state==WT_CHILD\uff0c \u5219\u5524\u9192\u7236\u8fdb\u7a0b\uff08\u5373\u6267\u884c\u201cwakup_proc(current->parent)\u201d\uff09\uff0c\u8ba9\u7236\u8fdb\u7a0b\u5e2e\u52a9\u81ea\u5df1\u5b8c\u6210\u6700\u540e\u7684\u8d44\u6e90\u56de\u6536\uff1b 4. \u5982\u679c\u5f53\u524d\u8fdb\u7a0b\u8fd8\u6709\u5b50\u8fdb\u7a0b\uff0c\u5219\u9700\u8981\u628a\u8fd9\u4e9b\u5b50\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\u6307\u9488\u8bbe\u7f6e\u4e3a\u5185\u6838\u7ebf\u7a0binitproc\uff0c\u4e14\u5404\u4e2a\u5b50\u8fdb\u7a0b\u6307\u9488\u9700\u8981\u63d2\u5165\u5230initproc\u7684\u5b50\u8fdb\u7a0b\u94fe\u8868\u4e2d\u3002\u5982\u679c\u67d0\u4e2a\u5b50\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u662fPROC_ZOMBIE\uff0c\u5219\u9700\u8981\u5524\u9192initproc\u6765\u5b8c\u6210\u5bf9\u6b64\u5b50\u8fdb\u7a0b\u7684\u6700\u540e\u56de\u6536\u5de5\u4f5c\u3002 5. \u6267\u884cschedule()\u51fd\u6570\uff0c\u9009\u62e9\u65b0\u7684\u8fdb\u7a0b\u6267\u884c\u3002","title":"ucore\u662f\u5982\u4f55\u505a\u8fdb\u7a0b\u9000\u51fa\u5de5\u4f5c\u7684"},{"location":"lab3/intro/#_5","text":"\u8fd9\u8981\u6c42\u7236\u8fdb\u7a0b\u8981\u6267\u884cwait\u7528\u6237\u51fd\u6570\u6216wait_pid\u7528\u6237\u51fd\u6570\uff0c\u8fd9\u4e24\u4e2a\u51fd\u6570\u7684\u533a\u522b\u662f\uff0cwait\u51fd\u6570\u7b49\u5f85\u4efb\u610f\u5b50\u8fdb\u7a0b\u7684\u7ed3\u675f\u901a\u77e5\uff0c\u800cwait_pid\u51fd\u6570\u7b49\u5f85\u8fdb\u7a0bid\u53f7\u4e3apid\u7684\u5b50\u8fdb\u7a0b\u7ed3\u675f\u901a\u77e5\u3002\u8fd9\u4e24\u4e2a\u51fd\u6570\u6700\u7ec8\u8bbf\u95eesys_wait\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u8ba9ucore\u6765\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b\u7684\u6700\u540e\u56de\u6536\u5de5\u4f5c\uff0c\u5373\u56de\u6536\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u548c\u8fdb\u7a0b\u63a7\u5236\u5757\u6240\u5360\u5185\u5b58\u7a7a\u95f4\uff0c\u5177\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a 1. \u5982\u679cpid!=0\uff0c\u8868\u793a\u53ea\u627e\u4e00\u4e2a\u8fdb\u7a0bid\u53f7\u4e3apid\u7684\u9000\u51fa\u72b6\u6001\u7684\u5b50\u8fdb\u7a0b\uff0c\u5426\u5219\u627e\u4efb\u610f\u4e00\u4e2a\u5904\u4e8e\u9000\u51fa\u72b6\u6001\u7684\u5b50\u8fdb\u7a0b\uff1b 2. \u5982\u679c\u6b64\u5b50\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u4e0d\u4e3aPROC_ZOMBIE\uff0c\u8868\u660e\u6b64\u5b50\u8fdb\u7a0b\u8fd8\u6ca1\u6709\u9000\u51fa\uff0c\u5219\u5f53\u524d\u8fdb\u7a0b\uff08\u5373\u5b50\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\uff09\u53ea\u597d\u8bbe\u7f6e\u81ea\u5df1\u7684\u6267\u884c\u72b6\u6001\u4e3aPROC_SLEEPING\uff0c\u7761\u7720\u539f\u56e0\u4e3aWT_CHILD\uff08\u5373\u7b49\u5f85\u5b50\u8fdb\u7a0b\u9000\u51fa\uff09\uff0c\u8c03\u7528schedule()\u51fd\u6570\u9009\u62e9\u65b0\u7684\u8fdb\u7a0b\u6267\u884c\uff0c\u81ea\u5df1\u7761\u7720\u7b49\u5f85\uff0c\u5982\u679c\u88ab\u5524\u9192\uff0c\u5219\u91cd\u590d\u8df3\u56de\u6b65\u9aa41\u5904\u6267\u884c\uff1b 3. \u5982\u679c\u6b64\u5b50\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u4e3aPROC_ZOMBIE\uff0c\u8868\u660e\u6b64\u5b50\u8fdb\u7a0b\u5904\u4e8e\u9000\u51fa\u72b6\u6001\uff0c\u9700\u8981\u5f53\u524d\u8fdb\u7a0b\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b\u7684\u6700\u7ec8\u56de\u6536\u5de5\u4f5c\uff0c\u5373\u9996\u5148\u628a\u5b50\u8fdb\u7a0b\u63a7\u5236\u5757\u4ece\u4e24\u4e2a\u8fdb\u7a0b\u961f\u5217proc_list\u548chash_list\u4e2d\u5220\u9664\uff0c\u5e76\u91ca\u653e\u5b50\u8fdb\u7a0b\u7684\u5185\u6838\u5806\u6808\u548c\u8fdb\u7a0b\u63a7\u5236\u5757\u3002\u81ea\u6b64\uff0c\u5b50\u8fdb\u7a0b\u624d\u5f7b\u5e95\u5730\u7ed3\u675f\u4e86\u5b83\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u6d88\u9664\u4e86\u5b83\u6240\u5360\u7528\u7684\u6240\u6709\u8d44\u6e90\u3002","title":"\u7236\u8fdb\u7a0b\u5982\u4f55\u5b8c\u6210\u5bf9\u5b50\u8fdb\u7a0b\u7684\u6700\u540e\u56de\u6536\u5de5\u4f5c"},{"location":"lab3/intro/#_6","text":"\u7cfb\u7edf\u8c03\u7528\u7684\u82f1\u6587\u540d\u5b57\u662fSystem Call\u3002\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u4ec0\u4e48\u9700\u8981\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u5462\uff1f\u5176\u5b9e\u8fd9\u662f\u5b9e\u73b0\u4e86\u7528\u6237\u8fdb\u7a0b\u540e\uff0c\u81ea\u7136\u5f15\u7533\u51fa\u6765\u9700\u8981\u5b9e\u73b0\u7684\u64cd\u4f5c\u7cfb\u7edf\u529f\u80fd\u3002\u7528\u6237\u8fdb\u7a0b\u53ea\u80fd\u5728\u64cd\u4f5c\u7cfb\u7edf\u7ed9\u5b83\u5708\u5b9a\u597d\u7684\u201c\u7528\u6237\u73af\u5883\u201d\u4e2d\u6267\u884c\uff0c\u4f46\u201c\u7528\u6237\u73af\u5883\u201d\u9650\u5236\u4e86\u7528\u6237\u8fdb\u7a0b\u80fd\u591f\u6267\u884c\u7684\u6307\u4ee4\uff0c\u5373\u7528\u6237\u8fdb\u7a0b\u53ea\u80fd\u6267\u884c\u4e00\u822c\u7684\u6307\u4ee4\uff0c\u65e0\u6cd5\u6267\u884c\u7279\u6743\u6307\u4ee4\u3002\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u60f3\u6267\u884c\u4e00\u4e9b\u9700\u8981\u7279\u6743\u6307\u4ee4\u7684\u4efb\u52a1\uff0c\u6bd4\u5982\u901a\u8fc7\u7f51\u5361\u53d1\u7f51\u7edc\u5305\u7b49\uff0c\u53ea\u80fd\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u6765\u4ee3\u52b3\u4e86\u3002\u4e8e\u662f\u5c31\u9700\u8981\u4e00\u79cd\u673a\u5236\u6765\u786e\u4fdd\u7528\u6237\u8fdb\u7a0b\u4e0d\u80fd\u6267\u884c\u7279\u6743\u6307\u4ee4\uff0c\u4f46\u80fd\u591f\u8bf7\u64cd\u4f5c\u7cfb\u7edf\u201c\u5e2e\u5fd9\u201d\u5b8c\u6210\u9700\u8981\u7279\u6743\u6307\u4ee4\u7684\u4efb\u52a1\uff0c\u8fd9\u79cd\u673a\u5236\u5c31\u662f\u7cfb\u7edf\u8c03\u7528\u3002 \u91c7\u7528\u7cfb\u7edf\u8c03\u7528\u673a\u5236\u4e3a\u7528\u6237\u8fdb\u7a0b\u63d0\u4f9b\u4e00\u4e2a\u83b7\u5f97\u64cd\u4f5c\u7cfb\u7edf\u670d\u52a1\u7684\u7edf\u4e00\u63a5\u53e3\u5c42\uff0c\u8fd9\u6837\u4e00\u6765\u53ef\u7b80\u5316\u7528\u6237\u8fdb\u7a0b\u7684\u5b9e\u73b0\uff0c\u628a\u4e00\u4e9b\u5171\u6027\u7684\u3001\u7e41\u7410\u7684\u3001\u4e0e\u786c\u4ef6\u76f8\u5173\u3001\u4e0e\u7279\u6743\u6307\u4ee4\u76f8\u5173\u7684\u4efb\u52a1\u653e\u5230\u64cd\u4f5c\u7cfb\u7edf\u5c42\u6765\u5b9e\u73b0\uff0c\u4f46\u63d0\u4f9b\u4e00\u4e2a\u7b80\u6d01\u7684\u63a5\u53e3\u7ed9\u7528\u6237\u8fdb\u7a0b\u8c03\u7528\uff1b\u4e8c\u6765\u8fd9\u5c42\u63a5\u53e3\u4e8b\u5148\u53ef\u89c4\u5b9a\u597d\uff0c\u4e14\u4e25\u683c\u68c0\u67e5\u7528\u6237\u8fdb\u7a0b\u4f20\u9012\u8fdb\u6765\u7684\u53c2\u6570\u548c\u64cd\u4f5c\u7cfb\u7edf\u8981\u8fd4\u56de\u7684\u6570\u636e\uff0c\u4f7f\u5f97\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u7ed9\u7528\u6237\u8fdb\u7a0b\u670d\u52a1\u7684\u540c\u65f6\uff0c\u4fdd\u62a4\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u4f1a\u88ab\u7528\u6237\u8fdb\u7a0b\u7834\u574f\u3002 \u4ece\u786c\u4ef6\u5c42\u9762\u4e0a\u770b\uff0c\u9700\u8981\u786c\u4ef6\u80fd\u591f\u652f\u6301\u5728\u7528\u6237\u6001\u7684\u7528\u6237\u8fdb\u7a0b\u901a\u8fc7\u67d0\u79cd\u673a\u5236\u5207\u6362\u5230\u5185\u6838\u6001\u3002lab1\u8bb2\u8ff0\u4e2d\u65ad\u786c\u4ef6\u652f\u6301\u548c\u8f6f\u4ef6\u5904\u7406\u8fc7\u7a0b\u5176\u5b9e\u5c31\u53ef\u4ee5\u7528\u6765\u5b8c\u6210\u7cfb\u7edf\u8c03\u7528\u6240\u9700\u7684\u8f6f\u786c\u4ef6\u652f\u6301\u3002\u4e0b\u9762\u6211\u4eec\u6765\u770b\u770b\u5982\u4f55\u5728ucore\u4e2d\u5b9e\u73b0\u7cfb\u7edf\u8c03\u7528\u3002","title":"\u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0"},{"location":"lab3/intro/#1_1","text":"\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u521d\u59cb\u5316\u597d\u7cfb\u7edf\u8c03\u7528\u76f8\u5173\u7684\u4e2d\u65ad\u63cf\u8ff0\u7b26\u3001\u4e2d\u65ad\u5904\u7406\u8d77\u59cb\u5730\u5740\u7b49\u540e\uff0c\u8fd8\u9700\u5728\u7528\u6237\u6001\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u521d\u59cb\u5316\u597d\u76f8\u5173\u5de5\u4f5c\uff0c\u7b80\u5316\u5e94\u7528\u7a0b\u5e8f\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u7684\u590d\u6742\u6027\u3002\u4e3a\u6b64\u5728\u7528\u6237\u6001\u5efa\u7acb\u4e86\u4e00\u4e2a\u4e2d\u95f4\u5c42\uff0c\u5373\u7b80\u5316\u7684libc\u5b9e\u73b0\uff0c\u5728user/libs/ulib.[ch]\u548cuser/libs/syscall.[ch]\u4e2d\u5b8c\u6210\u4e86\u5bf9\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u7684\u5c01\u88c5\u3002\u7528\u6237\u6001\u6700\u7ec8\u7684\u8bbf\u95ee\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u662fsyscall\uff0c\u5b9e\u73b0\u5982\u4e0b\uff1a static inline int syscall(int num, ...) { va_list ap; va_start(ap, num); uint32_t arg[MAX_ARGS]; int i, ret; for (i = 0; i < MAX_ARGS; i ++) { arg[i] = va_arg(ap, uint32_t); } va_end(ap); num += SYSCALL_BASE; asm volatile( \"move $a7, %1;\\n\" /* syscall no. */ \"move $a0, %2;\\n\" \"move $a1, %3;\\n\" \"move $a2, %4;\\n\" \"move $a3, %5;\\n\" \"syscall 0;\\n\" \"move %0, $a7;\\n\" : \"=r\"(ret) : \"r\"(num), \"r\"(arg[0]), \"r\"(arg[1]), \"r\"(arg[2]), \"r\"(arg[3]) : \"a0\", \"a1\", \"a2\", \"a3\", \"a7\" ); return ret; }","title":"1. \u5efa\u7acb\u7cfb\u7edf\u8c03\u7528\u7684\u7528\u6237\u5e93\u51c6\u5907"},{"location":"lab3/intro/#2_1","text":"\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u4e0e\u8fdb\u7a0b\u76f8\u5173\u7684\u5404\u4e2a\u7cfb\u7edf\u8c03\u7528\u5c5e\u6027\u5982\u4e0b\u8868\u6240\u793a\uff0c\u901a\u8fc7\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\uff0c\u53ef\u65b9\u4fbf\u5730\u5b8c\u6210\u4ece\u8fdb\u7a0b/\u7ebf\u7a0b\u521b\u5efa\u5230\u9000\u51fa\u7684\u6574\u4e2a\u8fd0\u884c\u8fc7\u7a0b\u3002 \u7cfb\u7edf\u8c03\u7528\u540d \u542b\u4e49 \u5177\u4f53\u5b8c\u6210\u670d\u52a1\u7684\u51fd\u6570 SYS_exit process exit do_exit SYS_fork create child process, dup mm do_fork\u2192wakeup_proc SYS_wait wait child process do_wait SYS_exec after fork, process execute a new program load a program and refresh the mm SYS_yield process flag itself need resecheduling proc->need_sched=1, then scheduler will rescheule this process SYS_kill kill process do_kill\u2192proc->flags |= PF_EXITING, \u2192wakeup_proc\u2192do_wait\u2192do_exit SYS_getpid get the process's pid","title":"2. \u4e0e\u7528\u6237\u8fdb\u7a0b\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528"},{"location":"lab3/intro/#3_1","text":"\u4e0e\u7528\u6237\u6001\u7684\u51fd\u6570\u5e93\u8c03\u7528\u6267\u884c\u8fc7\u7a0b\u76f8\u6bd4\uff0c\u7cfb\u7edf\u8c03\u7528\u6267\u884c\u8fc7\u7a0b\u7684\u6709\u56db\u70b9\u4e3b\u8981\u7684\u4e0d\u540c\uff1a \u901a\u8fc7\u201csyscall\u201d\u6307\u4ee4\u53d1\u8d77\u8c03\u7528\uff1b \u901a\u8fc7\u201certn\u201d\u6307\u4ee4\u5b8c\u6210\u8c03\u7528\u8fd4\u56de\uff1b \u5f53\u5230\u8fbe\u5185\u6838\u6001\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u4e25\u683c\u68c0\u67e5\u7cfb\u7edf\u8c03\u7528\u4f20\u9012\u7684\u53c2\u6570\uff0c\u786e\u4fdd\u4e0d\u7834\u574f\u6574\u4e2a\u7cfb\u7edf\u7684\u5b89\u5168\u6027\uff1b \u6267\u884c\u7cfb\u7edf\u8c03\u7528\u53ef\u5bfc\u81f4\u8fdb\u7a0b\u7b49\u5f85\u67d0\u4e8b\u4ef6\u53d1\u751f\uff0c\u4ece\u800c\u53ef\u5f15\u8d77\u8fdb\u7a0b\u5207\u6362\uff1b \u4e0b\u9762\u6211\u4eec\u4ee5getpid\u7cfb\u7edf\u8c03\u7528\u7684\u6267\u884c\u8fc7\u7a0b\u5927\u81f4\u770b\u770b\u64cd\u4f5c\u7cfb\u7edf\u662f\u5982\u4f55\u5b8c\u6210\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\u7684\u3002\u5f53\u7528\u6237\u8fdb\u7a0b\u8c03\u7528getpid\u51fd\u6570\uff0c\u6700\u7ec8\u6267\u884c\u5230\u201csyscall\u201d\u6307\u4ee4\u540e\uff0cCPU\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u5efa\u7acb\u7684\u7cfb\u7edf\u8c03\u7528\u4e2d\u65ad\u63cf\u8ff0\u7b26\uff0c\u8f6c\u5165\u5185\u6838\u6001\uff0c\u5e76\u8df3\u8f6c\u5230exception13\u5904\uff08kern/trap/exception.S\uff09\uff0c\u5f00\u59cb\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u7cfb\u7edf\u8c03\u7528\u6267\u884c\u8fc7\u7a0b\uff0c\u51fd\u6570\u8c03\u7528\u548c\u8fd4\u56de\u64cd\u4f5c\u7684\u5173\u7cfb\u5982\u4e0b\u6240\u793a\uff1a exception13(exception.S)--> _\\loongarch_trap(trap.c)-->trap_dispatch(trap.c)-- -->syscall(syscall.c)-->sys_getpid(syscall.c)-->\u2026\u2026-->_\\exception_return(exception.S) \u5728\u6267\u884ctrap\u51fd\u6570\u524d\uff0c\u8f6f\u4ef6\u8fd8\u9700\u8fdb\u4e00\u6b65\u4fdd\u5b58\u6267\u884c\u7cfb\u7edf\u8c03\u7528\u524d\u7684\u6267\u884c\u73b0\u573a\uff0c\u628a\u4e0e\u7528\u6237\u8fdb\u7a0b\u7ee7\u7eed\u6267\u884c\u6240\u9700\u7684\u76f8\u5173\u5bc4\u5b58\u5668\u7b49\u5f53\u524d\u5185\u5bb9\u4fdd\u5b58\u5230\u5f53\u524d\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27trapframe\u4e2d\uff08\u6ce8\u610f\uff0c\u5728\u521b\u5efa\u8fdb\u7a0b\u65f6\uff0c\u628a\u8fdb\u7a0b\u7684trapframe\u653e\u5728\u8fdb\u7a0b\u5185\u6838\u6808\u5206\u914d\u7a7a\u95f4\u7684\u9876\u90e8\uff09\u3002\u8f6f\u4ef6\u505a\u7684\u5de5\u4f5c\u5728exception.S\u7684exception_handler\u51fd\u6570\u90e8\u5206\uff1a exception_handler: // Save t0 and t1 csrwr t0, LISA_CSR_KS0 csrwr t1, LISA_CSR_KS1 // Save previous stack pointer in t1 move t1, sp csrwr t1, LISA_CSR_KS2 //t1 saved the vaual of KS2,KS2 saved sp /* Warning: csrwr will bring the old csr register value into rd, not only just write rd to csr register, so you may see the rd changed. It's documented in the manual from loongarch. */ // check if user mode csrrd t0, LISA_CSR_PRMD andi t0, t0, 3 beq t0, zero, 1f /* Coming from user mode - load kernel stack into sp */ la t0, current // current pointer ld.w t0, t0, 0 // proc struct ld.w t0, t0, 12 // kstack pointer addi.w t1, zero, 1 slli.w t1, t1, 13 // KSTACKSIZE=8192=pow(2,13) add.w sp, t0, t1 csrrd t1, LISA_CSR_KS2 1: //saved EXST to t0 for save EXST to sp later(line 114) csrrd t0, LISA_CSR_EXST //return KS2 csrrd t1, LISA_CSR_KS2 b common_exception common_exception: /* * At this point: * Interrupts are off. (The processor did this for us.) * t0 contains the exception status(like exception cause on MIPS). * t1 contains the old stack pointer. * sp points into the kernel stack. * All other registers are untouched. */ /* * Allocate stack space for 35 words to hold the trap frame, * plus four more words for a minimal argument block. */ addi.w sp, sp, -156 st.w s8, sp, 148 st.w s7, sp, 144 st.w s6, sp, 140 st.w s5, sp, 136 st.w s4, sp, 132 st.w s3, sp, 128 st.w s2, sp, 124 st.w s1, sp, 120 st.w s0, sp, 116 st.w fp, sp, 112 st.w reserved_reg, sp, 108 st.w t8, sp, 104 st.w t7, sp, 100 st.w t6, sp, 96 st.w t5, sp, 92 st.w t4, sp, 88 st.w t3, sp, 84 st.w t2, sp, 80 //st.w t1, sp, 76 //st.w t0, sp, 72 st.w a7, sp, 68 st.w a6, sp, 64 st.w a5, sp, 60 st.w a4, sp, 56 st.w a3, sp, 52 st.w a2, sp, 48 st.w a1, sp, 44 st.w a0, sp, 40 st.w t1, sp, 36 // replace sp with real sp, now use t1 for free st.w tp, sp, 32 // save real t0 and t1 after real sp (stored in t1 previously) stored csrrd t1, LISA_CSR_KS1 st.w t1, sp, 76 csrrd t1, LISA_CSR_KS0 st.w t1, sp, 72 // replace with real value // save tf_era after t0 and t1 saved csrrd t1, LISA_CSR_EPC st.w t1, sp, 152 /* * Save remaining exception context information. */ // save ra (note: not in pushregs, it's tf_ra) st.w ra, sp, 28 // save prmd csrrd t1, LISA_CSR_PRMD st.w t1, sp, 24 // save estat st.w t0, sp, 20 // now use t0 for free // store badv csrrd t0, LISA_CSR_BADV st.w t0, sp, 16 st.w zero, sp, 12 // support nested interrupt // IE and PLV will automatically set to 0 when trap occur // set trapframe as function argument addi.w a0, sp, 16 li t0, 0xb0 # PLV=0, IE=0, PG=1 csrwr t0, LISA_CSR_CRMD la.abs t0, loongarch_trap jirl ra, t0, 0 //bl loongarch_trap \u2026\u2026 \u81ea\u6b64\uff0c\u7528\u4e8e\u4fdd\u5b58\u7528\u6237\u6001\u7684\u7528\u6237\u8fdb\u7a0b\u6267\u884c\u73b0\u573a\u7684trapframe\u7684\u5185\u5bb9\u586b\u5199\u5b8c\u6bd5\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u5f00\u59cb\u5b8c\u6210\u5177\u4f53\u7684\u7cfb\u7edf\u8c03\u7528\u670d\u52a1\u3002 \u5728sys_getpid\u51fd\u6570\u4e2d\uff0c\u7b80\u5355\u5730\u628a\u5f53\u524d\u8fdb\u7a0b\u7684pid\u6210\u5458\u53d8\u91cf\u505a\u4e3a\u51fd\u6570\u8fd4\u56de\u503c\u5c31\u662f\u4e00\u4e2a\u5177\u4f53\u7684\u7cfb\u7edf\u8c03\u7528\u670d\u52a1\u3002\u5b8c\u6210\u670d\u52a1\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u6309\u8c03\u7528\u5173\u7cfb\u7684\u8def\u5f84\u539f\u8def\u8fd4\u56de\u5230__exception.S\u4e2d\u3002\u7136\u540e\u64cd\u4f5c\u7cfb\u7edf\u5f00\u59cb\u6839\u636e\u5f53\u524d\u8fdb\u7a0b\u7684\u4e2d\u65ad\u5e27\u5185\u5bb9\u505a\u6062\u590d\u6267\u884c\u73b0\u573a\u64cd\u4f5c\u3002\u5176\u5b9e\u5c31\u662f\u628atrapframe\u7684\u4e00\u90e8\u5206\u5185\u5bb9\u4fdd\u5b58\u5230\u5bc4\u5b58\u5668\u5185\u5bb9\u3002\u8fd9\u65f6\u5185\u6838\u6808\u7684\u7ed3\u6784\u5982\u4e0b\uff1a exception_return: // restore prmd ld.w t0, sp, 24 li t1, 7 csrxchg t0, t1, LISA_CSR_PRMD // restore era no k0 and k1 for la32, so must do first ld.w t0, sp, 152 csrwr t0, LISA_CSR_EPC // restore general registers ld.w ra, sp, 28 ld.w tp, sp, 32 //ld.w sp, sp, 36 (do it finally) ld.w a0, sp, 40 ld.w a1, sp, 44 ld.w a2, sp, 48 ld.w a3, sp, 52 ld.w a4, sp, 56 ld.w a5, sp, 60 ld.w a6, sp, 64 ld.w a7, sp, 68 ld.w t0, sp, 72 ld.w t1, sp, 76 ld.w t2, sp, 80 ld.w t3, sp, 84 ld.w t4, sp, 88 ld.w t5, sp, 92 ld.w t6, sp, 96 ld.w t7, sp, 100 ld.w t8, sp, 104 ld.w reserved_reg, sp, 108 ld.w fp, sp, 112 ld.w s0, sp, 116 ld.w s1, sp, 120 ld.w s2, sp, 124 ld.w s3, sp, 128 ld.w s4, sp, 132 ld.w s5, sp, 136 ld.w s6, sp, 140 ld.w s7, sp, 144 ld.w s8, sp, 148 // restore sp ld.w sp, sp, 36 ertn .end exception_return .end common_exception \u8fd9\u65f6\u6267\u884c\u201certn\u201d\u6307\u4ee4\u540e\uff0cCPU\u6839\u636e\u5185\u6838\u6808\u7684\u60c5\u51b5\u6062\u590d\u5230\u7528\u6237\u6001\uff0c\u5373\u201csyscall\u201d\u540e\u7684\u90a3\u6761\u6307\u4ee4\u3002\u8fd9\u6837\u6574\u4e2a\u7cfb\u7edf\u8c03\u7528\u5c31\u6267\u884c\u5b8c\u6bd5\u4e86\u3002 \u81f3\u6b64\uff0c\u5b9e\u9a8c\u4e09\u4e2d\u7684\u4e3b\u8981\u5de5\u4f5c\u63cf\u8ff0\u5b8c\u6bd5\u3002","title":"3. \u7cfb\u7edf\u8c03\u7528\u7684\u6267\u884c\u8fc7\u7a0b"},{"location":"lab3/intro/#a","text":"","title":"\u9644\u5f55 A\uff1a\u7528\u6237\u8fdb\u7a0b\u7684\u7279\u5f81"},{"location":"lab3/intro/#_7","text":"\u5bf9\u4e8e\u5185\u6838\u7ebf\u7a0b\u6765\u8bf4\uff0c\u5b83\u4eec\u4e0d\u9700\u8981\u5728\u7528\u6237\u6001\u6267\u884c\u7528\u6237\u8fdb\u7a0b\u7684\u7ba1\u7406\u673a\u5236\uff0c\u65e2\u65e0\u6cd5\u4f53\u73b0\u7528\u6237\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u4ee5\u53ca\u7528\u6237\u8fdb\u7a0b\u95f4\u5730\u5740\u7a7a\u95f4\u9694\u79bb\u7684\u4fdd\u62a4\u673a\u5236\uff0c\u4e0d\u652f\u6301\u8fdb\u7a0b\u6267\u884c\u8fc7\u7a0b\u7684\u7528\u6237\u6001\u548c\u6838\u5fc3\u6001\u4e4b\u95f4\u7684\u5207\u6362\uff0c\u4e14\u6ca1\u6709\u7528\u6237\u8fdb\u7a0b\u7684\u5b8c\u6574\u72b6\u6001\u53d8\u5316\u7684\u751f\u547d\u5468\u671f\u3002 \u5185\u6838\u7ebf\u7a0b\u7684\u7ba1\u7406 \u5b9e\u73b0\u76f8\u5bf9\u662f\u7b80\u5355\u7684\uff0c\u5176\u7279\u70b9\u662f\u76f4\u63a5\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\uff08\u6bd4\u5982ucore\uff09\u5728\u521d\u59cb\u5316\u4e2d\u5efa\u7acb\u7684\u5185\u6838\u865a\u62df\u5185\u5b58\u5730\u5740\u7a7a\u95f4\uff0c\u4e0d\u540c\u7684\u5185\u6838\u7ebf\u7a0b\u4e4b\u95f4\u53ef\u4ee5\u901a\u8fc7\u8c03\u5ea6\u5668\u5b9e\u73b0\u7ebf\u7a0b\u95f4\u7684\u5207\u6362\uff0c\u8fbe\u5230\u5206\u65f6\u4f7f\u7528CPU\u7684\u76ee\u7684\u3002\u7531\u4e8e\u5185\u6838\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u662f\u4e00\u4e00\u6620\u5c04\u8ba1\u7b97\u673a\u7cfb\u7edf\u7684\u7269\u7406\u7a7a\u95f4\u7684\uff0c\u8fd9\u4f7f\u5f97\u53ef\u7528\u7a7a\u95f4\u7684\u5927\u5c0f\u4e0d\u4f1a\u8d85\u8fc7\u7269\u7406\u7a7a\u95f4\u5927\u5c0f\uff0c\u6240\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u7a0b\u5e8f\u5458\u7f16\u5199\u5185\u6838\u7ebf\u7a0b\u65f6\uff0c\u9700\u8981\u8003\u8651\u5230\u6709\u9650\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u9700\u8981\u4fdd\u8bc1\u5404\u4e2a\u5185\u6838\u7ebf\u7a0b\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u7834\u574f\u64cd\u4f5c\u7cfb\u7edf\u7684\u6b63\u5e38\u8fd0\u884c\u3002\u8fd9\u6837\u5728\u5b9e\u73b0\u5185\u6838\u7ebf\u7a0b\u7ba1\u7406\u65f6\uff0c\u4e0d\u5fc5\u8003\u8651\u6d89\u53ca\u4e0e\u8fdb\u7a0b\u76f8\u5173\u7684\u865a\u62df\u5185\u5b58\u7ba1\u7406\u4e2d\u7684\u7f3a\u9875\u5904\u7406\u3001\u6309\u9700\u5206\u9875\u3001\u5199\u65f6\u590d\u5236\u3001\u9875\u6362\u5165\u6362\u51fa\u7b49\u529f\u80fd\u3002\u5982\u679c\u5728\u5185\u6838\u7ebf\u7a0b\u6267\u884c\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e86\u8bbf\u5b58\u9519\u8bef\u5f02\u5e38\u6216\u5185\u5b58\u4e0d\u591f\u7684\u60c5\u51b5\uff0c\u5c31\u8ba4\u4e3a\u64cd\u4f5c\u7cfb\u7edf\u51fa\u73b0\u9519\u8bef\u4e86\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c06\u76f4\u63a5\u5b95\u673a\u3002\u5728ucore\u4e2d\uff0c\u5c31\u662f\u8c03\u7528panic\u51fd\u6570\uff0c\u8fdb\u5165\u5185\u6838\u8c03\u8bd5\u76d1\u63a7\u5668kernel_debug_monitor\u3002 \u5185\u6838\u7ebf\u7a0b\u7ba1\u7406\u601d\u60f3\u76f8\u5bf9\u7b80\u5355\uff0c\u4f46 \u7f16\u5199\u5185\u6838\u7ebf\u7a0b\u5bf9\u7a0b\u5e8f\u5458\u7684\u8981\u6c42\u5f88\u9ad8 \u3002\u4ece\u7406\u8bba\u4e0a\u8bb2\uff08\u7406\u60f3\u60c5\u51b5\uff09\uff0c\u5982\u679c\u7a0b\u5e8f\u5458\u90fd\u662f\u80fd\u591f\u7f16\u5199\u64cd\u4f5c\u7cfb\u7edf\u7ea7\u522b\u7684\u201c\u9ad8\u624b\u201d\uff0c\u80fd\u591f\u52e4\u4fed\u548c\u9ad8\u6548\u5730\u4f7f\u7528\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u8d44\u6e90\uff0c\u4e14\u8fd9\u4e9b\u201c\u9ad8\u624b\u201d\u90fd\u4e3a\u4ed6\u4eba\u7740\u60f3\uff0c\u5177\u6709\u5949\u732e\u7cbe\u795e\uff0c\u5728\u522b\u7684\u5e94\u7528\u9700\u8981\u8ba1\u7b97\u673a\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u80fd\u591f\u4ece\u5927\u5c40\u51fa\u53d1\uff0c\u4ece\u6574\u4e2a\u7cfb\u7edf\u7684\u6267\u884c\u6548\u7387\u51fa\u53d1\uff0c\u8ba9\u51fa\u81ea\u5df1\u5360\u7528\u7684\u8d44\u6e90\uff0c\u90a3\u8fd9\u4e9b\u201c\u9ad8\u624b\u201d\u7f16\u5199\u51fa\u6765\u7684\u7a0b\u5e8f\u76f4\u63a5\u4f5c\u4e3a\u5185\u6838\u7ebf\u7a0b\u8fd0\u884c\u5373\u53ef\uff0c\u4e5f\u5c31\u6ca1\u6709\u7528\u6237\u8fdb\u7a0b\u5b58\u5728\u7684\u5fc5\u8981\u4e86\u3002 \u4f46\u73b0\u5b9e\u4e0e\u7406\u8bba\u7684\u5dee\u8ddd\u662f\u5de8\u5927\u7684\uff0c\u80fd\u7f16\u5199\u64cd\u4f5c\u7cfb\u7edf\u7684\u7a0b\u5e8f\u5458\u662f\u6781\u5c11\u6570\u7684\uff0c\u4e0e\u5f53\u524d\u7684\u5e94\u7528\u7a0b\u5e8f\u5458\u76f8\u6bd4\uff0c\u4f30\u8ba1\u5927\u7ea6\u5dee\u4e863~4\u4e2a\u6570\u91cf\u7ea7\u3002\u5982\u679c\u8fd8\u8981\u6c42\u7f16\u5199\u64cd\u4f5c\u7cfb\u7edf\u7684\u7a0b\u5e8f\u5458\u8003\u8651\u5176\u4ed6\u672a\u77e5\u7a0b\u5e8f\u5458\u7684\u672a\u77e5\u9700\u6c42\uff0c\u90a3\u8fd9\u6837\u7684\u7a0b\u5e8f\u5458\u4f30\u8ba1\u53ef\u4ee5\u6210\u4e3a\u662f\u7f16\u7a0b\u754c\u7684\u201c\u4e0a\u5e1d\u201d\u4e86\u3002 \u4ece\u5e94\u7528\u7a0b\u5e8f\u7f16\u5199\u548c\u8fd0\u884c\u7684\u89d2\u5ea6\u770b\uff0c\u65e2\u7136\u7a0b\u5e8f\u5458\u90fd\u4e0d\u662f\u201c\u4e0a\u5e1d\u201d\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7a0b\u5e8f\u5458\u5c31\u9700\u8981\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5458\u7f16\u5199\u7684\u7a0b\u5e8f\u63d0\u4f9b\u4e00\u4e2a\u65e2\u201c\u5bbd\u677e\u201d\u53c8\u201c\u4e25\u683c\u201d\u7684\u6267\u884c\u73af\u5883\uff0c\u8ba9\u5bf9\u5185\u5b58\u5927\u5c0f\u548cCPU\u4f7f\u7528\u65f6\u95f4\u7b49\u8d44\u6e90\u7684\u9650\u5236\u6ca1\u6709\u4ed4\u7ec6\u8003\u8651\u7684\u5e94\u7528\u7a0b\u5e8f\u90fd\u80fd\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u6b63\u5e38\u8fd0\u884c\uff0c\u4e14\u5373\u4f7f\u7a0b\u5e8f\u592a\u53ef\u9760\uff0c\u4e5f\u53ea\u80fd\u7834\u574f\u81ea\u5df1\uff0c\u800c\u4e0d\u80fd\u7834\u574f\u5176\u4ed6\u8fd0\u884c\u7a0b\u5e8f\u548c\u6574\u4e2a\u7cfb\u7edf\u3002 \u4e25\u683c \u5c31\u662f\u5b89\u5168\u6027\u4fdd\u8bc1\uff0c\u5373\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u4e0d\u4f1a\u7834\u574f\u5728\u5185\u5b58\u4e2d\u5b58\u5728\u7684\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u548c\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u5b58\u7a7a\u95f4\u7b49\u72ec\u5360\u7684\u8d44\u6e90\uff1b \u5bbd\u677e \u5c31\u7b97\u662f\u65b9\u4fbf\u6027\u652f\u6301\uff0c\u5373\u63d0\u4f9b\u7ed9\u5e94\u7528\u7a0b\u5e8f\u5c3d\u91cf\u4e30\u5bcc\u7684\u670d\u52a1\u529f\u80fd\u548c\u4e00\u4e2a\u8fdc\u5927\u4e8e\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u4f7f\u5f97\u5e94\u7528\u7a0b\u5e8f\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e0d\u5fc5\u8003\u8651\u5f88\u591a\u7e41\u7410\u7684\u7ec6\u8282\uff08\u6bd4\u5982\u5982\u4f55\u521d\u59cb\u5316PCI\u603b\u7ebf\u548c\u5916\u8bbe\u7b49\uff0c\u5982\u4f55\u7ba1\u7406\u7269\u7406\u5185\u5b58\u7b49\uff09\u3002","title":"\u4ece\u5185\u6838\u7ebf\u7a0b\u5230\u7528\u6237\u8fdb\u7a0b"},{"location":"lab3/intro/#_8","text":"\u5728\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u7684\u4ecb\u7ecd\u4e2d\uff0c\u4e00\u822c\u63d0\u5230\u8fdb\u7a0b\u7684\u6982\u5ff5\u5176\u5b9e\u4e3b\u8981\u662f\u6307\u7528\u6237\u8fdb\u7a0b\u3002\u4ece\u64cd\u4f5c\u7cfb\u7edf\u7684\u8bbe\u8ba1\u548c\u5b9e\u73b0\u7684\u89d2\u5ea6\u770b\uff0c\u5176\u5b9e\u7528\u6237\u8fdb\u7a0b\u662f\u6307\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5728\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u4e00\u4e2a\u7528\u6237\u73af\u5883\u4e2d\u7684\u4e00\u6b21\u6267\u884c\u8fc7\u7a0b\u3002\u8fd9\u91cc\u7684\u91cd\u70b9\u662f\u7528\u6237\u73af\u5883\u3002","title":"\u8ba9\u7528\u6237\u8fdb\u7a0b\u6b63\u5e38\u8fd0\u884c\u7684\u7528\u6237\u73af\u5883"},{"location":"lab3/intro/#_9","text":"\u4ece\u529f\u80fd\u4e0a\u770b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u8fd9\u4e2a\u7528\u6237\u73af\u5883\u6709\u4e24\u65b9\u9762\u7684\u7279\u70b9\u3002 \u4e00\u65b9\u9762\u4e0e \u5b58\u50a8\u7a7a\u95f4 \u76f8\u5173\uff0c\u5373\u9650\u5236\u7528\u6237\u8fdb\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u4e14\u8ba9\u5404\u4e2a\u7528\u6237\u8fdb\u7a0b\u4e4b\u95f4\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u8bbf\u95ee\u4e0d\u91cd\u53e0\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u4e0d\u540c\u7528\u6237\u8fdb\u7a0b\u4e4b\u95f4\u4e0d\u80fd\u76f8\u4e92\u7834\u574f\u5404\u81ea\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5229\u7528\u865a\u62df\u5185\u5b58\u7684\u529f\u80fd\uff08\u9875\u6362\u5165\u6362\u51fa\uff09\uff0c\u7ed9\u7528\u6237\u8fdb\u7a0b\u63d0\u4f9b\u4e86\u8fdc\u5927\u4e8e\u5b9e\u9645\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u3002 \u53e6\u4e00\u65b9\u9762\u4e0e \u6267\u884c\u6307\u4ee4 \u76f8\u5173\uff0c\u5373\u9650\u5236\u7528\u6237\u8fdb\u7a0b\u53ef\u6267\u884c\u7684\u6307\u4ee4\uff0c\u4e0d\u80fd\u8ba9\u7528\u6237\u8fdb\u7a0b\u6267\u884c\u7279\u6743\u6307\u4ee4\uff08\u6bd4\u5982\u4fee\u6539\u9875\u8868\u8d77\u59cb\u5730\u5740\uff09\uff0c\u4ece\u800c\u4fdd\u8bc1\u7528\u6237\u8fdb\u7a0b\u65e0\u6cd5\u7834\u574f\u7cfb\u7edf\u3002\u4f46\u5982\u679c\u4e0d\u80fd\u6267\u884c\u7279\u6743\u6307\u4ee4\uff0c\u5219\u5f88\u591a\u529f\u80fd\uff08\u6bd4\u5982\u8bbf\u95ee\u78c1\u76d8\u7b49\uff09\u65e0\u6cd5\u5b9e\u73b0\uff0c\u6240\u4ee5\u9700\u8981\u63d0\u4f9b\u67d0\u79cd\u673a\u5236\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u9700\u8981\u7279\u6743\u6307\u4ee4\u624d\u80fd\u505a\u7684\u5404\u79cd\u670d\u52a1\u529f\u80fd\uff0c\u7ed9\u7528\u6237\u8fdb\u7a0b\u4e00\u4e2a\u201c\u670d\u52a1\u7a97\u53e3\u201d,\u7528\u6237\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u201c\u7a97\u53e3\u201d\u5411\u64cd\u4f5c\u7cfb\u7edf\u63d0\u51fa\u670d\u52a1\u8bf7\u6c42\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u6765\u5e2e\u52a9\u7528\u6237\u8fdb\u7a0b\u5b8c\u6210\u9700\u8981\u7279\u6743\u6307\u4ee4\u624d\u80fd\u505a\u7684\u5404\u79cd\u670d\u52a1\u3002\u53e6\u5916\uff0c\u8fd8\u8981\u6709\u4e00\u4e2a\u201c\u4e2d\u65ad\u7a97\u53e3\u201d\uff0c\u8ba9\u7528\u6237\u8fdb\u7a0b\u4e0d\u4e3b\u52a8\u653e\u5f03\u4f7f\u7528CPU\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u80fd\u591f\u901a\u8fc7\u8fd9\u4e2a\u201c\u4e2d\u65ad\u7a97\u53e3\u201d\u5f3a\u5236\u8ba9\u7528\u6237\u8fdb\u7a0b\u653e\u5f03\u4f7f\u7528CPU\uff0c\u4ece\u800c\u8ba9\u5176\u4ed6\u7528\u6237\u8fdb\u7a0b\u6709\u673a\u4f1a\u6267\u884c\u3002","title":"\u7528\u6237\u73af\u5883\u7684\u529f\u80fd"},{"location":"lab3/intro/#_10","text":"\u57fa\u4e8e\u529f\u80fd\u5206\u6790\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u7528\u6237\u73af\u5883\u5b9a\u4e49\u4e3a\u5982\u4e0b\u7ec4\u6210\u90e8\u5206\uff1a \u5efa\u7acb\u7528\u6237\u865a\u62df\u7a7a\u95f4\u7684\u9875\u8868\u548c\u652f\u6301\u9875\u6362\u5165\u6362\u51fa\u673a\u5236\u7684\u7528\u6237\u5185\u5b58\u8bbf\u5b58\u9519\u8bef\u5f02\u5e38\u670d\u52a1\u4f8b\u7a0b \uff1a\u63d0\u4f9b\u5730\u5740\u9694\u79bb\u548c\u8d85\u8fc7\u7269\u7406\u7a7a\u95f4\u5927\u5c0f\u7684\u865a\u5b58\u7a7a\u95f4\u3002 \u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u7684\u7528\u6237\u6001CPU\u7279\u6743\u7ea7 \uff1a\u5728\u7528\u6237\u6001CPU\u7279\u6743\u7ea7\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ea\u80fd\u6267\u884c\u4e00\u822c\u6307\u4ee4\uff0c\u5bf9\u4e8e\u7279\u6743\u6307\u4ee4\uff0c\u7ed3\u679c\u4e0d\u662f\u65e0\u6548\u5c31\u662f\u4ea7\u751f\u201c\u6267\u884c\u975e\u6cd5\u6307\u4ee4\u201d\u5f02\u5e38\uff1b \u7cfb\u7edf\u8c03\u7528\u673a\u5236 \uff1a\u7ed9\u7528\u6237\u8fdb\u7a0b\u63d0\u4f9b\u201c\u670d\u52a1\u7a97\u53e3\u201d\uff1b \u4e2d\u65ad\u54cd\u5e94\u673a\u5236 \uff1a\u7ed9\u7528\u6237\u8fdb\u7a0b\u8bbe\u7f6e\u201c\u4e2d\u65ad\u7a97\u53e3\u201d\uff0c\u8fd9\u6837\u4ea7\u751f\u4e2d\u65ad\u540e\uff0c\u5f53\u524d\u6267\u884c\u7684\u7528\u6237\u8fdb\u7a0b\u5c06\u88ab\u5f3a\u5236\u6253\u65ad\uff0cCPU\u63a7\u5236\u6743\u5c06\u88ab\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e2d\u65ad\u670d\u52a1\u4f8b\u7a0b\u4f7f\u7528\u3002","title":"\u7528\u6237\u73af\u5883\u7684\u7ec4\u6210\u90e8\u5206"},{"location":"lab3/intro/#_11","text":"\u5728\u7528\u6237\u73af\u5883\u4e0b\u8fd0\u884c\u7684\u8fdb\u7a0b\u5c31\u662f\u7528\u6237\u8fdb\u7a0b\u3002\u90a3\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u7531\u4e8e\u67d0\u79cd\u539f\u56e0\u8fdb\u5165\u5185\u6838\u6001\uff0c\u90a3\u5728\u5185\u6838\u6001\u6267\u884c\u7684\u662f\u4ec0\u4e48\u5462\uff1f\u8fd8\u662f\u7528\u6237\u8fdb\u7a0b\u5417\uff1f \u9996\u5148\u5206\u6790\u4e00\u4e0b\u7528\u6237\u8fdb\u7a0b\u8fd9\u6837\u4f1a\u8fdb\u5165\u5185\u6838\u6001\u5462\uff1f\u56de\u987e\u4e00\u4e0blab1\uff0c\u5c31\u53ef\u4ee5\u77e5\u9053\u5f53\u4ea7\u751f\u5916\u8bbe\u4e2d\u65ad\u3001CPU\u6267\u884c\u5f02\u5e38\uff08\u6bd4\u5982\u8bbf\u5b58\u9519\u8bef\uff09\u3001\u9677\u5165\uff08\u7cfb\u7edf\u8c03\u7528\uff09\uff0c\u7528\u6237\u8fdb\u7a0b\u5c31\u4f1a\u5207\u6362\u5230\u5185\u6838\u4e2d\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u6765\u3002\u8868\u9762\u4e0a\u770b\uff0c\u5230\u5185\u6838\u6001\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53d6\u5f97\u4e86CPU\u63a7\u5236\u6743\uff0c\u6240\u4ee5\u73b0\u5728\u6267\u884c\u7684\u5e94\u8be5\u662f\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\uff0c\u7531\u4e8e\u6b64\u65f6CPU\u5904\u4e8e\u6838\u5fc3\u6001\u7279\u6743\u7ea7\uff0c\u6240\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u7684\u6267\u884c\u8fc7\u7a0b\u5c31\u5c31\u5e94\u8be5\u662f\u5185\u6838\u8fdb\u7a0b\u4e86\u3002\u4f46\u662f\u8fd9\u6837\u7406\u89e3\u5ffd\u7565\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u5177\u4f53\u5b9e\u73b0\u3002\u5982\u679c\u8003\u8651\u64cd\u4f5c\u7cfb\u7edf\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u5e94\u8be5\u5982\u679c\u6765\u7406\u89e3\u8fdb\u7a0b\u5462\uff1f \u4ece \u8fdb\u7a0b\u63a7\u5236\u5757 \u7684\u89d2\u5ea6\u770b\uff0c\u5982\u679c\u6267\u884c\u4e86\u8fdb\u7a0b\u6267\u884c\u73b0\u573a\uff08\u4e0a\u4e0b\u6587\uff09\u7684\u5207\u6362\uff0c\u5c31\u8ba4\u4e3a\u5230\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u6267\u884c\u4e86\uff0c\u53ca\u8fdb\u7a0b\u7684\u5206\u754c\u70b9\u8bbe\u5b9a\u5728\u6267\u884c\u8fdb\u7a0b\u5207\u6362\u7684\u524d\u540e\u3002\u5230\u5e95\u5207\u6362\u4e86\u4ec0\u4e48\u5462\uff1f\u5176\u5b9e\u53ea\u662f\u5207\u6362\u4e86\u8fdb\u7a0b\u7684\u9875\u8868\u548c\u76f8\u5173\u786c\u4ef6\u5bc4\u5b58\u5668\uff0c\u8fd9\u4e9b\u4fe1\u606f\u90fd\u4fdd\u5b58\u5728\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2d\u7684\u76f8\u5173\u57df\u4e2d\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u4e00\u76f4\u5230\u6267\u884c\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u8fdb\u7a0b\u5207\u6362\u5904\u4e3a\u6b62\u90fd\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u8fc7\u7a0b\uff08\u5176\u4e2d\u6709\u64cd\u4f5c\u7cfb\u7edf\u7684\u90e8\u5206\u4ee3\u7801\u6267\u884c\u8fc7\u8fc7\u7a0b\uff09\uff0c\u5373\u8fdb\u7a0b\u3002\u56e0\u4e3a\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6ca1\u6709\u66f4\u6362\u5230\u53e6\u5916\u4e00\u4e2a\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u8fdb\u7a0b\u7684\u9875\u8868\u548c\u76f8\u5173\u786c\u4ef6\u5bc4\u5b58\u5668\u3002 \u4ece \u6307\u4ee4\u6267\u884c \u7684\u89d2\u5ea6\u770b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e3b\u8981\u529f\u80fd\u662f\u7ed9\u4e0a\u5c42\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\uff0c\u7ba1\u7406\u6574\u4e2a\u8ba1\u7b97\u673a\u7cfb\u7edf\u4e2d\u7684\u8d44\u6e90\u3002\u6240\u4ee5\u64cd\u4f5c\u7cfb\u7edf\u867d\u7136\u662f\u4e00\u4e2a\u8f6f\u4ef6\uff0c\u4f46\u5176\u5b9e\u662f\u4e00\u4e2a\u57fa\u4e8e\u4e8b\u4ef6\u7684\u8f6f\u4ef6\uff0c\u8fd9\u91cc\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u54cd\u5e94\u7684\u4e8b\u4ef6\u5305\u62ec\u4e09\u7c7b\uff1a\u5916\u8bbe\u4e2d\u65ad\u3001CPU\u6267\u884c\u5f02\u5e38\uff08\u6bd4\u5982\u8bbf\u5b58\u9519\u8bef\uff09\u3001\u9677\u5165\uff08\u7cfb\u7edf\u8c03\u7528\uff09\u3002\u5982\u679c\u7528\u6237\u8fdb\u7a0b\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u8981\u6c42\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u670d\u52a1\uff0c\u90a3\u4e48\u4ece\u7528\u6237\u8fdb\u7a0b\u7684\u89d2\u5ea6\u770b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c31\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u8f6f\u4ef6\u5e93\uff08\u6bd4\u5982\u76f8\u5bf9\u4e8e\u7528\u6237\u6001\u7684libc\u5e93\uff0c\u64cd\u4f5c\u7cfb\u7edf\u53ef\u770b\u4f5c\u662f\u5185\u6838\u6001\u7684libc\u5e93\uff09\uff0c\u5b8c\u6210\u7528\u6237\u8fdb\u7a0b\u7684\u9700\u6c42\u3002\u4ece\u6267\u884c\u903b\u8f91\u4e0a\u770b\uff0c\u662f\u7528\u6237\u8fdb\u7a0b\u201c\u4e3b\u89c2\u201d\u6267\u884c\u7684\u4e00\u90e8\u5206\uff0c\u5373\u7528\u6237\u8fdb\u7a0b\u201c\u77e5\u9053\u201d\u64cd\u4f5c\u7cfb\u7edf\u8981\u505a\u7684\u4e8b\u60c5\u3002\u90a3\u4e48\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8fdb\u7a0b\u7684\u4ee3\u7801\u7a7a\u95f4\u5305\u62ec\u7528\u6237\u6001\u7684\u6267\u884c\u7a0b\u5e8f\u548c\u5185\u6838\u6001\u54cd\u5e94\u7528\u6237\u8fdb\u7a0b\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u800c\u5728\u6838\u5fc3\u7279\u6743\u6001\u6267\u884c\u670d\u52a1\u8bf7\u6c42\u7684\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\u3002 \u4e3a\u6b64\u8fd9\u79cd\u60c5\u51b5\u4e0b\u7684\u8fdb\u7a0b\u7684\u5185\u5b58\u865a\u62df\u7a7a\u95f4\u4e5f\u5305\u62ec\u4e24\u90e8\u5206\uff1a\u7528\u6237\u6001\u7684\u865a\u5730\u5740\u7a7a\u95f4\u548c\u6838\u5fc3\u6001\u7684\u865a\u5730\u5740\u7a7a\u95f4\u3002\u4f46\u5982\u679c\u6b64\u65f6\u53d1\u751f\u7684\u4e8b\u4ef6\u662f\u5916\u8bbe\u4e2d\u65ad\u548cCPU\u6267\u884c\u5f02\u5e38\uff0c\u867d\u7136CPU\u63a7\u5236\u6743\u4e5f\u8f6c\u5165\u5230\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u4e2d\u65ad\u670d\u52a1\u4f8b\u7a0b\uff0c\u4f46\u8fd9\u4e9b\u5185\u6838\u6267\u884c\u4ee3\u7801\u6267\u884c\u8fc7\u7a0b\u662f\u7528\u6237\u8fdb\u7a0b\u201c\u4e0d\u77e5\u9053\u201d\u7684\uff0c\u662f\u53e6\u5916\u4e00\u6bb5\u6267\u884c\u903b\u8f91\u3002\u90a3\u4e48\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c \u5b9e\u9645\u4e0a\u662f\u6267\u884c\u4e86\u4e24\u6bb5\u76ee\u6807\u4e0d\u540c\u7684\u6267\u884c\u7a0b\u5e8f\uff0c\u4e00\u4e2a\u662f\u4ee3\u8868\u5e94\u7528\u7a0b\u5e8f\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u4e00\u4e2a\u662f\u4ee3\u8868\u4e2d\u65ad\u670d\u52a1\u4f8b\u7a0b\u5904\u7406\u5916\u8bbe\u4e2d\u65ad\u548cCPU\u6267\u884c\u5f02\u5e38\u7684\u5185\u6838\u7ebf\u7a0b \u3002\u8fd9\u4e2a\u7528\u6237\u8fdb\u7a0b\u548c\u5185\u6838\u7ebf\u7a0b\u5728\u4ea7\u751f\u4e2d\u65ad\u6216\u5f02\u5e38\u7684\u65f6\u5019\uff0cCPU\u786c\u4ef6\u5c31\u5b8c\u6210\u4e86\u5b83\u4eec\u4e4b\u95f4\u7684\u6307\u4ee4\u6d41\u5207\u6362\u3002","title":"\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u5206\u6790"},{"location":"lab3/intro/#_12","text":"\u7528\u6237\u8fdb\u7a0b\u5728\u5176\u6267\u884c\u8fc7\u7a0b\u4e2d\u4f1a\u5b58\u5728\u5f88\u591a\u79cd\u4e0d\u540c\u7684\u6267\u884c\u72b6\u6001\uff0c\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\uff0c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u4e00\u822c\u7684\u8fd0\u884c\u72b6\u6001\u6709\u4e94\u79cd\uff1a\u521b\u5efa\uff08new\uff09\u6001\u3001\u5c31\u7eea\uff08ready\uff09\u6001\u3001\u8fd0\u884c\uff08running\uff09\u6001\u3001\u7b49\u5f85\uff08blocked\uff09\u6001\u3001\u9000\u51fa\uff08exit\uff09\u6001\u3002\u5404\u4e2a\u72b6\u6001\u4e4b\u95f4\u4f1a\u7531\u4e8e\u53d1\u751f\u4e86\u67d0\u4e8b\u4ef6\u800c\u8fdb\u884c\u72b6\u6001\u8f6c\u6362\u3002","title":"\u7528\u6237\u8fdb\u7a0b\u7684\u8fd0\u884c\u72b6\u6001\u5206\u6790"},{"location":"lab3/intro/#_13","text":"\u9996\u5148\uff0c\u5728 \u521b\u5efa\uff08new\uff09\u6001 \uff0c\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u8fdb\u7a0b\u7684\u521b\u5efa\u5de5\u4f5c\uff0c\u800c\u4f53\u73b0\u8fdb\u7a0b\u5b58\u5728\u7684\u5c31\u662f\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u6240\u4ee5\u4e00\u65e6\u64cd\u4f5c\u7cfb\u7edf\u521b\u5efa\u4e86\u8fdb\u7a0b\u63a7\u5236\u5757\uff0c\u5219\u53ef\u4ee5\u8ba4\u4e3a\u6b64\u65f6\u8fdb\u7a0b\u5c31\u5df2\u7ecf\u5b58\u5728\u4e86\uff0c\u4f46\u7531\u4e8e\u8fdb\u7a0b\u80fd\u591f\u8fd0\u884c\u7684\u5404\u79cd\u8d44\u6e90\u8fd8\u6ca1\u51c6\u5907\u597d\uff0c\u6240\u4ee5\u6b64\u65f6\u7684\u8fdb\u7a0b\u5904\u4e8e\u521b\u5efa\uff08new\uff09\u6001\u3002 \u521b\u5efa\u4e86\u8fdb\u7a0b\u63a7\u5236\u5757\u540e\uff0c\u8fdb\u7a0b\u5e76\u4e0d\u80fd\u76f4\u63a5\u6267\u884c\uff0c\u8fd8\u9700\u51c6\u5907\u597d\u5404\u79cd\u8d44\u6e90\uff0c\u5982\u679c\u628a\u8fdb\u7a0b\u6267\u884c\u6240\u9700\u8981\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u6267\u884c\u4ee3\u7801\uff0c\u8981\u5904\u7406\u7684\u6570\u636e\u7b49\u90fd\u51c6\u5907\u597d\u4e86\uff0c\u5219\u6b64\u65f6\u8fdb\u7a0b\u5df2\u7ecf\u53ef\u4ee5\u6267\u884c\u4e86\uff0c\u4f46\u8fd8\u6ca1\u6709\u88ab\u64cd\u4f5c\u7cfb\u7edf\u8c03\u5ea6\uff0c\u9700\u8981\u7b49\u5f85\u64cd\u4f5c\u7cfb\u7edf\u9009\u62e9\u8fd9\u4e2a\u8fdb\u7a0b\u6267\u884c\uff0c\u4e8e\u662f\u628a\u8fd9\u4e2a\u505a\u597d\u201c\u6267\u884c\u51c6\u5907\u201d\u7684\u8fdb\u7a0b\u653e\u5165\u5230\u4e00\u4e2a\u961f\u5217\u4e2d\uff0c\u5e76\u53ef\u4ee5\u8ba4\u4e3a\u6b64\u65f6\u8fdb\u7a0b\u5904\u4e8e \u5c31\u7eea\uff08ready\uff09\u6001 \u3002 \u5f53\u64cd\u4f5c\u7cfb\u7edf\u7684\u8c03\u5ea6\u5668\u4ece\u5c31\u7eea\u8fdb\u7a0b\u961f\u5217\u4e2d\u9009\u62e9\u4e86\u4e00\u4e2a\u5c31\u7eea\u8fdb\u7a0b\u540e\uff0c\u901a\u8fc7\u6267\u884c\u8fdb\u7a0b\u5207\u6362\uff0c\u5c31\u8ba9\u8fd9\u4e2a\u88ab\u9009\u4e0a\u7684\u5c31\u7eea\u8fdb\u7a0b\u6267\u884c\u4e86\uff0c\u6b64\u65f6\u8fdb\u7a0b\u5c31\u5904\u4e8e \u8fd0\u884c\uff08running\uff09\u6001 \u4e86\u3002 \u5230\u4e86\u8fd0\u884c\u6001\u540e\uff0c\u4f1a\u51fa\u73b0\u4e09\u79cd\u4e8b\u4ef6\uff1a \u5982\u679c\u8fdb\u7a0b\u9700\u8981\u7b49\u5f85\u67d0\u4e2a\u4e8b\u4ef6\uff08\u6bd4\u5982\u4e3b\u52a8\u7761\u772010\u79d2\u949f\uff0c\u6216\u8fdb\u7a0b\u8bbf\u95ee\u67d0\u4e2a\u5185\u5b58\u7a7a\u95f4\uff0c\u4f46\u6b64\u5185\u5b58\u7a7a\u95f4\u88ab\u6362\u51fa\u5230\u786c\u76d8swap\u5206\u533a\u4e2d\u4e86\uff0c\u8fdb\u7a0b\u4e0d\u5f97\u4e0d\u7b49\u5f85\u64cd\u4f5c\u7cfb\u7edf\u628a\u7f13\u6162\u7684\u786c\u76d8\u4e0a\u7684\u6570\u636e\u91cd\u65b0\u8bfb\u56de\u5230\u5185\u5b58\u4e2d\uff09\uff0c\u90a3\u4e48\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u628aCPU\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\uff0c\u5e76\u628a\u8fdb\u7a0b\u72b6\u6001\u4ece\u8fd0\u884c\uff08running\uff09\u6001\u8f6c\u6362\u4e3a \u7b49\u5f85\uff08blocked\uff09\u6001 \u3002 \u5982\u679c\u7528\u6237\u8fdb\u7a0b\u7684\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u6d41\u7a0b\u6267\u884c\u7ed3\u675f\u4e86\uff0c\u90a3\u4e48\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u628aCPU\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\uff0c\u5e76\u628a\u8fdb\u7a0b\u72b6\u6001\u4ece\u8fd0\u884c\uff08running\uff09\u6001\u8f6c\u6362\u4e3a \u9000\u51fa\uff08exit\uff09\u6001 \uff0c\u5e76\u51c6\u5907\u56de\u6536\u7528\u6237\u8fdb\u7a0b\u5360\u7528\u7684\u5404\u79cd\u8d44\u6e90\uff0c\u5f53\u628a\u8868\u793a\u6574\u4e2a\u8fdb\u7a0b\u5b58\u5728\u7684\u8fdb\u7a0b\u63a7\u5236\u5757\u4e5f\u56de\u6536\u4e86\uff0c\u8fd9\u8fdb\u7a0b\u5c31\u4e0d\u5b58\u5728\u4e86\u3002\u5728\u8fd9\u6574\u4e2a\u56de\u6536\u8fc7\u7a0b\u4e2d\uff0c\u8fdb\u7a0b\u90fd\u5904\u4e8e\u9000\u51fa\uff08exit\uff09\u6001\u3002 Info \u8003\u8651\u5230\u5728\u5185\u5b58\u4e2d\u5b58\u5728\u591a\u4e2a\u5904\u4e8e\u5c31\u7eea(ready)\u6001\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u4f46\u53ea\u6709\u4e00\u4e2aCPU\uff0c\u6240\u4ee5\u4e3a\u4e86\u516c\u5e73\u8d77\u89c1\uff0c \u6bcf\u4e2a\u5c31\u7eea\u6001\u8fdb\u7a0b\u90fd\u53ea\u6709\u6709\u9650\u7684\u65f6\u95f4\u7247\u6bb5 \uff0c\u5f53\u4e00\u4e2a\u8fd0\u884c\u6001\u7684\u8fdb\u7a0b\u7528\u5b8c\u4e86\u5b83\u7684\u65f6\u95f4\u7247\u6bb5\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u5265\u593a\u6b64\u8fdb\u7a0b\u7684CPU\u4f7f\u7528\u6743\uff0c\u5e76\u628a\u6b64\u8fdb\u7a0b\u72b6\u6001\u4ece\u8fd0\u884c\uff08running\uff09\u6001\u8f6c\u6362\u4e3a\u5c31\u7eea\uff08ready\uff09\u6001\uff0c\u6700\u540e\u628aCPU\u7ed9\u5176\u4ed6\u8fdb\u7a0b\u6267\u884c\u3002 \u5982\u679c\u67d0\u4e2a\u5904\u4e8e\u7b49\u5f85\uff08blocked\uff09\u6001\u7684\u8fdb\u7a0b\u6240\u7b49\u5f85\u7684\u4e8b\u4ef6\u4ea7\u751f\u4e86\uff08\u6bd4\u5982\u7761\u7720\u65f6\u95f4\u5230\uff0c\u6216\u9700\u8981\u8bbf\u95ee\u7684\u6570\u636e\u5df2\u7ecf\u4ece\u786c\u76d8\u6362\u5165\u5230\u5185\u5b58\u4e2d\uff09\uff0c\u5219\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u901a\u8fc7\u628a\u7b49\u5f85\u6b64\u4e8b\u4ef6\u7684\u8fdb\u7a0b\u72b6\u6001\u4ece\u7b49\u5f85\uff08blocked\uff09\u6001\u8f6c\u5230 \u5c31\u7eea\uff08ready\uff09\u6001 \u3002\u8fd9\u6837\u8fdb\u7a0b\u7684\u6574\u4e2a\u72b6\u6001\u8f6c\u6362\u5f62\u6210\u4e86\u4e00\u4e2a\u6709\u9650\u72b6\u6001\u81ea\u52a8\u673a\u3002","title":"\u8fdb\u7a0b\u8fd0\u884c\u72b6\u6001\u5982\u4f55\u8f6c\u53d8"},{"location":"lab3/method/","text":"1. \u8865\u5168\u4ee3\u7801 \u00b6 \u6ce8\u610f\u4ee3\u7801\u4e2d\u6709\u201cLAB3\u201d\u7684\u6ce8\u91ca\u7684\u5730\u65b9\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\u90fd\u6709\u201cLAB3\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca\u3002\u540c\u5b66\u4eec\u53ef\u4ee5\u6839\u636e\u4ee3\u7801\u4e2d\u7684\u6ce8\u91ca\u7684\u63d0\u793a\uff0c\u601d\u8003\u7ec3\u4e60\u4e2d\u7684\u95ee\u9898\u6765\u8865\u5168\u4ee3\u7801\u3002 2. Makefile\u4fee\u6539 \u00b6 LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 LAB3 := -DLAB3_EX1 -DLAB3_EX2 #LAB4 := -DLAB4_EX1 -DLAB4_EX2 3. \u7f16\u8bd1\u8fd0\u884c \u00b6 \u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a make clean make make qemu -j 16 \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 chenyu$ make qemu -j 16 (THU.CST) os is loading ... Special kernel symbols: entry 0xA0000120 (phys) etext 0xA0022000 (phys) edata 0xA017C630 (phys) end 0xA017F910 (phys) Kernel executable memory footprint: 1399KB memory management: default_pmm_manager memory map: [A0000000, A2000000] freemem start at: A01C0000 free pages: 00001E40 ## 00000020 check_alloc_page() succeeded! check_pgdir() succeeded! check_boot_pgdir() succeeded! check_slab() succeeded! kmalloc_init() succeeded! check_vma_struct() succeeded! check_pgfault() succeeded! check_vmm() succeeded. sched class: stride_scheduler proc_init succeeded kernel_execve: pid = 2, name = \"exit\". I am the parent. Forking the child... I am parent, fork a child pid 3 I am the parent, waiting now.. I am the child. waitpid 3 ok. exit pass. all user-mode processes have quit. init check memory pass. initproc exit. Lab3 Check Pass!","title":"\u7f16\u8bd1\u65b9\u6cd5"},{"location":"lab3/method/#1","text":"\u6ce8\u610f\u4ee3\u7801\u4e2d\u6709\u201cLAB3\u201d\u7684\u6ce8\u91ca\u7684\u5730\u65b9\uff0c\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\u90fd\u6709\u201cLAB3\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca\u3002\u540c\u5b66\u4eec\u53ef\u4ee5\u6839\u636e\u4ee3\u7801\u4e2d\u7684\u6ce8\u91ca\u7684\u63d0\u793a\uff0c\u601d\u8003\u7ec3\u4e60\u4e2d\u7684\u95ee\u9898\u6765\u8865\u5168\u4ee3\u7801\u3002","title":"1. \u8865\u5168\u4ee3\u7801"},{"location":"lab3/method/#2-makefile","text":"LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 LAB3 := -DLAB3_EX1 -DLAB3_EX2 #LAB4 := -DLAB4_EX1 -DLAB4_EX2","title":"2. Makefile\u4fee\u6539"},{"location":"lab3/method/#3","text":"\u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a make clean make make qemu -j 16 \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 chenyu$ make qemu -j 16 (THU.CST) os is loading ... Special kernel symbols: entry 0xA0000120 (phys) etext 0xA0022000 (phys) edata 0xA017C630 (phys) end 0xA017F910 (phys) Kernel executable memory footprint: 1399KB memory management: default_pmm_manager memory map: [A0000000, A2000000] freemem start at: A01C0000 free pages: 00001E40 ## 00000020 check_alloc_page() succeeded! check_pgdir() succeeded! check_boot_pgdir() succeeded! check_slab() succeeded! kmalloc_init() succeeded! check_vma_struct() succeeded! check_pgfault() succeeded! check_vmm() succeeded. sched class: stride_scheduler proc_init succeeded kernel_execve: pid = 2, name = \"exit\". I am the parent. Forking the child... I am parent, fork a child pid 3 I am the parent, waiting now.. I am the child. waitpid 3 ok. exit pass. all user-mode processes have quit. init check memory pass. initproc exit. Lab3 Check Pass!","title":"3. \u7f16\u8bd1\u8fd0\u884c"},{"location":"lab3/task/","text":"\u5b9e\u9a8c\u4e09\u5c06\u521b\u5efa\u7528\u6237\u8fdb\u7a0b\uff0c\u8ba9\u7528\u6237\u8fdb\u7a0b\u5728\u7528\u6237\u6001\u6267\u884c\uff0c\u4e14\u5728\u9700\u8981ucore\u652f\u6301\u65f6\uff0c\u53ef\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u6765\u8ba9ucore\u63d0\u4f9b\u670d\u52a1\u3002\u4e3a\u6b64\u9700\u8981\u6784\u9020\u51fa\u7b2c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\uff0c\u5e76\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528sys_fork/sys_exec/sys_exit/sys_wait\u6765\u652f\u6301\u8fd0\u884c\u4e0d\u540c\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5b8c\u6210\u5bf9\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u7684\u57fa\u672c\u7ba1\u7406\u3002\u76f8\u5173\u539f\u7406\u4ecb\u7ecd\u53ef\u770b\u9644\u5f55\u3002\u4e3a\u4e86\u5b9e\u73b0\u5b9e\u9a8c\u4e09\u7684\u76ee\u6807\uff0c\u63d0\u4f9b\u4e863\u4e2a\u57fa\u672c\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002 Note \u6ce8\u610f\u4ee3\u7801\u4e2d\u6709\u201cLAB3\u201d\u7684\u6ce8\u91ca\u7684\u5730\u65b9\uff1a\u4ee3\u7801\u4e2d\u6240\u6709\u9700\u8981\u5b8c\u6210\u7684\u5730\u65b9\u90fd\u6709\u201cLAB3\u201d\u548c\u201cYOUR CODE\u201d\u7684\u6ce8\u91ca\u3002 \u7ec3\u4e601: \u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u5e76\u6267\u884c\uff08\u9700\u8981\u7f16\u7801\uff09 \u00b6 do_execve\u51fd\u6570\u8c03\u7528load_icode\uff08\u4f4d\u4e8ekern/process/proc.c\u4e2d\uff09\u6765\u52a0\u8f7d\u5e76\u89e3\u6790\u4e00\u4e2a\u5904\u4e8e\u5185\u5b58\u4e2d\u7684ELF\u6267\u884c\u6587\u4ef6\u683c\u5f0f\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5efa\u7acb\u76f8\u5e94\u7684\u7528\u6237\u5185\u5b58\u7a7a\u95f4\u6765\u653e\u7f6e\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u6bb5\u3001\u6570\u636e\u6bb5\u7b49\uff0c\u4e14\u8981\u8bbe\u7f6e\u597dproc_struct\u7ed3\u6784\u4e2d\u7684\u6210\u5458\u53d8\u91cftrapframe\u4e2d\u7684\u5185\u5bb9\uff0c\u786e\u4fdd\u5728\u6267\u884c\u6b64\u8fdb\u7a0b\u540e\uff0c\u80fd\u591f\u4ece\u5e94\u7528\u7a0b\u5e8f\u8bbe\u5b9a\u7684\u8d77\u59cb\u6267\u884c\u5730\u5740\u5f00\u59cb\u6267\u884c\u3002\u9700\u8bbe\u7f6e\u6b63\u786e\u7684trapframe\u5185\u5bb9\u3002 (1) \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002 (2) \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u63cf\u8ff0\u5f53\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u5e76\u52a0\u8f7d\u4e86\u5e94\u7528\u7a0b\u5e8f\u540e\uff0cCPU\u662f\u5982\u4f55\u8ba9\u8fd9\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6700\u7ec8\u5728\u7528\u6237\u6001\u6267\u884c\u8d77\u6765\u7684\u3002\u5373\u8fd9\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u88abucore\u9009\u62e9\u5360\u7528CPU\u6267\u884c\uff08RUNNING\u6001\uff09\u5230\u5177\u4f53\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7b2c\u4e00\u6761\u6307\u4ee4\u7684\u6574\u4e2a\u7ecf\u8fc7\u3002 \u7ec3\u4e602: \u7236\u8fdb\u7a0b\u590d\u5236\u81ea\u5df1\u7684\u5185\u5b58\u7a7a\u95f4\u7ed9\u5b50\u8fdb\u7a0b\uff08\u9700\u8981\u7f16\u7801\uff09 \u00b6 \u521b\u5efa\u5b50\u8fdb\u7a0b\u7684\u51fd\u6570do_fork\u5728\u6267\u884c\u4e2d\u5c06\u62f7\u8d1d\u5f53\u524d\u8fdb\u7a0b\uff08\u5373\u7236\u8fdb\u7a0b\uff09\u7684\u7528\u6237\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u4e2d\u7684\u5408\u6cd5\u5185\u5bb9\u5230\u65b0\u8fdb\u7a0b\u4e2d\uff08\u5b50\u8fdb\u7a0b\uff09\uff0c\u5b8c\u6210\u5185\u5b58\u8d44\u6e90\u7684\u590d\u5236\u3002\u5177\u4f53\u662f\u901a\u8fc7copy_range\u51fd\u6570\uff08\u4f4d\u4e8ekern/mm/pmm.c\u4e2d\uff09\u5b9e\u73b0\u7684\uff0c\u8bf7\u8865\u5145copy_range\u7684\u5b9e\u73b0\uff0c\u786e\u4fdd\u80fd\u591f\u6b63\u786e\u6267\u884c\u3002 (1) \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u5982\u4f55\u8bbe\u8ba1\u5b9e\u73b0\u201dCopy on Write \u673a\u5236\u201c\uff0c\u7ed9\u51fa\u6982\u8981\u8bbe\u8ba1\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1\u3002\u5e76\u6307\u51fa\u5b9e\u73b0COW\u65f6\u6211\u4eec\u8fd8\u9700\u8981\u6dfb\u52a0\u54ea\u79cd\u5f02\u5e38\u7c7b\u578b\u7684\u5904\u7406\uff1f Note Copy-on-write\uff08\u7b80\u79f0COW\uff09\u7684\u57fa\u672c\u6982\u5ff5\u662f\u6307\u5982\u679c\u6709\u591a\u4e2a\u4f7f\u7528\u8005\u5bf9\u4e00\u4e2a\u8d44\u6e90A\uff08\u6bd4\u5982\u5185\u5b58\u5757\uff09\u8fdb\u884c\u8bfb\u64cd\u4f5c\uff0c\u5219\u6bcf\u4e2a\u4f7f\u7528\u8005\u53ea\u9700\u83b7\u5f97\u4e00\u4e2a\u6307\u5411\u540c\u4e00\u4e2a\u8d44\u6e90A\u7684\u6307\u9488\uff0c\u5c31\u53ef\u4ee5\u8be5\u8d44\u6e90\u4e86\u3002\u82e5\u67d0\u4f7f\u7528\u8005\u9700\u8981\u5bf9\u8fd9\u4e2a\u8d44\u6e90A\u8fdb\u884c\u5199\u64cd\u4f5c\uff0c\u7cfb\u7edf\u4f1a\u5bf9\u8be5\u8d44\u6e90\u8fdb\u884c\u62f7\u8d1d\u64cd\u4f5c\uff0c\u4ece\u800c\u4f7f\u5f97\u8be5\u201c\u5199\u64cd\u4f5c\u201d\u4f7f\u7528\u8005\u83b7\u5f97\u4e00\u4e2a\u8be5\u8d44\u6e90A\u7684\u201c\u79c1\u6709\u201d\u62f7\u8d1d\u2014\u8d44\u6e90B\uff0c\u53ef\u5bf9\u8d44\u6e90B\u8fdb\u884c\u5199\u64cd\u4f5c\u3002\u8be5\u201c\u5199\u64cd\u4f5c\u201d\u4f7f\u7528\u8005\u5bf9\u8d44\u6e90B\u7684\u6539\u53d8\u5bf9\u4e8e\u5176\u4ed6\u7684\u4f7f\u7528\u8005\u800c\u8a00\u662f\u4e0d\u53ef\u89c1\u7684\uff0c\u56e0\u4e3a\u5176\u4ed6\u4f7f\u7528\u8005\u770b\u5230\u7684\u8fd8\u662f\u8d44\u6e90A\u3002 \u6ce8\uff1a\u8be5\u7248\u672c\u7b54\u6848\u4e2d\u5e76\u672a\u5b9e\u73b0COW\u673a\u5236\uff0cfork\u5b9e\u73b0\u4e3a\u590d\u5236\u6574\u5757\u865a\u62df\u5730\u5740\u7a7a\u95f4\u3002 \u7ec3\u4e603: \u9605\u8bfb\u5206\u6790\u6e90\u4ee3\u7801\uff0c\u7406\u89e3\u8fdb\u7a0b\u6267\u884c fork/exec/wait/exit \u7684\u5b9e\u73b0\uff0c\u4ee5\u53ca\u7cfb\u7edf\u8c03\u7528\u7684\u5b9e\u73b0\uff08\u4e0d\u9700\u8981\u7f16\u7801\uff09 \u00b6 (1) \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9 fork/exec/wait/exit\u51fd\u6570\u7684\u5206\u6790\u3002\u5e76\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a (2) \u8bf7\u5206\u6790fork/exec/wait/exit\u5728\u5b9e\u73b0\u4e2d\u662f\u5982\u4f55\u5f71\u54cd\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u7684\uff1f (3)\u8bf7\u7ed9\u51faucore\u4e2d\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u751f\u547d\u5468\u671f\u56fe\uff08\u5305\u62ec\u6267\u884c\u72b6\u6001\uff0c\u6267\u884c\u72b6\u6001\u4e4b\u95f4\u7684\u53d8\u6362\u5173\u7cfb\uff0c\u4ee5\u53ca\u4ea7\u751f\u53d8\u6362\u7684\u4e8b\u4ef6\u6216\u51fd\u6570\u8c03\u7528\uff09 Note \u8865\u5168\u4ee3\u7801\u540e\uff0c\u6267\u884c\uff1amake qemu -j 16\u3002\u5982\u679c\u8f93\u51fa\u7ed3\u679c\u548c\u7f16\u8bd1\u65b9\u6cd5\u4e2d\u7684\u7ed3\u679c\u4e00\u81f4\uff0c\u5219\u57fa\u672c\u6b63\u786e\u3002 \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u5b8c\u6210\u4ee5\u4e0a\u4e09\u4e2a\u7ec3\u4e60\uff0c\u7ed9\u51fa\u7f16\u8bd1\u8fd0\u884c\u540e\u8f93\u51fa\u7ed3\u679c\u7684\u622a\u56fe\u3002\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u5bf9\u6240\u5199\u4ee3\u7801\u8c03\u7528\u7684\u51fd\u6570\u7684\u4f5c\u7528\u52a0\u4ee5\u8bf4\u660e\u3002 \u9700\u63d0\u4ea4\u53ef\u4ee5\u5728\u6211\u4eec\u7ed9\u5b9a\u7684Docker\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528make qemu\u7f16\u8bd1\u5e76\u8fd0\u884c\u7684\u6587\u4ef6\u5939\u7684\u538b\u7f29\u5305\u3002 \u7ec4\u961f\u5206\u5de5\u5efa\u8bae \u00b6 \u5bf9\u4e8e\u4e09\u4eba\u5c0f\u7ec4\uff0c\u5efa\u8bae\u4e00\u4eba\u8d1f\u8d23\u4e00\u4e2a\u7ec3\u4e60\u3002","title":"\u5b9e\u9a8c\u4efb\u52a1"},{"location":"lab3/task/#1","text":"do_execve\u51fd\u6570\u8c03\u7528load_icode\uff08\u4f4d\u4e8ekern/process/proc.c\u4e2d\uff09\u6765\u52a0\u8f7d\u5e76\u89e3\u6790\u4e00\u4e2a\u5904\u4e8e\u5185\u5b58\u4e2d\u7684ELF\u6267\u884c\u6587\u4ef6\u683c\u5f0f\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5efa\u7acb\u76f8\u5e94\u7684\u7528\u6237\u5185\u5b58\u7a7a\u95f4\u6765\u653e\u7f6e\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u6bb5\u3001\u6570\u636e\u6bb5\u7b49\uff0c\u4e14\u8981\u8bbe\u7f6e\u597dproc_struct\u7ed3\u6784\u4e2d\u7684\u6210\u5458\u53d8\u91cftrapframe\u4e2d\u7684\u5185\u5bb9\uff0c\u786e\u4fdd\u5728\u6267\u884c\u6b64\u8fdb\u7a0b\u540e\uff0c\u80fd\u591f\u4ece\u5e94\u7528\u7a0b\u5e8f\u8bbe\u5b9a\u7684\u8d77\u59cb\u6267\u884c\u5730\u5740\u5f00\u59cb\u6267\u884c\u3002\u9700\u8bbe\u7f6e\u6b63\u786e\u7684trapframe\u5185\u5bb9\u3002 (1) \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u7684\u8bbe\u8ba1\u5b9e\u73b0\u8fc7\u7a0b\u3002 (2) \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u63cf\u8ff0\u5f53\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u5e76\u52a0\u8f7d\u4e86\u5e94\u7528\u7a0b\u5e8f\u540e\uff0cCPU\u662f\u5982\u4f55\u8ba9\u8fd9\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6700\u7ec8\u5728\u7528\u6237\u6001\u6267\u884c\u8d77\u6765\u7684\u3002\u5373\u8fd9\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u88abucore\u9009\u62e9\u5360\u7528CPU\u6267\u884c\uff08RUNNING\u6001\uff09\u5230\u5177\u4f53\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7b2c\u4e00\u6761\u6307\u4ee4\u7684\u6574\u4e2a\u7ecf\u8fc7\u3002","title":"\u7ec3\u4e601: \u52a0\u8f7d\u5e94\u7528\u7a0b\u5e8f\u5e76\u6267\u884c\uff08\u9700\u8981\u7f16\u7801\uff09"},{"location":"lab3/task/#2","text":"\u521b\u5efa\u5b50\u8fdb\u7a0b\u7684\u51fd\u6570do_fork\u5728\u6267\u884c\u4e2d\u5c06\u62f7\u8d1d\u5f53\u524d\u8fdb\u7a0b\uff08\u5373\u7236\u8fdb\u7a0b\uff09\u7684\u7528\u6237\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u4e2d\u7684\u5408\u6cd5\u5185\u5bb9\u5230\u65b0\u8fdb\u7a0b\u4e2d\uff08\u5b50\u8fdb\u7a0b\uff09\uff0c\u5b8c\u6210\u5185\u5b58\u8d44\u6e90\u7684\u590d\u5236\u3002\u5177\u4f53\u662f\u901a\u8fc7copy_range\u51fd\u6570\uff08\u4f4d\u4e8ekern/mm/pmm.c\u4e2d\uff09\u5b9e\u73b0\u7684\uff0c\u8bf7\u8865\u5145copy_range\u7684\u5b9e\u73b0\uff0c\u786e\u4fdd\u80fd\u591f\u6b63\u786e\u6267\u884c\u3002 (1) \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u5982\u4f55\u8bbe\u8ba1\u5b9e\u73b0\u201dCopy on Write \u673a\u5236\u201c\uff0c\u7ed9\u51fa\u6982\u8981\u8bbe\u8ba1\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1\u3002\u5e76\u6307\u51fa\u5b9e\u73b0COW\u65f6\u6211\u4eec\u8fd8\u9700\u8981\u6dfb\u52a0\u54ea\u79cd\u5f02\u5e38\u7c7b\u578b\u7684\u5904\u7406\uff1f Note Copy-on-write\uff08\u7b80\u79f0COW\uff09\u7684\u57fa\u672c\u6982\u5ff5\u662f\u6307\u5982\u679c\u6709\u591a\u4e2a\u4f7f\u7528\u8005\u5bf9\u4e00\u4e2a\u8d44\u6e90A\uff08\u6bd4\u5982\u5185\u5b58\u5757\uff09\u8fdb\u884c\u8bfb\u64cd\u4f5c\uff0c\u5219\u6bcf\u4e2a\u4f7f\u7528\u8005\u53ea\u9700\u83b7\u5f97\u4e00\u4e2a\u6307\u5411\u540c\u4e00\u4e2a\u8d44\u6e90A\u7684\u6307\u9488\uff0c\u5c31\u53ef\u4ee5\u8be5\u8d44\u6e90\u4e86\u3002\u82e5\u67d0\u4f7f\u7528\u8005\u9700\u8981\u5bf9\u8fd9\u4e2a\u8d44\u6e90A\u8fdb\u884c\u5199\u64cd\u4f5c\uff0c\u7cfb\u7edf\u4f1a\u5bf9\u8be5\u8d44\u6e90\u8fdb\u884c\u62f7\u8d1d\u64cd\u4f5c\uff0c\u4ece\u800c\u4f7f\u5f97\u8be5\u201c\u5199\u64cd\u4f5c\u201d\u4f7f\u7528\u8005\u83b7\u5f97\u4e00\u4e2a\u8be5\u8d44\u6e90A\u7684\u201c\u79c1\u6709\u201d\u62f7\u8d1d\u2014\u8d44\u6e90B\uff0c\u53ef\u5bf9\u8d44\u6e90B\u8fdb\u884c\u5199\u64cd\u4f5c\u3002\u8be5\u201c\u5199\u64cd\u4f5c\u201d\u4f7f\u7528\u8005\u5bf9\u8d44\u6e90B\u7684\u6539\u53d8\u5bf9\u4e8e\u5176\u4ed6\u7684\u4f7f\u7528\u8005\u800c\u8a00\u662f\u4e0d\u53ef\u89c1\u7684\uff0c\u56e0\u4e3a\u5176\u4ed6\u4f7f\u7528\u8005\u770b\u5230\u7684\u8fd8\u662f\u8d44\u6e90A\u3002 \u6ce8\uff1a\u8be5\u7248\u672c\u7b54\u6848\u4e2d\u5e76\u672a\u5b9e\u73b0COW\u673a\u5236\uff0cfork\u5b9e\u73b0\u4e3a\u590d\u5236\u6574\u5757\u865a\u62df\u5730\u5740\u7a7a\u95f4\u3002","title":"\u7ec3\u4e602: \u7236\u8fdb\u7a0b\u590d\u5236\u81ea\u5df1\u7684\u5185\u5b58\u7a7a\u95f4\u7ed9\u5b50\u8fdb\u7a0b\uff08\u9700\u8981\u7f16\u7801\uff09"},{"location":"lab3/task/#3-forkexecwaitexit","text":"(1) \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7b80\u8981\u8bf4\u660e\u4f60\u5bf9 fork/exec/wait/exit\u51fd\u6570\u7684\u5206\u6790\u3002\u5e76\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a (2) \u8bf7\u5206\u6790fork/exec/wait/exit\u5728\u5b9e\u73b0\u4e2d\u662f\u5982\u4f55\u5f71\u54cd\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u7684\uff1f (3)\u8bf7\u7ed9\u51faucore\u4e2d\u4e00\u4e2a\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u6267\u884c\u72b6\u6001\u751f\u547d\u5468\u671f\u56fe\uff08\u5305\u62ec\u6267\u884c\u72b6\u6001\uff0c\u6267\u884c\u72b6\u6001\u4e4b\u95f4\u7684\u53d8\u6362\u5173\u7cfb\uff0c\u4ee5\u53ca\u4ea7\u751f\u53d8\u6362\u7684\u4e8b\u4ef6\u6216\u51fd\u6570\u8c03\u7528\uff09 Note \u8865\u5168\u4ee3\u7801\u540e\uff0c\u6267\u884c\uff1amake qemu -j 16\u3002\u5982\u679c\u8f93\u51fa\u7ed3\u679c\u548c\u7f16\u8bd1\u65b9\u6cd5\u4e2d\u7684\u7ed3\u679c\u4e00\u81f4\uff0c\u5219\u57fa\u672c\u6b63\u786e\u3002","title":"\u7ec3\u4e603: \u9605\u8bfb\u5206\u6790\u6e90\u4ee3\u7801\uff0c\u7406\u89e3\u8fdb\u7a0b\u6267\u884c fork/exec/wait/exit \u7684\u5b9e\u73b0\uff0c\u4ee5\u53ca\u7cfb\u7edf\u8c03\u7528\u7684\u5b9e\u73b0\uff08\u4e0d\u9700\u8981\u7f16\u7801\uff09"},{"location":"lab3/task/#_1","text":"\u5b8c\u6210\u4ee5\u4e0a\u4e09\u4e2a\u7ec3\u4e60\uff0c\u7ed9\u51fa\u7f16\u8bd1\u8fd0\u884c\u540e\u8f93\u51fa\u7ed3\u679c\u7684\u622a\u56fe\u3002\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u5bf9\u6240\u5199\u4ee3\u7801\u8c03\u7528\u7684\u51fd\u6570\u7684\u4f5c\u7528\u52a0\u4ee5\u8bf4\u660e\u3002 \u9700\u63d0\u4ea4\u53ef\u4ee5\u5728\u6211\u4eec\u7ed9\u5b9a\u7684Docker\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528make qemu\u7f16\u8bd1\u5e76\u8fd0\u884c\u7684\u6587\u4ef6\u5939\u7684\u538b\u7f29\u5305\u3002","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab3/task/#_2","text":"\u5bf9\u4e8e\u4e09\u4eba\u5c0f\u7ec4\uff0c\u5efa\u8bae\u4e00\u4eba\u8d1f\u8d23\u4e00\u4e2a\u7ec3\u4e60\u3002","title":"\u7ec4\u961f\u5206\u5de5\u5efa\u8bae"},{"location":"lab4/compile/","text":"\u7f16\u8bd1\u65b9\u6cd5 \u00b6 Makefile\u4fee\u6539 LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 LAB3 := -DLAB3_EX1 -DLAB3_EX2 LAB4 := -DLAB4_EX1 -DLAB4_EX2 \u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a make make qemu -j 16 \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 chenyu$ make qemu -j 16 ( THU.CST ) os is loading ... Special kernel symbols: entry 0xA00000A0 ( phys ) etext 0xA0021000 ( phys ) edata 0xA0251470 ( phys ) end 0xA0254750 ( phys ) Kernel executable memory footprint: 2254KB memory management: default_pmm_manager memory map: [ A0000000, A2000000 ] freemem start at: A0295000 free pages: 00001D6B ## 00000020 check_alloc_page () succeeded! check_pgdir () succeeded! check_boot_pgdir () succeeded! check_slab () succeeded! kmalloc_init () succeeded! check_vma_struct () succeeded! check_pgfault () succeeded! check_vmm () succeeded. sched class: stride_scheduler proc_init succeeded Initrd: 0xa005d3d0 - 0xa02513cf, size: 0x001f4000, magic: 0x2f8dbe2a ramdisk_init () : initrd found, magic: 0x2f8dbe2a, 0x00000fa0 secs sfs: mount: 'simple file system' ( 318 /182/500 ) vfs: mount disk0. kernel_execve: pid = 2 , name = \"sh\" . user sh is running!!! $","title":"\u7f16\u8bd1\u65b9\u6cd5"},{"location":"lab4/compile/#_1","text":"Makefile\u4fee\u6539 LAB1 := -DLAB1_EX2 -DLAB1_EX3 #-D_SHOW_100_TICKS -D_SHOW_SERIAL_INPUT LAB2 := -DLAB2_EX1 -DLAB2_EX2 -DLAB2_EX3 LAB3 := -DLAB3_EX1 -DLAB3_EX2 LAB4 := -DLAB4_EX1 -DLAB4_EX2 \u7f16\u8bd1\u5e76\u8fd0\u884c\u4ee3\u7801\u7684\u547d\u4ee4\u5982\u4e0b\uff1a make make qemu -j 16 \u8865\u5168\u4ee3\u7801\u540e\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u663e\u793a\u754c\u9762\uff08\u4ec5\u4f9b\u53c2\u8003\uff09 chenyu$ make qemu -j 16 ( THU.CST ) os is loading ... Special kernel symbols: entry 0xA00000A0 ( phys ) etext 0xA0021000 ( phys ) edata 0xA0251470 ( phys ) end 0xA0254750 ( phys ) Kernel executable memory footprint: 2254KB memory management: default_pmm_manager memory map: [ A0000000, A2000000 ] freemem start at: A0295000 free pages: 00001D6B ## 00000020 check_alloc_page () succeeded! check_pgdir () succeeded! check_boot_pgdir () succeeded! check_slab () succeeded! kmalloc_init () succeeded! check_vma_struct () succeeded! check_pgfault () succeeded! check_vmm () succeeded. sched class: stride_scheduler proc_init succeeded Initrd: 0xa005d3d0 - 0xa02513cf, size: 0x001f4000, magic: 0x2f8dbe2a ramdisk_init () : initrd found, magic: 0x2f8dbe2a, 0x00000fa0 secs sfs: mount: 'simple file system' ( 318 /182/500 ) vfs: mount disk0. kernel_execve: pid = 2 , name = \"sh\" . user sh is running!!! $","title":"\u7f16\u8bd1\u65b9\u6cd5"},{"location":"lab4/goals/","text":"\u901a\u8fc7\u5b8c\u6210\u672c\u6b21\u5b9e\u9a8c\uff0c\u5e0c\u671b\u80fd\u8fbe\u5230\u4ee5\u4e0b\u76ee\u6807 \u4e86\u89e3\u57fa\u672c\u7684\u6587\u4ef6\u7cfb\u7edf\u7cfb\u7edf\u8c03\u7528\u7684\u5b9e\u73b0\u65b9\u6cd5\uff1b \u4e86\u89e3\u4e00\u4e2a\u57fa\u4e8e\u7d22\u5f15\u8282\u70b9\u7ec4\u7ec7\u65b9\u5f0f\u7684Simple FS\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\uff1b \u4e86\u89e3\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42-VFS\u7684\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\uff1b","title":"\u5b9e\u9a8c\u76ee\u7684"},{"location":"lab4/intro/","text":"\u6587\u4ef6\u7cfb\u7edf\u8bbe\u8ba1\u4e0e\u5b9e\u73b0 \u00b6 ucore \u6587\u4ef6\u7cfb\u7edf\u603b\u4f53\u4ecb\u7ecd \u00b6 \u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8d1f\u8d23\u7ba1\u7406\u548c\u5b58\u50a8\u53ef\u957f\u671f\u4fdd\u5b58\u6570\u636e\u7684\u8f6f\u4ef6\u529f\u80fd\u6a21\u5757\u79f0\u4e3a\u6587\u4ef6\u7cfb\u7edf\u3002\u5728\u672c\u6b21\u8bd5\u9a8c\u4e2d\uff0c\u4e3b\u8981\u4fa7\u91cd\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbe\u8ba1\u5b9e\u73b0\u548c\u5bf9\u6587\u4ef6\u7cfb\u7edf\u6267\u884c\u6d41\u7a0b\u7684\u5206\u6790\u4e0e\u7406\u89e3\u3002 ucore\u7684\u6587\u4ef6\u7cfb\u7edf\u6a21\u578b\u6e90\u4e8eHavard\u7684OS161\u7684\u6587\u4ef6\u7cfb\u7edf\u548cLinux\u6587\u4ef6\u7cfb\u7edf\u3002\u4f46\u5176\u5b9e\u8fd9\u4e8c\u8005\u90fd\u662f\u6e90\u4e8e\u4f20\u7edf\u7684UNIX\u6587\u4ef6\u7cfb\u7edf\u8bbe\u8ba1\u3002UNIX\u63d0\u51fa\u4e86\u56db\u4e2a\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u6982\u5ff5\uff1a\u6587\u4ef6(file)\u3001\u76ee\u5f55\u9879(dentry)\u3001\u7d22\u5f15\u8282\u70b9(inode)\u548c\u5b89\u88c5\u70b9(mount point)\u3002 \u6587\u4ef6\uff1aUNIX\u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\u53ef\u7406\u89e3\u4e3a\u662f\u4e00\u6709\u5e8f\u5b57\u8282buffer\uff0c\u6587\u4ef6\u90fd\u6709\u4e00\u4e2a\u65b9\u4fbf\u5e94\u7528\u7a0b\u5e8f\u8bc6\u522b\u7684\u6587\u4ef6\u540d\u79f0\uff08\u4e5f\u79f0\u6587\u4ef6\u8def\u5f84\u540d\uff09\u3002\u5178\u578b\u7684\u6587\u4ef6\u64cd\u4f5c\u6709\u8bfb\u3001\u5199\u3001\u521b\u5efa\u548c\u5220\u9664\u7b49\u3002 \u76ee\u5f55\u9879\uff1a\u76ee\u5f55\u9879\u4e0d\u662f\u76ee\u5f55\uff08\u53c8\u79f0\u6587\u4ef6\u8def\u5f84\uff09\uff0c\u800c\u662f\u76ee\u5f55\u7684\u7ec4\u6210\u90e8\u5206\u3002\u5728UNIX\u4e2d\u76ee\u5f55\u88ab\u770b\u4f5c\u4e00\u79cd\u7279\u5b9a\u7684\u6587\u4ef6\uff0c\u800c\u76ee\u5f55\u9879\u662f\u6587\u4ef6\u8def\u5f84\u4e2d\u7684\u4e00\u90e8\u5206\u3002\u5982\u4e00\u4e2a\u6587\u4ef6\u8def\u5f84\u540d\u662f\u201c/test/testfile\u201d\uff0c\u5219\u5305\u542b\u7684\u76ee\u5f55\u9879\u4e3a\uff1a\u6839\u76ee\u5f55\u201c/\u201d\uff0c\u76ee\u5f55\u201ctest\u201d\u548c\u6587\u4ef6\u201ctestfile\u201d\uff0c\u8fd9\u4e09\u4e2a\u90fd\u662f\u76ee\u5f55\u9879\u3002\u4e00\u822c\u800c\u8a00\uff0c\u76ee\u5f55\u9879\u5305\u542b\u76ee\u5f55\u9879\u7684\u540d\u5b57\uff08\u6587\u4ef6\u540d\u6216\u76ee\u5f55\u540d\uff09\u548c\u76ee\u5f55\u9879\u7684\u7d22\u5f15\u8282\u70b9\uff08\u89c1\u4e0b\u9762\u7684\u63cf\u8ff0\uff09\u4f4d\u7f6e\u3002 \u7d22\u5f15\u8282\u70b9\uff1aUNIX\u5c06\u6587\u4ef6\u7684\u76f8\u5173\u5143\u6570\u636e\u4fe1\u606f\uff08\u5982\u8bbf\u95ee\u63a7\u5236\u6743\u9650\u3001\u5927\u5c0f\u3001\u62e5\u6709\u8005\u3001\u521b\u5efa\u65f6\u95f4\u3001\u6570\u636e\u5185\u5bb9\u7b49\u7b49\u4fe1\u606f\uff09\u5b58\u50a8\u5728\u4e00\u4e2a\u5355\u72ec\u7684\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u8be5\u7ed3\u6784\u88ab\u79f0\u4e3a\u7d22\u5f15\u8282\u70b9\u3002 \u5b89\u88c5\u70b9\uff1a\u5728UNIX\u4e2d\uff0c\u6587\u4ef6\u7cfb\u7edf\u88ab\u5b89\u88c5\u5728\u4e00\u4e2a\u7279\u5b9a\u7684\u6587\u4ef6\u8def\u5f84\u4f4d\u7f6e\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u5c31\u662f\u5b89\u88c5\u70b9\u3002\u6240\u6709\u7684\u5df2\u5b89\u88c5\u6587\u4ef6\u7cfb\u7edf\u90fd\u4f5c\u4e3a\u6839\u6587\u4ef6\u7cfb\u7edf\u6811\u4e2d\u7684\u53f6\u5b50\u51fa\u73b0\u5728\u7cfb\u7edf\u4e2d\u3002 \u4e0a\u8ff0\u62bd\u8c61\u6982\u5ff5\u5f62\u6210\u4e86UNIX\u6587\u4ef6\u7cfb\u7edf\u7684\u903b\u8f91\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u9700\u8981\u901a\u8fc7\u4e00\u4e2a\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u67b6\u6784\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\u628a\u4e0a\u8ff0\u4fe1\u606f\u6620\u5c04\u5e76\u50a8\u5b58\u5230\u78c1\u76d8\u4ecb\u8d28\u4e0a\uff0c\u4ece\u800c\u5728\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u78c1\u76d8\u5e03\u5c40\uff08\u5373\u6570\u636e\u5728\u78c1\u76d8\u4e0a\u7684\u7269\u7406\u7ec4\u7ec7\uff09\u4e0a\u5177\u4f53\u4f53\u73b0\u51fa\u4e0a\u8ff0\u62bd\u8c61\u6982\u5ff5\u3002\u6bd4\u5982\u6587\u4ef6\u5143\u6570\u636e\u4fe1\u606f\u5b58\u50a8\u5728\u78c1\u76d8\u5757\u4e2d\u7684\u7d22\u5f15\u8282\u70b9\u4e0a\u3002\u5f53\u6587\u4ef6\u88ab\u8f7d\u5165\u5185\u5b58\u65f6\uff0c\u5185\u6838\u9700\u8981\u4f7f\u7528\u78c1\u76d8\u5757\u4e2d\u7684\u7d22\u5f15\u70b9\u6765\u6784\u9020\u5185\u5b58\u4e2d\u7684\u7d22\u5f15\u8282\u70b9\u3002 ucore\u6a21\u4eff\u4e86UNIX\u7684\u6587\u4ef6\u7cfb\u7edf\u8bbe\u8ba1\uff0cucore\u7684\u6587\u4ef6\u7cfb\u7edf\u67b6\u6784\u4e3b\u8981\u7531\u56db\u90e8\u5206\u7ec4\u6210\uff1a \u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3\u5c42\uff1a\u8be5\u5c42\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4ece\u7528\u6237\u7a7a\u95f4\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u6807\u51c6\u8bbf\u95ee\u63a5\u53e3\u3002\u8fd9\u4e00\u5c42\u8bbf\u95ee\u63a5\u53e3\u8ba9\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u63a5\u53e3\u83b7\u5f97ucore\u5185\u6838\u7684\u6587\u4ef6\u7cfb\u7edf\u670d\u52a1\u3002 \u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\uff1a\u5411\u4e0a\u63d0\u4f9b\u4e00\u4e2a\u4e00\u81f4\u7684\u63a5\u53e3\u7ed9\u5185\u6838\u5176\u4ed6\u90e8\u5206\uff08\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0\u6a21\u5757\u548c\u5176\u4ed6\u5185\u6838\u529f\u80fd\u6a21\u5757\uff09\u8bbf\u95ee\u3002\u5411\u4e0b\u63d0\u4f9b\u4e00\u4e2a\u540c\u6837\u7684\u62bd\u8c61\u51fd\u6570\u6307\u9488\u5217\u8868\u548c\u6570\u636e\u7ed3\u6784\u5c4f\u853d\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u7ec6\u8282\u3002 Simple FS\u6587\u4ef6\u7cfb\u7edf\u5c42\uff1a\u4e00\u4e2a\u57fa\u4e8e\u7d22\u5f15\u65b9\u5f0f\u7684\u7b80\u5355\u6587\u4ef6\u7cfb\u7edf\u5b9e\u4f8b\u3002\u5411\u4e0a\u901a\u8fc7\u5404\u79cd\u5177\u4f53\u51fd\u6570\u5b9e\u73b0\u4ee5\u5bf9\u5e94\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u63d0\u51fa\u7684\u62bd\u8c61\u51fd\u6570\u3002\u5411\u4e0b\u8bbf\u95ee\u5916\u8bbe\u63a5\u53e3 \u5916\u8bbe\u63a5\u53e3\u5c42\uff1a\u5411\u4e0a\u63d0\u4f9bdevice\u8bbf\u95ee\u63a5\u53e3\u5c4f\u853d\u4e0d\u540c\u786c\u4ef6\u7ec6\u8282\u3002\u5411\u4e0b\u5b9e\u73b0\u8bbf\u95ee\u5404\u79cd\u5177\u4f53\u8bbe\u5907\u9a71\u52a8\u7684\u63a5\u53e3\uff0c\u6bd4\u5982disk\u8bbe\u5907\u63a5\u53e3/\u4e32\u53e3\u8bbe\u5907\u63a5\u53e3\u3002 \u5bf9\u7167\u4e0a\u9762\u7684\u5c42\u6b21\u6211\u4eec\u518d\u5927\u81f4\u4ecb\u7ecd\u4e00\u4e0b\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbf\u95ee\u5904\u7406\u8fc7\u7a0b\uff0c\u52a0\u6df1\u5bf9\u6587\u4ef6\u7cfb\u7edf\u7684\u603b\u4f53\u7406\u89e3\u3002\u5047\u5982\u5e94\u7528\u7a0b\u5e8f\u64cd\u4f5c\u6587\u4ef6\uff08\u6253\u5f00/\u521b\u5efa/\u5220\u9664/\u8bfb\u5199\uff09\uff0c\u9996\u5148\u9700\u8981\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u7684\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3\u5c42\u7ed9\u7528\u6237\u7a7a\u95f4\u63d0\u4f9b\u7684\u8bbf\u95ee\u63a5\u53e3\u8fdb\u5165\u6587\u4ef6\u7cfb\u7edf\u5185\u90e8\uff0c\u63a5\u7740\u7531\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u628a\u8bbf\u95ee\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u67d0\u4e00\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\uff08\u6bd4\u5982SFS\u6587\u4ef6\u7cfb\u7edf\uff09\uff0c\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\uff08Simple FS\u6587\u4ef6\u7cfb\u7edf\u5c42\uff09\u628a\u5e94\u7528\u7a0b\u5e8f\u7684\u8bbf\u95ee\u8bf7\u6c42\u8f6c\u5316\u4e3a\u5bf9\u78c1\u76d8\u4e0a\u7684block\u7684\u5904\u7406\u8bf7\u6c42\uff0c\u5e76\u901a\u8fc7\u5916\u8bbe\u63a5\u53e3\u5c42\u4ea4\u7ed9\u78c1\u76d8\u9a71\u52a8\u4f8b\u7a0b\u6765\u5b8c\u6210\u5177\u4f53\u7684\u78c1\u76d8\u64cd\u4f5c\u3002\u7ed3\u5408\u7528\u6237\u6001\u5199\u6587\u4ef6\u51fd\u6570write\u7684\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u6bd4\u8f83\u6e05\u695a\u5730\u770b\u51faucore\u6587\u4ef6\u7cfb\u7edf\u67b6\u6784\u7684\u5c42\u6b21\u548c\u4f9d\u8d56\u5173\u7cfb\u3002 ucore\u6587\u4ef6\u7cfb\u7edf\u603b\u4f53\u7ed3\u6784 \u4eceucore\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u540c\u7684\u89d2\u5ea6\u6765\u770b\uff0cucore\u4e2d\u7684\u6587\u4ef6\u7cfb\u7edf\u67b6\u6784\u5305\u542b\u56db\u7c7b\u4e3b\u8981\u7684\u6570\u636e\u7ed3\u6784, \u5b83\u4eec\u5206\u522b\u662f\uff1a \u8d85\u7ea7\u5757\uff08SuperBlock\uff09\uff0c\u5b83\u4e3b\u8981\u4ece\u6587\u4ef6\u7cfb\u7edf\u7684\u5168\u5c40\u89d2\u5ea6\u63cf\u8ff0\u7279\u5b9a\u6587\u4ef6\u7cfb\u7edf\u7684\u5168\u5c40\u4fe1\u606f\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u6574\u4e2aOS\u7a7a\u95f4\u3002 \u7d22\u5f15\u8282\u70b9\uff08inode\uff09\uff1a\u5b83\u4e3b\u8981\u4ece\u6587\u4ef6\u7cfb\u7edf\u7684\u5355\u4e2a\u6587\u4ef6\u7684\u89d2\u5ea6\u5b83\u63cf\u8ff0\u4e86\u6587\u4ef6\u7684\u5404\u79cd\u5c5e\u6027\u548c\u6570\u636e\u6240\u5728\u4f4d\u7f6e\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u6574\u4e2aOS\u7a7a\u95f4\u3002 \u76ee\u5f55\u9879\uff08dentry\uff09\uff1a\u5b83\u4e3b\u8981\u4ece\u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\u8def\u5f84\u7684\u89d2\u5ea6\u63cf\u8ff0\u4e86\u6587\u4ef6\u8def\u5f84\u4e2d\u7684\u4e00\u4e2a\u7279\u5b9a\u7684\u76ee\u5f55\u9879\uff08\u6ce8\uff1a\u4e00\u7cfb\u5217\u76ee\u5f55\u9879\u5f62\u6210\u76ee\u5f55/\u6587\u4ef6\u8def\u5f84\uff09\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u6574\u4e2aOS\u7a7a\u95f4\u3002\u5bf9\u4e8eSFS\u800c\u8a00\uff0cinode(\u5177\u4f53\u4e3astruct sfs_disk_inode)\u5bf9\u5e94\u4e8e\u7269\u7406\u78c1\u76d8\u4e0a\u7684\u5177\u4f53\u5bf9\u8c61\uff0cdentry\uff08\u5177\u4f53\u4e3astruct sfs_disk_entry\uff09\u662f\u4e00\u4e2a\u5185\u5b58\u5b9e\u4f53\uff0c\u5176\u4e2d\u7684ino\u6210\u5458\u6307\u5411\u5bf9\u5e94\u7684inode number\uff0c\u53e6\u5916\u4e00\u4e2a\u6210\u5458\u662ffile name(\u6587\u4ef6\u540d). \u6587\u4ef6\uff08file\uff09\uff0c\u5b83\u4e3b\u8981\u4ece\u8fdb\u7a0b\u7684\u89d2\u5ea6\u63cf\u8ff0\u4e86\u4e00\u4e2a\u8fdb\u7a0b\u5728\u8bbf\u95ee\u6587\u4ef6\u65f6\u9700\u8981\u4e86\u89e3\u7684\u6587\u4ef6\u6807\u8bc6\uff0c\u6587\u4ef6\u8bfb\u5199\u7684\u4f4d\u7f6e\uff0c\u6587\u4ef6\u5f15\u7528\u60c5\u51b5\u7b49\u4fe1\u606f\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u67d0\u4e00\u5177\u4f53\u8fdb\u7a0b\u3002 \u5982\u679c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u6253\u5f00\u4e86\u4e00\u4e2a\u6587\u4ef6\uff0c\u90a3\u4e48\u5728ucore\u4e2d\u6d89\u53ca\u7684\u76f8\u5173\u6570\u636e\u7ed3\u6784\uff08\u5176\u4e2d\u76f8\u5173\u6570\u636e\u7ed3\u6784\u5c06\u5728\u4e0b\u9762\u5404\u4e2a\u5c0f\u8282\u4e2d\u5c55\u5f00\u53d9\u8ff0\uff09\u548c\u5173\u7cfb\u5982\u4e0b\u56fe\u6240\u793a\uff1a ucore\u4e2d\u6587\u4ef6\u76f8\u5173\u5173\u952e\u6570\u636e\u7ed3\u6784\u53ca\u5176\u5173\u7cfb \u78c1\u76d8\u5757\u8bbe\u5907 \u00b6 \u5728LoongArch32\u7248\u672c\u7684uCore\u4e2d\uff0c\u5176\u78c1\u76d8\u662f\u901a\u8fc7\u4e00\u5757\u5185\u5b58\u8fdb\u884c\u7684\u6a21\u62df\uff0c\u5e76\u65e0\u771f\u5b9e\u7684\u78c1\u76d8\u63a7\u5236\u5668\u786c\u4ef6\u3002\u56e0\u6b64\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u78c1\u76d8\u6570\u636e\u5176\u5b9e\u8fd0\u884c\u5728\u5185\u5b58\u4e2d\u3002\u5728\u7f16\u8bd1uCore\u65f6\uff0cmakefile\u4f1a\u8c03\u7528 tools/mksfs \u5728\u4f60\u7684\u8ba1\u7b97\u673a\u4e0a\u5b8c\u6210SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u683c\u5f0f\u5316\u4ee5\u53ca\u6587\u4ef6\u4e3a\u955c\u50cf\uff0c\u5e76\u94fe\u63a5\u5230 ucore-kernel-initrd \u8fd9\u4e00\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\u4e2d\u3002 \u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3 \u00b6 \u6587\u4ef6\u548c\u76ee\u5f55\u76f8\u5173\u7528\u6237\u5e93\u51fd\u6570 Lab4\u4e2d\u90e8\u5206\u7528\u6237\u5e93\u51fd\u6570\u4e0e\u6587\u4ef6\u7cfb\u7edf\u6709\u5173\uff0c\u6211\u4eec\u5148\u8ba8\u8bba\u5bf9\u5355\u4e2a\u6587\u4ef6\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u7136\u540e\u8ba8\u8bba\u5bf9\u76ee\u5f55\u548c\u6587\u4ef6\u7cfb\u7edf\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\u3002 \u5728\u6587\u4ef6\u64cd\u4f5c\u65b9\u9762\uff0c\u6700\u57fa\u672c\u7684\u76f8\u5173\u51fd\u6570\u662fopen\u3001close\u3001read\u3001write\u3002\u5728\u8bfb\u5199\u4e00\u4e2a\u6587\u4ef6\u4e4b\u524d\uff0c\u9996\u5148\u8981\u7528open\u7cfb\u7edf\u8c03\u7528\u5c06\u5176\u6253\u5f00\u3002open\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u6307\u5b9a\u6587\u4ef6\u7684\u8def\u5f84\u540d\uff0c\u53ef\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\u540d\uff1b\u7b2c\u4e8c\u4e2a\u53c2\u6570\u6307\u5b9a\u6253\u5f00\u7684\u65b9\u5f0f\uff0c\u53ef\u8bbe\u7f6e\u4e3aO_RDONLY\u3001O_WRONLY\u3001O_RDWR\uff0c\u5206\u522b\u8868\u793a\u53ea\u8bfb\u3001\u53ea\u5199\u3001\u53ef\u8bfb\u53ef\u5199\u3002\u5728\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u5b83\u8fd4\u56de\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u5bf9\u6587\u4ef6\u8fdb\u884c\u76f8\u5173\u64cd\u4f5c\u3002\u5728\u4f7f\u7528\u5b8c\u4e00\u4e2a\u6587\u4ef6\u540e\uff0c\u8fd8\u8981\u7528close\u7cfb\u7edf\u8c03\u7528\u628a\u5b83\u5173\u95ed\uff0c\u5176\u53c2\u6570\u5c31\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u3002\u8fd9\u6837\u5b83\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u5c31\u53ef\u4ee5\u7a7a\u51fa\u6765\uff0c\u7ed9\u522b\u7684\u6587\u4ef6\u4f7f\u7528\u3002 \u8bfb\u5199\u6587\u4ef6\u5185\u5bb9\u7684\u7cfb\u7edf\u8c03\u7528\u662fread\u548cwrite\u3002read\u7cfb\u7edf\u8c03\u7528\u6709\u4e09\u4e2a\u53c2\u6570\uff1a\u4e00\u4e2a\u6307\u5b9a\u6240\u64cd\u4f5c\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4e00\u4e2a\u6307\u5b9a\u8bfb\u53d6\u6570\u636e\u7684\u5b58\u653e\u5730\u5740\uff0c\u6700\u540e\u4e00\u4e2a\u6307\u5b9a\u8bfb\u591a\u5c11\u4e2a\u5b57\u8282\u3002\u5728C\u7a0b\u5e8f\u4e2d\u8c03\u7528\u8be5\u7cfb\u7edf\u8c03\u7528\u7684\u65b9\u6cd5\u5982\u4e0b\uff1a count = read(filehandle, buffer, nbytes); \u8be5\u7cfb\u7edf\u8c03\u7528\u4f1a\u628a\u5b9e\u9645\u8bfb\u5230\u7684\u5b57\u8282\u6570\u8fd4\u56de\u7ed9count\u53d8\u91cf\u3002\u5728\u6b63\u5e38\u60c5\u5f62\u4e0b\u8fd9\u4e2a\u503c\u4e0enbytes\u76f8\u7b49\uff0c\u4f46\u6709\u65f6\u53ef\u80fd\u4f1a\u5c0f\u4e00\u4e9b\u3002\u4f8b\u5982\uff0c\u5728\u8bfb\u6587\u4ef6\u65f6\u78b0\u4e0a\u4e86\u6587\u4ef6\u7ed3\u675f\u7b26\uff0c\u4ece\u800c\u63d0\u524d\u7ed3\u675f\u6b64\u6b21\u8bfb\u64cd\u4f5c\u3002 \u5982\u679c\u7531\u4e8e\u53c2\u6570\u65e0\u6548\u6216\u78c1\u76d8\u8bbf\u95ee\u9519\u8bef\u7b49\u539f\u56e0\uff0c\u4f7f\u5f97\u6b64\u6b21\u7cfb\u7edf\u8c03\u7528\u65e0\u6cd5\u5b8c\u6210\uff0c\u5219count\u88ab\u7f6e\u4e3a-1\u3002\u800cwrite\u51fd\u6570\u7684\u53c2\u6570\u4e0e\u4e4b\u5b8c\u5168\u76f8\u540c\u3002 \u5bf9\u4e8e\u76ee\u5f55\u800c\u8a00\uff0c\u6700\u5e38\u7528\u7684\u64cd\u4f5c\u662f\u8df3\u8f6c\u5230\u67d0\u4e2a\u76ee\u5f55\uff0c\u8fd9\u91cc\u5bf9\u5e94\u7684\u7528\u6237\u5e93\u51fd\u6570\u662fchdir\u3002\u7136\u540e\u5c31\u9700\u8981\u8bfb\u76ee\u5f55\u7684\u5185\u5bb9\u4e86\uff0c\u5373\u5217\u51fa\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u540d\uff0c\u8fd9\u5728\u5904\u7406\u4e0a\u4e0e\u8bfb\u6587\u4ef6\u7c7b\u4f3c\uff0c\u5373\u9700\u8981\u901a\u8fc7opendir\u51fd\u6570\u6253\u5f00\u76ee\u5f55\uff0c\u901a\u8fc7readdir\u6765\u83b7\u53d6\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u4fe1\u606f\uff0c\u8bfb\u5b8c\u540e\u8fd8\u9700\u901a\u8fc7closedir\u51fd\u6570\u6765\u5173\u95ed\u76ee\u5f55\u3002\u7531\u4e8e\u5728ucore\u4e2d\u628a\u76ee\u5f55\u770b\u6210\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u6587\u4ef6\uff0c\u6240\u4ee5opendir\u548cclosedir\u5b9e\u9645\u4e0a\u5c31\u662f\u8c03\u7528\u4e0e\u6587\u4ef6\u76f8\u5173\u7684open\u548cclose\u51fd\u6570\u3002\u53ea\u6709readdir\u9700\u8981\u8c03\u7528\u83b7\u53d6\u76ee\u5f55\u5185\u5bb9\u7684\u7279\u6b8a\u7cfb\u7edf\u8c03\u7528sys_getdirentry\u3002\u800c\u4e14\u8fd9\u91cc\u6ca1\u6709\u5199\u76ee\u5f55\u8fd9\u4e00\u64cd\u4f5c\u3002\u5728\u76ee\u5f55\u4e2d\u589e\u52a0\u5185\u5bb9\u5176\u5b9e\u5c31\u662f\u5728\u6b64\u76ee\u5f55\u4e2d\u521b\u5efa\u6587\u4ef6\uff0c\u9700\u8981\u7528\u5230\u521b\u5efa\u6587\u4ef6\u7684\u51fd\u6570\u3002 \u6587\u4ef6\u548c\u76ee\u5f55\u8bbf\u95ee\u76f8\u5173\u7cfb\u7edf\u8c03\u7528 \u4e0e\u6587\u4ef6\u76f8\u5173\u7684open\u3001close\u3001read\u3001write\u7528\u6237\u5e93\u51fd\u6570\u5bf9\u5e94\u7684\u662fsys_open\u3001sys_close\u3001sys_read\u3001sys_write\u56db\u4e2a\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u3002\u4e0e\u76ee\u5f55\u76f8\u5173\u7684readdir\u7528\u6237\u5e93\u51fd\u6570\u5bf9\u5e94\u7684\u662fsys_getdirentry\u7cfb\u7edf\u8c03\u7528\u3002\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u63a5\u53e3\u5c06\u901a\u8fc7syscall\u51fd\u6570\u6765\u83b7\u5f97ucore\u7684\u5185\u6838\u670d\u52a1\u3002\u5f53\u5230\u4e86ucore\u5185\u6838\u540e\uff0c\u5728\u8c03\u7528\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684file\u63a5\u53e3\u548cdir\u63a5\u53e3\u3002 \u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42 - VFS \u00b6 \u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u662f\u628a\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u5bf9\u5916\u5171\u6027\u63a5\u53e3\u63d0\u53d6\u51fa\u6765\uff0c\u5f62\u6210\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u6570\u7ec4\uff0c\u8fd9\u6837\uff0c\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3\u5c42\u53ea\u9700\u8bbf\u95ee\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\uff0c\u800c\u4e0d\u9700\u5173\u5fc3\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u7ec6\u8282\u548c\u63a5\u53e3\u3002 file & dir\u63a5\u53e3 \u00b6 file&dir\u63a5\u53e3\u5c42\u5b9a\u4e49\u4e86\u8fdb\u7a0b\u5728\u5185\u6838\u4e2d\u76f4\u63a5\u8bbf\u95ee\u7684\u6587\u4ef6\u76f8\u5173\u4fe1\u606f\uff0c\u8fd9\u5b9a\u4e49\u5728file\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u5177\u4f53\u63cf\u8ff0\u5982\u4e0b\uff1a struct file { enum { FD_NONE, FD_INIT, FD_OPENED, FD_CLOSED, } status; //\u8bbf\u95ee\u6587\u4ef6\u7684\u6267\u884c\u72b6\u6001 bool readable; //\u6587\u4ef6\u662f\u5426\u53ef\u8bfb bool writable; //\u6587\u4ef6\u662f\u5426\u53ef\u5199 int fd; //\u6587\u4ef6\u5728filemap\u4e2d\u7684\u7d22\u5f15\u503c off_t pos; //\u8bbf\u95ee\u6587\u4ef6\u7684\u5f53\u524d\u4f4d\u7f6e struct inode *node; //\u8be5\u6587\u4ef6\u5bf9\u5e94\u7684\u5185\u5b58inode\u6307\u9488 int open_count; //\u6253\u5f00\u6b64\u6587\u4ef6\u7684\u6b21\u6570 }; \u800c\u5728kern/process/proc.h\u4e2d\u7684proc_struct\u7ed3\u6784\u4e2d\u63cf\u8ff0\u4e86\u8fdb\u7a0b\u8bbf\u95ee\u6587\u4ef6\u7684\u6570\u636e\u63a5\u53e3files_struct\uff0c\u5176\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b\uff1a struct files_struct { struct inode *pwd; //\u8fdb\u7a0b\u5f53\u524d\u6267\u884c\u76ee\u5f55\u7684\u5185\u5b58inode\u6307\u9488 struct file *fd_array; //\u8fdb\u7a0b\u6253\u5f00\u6587\u4ef6\u7684\u6570\u7ec4 atomic_t files_count; //\u8bbf\u95ee\u6b64\u6587\u4ef6\u7684\u7ebf\u7a0b\u4e2a\u6570 semaphore_t files_sem; //\u786e\u4fdd\u5bf9\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2dfs_struct\u7684\u4e92\u65a5\u8bbf\u95ee }; \u5f53\u521b\u5efa\u4e00\u4e2a\u8fdb\u7a0b\u540e\uff0c\u8be5\u8fdb\u7a0b\u7684files_struct\u5c06\u4f1a\u88ab\u521d\u59cb\u5316\u6216\u590d\u5236\u7236\u8fdb\u7a0b\u7684files_struct\u3002\u5f53\u7528\u6237\u8fdb\u7a0b\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u65f6\uff0c\u5c06\u4ecefd_array\u6570\u7ec4\u4e2d\u53d6\u5f97\u4e00\u4e2a\u7a7a\u95f2file\u9879\uff0c\u7136\u540e\u4f1a\u628a\u6b64file\u7684\u6210\u5458\u53d8\u91cfnode\u6307\u9488\u6307\u5411\u4e00\u4e2a\u4ee3\u8868\u6b64\u6587\u4ef6\u7684inode\u7684\u8d77\u59cb\u5730\u5740\u3002 inode \u63a5\u53e3 \u00b6 index node\u662f\u4f4d\u4e8e\u5185\u5b58\u7684\u7d22\u5f15\u8282\u70b9\uff0c\u5b83\u662fVFS\u7ed3\u6784\u4e2d\u7684\u91cd\u8981\u6570\u636e\u7ed3\u6784\uff0c\u56e0\u4e3a\u5b83\u5b9e\u9645\u8d1f\u8d23\u628a\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u7279\u5b9a\u7d22\u5f15\u8282\u70b9\u4fe1\u606f\uff08\u751a\u81f3\u4e0d\u80fd\u7b97\u662f\u4e00\u4e2a\u7d22\u5f15\u8282\u70b9\uff09\u7edf\u4e00\u5c01\u88c5\u8d77\u6765\uff0c\u907f\u514d\u4e86\u8fdb\u7a0b\u76f4\u63a5\u8bbf\u95ee\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u3002\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a struct inode { union { //\u5305\u542b\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7279\u5b9ainode\u4fe1\u606f\u7684union\u6210\u5458\u53d8\u91cf struct device __device_info; //\u8bbe\u5907\u6587\u4ef6\u7cfb\u7edf\u5185\u5b58inode\u4fe1\u606f struct sfs_inode __sfs_inode_info; //SFS\u6587\u4ef6\u7cfb\u7edf\u5185\u5b58inode\u4fe1\u606f } in_info; enum { inode_type_device_info = 0x1234, inode_type_sfs_inode_info, } in_type; //\u6b64inode\u6240\u5c5e\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b atomic_t ref_count; //\u6b64inode\u7684\u5f15\u7528\u8ba1\u6570 atomic_t open_count; //\u6253\u5f00\u6b64inode\u5bf9\u5e94\u6587\u4ef6\u7684\u4e2a\u6570 struct fs *in_fs; //\u62bd\u8c61\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u5305\u542b\u8bbf\u95ee\u6587\u4ef6\u7cfb\u7edf\u7684\u51fd\u6570\u6307\u9488 const struct inode_ops *in_ops; //\u62bd\u8c61\u7684inode\u64cd\u4f5c\uff0c\u5305\u542b\u8bbf\u95eeinode\u7684\u51fd\u6570\u6307\u9488 }; \u5728inode\u4e2d\uff0c\u6709\u4e00\u6210\u5458\u53d8\u91cf\u4e3ain_ops\uff0c\u8fd9\u662f\u5bf9\u6b64inode\u7684\u64cd\u4f5c\u51fd\u6570\u6307\u9488\u5217\u8868\uff0c\u5176\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b\uff1a struct inode_ops { unsigned long vop_magic; int (*vop_open)(struct inode *node, uint32_t open_flags); int (*vop_close)(struct inode *node); int (*vop_read)(struct inode *node, struct iobuf *iob); int (*vop_write)(struct inode *node, struct iobuf *iob); int (*vop_getdirentry)(struct inode *node, struct iobuf *iob); int (*vop_create)(struct inode *node, const char *name, bool excl, struct inode **node_store); int (*vop_lookup)(struct inode *node, char *path, struct inode **node_store); \u2026\u2026 }; \u53c2\u7167\u4e0a\u9762\u5bf9SFS\u4e2d\u7684\u7d22\u5f15\u8282\u70b9\u64cd\u4f5c\u51fd\u6570\u7684\u8bf4\u660e\uff0c\u53ef\u4ee5\u770b\u51fainode_ops\u662f\u5bf9\u5e38\u89c4\u6587\u4ef6\u3001\u76ee\u5f55\u3001\u8bbe\u5907\u6587\u4ef6\u6240\u6709\u64cd\u4f5c\u7684\u4e00\u4e2a\u62bd\u8c61\u51fd\u6570\u8868\u793a\u3002\u5bf9\u4e8e\u67d0\u4e00\u5177\u4f53\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u53ea\u9700\u5b9e\u73b0\u76f8\u5173\u7684\u51fd\u6570\uff0c\u5c31\u53ef\u4ee5\u88ab\u7528\u6237\u8fdb\u7a0b\u8bbf\u95ee\u5177\u4f53\u7684\u6587\u4ef6\u4e86\uff0c\u4e14\u7528\u6237\u8fdb\u7a0b\u65e0\u9700\u4e86\u89e3\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u7ec6\u8282\u3002 Simple FS \u6587\u4ef6\u7cfb\u7edf \u00b6 \u8fd9\u91cc\u6211\u4eec\u6ca1\u6709\u6309\u7167\u4ece\u4e0a\u5230\u4e0b\u5148\u8bb2\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\uff0c\u518d\u8bb2\u5177\u4f53\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u8fd9\u662f\u7531\u4e8e\u5982\u679c\u80fd\u591f\u7406\u89e3Simple FS\uff08\u7b80\u79f0SFS\uff09\u6587\u4ef6\u7cfb\u7edf\uff0c\u5c31\u53ef\u66f4\u597d\u5730\u5206\u6790\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u8bbe\u8ba1\u3002\u5373\u4ece\u5177\u4f53\u8d70\u5411\u62bd\u8c61\u3002ucore\u5185\u6838\u628a\u6240\u6709\u6587\u4ef6\u90fd\u770b\u4f5c\u662f\u5b57\u8282\u6d41\uff0c\u4efb\u4f55\u5185\u90e8\u903b\u8f91\u7ed3\u6784\u90fd\u662f\u4e13\u7528\u7684\uff0c\u7531\u5e94\u7528\u7a0b\u5e8f\u8d1f\u8d23\u89e3\u91ca\u3002\u4f46\u662fucore\u533a\u5206\u6587\u4ef6\u7684\u7269\u7406\u7ed3\u6784\u3002ucore\u76ee\u524d\u652f\u6301\u5982\u4e0b\u51e0\u79cd\u7c7b\u578b\u7684\u6587\u4ef6\uff1a \u5e38\u89c4\u6587\u4ef6\uff1a\u6587\u4ef6\u4e2d\u5305\u62ec\u7684\u5185\u5bb9\u4fe1\u606f\u662f\u7531\u5e94\u7528\u7a0b\u5e8f\u8f93\u5165\u3002SFS\u6587\u4ef6\u7cfb\u7edf\u5728\u666e\u901a\u6587\u4ef6\u4e0a\u4e0d\u5f3a\u52a0\u4efb\u4f55\u5185\u90e8\u7ed3\u6784\uff0c\u628a\u5176\u6587\u4ef6\u5185\u5bb9\u4fe1\u606f\u770b\u4f5c\u4e3a\u5b57\u8282\u3002 \u76ee\u5f55\uff1a\u5305\u542b\u4e00\u7cfb\u5217\u7684entry\uff0c\u6bcf\u4e2aentry\u5305\u542b\u6587\u4ef6\u540d\u548c\u6307\u5411\u4e0e\u4e4b\u76f8\u5173\u8054\u7684\u7d22\u5f15\u8282\u70b9\uff08index node\uff09\u7684\u6307\u9488\u3002\u76ee\u5f55\u662f\u6309\u5c42\u6b21\u7ed3\u6784\u7ec4\u7ec7\u7684\u3002 \u94fe\u63a5\u6587\u4ef6\uff1a\u5b9e\u9645\u4e0a\u4e00\u4e2a\u94fe\u63a5\u6587\u4ef6\u662f\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u6587\u4ef6\u7684\u53e6\u4e00\u4e2a\u53ef\u9009\u62e9\u7684\u6587\u4ef6\u540d\u3002 \u8bbe\u5907\u6587\u4ef6\uff1a\u4e0d\u5305\u542b\u6570\u636e\uff0c\u4f46\u662f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6620\u5c04\u7269\u7406\u8bbe\u5907\uff08\u5982\u4e32\u53e3\uff09\u5230\u4e00\u4e2a\u6587\u4ef6\u540d\u7684\u673a\u5236\u3002\u53ef\u901a\u8fc7\u8bbe\u5907\u6587\u4ef6\u8bbf\u95ee\u5916\u56f4\u8bbe\u5907\u3002 \u7ba1\u9053\uff1a\u7ba1\u9053\u662f\u8fdb\u7a0b\u95f4\u901a\u8baf\u7684\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u3002\u7ba1\u9053\u7f13\u5b58\u4e86\u5176\u8f93\u5165\u7aef\u6240\u63a5\u53d7\u7684\u6570\u636e\uff0c\u4ee5\u4fbf\u5728\u7ba1\u9053\u8f93\u51fa\u7aef\u8bfb\u7684\u8fdb\u7a0b\u80fd\u4e00\u4e2a\u5148\u8fdb\u5148\u51fa\u7684\u65b9\u5f0f\u6765\u63a5\u53d7\u6570\u636e\u3002 \u5728lab4\u4e2d\u5173\u6ce8\u7684\u4e3b\u8981\u662fSFS\u652f\u6301\u7684\u5e38\u89c4\u6587\u4ef6\u3001\u76ee\u5f55\u548c\u94fe\u63a5\u4e2d\u7684 hardlink \u7684\u8bbe\u8ba1\u5b9e\u73b0\u3002SFS\u6587\u4ef6\u7cfb\u7edf\u4e2d\u76ee\u5f55\u548c\u5e38\u89c4\u6587\u4ef6\u5177\u6709\u5171\u540c\u7684\u5c5e\u6027\uff0c\u800c\u8fd9\u4e9b\u5c5e\u6027\u4fdd\u5b58\u5728\u7d22\u5f15\u8282\u70b9\u4e2d\u3002SFS\u901a\u8fc7\u7d22\u5f15\u8282\u70b9\u6765\u7ba1\u7406\u76ee\u5f55\u548c\u5e38\u89c4\u6587\u4ef6\uff0c\u7d22\u5f15\u8282\u70b9\u5305\u542b\u64cd\u4f5c\u7cfb\u7edf\u6240\u9700\u8981\u7684\u5173\u4e8e\u67d0\u4e2a\u6587\u4ef6\u7684\u5173\u952e\u4fe1\u606f\uff0c\u6bd4\u5982\u6587\u4ef6\u7684\u5c5e\u6027\u3001\u8bbf\u95ee\u8bb8\u53ef\u6743\u4ee5\u53ca\u5176\u5b83\u63a7\u5236\u4fe1\u606f\u90fd\u4fdd\u5b58\u5728\u7d22\u5f15\u8282\u70b9\u4e2d\u3002\u53ef\u4ee5\u6709\u591a\u4e2a\u6587\u4ef6\u540d\u53ef\u6307\u5411\u4e00\u4e2a\u7d22\u5f15\u8282\u70b9\u3002 \u6587\u4ef6\u7cfb\u7edf\u7684\u5e03\u5c40 \u00b6 \u6587\u4ef6\u7cfb\u7edf\u901a\u5e38\u4fdd\u5b58\u5728\u78c1\u76d8\u4e0a\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u78c1\u76d8\uff08\u5373disk0\uff09\u7528\u4e8e\u5b58\u653e\u4e00\u4e2aSFS\u6587\u4ef6\u7cfb\u7edf\uff08Simple Filesystem\uff09\u3002\u901a\u5e38\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u78c1\u76d8\u7684\u4f7f\u7528\u662f\u4ee5\u6247\u533a\uff08Sector\uff09\u4e3a\u5355\u4f4d\u7684\uff0c\u4f46\u662f\u4e3a\u4e86\u5b9e\u73b0\u7b80\u4fbf\uff0cSFS \u4e2d\u4ee5 block \uff084K\uff0c\u4e0e\u5185\u5b58 page \u5927\u5c0f\u76f8\u7b49\uff09\u4e3a\u57fa\u672c\u5355\u4f4d\u3002 SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u5e03\u5c40\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u7b2c0\u4e2a\u5757\uff084K\uff09\u662f\u8d85\u7ea7\u5757\uff08superblock\uff09\uff0c\u5b83\u5305\u542b\u4e86\u5173\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6240\u6709\u5173\u952e\u53c2\u6570\uff0c\u5f53\u8ba1\u7b97\u673a\u88ab\u542f\u52a8\u6216\u6587\u4ef6\u7cfb\u7edf\u88ab\u9996\u6b21\u63a5\u89e6\u65f6\uff0c\u8d85\u7ea7\u5757\u7684\u5185\u5bb9\u5c31\u4f1a\u88ab\u88c5\u5165\u5185\u5b58\u3002\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a struct sfs_super { uint32_t magic; /* magic number, should be SFS_MAGIC */ uint32_t blocks; /* # of blocks in fs */ uint32_t unused_blocks; /* # of unused blocks in fs */ char info[SFS_MAX_INFO_LEN + 1]; /* infomation for sfs */ }; \u53ef\u4ee5\u770b\u5230\uff0c\u5305\u542b\u4e00\u4e2a\u6210\u5458\u53d8\u91cf\u9b54\u6570magic\uff0c\u5176\u503c\u4e3a0x2f8dbe2a\uff0c\u5185\u6838\u901a\u8fc7\u5b83\u6765\u68c0\u67e5\u78c1\u76d8\u955c\u50cf\u662f\u5426\u662f\u5408\u6cd5\u7684 SFS img\uff1b\u6210\u5458\u53d8\u91cfblocks\u8bb0\u5f55\u4e86SFS\u4e2d\u6240\u6709block\u7684\u6570\u91cf\uff0c\u5373 img \u7684\u5927\u5c0f\uff1b\u6210\u5458\u53d8\u91cfunused_block\u8bb0\u5f55\u4e86SFS\u4e2d\u8fd8\u6ca1\u6709\u88ab\u4f7f\u7528\u7684block\u7684\u6570\u91cf\uff1b\u6210\u5458\u53d8\u91cfinfo\u5305\u542b\u4e86\u5b57\u7b26\u4e32\"simple file system\"\u3002 \u7b2c1\u4e2a\u5757\u653e\u4e86\u4e00\u4e2aroot-dir\u7684inode\uff0c\u7528\u6765\u8bb0\u5f55\u6839\u76ee\u5f55\u7684\u76f8\u5173\u4fe1\u606f\u3002\u6709\u5173inode\u8fd8\u5c06\u5728\u540e\u7eed\u90e8\u5206\u4ecb\u7ecd\u3002\u8fd9\u91cc\u53ea\u8981\u7406\u89e3root-dir\u662fSFS\u6587\u4ef6\u7cfb\u7edf\u7684\u6839\u7ed3\u70b9\uff0c\u901a\u8fc7\u8fd9\u4e2aroot-dir\u7684inode\u4fe1\u606f\u5c31\u53ef\u4ee5\u5b9a\u4f4d\u5e76\u67e5\u627e\u5230\u6839\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u4fe1\u606f\u3002 \u4ece\u7b2c2\u4e2a\u5757\u5f00\u59cb\uff0c\u6839\u636eSFS\u4e2d\u6240\u6709\u5757\u7684\u6570\u91cf\uff0c\u75281\u4e2abit\u6765\u8868\u793a\u4e00\u4e2a\u5757\u7684\u5360\u7528\u548c\u672a\u88ab\u5360\u7528\u7684\u60c5\u51b5\u3002\u8fd9\u4e2a\u533a\u57df\u79f0\u4e3aSFS\u7684freemap\u533a\u57df\uff0c\u8fd9\u5c06\u5360\u7528\u82e5\u5e72\u4e2a\u5757\u7a7a\u95f4\u3002\u4e3a\u4e86\u66f4\u597d\u5730\u8bb0\u5f55\u548c\u7ba1\u7406freemap\u533a\u57df\uff0c\u4e13\u95e8\u63d0\u4f9b\u4e86\u4e24\u4e2a\u6587\u4ef6kern/fs/sfs/bitmap.[ch]\u6765\u5b8c\u6210\u6839\u636e\u4e00\u4e2a\u5757\u53f7\u67e5\u627e\u6216\u8bbe\u7f6e\u5bf9\u5e94\u7684bit\u4f4d\u7684\u503c\u3002 \u6700\u540e\u5728\u5269\u4f59\u7684\u78c1\u76d8\u7a7a\u95f4\u4e2d\uff0c\u5b58\u653e\u4e86\u6240\u6709\u5176\u4ed6\u76ee\u5f55\u548c\u6587\u4ef6\u7684inode\u4fe1\u606f\u548c\u5185\u5bb9\u6570\u636e\u4fe1\u606f\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\u867d\u7136inode\u7684\u5927\u5c0f\u5c0f\u4e8e\u4e00\u4e2a\u5757\u7684\u5927\u5c0f\uff084096B\uff09\uff0c\u4f46\u4e3a\u4e86\u5b9e\u73b0\u7b80\u5355\uff0c\u6bcf\u4e2a inode \u90fd\u5360\u7528\u4e00\u4e2a\u5b8c\u6574\u7684 block\u3002 \u5728sfs_fs.c\u6587\u4ef6\u4e2d\u7684sfs_do_mount\u51fd\u6570\u4e2d\uff0c\u5b8c\u6210\u4e86\u52a0\u8f7d\u4f4d\u4e8e\u786c\u76d8\u4e0a\u7684SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u8d85\u7ea7\u5757superblock\u548cfreemap\u7684\u5de5\u4f5c\u3002\u8fd9\u6837\uff0c\u5728\u5185\u5b58\u4e2d\u5c31\u6709\u4e86SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u5168\u5c40\u4fe1\u606f\u3002 \u7d22\u5f15\u8282\u70b9 \u00b6 \u5728SFS\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u9700\u8981\u8bb0\u5f55\u6587\u4ef6\u5185\u5bb9\u7684\u5b58\u50a8\u4f4d\u7f6e\u4ee5\u53ca\u6587\u4ef6\u540d\u4e0e\u6587\u4ef6\u5185\u5bb9\u7684\u5bf9\u5e94\u5173\u7cfb\u3002sfs_disk_inode\u8bb0\u5f55\u4e86\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u5185\u5bb9\u5b58\u50a8\u7684\u7d22\u5f15\u4fe1\u606f\uff0c\u8be5\u6570\u636e\u7ed3\u6784\u5728\u786c\u76d8\u91cc\u50a8\u5b58\uff0c\u9700\u8981\u65f6\u8bfb\u5165\u5185\u5b58\u3002sfs_disk_entry\u8868\u793a\u4e00\u4e2a\u76ee\u5f55\u4e2d\u7684\u4e00\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5305\u542b\u8be5\u9879\u6240\u5bf9\u5e94inode\u7684\u4f4d\u7f6e\u548c\u6587\u4ef6\u540d\uff0c\u540c\u6837\u4e5f\u5728\u786c\u76d8\u91cc\u50a8\u5b58\uff0c\u9700\u8981\u65f6\u8bfb\u5165\u5185\u5b58\u3002 \u78c1\u76d8\u7d22\u5f15\u8282\u70b9 SFS\u4e2d\u7684\u78c1\u76d8\u7d22\u5f15\u8282\u70b9\u4ee3\u8868\u4e86\u4e00\u4e2a\u5b9e\u9645\u4f4d\u4e8e\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\u3002\u9996\u5148\u6211\u4eec\u770b\u770b\u5728\u786c\u76d8\u4e0a\u7684\u7d22\u5f15\u8282\u70b9\u7684\u5185\u5bb9\uff1a struct sfs_disk_inode { uint32_t size; \u5982\u679cinode\u8868\u793a\u5e38\u89c4\u6587\u4ef6\uff0c\u5219size\u662f\u6587\u4ef6\u5927\u5c0f uint16_t type; inode\u7684\u6587\u4ef6\u7c7b\u578b uint16_t nlinks; \u6b64inode\u7684\u786c\u94fe\u63a5\u6570 uint32_t blocks; \u6b64inode\u7684\u6570\u636e\u5757\u6570\u7684\u4e2a\u6570 uint32_t direct[SFS_NDIRECT]; \u6b64inode\u7684\u76f4\u63a5\u6570\u636e\u5757\u7d22\u5f15\u503c\uff08\u6709SFS_NDIRECT\u4e2a\uff09 uint32_t indirect; \u6b64inode\u7684\u4e00\u7ea7\u95f4\u63a5\u6570\u636e\u5757\u7d22\u5f15\u503c }; \u901a\u8fc7\u4e0a\u8868\u53ef\u4ee5\u770b\u51fa\uff0c\u5982\u679cinode\u8868\u793a\u7684\u662f\u6587\u4ef6\uff0c\u5219\u6210\u5458\u53d8\u91cfdirect[]\u76f4\u63a5\u6307\u5411\u4e86\u4fdd\u5b58\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u7684\u6570\u636e\u5757\u7d22\u5f15\u503c\u3002indirect\u95f4\u63a5\u6307\u5411\u4e86\u4fdd\u5b58\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u7684\u6570\u636e\u5757\uff0cindirect\u6307\u5411\u7684\u662f\u95f4\u63a5\u6570\u636e\u5757\uff08indirect block\uff09\uff0c\u6b64\u6570\u636e\u5757\u5b9e\u9645\u5b58\u653e\u7684\u5168\u90e8\u662f\u6570\u636e\u5757\u7d22\u5f15\uff0c\u8fd9\u4e9b\u6570\u636e\u5757\u7d22\u5f15\u6307\u5411\u7684\u6570\u636e\u5757\u624d\u88ab\u7528\u6765\u5b58\u653e\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u3002 \u9ed8\u8ba4\u7684\uff0cucore \u91cc SFS_NDIRECT \u662f 12\uff0c\u5373\u76f4\u63a5\u7d22\u5f15\u7684\u6570\u636e\u9875\u5927\u5c0f\u4e3a 12 * 4k = 48k\uff1b\u5f53\u4f7f\u7528\u4e00\u7ea7\u95f4\u63a5\u6570\u636e\u5757\u7d22\u5f15\u65f6\uff0cucore \u652f\u6301\u6700\u5927\u7684\u6587\u4ef6\u5927\u5c0f\u4e3a 12 * 4k + 1024 * 4k = 48k + 4m\u3002\u6570\u636e\u7d22\u5f15\u8868\u5185\uff0c0 \u8868\u793a\u4e00\u4e2a\u65e0\u6548\u7684\u7d22\u5f15\uff0cinode \u91cc blocks \u8868\u793a\u8be5\u6587\u4ef6\u6216\u8005\u76ee\u5f55\u5360\u7528\u7684\u78c1\u76d8\u7684 block \u7684\u4e2a\u6570\u3002indiret \u4e3a 0 \u65f6\uff0c\u8868\u793a\u4e0d\u4f7f\u7528\u4e00\u7ea7\u7d22\u5f15\u5757\u3002\uff08\u56e0\u4e3a block 0 \u7528\u6765\u4fdd\u5b58 super block\uff0c\u5b83\u4e0d\u53ef\u80fd\u88ab\u5176\u4ed6\u4efb\u4f55\u6587\u4ef6\u6216\u76ee\u5f55\u4f7f\u7528\uff0c\u6240\u4ee5\u8fd9\u4e48\u8bbe\u8ba1\u4e5f\u662f\u5408\u7406\u7684\uff09\u3002 \u5bf9\u4e8e\u666e\u901a\u6587\u4ef6\uff0c\u7d22\u5f15\u503c\u6307\u5411\u7684 block \u4e2d\u4fdd\u5b58\u7684\u662f\u6587\u4ef6\u4e2d\u7684\u6570\u636e\u3002\u800c\u5bf9\u4e8e\u76ee\u5f55\uff0c\u7d22\u5f15\u503c\u6307\u5411\u7684\u6570\u636e\u4fdd\u5b58\u7684\u662f\u76ee\u5f55\u4e0b\u6240\u6709\u7684\u6587\u4ef6\u540d\u4ee5\u53ca\u5bf9\u5e94\u7684\u7d22\u5f15\u8282\u70b9\u6240\u5728\u7684\u7d22\u5f15\u5757\uff08\u78c1\u76d8\u5757\uff09\u6240\u5f62\u6210\u7684\u6570\u7ec4\u3002\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a /* file entry (on disk) */ struct sfs_disk_entry { uint32_t ino; \u7d22\u5f15\u8282\u70b9\u6240\u5360\u6570\u636e\u5757\u7d22\u5f15\u503c char name[SFS_MAX_FNAME_LEN + 1]; \u6587\u4ef6\u540d }; \u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e0b\u7684 inode \u90fd\u5e94\u8be5\u5206\u914d\u552f\u4e00\u7684 inode \u7f16\u53f7\u3002SFS \u4e0b\uff0c\u4e3a\u4e86\u5b9e\u73b0\u7684\u7b80\u4fbf\uff08\u5077\u61d2\uff09\uff0c\u6bcf\u4e2a inode \u76f4\u63a5\u7528\u4ed6\u6240\u5728\u7684\u78c1\u76d8 block \u7684\u7f16\u53f7\u4f5c\u4e3a inode \u7f16\u53f7\u3002\u6bd4\u5982\uff0croot block \u7684 inode \u7f16\u53f7\u4e3a 1\uff1b\u6bcf\u4e2a sfs_disk_entry \u6570\u636e\u7ed3\u6784\u4e2d\uff0cname \u8868\u793a\u76ee\u5f55\u4e0b\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u7684\u540d\u79f0\uff0cino \u8868\u793a\u78c1\u76d8 block \u7f16\u53f7\uff0c\u901a\u8fc7\u8bfb\u53d6\u8be5 block \u7684\u6570\u636e\uff0c\u80fd\u591f\u5f97\u5230\u76f8\u5e94\u7684\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u7684 inode\u3002ino \u4e3a0\u65f6\uff0c\u8868\u793a\u4e00\u4e2a\u65e0\u6548\u7684 entry\u3002 \u6b64\u5916\uff0c\u548c inode \u76f8\u4f3c\uff0c\u6bcf\u4e2a sfs_dirent_entry \u4e5f\u5360\u7528\u4e00\u4e2a block\u3002 \u5185\u5b58\u4e2d\u7684\u7d22\u5f15\u8282\u70b9 /* inode for sfs */ struct sfs_inode { struct sfs_disk_inode *din; /* on-disk inode */ uint32_t ino; /* inode number */ uint32_t flags; /* inode flags */ bool dirty; /* true if inode modified */ int reclaim_count; /* kill inode if it hits zero */ semaphore_t sem; /* semaphore for din */ list_entry_t inode_link; /* entry for linked-list in sfs_fs */ list_entry_t hash_link; /* entry for hash linked-list in sfs_fs */ }; \u53ef\u4ee5\u770b\u5230SFS\u4e2d\u7684\u5185\u5b58inode\u5305\u542b\u4e86SFS\u7684\u786c\u76d8inode\u4fe1\u606f\uff0c\u800c\u4e14\u8fd8\u589e\u52a0\u4e86\u5176\u4ed6\u4e00\u4e9b\u4fe1\u606f\uff0c\u8fd9\u5c5e\u4e8e\u662f\u4fbf\u4e8e\u8fdb\u884c\u662f\u5224\u65ad\u5426\u6539\u5199\u3001\u4e92\u65a5\u64cd\u4f5c\u3001\u56de\u6536\u548c\u5feb\u901f\u5730\u5b9a\u4f4d\u7b49\u4f5c\u7528\u3002\u9700\u8981\u6ce8\u610f\uff0c\u4e00\u4e2a\u5185\u5b58inode\u662f\u5728\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u540e\u624d\u521b\u5efa\u7684\uff0c\u5982\u679c\u5173\u673a\u5219\u76f8\u5173\u4fe1\u606f\u90fd\u4f1a\u6d88\u5931\u3002\u800c\u786c\u76d8inode\u7684\u5185\u5bb9\u662f\u4fdd\u5b58\u5728\u786c\u76d8\u4e2d\u7684\uff0c\u53ea\u662f\u5728\u8fdb\u7a0b\u9700\u8981\u65f6\u624d\u88ab\u8bfb\u5165\u5230\u5185\u5b58\u4e2d\uff0c\u7528\u4e8e\u8bbf\u95ee\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u5177\u4f53\u5185\u5bb9\u6570\u636e \u4e3a\u4e86\u65b9\u4fbf\u5b9e\u73b0\u4e0a\u9762\u63d0\u5230\u7684\u591a\u7ea7\u6570\u636e\u7684\u8bbf\u95ee\u4ee5\u53ca\u76ee\u5f55\u4e2d entry \u7684\u64cd\u4f5c\uff0c\u5bf9 inode SFS\u5b9e\u73b0\u4e86\u4e00\u4e9b\u8f85\u52a9\u7684\u51fd\u6570\uff1a sfs_bmap_load_nolock\uff1a\u5c06\u5bf9\u5e94 sfs_inode \u7684\u7b2c index \u4e2a\u7d22\u5f15\u6307\u5411\u7684 block \u7684\u7d22\u5f15\u503c\u53d6\u51fa\u5b58\u5230\u76f8\u5e94\u7684\u6307\u9488\u6307\u5411\u7684\u5355\u5143\uff08ino_store\uff09\u3002\u8be5\u51fd\u6570\u53ea\u63a5\u53d7 index <= inode->blocks \u7684\u53c2\u6570\u3002\u5f53 index == inode->blocks \u65f6\uff0c\u8be5\u51fd\u6570\u7406\u89e3\u4e3a\u9700\u8981\u4e3a inode \u589e\u957f\u4e00\u4e2a block\u3002\u5e76\u6807\u8bb0 inode \u4e3a dirty\uff08\u6240\u6709\u5bf9 inode \u6570\u636e\u7684\u4fee\u6539\u90fd\u8981\u505a\u8fd9\u6837\u7684\u64cd\u4f5c\uff0c\u8fd9\u6837\uff0c\u5f53 inode \u4e0d\u518d\u4f7f\u7528\u7684\u65f6\u5019\uff0csfs \u80fd\u591f\u4fdd\u8bc1 inode \u6570\u636e\u80fd\u591f\u88ab\u5199\u56de\u5230\u78c1\u76d8\uff09\u3002sfs_bmap_load_nolock \u8c03\u7528\u7684 sfs_bmap_get_nolock \u6765\u5b8c\u6210\u76f8\u5e94\u7684\u64cd\u4f5c\uff0c\u9605\u8bfb sfs_bmap_get_nolock\uff0c\u4e86\u89e3\u4ed6\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u3002\uff08sfs_bmap_get_nolock \u53ea\u7531 sfs_bmap_load_nolock \u8c03\u7528\uff09 sfs_bmap_truncate_nolock\uff1a\u5c06\u591a\u7ea7\u6570\u636e\u7d22\u5f15\u8868\u7684\u6700\u540e\u4e00\u4e2a entry \u91ca\u653e\u6389\u3002\u4ed6\u53ef\u4ee5\u8ba4\u4e3a\u662f sfs_bmap_load_nolock \u4e2d\uff0cindex == inode->blocks \u7684\u9006\u64cd\u4f5c\u3002\u5f53\u4e00\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\u88ab\u5220\u9664\u65f6\uff0csfs \u4f1a\u5faa\u73af\u8c03\u7528\u8be5\u51fd\u6570\u76f4\u5230 inode->blocks \u51cf\u4e3a 0\uff0c\u91ca\u653e\u6240\u6709\u7684\u6570\u636e\u9875\u3002\u51fd\u6570\u901a\u8fc7 sfs_bmap_free_nolock \u6765\u5b9e\u73b0\uff0c\u4ed6\u5e94\u8be5\u662f sfs_bmap_get_nolock \u7684\u9006\u64cd\u4f5c\u3002\u548c sfs_bmap_get_nolock \u4e00\u6837\uff0c\u8c03\u7528 sfs_bmap_free_nolock \u4e5f\u8981\u683c\u5916\u5c0f\u5fc3\u3002 sfs_dirent_read_nolock\uff1a\u5c06\u76ee\u5f55\u7684\u7b2c slot \u4e2a entry \u8bfb\u53d6\u5230\u6307\u5b9a\u7684\u5185\u5b58\u7a7a\u95f4\u3002\u4ed6\u901a\u8fc7\u4e0a\u9762\u63d0\u5230\u7684\u51fd\u6570\u6765\u5b8c\u6210\u3002 sfs_dirent_search_nolock\uff1a\u662f\u5e38\u7528\u7684\u67e5\u627e\u51fd\u6570\u3002\u4ed6\u5728\u76ee\u5f55\u4e0b\u67e5\u627e name\uff0c\u5e76\u4e14\u8fd4\u56de\u76f8\u5e94\u7684\u641c\u7d22\u7ed3\u679c\uff08\u6587\u4ef6\u6216\u6587\u4ef6\u5939\uff09\u7684 inode \u7684\u7f16\u53f7\uff08\u4e5f\u662f\u78c1\u76d8\u7f16\u53f7\uff09\uff0c\u548c\u76f8\u5e94\u7684 entry \u5728\u8be5\u76ee\u5f55\u7684 index \u7f16\u53f7\u4ee5\u53ca\u76ee\u5f55\u4e0b\u7684\u6570\u636e\u9875\u662f\u5426\u6709\u7a7a\u95f2\u7684 entry\u3002\uff08SFS \u5b9e\u73b0\u91cc\u6587\u4ef6\u7684\u6570\u636e\u9875\u662f\u8fde\u7eed\u7684\uff0c\u4e0d\u5b58\u5728\u4efb\u4f55\u7a7a\u6d1e\uff1b\u800c\u5bf9\u4e8e\u76ee\u5f55\uff0c\u6570\u636e\u9875\u4e0d\u662f\u8fde\u7eed\u7684\uff0c\u5f53\u67d0\u4e2a entry \u5220\u9664\u7684\u65f6\u5019\uff0cSFS \u901a\u8fc7\u8bbe\u7f6e entry->ino \u4e3a0\u5c06\u8be5 entry \u6240\u5728\u7684 block \u6807\u8bb0\u4e3a free\uff0c\u5728\u9700\u8981\u6dfb\u52a0\u65b0 entry \u7684\u65f6\u5019\uff0cSFS \u4f18\u5148\u4f7f\u7528\u8fd9\u4e9b free \u7684 entry\uff0c\u5176\u6b21\u624d\u4f1a\u53bb\u5728\u6570\u636e\u9875\u5c3e\u8ffd\u52a0\u65b0\u7684 entry\u3002 \u6ce8\u610f\uff0c\u8fd9\u4e9b\u540e\u7f00\u4e3a nolock \u7684\u51fd\u6570\uff0c\u53ea\u80fd\u5728\u5df2\u7ecf\u83b7\u5f97\u76f8\u5e94 inode \u7684semaphore\u624d\u80fd\u8c03\u7528\u3002 Inode\u7684\u6587\u4ef6\u64cd\u4f5c\u51fd\u6570 static const struct inode_ops sfs_node_fileops = { .vop_magic = VOP_MAGIC, .vop_open = sfs_openfile, .vop_close = sfs_close, .vop_read = sfs_read, .vop_write = sfs_write, \u2026\u2026 }; \u4e0a\u8ff0sfs_openfile\u3001sfs_close\u3001sfs_read\u548csfs_write\u5206\u522b\u5bf9\u5e94\u7528\u6237\u8fdb\u7a0b\u53d1\u51fa\u7684open\u3001close\u3001read\u3001write\u64cd\u4f5c\u3002\u5176\u4e2dsfs_openfile\u4e0d\u7528\u505a\u4ec0\u4e48\u4e8b\uff1bsfs_close\u9700\u8981\u628a\u5bf9\u6587\u4ef6\u7684\u4fee\u6539\u5185\u5bb9\u5199\u56de\u5230\u786c\u76d8\u4e0a\uff0c\u8fd9\u6837\u786e\u4fdd\u786c\u76d8\u4e0a\u7684\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u662f\u6700\u65b0\u7684\uff1bsfs_read\u548csfs_write\u51fd\u6570\u90fd\u8c03\u7528\u4e86\u4e00\u4e2a\u51fd\u6570sfs_io\uff0c\u5e76\u6700\u7ec8\u901a\u8fc7\u8bbf\u95ee\u786c\u76d8\u9a71\u52a8\u6765\u5b8c\u6210\u5bf9\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u7684\u8bfb\u5199\u3002 Inode\u7684\u76ee\u5f55\u64cd\u4f5c\u51fd\u6570 static const struct inode_ops sfs_node_dirops = { .vop_magic = VOP_MAGIC, .vop_open = sfs_opendir, .vop_close = sfs_close, .vop_getdirentry = sfs_getdirentry, .vop_lookup = sfs_lookup, \u2026\u2026 }; \u5bf9\u4e8e\u76ee\u5f55\u64cd\u4f5c\u800c\u8a00\uff0c\u7531\u4e8e\u76ee\u5f55\u4e5f\u662f\u4e00\u79cd\u6587\u4ef6\uff0c\u6240\u4ee5sfs_opendir\u3001sys_close\u5bf9\u5e94\u6237\u8fdb\u7a0b\u53d1\u51fa\u7684open\u3001close\u51fd\u6570\u3002\u76f8\u5bf9\u4e8esfs_open\uff0csfs_opendir\u53ea\u662f\u5b8c\u6210\u4e00\u4e9bopen\u51fd\u6570\u4f20\u9012\u7684\u53c2\u6570\u5224\u65ad\uff0c\u6ca1\u505a\u5176\u4ed6\u66f4\u591a\u7684\u4e8b\u60c5\u3002\u76ee\u5f55\u7684close\u64cd\u4f5c\u4e0e\u6587\u4ef6\u7684close\u64cd\u4f5c\u5b8c\u5168\u4e00\u81f4\u3002\u7531\u4e8e\u76ee\u5f55\u7684\u5185\u5bb9\u6570\u636e\u4e0e\u6587\u4ef6\u7684\u5185\u5bb9\u6570\u636e\u4e0d\u540c\uff0c\u6240\u4ee5\u8bfb\u51fa\u76ee\u5f55\u7684\u5185\u5bb9\u6570\u636e\u7684\u51fd\u6570\u662fsfs_getdirentry\uff0c\u5176\u4e3b\u8981\u5de5\u4f5c\u662f\u83b7\u53d6\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6inode\u4fe1\u606f\u3002 \u8bbe\u5907\u5c42\u6587\u4ef6 IO \u5c42 \u00b6 \u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u4e3a\u4e86\u7edf\u4e00\u5730\u8bbf\u95ee\u8bbe\u5907\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u4e00\u4e2a\u8bbe\u5907\u770b\u6210\u4e00\u4e2a\u6587\u4ef6\uff0c\u901a\u8fc7\u8bbf\u95ee\u6587\u4ef6\u7684\u63a5\u53e3\u6765\u8bbf\u95ee\u8bbe\u5907\u3002\u76ee\u524d\u5b9e\u73b0\u4e86stdin\u8bbe\u5907\u6587\u4ef6\u6587\u4ef6\u3001stdout\u8bbe\u5907\u6587\u4ef6\u3001disk0\u8bbe\u5907\u3002stdin\u8bbe\u5907\u5c31\u662f\u4e32\u53e3\uff0cstdout\u8bbe\u5907\u5c31\u662fCONSOLE\uff08\u4e32\u53e3\uff09\uff0c\u800cdisk0\u8bbe\u5907\u662f\u627f\u8f7dSFS\u6587\u4ef6\u7cfb\u7edf\u7684\u78c1\u76d8\u8bbe\u5907\u3002\u4e0b\u9762\u6211\u4eec\u9010\u4e00\u5206\u6790ucore\u662f\u5982\u4f55\u8ba9\u7528\u6237\u628a\u8bbe\u5907\u770b\u6210\u6587\u4ef6\u6765\u8bbf\u95ee\u3002 \u5173\u952e\u6570\u636e\u7ed3\u6784 \u00b6 \u4e3a\u4e86\u8868\u793a\u4e00\u4e2a\u8bbe\u5907\uff0c\u9700\u8981\u6709\u5bf9\u5e94\u7684\u6570\u636e\u7ed3\u6784\uff0cucore\u4e3a\u6b64\u5b9a\u4e49\u4e86struct device\uff0c\u5176\u63cf\u8ff0\u5982\u4e0b\uff1a struct device { size_t d_blocks; //\u8bbe\u5907\u5360\u7528\u7684\u6570\u636e\u5757\u4e2a\u6570 size_t d_blocksize; //\u6570\u636e\u5757\u7684\u5927\u5c0f int (*d_open)(struct device *dev, uint32_t open_flags); //\u6253\u5f00\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488 int (*d_close)(struct device *dev); //\u5173\u95ed\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488 int (*d_io)(struct device *dev, struct iobuf *iob, bool write); //\u8bfb\u5199\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488 int (*d_ioctl)(struct device *dev, int op, void *data); //\u7528ioctl\u65b9\u5f0f\u63a7\u5236\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488 }; \u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u80fd\u591f\u652f\u6301\u5bf9\u5757\u8bbe\u5907\uff08\u6bd4\u5982\u78c1\u76d8\uff09\u3001\u5b57\u7b26\u8bbe\u5907\uff08\u6bd4\u5982\u4e32\u53e3\uff09\u7684\u8868\u793a\uff0c\u5b8c\u6210\u5bf9\u8bbe\u5907\u7684\u57fa\u672c\u64cd\u4f5c\u3002ucore\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4e86\u628a\u8fd9\u4e9b\u8bbe\u5907\u94fe\u63a5\u5728\u4e00\u8d77\uff0c\u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbe\u5907\u94fe\u8868\uff0c\u5373\u53cc\u5411\u94fe\u8868vdev_list\uff0c\u8fd9\u6837\u901a\u8fc7\u8bbf\u95ee\u6b64\u94fe\u8868\uff0c\u53ef\u4ee5\u627e\u5230ucore\u80fd\u591f\u8bbf\u95ee\u7684\u6240\u6709\u8bbe\u5907\u6587\u4ef6\u3002 \u4f46\u8fd9\u4e2a\u8bbe\u5907\u63cf\u8ff0\u6ca1\u6709\u4e0e\u6587\u4ef6\u7cfb\u7edf\u4ee5\u53ca\u8868\u793a\u4e00\u4e2a\u6587\u4ef6\u7684inode\u6570\u636e\u7ed3\u6784\u5efa\u7acb\u5173\u7cfb\uff0c\u4e3a\u6b64\uff0c\u8fd8\u9700\u8981\u53e6\u5916\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u628adevice\u548cinode\u8054\u901a\u8d77\u6765\uff0c\u8fd9\u5c31\u662fvfs_dev_t\u6570\u636e\u7ed3\u6784\uff1a // device info entry in vdev_list typedef struct { const char *devname; struct inode *devnode; struct fs *fs; bool mountable; list_entry_t vdev_link; } vfs_dev_t; \u5229\u7528vfs_dev_t\u6570\u636e\u7ed3\u6784\uff0c\u5c31\u53ef\u4ee5\u8ba9\u6587\u4ef6\u7cfb\u7edf\u901a\u8fc7\u4e00\u4e2a\u94fe\u63a5vfs_dev_t\u7ed3\u6784\u7684\u53cc\u5411\u94fe\u8868\u627e\u5230device\u5bf9\u5e94\u7684inode\u6570\u636e\u7ed3\u6784\uff0c\u4e00\u4e2ainode\u8282\u70b9\u7684\u6210\u5458\u53d8\u91cfin_type\u7684\u503c\u662f0x1234\uff0c\u5219\u6b64 inode\u7684\u6210\u5458\u53d8\u91cfin_info\u5c06\u6210\u4e3a\u4e00\u4e2adevice\u7ed3\u6784\u3002\u8fd9\u6837inode\u5c31\u548c\u4e00\u4e2a\u8bbe\u5907\u5efa\u7acb\u4e86\u8054\u7cfb\uff0c\u8fd9\u4e2ainode\u5c31\u662f\u4e00\u4e2a\u8bbe\u5907\u6587\u4ef6\u3002 stdout\u8bbe\u5907\u6587\u4ef6 \u00b6 \u521d\u59cb\u5316 \u65e2\u7136stdout\u8bbe\u5907\u662f\u8bbe\u5907\u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\uff0c\u81ea\u7136\u6709\u81ea\u5df1\u7684inode\u7ed3\u6784\u3002\u5728\u7cfb\u7edf\u521d\u59cb\u5316\u65f6\uff0c\u5373\u53ea\u9700\u5982\u4e0b\u5904\u7406\u8fc7\u7a0b kern_init-->fs_init-->dev_init-->dev_init_stdout --> dev_create_inode --> stdout_device_init --> vfs_add_dev \u5728dev_init_stdout\u4e2d\u5b8c\u6210\u4e86\u5bf9stdout\u8bbe\u5907\u6587\u4ef6\u7684\u521d\u59cb\u5316\u3002\u5373\u9996\u5148\u521b\u5efa\u4e86\u4e00\u4e2ainode\uff0c\u7136\u540e\u901a\u8fc7stdout_device_init\u5b8c\u6210\u5bf9inode\u4e2d\u7684\u6210\u5458\u53d8\u91cfinode->__device_info\u8fdb\u884c\u521d\u59cb\uff1a \u8fd9\u91cc\u7684stdout\u8bbe\u5907\u6587\u4ef6\u5b9e\u9645\u4e0a\u5c31\u662f\u6307\u7684console\u5916\u8bbe\uff08\u5b83\u5176\u5b9e\u662f\u4e32\u53e3\u3001\u5e76\u53e3\u548cCGA\u7684\u7ec4\u5408\u578b\u5916\u8bbe\uff09\u3002\u8fd9\u4e2a\u8bbe\u5907\u6587\u4ef6\u662f\u4e00\u4e2a\u53ea\u5199\u8bbe\u5907\uff0c\u5982\u679c\u8bfb\u8fd9\u4e2a\u8bbe\u5907\uff0c\u5c31\u4f1a\u51fa\u9519\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u770bstdout\u8bbe\u5907\u7684\u76f8\u5173\u5904\u7406\u8fc7\u7a0b\u3002 \u521d\u59cb\u5316 stdout\u8bbe\u5907\u6587\u4ef6\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u4e3b\u8981\u7531stdout_device_init\u5b8c\u6210\uff0c\u5176\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a static void stdout_device_init(struct device *dev) { dev->d_blocks = 0; dev->d_blocksize = 1; dev->d_open = stdout_open; dev->d_close = stdout_close; dev->d_io = stdout_io; dev->d_ioctl = stdout_ioctl; } \u53ef\u4ee5\u770b\u5230\uff0cstdout_open\u51fd\u6570\u5b8c\u6210\u8bbe\u5907\u6587\u4ef6\u6253\u5f00\u5de5\u4f5c\uff0c\u5982\u679c\u53d1\u73b0\u7528\u6237\u8fdb\u7a0b\u8c03\u7528open\u51fd\u6570\u7684\u53c2\u6570flags\u4e0d\u662f\u53ea\u5199\uff08O_WRONLY\uff09\uff0c\u5219\u4f1a\u62a5\u9519\u3002 \u8bbf\u95ee\u64cd\u4f5c\u5b9e\u73b0 stdout_io\u51fd\u6570\u5b8c\u6210\u8bbe\u5907\u7684\u5199\u64cd\u4f5c\u5de5\u4f5c\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a static int stdout_io(struct device *dev, struct iobuf *iob, bool write) { if (write) { char *data = iob->io_base; for (; iob->io_resid != 0; iob->io_resid --) { cputchar(*data ++); } return 0; } return -E_INVAL; } \u53ef\u4ee5\u770b\u5230\uff0c\u8981\u5199\u7684\u6570\u636e\u653e\u5728iob->io_base\u6240\u6307\u7684\u5185\u5b58\u533a\u57df\uff0c\u4e00\u76f4\u5199\u5230iob->io_resid\u7684\u503c\u4e3a0\u4e3a\u6b62\u3002\u6bcf\u6b21\u5199\u64cd\u4f5c\u90fd\u662f\u901a\u8fc7cputchar\u6765\u5b8c\u6210\u7684\uff0c\u6b64\u51fd\u6570\u6700\u7ec8\u5c06\u901a\u8fc7console\u5916\u8bbe\u9a71\u52a8\u6765\u5b8c\u6210\u628a\u6570\u636e\u8f93\u51fa\u5230\u4e32\u53e3\u3001\u5e76\u53e3\u548cCGA\u663e\u793a\u5668\u4e0a\u8fc7\u7a0b\u3002\u53e6\u5916\uff0c\u4e5f\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c\u5982\u679c\u7528\u6237\u60f3\u6267\u884c\u8bfb\u64cd\u4f5c\uff0c\u5219stdout_io\u51fd\u6570\u76f4\u63a5\u8fd4\u56de\u9519\u8bef\u503c-E_INVAL\u3002 stdin \u8bbe\u5907\u6587\u4ef6 \u00b6 \u8fd9\u91cc\u7684stdin\u8bbe\u5907\u6587\u4ef6\u5b9e\u9645\u4e0a\u5c31\u662f\u6307\u7684\u4e32\u53e3\u3002\u8fd9\u4e2a\u8bbe\u5907\u6587\u4ef6\u662f\u4e00\u4e2a\u53ea\u8bfb\u8bbe\u5907\uff0c\u5982\u679c\u5199\u8fd9\u4e2a\u8bbe\u5907\uff0c\u5c31\u4f1a\u51fa\u9519\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u770bstdin\u8bbe\u5907\u7684\u76f8\u5173\u5904\u7406\u8fc7\u7a0b\u3002 \u521d\u59cb\u5316 stdin\u8bbe\u5907\u6587\u4ef6\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u4e3b\u8981\u7531stdin_device_init\u5b8c\u6210\u4e86\u4e3b\u8981\u7684\u521d\u59cb\u5316\u5de5\u4f5c\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a static void stdin_device_init(struct device *dev) { dev->d_blocks = 0; dev->d_blocksize = 1; dev->d_open = stdin_open; dev->d_close = stdin_close; dev->d_io = stdin_io; dev->d_ioctl = stdin_ioctl; p_rpos = p_wpos = 0; wait_queue_init(wait_queue); } \u76f8\u5bf9\u4e8estdout\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\uff0cstdin\u7684\u521d\u59cb\u5316\u76f8\u5bf9\u590d\u6742\u4e00\u4e9b\uff0c\u591a\u4e86\u4e00\u4e2astdin_buffer\u7f13\u51b2\u533a\uff0c\u63cf\u8ff0\u7f13\u51b2\u533a\u8bfb\u5199\u4f4d\u7f6e\u7684\u53d8\u91cfp_rpos\u3001p_wpos\u4ee5\u53ca\u7528\u4e8e\u7b49\u5f85\u7f13\u51b2\u533a\u7684\u7b49\u5f85\u961f\u5217wait_queue\u3002\u5728stdin_device_init\u51fd\u6570\u7684\u521d\u59cb\u5316\u4e2d\uff0c\u4e5f\u5b8c\u6210\u4e86\u5bf9p_rpos\u3001p_wpos\u548cwait_queue\u7684\u521d\u59cb\u5316\u3002 \u8bbf\u95ee\u64cd\u4f5c\u5b9e\u73b0 stdin_io\u51fd\u6570\u8d1f\u8d23\u5b8c\u6210\u8bbe\u5907\u7684\u8bfb\u64cd\u4f5c\u5de5\u4f5c\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a static int stdin_io(struct device *dev, struct iobuf *iob, bool write) { if (!write) { int ret; if ((ret = dev_stdin_read(iob->io_base, iob->io_resid)) > 0) { iob->io_resid -= ret; } return ret; } return -E_INVAL; } \u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u662f\u5199\u64cd\u4f5c\uff0c\u5219stdin_io\u51fd\u6570\u76f4\u63a5\u62a5\u9519\u8fd4\u56de\u3002\u6240\u4ee5\u8fd9\u4e5f\u8fdb\u4e00\u6b65\u8bf4\u660e\u4e86\u6b64\u8bbe\u5907\u6587\u4ef6\u662f\u53ea\u8bfb\u6587\u4ef6\u3002\u5982\u679c\u6b64\u8bfb\u64cd\u4f5c\uff0c\u5219\u6b64\u51fd\u6570\u8fdb\u4e00\u6b65\u8c03\u7528dev_stdin_read\u51fd\u6570\u5b8c\u6210\u5bf9\u952e\u76d8\u8bbe\u5907\u7684\u8bfb\u5165\u64cd\u4f5c\u3002dev_stdin_read\u51fd\u6570\u7684\u5b9e\u73b0\u76f8\u5bf9\u590d\u6742\u4e00\u4e9b\uff0c\u4e3b\u8981\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a static int dev_stdin_read(char *buf, size_t len) { int ret = 0; bool intr_flag; local_intr_save(intr_flag); { for (; ret < len; ret ++, p_rpos ++) { try_again: if (p_rpos < p_wpos) { *buf ++ = stdin_buffer[p_rpos % stdin_BUFSIZE]; } else { wait_t __wait, *wait = &__wait; wait_current_set(wait_queue, wait, WT_KBD); local_intr_restore(intr_flag); schedule(); local_intr_save(intr_flag); wait_current_del(wait_queue, wait); if (wait->wakeup_flags == WT_KBD) { goto try_again; } break; } } } local_intr_restore(intr_flag); return ret; } \u5728\u4e0a\u8ff0\u51fd\u6570\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c\u5982\u679cp_rpos < p_wpos\uff0c\u5219\u8868\u793a\u6709\u952e\u76d8\u8f93\u5165\u7684\u65b0\u5b57\u7b26\u5728stdin_buffer\u4e2d\uff0c\u4e8e\u662f\u5c31\u4ecestdin_buffer\u4e2d\u53d6\u51fa\u65b0\u5b57\u7b26\u653e\u5230iobuf\u6307\u5411\u7684\u7f13\u51b2\u533a\u4e2d\uff1b\u5982\u679cp_rpos >=p_wpos\uff0c\u5219\u8868\u660e\u6ca1\u6709\u65b0\u5b57\u7b26\uff0c\u8fd9\u6837\u8c03\u7528read\u7528\u6237\u6001\u5e93\u51fd\u6570\u7684\u7528\u6237\u8fdb\u7a0b\u5c31\u9700\u8981\u91c7\u7528\u7b49\u5f85\u961f\u5217\u7684\u7761\u7720\u64cd\u4f5c\u8fdb\u5165\u7761\u7720\u72b6\u6001\uff0c\u7b49\u5f85\u952e\u76d8\u8f93\u5165\u5b57\u7b26\u7684\u4ea7\u751f\u3002 \u952e\u76d8\u8f93\u5165\u5b57\u7b26\u540e\uff0c\u5982\u4f55\u5524\u9192\u7b49\u5f85\u952e\u76d8\u8f93\u5165\u7684\u7528\u6237\u8fdb\u7a0b\u5462\uff1f\u56de\u987elab1\u4e2d\u7684\u5916\u8bbe\u4e2d\u65ad\u5904\u7406\uff0c\u53ef\u4ee5\u4e86\u89e3\u5230\uff0c\u5f53\u7528\u6237\u5728QEMU\u63a7\u5236\u53f0\u8f93\u5165\u5b57\u7b26\u65f6\uff0c\u4f1a\u4ea7\u751f\u4e32\u53e3\u4e2d\u65ad\uff0c\u5728trap_dispatch\u51fd\u6570\u4e2d\uff0c\u5f53\u8bc6\u522b\u51fa\u4e2d\u65ad\u662f\u4e32\u53e3\u4e2d\u65ad\u65f6\uff0c\u4f1a\u8c03\u7528dev_stdin_write\u51fd\u6570\uff0c\u6765\u628a\u5b57\u7b26\u5199\u5165\u5230stdin_buffer\u4e2d\uff0c\u4e14\u4f1a\u901a\u8fc7\u7b49\u5f85\u961f\u5217\u7684\u5524\u9192\u64cd\u4f5c\u5524\u9192\u6b63\u5728\u7b49\u5f85\u952e\u76d8\u8f93\u5165\u7684\u7528\u6237\u8fdb\u7a0b\u3002 \u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0 \u00b6 \u4e0e\u4e4b\u524d\u76f8\u6bd4\uff0c\u5b9e\u9a8c\u56db\u589e\u52a0\u4e86\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u56e0\u6b64\u5b9e\u73b0\u4e86\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u6765\u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6\u5230\u5185\u5b58\u4e2d\u8fd0\u884c\u7684\u529f\u80fd\uff0c\u5bfc\u81f4\u5bf9\u8fdb\u7a0b\u7ba1\u7406\u76f8\u5173\u7684\u5b9e\u73b0\u6bd4\u8f83\u5927\u7684\u8c03\u6574\u3002\u6211\u4eec\u6765\u7b80\u5355\u770b\u770b\u6587\u4ef6\u7cfb\u7edf\u662f\u5982\u4f55\u521d\u59cb\u5316\u5e76\u80fd\u5728ucore\u7684\u7ba1\u7406\u4e0b\u6b63\u5e38\u5de5\u4f5c\u7684\u3002 \u9996\u5148\u770b\u770bkern_init\u51fd\u6570\uff0c\u53ef\u4ee5\u53d1\u73b0\u4e0e\u4e4b\u524d\u76f8\u6bd4\u589e\u52a0\u4e86\u5bf9fs_init\u51fd\u6570\u7684\u8c03\u7528\u3002fs_init\u51fd\u6570\u5c31\u662f\u6587\u4ef6\u7cfb\u7edf\u521d\u59cb\u5316\u7684\u603b\u63a7\u51fd\u6570\uff0c\u5b83\u8fdb\u4e00\u6b65\u8c03\u7528\u4e86\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u521d\u59cb\u5316\u51fd\u6570vfs_init\uff0c\u4e0e\u6587\u4ef6\u76f8\u5173\u7684\u8bbe\u5907\u521d\u59cb\u5316\u51fd\u6570dev_init\u548cSimple FS\u6587\u4ef6\u7cfb\u7edf\u7684\u521d\u59cb\u5316\u51fd\u6570sfs_init\u3002\u8fd9\u4e09\u4e2a\u521d\u59cb\u5316\u51fd\u6570\u8054\u5408\u5728\u4e00\u8d77\uff0c\u534f\u540c\u5b8c\u6210\u4e86\u6574\u4e2a\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u3001SFS\u6587\u4ef6\u7cfb\u7edf\u548c\u6587\u4ef6\u7cfb\u7edf\u5bf9\u5e94\u7684\u8bbe\u5907\uff08\u4e32\u53e3\u3001\u78c1\u76d8\uff09\u7684\u521d\u59cb\u5316\u5de5\u4f5c\u3002\u5176\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a \u6587\u4ef6\u7cfb\u7edf\u521d\u59cb\u5316\u8c03\u7528\u5173\u7cfb\u56fe \u53c2\u8003\u4e0a\u56fe\uff0c\u5e76\u7ed3\u5408\u6e90\u7801\u5206\u6790\uff0c\u53ef\u5927\u81f4\u4e86\u89e3\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u6574\u4e2a\u521d\u59cb\u5316\u6d41\u7a0b\u3002vfs_init\u4e3b\u8981\u5efa\u7acb\u4e86\u4e00\u4e2adevice list\u53cc\u5411\u94fe\u8868vdev_list\uff0c\u4e3a\u540e\u7eed\u5177\u4f53\u8bbe\u5907\uff08\u4e32\u53e3\u3001\u78c1\u76d8\uff09\u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u5448\u73b0\u5efa\u7acb\u67e5\u627e\u8bbf\u95ee\u901a\u9053\u3002dev_init\u51fd\u6570\u901a\u8fc7\u8fdb\u4e00\u6b65\u8c03\u7528disk0/stdin/stdout_device_init\u5b8c\u6210\u5bf9\u5177\u4f53\u8bbe\u5907\u7684\u521d\u59cb\u5316\uff0c\u628a\u5b83\u4eec\u62bd\u8c61\u6210\u4e00\u4e2a\u8bbe\u5907\u6587\u4ef6\uff0c\u5e76\u5efa\u7acb\u5bf9\u5e94\u7684inode\u6570\u636e\u7ed3\u6784\uff0c\u6700\u540e\u628a\u5b83\u4eec\u94fe\u5165\u5230vdev_list\u4e2d\u3002\u8fd9\u6837\u901a\u8fc7\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u5c31\u53ef\u4ee5\u65b9\u4fbf\u5730\u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u8bbf\u95ee\u8fd9\u4e9b\u8bbe\u5907\u4e86\u3002sfs_init\u662f\u5b8c\u6210\u5bf9Simple FS\u7684\u521d\u59cb\u5316\u5de5\u4f5c\uff0c\u5e76\u628a\u6b64\u5b9e\u4f8b\u6587\u4ef6\u7cfb\u7edf\u6302\u5728\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u4ece\u800c\u8ba9ucore\u7684\u5176\u4ed6\u90e8\u5206\u80fd\u591f\u901a\u8fc7\u8bbf\u95ee\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u7684\u63a5\u53e3\u6765\u8fdb\u4e00\u6b65\u8bbf\u95ee\u5230SFS\u5b9e\u4f8b\u6587\u4ef6\u7cfb\u7edf\u3002 \u6587\u4ef6\u64cd\u4f5c\u5b9e\u73b0 \u00b6 \u6253\u5f00\u6587\u4ef6 \u00b6 \u6709\u4e86\u4e0a\u8ff0\u5206\u6790\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u770b\u5982\u679c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u6253\u5f00\u6587\u4ef6\u4f1a\u505a\u54ea\u4e9b\u4e8b\u60c5\uff1f\u9996\u5148\u5047\u5b9a\u7528\u6237\u8fdb\u7a0b\u9700\u8981\u6253\u5f00\u7684\u6587\u4ef6\u5df2\u7ecf\u5b58\u5728\u5728\u786c\u76d8\u4e0a\u3002\u4ee5user/sfs_filetest1.c\u4e3a\u4f8b\uff0c\u9996\u5148\u7528\u6237\u8fdb\u7a0b\u4f1a\u8c03\u7528\u5728main\u51fd\u6570\u4e2d\u7684\u5982\u4e0b\u8bed\u53e5\uff1a int fd1 = safe_open(\"sfs\\_filetest1\", O_RDONLY); \u4ece\u5b57\u9762\u4e0a\u53ef\u4ee5\u770b\u51fa\uff0c\u5982\u679cucore\u80fd\u591f\u6b63\u5e38\u67e5\u627e\u5230\u8fd9\u4e2a\u6587\u4ef6\uff0c\u5c31\u4f1a\u8fd4\u56de\u4e00\u4e2a\u4ee3\u8868\u6587\u4ef6\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26fd1\uff0c\u8fd9\u6837\u5728\u63a5\u4e0b\u6765\u7684\u8bfb\u5199\u6587\u4ef6\u8fc7\u7a0b\u4e2d\uff0c\u5c31\u76f4\u63a5\u7528\u8fd9\u6837fd1\u6765\u4ee3\u8868\u5c31\u53ef\u4ee5\u4e86\u3002\u90a3\u8fd9\u4e2a\u6253\u5f00\u6587\u4ef6\u7684\u8fc7\u7a0b\u662f\u5982\u4f55\u4e00\u6b65\u4e00\u6b65\u5b9e\u73b0\u7684\u5462\uff1f \u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b \u9996\u5148\u8fdb\u5165\u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u5373\u8fdb\u4e00\u6b65\u8c03\u7528\u5982\u4e0b\u7528\u6237\u6001\u51fd\u6570\uff1a open->sys_open->syscall\uff0c\u4ece\u800c\u5f15\u8d77\u7cfb\u7edf\u8c03\u7528\u8fdb\u5165\u5230\u5185\u6838\u6001\u3002\u5230\u4e86\u5185\u6838\u6001\u540e\uff0c\u901a\u8fc7\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b\uff0c\u4f1a\u8c03\u7528\u5230sys_open\u5185\u6838\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528sysfile_open\u5185\u6838\u51fd\u6570\u3002\u5230\u4e86\u8fd9\u91cc\uff0c\u9700\u8981\u628a\u4f4d\u4e8e\u7528\u6237\u7a7a\u95f4\u7684\u5b57\u7b26\u4e32\"sfs_filetest1\"\u62f7\u8d1d\u5230\u5185\u6838\u7a7a\u95f4\u4e2d\u7684\u5b57\u7b26\u4e32path\u4e2d\uff0c\u5e76\u8fdb\u5165\u5230\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u6d41\u7a0b\u5b8c\u6210\u8fdb\u4e00\u6b65\u7684\u6253\u5f00\u6587\u4ef6\u64cd\u4f5c\u4e2d\u3002 \u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u6d41\u7a0b \u5206\u914d\u4e00\u4e2a\u7a7a\u95f2\u7684file\u6570\u636e\u7ed3\u6784\u53d8\u91cffile\u5728\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u4e2d\uff0c\u9996\u5148\u8c03\u7528\u7684\u662ffile_open\u51fd\u6570\uff0c\u5b83\u8981\u7ed9\u8fd9\u4e2a\u5373\u5c06\u6253\u5f00\u7684\u6587\u4ef6\u5206\u914d\u4e00\u4e2afile\u6570\u636e\u7ed3\u6784\u7684\u53d8\u91cf\uff0c\u8fd9\u4e2a\u53d8\u91cf\u5176\u5b9e\u662f\u5f53\u524d\u8fdb\u7a0b\u7684\u6253\u5f00\u6587\u4ef6\u6570\u7ec4current->fs_struct->filemap[]\u4e2d\u7684\u4e00\u4e2a\u7a7a\u95f2\u5143\u7d20\uff08\u5373\u8fd8\u6ca1\u7528\u4e8e\u4e00\u4e2a\u6253\u5f00\u7684\u6587\u4ef6\uff09\uff0c\u800c\u8fd9\u4e2a\u5143\u7d20\u7684\u7d22\u5f15\u503c\u5c31\u662f\u6700\u7ec8\u8981\u8fd4\u56de\u5230\u7528\u6237\u8fdb\u7a0b\u5e76\u8d4b\u503c\u7ed9\u53d8\u91cffd1\u3002\u5230\u4e86\u8fd9\u4e00\u6b65\u8fd8\u4ec5\u4ec5\u662f\u7ed9\u5f53\u524d\u7528\u6237\u8fdb\u7a0b\u5206\u914d\u4e86\u4e00\u4e2afile\u6570\u636e\u7ed3\u6784\u7684\u53d8\u91cf\uff0c\u8fd8\u6ca1\u6709\u627e\u5230\u5bf9\u5e94\u7684\u6587\u4ef6\u7d22\u5f15\u8282\u70b9\u3002 \u4e3a\u6b64\u9700\u8981\u8fdb\u4e00\u6b65\u8c03\u7528vfs_open\u51fd\u6570\u6765\u627e\u5230path\u6307\u51fa\u7684\u6587\u4ef6\u6240\u5bf9\u5e94\u7684\u57fa\u4e8einode\u6570\u636e\u7ed3\u6784\u7684VFS\u7d22\u5f15\u8282\u70b9node\u3002vfs_open\u51fd\u6570\u9700\u8981\u5b8c\u6210\u4e24\u4ef6\u4e8b\u60c5\uff1a\u901a\u8fc7vfs_lookup\u627e\u5230path\u5bf9\u5e94\u6587\u4ef6\u7684inode\uff1b\u8c03\u7528vop_open\u51fd\u6570\u6253\u5f00\u6587\u4ef6\u3002 \u627e\u5230\u6587\u4ef6\u8bbe\u5907\u7684\u6839\u76ee\u5f55\u201c/\u201d\u7684\u7d22\u5f15\u8282\u70b9\u9700\u8981\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684vfs_lookup\u51fd\u6570\u662f\u4e00\u4e2a\u9488\u5bf9\u76ee\u5f55\u7684\u64cd\u4f5c\u51fd\u6570\uff0c\u5b83\u4f1a\u8c03\u7528vop_lookup\u51fd\u6570\u6765\u627e\u5230SFS\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u201c/\u201d\u76ee\u5f55\u4e0b\u7684\u201csfs_filetest1\u201d\u6587\u4ef6\u3002\u4e3a\u6b64\uff0cvfs_lookup\u51fd\u6570\u9996\u5148\u8c03\u7528get_device\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528vfs_get_bootfs\u51fd\u6570\uff08\u5176\u5b9e\u8c03\u7528\u4e86\uff09\u6765\u627e\u5230\u6839\u76ee\u5f55\u201c/\u201d\u5bf9\u5e94\u7684inode\u3002\u8fd9\u4e2ainode\u5c31\u662f\u4f4d\u4e8evfs.c\u4e2d\u7684inode\u53d8\u91cfbootfs_node\u3002\u8fd9\u4e2a\u53d8\u91cf\u5728init_main\u51fd\u6570\uff08\u4f4d\u4e8ekern/process/proc.c\uff09\u6267\u884c\u65f6\u83b7\u5f97\u4e86\u8d4b\u503c\u3002 \u901a\u8fc7\u8c03\u7528vop_lookup\u51fd\u6570\u6765\u67e5\u627e\u5230\u6839\u76ee\u5f55\u201c/\u201d\u4e0b\u5bf9\u5e94\u6587\u4ef6sfs_filetest1\u7684\u7d22\u5f15\u8282\u70b9\uff0c\uff0c\u5982\u679c\u627e\u5230\u5c31\u8fd4\u56de\u6b64\u7d22\u5f15\u8282\u70b9\u3002 \u628afile\u548cnode\u5efa\u7acb\u8054\u7cfb\u3002\u5b8c\u6210\u7b2c3\u6b65\u540e\uff0c\u5c06\u8fd4\u56de\u5230file_open\u51fd\u6570\u4e2d\uff0c\u901a\u8fc7\u6267\u884c\u8bed\u53e5\u201cfile->node=node;\u201d\uff0c\u5c31\u628a\u5f53\u524d\u8fdb\u7a0b\u7684current->fs_struct->filemap[fd]\uff08\u5373file\u6240\u6307\u53d8\u91cf\uff09\u7684\u6210\u5458\u53d8\u91cfnode\u6307\u9488\u6307\u5411\u4e86\u4ee3\u8868sfs_filetest1\u6587\u4ef6\u7684\u7d22\u5f15\u8282\u70b9inode\u3002\u8fd9\u65f6\u8fd4\u56defd\u3002\u7ecf\u8fc7\u91cd\u91cd\u56de\u9000\uff0c\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\uff0c\u7528\u6237\u6001\u7684syscall->sys_open->open->safe_open\u7b49\u7528\u6237\u51fd\u6570\u7684\u5c42\u5c42\u51fd\u6570\u8fd4\u56de\uff0c\u6700\u7ec8\u628a\u628afd\u8d4b\u503c\u7ed9fd1\u3002\u81ea\u6b64\u5b8c\u6210\u4e86\u6253\u5f00\u6587\u4ef6\u64cd\u4f5c\u3002\u4f46\u8fd9\u91cc\u6211\u4eec\u8fd8\u6ca1\u6709\u5206\u6790\u7b2c2\u548c\u7b2c3\u6b65\u662f\u5982\u4f55\u8fdb\u4e00\u6b65\u8c03\u7528SFS\u6587\u4ef6\u7cfb\u7edf\u63d0\u4f9b\u7684\u51fd\u6570\u627e\u4f4d\u4e8eSFS\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684sfs_filetest1\u6587\u4ef6\u6240\u5bf9\u5e94\u7684sfs\u78c1\u76d8inode\u7684\u8fc7\u7a0b\u3002\u4e0b\u9762\u9700\u8981\u8fdb\u4e00\u6b65\u5bf9\u6b64\u8fdb\u884c\u5206\u6790\u3002 SFS\u6587\u4ef6\u7cfb\u7edf\u5c42\u7684\u5904\u7406\u6d41\u7a0b \u8fd9\u91cc\u9700\u8981\u5206\u6790\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u4e2d\u6ca1\u6709\u5f7b\u5e95\u5206\u6790\u7684vop_lookup\u51fd\u6570\u5230\u5e95\u505a\u4e86\u5565\u3002\u4e0b\u9762\u6211\u4eec\u6765\u770b\u770b\u3002\u5728sfs_inode.c\u4e2d\u7684sfs_node_dirops\u53d8\u91cf\u5b9a\u4e49\u4e86\u201c.vop_lookup = sfs_lookup\u201d\uff0c\u6240\u4ee5\u6211\u4eec\u91cd\u70b9\u5206\u6790sfs_lookup\u7684\u5b9e\u73b0\u3002\u6ce8\u610f\uff1a\u5728lab4\u4e2d\uff0c\u4e3a\u7b80\u5316\u4ee3\u7801\uff0csfs_lookup\u51fd\u6570\u4e2d\u5e76\u6ca1\u6709\u5b9e\u73b0\u80fd\u591f\u5bf9\u591a\u7ea7\u76ee\u5f55\u8fdb\u884c\u67e5\u627e\u7684\u63a7\u5236\u903b\u8f91\uff08\u5728ucore_plus\u4e2d\u6709\u5b9e\u73b0\uff09\u3002 sfs_lookup\u6709\u4e09\u4e2a\u53c2\u6570\uff1anode\uff0cpath\uff0cnode_store\u3002\u5176\u4e2dnode\u662f\u6839\u76ee\u5f55\u201c/\u201d\u6240\u5bf9\u5e94\u7684inode\u8282\u70b9\uff1bpath\u662f\u6587\u4ef6sfs_filetest1\u7684\u7edd\u5bf9\u8def\u5f84/sfs_filetest1\uff0c\u800cnode_store\u662f\u7ecf\u8fc7\u67e5\u627e\u83b7\u5f97\u7684sfs_filetest1\u6240\u5bf9\u5e94\u7684inode\u8282\u70b9\u3002 sfs_lookup\u51fd\u6570\u4ee5\u201c/\u201d\u4e3a\u5206\u5272\u7b26\uff0c\u4ece\u5de6\u81f3\u53f3\u9010\u4e00\u5206\u89e3path\u83b7\u5f97\u5404\u4e2a\u5b50\u76ee\u5f55\u548c\u6700\u7ec8\u6587\u4ef6\u5bf9\u5e94\u7684inode\u8282\u70b9\u3002\u5728\u672c\u4f8b\u4e2d\u662f\u8c03\u7528sfs_lookup_once\u67e5\u627e\u4ee5\u6839\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6sfs_filetest1\u6240\u5bf9\u5e94\u7684inode\u8282\u70b9\u3002\u5f53\u65e0\u6cd5\u5206\u89e3path\u540e\uff0c\u5c31\u610f\u5473\u7740\u627e\u5230\u4e86sfs_filetest1\u5bf9\u5e94\u7684inode\u8282\u70b9\uff0c\u5c31\u53ef\u987a\u5229\u8fd4\u56de\u4e86\u3002 \u5f53\u7136\u8fd9\u91cc\u8bb2\u5f97\u8fd8\u6bd4\u8f83\u7b80\u5355\uff0csfs_lookup_once\u5c06\u8c03\u7528sfs_dirent_search_nolock\u51fd\u6570\u6765\u67e5\u627e\u4e0e\u8def\u5f84\u540d\u5339\u914d\u7684\u76ee\u5f55\u9879\uff0c\u5982\u679c\u627e\u5230\u76ee\u5f55\u9879\uff0c\u5219\u6839\u636e\u76ee\u5f55\u9879\u4e2d\u8bb0\u5f55\u7684inode\u6240\u5904\u7684\u6570\u636e\u5757\u7d22\u5f15\u503c\u627e\u5230\u8def\u5f84\u540d\u5bf9\u5e94\u7684SFS\u78c1\u76d8inode\uff0c\u5e76\u8bfb\u5165SFS\u78c1\u76d8inode\u5bf9\u7684\u5185\u5bb9\uff0c\u521b\u5efaSFS\u5185\u5b58inode\u3002 \u8bfb\u6587\u4ef6 \u00b6 \u8bfb\u6587\u4ef6\u5176\u5b9e\u5c31\u662f\u8bfb\u51fa\u76ee\u5f55\u4e2d\u7684\u76ee\u5f55\u9879\uff0c\u9996\u5148\u5047\u5b9a\u6587\u4ef6\u5728\u78c1\u76d8\u4e0a\u4e14\u5df2\u7ecf\u6253\u5f00\u3002\u7528\u6237\u8fdb\u7a0b\u6709\u5982\u4e0b\u8bed\u53e5\uff1a read(fd, data, len); \u5373\u8bfb\u53d6fd\u5bf9\u5e94\u6587\u4ef6\uff0c\u8bfb\u53d6\u957f\u5ea6\u4e3alen\uff0c\u5b58\u5165data\u4e2d\u3002\u4e0b\u9762\u6765\u5206\u6790\u4e00\u4e0b\u8bfb\u6587\u4ef6\u7684\u5b9e\u73b0\u3002 \u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b \u5148\u8fdb\u5165\u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u5373\u8fdb\u4e00\u6b65\u8c03\u7528\u5982\u4e0b\u7528\u6237\u6001\u51fd\u6570\uff1aread->sys_read->syscall\uff0c\u4ece\u800c\u5f15\u8d77\u7cfb\u7edf\u8c03\u7528\u8fdb\u5165\u5230\u5185\u6838\u6001\u3002\u5230\u4e86\u5185\u6838\u6001\u4ee5\u540e\uff0c\u901a\u8fc7\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b\uff0c\u4f1a\u8c03\u7528\u5230sys_read\u5185\u6838\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528sysfile_read\u5185\u6838\u51fd\u6570\uff0c\u8fdb\u5165\u5230\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u5904\u7406\u6d41\u7a0b\u5b8c\u6210\u8fdb\u4e00\u6b65\u8bfb\u6587\u4ef6\u7684\u64cd\u4f5c\u3002 \u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u6d41\u7a0b \\1) \u68c0\u67e5\u9519\u8bef\uff0c\u5373\u68c0\u67e5\u8bfb\u53d6\u957f\u5ea6\u662f\u5426\u4e3a0\u548c\u6587\u4ef6\u662f\u5426\u53ef\u8bfb\u3002 \\2) \u5206\u914dbuffer\u7a7a\u95f4\uff0c\u5373\u8c03\u7528kmalloc\u51fd\u6570\u5206\u914d4096\u5b57\u8282\u7684buffer\u7a7a\u95f4\u3002 \\3) \u8bfb\u6587\u4ef6\u8fc7\u7a0b [1] \u5b9e\u9645\u8bfb\u6587\u4ef6 \u5faa\u73af\u8bfb\u53d6\u6587\u4ef6\uff0c\u6bcf\u6b21\u8bfb\u53d6buffer\u5927\u5c0f\u3002\u6bcf\u6b21\u5faa\u73af\u4e2d\uff0c\u5148\u68c0\u67e5\u5269\u4f59\u90e8\u5206\u5927\u5c0f\uff0c\u82e5\u5176\u5c0f\u4e8e4096\u5b57\u8282\uff0c\u5219\u53ea\u8bfb\u53d6\u5269\u4f59\u90e8\u5206\u7684\u5927\u5c0f\u3002\u7136\u540e\u8c03\u7528file_read\u51fd\u6570\uff08\u8be6\u7ec6\u5206\u6790\u89c1\u540e\uff09\u5c06\u6587\u4ef6\u5185\u5bb9\u8bfb\u53d6\u5230buffer\u4e2d\uff0calen\u4e3a\u5b9e\u9645\u5927\u5c0f\u3002\u8c03\u7528copy_to_user\u51fd\u6570\u5c06\u8bfb\u5230\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u7528\u6237\u7684\u5185\u5b58\u7a7a\u95f4\u4e2d\uff0c\u8c03\u6574\u5404\u53d8\u91cf\u4ee5\u8fdb\u884c\u4e0b\u4e00\u6b21\u5faa\u73af\u8bfb\u53d6\uff0c\u76f4\u81f3\u6307\u5b9a\u957f\u5ea6\u8bfb\u53d6\u5b8c\u6210\u3002\u6700\u540e\u51fd\u6570\u8c03\u7528\u5c42\u5c42\u8fd4\u56de\u81f3\u7528\u6237\u7a0b\u5e8f\uff0c\u7528\u6237\u7a0b\u5e8f\u6536\u5230\u4e86\u8bfb\u5230\u7684\u6587\u4ef6\u5185\u5bb9\u3002 [2] file_read\u51fd\u6570 \u8fd9\u4e2a\u51fd\u6570\u662f\u8bfb\u6587\u4ef6\u7684\u6838\u5fc3\u51fd\u6570\u3002\u51fd\u6570\u67094\u4e2a\u53c2\u6570\uff0cfd\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0cbase\u662f\u7f13\u5b58\u7684\u57fa\u5730\u5740\uff0clen\u662f\u8981\u8bfb\u53d6\u7684\u957f\u5ea6\uff0ccopied_store\u5b58\u653e\u5b9e\u9645\u8bfb\u53d6\u7684\u957f\u5ea6\u3002\u51fd\u6570\u9996\u5148\u8c03\u7528fd2file\u51fd\u6570\u627e\u5230\u5bf9\u5e94\u7684file\u7ed3\u6784\uff0c\u5e76\u68c0\u67e5\u662f\u5426\u53ef\u8bfb\u3002\u8c03\u7528filemap_acquire\u51fd\u6570\u4f7f\u6253\u5f00\u8fd9\u4e2a\u6587\u4ef6\u7684\u8ba1\u6570\u52a01\u3002\u8c03\u7528vop_read\u51fd\u6570\u5c06\u6587\u4ef6\u5185\u5bb9\u8bfb\u5230iob\u4e2d\uff08\u8be6\u7ec6\u5206\u6790\u89c1\u540e\uff09\u3002\u8c03\u6574\u6587\u4ef6\u6307\u9488\u504f\u79fb\u91cfpos\u7684\u503c\uff0c\u4f7f\u5176\u5411\u540e\u79fb\u52a8\u5b9e\u9645\u8bfb\u5230\u7684\u5b57\u8282\u6570iobuf_used(iob)\u3002\u6700\u540e\u8c03\u7528filemap_release\u51fd\u6570\u4f7f\u6253\u5f00\u8fd9\u4e2a\u6587\u4ef6\u7684\u8ba1\u6570\u51cf1\uff0c\u82e5\u6253\u5f00\u8ba1\u6570\u4e3a0\uff0c\u5219\u91ca\u653efile\u3002 SFS\u6587\u4ef6\u7cfb\u7edf\u5c42\u7684\u5904\u7406\u6d41\u7a0b vop_read\u51fd\u6570\u5b9e\u9645\u4e0a\u662f\u5bf9sfs_read\u7684\u5305\u88c5\u3002\u5728sfs_inode.c\u4e2dsfs_node_fileops\u53d8\u91cf\u5b9a\u4e49\u4e86.vop_read = sfs_read\uff0c\u6240\u4ee5\u4e0b\u9762\u6765\u5206\u6790sfs_read\u51fd\u6570\u7684\u5b9e\u73b0\u3002 sfs_read\u51fd\u6570\u8c03\u7528sfs_io\u51fd\u6570\u3002\u5b83\u6709\u4e09\u4e2a\u53c2\u6570\uff0cnode\u662f\u5bf9\u5e94\u6587\u4ef6\u7684inode\uff0ciob\u662f\u7f13\u5b58\uff0cwrite\u8868\u793a\u662f\u8bfb\u8fd8\u662f\u5199\u7684\u5e03\u5c14\u503c\uff080\u8868\u793a\u8bfb\uff0c1\u8868\u793a\u5199\uff09\uff0c\u8fd9\u91cc\u662f0\u3002\u51fd\u6570\u5148\u627e\u5230inode\u5bf9\u5e94sfs\u548csin\uff0c\u7136\u540e\u8c03\u7528sfs_io_nolock\u51fd\u6570\u8fdb\u884c\u8bfb\u53d6\u6587\u4ef6\u64cd\u4f5c\uff0c\u6700\u540e\u8c03\u7528iobuf_skip\u51fd\u6570\u8c03\u6574iobuf\u7684\u6307\u9488\u3002 \u5728sfs_io_nolock\u51fd\u6570\u4e2d\uff0c\u5148\u8ba1\u7b97\u4e00\u4e9b\u8f85\u52a9\u53d8\u91cf\uff0c\u5e76\u5904\u7406\u4e00\u4e9b\u7279\u6b8a\u60c5\u51b5\uff08\u6bd4\u5982\u8d8a\u754c\uff09\uff0c\u7136\u540e\u6709sfs_buf_op = sfs_rbuf,sfs_block_op = sfs_rblock\uff0c\u8bbe\u7f6e\u8bfb\u53d6\u7684\u51fd\u6570\u64cd\u4f5c\u3002\u63a5\u7740\u8fdb\u884c\u5b9e\u9645\u64cd\u4f5c\uff0c\u5148\u5904\u7406\u8d77\u59cb\u7684\u6ca1\u6709\u5bf9\u9f50\u5230\u5757\u7684\u90e8\u5206\uff0c\u518d\u4ee5\u5757\u4e3a\u5355\u4f4d\u5faa\u73af\u5904\u7406\u4e2d\u95f4\u7684\u90e8\u5206\uff0c\u6700\u540e\u5904\u7406\u672b\u5c3e\u5269\u4f59\u7684\u90e8\u5206\u3002\u6bcf\u90e8\u5206\u4e2d\u90fd\u8c03\u7528sfs_bmap_load_nolock\u51fd\u6570\u5f97\u5230blkno\u5bf9\u5e94\u7684inode\u7f16\u53f7\uff0c\u5e76\u8c03\u7528sfs_rbuf\u6216sfs_rblock\u51fd\u6570\u8bfb\u53d6\u6570\u636e\uff08\u4e2d\u95f4\u90e8\u5206\u8c03\u7528sfs_rblock\uff0c\u8d77\u59cb\u548c\u672b\u5c3e\u90e8\u5206\u8c03\u7528sfs_rbuf\uff09\uff0c\u8c03\u6574\u76f8\u5173\u53d8\u91cf\u3002\u5b8c\u6210\u540e\u5982\u679coffset + alen > din->fileinfo.size\uff08\u5199\u6587\u4ef6\u65f6\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0c\u8bfb\u6587\u4ef6\u65f6\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0calen\u4e3a\u5b9e\u9645\u8bfb\u5199\u7684\u957f\u5ea6\uff09\uff0c\u5219\u8c03\u6574\u6587\u4ef6\u5927\u5c0f\u4e3aoffset + alen\u5e76\u8bbe\u7f6edirty\u53d8\u91cf\u3002 sfs_bmap_load_nolock\u51fd\u6570\u5c06\u5bf9\u5e94sfs_inode\u7684\u7b2cindex\u4e2a\u7d22\u5f15\u6307\u5411\u7684block\u7684\u7d22\u5f15\u503c\u53d6\u51fa\u5b58\u5230\u76f8\u5e94\u7684\u6307\u9488\u6307\u5411\u7684\u5355\u5143\uff08ino_store\uff09\u3002\u5b83\u8c03\u7528sfs_bmap_get_nolock\u6765\u5b8c\u6210\u76f8\u5e94\u7684\u64cd\u4f5c\u3002sfs_rbuf\u548csfs_rblock\u51fd\u6570\u6700\u7ec8\u90fd\u8c03\u7528sfs_rwblock_nolock\u51fd\u6570\u5b8c\u6210\u64cd\u4f5c\uff0c\u800csfs_rwblock_nolock\u51fd\u6570\u8c03\u7528dop_io->disk0_io->disk0_read_blks_nolock->ide_read_secs\u5b8c\u6210\u5bf9\u78c1\u76d8\u7684\u64cd\u4f5c\u3002","title":"\u80cc\u666f\u4ecb\u7ecd"},{"location":"lab4/intro/#_1","text":"","title":"\u6587\u4ef6\u7cfb\u7edf\u8bbe\u8ba1\u4e0e\u5b9e\u73b0"},{"location":"lab4/intro/#ucore","text":"\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8d1f\u8d23\u7ba1\u7406\u548c\u5b58\u50a8\u53ef\u957f\u671f\u4fdd\u5b58\u6570\u636e\u7684\u8f6f\u4ef6\u529f\u80fd\u6a21\u5757\u79f0\u4e3a\u6587\u4ef6\u7cfb\u7edf\u3002\u5728\u672c\u6b21\u8bd5\u9a8c\u4e2d\uff0c\u4e3b\u8981\u4fa7\u91cd\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbe\u8ba1\u5b9e\u73b0\u548c\u5bf9\u6587\u4ef6\u7cfb\u7edf\u6267\u884c\u6d41\u7a0b\u7684\u5206\u6790\u4e0e\u7406\u89e3\u3002 ucore\u7684\u6587\u4ef6\u7cfb\u7edf\u6a21\u578b\u6e90\u4e8eHavard\u7684OS161\u7684\u6587\u4ef6\u7cfb\u7edf\u548cLinux\u6587\u4ef6\u7cfb\u7edf\u3002\u4f46\u5176\u5b9e\u8fd9\u4e8c\u8005\u90fd\u662f\u6e90\u4e8e\u4f20\u7edf\u7684UNIX\u6587\u4ef6\u7cfb\u7edf\u8bbe\u8ba1\u3002UNIX\u63d0\u51fa\u4e86\u56db\u4e2a\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u6982\u5ff5\uff1a\u6587\u4ef6(file)\u3001\u76ee\u5f55\u9879(dentry)\u3001\u7d22\u5f15\u8282\u70b9(inode)\u548c\u5b89\u88c5\u70b9(mount point)\u3002 \u6587\u4ef6\uff1aUNIX\u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\u53ef\u7406\u89e3\u4e3a\u662f\u4e00\u6709\u5e8f\u5b57\u8282buffer\uff0c\u6587\u4ef6\u90fd\u6709\u4e00\u4e2a\u65b9\u4fbf\u5e94\u7528\u7a0b\u5e8f\u8bc6\u522b\u7684\u6587\u4ef6\u540d\u79f0\uff08\u4e5f\u79f0\u6587\u4ef6\u8def\u5f84\u540d\uff09\u3002\u5178\u578b\u7684\u6587\u4ef6\u64cd\u4f5c\u6709\u8bfb\u3001\u5199\u3001\u521b\u5efa\u548c\u5220\u9664\u7b49\u3002 \u76ee\u5f55\u9879\uff1a\u76ee\u5f55\u9879\u4e0d\u662f\u76ee\u5f55\uff08\u53c8\u79f0\u6587\u4ef6\u8def\u5f84\uff09\uff0c\u800c\u662f\u76ee\u5f55\u7684\u7ec4\u6210\u90e8\u5206\u3002\u5728UNIX\u4e2d\u76ee\u5f55\u88ab\u770b\u4f5c\u4e00\u79cd\u7279\u5b9a\u7684\u6587\u4ef6\uff0c\u800c\u76ee\u5f55\u9879\u662f\u6587\u4ef6\u8def\u5f84\u4e2d\u7684\u4e00\u90e8\u5206\u3002\u5982\u4e00\u4e2a\u6587\u4ef6\u8def\u5f84\u540d\u662f\u201c/test/testfile\u201d\uff0c\u5219\u5305\u542b\u7684\u76ee\u5f55\u9879\u4e3a\uff1a\u6839\u76ee\u5f55\u201c/\u201d\uff0c\u76ee\u5f55\u201ctest\u201d\u548c\u6587\u4ef6\u201ctestfile\u201d\uff0c\u8fd9\u4e09\u4e2a\u90fd\u662f\u76ee\u5f55\u9879\u3002\u4e00\u822c\u800c\u8a00\uff0c\u76ee\u5f55\u9879\u5305\u542b\u76ee\u5f55\u9879\u7684\u540d\u5b57\uff08\u6587\u4ef6\u540d\u6216\u76ee\u5f55\u540d\uff09\u548c\u76ee\u5f55\u9879\u7684\u7d22\u5f15\u8282\u70b9\uff08\u89c1\u4e0b\u9762\u7684\u63cf\u8ff0\uff09\u4f4d\u7f6e\u3002 \u7d22\u5f15\u8282\u70b9\uff1aUNIX\u5c06\u6587\u4ef6\u7684\u76f8\u5173\u5143\u6570\u636e\u4fe1\u606f\uff08\u5982\u8bbf\u95ee\u63a7\u5236\u6743\u9650\u3001\u5927\u5c0f\u3001\u62e5\u6709\u8005\u3001\u521b\u5efa\u65f6\u95f4\u3001\u6570\u636e\u5185\u5bb9\u7b49\u7b49\u4fe1\u606f\uff09\u5b58\u50a8\u5728\u4e00\u4e2a\u5355\u72ec\u7684\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u8be5\u7ed3\u6784\u88ab\u79f0\u4e3a\u7d22\u5f15\u8282\u70b9\u3002 \u5b89\u88c5\u70b9\uff1a\u5728UNIX\u4e2d\uff0c\u6587\u4ef6\u7cfb\u7edf\u88ab\u5b89\u88c5\u5728\u4e00\u4e2a\u7279\u5b9a\u7684\u6587\u4ef6\u8def\u5f84\u4f4d\u7f6e\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u5c31\u662f\u5b89\u88c5\u70b9\u3002\u6240\u6709\u7684\u5df2\u5b89\u88c5\u6587\u4ef6\u7cfb\u7edf\u90fd\u4f5c\u4e3a\u6839\u6587\u4ef6\u7cfb\u7edf\u6811\u4e2d\u7684\u53f6\u5b50\u51fa\u73b0\u5728\u7cfb\u7edf\u4e2d\u3002 \u4e0a\u8ff0\u62bd\u8c61\u6982\u5ff5\u5f62\u6210\u4e86UNIX\u6587\u4ef6\u7cfb\u7edf\u7684\u903b\u8f91\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u9700\u8981\u901a\u8fc7\u4e00\u4e2a\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u67b6\u6784\u8bbe\u8ba1\u4e0e\u5b9e\u73b0\u628a\u4e0a\u8ff0\u4fe1\u606f\u6620\u5c04\u5e76\u50a8\u5b58\u5230\u78c1\u76d8\u4ecb\u8d28\u4e0a\uff0c\u4ece\u800c\u5728\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u78c1\u76d8\u5e03\u5c40\uff08\u5373\u6570\u636e\u5728\u78c1\u76d8\u4e0a\u7684\u7269\u7406\u7ec4\u7ec7\uff09\u4e0a\u5177\u4f53\u4f53\u73b0\u51fa\u4e0a\u8ff0\u62bd\u8c61\u6982\u5ff5\u3002\u6bd4\u5982\u6587\u4ef6\u5143\u6570\u636e\u4fe1\u606f\u5b58\u50a8\u5728\u78c1\u76d8\u5757\u4e2d\u7684\u7d22\u5f15\u8282\u70b9\u4e0a\u3002\u5f53\u6587\u4ef6\u88ab\u8f7d\u5165\u5185\u5b58\u65f6\uff0c\u5185\u6838\u9700\u8981\u4f7f\u7528\u78c1\u76d8\u5757\u4e2d\u7684\u7d22\u5f15\u70b9\u6765\u6784\u9020\u5185\u5b58\u4e2d\u7684\u7d22\u5f15\u8282\u70b9\u3002 ucore\u6a21\u4eff\u4e86UNIX\u7684\u6587\u4ef6\u7cfb\u7edf\u8bbe\u8ba1\uff0cucore\u7684\u6587\u4ef6\u7cfb\u7edf\u67b6\u6784\u4e3b\u8981\u7531\u56db\u90e8\u5206\u7ec4\u6210\uff1a \u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3\u5c42\uff1a\u8be5\u5c42\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4ece\u7528\u6237\u7a7a\u95f4\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u6807\u51c6\u8bbf\u95ee\u63a5\u53e3\u3002\u8fd9\u4e00\u5c42\u8bbf\u95ee\u63a5\u53e3\u8ba9\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u63a5\u53e3\u83b7\u5f97ucore\u5185\u6838\u7684\u6587\u4ef6\u7cfb\u7edf\u670d\u52a1\u3002 \u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\uff1a\u5411\u4e0a\u63d0\u4f9b\u4e00\u4e2a\u4e00\u81f4\u7684\u63a5\u53e3\u7ed9\u5185\u6838\u5176\u4ed6\u90e8\u5206\uff08\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0\u6a21\u5757\u548c\u5176\u4ed6\u5185\u6838\u529f\u80fd\u6a21\u5757\uff09\u8bbf\u95ee\u3002\u5411\u4e0b\u63d0\u4f9b\u4e00\u4e2a\u540c\u6837\u7684\u62bd\u8c61\u51fd\u6570\u6307\u9488\u5217\u8868\u548c\u6570\u636e\u7ed3\u6784\u5c4f\u853d\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u7ec6\u8282\u3002 Simple FS\u6587\u4ef6\u7cfb\u7edf\u5c42\uff1a\u4e00\u4e2a\u57fa\u4e8e\u7d22\u5f15\u65b9\u5f0f\u7684\u7b80\u5355\u6587\u4ef6\u7cfb\u7edf\u5b9e\u4f8b\u3002\u5411\u4e0a\u901a\u8fc7\u5404\u79cd\u5177\u4f53\u51fd\u6570\u5b9e\u73b0\u4ee5\u5bf9\u5e94\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u63d0\u51fa\u7684\u62bd\u8c61\u51fd\u6570\u3002\u5411\u4e0b\u8bbf\u95ee\u5916\u8bbe\u63a5\u53e3 \u5916\u8bbe\u63a5\u53e3\u5c42\uff1a\u5411\u4e0a\u63d0\u4f9bdevice\u8bbf\u95ee\u63a5\u53e3\u5c4f\u853d\u4e0d\u540c\u786c\u4ef6\u7ec6\u8282\u3002\u5411\u4e0b\u5b9e\u73b0\u8bbf\u95ee\u5404\u79cd\u5177\u4f53\u8bbe\u5907\u9a71\u52a8\u7684\u63a5\u53e3\uff0c\u6bd4\u5982disk\u8bbe\u5907\u63a5\u53e3/\u4e32\u53e3\u8bbe\u5907\u63a5\u53e3\u3002 \u5bf9\u7167\u4e0a\u9762\u7684\u5c42\u6b21\u6211\u4eec\u518d\u5927\u81f4\u4ecb\u7ecd\u4e00\u4e0b\u6587\u4ef6\u7cfb\u7edf\u7684\u8bbf\u95ee\u5904\u7406\u8fc7\u7a0b\uff0c\u52a0\u6df1\u5bf9\u6587\u4ef6\u7cfb\u7edf\u7684\u603b\u4f53\u7406\u89e3\u3002\u5047\u5982\u5e94\u7528\u7a0b\u5e8f\u64cd\u4f5c\u6587\u4ef6\uff08\u6253\u5f00/\u521b\u5efa/\u5220\u9664/\u8bfb\u5199\uff09\uff0c\u9996\u5148\u9700\u8981\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u7684\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3\u5c42\u7ed9\u7528\u6237\u7a7a\u95f4\u63d0\u4f9b\u7684\u8bbf\u95ee\u63a5\u53e3\u8fdb\u5165\u6587\u4ef6\u7cfb\u7edf\u5185\u90e8\uff0c\u63a5\u7740\u7531\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u628a\u8bbf\u95ee\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u67d0\u4e00\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\uff08\u6bd4\u5982SFS\u6587\u4ef6\u7cfb\u7edf\uff09\uff0c\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\uff08Simple FS\u6587\u4ef6\u7cfb\u7edf\u5c42\uff09\u628a\u5e94\u7528\u7a0b\u5e8f\u7684\u8bbf\u95ee\u8bf7\u6c42\u8f6c\u5316\u4e3a\u5bf9\u78c1\u76d8\u4e0a\u7684block\u7684\u5904\u7406\u8bf7\u6c42\uff0c\u5e76\u901a\u8fc7\u5916\u8bbe\u63a5\u53e3\u5c42\u4ea4\u7ed9\u78c1\u76d8\u9a71\u52a8\u4f8b\u7a0b\u6765\u5b8c\u6210\u5177\u4f53\u7684\u78c1\u76d8\u64cd\u4f5c\u3002\u7ed3\u5408\u7528\u6237\u6001\u5199\u6587\u4ef6\u51fd\u6570write\u7684\u6574\u4e2a\u6267\u884c\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u6bd4\u8f83\u6e05\u695a\u5730\u770b\u51faucore\u6587\u4ef6\u7cfb\u7edf\u67b6\u6784\u7684\u5c42\u6b21\u548c\u4f9d\u8d56\u5173\u7cfb\u3002 ucore\u6587\u4ef6\u7cfb\u7edf\u603b\u4f53\u7ed3\u6784 \u4eceucore\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u540c\u7684\u89d2\u5ea6\u6765\u770b\uff0cucore\u4e2d\u7684\u6587\u4ef6\u7cfb\u7edf\u67b6\u6784\u5305\u542b\u56db\u7c7b\u4e3b\u8981\u7684\u6570\u636e\u7ed3\u6784, \u5b83\u4eec\u5206\u522b\u662f\uff1a \u8d85\u7ea7\u5757\uff08SuperBlock\uff09\uff0c\u5b83\u4e3b\u8981\u4ece\u6587\u4ef6\u7cfb\u7edf\u7684\u5168\u5c40\u89d2\u5ea6\u63cf\u8ff0\u7279\u5b9a\u6587\u4ef6\u7cfb\u7edf\u7684\u5168\u5c40\u4fe1\u606f\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u6574\u4e2aOS\u7a7a\u95f4\u3002 \u7d22\u5f15\u8282\u70b9\uff08inode\uff09\uff1a\u5b83\u4e3b\u8981\u4ece\u6587\u4ef6\u7cfb\u7edf\u7684\u5355\u4e2a\u6587\u4ef6\u7684\u89d2\u5ea6\u5b83\u63cf\u8ff0\u4e86\u6587\u4ef6\u7684\u5404\u79cd\u5c5e\u6027\u548c\u6570\u636e\u6240\u5728\u4f4d\u7f6e\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u6574\u4e2aOS\u7a7a\u95f4\u3002 \u76ee\u5f55\u9879\uff08dentry\uff09\uff1a\u5b83\u4e3b\u8981\u4ece\u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\u8def\u5f84\u7684\u89d2\u5ea6\u63cf\u8ff0\u4e86\u6587\u4ef6\u8def\u5f84\u4e2d\u7684\u4e00\u4e2a\u7279\u5b9a\u7684\u76ee\u5f55\u9879\uff08\u6ce8\uff1a\u4e00\u7cfb\u5217\u76ee\u5f55\u9879\u5f62\u6210\u76ee\u5f55/\u6587\u4ef6\u8def\u5f84\uff09\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u6574\u4e2aOS\u7a7a\u95f4\u3002\u5bf9\u4e8eSFS\u800c\u8a00\uff0cinode(\u5177\u4f53\u4e3astruct sfs_disk_inode)\u5bf9\u5e94\u4e8e\u7269\u7406\u78c1\u76d8\u4e0a\u7684\u5177\u4f53\u5bf9\u8c61\uff0cdentry\uff08\u5177\u4f53\u4e3astruct sfs_disk_entry\uff09\u662f\u4e00\u4e2a\u5185\u5b58\u5b9e\u4f53\uff0c\u5176\u4e2d\u7684ino\u6210\u5458\u6307\u5411\u5bf9\u5e94\u7684inode number\uff0c\u53e6\u5916\u4e00\u4e2a\u6210\u5458\u662ffile name(\u6587\u4ef6\u540d). \u6587\u4ef6\uff08file\uff09\uff0c\u5b83\u4e3b\u8981\u4ece\u8fdb\u7a0b\u7684\u89d2\u5ea6\u63cf\u8ff0\u4e86\u4e00\u4e2a\u8fdb\u7a0b\u5728\u8bbf\u95ee\u6587\u4ef6\u65f6\u9700\u8981\u4e86\u89e3\u7684\u6587\u4ef6\u6807\u8bc6\uff0c\u6587\u4ef6\u8bfb\u5199\u7684\u4f4d\u7f6e\uff0c\u6587\u4ef6\u5f15\u7528\u60c5\u51b5\u7b49\u4fe1\u606f\u3002\u5b83\u7684\u4f5c\u7528\u8303\u56f4\u662f\u67d0\u4e00\u5177\u4f53\u8fdb\u7a0b\u3002 \u5982\u679c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u6253\u5f00\u4e86\u4e00\u4e2a\u6587\u4ef6\uff0c\u90a3\u4e48\u5728ucore\u4e2d\u6d89\u53ca\u7684\u76f8\u5173\u6570\u636e\u7ed3\u6784\uff08\u5176\u4e2d\u76f8\u5173\u6570\u636e\u7ed3\u6784\u5c06\u5728\u4e0b\u9762\u5404\u4e2a\u5c0f\u8282\u4e2d\u5c55\u5f00\u53d9\u8ff0\uff09\u548c\u5173\u7cfb\u5982\u4e0b\u56fe\u6240\u793a\uff1a ucore\u4e2d\u6587\u4ef6\u76f8\u5173\u5173\u952e\u6570\u636e\u7ed3\u6784\u53ca\u5176\u5173\u7cfb","title":"ucore \u6587\u4ef6\u7cfb\u7edf\u603b\u4f53\u4ecb\u7ecd"},{"location":"lab4/intro/#_2","text":"\u5728LoongArch32\u7248\u672c\u7684uCore\u4e2d\uff0c\u5176\u78c1\u76d8\u662f\u901a\u8fc7\u4e00\u5757\u5185\u5b58\u8fdb\u884c\u7684\u6a21\u62df\uff0c\u5e76\u65e0\u771f\u5b9e\u7684\u78c1\u76d8\u63a7\u5236\u5668\u786c\u4ef6\u3002\u56e0\u6b64\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u78c1\u76d8\u6570\u636e\u5176\u5b9e\u8fd0\u884c\u5728\u5185\u5b58\u4e2d\u3002\u5728\u7f16\u8bd1uCore\u65f6\uff0cmakefile\u4f1a\u8c03\u7528 tools/mksfs \u5728\u4f60\u7684\u8ba1\u7b97\u673a\u4e0a\u5b8c\u6210SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u683c\u5f0f\u5316\u4ee5\u53ca\u6587\u4ef6\u4e3a\u955c\u50cf\uff0c\u5e76\u94fe\u63a5\u5230 ucore-kernel-initrd \u8fd9\u4e00\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\u4e2d\u3002","title":"\u78c1\u76d8\u5757\u8bbe\u5907"},{"location":"lab4/intro/#_3","text":"\u6587\u4ef6\u548c\u76ee\u5f55\u76f8\u5173\u7528\u6237\u5e93\u51fd\u6570 Lab4\u4e2d\u90e8\u5206\u7528\u6237\u5e93\u51fd\u6570\u4e0e\u6587\u4ef6\u7cfb\u7edf\u6709\u5173\uff0c\u6211\u4eec\u5148\u8ba8\u8bba\u5bf9\u5355\u4e2a\u6587\u4ef6\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u7136\u540e\u8ba8\u8bba\u5bf9\u76ee\u5f55\u548c\u6587\u4ef6\u7cfb\u7edf\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\u3002 \u5728\u6587\u4ef6\u64cd\u4f5c\u65b9\u9762\uff0c\u6700\u57fa\u672c\u7684\u76f8\u5173\u51fd\u6570\u662fopen\u3001close\u3001read\u3001write\u3002\u5728\u8bfb\u5199\u4e00\u4e2a\u6587\u4ef6\u4e4b\u524d\uff0c\u9996\u5148\u8981\u7528open\u7cfb\u7edf\u8c03\u7528\u5c06\u5176\u6253\u5f00\u3002open\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u6307\u5b9a\u6587\u4ef6\u7684\u8def\u5f84\u540d\uff0c\u53ef\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\u540d\uff1b\u7b2c\u4e8c\u4e2a\u53c2\u6570\u6307\u5b9a\u6253\u5f00\u7684\u65b9\u5f0f\uff0c\u53ef\u8bbe\u7f6e\u4e3aO_RDONLY\u3001O_WRONLY\u3001O_RDWR\uff0c\u5206\u522b\u8868\u793a\u53ea\u8bfb\u3001\u53ea\u5199\u3001\u53ef\u8bfb\u53ef\u5199\u3002\u5728\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u5b83\u8fd4\u56de\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u5bf9\u6587\u4ef6\u8fdb\u884c\u76f8\u5173\u64cd\u4f5c\u3002\u5728\u4f7f\u7528\u5b8c\u4e00\u4e2a\u6587\u4ef6\u540e\uff0c\u8fd8\u8981\u7528close\u7cfb\u7edf\u8c03\u7528\u628a\u5b83\u5173\u95ed\uff0c\u5176\u53c2\u6570\u5c31\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26fd\u3002\u8fd9\u6837\u5b83\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u5c31\u53ef\u4ee5\u7a7a\u51fa\u6765\uff0c\u7ed9\u522b\u7684\u6587\u4ef6\u4f7f\u7528\u3002 \u8bfb\u5199\u6587\u4ef6\u5185\u5bb9\u7684\u7cfb\u7edf\u8c03\u7528\u662fread\u548cwrite\u3002read\u7cfb\u7edf\u8c03\u7528\u6709\u4e09\u4e2a\u53c2\u6570\uff1a\u4e00\u4e2a\u6307\u5b9a\u6240\u64cd\u4f5c\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4e00\u4e2a\u6307\u5b9a\u8bfb\u53d6\u6570\u636e\u7684\u5b58\u653e\u5730\u5740\uff0c\u6700\u540e\u4e00\u4e2a\u6307\u5b9a\u8bfb\u591a\u5c11\u4e2a\u5b57\u8282\u3002\u5728C\u7a0b\u5e8f\u4e2d\u8c03\u7528\u8be5\u7cfb\u7edf\u8c03\u7528\u7684\u65b9\u6cd5\u5982\u4e0b\uff1a count = read(filehandle, buffer, nbytes); \u8be5\u7cfb\u7edf\u8c03\u7528\u4f1a\u628a\u5b9e\u9645\u8bfb\u5230\u7684\u5b57\u8282\u6570\u8fd4\u56de\u7ed9count\u53d8\u91cf\u3002\u5728\u6b63\u5e38\u60c5\u5f62\u4e0b\u8fd9\u4e2a\u503c\u4e0enbytes\u76f8\u7b49\uff0c\u4f46\u6709\u65f6\u53ef\u80fd\u4f1a\u5c0f\u4e00\u4e9b\u3002\u4f8b\u5982\uff0c\u5728\u8bfb\u6587\u4ef6\u65f6\u78b0\u4e0a\u4e86\u6587\u4ef6\u7ed3\u675f\u7b26\uff0c\u4ece\u800c\u63d0\u524d\u7ed3\u675f\u6b64\u6b21\u8bfb\u64cd\u4f5c\u3002 \u5982\u679c\u7531\u4e8e\u53c2\u6570\u65e0\u6548\u6216\u78c1\u76d8\u8bbf\u95ee\u9519\u8bef\u7b49\u539f\u56e0\uff0c\u4f7f\u5f97\u6b64\u6b21\u7cfb\u7edf\u8c03\u7528\u65e0\u6cd5\u5b8c\u6210\uff0c\u5219count\u88ab\u7f6e\u4e3a-1\u3002\u800cwrite\u51fd\u6570\u7684\u53c2\u6570\u4e0e\u4e4b\u5b8c\u5168\u76f8\u540c\u3002 \u5bf9\u4e8e\u76ee\u5f55\u800c\u8a00\uff0c\u6700\u5e38\u7528\u7684\u64cd\u4f5c\u662f\u8df3\u8f6c\u5230\u67d0\u4e2a\u76ee\u5f55\uff0c\u8fd9\u91cc\u5bf9\u5e94\u7684\u7528\u6237\u5e93\u51fd\u6570\u662fchdir\u3002\u7136\u540e\u5c31\u9700\u8981\u8bfb\u76ee\u5f55\u7684\u5185\u5bb9\u4e86\uff0c\u5373\u5217\u51fa\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u540d\uff0c\u8fd9\u5728\u5904\u7406\u4e0a\u4e0e\u8bfb\u6587\u4ef6\u7c7b\u4f3c\uff0c\u5373\u9700\u8981\u901a\u8fc7opendir\u51fd\u6570\u6253\u5f00\u76ee\u5f55\uff0c\u901a\u8fc7readdir\u6765\u83b7\u53d6\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u4fe1\u606f\uff0c\u8bfb\u5b8c\u540e\u8fd8\u9700\u901a\u8fc7closedir\u51fd\u6570\u6765\u5173\u95ed\u76ee\u5f55\u3002\u7531\u4e8e\u5728ucore\u4e2d\u628a\u76ee\u5f55\u770b\u6210\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u6587\u4ef6\uff0c\u6240\u4ee5opendir\u548cclosedir\u5b9e\u9645\u4e0a\u5c31\u662f\u8c03\u7528\u4e0e\u6587\u4ef6\u76f8\u5173\u7684open\u548cclose\u51fd\u6570\u3002\u53ea\u6709readdir\u9700\u8981\u8c03\u7528\u83b7\u53d6\u76ee\u5f55\u5185\u5bb9\u7684\u7279\u6b8a\u7cfb\u7edf\u8c03\u7528sys_getdirentry\u3002\u800c\u4e14\u8fd9\u91cc\u6ca1\u6709\u5199\u76ee\u5f55\u8fd9\u4e00\u64cd\u4f5c\u3002\u5728\u76ee\u5f55\u4e2d\u589e\u52a0\u5185\u5bb9\u5176\u5b9e\u5c31\u662f\u5728\u6b64\u76ee\u5f55\u4e2d\u521b\u5efa\u6587\u4ef6\uff0c\u9700\u8981\u7528\u5230\u521b\u5efa\u6587\u4ef6\u7684\u51fd\u6570\u3002 \u6587\u4ef6\u548c\u76ee\u5f55\u8bbf\u95ee\u76f8\u5173\u7cfb\u7edf\u8c03\u7528 \u4e0e\u6587\u4ef6\u76f8\u5173\u7684open\u3001close\u3001read\u3001write\u7528\u6237\u5e93\u51fd\u6570\u5bf9\u5e94\u7684\u662fsys_open\u3001sys_close\u3001sys_read\u3001sys_write\u56db\u4e2a\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u3002\u4e0e\u76ee\u5f55\u76f8\u5173\u7684readdir\u7528\u6237\u5e93\u51fd\u6570\u5bf9\u5e94\u7684\u662fsys_getdirentry\u7cfb\u7edf\u8c03\u7528\u3002\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u63a5\u53e3\u5c06\u901a\u8fc7syscall\u51fd\u6570\u6765\u83b7\u5f97ucore\u7684\u5185\u6838\u670d\u52a1\u3002\u5f53\u5230\u4e86ucore\u5185\u6838\u540e\uff0c\u5728\u8c03\u7528\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684file\u63a5\u53e3\u548cdir\u63a5\u53e3\u3002","title":"\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3"},{"location":"lab4/intro/#-vfs","text":"\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u662f\u628a\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u5bf9\u5916\u5171\u6027\u63a5\u53e3\u63d0\u53d6\u51fa\u6765\uff0c\u5f62\u6210\u4e00\u4e2a\u51fd\u6570\u6307\u9488\u6570\u7ec4\uff0c\u8fd9\u6837\uff0c\u901a\u7528\u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee\u63a5\u53e3\u5c42\u53ea\u9700\u8bbf\u95ee\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\uff0c\u800c\u4e0d\u9700\u5173\u5fc3\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u7ec6\u8282\u548c\u63a5\u53e3\u3002","title":"\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42 - VFS"},{"location":"lab4/intro/#file-dir","text":"file&dir\u63a5\u53e3\u5c42\u5b9a\u4e49\u4e86\u8fdb\u7a0b\u5728\u5185\u6838\u4e2d\u76f4\u63a5\u8bbf\u95ee\u7684\u6587\u4ef6\u76f8\u5173\u4fe1\u606f\uff0c\u8fd9\u5b9a\u4e49\u5728file\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u5177\u4f53\u63cf\u8ff0\u5982\u4e0b\uff1a struct file { enum { FD_NONE, FD_INIT, FD_OPENED, FD_CLOSED, } status; //\u8bbf\u95ee\u6587\u4ef6\u7684\u6267\u884c\u72b6\u6001 bool readable; //\u6587\u4ef6\u662f\u5426\u53ef\u8bfb bool writable; //\u6587\u4ef6\u662f\u5426\u53ef\u5199 int fd; //\u6587\u4ef6\u5728filemap\u4e2d\u7684\u7d22\u5f15\u503c off_t pos; //\u8bbf\u95ee\u6587\u4ef6\u7684\u5f53\u524d\u4f4d\u7f6e struct inode *node; //\u8be5\u6587\u4ef6\u5bf9\u5e94\u7684\u5185\u5b58inode\u6307\u9488 int open_count; //\u6253\u5f00\u6b64\u6587\u4ef6\u7684\u6b21\u6570 }; \u800c\u5728kern/process/proc.h\u4e2d\u7684proc_struct\u7ed3\u6784\u4e2d\u63cf\u8ff0\u4e86\u8fdb\u7a0b\u8bbf\u95ee\u6587\u4ef6\u7684\u6570\u636e\u63a5\u53e3files_struct\uff0c\u5176\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b\uff1a struct files_struct { struct inode *pwd; //\u8fdb\u7a0b\u5f53\u524d\u6267\u884c\u76ee\u5f55\u7684\u5185\u5b58inode\u6307\u9488 struct file *fd_array; //\u8fdb\u7a0b\u6253\u5f00\u6587\u4ef6\u7684\u6570\u7ec4 atomic_t files_count; //\u8bbf\u95ee\u6b64\u6587\u4ef6\u7684\u7ebf\u7a0b\u4e2a\u6570 semaphore_t files_sem; //\u786e\u4fdd\u5bf9\u8fdb\u7a0b\u63a7\u5236\u5757\u4e2dfs_struct\u7684\u4e92\u65a5\u8bbf\u95ee }; \u5f53\u521b\u5efa\u4e00\u4e2a\u8fdb\u7a0b\u540e\uff0c\u8be5\u8fdb\u7a0b\u7684files_struct\u5c06\u4f1a\u88ab\u521d\u59cb\u5316\u6216\u590d\u5236\u7236\u8fdb\u7a0b\u7684files_struct\u3002\u5f53\u7528\u6237\u8fdb\u7a0b\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u65f6\uff0c\u5c06\u4ecefd_array\u6570\u7ec4\u4e2d\u53d6\u5f97\u4e00\u4e2a\u7a7a\u95f2file\u9879\uff0c\u7136\u540e\u4f1a\u628a\u6b64file\u7684\u6210\u5458\u53d8\u91cfnode\u6307\u9488\u6307\u5411\u4e00\u4e2a\u4ee3\u8868\u6b64\u6587\u4ef6\u7684inode\u7684\u8d77\u59cb\u5730\u5740\u3002","title":"file &amp; dir\u63a5\u53e3"},{"location":"lab4/intro/#inode","text":"index node\u662f\u4f4d\u4e8e\u5185\u5b58\u7684\u7d22\u5f15\u8282\u70b9\uff0c\u5b83\u662fVFS\u7ed3\u6784\u4e2d\u7684\u91cd\u8981\u6570\u636e\u7ed3\u6784\uff0c\u56e0\u4e3a\u5b83\u5b9e\u9645\u8d1f\u8d23\u628a\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u7279\u5b9a\u7d22\u5f15\u8282\u70b9\u4fe1\u606f\uff08\u751a\u81f3\u4e0d\u80fd\u7b97\u662f\u4e00\u4e2a\u7d22\u5f15\u8282\u70b9\uff09\u7edf\u4e00\u5c01\u88c5\u8d77\u6765\uff0c\u907f\u514d\u4e86\u8fdb\u7a0b\u76f4\u63a5\u8bbf\u95ee\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u3002\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a struct inode { union { //\u5305\u542b\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7279\u5b9ainode\u4fe1\u606f\u7684union\u6210\u5458\u53d8\u91cf struct device __device_info; //\u8bbe\u5907\u6587\u4ef6\u7cfb\u7edf\u5185\u5b58inode\u4fe1\u606f struct sfs_inode __sfs_inode_info; //SFS\u6587\u4ef6\u7cfb\u7edf\u5185\u5b58inode\u4fe1\u606f } in_info; enum { inode_type_device_info = 0x1234, inode_type_sfs_inode_info, } in_type; //\u6b64inode\u6240\u5c5e\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b atomic_t ref_count; //\u6b64inode\u7684\u5f15\u7528\u8ba1\u6570 atomic_t open_count; //\u6253\u5f00\u6b64inode\u5bf9\u5e94\u6587\u4ef6\u7684\u4e2a\u6570 struct fs *in_fs; //\u62bd\u8c61\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u5305\u542b\u8bbf\u95ee\u6587\u4ef6\u7cfb\u7edf\u7684\u51fd\u6570\u6307\u9488 const struct inode_ops *in_ops; //\u62bd\u8c61\u7684inode\u64cd\u4f5c\uff0c\u5305\u542b\u8bbf\u95eeinode\u7684\u51fd\u6570\u6307\u9488 }; \u5728inode\u4e2d\uff0c\u6709\u4e00\u6210\u5458\u53d8\u91cf\u4e3ain_ops\uff0c\u8fd9\u662f\u5bf9\u6b64inode\u7684\u64cd\u4f5c\u51fd\u6570\u6307\u9488\u5217\u8868\uff0c\u5176\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b\uff1a struct inode_ops { unsigned long vop_magic; int (*vop_open)(struct inode *node, uint32_t open_flags); int (*vop_close)(struct inode *node); int (*vop_read)(struct inode *node, struct iobuf *iob); int (*vop_write)(struct inode *node, struct iobuf *iob); int (*vop_getdirentry)(struct inode *node, struct iobuf *iob); int (*vop_create)(struct inode *node, const char *name, bool excl, struct inode **node_store); int (*vop_lookup)(struct inode *node, char *path, struct inode **node_store); \u2026\u2026 }; \u53c2\u7167\u4e0a\u9762\u5bf9SFS\u4e2d\u7684\u7d22\u5f15\u8282\u70b9\u64cd\u4f5c\u51fd\u6570\u7684\u8bf4\u660e\uff0c\u53ef\u4ee5\u770b\u51fainode_ops\u662f\u5bf9\u5e38\u89c4\u6587\u4ef6\u3001\u76ee\u5f55\u3001\u8bbe\u5907\u6587\u4ef6\u6240\u6709\u64cd\u4f5c\u7684\u4e00\u4e2a\u62bd\u8c61\u51fd\u6570\u8868\u793a\u3002\u5bf9\u4e8e\u67d0\u4e00\u5177\u4f53\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u53ea\u9700\u5b9e\u73b0\u76f8\u5173\u7684\u51fd\u6570\uff0c\u5c31\u53ef\u4ee5\u88ab\u7528\u6237\u8fdb\u7a0b\u8bbf\u95ee\u5177\u4f53\u7684\u6587\u4ef6\u4e86\uff0c\u4e14\u7528\u6237\u8fdb\u7a0b\u65e0\u9700\u4e86\u89e3\u5177\u4f53\u6587\u4ef6\u7cfb\u7edf\u7684\u5b9e\u73b0\u7ec6\u8282\u3002","title":"inode \u63a5\u53e3"},{"location":"lab4/intro/#simple-fs","text":"\u8fd9\u91cc\u6211\u4eec\u6ca1\u6709\u6309\u7167\u4ece\u4e0a\u5230\u4e0b\u5148\u8bb2\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\uff0c\u518d\u8bb2\u5177\u4f53\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u8fd9\u662f\u7531\u4e8e\u5982\u679c\u80fd\u591f\u7406\u89e3Simple FS\uff08\u7b80\u79f0SFS\uff09\u6587\u4ef6\u7cfb\u7edf\uff0c\u5c31\u53ef\u66f4\u597d\u5730\u5206\u6790\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u8bbe\u8ba1\u3002\u5373\u4ece\u5177\u4f53\u8d70\u5411\u62bd\u8c61\u3002ucore\u5185\u6838\u628a\u6240\u6709\u6587\u4ef6\u90fd\u770b\u4f5c\u662f\u5b57\u8282\u6d41\uff0c\u4efb\u4f55\u5185\u90e8\u903b\u8f91\u7ed3\u6784\u90fd\u662f\u4e13\u7528\u7684\uff0c\u7531\u5e94\u7528\u7a0b\u5e8f\u8d1f\u8d23\u89e3\u91ca\u3002\u4f46\u662fucore\u533a\u5206\u6587\u4ef6\u7684\u7269\u7406\u7ed3\u6784\u3002ucore\u76ee\u524d\u652f\u6301\u5982\u4e0b\u51e0\u79cd\u7c7b\u578b\u7684\u6587\u4ef6\uff1a \u5e38\u89c4\u6587\u4ef6\uff1a\u6587\u4ef6\u4e2d\u5305\u62ec\u7684\u5185\u5bb9\u4fe1\u606f\u662f\u7531\u5e94\u7528\u7a0b\u5e8f\u8f93\u5165\u3002SFS\u6587\u4ef6\u7cfb\u7edf\u5728\u666e\u901a\u6587\u4ef6\u4e0a\u4e0d\u5f3a\u52a0\u4efb\u4f55\u5185\u90e8\u7ed3\u6784\uff0c\u628a\u5176\u6587\u4ef6\u5185\u5bb9\u4fe1\u606f\u770b\u4f5c\u4e3a\u5b57\u8282\u3002 \u76ee\u5f55\uff1a\u5305\u542b\u4e00\u7cfb\u5217\u7684entry\uff0c\u6bcf\u4e2aentry\u5305\u542b\u6587\u4ef6\u540d\u548c\u6307\u5411\u4e0e\u4e4b\u76f8\u5173\u8054\u7684\u7d22\u5f15\u8282\u70b9\uff08index node\uff09\u7684\u6307\u9488\u3002\u76ee\u5f55\u662f\u6309\u5c42\u6b21\u7ed3\u6784\u7ec4\u7ec7\u7684\u3002 \u94fe\u63a5\u6587\u4ef6\uff1a\u5b9e\u9645\u4e0a\u4e00\u4e2a\u94fe\u63a5\u6587\u4ef6\u662f\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u6587\u4ef6\u7684\u53e6\u4e00\u4e2a\u53ef\u9009\u62e9\u7684\u6587\u4ef6\u540d\u3002 \u8bbe\u5907\u6587\u4ef6\uff1a\u4e0d\u5305\u542b\u6570\u636e\uff0c\u4f46\u662f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6620\u5c04\u7269\u7406\u8bbe\u5907\uff08\u5982\u4e32\u53e3\uff09\u5230\u4e00\u4e2a\u6587\u4ef6\u540d\u7684\u673a\u5236\u3002\u53ef\u901a\u8fc7\u8bbe\u5907\u6587\u4ef6\u8bbf\u95ee\u5916\u56f4\u8bbe\u5907\u3002 \u7ba1\u9053\uff1a\u7ba1\u9053\u662f\u8fdb\u7a0b\u95f4\u901a\u8baf\u7684\u4e00\u4e2a\u57fa\u7840\u8bbe\u65bd\u3002\u7ba1\u9053\u7f13\u5b58\u4e86\u5176\u8f93\u5165\u7aef\u6240\u63a5\u53d7\u7684\u6570\u636e\uff0c\u4ee5\u4fbf\u5728\u7ba1\u9053\u8f93\u51fa\u7aef\u8bfb\u7684\u8fdb\u7a0b\u80fd\u4e00\u4e2a\u5148\u8fdb\u5148\u51fa\u7684\u65b9\u5f0f\u6765\u63a5\u53d7\u6570\u636e\u3002 \u5728lab4\u4e2d\u5173\u6ce8\u7684\u4e3b\u8981\u662fSFS\u652f\u6301\u7684\u5e38\u89c4\u6587\u4ef6\u3001\u76ee\u5f55\u548c\u94fe\u63a5\u4e2d\u7684 hardlink \u7684\u8bbe\u8ba1\u5b9e\u73b0\u3002SFS\u6587\u4ef6\u7cfb\u7edf\u4e2d\u76ee\u5f55\u548c\u5e38\u89c4\u6587\u4ef6\u5177\u6709\u5171\u540c\u7684\u5c5e\u6027\uff0c\u800c\u8fd9\u4e9b\u5c5e\u6027\u4fdd\u5b58\u5728\u7d22\u5f15\u8282\u70b9\u4e2d\u3002SFS\u901a\u8fc7\u7d22\u5f15\u8282\u70b9\u6765\u7ba1\u7406\u76ee\u5f55\u548c\u5e38\u89c4\u6587\u4ef6\uff0c\u7d22\u5f15\u8282\u70b9\u5305\u542b\u64cd\u4f5c\u7cfb\u7edf\u6240\u9700\u8981\u7684\u5173\u4e8e\u67d0\u4e2a\u6587\u4ef6\u7684\u5173\u952e\u4fe1\u606f\uff0c\u6bd4\u5982\u6587\u4ef6\u7684\u5c5e\u6027\u3001\u8bbf\u95ee\u8bb8\u53ef\u6743\u4ee5\u53ca\u5176\u5b83\u63a7\u5236\u4fe1\u606f\u90fd\u4fdd\u5b58\u5728\u7d22\u5f15\u8282\u70b9\u4e2d\u3002\u53ef\u4ee5\u6709\u591a\u4e2a\u6587\u4ef6\u540d\u53ef\u6307\u5411\u4e00\u4e2a\u7d22\u5f15\u8282\u70b9\u3002","title":"Simple FS \u6587\u4ef6\u7cfb\u7edf"},{"location":"lab4/intro/#_4","text":"\u6587\u4ef6\u7cfb\u7edf\u901a\u5e38\u4fdd\u5b58\u5728\u78c1\u76d8\u4e0a\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u78c1\u76d8\uff08\u5373disk0\uff09\u7528\u4e8e\u5b58\u653e\u4e00\u4e2aSFS\u6587\u4ef6\u7cfb\u7edf\uff08Simple Filesystem\uff09\u3002\u901a\u5e38\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u78c1\u76d8\u7684\u4f7f\u7528\u662f\u4ee5\u6247\u533a\uff08Sector\uff09\u4e3a\u5355\u4f4d\u7684\uff0c\u4f46\u662f\u4e3a\u4e86\u5b9e\u73b0\u7b80\u4fbf\uff0cSFS \u4e2d\u4ee5 block \uff084K\uff0c\u4e0e\u5185\u5b58 page \u5927\u5c0f\u76f8\u7b49\uff09\u4e3a\u57fa\u672c\u5355\u4f4d\u3002 SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u5e03\u5c40\u5982\u4e0b\u56fe\u6240\u793a\u3002 \u7b2c0\u4e2a\u5757\uff084K\uff09\u662f\u8d85\u7ea7\u5757\uff08superblock\uff09\uff0c\u5b83\u5305\u542b\u4e86\u5173\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6240\u6709\u5173\u952e\u53c2\u6570\uff0c\u5f53\u8ba1\u7b97\u673a\u88ab\u542f\u52a8\u6216\u6587\u4ef6\u7cfb\u7edf\u88ab\u9996\u6b21\u63a5\u89e6\u65f6\uff0c\u8d85\u7ea7\u5757\u7684\u5185\u5bb9\u5c31\u4f1a\u88ab\u88c5\u5165\u5185\u5b58\u3002\u5176\u5b9a\u4e49\u5982\u4e0b\uff1a struct sfs_super { uint32_t magic; /* magic number, should be SFS_MAGIC */ uint32_t blocks; /* # of blocks in fs */ uint32_t unused_blocks; /* # of unused blocks in fs */ char info[SFS_MAX_INFO_LEN + 1]; /* infomation for sfs */ }; \u53ef\u4ee5\u770b\u5230\uff0c\u5305\u542b\u4e00\u4e2a\u6210\u5458\u53d8\u91cf\u9b54\u6570magic\uff0c\u5176\u503c\u4e3a0x2f8dbe2a\uff0c\u5185\u6838\u901a\u8fc7\u5b83\u6765\u68c0\u67e5\u78c1\u76d8\u955c\u50cf\u662f\u5426\u662f\u5408\u6cd5\u7684 SFS img\uff1b\u6210\u5458\u53d8\u91cfblocks\u8bb0\u5f55\u4e86SFS\u4e2d\u6240\u6709block\u7684\u6570\u91cf\uff0c\u5373 img \u7684\u5927\u5c0f\uff1b\u6210\u5458\u53d8\u91cfunused_block\u8bb0\u5f55\u4e86SFS\u4e2d\u8fd8\u6ca1\u6709\u88ab\u4f7f\u7528\u7684block\u7684\u6570\u91cf\uff1b\u6210\u5458\u53d8\u91cfinfo\u5305\u542b\u4e86\u5b57\u7b26\u4e32\"simple file system\"\u3002 \u7b2c1\u4e2a\u5757\u653e\u4e86\u4e00\u4e2aroot-dir\u7684inode\uff0c\u7528\u6765\u8bb0\u5f55\u6839\u76ee\u5f55\u7684\u76f8\u5173\u4fe1\u606f\u3002\u6709\u5173inode\u8fd8\u5c06\u5728\u540e\u7eed\u90e8\u5206\u4ecb\u7ecd\u3002\u8fd9\u91cc\u53ea\u8981\u7406\u89e3root-dir\u662fSFS\u6587\u4ef6\u7cfb\u7edf\u7684\u6839\u7ed3\u70b9\uff0c\u901a\u8fc7\u8fd9\u4e2aroot-dir\u7684inode\u4fe1\u606f\u5c31\u53ef\u4ee5\u5b9a\u4f4d\u5e76\u67e5\u627e\u5230\u6839\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u4fe1\u606f\u3002 \u4ece\u7b2c2\u4e2a\u5757\u5f00\u59cb\uff0c\u6839\u636eSFS\u4e2d\u6240\u6709\u5757\u7684\u6570\u91cf\uff0c\u75281\u4e2abit\u6765\u8868\u793a\u4e00\u4e2a\u5757\u7684\u5360\u7528\u548c\u672a\u88ab\u5360\u7528\u7684\u60c5\u51b5\u3002\u8fd9\u4e2a\u533a\u57df\u79f0\u4e3aSFS\u7684freemap\u533a\u57df\uff0c\u8fd9\u5c06\u5360\u7528\u82e5\u5e72\u4e2a\u5757\u7a7a\u95f4\u3002\u4e3a\u4e86\u66f4\u597d\u5730\u8bb0\u5f55\u548c\u7ba1\u7406freemap\u533a\u57df\uff0c\u4e13\u95e8\u63d0\u4f9b\u4e86\u4e24\u4e2a\u6587\u4ef6kern/fs/sfs/bitmap.[ch]\u6765\u5b8c\u6210\u6839\u636e\u4e00\u4e2a\u5757\u53f7\u67e5\u627e\u6216\u8bbe\u7f6e\u5bf9\u5e94\u7684bit\u4f4d\u7684\u503c\u3002 \u6700\u540e\u5728\u5269\u4f59\u7684\u78c1\u76d8\u7a7a\u95f4\u4e2d\uff0c\u5b58\u653e\u4e86\u6240\u6709\u5176\u4ed6\u76ee\u5f55\u548c\u6587\u4ef6\u7684inode\u4fe1\u606f\u548c\u5185\u5bb9\u6570\u636e\u4fe1\u606f\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\u867d\u7136inode\u7684\u5927\u5c0f\u5c0f\u4e8e\u4e00\u4e2a\u5757\u7684\u5927\u5c0f\uff084096B\uff09\uff0c\u4f46\u4e3a\u4e86\u5b9e\u73b0\u7b80\u5355\uff0c\u6bcf\u4e2a inode \u90fd\u5360\u7528\u4e00\u4e2a\u5b8c\u6574\u7684 block\u3002 \u5728sfs_fs.c\u6587\u4ef6\u4e2d\u7684sfs_do_mount\u51fd\u6570\u4e2d\uff0c\u5b8c\u6210\u4e86\u52a0\u8f7d\u4f4d\u4e8e\u786c\u76d8\u4e0a\u7684SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u8d85\u7ea7\u5757superblock\u548cfreemap\u7684\u5de5\u4f5c\u3002\u8fd9\u6837\uff0c\u5728\u5185\u5b58\u4e2d\u5c31\u6709\u4e86SFS\u6587\u4ef6\u7cfb\u7edf\u7684\u5168\u5c40\u4fe1\u606f\u3002","title":"\u6587\u4ef6\u7cfb\u7edf\u7684\u5e03\u5c40"},{"location":"lab4/intro/#_5","text":"\u5728SFS\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u9700\u8981\u8bb0\u5f55\u6587\u4ef6\u5185\u5bb9\u7684\u5b58\u50a8\u4f4d\u7f6e\u4ee5\u53ca\u6587\u4ef6\u540d\u4e0e\u6587\u4ef6\u5185\u5bb9\u7684\u5bf9\u5e94\u5173\u7cfb\u3002sfs_disk_inode\u8bb0\u5f55\u4e86\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u5185\u5bb9\u5b58\u50a8\u7684\u7d22\u5f15\u4fe1\u606f\uff0c\u8be5\u6570\u636e\u7ed3\u6784\u5728\u786c\u76d8\u91cc\u50a8\u5b58\uff0c\u9700\u8981\u65f6\u8bfb\u5165\u5185\u5b58\u3002sfs_disk_entry\u8868\u793a\u4e00\u4e2a\u76ee\u5f55\u4e2d\u7684\u4e00\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5305\u542b\u8be5\u9879\u6240\u5bf9\u5e94inode\u7684\u4f4d\u7f6e\u548c\u6587\u4ef6\u540d\uff0c\u540c\u6837\u4e5f\u5728\u786c\u76d8\u91cc\u50a8\u5b58\uff0c\u9700\u8981\u65f6\u8bfb\u5165\u5185\u5b58\u3002 \u78c1\u76d8\u7d22\u5f15\u8282\u70b9 SFS\u4e2d\u7684\u78c1\u76d8\u7d22\u5f15\u8282\u70b9\u4ee3\u8868\u4e86\u4e00\u4e2a\u5b9e\u9645\u4f4d\u4e8e\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\u3002\u9996\u5148\u6211\u4eec\u770b\u770b\u5728\u786c\u76d8\u4e0a\u7684\u7d22\u5f15\u8282\u70b9\u7684\u5185\u5bb9\uff1a struct sfs_disk_inode { uint32_t size; \u5982\u679cinode\u8868\u793a\u5e38\u89c4\u6587\u4ef6\uff0c\u5219size\u662f\u6587\u4ef6\u5927\u5c0f uint16_t type; inode\u7684\u6587\u4ef6\u7c7b\u578b uint16_t nlinks; \u6b64inode\u7684\u786c\u94fe\u63a5\u6570 uint32_t blocks; \u6b64inode\u7684\u6570\u636e\u5757\u6570\u7684\u4e2a\u6570 uint32_t direct[SFS_NDIRECT]; \u6b64inode\u7684\u76f4\u63a5\u6570\u636e\u5757\u7d22\u5f15\u503c\uff08\u6709SFS_NDIRECT\u4e2a\uff09 uint32_t indirect; \u6b64inode\u7684\u4e00\u7ea7\u95f4\u63a5\u6570\u636e\u5757\u7d22\u5f15\u503c }; \u901a\u8fc7\u4e0a\u8868\u53ef\u4ee5\u770b\u51fa\uff0c\u5982\u679cinode\u8868\u793a\u7684\u662f\u6587\u4ef6\uff0c\u5219\u6210\u5458\u53d8\u91cfdirect[]\u76f4\u63a5\u6307\u5411\u4e86\u4fdd\u5b58\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u7684\u6570\u636e\u5757\u7d22\u5f15\u503c\u3002indirect\u95f4\u63a5\u6307\u5411\u4e86\u4fdd\u5b58\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u7684\u6570\u636e\u5757\uff0cindirect\u6307\u5411\u7684\u662f\u95f4\u63a5\u6570\u636e\u5757\uff08indirect block\uff09\uff0c\u6b64\u6570\u636e\u5757\u5b9e\u9645\u5b58\u653e\u7684\u5168\u90e8\u662f\u6570\u636e\u5757\u7d22\u5f15\uff0c\u8fd9\u4e9b\u6570\u636e\u5757\u7d22\u5f15\u6307\u5411\u7684\u6570\u636e\u5757\u624d\u88ab\u7528\u6765\u5b58\u653e\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u3002 \u9ed8\u8ba4\u7684\uff0cucore \u91cc SFS_NDIRECT \u662f 12\uff0c\u5373\u76f4\u63a5\u7d22\u5f15\u7684\u6570\u636e\u9875\u5927\u5c0f\u4e3a 12 * 4k = 48k\uff1b\u5f53\u4f7f\u7528\u4e00\u7ea7\u95f4\u63a5\u6570\u636e\u5757\u7d22\u5f15\u65f6\uff0cucore \u652f\u6301\u6700\u5927\u7684\u6587\u4ef6\u5927\u5c0f\u4e3a 12 * 4k + 1024 * 4k = 48k + 4m\u3002\u6570\u636e\u7d22\u5f15\u8868\u5185\uff0c0 \u8868\u793a\u4e00\u4e2a\u65e0\u6548\u7684\u7d22\u5f15\uff0cinode \u91cc blocks \u8868\u793a\u8be5\u6587\u4ef6\u6216\u8005\u76ee\u5f55\u5360\u7528\u7684\u78c1\u76d8\u7684 block \u7684\u4e2a\u6570\u3002indiret \u4e3a 0 \u65f6\uff0c\u8868\u793a\u4e0d\u4f7f\u7528\u4e00\u7ea7\u7d22\u5f15\u5757\u3002\uff08\u56e0\u4e3a block 0 \u7528\u6765\u4fdd\u5b58 super block\uff0c\u5b83\u4e0d\u53ef\u80fd\u88ab\u5176\u4ed6\u4efb\u4f55\u6587\u4ef6\u6216\u76ee\u5f55\u4f7f\u7528\uff0c\u6240\u4ee5\u8fd9\u4e48\u8bbe\u8ba1\u4e5f\u662f\u5408\u7406\u7684\uff09\u3002 \u5bf9\u4e8e\u666e\u901a\u6587\u4ef6\uff0c\u7d22\u5f15\u503c\u6307\u5411\u7684 block \u4e2d\u4fdd\u5b58\u7684\u662f\u6587\u4ef6\u4e2d\u7684\u6570\u636e\u3002\u800c\u5bf9\u4e8e\u76ee\u5f55\uff0c\u7d22\u5f15\u503c\u6307\u5411\u7684\u6570\u636e\u4fdd\u5b58\u7684\u662f\u76ee\u5f55\u4e0b\u6240\u6709\u7684\u6587\u4ef6\u540d\u4ee5\u53ca\u5bf9\u5e94\u7684\u7d22\u5f15\u8282\u70b9\u6240\u5728\u7684\u7d22\u5f15\u5757\uff08\u78c1\u76d8\u5757\uff09\u6240\u5f62\u6210\u7684\u6570\u7ec4\u3002\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a /* file entry (on disk) */ struct sfs_disk_entry { uint32_t ino; \u7d22\u5f15\u8282\u70b9\u6240\u5360\u6570\u636e\u5757\u7d22\u5f15\u503c char name[SFS_MAX_FNAME_LEN + 1]; \u6587\u4ef6\u540d }; \u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e0b\u7684 inode \u90fd\u5e94\u8be5\u5206\u914d\u552f\u4e00\u7684 inode \u7f16\u53f7\u3002SFS \u4e0b\uff0c\u4e3a\u4e86\u5b9e\u73b0\u7684\u7b80\u4fbf\uff08\u5077\u61d2\uff09\uff0c\u6bcf\u4e2a inode \u76f4\u63a5\u7528\u4ed6\u6240\u5728\u7684\u78c1\u76d8 block \u7684\u7f16\u53f7\u4f5c\u4e3a inode \u7f16\u53f7\u3002\u6bd4\u5982\uff0croot block \u7684 inode \u7f16\u53f7\u4e3a 1\uff1b\u6bcf\u4e2a sfs_disk_entry \u6570\u636e\u7ed3\u6784\u4e2d\uff0cname \u8868\u793a\u76ee\u5f55\u4e0b\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u7684\u540d\u79f0\uff0cino \u8868\u793a\u78c1\u76d8 block \u7f16\u53f7\uff0c\u901a\u8fc7\u8bfb\u53d6\u8be5 block \u7684\u6570\u636e\uff0c\u80fd\u591f\u5f97\u5230\u76f8\u5e94\u7684\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u7684 inode\u3002ino \u4e3a0\u65f6\uff0c\u8868\u793a\u4e00\u4e2a\u65e0\u6548\u7684 entry\u3002 \u6b64\u5916\uff0c\u548c inode \u76f8\u4f3c\uff0c\u6bcf\u4e2a sfs_dirent_entry \u4e5f\u5360\u7528\u4e00\u4e2a block\u3002 \u5185\u5b58\u4e2d\u7684\u7d22\u5f15\u8282\u70b9 /* inode for sfs */ struct sfs_inode { struct sfs_disk_inode *din; /* on-disk inode */ uint32_t ino; /* inode number */ uint32_t flags; /* inode flags */ bool dirty; /* true if inode modified */ int reclaim_count; /* kill inode if it hits zero */ semaphore_t sem; /* semaphore for din */ list_entry_t inode_link; /* entry for linked-list in sfs_fs */ list_entry_t hash_link; /* entry for hash linked-list in sfs_fs */ }; \u53ef\u4ee5\u770b\u5230SFS\u4e2d\u7684\u5185\u5b58inode\u5305\u542b\u4e86SFS\u7684\u786c\u76d8inode\u4fe1\u606f\uff0c\u800c\u4e14\u8fd8\u589e\u52a0\u4e86\u5176\u4ed6\u4e00\u4e9b\u4fe1\u606f\uff0c\u8fd9\u5c5e\u4e8e\u662f\u4fbf\u4e8e\u8fdb\u884c\u662f\u5224\u65ad\u5426\u6539\u5199\u3001\u4e92\u65a5\u64cd\u4f5c\u3001\u56de\u6536\u548c\u5feb\u901f\u5730\u5b9a\u4f4d\u7b49\u4f5c\u7528\u3002\u9700\u8981\u6ce8\u610f\uff0c\u4e00\u4e2a\u5185\u5b58inode\u662f\u5728\u6253\u5f00\u4e00\u4e2a\u6587\u4ef6\u540e\u624d\u521b\u5efa\u7684\uff0c\u5982\u679c\u5173\u673a\u5219\u76f8\u5173\u4fe1\u606f\u90fd\u4f1a\u6d88\u5931\u3002\u800c\u786c\u76d8inode\u7684\u5185\u5bb9\u662f\u4fdd\u5b58\u5728\u786c\u76d8\u4e2d\u7684\uff0c\u53ea\u662f\u5728\u8fdb\u7a0b\u9700\u8981\u65f6\u624d\u88ab\u8bfb\u5165\u5230\u5185\u5b58\u4e2d\uff0c\u7528\u4e8e\u8bbf\u95ee\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u5177\u4f53\u5185\u5bb9\u6570\u636e \u4e3a\u4e86\u65b9\u4fbf\u5b9e\u73b0\u4e0a\u9762\u63d0\u5230\u7684\u591a\u7ea7\u6570\u636e\u7684\u8bbf\u95ee\u4ee5\u53ca\u76ee\u5f55\u4e2d entry \u7684\u64cd\u4f5c\uff0c\u5bf9 inode SFS\u5b9e\u73b0\u4e86\u4e00\u4e9b\u8f85\u52a9\u7684\u51fd\u6570\uff1a sfs_bmap_load_nolock\uff1a\u5c06\u5bf9\u5e94 sfs_inode \u7684\u7b2c index \u4e2a\u7d22\u5f15\u6307\u5411\u7684 block \u7684\u7d22\u5f15\u503c\u53d6\u51fa\u5b58\u5230\u76f8\u5e94\u7684\u6307\u9488\u6307\u5411\u7684\u5355\u5143\uff08ino_store\uff09\u3002\u8be5\u51fd\u6570\u53ea\u63a5\u53d7 index <= inode->blocks \u7684\u53c2\u6570\u3002\u5f53 index == inode->blocks \u65f6\uff0c\u8be5\u51fd\u6570\u7406\u89e3\u4e3a\u9700\u8981\u4e3a inode \u589e\u957f\u4e00\u4e2a block\u3002\u5e76\u6807\u8bb0 inode \u4e3a dirty\uff08\u6240\u6709\u5bf9 inode \u6570\u636e\u7684\u4fee\u6539\u90fd\u8981\u505a\u8fd9\u6837\u7684\u64cd\u4f5c\uff0c\u8fd9\u6837\uff0c\u5f53 inode \u4e0d\u518d\u4f7f\u7528\u7684\u65f6\u5019\uff0csfs \u80fd\u591f\u4fdd\u8bc1 inode \u6570\u636e\u80fd\u591f\u88ab\u5199\u56de\u5230\u78c1\u76d8\uff09\u3002sfs_bmap_load_nolock \u8c03\u7528\u7684 sfs_bmap_get_nolock \u6765\u5b8c\u6210\u76f8\u5e94\u7684\u64cd\u4f5c\uff0c\u9605\u8bfb sfs_bmap_get_nolock\uff0c\u4e86\u89e3\u4ed6\u662f\u5982\u4f55\u5de5\u4f5c\u7684\u3002\uff08sfs_bmap_get_nolock \u53ea\u7531 sfs_bmap_load_nolock \u8c03\u7528\uff09 sfs_bmap_truncate_nolock\uff1a\u5c06\u591a\u7ea7\u6570\u636e\u7d22\u5f15\u8868\u7684\u6700\u540e\u4e00\u4e2a entry \u91ca\u653e\u6389\u3002\u4ed6\u53ef\u4ee5\u8ba4\u4e3a\u662f sfs_bmap_load_nolock \u4e2d\uff0cindex == inode->blocks \u7684\u9006\u64cd\u4f5c\u3002\u5f53\u4e00\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\u88ab\u5220\u9664\u65f6\uff0csfs \u4f1a\u5faa\u73af\u8c03\u7528\u8be5\u51fd\u6570\u76f4\u5230 inode->blocks \u51cf\u4e3a 0\uff0c\u91ca\u653e\u6240\u6709\u7684\u6570\u636e\u9875\u3002\u51fd\u6570\u901a\u8fc7 sfs_bmap_free_nolock \u6765\u5b9e\u73b0\uff0c\u4ed6\u5e94\u8be5\u662f sfs_bmap_get_nolock \u7684\u9006\u64cd\u4f5c\u3002\u548c sfs_bmap_get_nolock \u4e00\u6837\uff0c\u8c03\u7528 sfs_bmap_free_nolock \u4e5f\u8981\u683c\u5916\u5c0f\u5fc3\u3002 sfs_dirent_read_nolock\uff1a\u5c06\u76ee\u5f55\u7684\u7b2c slot \u4e2a entry \u8bfb\u53d6\u5230\u6307\u5b9a\u7684\u5185\u5b58\u7a7a\u95f4\u3002\u4ed6\u901a\u8fc7\u4e0a\u9762\u63d0\u5230\u7684\u51fd\u6570\u6765\u5b8c\u6210\u3002 sfs_dirent_search_nolock\uff1a\u662f\u5e38\u7528\u7684\u67e5\u627e\u51fd\u6570\u3002\u4ed6\u5728\u76ee\u5f55\u4e0b\u67e5\u627e name\uff0c\u5e76\u4e14\u8fd4\u56de\u76f8\u5e94\u7684\u641c\u7d22\u7ed3\u679c\uff08\u6587\u4ef6\u6216\u6587\u4ef6\u5939\uff09\u7684 inode \u7684\u7f16\u53f7\uff08\u4e5f\u662f\u78c1\u76d8\u7f16\u53f7\uff09\uff0c\u548c\u76f8\u5e94\u7684 entry \u5728\u8be5\u76ee\u5f55\u7684 index \u7f16\u53f7\u4ee5\u53ca\u76ee\u5f55\u4e0b\u7684\u6570\u636e\u9875\u662f\u5426\u6709\u7a7a\u95f2\u7684 entry\u3002\uff08SFS \u5b9e\u73b0\u91cc\u6587\u4ef6\u7684\u6570\u636e\u9875\u662f\u8fde\u7eed\u7684\uff0c\u4e0d\u5b58\u5728\u4efb\u4f55\u7a7a\u6d1e\uff1b\u800c\u5bf9\u4e8e\u76ee\u5f55\uff0c\u6570\u636e\u9875\u4e0d\u662f\u8fde\u7eed\u7684\uff0c\u5f53\u67d0\u4e2a entry \u5220\u9664\u7684\u65f6\u5019\uff0cSFS \u901a\u8fc7\u8bbe\u7f6e entry->ino \u4e3a0\u5c06\u8be5 entry \u6240\u5728\u7684 block \u6807\u8bb0\u4e3a free\uff0c\u5728\u9700\u8981\u6dfb\u52a0\u65b0 entry \u7684\u65f6\u5019\uff0cSFS \u4f18\u5148\u4f7f\u7528\u8fd9\u4e9b free \u7684 entry\uff0c\u5176\u6b21\u624d\u4f1a\u53bb\u5728\u6570\u636e\u9875\u5c3e\u8ffd\u52a0\u65b0\u7684 entry\u3002 \u6ce8\u610f\uff0c\u8fd9\u4e9b\u540e\u7f00\u4e3a nolock \u7684\u51fd\u6570\uff0c\u53ea\u80fd\u5728\u5df2\u7ecf\u83b7\u5f97\u76f8\u5e94 inode \u7684semaphore\u624d\u80fd\u8c03\u7528\u3002 Inode\u7684\u6587\u4ef6\u64cd\u4f5c\u51fd\u6570 static const struct inode_ops sfs_node_fileops = { .vop_magic = VOP_MAGIC, .vop_open = sfs_openfile, .vop_close = sfs_close, .vop_read = sfs_read, .vop_write = sfs_write, \u2026\u2026 }; \u4e0a\u8ff0sfs_openfile\u3001sfs_close\u3001sfs_read\u548csfs_write\u5206\u522b\u5bf9\u5e94\u7528\u6237\u8fdb\u7a0b\u53d1\u51fa\u7684open\u3001close\u3001read\u3001write\u64cd\u4f5c\u3002\u5176\u4e2dsfs_openfile\u4e0d\u7528\u505a\u4ec0\u4e48\u4e8b\uff1bsfs_close\u9700\u8981\u628a\u5bf9\u6587\u4ef6\u7684\u4fee\u6539\u5185\u5bb9\u5199\u56de\u5230\u786c\u76d8\u4e0a\uff0c\u8fd9\u6837\u786e\u4fdd\u786c\u76d8\u4e0a\u7684\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u662f\u6700\u65b0\u7684\uff1bsfs_read\u548csfs_write\u51fd\u6570\u90fd\u8c03\u7528\u4e86\u4e00\u4e2a\u51fd\u6570sfs_io\uff0c\u5e76\u6700\u7ec8\u901a\u8fc7\u8bbf\u95ee\u786c\u76d8\u9a71\u52a8\u6765\u5b8c\u6210\u5bf9\u6587\u4ef6\u5185\u5bb9\u6570\u636e\u7684\u8bfb\u5199\u3002 Inode\u7684\u76ee\u5f55\u64cd\u4f5c\u51fd\u6570 static const struct inode_ops sfs_node_dirops = { .vop_magic = VOP_MAGIC, .vop_open = sfs_opendir, .vop_close = sfs_close, .vop_getdirentry = sfs_getdirentry, .vop_lookup = sfs_lookup, \u2026\u2026 }; \u5bf9\u4e8e\u76ee\u5f55\u64cd\u4f5c\u800c\u8a00\uff0c\u7531\u4e8e\u76ee\u5f55\u4e5f\u662f\u4e00\u79cd\u6587\u4ef6\uff0c\u6240\u4ee5sfs_opendir\u3001sys_close\u5bf9\u5e94\u6237\u8fdb\u7a0b\u53d1\u51fa\u7684open\u3001close\u51fd\u6570\u3002\u76f8\u5bf9\u4e8esfs_open\uff0csfs_opendir\u53ea\u662f\u5b8c\u6210\u4e00\u4e9bopen\u51fd\u6570\u4f20\u9012\u7684\u53c2\u6570\u5224\u65ad\uff0c\u6ca1\u505a\u5176\u4ed6\u66f4\u591a\u7684\u4e8b\u60c5\u3002\u76ee\u5f55\u7684close\u64cd\u4f5c\u4e0e\u6587\u4ef6\u7684close\u64cd\u4f5c\u5b8c\u5168\u4e00\u81f4\u3002\u7531\u4e8e\u76ee\u5f55\u7684\u5185\u5bb9\u6570\u636e\u4e0e\u6587\u4ef6\u7684\u5185\u5bb9\u6570\u636e\u4e0d\u540c\uff0c\u6240\u4ee5\u8bfb\u51fa\u76ee\u5f55\u7684\u5185\u5bb9\u6570\u636e\u7684\u51fd\u6570\u662fsfs_getdirentry\uff0c\u5176\u4e3b\u8981\u5de5\u4f5c\u662f\u83b7\u53d6\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6inode\u4fe1\u606f\u3002","title":"\u7d22\u5f15\u8282\u70b9"},{"location":"lab4/intro/#io","text":"\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u4e3a\u4e86\u7edf\u4e00\u5730\u8bbf\u95ee\u8bbe\u5907\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u4e00\u4e2a\u8bbe\u5907\u770b\u6210\u4e00\u4e2a\u6587\u4ef6\uff0c\u901a\u8fc7\u8bbf\u95ee\u6587\u4ef6\u7684\u63a5\u53e3\u6765\u8bbf\u95ee\u8bbe\u5907\u3002\u76ee\u524d\u5b9e\u73b0\u4e86stdin\u8bbe\u5907\u6587\u4ef6\u6587\u4ef6\u3001stdout\u8bbe\u5907\u6587\u4ef6\u3001disk0\u8bbe\u5907\u3002stdin\u8bbe\u5907\u5c31\u662f\u4e32\u53e3\uff0cstdout\u8bbe\u5907\u5c31\u662fCONSOLE\uff08\u4e32\u53e3\uff09\uff0c\u800cdisk0\u8bbe\u5907\u662f\u627f\u8f7dSFS\u6587\u4ef6\u7cfb\u7edf\u7684\u78c1\u76d8\u8bbe\u5907\u3002\u4e0b\u9762\u6211\u4eec\u9010\u4e00\u5206\u6790ucore\u662f\u5982\u4f55\u8ba9\u7528\u6237\u628a\u8bbe\u5907\u770b\u6210\u6587\u4ef6\u6765\u8bbf\u95ee\u3002","title":"\u8bbe\u5907\u5c42\u6587\u4ef6 IO \u5c42"},{"location":"lab4/intro/#_6","text":"\u4e3a\u4e86\u8868\u793a\u4e00\u4e2a\u8bbe\u5907\uff0c\u9700\u8981\u6709\u5bf9\u5e94\u7684\u6570\u636e\u7ed3\u6784\uff0cucore\u4e3a\u6b64\u5b9a\u4e49\u4e86struct device\uff0c\u5176\u63cf\u8ff0\u5982\u4e0b\uff1a struct device { size_t d_blocks; //\u8bbe\u5907\u5360\u7528\u7684\u6570\u636e\u5757\u4e2a\u6570 size_t d_blocksize; //\u6570\u636e\u5757\u7684\u5927\u5c0f int (*d_open)(struct device *dev, uint32_t open_flags); //\u6253\u5f00\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488 int (*d_close)(struct device *dev); //\u5173\u95ed\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488 int (*d_io)(struct device *dev, struct iobuf *iob, bool write); //\u8bfb\u5199\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488 int (*d_ioctl)(struct device *dev, int op, void *data); //\u7528ioctl\u65b9\u5f0f\u63a7\u5236\u8bbe\u5907\u7684\u51fd\u6570\u6307\u9488 }; \u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u80fd\u591f\u652f\u6301\u5bf9\u5757\u8bbe\u5907\uff08\u6bd4\u5982\u78c1\u76d8\uff09\u3001\u5b57\u7b26\u8bbe\u5907\uff08\u6bd4\u5982\u4e32\u53e3\uff09\u7684\u8868\u793a\uff0c\u5b8c\u6210\u5bf9\u8bbe\u5907\u7684\u57fa\u672c\u64cd\u4f5c\u3002ucore\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4e86\u628a\u8fd9\u4e9b\u8bbe\u5907\u94fe\u63a5\u5728\u4e00\u8d77\uff0c\u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8bbe\u5907\u94fe\u8868\uff0c\u5373\u53cc\u5411\u94fe\u8868vdev_list\uff0c\u8fd9\u6837\u901a\u8fc7\u8bbf\u95ee\u6b64\u94fe\u8868\uff0c\u53ef\u4ee5\u627e\u5230ucore\u80fd\u591f\u8bbf\u95ee\u7684\u6240\u6709\u8bbe\u5907\u6587\u4ef6\u3002 \u4f46\u8fd9\u4e2a\u8bbe\u5907\u63cf\u8ff0\u6ca1\u6709\u4e0e\u6587\u4ef6\u7cfb\u7edf\u4ee5\u53ca\u8868\u793a\u4e00\u4e2a\u6587\u4ef6\u7684inode\u6570\u636e\u7ed3\u6784\u5efa\u7acb\u5173\u7cfb\uff0c\u4e3a\u6b64\uff0c\u8fd8\u9700\u8981\u53e6\u5916\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u628adevice\u548cinode\u8054\u901a\u8d77\u6765\uff0c\u8fd9\u5c31\u662fvfs_dev_t\u6570\u636e\u7ed3\u6784\uff1a // device info entry in vdev_list typedef struct { const char *devname; struct inode *devnode; struct fs *fs; bool mountable; list_entry_t vdev_link; } vfs_dev_t; \u5229\u7528vfs_dev_t\u6570\u636e\u7ed3\u6784\uff0c\u5c31\u53ef\u4ee5\u8ba9\u6587\u4ef6\u7cfb\u7edf\u901a\u8fc7\u4e00\u4e2a\u94fe\u63a5vfs_dev_t\u7ed3\u6784\u7684\u53cc\u5411\u94fe\u8868\u627e\u5230device\u5bf9\u5e94\u7684inode\u6570\u636e\u7ed3\u6784\uff0c\u4e00\u4e2ainode\u8282\u70b9\u7684\u6210\u5458\u53d8\u91cfin_type\u7684\u503c\u662f0x1234\uff0c\u5219\u6b64 inode\u7684\u6210\u5458\u53d8\u91cfin_info\u5c06\u6210\u4e3a\u4e00\u4e2adevice\u7ed3\u6784\u3002\u8fd9\u6837inode\u5c31\u548c\u4e00\u4e2a\u8bbe\u5907\u5efa\u7acb\u4e86\u8054\u7cfb\uff0c\u8fd9\u4e2ainode\u5c31\u662f\u4e00\u4e2a\u8bbe\u5907\u6587\u4ef6\u3002","title":"\u5173\u952e\u6570\u636e\u7ed3\u6784"},{"location":"lab4/intro/#stdout","text":"\u521d\u59cb\u5316 \u65e2\u7136stdout\u8bbe\u5907\u662f\u8bbe\u5907\u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\uff0c\u81ea\u7136\u6709\u81ea\u5df1\u7684inode\u7ed3\u6784\u3002\u5728\u7cfb\u7edf\u521d\u59cb\u5316\u65f6\uff0c\u5373\u53ea\u9700\u5982\u4e0b\u5904\u7406\u8fc7\u7a0b kern_init-->fs_init-->dev_init-->dev_init_stdout --> dev_create_inode --> stdout_device_init --> vfs_add_dev \u5728dev_init_stdout\u4e2d\u5b8c\u6210\u4e86\u5bf9stdout\u8bbe\u5907\u6587\u4ef6\u7684\u521d\u59cb\u5316\u3002\u5373\u9996\u5148\u521b\u5efa\u4e86\u4e00\u4e2ainode\uff0c\u7136\u540e\u901a\u8fc7stdout_device_init\u5b8c\u6210\u5bf9inode\u4e2d\u7684\u6210\u5458\u53d8\u91cfinode->__device_info\u8fdb\u884c\u521d\u59cb\uff1a \u8fd9\u91cc\u7684stdout\u8bbe\u5907\u6587\u4ef6\u5b9e\u9645\u4e0a\u5c31\u662f\u6307\u7684console\u5916\u8bbe\uff08\u5b83\u5176\u5b9e\u662f\u4e32\u53e3\u3001\u5e76\u53e3\u548cCGA\u7684\u7ec4\u5408\u578b\u5916\u8bbe\uff09\u3002\u8fd9\u4e2a\u8bbe\u5907\u6587\u4ef6\u662f\u4e00\u4e2a\u53ea\u5199\u8bbe\u5907\uff0c\u5982\u679c\u8bfb\u8fd9\u4e2a\u8bbe\u5907\uff0c\u5c31\u4f1a\u51fa\u9519\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u770bstdout\u8bbe\u5907\u7684\u76f8\u5173\u5904\u7406\u8fc7\u7a0b\u3002 \u521d\u59cb\u5316 stdout\u8bbe\u5907\u6587\u4ef6\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u4e3b\u8981\u7531stdout_device_init\u5b8c\u6210\uff0c\u5176\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a static void stdout_device_init(struct device *dev) { dev->d_blocks = 0; dev->d_blocksize = 1; dev->d_open = stdout_open; dev->d_close = stdout_close; dev->d_io = stdout_io; dev->d_ioctl = stdout_ioctl; } \u53ef\u4ee5\u770b\u5230\uff0cstdout_open\u51fd\u6570\u5b8c\u6210\u8bbe\u5907\u6587\u4ef6\u6253\u5f00\u5de5\u4f5c\uff0c\u5982\u679c\u53d1\u73b0\u7528\u6237\u8fdb\u7a0b\u8c03\u7528open\u51fd\u6570\u7684\u53c2\u6570flags\u4e0d\u662f\u53ea\u5199\uff08O_WRONLY\uff09\uff0c\u5219\u4f1a\u62a5\u9519\u3002 \u8bbf\u95ee\u64cd\u4f5c\u5b9e\u73b0 stdout_io\u51fd\u6570\u5b8c\u6210\u8bbe\u5907\u7684\u5199\u64cd\u4f5c\u5de5\u4f5c\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a static int stdout_io(struct device *dev, struct iobuf *iob, bool write) { if (write) { char *data = iob->io_base; for (; iob->io_resid != 0; iob->io_resid --) { cputchar(*data ++); } return 0; } return -E_INVAL; } \u53ef\u4ee5\u770b\u5230\uff0c\u8981\u5199\u7684\u6570\u636e\u653e\u5728iob->io_base\u6240\u6307\u7684\u5185\u5b58\u533a\u57df\uff0c\u4e00\u76f4\u5199\u5230iob->io_resid\u7684\u503c\u4e3a0\u4e3a\u6b62\u3002\u6bcf\u6b21\u5199\u64cd\u4f5c\u90fd\u662f\u901a\u8fc7cputchar\u6765\u5b8c\u6210\u7684\uff0c\u6b64\u51fd\u6570\u6700\u7ec8\u5c06\u901a\u8fc7console\u5916\u8bbe\u9a71\u52a8\u6765\u5b8c\u6210\u628a\u6570\u636e\u8f93\u51fa\u5230\u4e32\u53e3\u3001\u5e76\u53e3\u548cCGA\u663e\u793a\u5668\u4e0a\u8fc7\u7a0b\u3002\u53e6\u5916\uff0c\u4e5f\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c\u5982\u679c\u7528\u6237\u60f3\u6267\u884c\u8bfb\u64cd\u4f5c\uff0c\u5219stdout_io\u51fd\u6570\u76f4\u63a5\u8fd4\u56de\u9519\u8bef\u503c-E_INVAL\u3002","title":"stdout\u8bbe\u5907\u6587\u4ef6"},{"location":"lab4/intro/#stdin","text":"\u8fd9\u91cc\u7684stdin\u8bbe\u5907\u6587\u4ef6\u5b9e\u9645\u4e0a\u5c31\u662f\u6307\u7684\u4e32\u53e3\u3002\u8fd9\u4e2a\u8bbe\u5907\u6587\u4ef6\u662f\u4e00\u4e2a\u53ea\u8bfb\u8bbe\u5907\uff0c\u5982\u679c\u5199\u8fd9\u4e2a\u8bbe\u5907\uff0c\u5c31\u4f1a\u51fa\u9519\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u770b\u770bstdin\u8bbe\u5907\u7684\u76f8\u5173\u5904\u7406\u8fc7\u7a0b\u3002 \u521d\u59cb\u5316 stdin\u8bbe\u5907\u6587\u4ef6\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\u4e3b\u8981\u7531stdin_device_init\u5b8c\u6210\u4e86\u4e3b\u8981\u7684\u521d\u59cb\u5316\u5de5\u4f5c\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a static void stdin_device_init(struct device *dev) { dev->d_blocks = 0; dev->d_blocksize = 1; dev->d_open = stdin_open; dev->d_close = stdin_close; dev->d_io = stdin_io; dev->d_ioctl = stdin_ioctl; p_rpos = p_wpos = 0; wait_queue_init(wait_queue); } \u76f8\u5bf9\u4e8estdout\u7684\u521d\u59cb\u5316\u8fc7\u7a0b\uff0cstdin\u7684\u521d\u59cb\u5316\u76f8\u5bf9\u590d\u6742\u4e00\u4e9b\uff0c\u591a\u4e86\u4e00\u4e2astdin_buffer\u7f13\u51b2\u533a\uff0c\u63cf\u8ff0\u7f13\u51b2\u533a\u8bfb\u5199\u4f4d\u7f6e\u7684\u53d8\u91cfp_rpos\u3001p_wpos\u4ee5\u53ca\u7528\u4e8e\u7b49\u5f85\u7f13\u51b2\u533a\u7684\u7b49\u5f85\u961f\u5217wait_queue\u3002\u5728stdin_device_init\u51fd\u6570\u7684\u521d\u59cb\u5316\u4e2d\uff0c\u4e5f\u5b8c\u6210\u4e86\u5bf9p_rpos\u3001p_wpos\u548cwait_queue\u7684\u521d\u59cb\u5316\u3002 \u8bbf\u95ee\u64cd\u4f5c\u5b9e\u73b0 stdin_io\u51fd\u6570\u8d1f\u8d23\u5b8c\u6210\u8bbe\u5907\u7684\u8bfb\u64cd\u4f5c\u5de5\u4f5c\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a static int stdin_io(struct device *dev, struct iobuf *iob, bool write) { if (!write) { int ret; if ((ret = dev_stdin_read(iob->io_base, iob->io_resid)) > 0) { iob->io_resid -= ret; } return ret; } return -E_INVAL; } \u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u662f\u5199\u64cd\u4f5c\uff0c\u5219stdin_io\u51fd\u6570\u76f4\u63a5\u62a5\u9519\u8fd4\u56de\u3002\u6240\u4ee5\u8fd9\u4e5f\u8fdb\u4e00\u6b65\u8bf4\u660e\u4e86\u6b64\u8bbe\u5907\u6587\u4ef6\u662f\u53ea\u8bfb\u6587\u4ef6\u3002\u5982\u679c\u6b64\u8bfb\u64cd\u4f5c\uff0c\u5219\u6b64\u51fd\u6570\u8fdb\u4e00\u6b65\u8c03\u7528dev_stdin_read\u51fd\u6570\u5b8c\u6210\u5bf9\u952e\u76d8\u8bbe\u5907\u7684\u8bfb\u5165\u64cd\u4f5c\u3002dev_stdin_read\u51fd\u6570\u7684\u5b9e\u73b0\u76f8\u5bf9\u590d\u6742\u4e00\u4e9b\uff0c\u4e3b\u8981\u7684\u6d41\u7a0b\u5982\u4e0b\uff1a static int dev_stdin_read(char *buf, size_t len) { int ret = 0; bool intr_flag; local_intr_save(intr_flag); { for (; ret < len; ret ++, p_rpos ++) { try_again: if (p_rpos < p_wpos) { *buf ++ = stdin_buffer[p_rpos % stdin_BUFSIZE]; } else { wait_t __wait, *wait = &__wait; wait_current_set(wait_queue, wait, WT_KBD); local_intr_restore(intr_flag); schedule(); local_intr_save(intr_flag); wait_current_del(wait_queue, wait); if (wait->wakeup_flags == WT_KBD) { goto try_again; } break; } } } local_intr_restore(intr_flag); return ret; } \u5728\u4e0a\u8ff0\u51fd\u6570\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c\u5982\u679cp_rpos < p_wpos\uff0c\u5219\u8868\u793a\u6709\u952e\u76d8\u8f93\u5165\u7684\u65b0\u5b57\u7b26\u5728stdin_buffer\u4e2d\uff0c\u4e8e\u662f\u5c31\u4ecestdin_buffer\u4e2d\u53d6\u51fa\u65b0\u5b57\u7b26\u653e\u5230iobuf\u6307\u5411\u7684\u7f13\u51b2\u533a\u4e2d\uff1b\u5982\u679cp_rpos >=p_wpos\uff0c\u5219\u8868\u660e\u6ca1\u6709\u65b0\u5b57\u7b26\uff0c\u8fd9\u6837\u8c03\u7528read\u7528\u6237\u6001\u5e93\u51fd\u6570\u7684\u7528\u6237\u8fdb\u7a0b\u5c31\u9700\u8981\u91c7\u7528\u7b49\u5f85\u961f\u5217\u7684\u7761\u7720\u64cd\u4f5c\u8fdb\u5165\u7761\u7720\u72b6\u6001\uff0c\u7b49\u5f85\u952e\u76d8\u8f93\u5165\u5b57\u7b26\u7684\u4ea7\u751f\u3002 \u952e\u76d8\u8f93\u5165\u5b57\u7b26\u540e\uff0c\u5982\u4f55\u5524\u9192\u7b49\u5f85\u952e\u76d8\u8f93\u5165\u7684\u7528\u6237\u8fdb\u7a0b\u5462\uff1f\u56de\u987elab1\u4e2d\u7684\u5916\u8bbe\u4e2d\u65ad\u5904\u7406\uff0c\u53ef\u4ee5\u4e86\u89e3\u5230\uff0c\u5f53\u7528\u6237\u5728QEMU\u63a7\u5236\u53f0\u8f93\u5165\u5b57\u7b26\u65f6\uff0c\u4f1a\u4ea7\u751f\u4e32\u53e3\u4e2d\u65ad\uff0c\u5728trap_dispatch\u51fd\u6570\u4e2d\uff0c\u5f53\u8bc6\u522b\u51fa\u4e2d\u65ad\u662f\u4e32\u53e3\u4e2d\u65ad\u65f6\uff0c\u4f1a\u8c03\u7528dev_stdin_write\u51fd\u6570\uff0c\u6765\u628a\u5b57\u7b26\u5199\u5165\u5230stdin_buffer\u4e2d\uff0c\u4e14\u4f1a\u901a\u8fc7\u7b49\u5f85\u961f\u5217\u7684\u5524\u9192\u64cd\u4f5c\u5524\u9192\u6b63\u5728\u7b49\u5f85\u952e\u76d8\u8f93\u5165\u7684\u7528\u6237\u8fdb\u7a0b\u3002","title":"stdin \u8bbe\u5907\u6587\u4ef6"},{"location":"lab4/intro/#_7","text":"\u4e0e\u4e4b\u524d\u76f8\u6bd4\uff0c\u5b9e\u9a8c\u56db\u589e\u52a0\u4e86\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u56e0\u6b64\u5b9e\u73b0\u4e86\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u6765\u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6\u5230\u5185\u5b58\u4e2d\u8fd0\u884c\u7684\u529f\u80fd\uff0c\u5bfc\u81f4\u5bf9\u8fdb\u7a0b\u7ba1\u7406\u76f8\u5173\u7684\u5b9e\u73b0\u6bd4\u8f83\u5927\u7684\u8c03\u6574\u3002\u6211\u4eec\u6765\u7b80\u5355\u770b\u770b\u6587\u4ef6\u7cfb\u7edf\u662f\u5982\u4f55\u521d\u59cb\u5316\u5e76\u80fd\u5728ucore\u7684\u7ba1\u7406\u4e0b\u6b63\u5e38\u5de5\u4f5c\u7684\u3002 \u9996\u5148\u770b\u770bkern_init\u51fd\u6570\uff0c\u53ef\u4ee5\u53d1\u73b0\u4e0e\u4e4b\u524d\u76f8\u6bd4\u589e\u52a0\u4e86\u5bf9fs_init\u51fd\u6570\u7684\u8c03\u7528\u3002fs_init\u51fd\u6570\u5c31\u662f\u6587\u4ef6\u7cfb\u7edf\u521d\u59cb\u5316\u7684\u603b\u63a7\u51fd\u6570\uff0c\u5b83\u8fdb\u4e00\u6b65\u8c03\u7528\u4e86\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u521d\u59cb\u5316\u51fd\u6570vfs_init\uff0c\u4e0e\u6587\u4ef6\u76f8\u5173\u7684\u8bbe\u5907\u521d\u59cb\u5316\u51fd\u6570dev_init\u548cSimple FS\u6587\u4ef6\u7cfb\u7edf\u7684\u521d\u59cb\u5316\u51fd\u6570sfs_init\u3002\u8fd9\u4e09\u4e2a\u521d\u59cb\u5316\u51fd\u6570\u8054\u5408\u5728\u4e00\u8d77\uff0c\u534f\u540c\u5b8c\u6210\u4e86\u6574\u4e2a\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u3001SFS\u6587\u4ef6\u7cfb\u7edf\u548c\u6587\u4ef6\u7cfb\u7edf\u5bf9\u5e94\u7684\u8bbe\u5907\uff08\u4e32\u53e3\u3001\u78c1\u76d8\uff09\u7684\u521d\u59cb\u5316\u5de5\u4f5c\u3002\u5176\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u56fe\u5982\u4e0b\u6240\u793a\uff1a \u6587\u4ef6\u7cfb\u7edf\u521d\u59cb\u5316\u8c03\u7528\u5173\u7cfb\u56fe \u53c2\u8003\u4e0a\u56fe\uff0c\u5e76\u7ed3\u5408\u6e90\u7801\u5206\u6790\uff0c\u53ef\u5927\u81f4\u4e86\u89e3\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u6574\u4e2a\u521d\u59cb\u5316\u6d41\u7a0b\u3002vfs_init\u4e3b\u8981\u5efa\u7acb\u4e86\u4e00\u4e2adevice list\u53cc\u5411\u94fe\u8868vdev_list\uff0c\u4e3a\u540e\u7eed\u5177\u4f53\u8bbe\u5907\uff08\u4e32\u53e3\u3001\u78c1\u76d8\uff09\u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u5448\u73b0\u5efa\u7acb\u67e5\u627e\u8bbf\u95ee\u901a\u9053\u3002dev_init\u51fd\u6570\u901a\u8fc7\u8fdb\u4e00\u6b65\u8c03\u7528disk0/stdin/stdout_device_init\u5b8c\u6210\u5bf9\u5177\u4f53\u8bbe\u5907\u7684\u521d\u59cb\u5316\uff0c\u628a\u5b83\u4eec\u62bd\u8c61\u6210\u4e00\u4e2a\u8bbe\u5907\u6587\u4ef6\uff0c\u5e76\u5efa\u7acb\u5bf9\u5e94\u7684inode\u6570\u636e\u7ed3\u6784\uff0c\u6700\u540e\u628a\u5b83\u4eec\u94fe\u5165\u5230vdev_list\u4e2d\u3002\u8fd9\u6837\u901a\u8fc7\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u5c31\u53ef\u4ee5\u65b9\u4fbf\u5730\u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u8bbf\u95ee\u8fd9\u4e9b\u8bbe\u5907\u4e86\u3002sfs_init\u662f\u5b8c\u6210\u5bf9Simple FS\u7684\u521d\u59cb\u5316\u5de5\u4f5c\uff0c\u5e76\u628a\u6b64\u5b9e\u4f8b\u6587\u4ef6\u7cfb\u7edf\u6302\u5728\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u4ece\u800c\u8ba9ucore\u7684\u5176\u4ed6\u90e8\u5206\u80fd\u591f\u901a\u8fc7\u8bbf\u95ee\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\u7684\u63a5\u53e3\u6765\u8fdb\u4e00\u6b65\u8bbf\u95ee\u5230SFS\u5b9e\u4f8b\u6587\u4ef6\u7cfb\u7edf\u3002","title":"\u5b9e\u9a8c\u6267\u884c\u6d41\u7a0b\u6982\u8ff0"},{"location":"lab4/intro/#_8","text":"","title":"\u6587\u4ef6\u64cd\u4f5c\u5b9e\u73b0"},{"location":"lab4/intro/#_9","text":"\u6709\u4e86\u4e0a\u8ff0\u5206\u6790\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u770b\u5982\u679c\u4e00\u4e2a\u7528\u6237\u8fdb\u7a0b\u6253\u5f00\u6587\u4ef6\u4f1a\u505a\u54ea\u4e9b\u4e8b\u60c5\uff1f\u9996\u5148\u5047\u5b9a\u7528\u6237\u8fdb\u7a0b\u9700\u8981\u6253\u5f00\u7684\u6587\u4ef6\u5df2\u7ecf\u5b58\u5728\u5728\u786c\u76d8\u4e0a\u3002\u4ee5user/sfs_filetest1.c\u4e3a\u4f8b\uff0c\u9996\u5148\u7528\u6237\u8fdb\u7a0b\u4f1a\u8c03\u7528\u5728main\u51fd\u6570\u4e2d\u7684\u5982\u4e0b\u8bed\u53e5\uff1a int fd1 = safe_open(\"sfs\\_filetest1\", O_RDONLY); \u4ece\u5b57\u9762\u4e0a\u53ef\u4ee5\u770b\u51fa\uff0c\u5982\u679cucore\u80fd\u591f\u6b63\u5e38\u67e5\u627e\u5230\u8fd9\u4e2a\u6587\u4ef6\uff0c\u5c31\u4f1a\u8fd4\u56de\u4e00\u4e2a\u4ee3\u8868\u6587\u4ef6\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26fd1\uff0c\u8fd9\u6837\u5728\u63a5\u4e0b\u6765\u7684\u8bfb\u5199\u6587\u4ef6\u8fc7\u7a0b\u4e2d\uff0c\u5c31\u76f4\u63a5\u7528\u8fd9\u6837fd1\u6765\u4ee3\u8868\u5c31\u53ef\u4ee5\u4e86\u3002\u90a3\u8fd9\u4e2a\u6253\u5f00\u6587\u4ef6\u7684\u8fc7\u7a0b\u662f\u5982\u4f55\u4e00\u6b65\u4e00\u6b65\u5b9e\u73b0\u7684\u5462\uff1f \u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b \u9996\u5148\u8fdb\u5165\u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u5373\u8fdb\u4e00\u6b65\u8c03\u7528\u5982\u4e0b\u7528\u6237\u6001\u51fd\u6570\uff1a open->sys_open->syscall\uff0c\u4ece\u800c\u5f15\u8d77\u7cfb\u7edf\u8c03\u7528\u8fdb\u5165\u5230\u5185\u6838\u6001\u3002\u5230\u4e86\u5185\u6838\u6001\u540e\uff0c\u901a\u8fc7\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b\uff0c\u4f1a\u8c03\u7528\u5230sys_open\u5185\u6838\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528sysfile_open\u5185\u6838\u51fd\u6570\u3002\u5230\u4e86\u8fd9\u91cc\uff0c\u9700\u8981\u628a\u4f4d\u4e8e\u7528\u6237\u7a7a\u95f4\u7684\u5b57\u7b26\u4e32\"sfs_filetest1\"\u62f7\u8d1d\u5230\u5185\u6838\u7a7a\u95f4\u4e2d\u7684\u5b57\u7b26\u4e32path\u4e2d\uff0c\u5e76\u8fdb\u5165\u5230\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u6d41\u7a0b\u5b8c\u6210\u8fdb\u4e00\u6b65\u7684\u6253\u5f00\u6587\u4ef6\u64cd\u4f5c\u4e2d\u3002 \u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u6d41\u7a0b \u5206\u914d\u4e00\u4e2a\u7a7a\u95f2\u7684file\u6570\u636e\u7ed3\u6784\u53d8\u91cffile\u5728\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u4e2d\uff0c\u9996\u5148\u8c03\u7528\u7684\u662ffile_open\u51fd\u6570\uff0c\u5b83\u8981\u7ed9\u8fd9\u4e2a\u5373\u5c06\u6253\u5f00\u7684\u6587\u4ef6\u5206\u914d\u4e00\u4e2afile\u6570\u636e\u7ed3\u6784\u7684\u53d8\u91cf\uff0c\u8fd9\u4e2a\u53d8\u91cf\u5176\u5b9e\u662f\u5f53\u524d\u8fdb\u7a0b\u7684\u6253\u5f00\u6587\u4ef6\u6570\u7ec4current->fs_struct->filemap[]\u4e2d\u7684\u4e00\u4e2a\u7a7a\u95f2\u5143\u7d20\uff08\u5373\u8fd8\u6ca1\u7528\u4e8e\u4e00\u4e2a\u6253\u5f00\u7684\u6587\u4ef6\uff09\uff0c\u800c\u8fd9\u4e2a\u5143\u7d20\u7684\u7d22\u5f15\u503c\u5c31\u662f\u6700\u7ec8\u8981\u8fd4\u56de\u5230\u7528\u6237\u8fdb\u7a0b\u5e76\u8d4b\u503c\u7ed9\u53d8\u91cffd1\u3002\u5230\u4e86\u8fd9\u4e00\u6b65\u8fd8\u4ec5\u4ec5\u662f\u7ed9\u5f53\u524d\u7528\u6237\u8fdb\u7a0b\u5206\u914d\u4e86\u4e00\u4e2afile\u6570\u636e\u7ed3\u6784\u7684\u53d8\u91cf\uff0c\u8fd8\u6ca1\u6709\u627e\u5230\u5bf9\u5e94\u7684\u6587\u4ef6\u7d22\u5f15\u8282\u70b9\u3002 \u4e3a\u6b64\u9700\u8981\u8fdb\u4e00\u6b65\u8c03\u7528vfs_open\u51fd\u6570\u6765\u627e\u5230path\u6307\u51fa\u7684\u6587\u4ef6\u6240\u5bf9\u5e94\u7684\u57fa\u4e8einode\u6570\u636e\u7ed3\u6784\u7684VFS\u7d22\u5f15\u8282\u70b9node\u3002vfs_open\u51fd\u6570\u9700\u8981\u5b8c\u6210\u4e24\u4ef6\u4e8b\u60c5\uff1a\u901a\u8fc7vfs_lookup\u627e\u5230path\u5bf9\u5e94\u6587\u4ef6\u7684inode\uff1b\u8c03\u7528vop_open\u51fd\u6570\u6253\u5f00\u6587\u4ef6\u3002 \u627e\u5230\u6587\u4ef6\u8bbe\u5907\u7684\u6839\u76ee\u5f55\u201c/\u201d\u7684\u7d22\u5f15\u8282\u70b9\u9700\u8981\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684vfs_lookup\u51fd\u6570\u662f\u4e00\u4e2a\u9488\u5bf9\u76ee\u5f55\u7684\u64cd\u4f5c\u51fd\u6570\uff0c\u5b83\u4f1a\u8c03\u7528vop_lookup\u51fd\u6570\u6765\u627e\u5230SFS\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u201c/\u201d\u76ee\u5f55\u4e0b\u7684\u201csfs_filetest1\u201d\u6587\u4ef6\u3002\u4e3a\u6b64\uff0cvfs_lookup\u51fd\u6570\u9996\u5148\u8c03\u7528get_device\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528vfs_get_bootfs\u51fd\u6570\uff08\u5176\u5b9e\u8c03\u7528\u4e86\uff09\u6765\u627e\u5230\u6839\u76ee\u5f55\u201c/\u201d\u5bf9\u5e94\u7684inode\u3002\u8fd9\u4e2ainode\u5c31\u662f\u4f4d\u4e8evfs.c\u4e2d\u7684inode\u53d8\u91cfbootfs_node\u3002\u8fd9\u4e2a\u53d8\u91cf\u5728init_main\u51fd\u6570\uff08\u4f4d\u4e8ekern/process/proc.c\uff09\u6267\u884c\u65f6\u83b7\u5f97\u4e86\u8d4b\u503c\u3002 \u901a\u8fc7\u8c03\u7528vop_lookup\u51fd\u6570\u6765\u67e5\u627e\u5230\u6839\u76ee\u5f55\u201c/\u201d\u4e0b\u5bf9\u5e94\u6587\u4ef6sfs_filetest1\u7684\u7d22\u5f15\u8282\u70b9\uff0c\uff0c\u5982\u679c\u627e\u5230\u5c31\u8fd4\u56de\u6b64\u7d22\u5f15\u8282\u70b9\u3002 \u628afile\u548cnode\u5efa\u7acb\u8054\u7cfb\u3002\u5b8c\u6210\u7b2c3\u6b65\u540e\uff0c\u5c06\u8fd4\u56de\u5230file_open\u51fd\u6570\u4e2d\uff0c\u901a\u8fc7\u6267\u884c\u8bed\u53e5\u201cfile->node=node;\u201d\uff0c\u5c31\u628a\u5f53\u524d\u8fdb\u7a0b\u7684current->fs_struct->filemap[fd]\uff08\u5373file\u6240\u6307\u53d8\u91cf\uff09\u7684\u6210\u5458\u53d8\u91cfnode\u6307\u9488\u6307\u5411\u4e86\u4ee3\u8868sfs_filetest1\u6587\u4ef6\u7684\u7d22\u5f15\u8282\u70b9inode\u3002\u8fd9\u65f6\u8fd4\u56defd\u3002\u7ecf\u8fc7\u91cd\u91cd\u56de\u9000\uff0c\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u8fd4\u56de\uff0c\u7528\u6237\u6001\u7684syscall->sys_open->open->safe_open\u7b49\u7528\u6237\u51fd\u6570\u7684\u5c42\u5c42\u51fd\u6570\u8fd4\u56de\uff0c\u6700\u7ec8\u628a\u628afd\u8d4b\u503c\u7ed9fd1\u3002\u81ea\u6b64\u5b8c\u6210\u4e86\u6253\u5f00\u6587\u4ef6\u64cd\u4f5c\u3002\u4f46\u8fd9\u91cc\u6211\u4eec\u8fd8\u6ca1\u6709\u5206\u6790\u7b2c2\u548c\u7b2c3\u6b65\u662f\u5982\u4f55\u8fdb\u4e00\u6b65\u8c03\u7528SFS\u6587\u4ef6\u7cfb\u7edf\u63d0\u4f9b\u7684\u51fd\u6570\u627e\u4f4d\u4e8eSFS\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7684sfs_filetest1\u6587\u4ef6\u6240\u5bf9\u5e94\u7684sfs\u78c1\u76d8inode\u7684\u8fc7\u7a0b\u3002\u4e0b\u9762\u9700\u8981\u8fdb\u4e00\u6b65\u5bf9\u6b64\u8fdb\u884c\u5206\u6790\u3002 SFS\u6587\u4ef6\u7cfb\u7edf\u5c42\u7684\u5904\u7406\u6d41\u7a0b \u8fd9\u91cc\u9700\u8981\u5206\u6790\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u4e2d\u6ca1\u6709\u5f7b\u5e95\u5206\u6790\u7684vop_lookup\u51fd\u6570\u5230\u5e95\u505a\u4e86\u5565\u3002\u4e0b\u9762\u6211\u4eec\u6765\u770b\u770b\u3002\u5728sfs_inode.c\u4e2d\u7684sfs_node_dirops\u53d8\u91cf\u5b9a\u4e49\u4e86\u201c.vop_lookup = sfs_lookup\u201d\uff0c\u6240\u4ee5\u6211\u4eec\u91cd\u70b9\u5206\u6790sfs_lookup\u7684\u5b9e\u73b0\u3002\u6ce8\u610f\uff1a\u5728lab4\u4e2d\uff0c\u4e3a\u7b80\u5316\u4ee3\u7801\uff0csfs_lookup\u51fd\u6570\u4e2d\u5e76\u6ca1\u6709\u5b9e\u73b0\u80fd\u591f\u5bf9\u591a\u7ea7\u76ee\u5f55\u8fdb\u884c\u67e5\u627e\u7684\u63a7\u5236\u903b\u8f91\uff08\u5728ucore_plus\u4e2d\u6709\u5b9e\u73b0\uff09\u3002 sfs_lookup\u6709\u4e09\u4e2a\u53c2\u6570\uff1anode\uff0cpath\uff0cnode_store\u3002\u5176\u4e2dnode\u662f\u6839\u76ee\u5f55\u201c/\u201d\u6240\u5bf9\u5e94\u7684inode\u8282\u70b9\uff1bpath\u662f\u6587\u4ef6sfs_filetest1\u7684\u7edd\u5bf9\u8def\u5f84/sfs_filetest1\uff0c\u800cnode_store\u662f\u7ecf\u8fc7\u67e5\u627e\u83b7\u5f97\u7684sfs_filetest1\u6240\u5bf9\u5e94\u7684inode\u8282\u70b9\u3002 sfs_lookup\u51fd\u6570\u4ee5\u201c/\u201d\u4e3a\u5206\u5272\u7b26\uff0c\u4ece\u5de6\u81f3\u53f3\u9010\u4e00\u5206\u89e3path\u83b7\u5f97\u5404\u4e2a\u5b50\u76ee\u5f55\u548c\u6700\u7ec8\u6587\u4ef6\u5bf9\u5e94\u7684inode\u8282\u70b9\u3002\u5728\u672c\u4f8b\u4e2d\u662f\u8c03\u7528sfs_lookup_once\u67e5\u627e\u4ee5\u6839\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6sfs_filetest1\u6240\u5bf9\u5e94\u7684inode\u8282\u70b9\u3002\u5f53\u65e0\u6cd5\u5206\u89e3path\u540e\uff0c\u5c31\u610f\u5473\u7740\u627e\u5230\u4e86sfs_filetest1\u5bf9\u5e94\u7684inode\u8282\u70b9\uff0c\u5c31\u53ef\u987a\u5229\u8fd4\u56de\u4e86\u3002 \u5f53\u7136\u8fd9\u91cc\u8bb2\u5f97\u8fd8\u6bd4\u8f83\u7b80\u5355\uff0csfs_lookup_once\u5c06\u8c03\u7528sfs_dirent_search_nolock\u51fd\u6570\u6765\u67e5\u627e\u4e0e\u8def\u5f84\u540d\u5339\u914d\u7684\u76ee\u5f55\u9879\uff0c\u5982\u679c\u627e\u5230\u76ee\u5f55\u9879\uff0c\u5219\u6839\u636e\u76ee\u5f55\u9879\u4e2d\u8bb0\u5f55\u7684inode\u6240\u5904\u7684\u6570\u636e\u5757\u7d22\u5f15\u503c\u627e\u5230\u8def\u5f84\u540d\u5bf9\u5e94\u7684SFS\u78c1\u76d8inode\uff0c\u5e76\u8bfb\u5165SFS\u78c1\u76d8inode\u5bf9\u7684\u5185\u5bb9\uff0c\u521b\u5efaSFS\u5185\u5b58inode\u3002","title":"\u6253\u5f00\u6587\u4ef6"},{"location":"lab4/intro/#_10","text":"\u8bfb\u6587\u4ef6\u5176\u5b9e\u5c31\u662f\u8bfb\u51fa\u76ee\u5f55\u4e2d\u7684\u76ee\u5f55\u9879\uff0c\u9996\u5148\u5047\u5b9a\u6587\u4ef6\u5728\u78c1\u76d8\u4e0a\u4e14\u5df2\u7ecf\u6253\u5f00\u3002\u7528\u6237\u8fdb\u7a0b\u6709\u5982\u4e0b\u8bed\u53e5\uff1a read(fd, data, len); \u5373\u8bfb\u53d6fd\u5bf9\u5e94\u6587\u4ef6\uff0c\u8bfb\u53d6\u957f\u5ea6\u4e3alen\uff0c\u5b58\u5165data\u4e2d\u3002\u4e0b\u9762\u6765\u5206\u6790\u4e00\u4e0b\u8bfb\u6587\u4ef6\u7684\u5b9e\u73b0\u3002 \u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b \u5148\u8fdb\u5165\u901a\u7528\u6587\u4ef6\u8bbf\u95ee\u63a5\u53e3\u5c42\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u5373\u8fdb\u4e00\u6b65\u8c03\u7528\u5982\u4e0b\u7528\u6237\u6001\u51fd\u6570\uff1aread->sys_read->syscall\uff0c\u4ece\u800c\u5f15\u8d77\u7cfb\u7edf\u8c03\u7528\u8fdb\u5165\u5230\u5185\u6838\u6001\u3002\u5230\u4e86\u5185\u6838\u6001\u4ee5\u540e\uff0c\u901a\u8fc7\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b\uff0c\u4f1a\u8c03\u7528\u5230sys_read\u5185\u6838\u51fd\u6570\uff0c\u5e76\u8fdb\u4e00\u6b65\u8c03\u7528sysfile_read\u5185\u6838\u51fd\u6570\uff0c\u8fdb\u5165\u5230\u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u5904\u7406\u6d41\u7a0b\u5b8c\u6210\u8fdb\u4e00\u6b65\u8bfb\u6587\u4ef6\u7684\u64cd\u4f5c\u3002 \u6587\u4ef6\u7cfb\u7edf\u62bd\u8c61\u5c42\u7684\u5904\u7406\u6d41\u7a0b \\1) \u68c0\u67e5\u9519\u8bef\uff0c\u5373\u68c0\u67e5\u8bfb\u53d6\u957f\u5ea6\u662f\u5426\u4e3a0\u548c\u6587\u4ef6\u662f\u5426\u53ef\u8bfb\u3002 \\2) \u5206\u914dbuffer\u7a7a\u95f4\uff0c\u5373\u8c03\u7528kmalloc\u51fd\u6570\u5206\u914d4096\u5b57\u8282\u7684buffer\u7a7a\u95f4\u3002 \\3) \u8bfb\u6587\u4ef6\u8fc7\u7a0b [1] \u5b9e\u9645\u8bfb\u6587\u4ef6 \u5faa\u73af\u8bfb\u53d6\u6587\u4ef6\uff0c\u6bcf\u6b21\u8bfb\u53d6buffer\u5927\u5c0f\u3002\u6bcf\u6b21\u5faa\u73af\u4e2d\uff0c\u5148\u68c0\u67e5\u5269\u4f59\u90e8\u5206\u5927\u5c0f\uff0c\u82e5\u5176\u5c0f\u4e8e4096\u5b57\u8282\uff0c\u5219\u53ea\u8bfb\u53d6\u5269\u4f59\u90e8\u5206\u7684\u5927\u5c0f\u3002\u7136\u540e\u8c03\u7528file_read\u51fd\u6570\uff08\u8be6\u7ec6\u5206\u6790\u89c1\u540e\uff09\u5c06\u6587\u4ef6\u5185\u5bb9\u8bfb\u53d6\u5230buffer\u4e2d\uff0calen\u4e3a\u5b9e\u9645\u5927\u5c0f\u3002\u8c03\u7528copy_to_user\u51fd\u6570\u5c06\u8bfb\u5230\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u7528\u6237\u7684\u5185\u5b58\u7a7a\u95f4\u4e2d\uff0c\u8c03\u6574\u5404\u53d8\u91cf\u4ee5\u8fdb\u884c\u4e0b\u4e00\u6b21\u5faa\u73af\u8bfb\u53d6\uff0c\u76f4\u81f3\u6307\u5b9a\u957f\u5ea6\u8bfb\u53d6\u5b8c\u6210\u3002\u6700\u540e\u51fd\u6570\u8c03\u7528\u5c42\u5c42\u8fd4\u56de\u81f3\u7528\u6237\u7a0b\u5e8f\uff0c\u7528\u6237\u7a0b\u5e8f\u6536\u5230\u4e86\u8bfb\u5230\u7684\u6587\u4ef6\u5185\u5bb9\u3002 [2] file_read\u51fd\u6570 \u8fd9\u4e2a\u51fd\u6570\u662f\u8bfb\u6587\u4ef6\u7684\u6838\u5fc3\u51fd\u6570\u3002\u51fd\u6570\u67094\u4e2a\u53c2\u6570\uff0cfd\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0cbase\u662f\u7f13\u5b58\u7684\u57fa\u5730\u5740\uff0clen\u662f\u8981\u8bfb\u53d6\u7684\u957f\u5ea6\uff0ccopied_store\u5b58\u653e\u5b9e\u9645\u8bfb\u53d6\u7684\u957f\u5ea6\u3002\u51fd\u6570\u9996\u5148\u8c03\u7528fd2file\u51fd\u6570\u627e\u5230\u5bf9\u5e94\u7684file\u7ed3\u6784\uff0c\u5e76\u68c0\u67e5\u662f\u5426\u53ef\u8bfb\u3002\u8c03\u7528filemap_acquire\u51fd\u6570\u4f7f\u6253\u5f00\u8fd9\u4e2a\u6587\u4ef6\u7684\u8ba1\u6570\u52a01\u3002\u8c03\u7528vop_read\u51fd\u6570\u5c06\u6587\u4ef6\u5185\u5bb9\u8bfb\u5230iob\u4e2d\uff08\u8be6\u7ec6\u5206\u6790\u89c1\u540e\uff09\u3002\u8c03\u6574\u6587\u4ef6\u6307\u9488\u504f\u79fb\u91cfpos\u7684\u503c\uff0c\u4f7f\u5176\u5411\u540e\u79fb\u52a8\u5b9e\u9645\u8bfb\u5230\u7684\u5b57\u8282\u6570iobuf_used(iob)\u3002\u6700\u540e\u8c03\u7528filemap_release\u51fd\u6570\u4f7f\u6253\u5f00\u8fd9\u4e2a\u6587\u4ef6\u7684\u8ba1\u6570\u51cf1\uff0c\u82e5\u6253\u5f00\u8ba1\u6570\u4e3a0\uff0c\u5219\u91ca\u653efile\u3002 SFS\u6587\u4ef6\u7cfb\u7edf\u5c42\u7684\u5904\u7406\u6d41\u7a0b vop_read\u51fd\u6570\u5b9e\u9645\u4e0a\u662f\u5bf9sfs_read\u7684\u5305\u88c5\u3002\u5728sfs_inode.c\u4e2dsfs_node_fileops\u53d8\u91cf\u5b9a\u4e49\u4e86.vop_read = sfs_read\uff0c\u6240\u4ee5\u4e0b\u9762\u6765\u5206\u6790sfs_read\u51fd\u6570\u7684\u5b9e\u73b0\u3002 sfs_read\u51fd\u6570\u8c03\u7528sfs_io\u51fd\u6570\u3002\u5b83\u6709\u4e09\u4e2a\u53c2\u6570\uff0cnode\u662f\u5bf9\u5e94\u6587\u4ef6\u7684inode\uff0ciob\u662f\u7f13\u5b58\uff0cwrite\u8868\u793a\u662f\u8bfb\u8fd8\u662f\u5199\u7684\u5e03\u5c14\u503c\uff080\u8868\u793a\u8bfb\uff0c1\u8868\u793a\u5199\uff09\uff0c\u8fd9\u91cc\u662f0\u3002\u51fd\u6570\u5148\u627e\u5230inode\u5bf9\u5e94sfs\u548csin\uff0c\u7136\u540e\u8c03\u7528sfs_io_nolock\u51fd\u6570\u8fdb\u884c\u8bfb\u53d6\u6587\u4ef6\u64cd\u4f5c\uff0c\u6700\u540e\u8c03\u7528iobuf_skip\u51fd\u6570\u8c03\u6574iobuf\u7684\u6307\u9488\u3002 \u5728sfs_io_nolock\u51fd\u6570\u4e2d\uff0c\u5148\u8ba1\u7b97\u4e00\u4e9b\u8f85\u52a9\u53d8\u91cf\uff0c\u5e76\u5904\u7406\u4e00\u4e9b\u7279\u6b8a\u60c5\u51b5\uff08\u6bd4\u5982\u8d8a\u754c\uff09\uff0c\u7136\u540e\u6709sfs_buf_op = sfs_rbuf,sfs_block_op = sfs_rblock\uff0c\u8bbe\u7f6e\u8bfb\u53d6\u7684\u51fd\u6570\u64cd\u4f5c\u3002\u63a5\u7740\u8fdb\u884c\u5b9e\u9645\u64cd\u4f5c\uff0c\u5148\u5904\u7406\u8d77\u59cb\u7684\u6ca1\u6709\u5bf9\u9f50\u5230\u5757\u7684\u90e8\u5206\uff0c\u518d\u4ee5\u5757\u4e3a\u5355\u4f4d\u5faa\u73af\u5904\u7406\u4e2d\u95f4\u7684\u90e8\u5206\uff0c\u6700\u540e\u5904\u7406\u672b\u5c3e\u5269\u4f59\u7684\u90e8\u5206\u3002\u6bcf\u90e8\u5206\u4e2d\u90fd\u8c03\u7528sfs_bmap_load_nolock\u51fd\u6570\u5f97\u5230blkno\u5bf9\u5e94\u7684inode\u7f16\u53f7\uff0c\u5e76\u8c03\u7528sfs_rbuf\u6216sfs_rblock\u51fd\u6570\u8bfb\u53d6\u6570\u636e\uff08\u4e2d\u95f4\u90e8\u5206\u8c03\u7528sfs_rblock\uff0c\u8d77\u59cb\u548c\u672b\u5c3e\u90e8\u5206\u8c03\u7528sfs_rbuf\uff09\uff0c\u8c03\u6574\u76f8\u5173\u53d8\u91cf\u3002\u5b8c\u6210\u540e\u5982\u679coffset + alen > din->fileinfo.size\uff08\u5199\u6587\u4ef6\u65f6\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0c\u8bfb\u6587\u4ef6\u65f6\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0calen\u4e3a\u5b9e\u9645\u8bfb\u5199\u7684\u957f\u5ea6\uff09\uff0c\u5219\u8c03\u6574\u6587\u4ef6\u5927\u5c0f\u4e3aoffset + alen\u5e76\u8bbe\u7f6edirty\u53d8\u91cf\u3002 sfs_bmap_load_nolock\u51fd\u6570\u5c06\u5bf9\u5e94sfs_inode\u7684\u7b2cindex\u4e2a\u7d22\u5f15\u6307\u5411\u7684block\u7684\u7d22\u5f15\u503c\u53d6\u51fa\u5b58\u5230\u76f8\u5e94\u7684\u6307\u9488\u6307\u5411\u7684\u5355\u5143\uff08ino_store\uff09\u3002\u5b83\u8c03\u7528sfs_bmap_get_nolock\u6765\u5b8c\u6210\u76f8\u5e94\u7684\u64cd\u4f5c\u3002sfs_rbuf\u548csfs_rblock\u51fd\u6570\u6700\u7ec8\u90fd\u8c03\u7528sfs_rwblock_nolock\u51fd\u6570\u5b8c\u6210\u64cd\u4f5c\uff0c\u800csfs_rwblock_nolock\u51fd\u6570\u8c03\u7528dop_io->disk0_io->disk0_read_blks_nolock->ide_read_secs\u5b8c\u6210\u5bf9\u78c1\u76d8\u7684\u64cd\u4f5c\u3002","title":"\u8bfb\u6587\u4ef6"},{"location":"lab4/tasks/","text":"\u5b9e\u9a8c\u5185\u5bb9 \u00b6 \u672c\u6b21\u5b9e\u9a8c\u6d89\u53ca\u7684\u662f\u6587\u4ef6\u7cfb\u7edf\uff0c\u901a\u8fc7\u5206\u6790\u4e86\u89e3ucore\u6587\u4ef6\u7cfb\u7edf\u7684\u603b\u4f53\u67b6\u6784\u8bbe\u8ba1\uff0c\u5b8c\u5584\u8bfb\u5199\u6587\u4ef6\u64cd\u4f5c\uff0c\u4ece\u65b0\u5b9e\u73b0\u57fa\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6267\u884c\u7a0b\u5e8f\u673a\u5236\uff08\u5373\u6539\u5199do_execve\uff09\uff0c\u4ece\u800c\u53ef\u4ee5\u5b8c\u6210\u6267\u884c\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\u548c\u5b9e\u73b0\u6587\u4ef6\u8bfb\u5199\u7b49\u529f\u80fd\u3002\u4e3a\u4e86\u5b9e\u73b0\u5b9e\u9a8c\u56db\u7684\u76ee\u6807\uff0c\u63d0\u4f9b\u4e862\u4e2a\u57fa\u672c\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002 \u7ec3\u4e601: \u5b8c\u6210\u8bfb\u6587\u4ef6\u64cd\u4f5c\u7684\u5b9e\u73b0\uff08\u9700\u8981\u7f16\u7801\uff09 \u00b6 \u9996\u5148\u4e86\u89e3\u6253\u5f00\u6587\u4ef6\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u7136\u540e\u53c2\u8003\u672c\u5b9e\u9a8c\u540e\u7eed\u7684\u6587\u4ef6\u8bfb\u5199\u64cd\u4f5c\u7684\u8fc7\u7a0b\u5206\u6790\uff0c\u7f16\u5199\u5728sfs_inode.c\u4e2dsfs_io_nolock\u8bfb\u6587\u4ef6\u4e2d\u6570\u636e\u7684\u5b9e\u73b0\u4ee3\u7801\u3002 \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u8bbe\u8ba1\u5b9e\u73b0\u201dUNIX\u7684PIPE\u673a\u5236\u201c\u7684\u6982\u8981\u8bbe\u65b9\u6848\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1\u65b9\u6848 \u7ec3\u4e602: \u5b8c\u6210\u57fa\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6267\u884c\u7a0b\u5e8f\u673a\u5236\u7684\u5b9e\u73b0\uff08\u9700\u8981\u7f16\u7801\uff09 \u00b6 \u6539\u5199proc.c\u4e2d\u7684load_icode\u51fd\u6570\u548c\u5176\u4ed6\u76f8\u5173\u51fd\u6570\uff0c\u5b9e\u73b0\u57fa\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6267\u884c\u7a0b\u5e8f\u673a\u5236\u3002\u6267\u884c\uff1amake qemu -j 16\u3002\u5982\u679c\u80fd\u770b\u770b\u5230sh\u7528\u6237\u7a0b\u5e8f\u7684\u6267\u884c\u754c\u9762\uff0c\u5219\u57fa\u672c\u6210\u529f\u4e86\u3002\u5982\u679c\u5728sh\u7528\u6237\u754c\u9762\u4e0a\u53ef\u4ee5\u6267\u884c\u201dls\u201d,\u201dhello\u201d\u7b49\u5176\u4ed6\u653e\u7f6e\u5728sfs\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u5176\u4ed6\u6267\u884c\u7a0b\u5e8f\uff0c\u5219\u53ef\u4ee5\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u57fa\u672c\u6210\u529f\u3002 \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u8bbe\u8ba1\u5b9e\u73b0\u57fa\u4e8e\u201dUNIX\u7684\u786c\u94fe\u63a5\u548c\u8f6f\u94fe\u63a5\u673a\u5236\u201c\u7684\u6982\u8981\u8bbe\u65b9\u6848\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1\u65b9\u6848 \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u5b8c\u6210\u4ee5\u4e0a\u4e24\u4e2a\u7ec3\u4e60\uff0c\u7ed9\u51fa\u7f16\u8bd1\u8fd0\u884c\u540e\u8f93\u51fa\u7ed3\u679c\u7684\u622a\u56fe\u3002\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u5bf9\u6240\u5199\u4ee3\u7801\u8c03\u7528\u7684\u51fd\u6570\u7684\u4f5c\u7528\u52a0\u4ee5\u8bf4\u660e\u3002 \u9700\u63d0\u4ea4\u53ef\u4ee5\u5728\u6211\u4eec\u7ed9\u5b9a\u7684Docker\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528make qemu\u7f16\u8bd1\u5e76\u8fd0\u884c\u7684\u6587\u4ef6\u5939\u7684\u538b\u7f29\u5305\u3002 \u7ec4\u961f\u5206\u5de5\u5efa\u8bae \u00b6 \u5bf9\u4e8e\u4e09\u4eba\u5c0f\u7ec4\uff0c\u5efa\u8bae\u4e24\u4f4d\u540c\u5b66\u5b8c\u6210\u7ec3\u4e60\u4e00\uff0c\u9700\u8981\u5927\u91cf\u9605\u8bfbSFS\u4ee3\u7801\uff0c\u53ef\u4ee5\u8003\u8651\u4e00\u8d77\u9605\u8bfb\u5e76\u8fdb\u884c\u4ea4\u6d41\u3002\u5269\u4e0b\u4e00\u4f4d\u540c\u5b66\u5b8c\u6210\u7ec3\u4e60\u4e8c\uff0c\u901a\u8fc7\u7cfb\u7edf\u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u5e94\u7528\u7a0b\u5e8f\u7684\u8f7d\u5165\u3002","title":"\u5b9e\u9a8c\u4efb\u52a1"},{"location":"lab4/tasks/#_1","text":"\u672c\u6b21\u5b9e\u9a8c\u6d89\u53ca\u7684\u662f\u6587\u4ef6\u7cfb\u7edf\uff0c\u901a\u8fc7\u5206\u6790\u4e86\u89e3ucore\u6587\u4ef6\u7cfb\u7edf\u7684\u603b\u4f53\u67b6\u6784\u8bbe\u8ba1\uff0c\u5b8c\u5584\u8bfb\u5199\u6587\u4ef6\u64cd\u4f5c\uff0c\u4ece\u65b0\u5b9e\u73b0\u57fa\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6267\u884c\u7a0b\u5e8f\u673a\u5236\uff08\u5373\u6539\u5199do_execve\uff09\uff0c\u4ece\u800c\u53ef\u4ee5\u5b8c\u6210\u6267\u884c\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\u548c\u5b9e\u73b0\u6587\u4ef6\u8bfb\u5199\u7b49\u529f\u80fd\u3002\u4e3a\u4e86\u5b9e\u73b0\u5b9e\u9a8c\u56db\u7684\u76ee\u6807\uff0c\u63d0\u4f9b\u4e862\u4e2a\u57fa\u672c\u7ec3\u4e60\uff0c\u8981\u6c42\u5b8c\u6210\u5b9e\u9a8c\u62a5\u544a\u3002","title":"\u5b9e\u9a8c\u5185\u5bb9"},{"location":"lab4/tasks/#1","text":"\u9996\u5148\u4e86\u89e3\u6253\u5f00\u6587\u4ef6\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u7136\u540e\u53c2\u8003\u672c\u5b9e\u9a8c\u540e\u7eed\u7684\u6587\u4ef6\u8bfb\u5199\u64cd\u4f5c\u7684\u8fc7\u7a0b\u5206\u6790\uff0c\u7f16\u5199\u5728sfs_inode.c\u4e2dsfs_io_nolock\u8bfb\u6587\u4ef6\u4e2d\u6570\u636e\u7684\u5b9e\u73b0\u4ee3\u7801\u3002 \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u8bbe\u8ba1\u5b9e\u73b0\u201dUNIX\u7684PIPE\u673a\u5236\u201c\u7684\u6982\u8981\u8bbe\u65b9\u6848\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1\u65b9\u6848","title":"\u7ec3\u4e601: \u5b8c\u6210\u8bfb\u6587\u4ef6\u64cd\u4f5c\u7684\u5b9e\u73b0\uff08\u9700\u8981\u7f16\u7801\uff09"},{"location":"lab4/tasks/#2","text":"\u6539\u5199proc.c\u4e2d\u7684load_icode\u51fd\u6570\u548c\u5176\u4ed6\u76f8\u5173\u51fd\u6570\uff0c\u5b9e\u73b0\u57fa\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6267\u884c\u7a0b\u5e8f\u673a\u5236\u3002\u6267\u884c\uff1amake qemu -j 16\u3002\u5982\u679c\u80fd\u770b\u770b\u5230sh\u7528\u6237\u7a0b\u5e8f\u7684\u6267\u884c\u754c\u9762\uff0c\u5219\u57fa\u672c\u6210\u529f\u4e86\u3002\u5982\u679c\u5728sh\u7528\u6237\u754c\u9762\u4e0a\u53ef\u4ee5\u6267\u884c\u201dls\u201d,\u201dhello\u201d\u7b49\u5176\u4ed6\u653e\u7f6e\u5728sfs\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u5176\u4ed6\u6267\u884c\u7a0b\u5e8f\uff0c\u5219\u53ef\u4ee5\u8ba4\u4e3a\u672c\u5b9e\u9a8c\u57fa\u672c\u6210\u529f\u3002 \u8bf7\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u7ed9\u51fa\u8bbe\u8ba1\u5b9e\u73b0\u57fa\u4e8e\u201dUNIX\u7684\u786c\u94fe\u63a5\u548c\u8f6f\u94fe\u63a5\u673a\u5236\u201c\u7684\u6982\u8981\u8bbe\u65b9\u6848\uff0c\u9f13\u52b1\u7ed9\u51fa\u8be6\u7ec6\u8bbe\u8ba1\u65b9\u6848","title":"\u7ec3\u4e602: \u5b8c\u6210\u57fa\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6267\u884c\u7a0b\u5e8f\u673a\u5236\u7684\u5b9e\u73b0\uff08\u9700\u8981\u7f16\u7801\uff09"},{"location":"lab4/tasks/#_2","text":"\u5b8c\u6210\u4ee5\u4e0a\u4e24\u4e2a\u7ec3\u4e60\uff0c\u7ed9\u51fa\u7f16\u8bd1\u8fd0\u884c\u540e\u8f93\u51fa\u7ed3\u679c\u7684\u622a\u56fe\u3002\u5e76\u5728\u5b9e\u9a8c\u62a5\u544a\u4e2d\u5bf9\u6240\u5199\u4ee3\u7801\u8c03\u7528\u7684\u51fd\u6570\u7684\u4f5c\u7528\u52a0\u4ee5\u8bf4\u660e\u3002 \u9700\u63d0\u4ea4\u53ef\u4ee5\u5728\u6211\u4eec\u7ed9\u5b9a\u7684Docker\u73af\u5883\u4e2d\u76f4\u63a5\u4f7f\u7528make qemu\u7f16\u8bd1\u5e76\u8fd0\u884c\u7684\u6587\u4ef6\u5939\u7684\u538b\u7f29\u5305\u3002","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab4/tasks/#_3","text":"\u5bf9\u4e8e\u4e09\u4eba\u5c0f\u7ec4\uff0c\u5efa\u8bae\u4e24\u4f4d\u540c\u5b66\u5b8c\u6210\u7ec3\u4e60\u4e00\uff0c\u9700\u8981\u5927\u91cf\u9605\u8bfbSFS\u4ee3\u7801\uff0c\u53ef\u4ee5\u8003\u8651\u4e00\u8d77\u9605\u8bfb\u5e76\u8fdb\u884c\u4ea4\u6d41\u3002\u5269\u4e0b\u4e00\u4f4d\u540c\u5b66\u5b8c\u6210\u7ec3\u4e60\u4e8c\uff0c\u901a\u8fc7\u7cfb\u7edf\u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u5e94\u7528\u7a0b\u5e8f\u7684\u8f7d\u5165\u3002","title":"\u7ec4\u961f\u5206\u5de5\u5efa\u8bae"}]}